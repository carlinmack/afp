<div id="IMP2_Aux_Lemmas">
<div class="head">
<h1>Theory IMP2_Aux_Lemmas</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemma Library›</span></span>  
<span class="keyword1"><span class="command">theory</span></span> IMP2_Aux_Lemmas
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Rewrite.html">HOL-Library.Rewrite</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This library contains auxiliary lemmas, which are useful for proving 
  various VCs.
›</span></span>
 



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Termination Proofs›</span></span>

<span class="comment1">― ‹Useful lemma to show well-foundedness of some process approaching a finite upper bound›</span>
<span class="keyword1"><span class="command">lemma</span></span> wf_bounded_supset<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> wf <span class="main">{</span><span class="main">(</span><span class="bound">Q'</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="bound">Q'</span><span class="main">⊃</span><span class="bound">Q</span> <span class="main">∧</span> <span class="bound">Q'</span><span class="main">⊆</span> <span class="free">S</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">x</span><span class="main">.</span> finite <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">Q'</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="bound">Q</span><span class="main">⊂</span><span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span><span class="main">⊆</span> <span class="free">S</span><span class="main">}</span> <span class="main">⊆</span> inv_image <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">s'</span><span class="main">::</span>nat<span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s'</span><span class="main">&lt;</span><span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span><span class="main">.</span> card <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="bound">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">⊂</span><span class="skolem">a</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">⊆</span><span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="skolem">a</span> <span class="main">⊂</span> <span class="free">S</span><span class="main">-</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="skolem">a</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psubset_card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">s'</span><span class="main">::</span>nat<span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">s'</span><span class="main">&lt;</span><span class="bound">s</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_less<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Well-founded relation to approximate a finite set from below›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">finite_psupset</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">Q'</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="bound">Q</span><span class="main">⊂</span><span class="bound">Q'</span> <span class="main">∧</span> <span class="bound">Q'</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> finite_psupset_wf<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> wf <span class="main">(</span>finite_psupset <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finite_psupset_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_bounded_supset<span class="main">)</span>




 
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conversion between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nat›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>int›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> nat_distribs <span class="main">=</span> nat_add_distrib nat_diff_distrib Suc_diff_le nat_mult_distrib nat_div_distrib


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interval Sets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> intvs_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">::</span>int<span class="main">..&lt;</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">::</span>int<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> intvs_incr_h<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">h</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">l</span><span class="main">::</span>int<span class="main">..&lt;</span><span class="free">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">h</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> intvs_decr_h<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">::</span>int<span class="main">..&lt;</span><span class="free">h</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> intvs_incr_l<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">::</span>int<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> intvs_decr_l<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">h</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">l</span><span class="main">-</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">::</span>int<span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">l</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> intvs_ii_incdec<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">l</span> <span class="free">h</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">h</span><span class="main">+</span><span class="main">1</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">h</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">h</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">h</span><span class="main">}</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">-</span><span class="main">1</span><span class="main">≤</span><span class="free">h</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">l</span><span class="main">-</span><span class="main">1</span><span class="main">..</span><span class="free">h</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">l</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">h</span><span class="main">}</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">h</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">h</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">l</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">h</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">h</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> intvs_ie_incdec <span class="main">=</span> intvs_incr_h intvs_incr_l intvs_decr_h intvs_decr_l
<span class="comment1">(* TODO: Add lemmas for ei, ee *)</span>
<span class="keyword1"><span class="command">lemmas</span></span> intvs_incdec <span class="main">=</span> intvs_ie_incdec intvs_ii_incdec

<span class="keyword1"><span class="command">lemma</span></span> intvs_lower_incr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">h</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">l</span><span class="main">::</span>int<span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">l</span> <span class="main">(</span><span class="main">{</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> intvs_upper_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">h</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">l</span><span class="main">::</span>int<span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Induction on Intervals›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">intv_fwd_induct_scheme</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> unit"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intv_fwd_induct_scheme</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">then</span> <span class="free">intv_fwd_induct_scheme</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">else</span> <span class="main">()</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> nat <span class="main">(</span><span class="bound">h</span><span class="main">-</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">lemmas</span></span> intv_induct <span class="main">=</span> intv_fwd_induct_scheme.induct<span class="main">[</span><span class="operator">case_names</span> incr<span class="main">]</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">intv_bwd_induct_scheme</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> unit"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intv_bwd_induct_scheme</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">then</span> <span class="free">intv_bwd_induct_scheme</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">()</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> nat <span class="main">(</span><span class="bound">h</span><span class="main">-</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">lemmas</span></span> intv_bwd_induct <span class="main">=</span> intv_bwd_induct_scheme.induct<span class="main">[</span><span class="operator">case_names</span> decr<span class="main">]</span>
  


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multiset Lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_subst_outside<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉#</span><span class="free">s</span> <span class="main">⟹</span> image_mset <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> image_mset <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> image_mset_set_subst_inside<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mset_set <span class="free">S</span><span class="main">)</span> <span class="main">=</span> image_mset <span class="free">f</span> <span class="main">(</span>mset_set <span class="free">S</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">-</span> <span class="main">{#</span><span class="free">f</span> <span class="free">i</span><span class="main">#}</span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_mset_subst_outside<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_mset_eq_imp_set_eq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> image_mset <span class="free">g</span> <span class="free">s</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="main">(</span>set_mset <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span>set_mset <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_image_mset<span class="main">)</span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equal on Set›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">=</span> _ <span class="keyword1">on</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">=</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">on</span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> eq_on_subst_same<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">⟷</span> <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">∧</span> <span class="free">s</span><span class="main">=</span><span class="free">t</span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>  
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">⟷</span> <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">∧</span> <span class="free">s</span><span class="main">=</span><span class="free">t</span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> eq_on_subst_other<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">⟷</span> <span class="free">s</span><span class="main">=</span><span class="free">t</span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">⟷</span> <span class="free">s</span><span class="main">=</span><span class="free">t</span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> eq_on_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">s</span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_on_sym<span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span><span class="free">t</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">=</span><span class="free">s</span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_on_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">=</span><span class="free">s</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">s</span><span class="main">=</span><span class="free">t</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">r</span><span class="main">=</span><span class="free">t</span> <span class="keyword1">on</span> <span class="free">X</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_on_trans'<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">=</span><span class="free">s</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">s</span><span class="main">=</span><span class="free">t</span> <span class="keyword1">on</span> <span class="free">X'</span> <span class="main">⟹</span> <span class="free">r</span><span class="main">=</span><span class="free">t</span> <span class="keyword1">on</span> <span class="main">(</span><span class="free">X</span><span class="main">∩</span><span class="free">X'</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> eq_onD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="free">s</span> <span class="keyword1">on</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">r</span> <span class="free">x</span> <span class="main">=</span> <span class="free">s</span> <span class="free">x</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>
  
      
<span class="keyword1"><span class="command">lemma</span></span> eq_on_xfer_pointwise<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span><span class="main">=</span><span class="free">a'</span> <span class="keyword1">on</span> <span class="free">r'</span><span class="main">;</span> <span class="free">r</span><span class="main">⊆</span><span class="free">r'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">r</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">r</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">a'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def subset_iff<span class="main">)</span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Arrays›</span></span>  
  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sortedness›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sortedness as monotonicity property›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ran_sorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">⇒</span> int<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ran_sorted</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">}</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">}</span><span class="main">.</span> <span class="bound">i</span><span class="main">≤</span><span class="bound">j</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">j</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Alternative definition›</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> ran_sorted_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span> <span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">l</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">h</span> <span class="main">⟶</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">a</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> ran_sorted_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> dual_order.order_iff_strict<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> ran_sorted_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a</span> <span class="free">l</span> <span class="free">l</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_sorted_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> ran_sorted_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a</span> <span class="free">l</span> <span class="main">(</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_sorted_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_on_xfer_ran_sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="main">=</span><span class="free">a'</span> <span class="keyword1">on</span> <span class="free">r'</span><span class="main">;</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">r'</span> <span class="main">⟧</span> <span class="main">⟹</span> ran_sorted <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">⟷</span> ran_sorted <span class="free">a'</span> <span class="free">l</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ran_sorted_alt eq_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_iff<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> combine_sorted_pivot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a</span> <span class="free">l</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="free">a</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span><span class="main">.</span> <span class="free">a</span> <span class="bound">k</span> <span class="main">≥</span> <span class="free">a</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a</span> <span class="free">l</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ran_sorted_def Ball_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="operator">smt</span>
  
  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Multiset of Ranges in Arrays›</span></span>  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mset_ran</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> int set <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mset_ran</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> image_mset <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>mset_set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_ran_infinite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="free">r</span> <span class="main">⟹</span> mset_ran <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_by_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">r</span><span class="main">.</span> <span class="main">{#</span><span class="free">a</span> <span class="bound">i</span><span class="main">#}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>    

<span class="keyword1"><span class="command">lemma</span></span> mset_ran_mem<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span> <span class="main">⟹</span> <span class="free">i</span><span class="main">∈</span><span class="free">r</span> <span class="main">⟹</span> <span class="free">a</span> <span class="free">i</span> <span class="main">∈#</span> mset_ran <span class="free">a</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_ran_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">r</span> <span class="main">⟹</span> mset_ran <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">r</span><span class="main">=</span><span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_def mset_set_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_ran_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span> <span class="free">i</span><span class="main">#}</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_eq_single_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span><span class="main">=</span><span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">∧</span> <span class="free">x</span><span class="main">=</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> finite_set_mset_mset_set msed_map_invR <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">r</span><span class="main">;</span> <span class="free">i</span><span class="main">∉</span><span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> mset_ran <span class="free">a</span> <span class="main">(</span>insert <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> add_mset <span class="main">(</span><span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>mset_ran <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_def<span class="main">)</span> 
  
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_subst_outside<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">∉</span><span class="free">r</span> <span class="main">⟹</span> mset_ran <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="free">r</span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> mset_ran_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_mset_subst_outside<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_ran_subst_inside<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span> <span class="main">⟹</span> <span class="free">i</span><span class="main">∈</span><span class="free">r</span> <span class="main">⟹</span> mset_ran <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="free">r</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">-</span> <span class="main">{#</span><span class="free">a</span> <span class="free">i</span><span class="main">#}</span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> mset_ran_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_mset_set_subst_inside<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_combine1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span> finite <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∩</span><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">=</span><span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> mset_ran <span class="free">a</span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> mset_ran <span class="free">a</span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∪</span><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_by_sum sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_ran_combine2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">r</span><span class="main">;</span> <span class="free">i</span><span class="main">∉</span><span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> add_mset <span class="main">(</span><span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>mset_ran <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">(</span>insert <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mset_ran_combine1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> mset_ran_combine <span class="main">=</span> mset_ran_combine1 mset_ran_combine2
    
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_cong<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">on</span> <span class="free">r</span> <span class="main">⟹</span> mset_ran <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> mset_ran <span class="free">b</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_by_sum eq_on_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">r</span> <span class="main">⟹</span> mset_ran <span class="main">(</span><span class="free">a</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_mset_set multiset.map_comp<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_combine_eqs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> mset_ran <span class="free">b</span> <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> mset_ran <span class="free">b</span> <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∩</span><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∪</span><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> mset_ran <span class="free">b</span> <span class="main">(</span><span class="free">r<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∪</span><span class="free">r<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">r<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">r<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_ran_combine1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_combine_eq_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="main">(</span><span class="free">r</span><span class="main">-</span><span class="free">I</span><span class="main">)</span> <span class="main">=</span> mset_ran <span class="free">a'</span> <span class="main">(</span><span class="free">r</span><span class="main">-</span><span class="free">I</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">=</span><span class="free">a'</span> <span class="keyword1">on</span> <span class="free">I</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> mset_ran <span class="free">a'</span> <span class="free">r</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">-</span> <span class="free">I</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">-</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">r</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> mset_ran <span class="free">a'</span> <span class="main">(</span><span class="free">r</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_by_sum eq_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mset_ran_combine_eqs<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">lemma</span></span> mset_ran_eq_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="free">r'</span> <span class="main">=</span> mset_ran <span class="free">a'</span> <span class="free">r'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">a'</span> <span class="keyword1">on</span> <span class="free">r2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">-</span><span class="free">r'</span> <span class="main">⊆</span> <span class="free">r2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span><span class="main">⊆</span><span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> mset_ran <span class="free">a'</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∩</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> <span class="free">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="main">∪</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">=</span><span class="free">a'</span> <span class="keyword1">on</span> <span class="free">r</span><span class="main">-</span><span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="main">(</span><span class="free">r</span><span class="main">-</span><span class="free">r'</span><span class="main">)</span> <span class="main">=</span> mset_ran <span class="free">a'</span> <span class="main">(</span><span class="free">r</span><span class="main">-</span><span class="free">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_ran_by_sum eq_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mset_ran_combine_eqs<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>    
  
<span class="keyword1"><span class="command">lemma</span></span> mset_ran_xfer_pointwise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> mset_ran <span class="free">a'</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">r</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">r</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">a'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mset_ran_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> image_mset_eq_imp_set_eq<span class="main">)</span>
  

  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Swap›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">swap</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_ran_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span><span class="main">∈</span><span class="free">r</span><span class="main">;</span> <span class="free">j</span><span class="main">∈</span><span class="free">r</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> mset_ran <span class="main">(</span>swap <span class="free">a</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> swap_def mset_ran_subst_inside<span class="main">)</span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Range of an Array as List›</span></span>  
<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">lran</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lran</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free">lran</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">l</span><span class="main">,</span><span class="bound">h</span><span class="main">)</span><span class="main">.</span> nat <span class="main">(</span><span class="bound">h</span><span class="main">-</span><span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">declare</span></span> lran.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>  
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lran a l h›</span></span></span></span> is the list <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[a<span class="hidden">⇩</span><sub>l</sub>,a<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>1</sub>,...,a<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>-</sub><span class="hidden">⇩</span><sub>1</sub>]›</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lran_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">h</span><span class="main">≤</span><span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lran.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lran_bwd_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">l</span><span class="main">&lt;</span><span class="free">h</span> <span class="keyword1">then</span> lran <span class="free">a</span> <span class="free">l</span> <span class="main">(</span><span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">a</span> <span class="main">(</span><span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lran.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> lran.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> lran.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> length_lran<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="free">h</span><span class="main">-</span><span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lran.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lran.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_lran<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="free">i</span> <span class="main">&lt;</span> <span class="free">h</span><span class="main">-</span><span class="free">l</span> <span class="main">⟹</span> lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> int <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lran.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lran.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons nth_tl <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  
<span class="keyword1"><span class="command">lemma</span></span> lran_append1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">h</span> <span class="main">⟹</span> lran <span class="free">a</span> <span class="free">l</span> <span class="main">(</span><span class="free">h</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span> <span class="free">h</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">⌑</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span> lran_bwd_simp<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lran_prepend1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">h</span> <span class="main">⟹</span> lran <span class="free">a</span> <span class="main">(</span><span class="free">l</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> <span class="free">a</span><span class="main">(</span><span class="free">l</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">#</span> lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">⌑</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span> lran.simps<span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> lran_tail<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="main">(</span><span class="free">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> tl <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> lran.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> lran_butlast<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l</span> <span class="main">(</span><span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> lran_bwd_simp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> hd_lran<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">h</span> <span class="main">⟹</span> hd <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="free">l</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lran.simps<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">lemma</span></span> last_lran<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">h</span> <span class="main">⟹</span> last <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">(</span><span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lran_bwd_simp<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  

<span class="keyword1"><span class="command">lemma</span></span> lran_upd_outside<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">l</span> <span class="main">⟹</span> lran <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">≤</span><span class="free">i</span> <span class="main">⟹</span> lran <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lran.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> lran.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> lran.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lran.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> lran.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> lran.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

  
<span class="keyword1"><span class="command">lemma</span></span> lran_upd_inside<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">∈</span><span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">⟹</span> lran <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span><span class="main">)</span><span class="main">[</span>nat <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="free">l</span><span class="main">)</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_list_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> tl_upd_at0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="main">0</span><span class="main">:=</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> tl <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span> 

    
  
  
<span class="keyword1"><span class="command">lemma</span></span> lran_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> lran <span class="free">a'</span> <span class="free">l</span> <span class="free">h</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">l</span><span class="main">≤</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">h</span> <span class="main">⟶</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">a'</span> <span class="bound">i</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lran.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> lran.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> lran.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym_conv not_less zless_imp_add1_zle<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> set_lran<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">`</span><span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lran.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> lran.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff image_iff not_less not_less_iff_gr_or_eq zless_imp_add1_zle<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> mset_lran<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lran.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> lran.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intvs_lower_incr mset_ran_insert<span class="main">)</span>
  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2_Utils">
<div class="head">
<h1>Theory IMP2_Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> IMP2_Utils
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="comment1">(*
      Explicit refinement of goal state, deterministic and with error messages.
      
      TODO:
        Add functions to extract subgoals, prove them externally, and then discharge them.
          This is currently done by hand in recursive_spec command   
        
    *)</span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Det_Goal_Refine</span> <span class="main">:</span> <span class="keyword2"><span class="keyword">sig</span></span>
      <span class="comment1">(* Apply tactic *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> apply<span class="main">:</span> string <span class="main">-&gt;</span> tactic <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
      
      <span class="comment1">(* Apply tactic to first goal *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> apply1<span class="main">:</span> string <span class="main">-&gt;</span> <span class="main">(</span>int <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
      
      <span class="comment1">(* Apply tactic on goal obtained from theorem *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> apply_on_thm<span class="main">:</span> string <span class="main">-&gt;</span> tactic <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
      
      <span class="comment1">(* Extract first element from seq, error message if empty *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> seq_first<span class="main">:</span> string <span class="main">-&gt;</span> 'a Seq.seq <span class="main">-&gt;</span> 'a
    <span class="keyword2"><span class="keyword">end</span></span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">seq_first</span> <span class="entity">msg</span> <span class="entity">seq</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Seq.pull <span class="entity">seq</span> <span class="keyword2"><span class="keyword">of</span></span> 
        NONE <span class="main">=&gt;</span> error <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">msg</span><span class="main">=</span><span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"Empty result sequence"</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">msg</span><span class="main">)</span> 
      <span class="main">|</span> SOME <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply</span> <span class="entity">msg</span> <span class="main">(</span><span class="entity">tac</span><span class="main">:</span>tactic<span class="main">)</span> <span class="main">=</span> <span class="entity">tac</span> #&gt; <span class="entity">seq_first</span> <span class="entity">msg</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply1</span> <span class="entity">msg</span> <span class="entity">tac</span> <span class="main">=</span> <span class="entity">apply</span> <span class="entity">msg</span> <span class="main">(</span>HEADGOAL <span class="entity">tac</span><span class="main">)</span>
    
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_on_thm</span> <span class="entity">msg</span> <span class="entity">tac</span> <span class="entity">thm</span> <span class="main">=</span> Goal.protect <span class="main">(</span>Thm.nprems_of <span class="entity">thm</span><span class="main">)</span> <span class="entity">thm</span> |&gt; <span class="entity">apply</span> <span class="entity">msg</span> <span class="entity">tac</span> |&gt; Goal.conclude
    <span class="keyword2"><span class="keyword">end</span></span>
  
  
  
  ›</span>

  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="comment1">(*
      ML-level interface to option datatype. 
      
      I would have expected this in HOLogic, but it isn't there!
    *)</span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">HOLOption</span> <span class="main">:</span> <span class="keyword2"><span class="keyword">sig</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> mk_None<span class="main">:</span> typ <span class="main">-&gt;</span> term
      <span class="keyword1"><span class="keyword">val</span></span> mk_Some<span class="main">:</span> term <span class="main">-&gt;</span> term
      <span class="keyword1"><span class="keyword">val</span></span> mk_optionT<span class="main">:</span> typ <span class="main">-&gt;</span> typ
      
      <span class="keyword1"><span class="keyword">val</span></span> mk_fun_upd<span class="main">:</span> term * term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
      
      <span class="keyword1"><span class="keyword">val</span></span> mk_map_empty<span class="main">:</span> typ <span class="main">-&gt;</span> typ <span class="main">-&gt;</span> term
      <span class="keyword1"><span class="keyword">val</span></span> mk_map_sng<span class="main">:</span> term * term <span class="main">-&gt;</span> term
      <span class="keyword1"><span class="keyword">val</span></span> mk_map_upd<span class="main">:</span> term * term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
      <span class="keyword1"><span class="keyword">val</span></span> mk_map_list<span class="main">:</span> typ <span class="main">-&gt;</span> typ <span class="main">-&gt;</span> <span class="main">(</span>term * term<span class="main">)</span> list <span class="main">-&gt;</span> term
    <span class="keyword2"><span class="keyword">end</span></span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_fun_upd</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">y</span><span class="main">)</span> <span class="entity">f</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">xT</span> <span class="main">=</span> fastype_of <span class="entity">x</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">yT</span> <span class="main">=</span> fastype_of <span class="entity">y</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Fun.fun_upd<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">(</span><span class="entity">xT</span>--&gt;<span class="entity">yT</span><span class="main">)</span> --&gt; <span class="entity">xT</span> --&gt; <span class="entity">yT</span> --&gt; <span class="main">(</span><span class="entity">xT</span> --&gt; <span class="entity">yT</span><span class="main">)</span><span class="main">)</span>$<span class="entity">f</span>$<span class="entity">x</span>$<span class="entity">y</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_optionT</span> <span class="entity">T</span> <span class="main">=</span> Type<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> option<span class="antiquote">}</span></span><span class="main">,</span><span class="main">[</span><span class="entity">T</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_Some</span> <span class="entity">x</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Option.Some<span class="antiquote">}</span></span><span class="main">,</span>fastype_of <span class="entity">x</span> --&gt; <span class="entity">mk_optionT</span> <span class="main">(</span>fastype_of <span class="entity">x</span><span class="main">)</span><span class="main">)</span>$<span class="entity">x</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_None</span> <span class="entity">T</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Option.None<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">mk_optionT</span> <span class="entity">T</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_map_upd</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> <span class="entity">m</span> <span class="main">=</span> <span class="entity">mk_fun_upd</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">mk_Some</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">m</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_map_empty</span> <span class="entity">K</span> <span class="entity">V</span> <span class="main">=</span> Abs <span class="main">(</span><span class="inner_quoted">"uu_"</span><span class="main">,</span><span class="entity">K</span><span class="main">,</span><span class="entity">mk_None</span> <span class="entity">V</span><span class="main">)</span>
    
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_map_list</span> <span class="entity">K</span> <span class="entity">V</span> <span class="entity">kvs</span> <span class="main">=</span> fold <span class="entity">mk_map_upd</span> <span class="entity">kvs</span> <span class="main">(</span><span class="entity">mk_map_empty</span> <span class="entity">K</span> <span class="entity">V</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_map_sng</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_map_upd</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> <span class="main">(</span><span class="entity">mk_map_empty</span> <span class="main">(</span>fastype_of <span class="entity">k</span><span class="main">)</span> <span class="main">(</span>fastype_of <span class="entity">v</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  
  ›</span>

  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="comment1">(*
      Application of rules (thm -&gt; thm) to premises of subgoals
    *)</span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Thm_Mapping</span> <span class="main">:</span> <span class="keyword2"><span class="keyword">sig</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> thin_fst_prem_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
      <span class="keyword1"><span class="keyword">val</span></span> thin_fst_prems_tac<span class="main">:</span> int <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
    
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">rule</span> <span class="main">=</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
      
      <span class="comment1">(* Map first premises with respective rules *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> map_prems_tac<span class="main">:</span> <span class="entity">rule</span> list <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
      <span class="comment1">(* Map all premises with rule *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> map_all_prems_tac<span class="main">:</span> <span class="entity">rule</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
      
      <span class="comment1">(* Apply ith rule to ith thm *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> map_thms<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">rule</span> list <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> thm list
    <span class="keyword2"><span class="keyword">end</span></span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">rule</span> <span class="main">=</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">thin_fst_prem_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="main">=</span> DETERM <span class="main">(</span>eresolve_tac <span class="entity">ctxt</span> <span class="main">[</span>Drule.thin_rl<span class="main">]</span> <span class="entity">i</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">thin_fst_prems_tac</span> <span class="inner_numeral">0</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> all_tac
        <span class="main">|</span> <span class="entity">thin_fst_prems_tac</span> <span class="entity">n</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">thin_fst_prem_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> THEN <span class="entity">thin_fst_prems_tac</span> <span class="main">(</span><span class="entity">n</span>-<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">i</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_prems_tac</span> <span class="entity">fs</span> <span class="entity">ctxt</span> <span class="main">=</span> SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nprems</span> <span class="main">=</span> length <span class="main">(</span>Logic.strip_assums_hyp <span class="entity">t</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span>
          <span class="entity">Subgoal.FOCUS_PREMS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context<span class="main">=</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> HEADGOAL <span class="main">(</span>
            <span class="entity">Method.insert_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">prem</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">ctxt</span> <span class="entity">prem</span><span class="main">)</span> <span class="main">(</span><span class="entity">fs</span>~~take <span class="main">(</span>length <span class="entity">fs</span><span class="main">)</span> <span class="entity">prems</span><span class="main">)</span><span class="main">)</span>
          <span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span>
          THEN' <span class="entity">thin_fst_prems_tac</span> <span class="main">(</span>length <span class="entity">fs</span><span class="main">)</span> <span class="entity">ctxt</span>
          THEN' rotate_tac <span class="main">(</span><span class="entity">nprems</span> - length <span class="entity">fs</span><span class="main">)</span>
        <span class="main">)</span> <span class="entity">i</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
    
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_all_prems_tac</span> <span class="entity">f</span> <span class="entity">ctxt</span> <span class="main">=</span> SUBGOAL <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> length <span class="main">(</span>Logic.strip_assums_hyp <span class="entity">t</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">map_prems_tac</span> <span class="main">(</span>replicate <span class="entity">n</span> <span class="entity">f</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
       
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_thms</span> <span class="entity">ctxt</span> <span class="entity">rls</span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">rls</span> ~~ <span class="entity">thms</span>
        |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">rl</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">rl</span> <span class="entity">ctxt</span> <span class="entity">thm</span><span class="main">)</span>
  
  
    <span class="keyword2"><span class="keyword">end</span></span>
  ›</span>
  
  
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">0</span> RS_fst

    <span class="comment1">(* Resolve with first matching rule
    
      Common idiom: thm RS_fst […,asm_rl] to keep original thm if no other rule matches
     *)</span>  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">_</span> <span class="entity">RS_fst</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> error <span class="inner_quoted">"RS_fst"</span>
      <span class="main">|</span> <span class="entity">thma</span> <span class="entity">RS_fst</span> <span class="main">(</span><span class="entity">thm</span>::<span class="entity">thms</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> try <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> RS<span class="main">)</span> <span class="main">(</span><span class="entity">thma</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
          SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span>
        <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="entity">thma</span> <span class="entity">RS_fst</span> <span class="entity">thms</span>  
  
  ›</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Named_Simpsets">
<div class="head">
<h1>Theory Named_Simpsets</h1>
</div>
<pre class="source"><span class="comment1">(*
  Named simpsets, analogously to named theorems.
  
  Author: Peter Lammich
  
  TODO: 
  
    Declare attributes with name of named simpset, instead of one global named_ss attribute!
  
    Initialize from merge of simpsets (?) This goes into direction of "locale expressions", don't overshoot here!
    
    Isar-Syntax for adding/removing simprocs
    
  
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Named Simpsets›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Named_Simpsets
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"named_simpset"</span> <span class="main">::</span> thy_decl <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"print_named_simpset"</span> <span class="main">::</span> diag
<span class="keyword2"><span class="keyword">begin</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>
  <span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"named_simpsets.ML"</span>
  
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
    <span class="entity">Outer_Syntax.local_theory</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">named_simpset</span>›</span></span>
      <span class="inner_quoted">"declare named simpset"</span>
      <span class="main">(</span>Parse.binding -- Scan.option <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">=</span>›</span></span> |-- Parse.position Parse.embedded<span class="main">)</span> &gt;&gt; uncurry <span class="entity">Named_Simpsets.declare_cmd</span><span class="main">)</span><span class="main">;</span>
  ›</span>
          
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹      
  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>      
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_named_simpset_cmd</span> <span class="entity">name_src</span> <span class="entity">bang</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">Named_Simpsets.check</span> <span class="entity">ctxt</span> <span class="entity">name_src</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">Named_Simpsets.put</span> <span class="entity">name</span> <span class="entity">ctxt</span>
      |&gt; <span class="entity">Simplifier.pretty_simpset</span> <span class="entity">bang</span>
      |&gt; Pretty.writeln
    <span class="keyword2"><span class="keyword">end</span></span>
        
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Outer_Syntax.command</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">print_named_simpset</span>›</span></span>
      <span class="inner_quoted">"print named simpset"</span>
      <span class="main">(</span>Parse.position Parse.name -- Parse.opt_bang &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">name_src</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">Toplevel.keep</span> <span class="main">(</span><span class="entity">print_named_simpset_cmd</span> <span class="entity">name_src</span> <span class="entity">b</span> o <span class="entity">Toplevel.context_of</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        
  <span class="keyword2"><span class="keyword">end</span></span>                
  ›</span>
  
  <span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹ I
    #&gt; <span class="entity">Named_Simpsets.declare</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> HOL_ss<span class="antiquote">}</span></span></span> <span class="main">(</span>SOME <span class="entity">HOL_ss</span><span class="main">)</span>
    #&gt; <span class="entity">Named_Simpsets.declare</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> HOL_basic_ss<span class="antiquote">}</span></span></span> <span class="main">(</span>SOME <span class="entity">HOL_basic_ss</span><span class="main">)</span>
    #&gt; <span class="entity">Named_Simpsets.declare</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> Main_ss<span class="antiquote">}</span></span></span> <span class="main">(</span>SOME <span class="main">(</span>simpset_of <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>
  ›</span>

  <span class="comment1">(* TODO/FIXME/XXX: Is this the intended way how to add an attribute to simp?*)</span>
  <span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">named_ss_mod</span> <span class="main">=</span> Args.$$$ <span class="inner_quoted">"named_ss"</span> |-- Parse.position Parse.name --| Args.colon 
      &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">raw_binding</span> <span class="main">=&gt;</span> <span class="main">{</span>
        init <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">Named_Simpsets.put</span> <span class="main">(</span><span class="entity">Named_Simpsets.check</span> <span class="entity">ctxt</span> <span class="entity">raw_binding</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">)</span><span class="main">,</span>
        attribute <span class="main">=</span> <span class="entity">Simplifier.simp_add</span><span class="main">,</span> 
        pos <span class="main">=</span> <span class="antiquoted"><span class="operator"><span class="entity">⌂</span></span></span>
      <span class="main">}</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Simplifier.method_setup</span> <span class="main">(</span><span class="entity">named_ss_mod</span> :: <span class="entity">Splitter.split_modifiers</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  ›</span>
    
  

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

  <span class="keyword1"><span class="command">experiment</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Isar Interface›</span></span>
    
    <span class="comment1">(* Start with cleared simpset *)</span>
    <span class="keyword1"><span class="command">named_simpset</span></span> bar
    
    <span class="comment1">(* Start with other named simpset *)</span>
    <span class="keyword1"><span class="command">named_simpset</span></span> foo <span class="main">=</span> HOL_ss

    <span class="comment1">(* Print Content *)</span>
    <span class="keyword1"><span class="command">print_named_simpset</span></span> bar
    <span class="keyword1"><span class="command">print_named_simpset</span></span> foo
    
    <span class="comment1">(* Predefined simpsets *)</span>
    <span class="keyword1"><span class="command">print_named_simpset</span></span> HOL_basic_ss
    <span class="keyword1"><span class="command">print_named_simpset</span></span> HOL_ss
    <span class="keyword1"><span class="command">print_named_simpset</span></span> Main_ss          <span class="comment1">(* Simpset of theory HOL.Main *)</span>
    
    
    
        
    <span class="comment1">(* Adding and deleting simp rules *)</span>
    <span class="keyword1"><span class="command">declare</span></span> nth_append<span class="main">[</span><span class="operator">named_ss</span> bar<span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> nth_append<span class="main">[</span><span class="operator">named_ss</span> bar <span class="quasi_keyword">del</span><span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> nth_append<span class="main">[</span><span class="operator">named_ss</span> bar <span class="quasi_keyword">add</span><span class="main">]</span>
    
    <span class="comment1">(* Same for split and cong *)</span>
    <span class="keyword1"><span class="command">declare</span></span> if_split<span class="main">[</span><span class="operator">named_ss</span> bar <span class="quasi_keyword">split</span> <span class="quasi_keyword">add</span><span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> if_split<span class="main">[</span><span class="operator">named_ss</span> bar <span class="quasi_keyword">split</span> <span class="quasi_keyword">del</span><span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> if_split<span class="main">[</span><span class="operator">named_ss</span> bar <span class="quasi_keyword">split</span><span class="main">]</span>
    
    <span class="keyword1"><span class="command">declare</span></span> if_cong<span class="main">[</span><span class="operator">named_ss</span> bar <span class="quasi_keyword">cong</span> <span class="quasi_keyword">add</span><span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> if_cong<span class="main">[</span><span class="operator">named_ss</span> bar <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main">]</span>
    <span class="keyword1"><span class="command">declare</span></span> if_cong<span class="main">[</span><span class="operator">named_ss</span> bar <span class="quasi_keyword">cong</span><span class="main">]</span>
    
    <span class="comment1">(* Using Named Simpsets *)</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">@</span><span class="main">[</span><span class="numeral">4</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">named_ss</span> bar<span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">@</span><span class="main">[</span><span class="numeral">4</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">put_named_ss</span> bar<span class="main">]</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">named_ss</span> Main_ss<span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">]</span><span class="main">@</span><span class="main">[</span><span class="numeral">4</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">use</span> <span class="main"><span class="main">[</span></span><span class="main"><span class="main">[</span></span><span class="operator">put_named_ss</span> bar<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          
  
  
    <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ML Interface›</span></span>
    
    <span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹<span class="entity">Named_Simpsets.declare</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> foo2<span class="antiquote">}</span></span></span> NONE›</span>
    <span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹<span class="entity">Named_Simpsets.declare</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> foo3<span class="antiquote">}</span></span></span> <span class="main">(</span>SOME <span class="entity">HOL_ss</span><span class="main">)</span>›</span>
    
    <span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span>
    
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Named_Simpsets.put</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> foo<span class="antiquote">}</span></span> <span class="entity">ctxt</span>

      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">Named_Simpsets.map_ctxt</span>
    ›</span>
    
  
  <span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/named_simpsets.ML">
<div class="head">
<h1>File ‹named_simpsets.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
Named simpsets. Derived from named_theorems.ML
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">NAMED_SIMPSETS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> get<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> simpset
  <span class="keyword1"><span class="keyword">val</span></span> clear<span class="main">:</span> string <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> map<span class="main">:</span> string <span class="main">-&gt;</span> <span class="main">(</span>simpset <span class="main">-&gt;</span> simpset<span class="main">)</span> <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> map_ctxt<span class="main">:</span> string <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span><span class="main">)</span> <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  
  <span class="keyword1"><span class="keyword">val</span></span> put<span class="main">:</span> string <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span>
  
  <span class="keyword1"><span class="keyword">val</span></span> get_all<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> simpset Name_Space.table
  
  
  <span class="keyword1"><span class="keyword">val</span></span> add_simp<span class="main">:</span> string <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> del_simp<span class="main">:</span> string <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic

  <span class="keyword1"><span class="keyword">val</span></span> add_cong<span class="main">:</span> string <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> del_cong<span class="main">:</span> string <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  
  <span class="keyword1"><span class="keyword">val</span></span> add_split<span class="main">:</span> string <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> del_split<span class="main">:</span> string <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
    
  <span class="keyword1"><span class="keyword">val</span></span> add_attr<span class="main">:</span> string <span class="main">-&gt;</span> attribute
  <span class="keyword1"><span class="keyword">val</span></span> del_attr<span class="main">:</span> string <span class="main">-&gt;</span> attribute
  
  <span class="keyword1"><span class="keyword">val</span></span> add_cong_attr<span class="main">:</span> string <span class="main">-&gt;</span> attribute
  <span class="keyword1"><span class="keyword">val</span></span> del_cong_attr<span class="main">:</span> string <span class="main">-&gt;</span> attribute
  
  <span class="keyword1"><span class="keyword">val</span></span> add_split_attr<span class="main">:</span> string <span class="main">-&gt;</span> attribute
  <span class="keyword1"><span class="keyword">val</span></span> del_split_attr<span class="main">:</span> string <span class="main">-&gt;</span> attribute
  
  <span class="keyword1"><span class="keyword">val</span></span> check<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> xstring * Position.T <span class="main">-&gt;</span> string

  <span class="keyword1"><span class="keyword">val</span></span> declare<span class="main">:</span> binding <span class="main">-&gt;</span> simpset option <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> local_theory
  <span class="keyword1"><span class="keyword">val</span></span> declare_cmd<span class="main">:</span> binding <span class="main">-&gt;</span> <span class="main">(</span>xstring * Position.T<span class="main">)</span> option <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span> local_theory
  
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Named_Simpsets</span><span class="main">:</span> <span class="entity">NAMED_SIMPSETS</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="comment1">(* context data *)</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Data</span> <span class="main">=</span> Generic_Data
<span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> simpset Name_Space.table<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span><span class="main">:</span> <span class="entity">T</span> <span class="main">=</span> Name_Space.empty_table <span class="inner_quoted">"named-simpset"</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I<span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">:</span> <span class="entity">T</span> * <span class="entity">T</span> <span class="main">-&gt;</span> <span class="entity">T</span> <span class="main">=</span> Name_Space.join_tables <span class="main">(</span>K merge_ss<span class="main">)</span><span class="main">;</span>
<span class="main">)</span><span class="main">;</span>


<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">content</span> <span class="main">=</span> Name_Space.get o Data.get

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get</span> <span class="main">=</span> <span class="entity">content</span> o Context.Proof<span class="main">;</span>
  
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_all</span> <span class="main">=</span> Data.get o Context.Proof


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">put</span> <span class="entity">name</span> <span class="entity">ctxt</span> <span class="main">=</span> put_simpset <span class="main">(</span><span class="entity">get</span> <span class="entity">ctxt</span> <span class="entity">name</span><span class="main">)</span> <span class="entity">ctxt</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map</span> <span class="entity">name</span> <span class="entity">f</span> <span class="entity">context</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">content</span> <span class="entity">context</span> <span class="entity">name</span><span class="main">;</span> Data.map <span class="main">(</span>Name_Space.map_table_entry <span class="entity">name</span> <span class="entity">f</span><span class="main">)</span> <span class="entity">context</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_ctxt</span> <span class="entity">name</span> <span class="entity">f</span> <span class="entity">context</span> <span class="main">=</span> <span class="entity">map</span> <span class="entity">name</span> <span class="main">(</span>simpset_map <span class="main">(</span>Context.proof_of <span class="entity">context</span><span class="main">)</span> <span class="entity">f</span><span class="main">)</span> <span class="entity">context</span>


<span class="comment1">(* maintain content *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clear</span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">map_ctxt</span> <span class="entity">name</span> clear_simpset<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_simp</span> <span class="entity">name</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">map_ctxt</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">Simplifier.add_simp</span> <span class="entity">thm</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_simp</span> <span class="entity">name</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">map_ctxt</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">Simplifier.del_simp</span> <span class="entity">thm</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_cong</span> <span class="entity">name</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">map_ctxt</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">Simplifier.add_cong</span> <span class="entity">thm</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_cong</span> <span class="entity">name</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">map_ctxt</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">Simplifier.del_cong</span> <span class="entity">thm</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_split</span> <span class="entity">name</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">map_ctxt</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">Splitter.add_split</span> <span class="entity">thm</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_split</span> <span class="entity">name</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">map_ctxt</span> <span class="entity">name</span> <span class="main">(</span><span class="entity">Splitter.del_split</span> <span class="entity">thm</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_attr</span> <span class="main">=</span> Thm.declaration_attribute o <span class="entity">add_simp</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_attr</span> <span class="main">=</span> Thm.declaration_attribute o <span class="entity">del_simp</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_cong_attr</span> <span class="main">=</span> Thm.declaration_attribute o <span class="entity">add_cong</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_cong_attr</span> <span class="main">=</span> Thm.declaration_attribute o <span class="entity">del_cong</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_split_attr</span> <span class="main">=</span> Thm.declaration_attribute o <span class="entity">add_split</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">del_split_attr</span> <span class="main">=</span> Thm.declaration_attribute o <span class="entity">del_split</span><span class="main">;</span>


<span class="comment1">(* check *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">context</span> <span class="main">=</span> Context.Proof <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">in</span></span> Name_Space.check <span class="entity">context</span> <span class="main">(</span>Data.get <span class="entity">context</span><span class="main">)</span> #&gt; <span class="main">#</span><span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">(* declaration *)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">new_entry</span> <span class="entity">binding</span> <span class="entity">init</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decl</span> <span class="main">_</span> <span class="entity">context</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sstab</span> <span class="main">=</span> Data.get <span class="entity">context</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ss</span> <span class="main">=</span> the_default <span class="main">(</span>Raw_Simplifier.clear_simpset <span class="main">(</span>Context.proof_of <span class="entity">context</span><span class="main">)</span> |&gt; simpset_of<span class="main">)</span> <span class="entity">init</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">sstab</span><span class="main">)</span> <span class="main">=</span> Name_Space.define <span class="entity">context</span> true <span class="main">(</span><span class="entity">binding</span><span class="main">,</span><span class="entity">ss</span><span class="main">)</span> <span class="entity">sstab</span>
  <span class="keyword2"><span class="keyword">in</span></span> Data.put <span class="entity">sstab</span> <span class="entity">context</span> <span class="keyword2"><span class="keyword">end</span></span>  
  
<span class="keyword2"><span class="keyword">in</span></span>
  Local_Theory.declaration <span class="main">{</span>syntax<span class="main">=</span>false<span class="main">,</span> pervasive<span class="main">=</span>true<span class="main">}</span> <span class="entity">decl</span>
<span class="keyword2"><span class="keyword">end</span></span>    



<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">declare</span> <span class="entity">binding</span> <span class="entity">init</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy'</span> <span class="main">=</span> <span class="entity">lthy</span> |&gt; <span class="entity">new_entry</span> <span class="entity">binding</span> <span class="entity">init</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">lthy'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">declare_cmd</span> <span class="entity">binding</span> <span class="entity">init_src</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">init</span> <span class="main">=</span> Option.map <span class="main">(</span><span class="entity">get</span> <span class="entity">lthy</span> o <span class="entity">check</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">init_src</span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">declare</span> <span class="entity">binding</span> <span class="entity">init</span> <span class="entity">lthy</span>
<span class="keyword2"><span class="keyword">end</span></span>
  
  
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">named_simpset_attr</span> <span class="main">=</span> 
  <span class="main">(</span>Args.context -- Scan.lift <span class="main">(</span>Parse.position Args.embedded<span class="main">)</span><span class="main">)</span> 
  :|-- <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">raw_binding</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">check</span> <span class="entity">ctxt</span> <span class="entity">raw_binding</span> <span class="keyword2"><span class="keyword">in</span></span>
       <span class="main">(</span>Scan.lift <span class="main">(</span>Args.$$$ <span class="inner_quoted">"simp"</span><span class="main">)</span> |-- <span class="entity">Attrib.add_del</span> <span class="main">(</span><span class="entity">add_attr</span> <span class="entity">name</span><span class="main">)</span> <span class="main">(</span><span class="entity">del_attr</span> <span class="entity">name</span><span class="main">)</span><span class="main">)</span>
    || <span class="main">(</span>Scan.lift <span class="main">(</span>Args.$$$ <span class="inner_quoted">"cong"</span><span class="main">)</span> |-- <span class="entity">Attrib.add_del</span> <span class="main">(</span><span class="entity">add_cong_attr</span> <span class="entity">name</span><span class="main">)</span> <span class="main">(</span><span class="entity">del_cong_attr</span> <span class="entity">name</span><span class="main">)</span><span class="main">)</span>
    || <span class="main">(</span>Scan.lift <span class="main">(</span>Args.$$$ <span class="inner_quoted">"split"</span><span class="main">)</span> |-- <span class="entity">Attrib.add_del</span> <span class="main">(</span><span class="entity">add_split_attr</span> <span class="entity">name</span><span class="main">)</span> <span class="main">(</span><span class="entity">del_split_attr</span> <span class="entity">name</span><span class="main">)</span><span class="main">)</span>
    || <span class="entity">Attrib.add_del</span> <span class="main">(</span><span class="entity">add_attr</span> <span class="entity">name</span><span class="main">)</span> <span class="main">(</span><span class="entity">del_attr</span> <span class="entity">name</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">)</span>
  
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Theory.setup
  <span class="main">(</span><span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹named_ss›</span></span> <span class="entity">named_simpset_attr</span> <span class="inner_quoted">"Modify named simpsets"</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">put_named_simpset_attr</span> <span class="main">=</span>
  <span class="main">(</span>Args.context -- Scan.lift <span class="main">(</span>Parse.position Args.embedded<span class="main">)</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">raw_binding</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">check</span> <span class="entity">ctxt</span> <span class="entity">raw_binding</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">attr</span> <span class="main">=</span> Thm.declaration_attribute <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Context.map_proof <span class="main">(</span><span class="entity">put</span> <span class="entity">name</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">attr</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>     
  
<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Theory.setup
  <span class="main">(</span><span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹put_named_ss›</span></span> <span class="entity">put_named_simpset_attr</span> <span class="inner_quoted">"Activate named simpset"</span><span class="main">)</span>
  
  
  
<span class="comment1">(* ML antiquotation *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Theory.setup
  <span class="main">(</span>ML_Antiquotation.inline <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span>‹named_simpset›</span></span>
    <span class="main">(</span>Args.context -- Scan.lift <span class="main">(</span>Parse.position Args.embedded<span class="main">)</span> &gt;&gt;
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">name</span><span class="main">)</span> <span class="main">=&gt;</span> ML_Syntax.print_string <span class="main">(</span><span class="entity">check</span> <span class="entity">ctxt</span> <span class="entity">name</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

      
      
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
</pre>
</div><div id="Subgoal_Focus_Some">
<div class="head">
<h1>Theory Subgoal_Focus_Some</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Subgoal_Focus_Some
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹subgoal_focus_some.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/subgoal_focus_some.ML">
<div class="head">
<h1>File ‹subgoal_focus_some.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
  Generalized version of Subgoal.FOCUS, where the premises to be be focused 
    on can be selected by a filter function. This generalizes the 
    do_prems from bool to Proof.context -&gt; cterm -&gt; bool

  Author: Peter Lammich. Derived from subgoal_focus.ML.  
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">SUBGOAL_FOCUS_SOME</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">focus</span> <span class="main">=</span>
   <span class="main">{</span>context<span class="main">:</span> <span class="entity">Proof.context</span><span class="main">,</span> params<span class="main">:</span> <span class="main">(</span>string * cterm<span class="main">)</span> list<span class="main">,</span> prems<span class="main">:</span> thm list<span class="main">,</span> asms<span class="main">:</span> <span class="main">(</span>bool * cterm<span class="main">)</span> list<span class="main">,</span>
    concl<span class="main">:</span> cterm<span class="main">,</span> schematics<span class="main">:</span> <span class="main">(</span><span class="main">(</span>indexname * sort<span class="main">)</span> * ctyp<span class="main">)</span> list * <span class="main">(</span><span class="main">(</span>indexname * typ<span class="main">)</span> * cterm<span class="main">)</span> list<span class="main">}</span>

  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">prem_filter</span> <span class="main">=</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> bool  
    
  <span class="keyword1"><span class="keyword">val</span></span> focus_params<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> binding list option <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">focus</span> * thm
  <span class="keyword1"><span class="keyword">val</span></span> focus_params_fixed<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> binding list option <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">focus</span> * thm
  <span class="keyword1"><span class="keyword">val</span></span> focus_prems<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> binding list option <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">focus</span> * thm
  <span class="keyword1"><span class="keyword">val</span></span> focus<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> binding list option <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">focus</span> * thm
  <span class="keyword1"><span class="keyword">val</span></span> focus_some_prems<span class="main">:</span> <span class="entity">prem_filter</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> binding list option <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> <span class="entity">focus</span> * thm
  
  <span class="keyword1"><span class="keyword">val</span></span> retrofit<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span>string * cterm<span class="main">)</span> list <span class="main">-&gt;</span> <span class="main">(</span>bool * cterm<span class="main">)</span> list <span class="main">-&gt;</span>
    int <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm Seq.seq
  
  <span class="keyword1"><span class="keyword">val</span></span> FOCUS_PARAMS<span class="main">:</span> <span class="main">(</span><span class="entity">focus</span> <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> FOCUS_PARAMS_FIXED<span class="main">:</span> <span class="main">(</span><span class="entity">focus</span> <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> FOCUS_PREMS<span class="main">:</span> <span class="main">(</span><span class="entity">focus</span> <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> FOCUS<span class="main">:</span> <span class="main">(</span><span class="entity">focus</span> <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> FOCUS_SOME_PREMS<span class="main">:</span> <span class="entity">prem_filter</span> <span class="main">-&gt;</span> <span class="main">(</span><span class="entity">focus</span> <span class="main">-&gt;</span> tactic<span class="main">)</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Subgoal_Focus_Some</span> <span class="main">:</span> <span class="entity">SUBGOAL_FOCUS_SOME</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">focus</span> <span class="main">=</span>
   <span class="main">{</span>context<span class="main">:</span> <span class="entity">Proof.context</span><span class="main">,</span> params<span class="main">:</span> <span class="main">(</span>string * cterm<span class="main">)</span> list<span class="main">,</span> prems<span class="main">:</span> thm list<span class="main">,</span> asms<span class="main">:</span> <span class="main">(</span>bool * cterm<span class="main">)</span> list<span class="main">,</span>
    concl<span class="main">:</span> cterm<span class="main">,</span> schematics<span class="main">:</span> <span class="main">(</span><span class="main">(</span>indexname * sort<span class="main">)</span> * ctyp<span class="main">)</span> list * <span class="main">(</span><span class="main">(</span>indexname * typ<span class="main">)</span> * cterm<span class="main">)</span> list<span class="main">}</span>

  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">prem_filter</span> <span class="main">=</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> bool  
    

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">partition</span> <span class="entity">P</span> <span class="entity">l</span> <span class="main">=</span> <span class="main">(</span>filter <span class="entity">P</span> <span class="entity">l</span><span class="main">,</span> filter_out <span class="entity">P</span> <span class="entity">l</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">invert_perm</span> <span class="entity">l</span> <span class="main">=</span> tag_list <span class="inner_numeral">0</span> <span class="entity">l</span> |&gt; map swap |&gt; order_list

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_focus</span> <span class="main">(</span><span class="entity">do_prems</span><span class="main">,</span> <span class="entity">do_concl</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">bindings</span> <span class="entity">raw_st</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">raw_st</span>
      |&gt; Thm.transfer <span class="main">(</span>Proof_Context.theory_of <span class="entity">ctxt</span><span class="main">)</span>
      |&gt; Raw_Simplifier.norm_hhf_protect <span class="entity">ctxt</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">schematic_types</span><span class="main">,</span> <span class="main">[</span><span class="entity">st'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt1</span><span class="main">)</span> <span class="main">=</span> Variable.importT <span class="main">[</span><span class="entity">st</span><span class="main">]</span> <span class="entity">ctxt</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">params</span><span class="main">,</span> <span class="entity">goal</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt2</span><span class="main">)</span> <span class="main">=</span> Variable.focus_cterm <span class="entity">bindings</span> <span class="main">(</span>Thm.cprem_of <span class="entity">st'</span> <span class="entity">i</span><span class="main">)</span> <span class="entity">ctxt1</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">asms</span><span class="main">,</span> <span class="entity">concl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Drule.strip_imp_prems <span class="entity">goal</span><span class="main">,</span> Drule.strip_imp_concl <span class="entity">goal</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">asms</span> <span class="main">=</span> map <span class="main">(</span>`<span class="main">(</span><span class="entity">do_prems</span> <span class="entity">ctxt2</span><span class="main">)</span><span class="main">)</span> <span class="entity">asms</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fasms</span> <span class="main">=</span> filter fst <span class="entity">asms</span> |&gt; map snd
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nasms</span> <span class="main">=</span> filter_out fst <span class="entity">asms</span> |&gt; map snd
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> Drule.list_implies <span class="main">(</span><span class="entity">nasms</span><span class="main">,</span> <span class="entity">concl</span><span class="main">)</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">text</span> <span class="main">=</span> <span class="entity">fasms</span> @ <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">do_concl</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="entity">concl</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">inst</span><span class="main">,</span> <span class="entity">ctxt3</span><span class="main">)</span> <span class="main">=</span> Variable.import_inst true <span class="main">(</span>map Thm.term_of <span class="entity">text</span><span class="main">)</span> <span class="entity">ctxt2</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">schematic_terms</span> <span class="main">=</span> map <span class="main">(</span>apsnd <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">inst</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">schematics</span> <span class="main">=</span> <span class="main">(</span><span class="entity">schematic_types</span><span class="main">,</span> <span class="entity">schematic_terms</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">asms'</span> <span class="main">=</span> map <span class="main">(</span>apsnd <span class="main">(</span>Thm.instantiate_cterm <span class="entity">schematics</span><span class="main">)</span><span class="main">)</span> <span class="entity">asms</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fasms'</span> <span class="main">=</span> filter fst <span class="entity">asms'</span> |&gt; map snd
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl'</span> <span class="main">=</span> Thm.instantiate_cterm <span class="entity">schematics</span> <span class="entity">concl</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">prems</span><span class="main">,</span> <span class="entity">context</span><span class="main">)</span> <span class="main">=</span> Assumption.add_assumes <span class="entity">fasms'</span> <span class="entity">ctxt3</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="main">{</span>context <span class="main">=</span> <span class="entity">context</span><span class="main">,</span> params <span class="main">=</span> <span class="entity">params</span><span class="main">,</span> prems <span class="main">=</span> <span class="entity">prems</span><span class="main">,</span>
      asms <span class="main">=</span> <span class="entity">asms'</span><span class="main">,</span> concl <span class="main">=</span> <span class="entity">concl'</span><span class="main">,</span> schematics <span class="main">=</span> <span class="entity">schematics</span><span class="main">}</span><span class="main">,</span> Goal.init <span class="entity">concl'</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">focus_params</span> <span class="main">=</span> <span class="entity">gen_focus</span> <span class="main">(</span>K <span class="main">(</span>K false<span class="main">)</span><span class="main">,</span> false<span class="main">)</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">focus_params_fixed</span> <span class="main">=</span> <span class="entity">gen_focus</span> <span class="main">(</span>K <span class="main">(</span>K false<span class="main">)</span><span class="main">,</span> true<span class="main">)</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">focus_prems</span> <span class="main">=</span> <span class="entity">gen_focus</span> <span class="main">(</span>K <span class="main">(</span>K true<span class="main">)</span><span class="main">,</span> false<span class="main">)</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">focus</span> <span class="main">=</span> <span class="entity">gen_focus</span> <span class="main">(</span>K <span class="main">(</span>K true<span class="main">)</span><span class="main">,</span> true<span class="main">)</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">focus_some_prems</span> <span class="entity">flt</span> <span class="main">=</span> <span class="entity">gen_focus</span> <span class="main">(</span><span class="entity">flt</span><span class="main">,</span>false<span class="main">)</span>

  
  
<span class="comment1">(*
     B [?'b, ?y]
  ----------------
  B ['b, y params]
*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lift_import</span> <span class="entity">idx</span> <span class="entity">params</span> <span class="entity">th</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">[</span><span class="entity">th'</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt'</span><span class="main">)</span> <span class="main">=</span> Variable.importT <span class="main">[</span><span class="entity">th</span><span class="main">]</span> <span class="entity">ctxt</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Ts</span> <span class="main">=</span> map Thm.typ_of_cterm <span class="entity">params</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> map Thm.term_of <span class="entity">params</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop</span> <span class="main">=</span> Thm.full_prop_of <span class="entity">th'</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl_vars</span> <span class="main">=</span> Term.add_vars <span class="main">(</span>Logic.strip_imp_concl <span class="entity">prop</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> rev <span class="main">(</span>Term.add_vars <span class="entity">prop</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ys</span><span class="main">,</span> <span class="entity">ctxt''</span><span class="main">)</span> <span class="main">=</span> Variable.variant_fixes <span class="main">(</span>map <span class="main">(</span>Name.clean o <span class="main">#</span><span class="inner_numeral">1</span> o <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">vars</span><span class="main">)</span> <span class="entity">ctxt'</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">var_inst</span> <span class="entity">v</span> <span class="entity">y</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span> <span class="main">=</span> <span class="entity">v</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">U</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> member <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">concl_vars</span> <span class="entity">v</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">T</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">Ts</span> ---&gt; <span class="entity">T</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">u</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">y</span><span class="main">,</span> <span class="entity">U</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span>Var <span class="entity">v</span><span class="main">,</span> list_comb <span class="main">(</span><span class="entity">u</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">u</span><span class="main">,</span> Var <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">i</span> + <span class="entity">idx</span><span class="main">)</span><span class="main">,</span> <span class="entity">U</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">inst1</span><span class="main">,</span> <span class="entity">inst2</span><span class="main">)</span> <span class="main">=</span>
      split_list <span class="main">(</span>map <span class="main">(</span>apply2 <span class="main">(</span>apply2 <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map2 <span class="entity">var_inst</span> <span class="entity">vars</span> <span class="entity">ys</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th''</span> <span class="main">=</span> Thm.instantiate <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> map <span class="main">(</span>apfst <span class="main">(</span>Term.dest_Var o Thm.term_of<span class="main">)</span><span class="main">)</span> <span class="entity">inst1</span><span class="main">)</span> <span class="entity">th'</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">inst2</span><span class="main">,</span> <span class="entity">th''</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt''</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  
  
<span class="comment1">(*
       [x, A x]
          :
       B x ==&gt; C
  ------------------
  [!!x. A x ==&gt; B x]
          :
          C
*)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lift_subgoals</span> <span class="entity">ctxt</span> <span class="entity">params</span> <span class="entity">asms</span> <span class="entity">th</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lift</span> <span class="entity">ct</span> <span class="main">=</span> fold_rev <span class="main">(</span>Thm.all_name <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">params</span> <span class="main">(</span>Drule.list_implies <span class="main">(</span><span class="entity">asms</span><span class="main">,</span> <span class="entity">ct</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unlift</span> <span class="main">=</span>
      fold <span class="main">(</span>Thm.elim_implies o Thm.assume<span class="main">)</span> <span class="entity">asms</span> o
      Drule.forall_elim_list <span class="main">(</span>map <span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">params</span><span class="main">)</span> o Thm.assume<span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subgoals</span> <span class="main">=</span> map <span class="entity">lift</span> <span class="main">(</span>Drule.strip_imp_prems <span class="main">(</span>Thm.cprop_of <span class="entity">th</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">th'</span> <span class="main">=</span> fold <span class="main">(</span>Thm.elim_implies o <span class="entity">unlift</span><span class="main">)</span> <span class="entity">subgoals</span> <span class="entity">th</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">subgoals</span><span class="main">,</span> <span class="entity">th'</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">retrofit</span> <span class="entity">ctxt1</span> <span class="entity">ctxt0</span> <span class="entity">params</span> <span class="entity">all_asms</span> <span class="entity">i</span> <span class="entity">st1</span> <span class="entity">st0</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">asms</span> <span class="main">=</span> filter fst <span class="entity">all_asms</span> |&gt; map snd
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">perm</span> <span class="main">=</span> tag_list <span class="inner_numeral">0</span> <span class="entity">all_asms</span> |&gt; <span class="entity">partition</span> <span class="main">(</span>fst o snd<span class="main">)</span> |&gt; <span class="keyword1"><span class="keyword">op</span></span> @ |&gt; map fst
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">perm</span> <span class="main">=</span> <span class="entity">invert_perm</span> <span class="entity">perm</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">idx</span> <span class="main">=</span> Thm.maxidx_of <span class="entity">st0</span> + <span class="inner_numeral">1</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> map <span class="main">#</span><span class="inner_numeral">2</span> <span class="entity">params</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">subgoal_inst</span><span class="main">,</span> <span class="entity">st2</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">lift_import</span> <span class="entity">idx</span> <span class="entity">ps</span> <span class="entity">st1</span> <span class="entity">ctxt1</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">subgoals</span><span class="main">,</span> <span class="entity">st3</span><span class="main">)</span> <span class="main">=</span> <span class="entity">lift_subgoals</span> <span class="entity">ctxt2</span> <span class="entity">params</span> <span class="entity">asms</span> <span class="entity">st2</span><span class="main">;</span>
        
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">st3</span>
      |&gt; Goal.conclude 
      |&gt; Drule.implies_intr_list <span class="entity">asms</span>
      |&gt; Drule.rearrange_prems <span class="entity">perm</span>
      |&gt; Drule.forall_intr_list <span class="entity">ps</span>
      |&gt; Drule.implies_intr_list <span class="entity">subgoals</span>
      |&gt; fold_rev <span class="main">(</span>Thm.forall_intr o <span class="main">#</span><span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">subgoal_inst</span>
      |&gt; fold <span class="main">(</span>Thm.forall_elim o <span class="main">#</span><span class="inner_numeral">2</span><span class="main">)</span> <span class="entity">subgoal_inst</span>
      |&gt; Thm.adjust_maxidx_thm <span class="entity">idx</span>
      |&gt; singleton <span class="main">(</span>Variable.export <span class="entity">ctxt2</span> <span class="entity">ctxt0</span><span class="main">)</span><span class="main">;</span>
      
  <span class="keyword2"><span class="keyword">in</span></span>
    Thm.bicompose <span class="main">(</span>SOME <span class="entity">ctxt0</span><span class="main">)</span> <span class="main">{</span>flatten <span class="main">=</span> true<span class="main">,</span> match <span class="main">=</span> false<span class="main">,</span> incremented <span class="main">=</span> false<span class="main">}</span>
      <span class="main">(</span>false<span class="main">,</span> <span class="entity">result</span><span class="main">,</span> Thm.nprems_of <span class="entity">st1</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">st0</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  
  
  

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">GEN_FOCUS</span> <span class="entity">flags</span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> Thm.nprems_of <span class="entity">st</span> &lt; <span class="entity">i</span> <span class="keyword2"><span class="keyword">then</span></span> Seq.empty
  <span class="keyword2"><span class="keyword">else</span></span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">args</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt'</span><span class="main">,</span> <span class="entity">params</span><span class="main">,</span> <span class="entity">asms</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span><span class="main">,</span> <span class="entity">st'</span><span class="main">)</span> <span class="main">=</span>
      <span class="entity">gen_focus</span> <span class="entity">flags</span> <span class="main">(</span><span class="entity">ctxt</span> |&gt; Variable.set_bound_focus true<span class="main">)</span> <span class="entity">i</span> NONE <span class="entity">st</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> Seq.lifts <span class="main">(</span><span class="entity">retrofit</span> <span class="entity">ctxt'</span> <span class="entity">ctxt</span> <span class="entity">params</span> <span class="entity">asms</span> <span class="entity">i</span><span class="main">)</span> <span class="main">(</span><span class="entity">tac</span> <span class="entity">args</span> <span class="entity">st'</span><span class="main">)</span> <span class="entity">st</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">FOCUS_PARAMS</span> <span class="main">=</span> <span class="entity">GEN_FOCUS</span> <span class="main">(</span>K <span class="main">(</span>K false<span class="main">)</span><span class="main">,</span> false<span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">FOCUS_PARAMS_FIXED</span> <span class="main">=</span> <span class="entity">GEN_FOCUS</span> <span class="main">(</span>K <span class="main">(</span>K false<span class="main">)</span><span class="main">,</span> true<span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">FOCUS_PREMS</span> <span class="main">=</span> <span class="entity">GEN_FOCUS</span> <span class="main">(</span>K <span class="main">(</span>K true<span class="main">)</span><span class="main">,</span> false<span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">FOCUS</span> <span class="main">=</span> <span class="entity">GEN_FOCUS</span> <span class="main">(</span>K <span class="main">(</span>K true<span class="main">)</span><span class="main">,</span> true<span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">FOCUS_SOME_PREMS</span> <span class="entity">flt</span> <span class="main">=</span> <span class="entity">GEN_FOCUS</span> <span class="main">(</span><span class="entity">flt</span><span class="main">,</span> true<span class="main">)</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="Syntax">
<div class="head">
<h1>Theory Syntax</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Syntax of IMP2›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Syntax
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the abstract syntax of the IMP2 language, 
    and a minimal concrete syntax for direct use in terms.›</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Primitives›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Variable and procedure names are strings.›</span></span>
  <span class="keyword1"><span class="command">type_synonym</span></span> vname <span class="main">=</span> <span class="quoted">string</span>
  <span class="keyword1"><span class="command">type_synonym</span></span> pname <span class="main">=</span> <span class="quoted">string</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The variable names are partitioned into local and global variables.›</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_global</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">is_global</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_global</span> <span class="main">(</span><span class="keyword1">CHR</span> <span class="inner_quoted">''G''</span><span class="main">#</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_global</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_local</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">¬</span>is_global <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
  
  
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Primitive values are integers,
    and values are arrays modeled as functions from integers to primitive values.
    
    Note that values and primitive values are usually part of the semantics, however, 
    as they occur as literals in the abstract syntax, we already define them here.
  ›</span></span>
  
  <span class="keyword1"><span class="command">type_synonym</span></span> pval <span class="main">=</span> <span class="quoted"><span class="quoted">"int"</span></span>
  <span class="keyword1"><span class="command">type_synonym</span></span> val <span class="main">=</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> pval"</span></span>

  <span class="comment1">(*
    TODO: Cf. SortedAlgebra, used in CeTa. Akihisa Yamada
      Should give aexp, bexp with type-checking, term ops, etc.
  
  *)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Arithmetic Expressions›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Arithmetic expressions consist of constants, indexed array variables, 
    and unary and binary operations. The operations are modeled by reflecting 
    arbitrary functions into the abstract syntax.›</span></span>
  
  <span class="keyword1"><span class="command">datatype</span></span> aexp <span class="main">=</span> 
      N <span class="quoted">int</span> 
    <span class="main">|</span> Vidx <span class="quoted">vname</span> <span class="quoted">aexp</span>
    <span class="main">|</span> Unop <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int"</span></span> <span class="quoted">aexp</span> 
    <span class="main">|</span> Binop <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int"</span></span> <span class="quoted">aexp</span> <span class="quoted">aexp</span>
    
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Boolean Expressions›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Boolean expressions consist of constants, the not operation, binary connectives, 
    and comparison operations. Binary connectives and comparison operations are modeled by
    reflecting arbitrary functions into the abstract syntax. The not operation is the only 
    meaningful unary Boolean operation, so we chose to model it explicitly instead of 
    reflecting and unary Boolean function.›</span></span>
    
  <span class="keyword1"><span class="command">datatype</span></span> bexp <span class="main">=</span> 
      Bc <span class="quoted">bool</span> 
    <span class="main">|</span> Not <span class="quoted">bexp</span> 
    <span class="main">|</span> BBinop <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="quoted">bexp</span> <span class="quoted">bexp</span> 
    <span class="main">|</span> Cmpop <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span></span> <span class="quoted">aexp</span> <span class="quoted">aexp</span>

    
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Commands›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    The commands can roughly be put into five categories:
    <span class="antiquoted"><span class="antiquoted">➧</span></span>[Skip] The no-op command
    <span class="antiquoted"><span class="antiquoted">➧</span></span>[Assignment commands] Commands to assign the value of an arithmetic expression, copy or clear arrays,
      and a command to simultaneously assign all local variables, which is only used internally 
      to simplify the definition of a small-step semantics.
    <span class="antiquoted"><span class="antiquoted">➧</span></span>[Block commands] The standard sequential composition, if-then-else, and while commands,
      and a scope command which executes a command with a fresh set of local variables.
    <span class="antiquoted"><span class="antiquoted">➧</span></span>[Procedure commands] Procedure call, and a procedure scope command, which executes
      a command in a specified procedure environment. Similar to the scope command, 
      which introduces new local variables, and thus limits the effect of variable manipulations
      to the content of the command, the procedure scope command introduces new procedures,
      and limits the validity of their names to the content of the command. This greatly 
      simplifies modular definition of programs, as procedure names can be used locally.
      
  ›</span></span>
  
  
  <span class="keyword1"><span class="command">datatype</span></span>
    com <span class="main">=</span> 
        SKIP                              <span class="comment1">― ‹No-op›</span>
        
        <span class="comment1">― ‹Assignment›</span> 
        <span class="main">|</span> AssignIdx <span class="quoted">vname</span> <span class="quoted">aexp</span> <span class="quoted">aexp</span>       <span class="comment1">― ‹Assign to index in array›</span>
        <span class="main">|</span> ArrayCpy <span class="quoted">vname</span> <span class="quoted">vname</span>            <span class="comment1">― ‹Copy whole array›</span>
        <span class="main">|</span> ArrayClear <span class="quoted">vname</span>                <span class="comment1">― ‹Clear array›</span>
        <span class="main">|</span> Assign_Locals <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> val"</span></span>    <span class="comment1">― ‹Internal: Assign all local variables simultaneously›</span>
        
        <span class="comment1">― ‹Block›</span>
        <span class="main">|</span> Seq    <span class="quoted">com</span>  <span class="quoted">com</span>                 <span class="comment1">― ‹Sequential composition›</span>
        <span class="main">|</span> If     <span class="quoted">bexp</span> <span class="quoted">com</span> <span class="quoted">com</span>             <span class="comment1">― ‹Conditional›</span>
        <span class="main">|</span> While  <span class="quoted">bexp</span> <span class="quoted">com</span>                 <span class="comment1">― ‹While-loop›</span>
        <span class="main">|</span> Scope <span class="quoted">com</span>                       <span class="comment1">― ‹Local variable scope›</span>
        
        <span class="comment1">― ‹Procedure›</span>
        <span class="main">|</span> PCall <span class="quoted">pname</span>                     <span class="comment1">― ‹Procedure call›</span>
        <span class="main">|</span> PScope <span class="quoted"><span class="quoted">"pname <span class="main">⇀</span> com"</span></span> <span class="quoted">com</span>       <span class="comment1">― ‹Procedure scope›</span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Minimal Concrete Syntax›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The commands come with a minimal concrete syntax, which is compatible 
    to the syntax of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>IMP›</span></span></span></span>.›</span></span>
  
  <span class="keyword1"><span class="command">notation</span></span> AssignIdx      <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_<span class="keyword1">]</span> <span class="keyword1">::=</span> _"</span> <span class="main">[</span>1000<span class="main">,</span> 0<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> ArrayCpy       <span class="main">(</span><span class="quoted">"_<span class="keyword1">[]</span> <span class="keyword1">::=</span> _"</span> <span class="main">[</span>1000<span class="main">,</span> 1000<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> ArrayClear     <span class="main">(</span><span class="quoted">"<span class="keyword1">CLEAR</span> _<span class="keyword1">[]</span>"</span> <span class="main">[</span>1000<span class="main">]</span> 61<span class="main">)</span>
  
  <span class="keyword1"><span class="command">notation</span></span> Seq            <span class="main">(</span><span class="quoted">"_<span class="keyword1">;;</span><span class="keyword3">/ </span>_"</span>  <span class="main">[</span>61<span class="main">,</span> 60<span class="main">]</span> 60<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> If             <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">IF</span> _<span class="keyword3">/ </span><span class="keyword1">THEN</span> _<span class="keyword3">/ </span><span class="keyword1">ELSE</span> _<span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> While          <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">WHILE</span> _<span class="keyword3">/ </span><span class="keyword1">DO</span> _<span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword1"><span class="command">notation</span></span> Scope          <span class="main">(</span><span class="quoted">"<span class="keyword1">SCOPE</span> _"</span> <span class="main">[</span>61<span class="main">]</span> 61<span class="main">)</span>
        
        
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Program›</span></span>                
  <span class="keyword1"><span class="command">type_synonym</span></span> program <span class="main">=</span> <span class="quoted"><span class="quoted">"pname <span class="main">⇀</span> com"</span></span>
        

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Default Array Index›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define abbreviations to make arrays look like plain integer variables:
    Without explicitly specifying an array index, the index <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span> will be used automatically.
  ›</span></span>
  
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Vidx <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>N <span class="main">0</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Assign</span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">::=</span> _"</span> <span class="main">[</span>1000<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">::=</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[</span>N <span class="main">0</span><span class="main">]</span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
        
   
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Semantics">
<div class="head">
<h1>Theory Semantics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Semantics of IMP›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Semantics
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Syntax.html">Syntax</a> <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach_Tools.html">HOL-Eisbach.Eisbach_Tools</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹State›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state maps variable names to values›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> val"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We introduce some syntax for the null state, and a state where only certain 
  variables are set.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">null_state</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;&gt;</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">null_state</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">syntax</span></span> 
  <span class="quoted">"_State"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"updbinds <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;</span>_<span class="keyword1">&gt;</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_State <span class="free">ms</span>"</span> <span class="main">==</span> <span class="quoted">"_Update <span class="main">&lt;&gt;</span> <span class="free">ms</span>"</span>
  <span class="quoted">"_State <span class="main">(</span>_updbinds <span class="free">b</span> <span class="free">bs</span><span class="main">)</span>"</span> <span class="main">&lt;=</span> <span class="quoted">"_Update <span class="main">(</span>_State <span class="free">b</span><span class="main">)</span> <span class="free">bs</span>"</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹State Combination›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state combination operator constructs a state by 
  taking the local variables from one state, and the globals from another state.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">combine_states</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> state"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">&lt;</span>_<span class="keyword1">|</span>_<span class="keyword1">&gt;</span>"</span> <span class="main">[</span>0<span class="main">,</span>0<span class="main">]</span> 1000<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">&lt;</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">|</span></span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">&gt;</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_local <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove some basic facts. 

Note that we use Isabelle's context command to locally declare the 
  definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> combine_states<span class="antiquote"><span class="antiquote">}</span></span></span></span> as simp lemma, such that it is 
  unfolded automatically.›</span></span>
  
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> combine_states_def <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_collapse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">s</span><span class="main">&gt;</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> combine_nest<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="main">&lt;</span><span class="free">s'</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span><span class="main">&gt;</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t'</span><span class="main">&gt;</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  
<span class="keyword1"><span class="command">lemma</span></span> combine_query<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_local <span class="free">x</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span> <span class="free">x</span> <span class="main">=</span> <span class="free">s</span> <span class="free">x</span>"</span></span>  
  <span class="quoted"><span class="quoted">"is_global <span class="free">x</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span> <span class="free">x</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> combine_upd<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_local <span class="free">x</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span>"</span></span>  
  <span class="quoted"><span class="quoted">"is_global <span class="free">x</span> <span class="main">⟹</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">&gt;</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  
<span class="keyword1"><span class="command">lemma</span></span> combine_cases<span class="main">[</span><span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="free">g</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">l</span><span class="main">|</span><span class="free">g</span><span class="main">&gt;</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
  
<span class="keyword2"><span class="keyword">end</span></span>  
  
  
  
    
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Arithmetic Expressions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The evaluation of arithmetic expressions is straightforward. ›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"aexp <span class="main">⇒</span> state <span class="main">⇒</span> pval"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>N <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>Vidx <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>Unop <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">aval</span> <span class="main">(</span>Binop <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">aval</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Boolean Expressions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The evaluation of Boolean expressions is straightforward. ›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bexp <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bval</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bval</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">bval</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bval</span> <span class="main">(</span>BBinop <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">bval</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">bval</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bval</span> <span class="main">(</span>Cmpop <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>aval <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>aval <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Big-Step Semantics›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The big-step semantics is a relation from commands and start states to end states,
  such that there is a terminating execution.

  If there is no such execution, no end state will be related to the command and start state.
  This either means that the program does not terminate, or gets stuck because it tries to call
  an undefined procedure.

  The inference rules of the big-step semantics are pretty straightforward.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">big_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"program <span class="main">⇒</span> com <span class="main">×</span> state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> 
  <span class="main">(</span><span class="quoted">"_<span class="keyword1">:</span> _ <span class="keyword1">⇒</span> _"</span> <span class="main">[</span>1000<span class="main">,</span>55<span class="main">,</span>55<span class="main">]</span> 55<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹No-Op›</span>
  Skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span>SKIP<span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> 
  
  <span class="comment1">― ‹Assignments›</span>
<span class="main">|</span> AssignIdx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">(</span>aval <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">:=</span> aval <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="main">|</span> ArrayCpy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[]</span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> ArrayClear<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="main">|</span> Assign_Locals<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span>Assign_Locals <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">&gt;</span>"</span></span>

  <span class="comment1">― ‹Block commands›</span>
<span class="main">|</span> Seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span>  <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>3</sub></span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>3</sub></span></span></span>"</span></span> 
<span class="main">|</span> IfTrue<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> 
<span class="main">|</span> IfFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span>bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>  <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> 
<span class="main">|</span> Scope<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">&gt;</span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">&gt;</span>"</span></span>
<span class="main">|</span> WhileFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> 
<span class="main">|</span> WhileTrue<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span>  <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span>  <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>3</sub></span></span></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>3</sub></span></span></span>"</span></span>

  <span class="comment1">― ‹Procedure commands›</span>        
<span class="main">|</span> PCall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span>PCall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>    
<span class="main">|</span> PScope<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">:</span></span><span class="main">(</span>PScope <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proof Automation›</span></span>    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We do some setup to make proofs over the big-step semantics more automatic.
›</span></span>

<span class="keyword1"><span class="command">declare</span></span> big_step.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> big_step_induct<span class="main">[</span><span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main">]</span> <span class="main">=</span> big_step.induct<span class="main">[</span><span class="operator">split_format</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive_simps</span></span> Skip_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span>SKIP<span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> AssignIdx_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">::=</span> <span class="free">a</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> ArrayCpy_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">x</span><span class="main">[]</span> <span class="main">::=</span> <span class="free">y</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> ArrayInit_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free">x</span><span class="main">[]</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> AssignLocals_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span>Assign_Locals <span class="free">l</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> Seq_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c1</span><span class="main">;;</span><span class="free">c2</span><span class="main">,</span><span class="free">s1</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">s3</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> If_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> Scope_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> PCall_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span>PCall <span class="free">p</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> PScope_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span>PScope <span class="free">π'</span> <span class="free">p</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> big_step_simps <span class="main">=</span> 
  Skip_simp AssignIdx_simp ArrayCpy_simp ArrayInit_simp
  Seq_simp If_simp Scope_simp PCall_simp PScope_simp

  
<span class="keyword1"><span class="command">inductive_cases</span></span> SkipE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span>SKIP<span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> AssignIdxE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">::=</span> <span class="free">a</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ArrayCpyE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">x</span><span class="main">[]</span> <span class="main">::=</span> <span class="free">y</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ArrayInitE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free">x</span><span class="main">[]</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> AssignLocalsE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span>Assign_Locals <span class="free">l</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> SeqE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c1</span><span class="main">;;</span><span class="free">c2</span><span class="main">,</span><span class="free">s1</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">s3</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> IfE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ScopeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> PCallE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span>PCall <span class="free">p</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> PScopeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span>PScope <span class="free">π'</span> <span class="free">p</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  
<span class="keyword1"><span class="command">inductive_cases</span></span> WhileE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
                             

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Automatic Derivation›</span></span>
  <span class="comment1">(* TODO: More comments, test *)</span>
  <span class="comment1">(* Testing the programs by constructing big-step derivations automatically *)</span>    
    
  <span class="comment1">(* This rule is used to enforce simplification of the newly generated state, before passing it on *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> Assign'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">(</span>aval <span class="free">i</span> <span class="free">s</span> <span class="main">:=</span> aval <span class="free">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">::=</span> <span class="free">a</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> ArrayCpy'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="free">s</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">x</span><span class="main">[]</span> <span class="main">::=</span> <span class="free">y</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> ArrayClear'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free">x</span><span class="main">[]</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> Scope'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="free">s</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">=</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span>Scope <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">named_theorems</span></span> deriv_unfolds <span class="quoted">‹Unfold rules before derivations›</span>
  
  <span class="keyword1"><span class="command">method</span></span> bs_simp <span class="main">=</span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> combine_nest combine_upd combine_query fun_upd_same fun_upd_other <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply
  
  <span class="keyword1"><span class="command">method</span></span> big_step' <span class="main">=</span> 
    <span class="operator">rule</span> Skip Seq PScope
  <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">rule</span> Assign' ArrayCpy' ArrayClear'<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main">)</span> 
  <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">rule</span> IfTrue IfFalse WhileTrue WhileFalse PCall Scope'<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
  <span class="main"><span class="keyword3">|</span></span> <span class="operator">unfold</span> <span class="dynamic"><span class="dynamic">deriv_unfolds</span></span>
  <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  
      
  <span class="keyword1"><span class="command">method</span></span> big_step <span class="main">=</span> 
    <span class="operator">rule</span> Skip 
  <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> Seq<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">big_step</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">big_step</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
  <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> PScope<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">big_step</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>  
  <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">rule</span> Assign' ArrayCpy' ArrayClear'<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main">)</span> 
  <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">rule</span> IfTrue IfFalse<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">big_step</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
  <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> WhileTrue<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">big_step</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">big_step</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
  <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> WhileFalse<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
  <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> PCall<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">big_step</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span>
  <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">rule</span> Scope'<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">big_step</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">bs_simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">fail</span><span class="main">)</span><span class="main">)</span>
  <span class="main"><span class="keyword3">|</span></span> <span class="operator">unfold</span> <span class="dynamic"><span class="dynamic">deriv_unfolds</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">big_step</span>
  
  <span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"Map.empty<span class="main">:</span> <span class="main">(</span>
    <span class="inner_quoted">''a''</span> <span class="main">::=</span> N <span class="main">1</span><span class="main">;;</span>
    <span class="keyword1">WHILE</span> Cmpop <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>V <span class="inner_quoted">''n''</span><span class="main">)</span> <span class="main">(</span>N <span class="main">0</span><span class="main">)</span> <span class="keyword1">DO</span> <span class="main">(</span>
      <span class="inner_quoted">''a''</span> <span class="main">::=</span> Binop <span class="main">(+)</span> <span class="main">(</span>V <span class="inner_quoted">''a''</span><span class="main">)</span> <span class="main">(</span>V <span class="inner_quoted">''a''</span><span class="main">)</span><span class="main">;;</span> 
      <span class="inner_quoted">''n''</span> <span class="main">::=</span> Binop <span class="main">(-)</span> <span class="main">(</span>V <span class="inner_quoted">''n''</span><span class="main">)</span> <span class="main">(</span>N <span class="main">1</span><span class="main">)</span>
    <span class="main">)</span><span class="main">,</span><span class="main">&lt;</span><span class="inner_quoted">''n''</span><span class="main">:=</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">5</span><span class="main">)</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">⇒</span> <span class="var">?s</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">big_step</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Command Equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Two commands are equivalent if they have the same semantics.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">equiv_c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> com <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">∼</span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">π</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">π</span><span class="main">:</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span>  <span class="main">=</span> <span class="bound">π</span><span class="main">:</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> equivI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>
  <span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">π</span><span class="main">.</span> <span class="bound">π</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">π</span><span class="main">:</span><span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span><span class="main">;</span> 
  <span class="main">⋀</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">π</span><span class="main">.</span> <span class="bound">π</span><span class="main">:</span><span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">π</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span><span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_c_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> equivD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> equiv_c_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Command equivalence is an equivalence relation, i.e.\ it is
reflexive, symmetric, and transitive.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> equiv_refl<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∼</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equivI<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> equiv_sym<span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c'</span> <span class="main">∼</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equivI<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> equiv_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">∼</span> <span class="free">c''</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">∼</span> <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equivI<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Equivalences›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> while_unfold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">∼</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span><span class="main">;;</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="keyword1">ELSE</span> SKIP<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> triv_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c</span> <span class="keyword1">ELSE</span> <span class="free">c</span><span class="main">)</span> <span class="main">∼</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> equivI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> commute_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">IF</span> <span class="free">b1</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b2</span> <span class="keyword1">THEN</span> <span class="free">c11</span> <span class="keyword1">ELSE</span> <span class="free">c12</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="free">c2</span><span class="main">)</span> 
   <span class="main">∼</span> 
   <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b2</span> <span class="keyword1">THEN</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b1</span> <span class="keyword1">THEN</span> <span class="free">c11</span> <span class="keyword1">ELSE</span> <span class="free">c2</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b1</span> <span class="keyword1">THEN</span> <span class="free">c12</span> <span class="keyword1">ELSE</span> <span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> equivI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sim_while_cong_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span><span class="main">;</span> bval <span class="free">b</span> <span class="main">=</span> bval <span class="free">b'</span><span class="main">;</span> <span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> big_step_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sim_while_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"bval <span class="free">b</span> <span class="main">=</span> bval <span class="free">b'</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span> <span class="main">⟹</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="main">∼</span> <span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> equiv_c_def sim_while_cong_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Execution is Deterministic›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This proof is automatic.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> big_step_determ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span><span class="main">;</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">u</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> big_step.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WhileTrue <span class="skolem">b</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Small-Step Semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The small step semantics is defined by a step function on
  a pair of command and state. Intuitively, the command is 
  the remaining part of the program that still has to be executed.
  The step function is defined to stutter if the command is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> SKIP<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  
  Moreover, the step function is explicitly partial, returning <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  on error, i.e., on an undefined procedure call.

  Most steps are straightforward. 
  For a sequential composition, steps are performed on the first command, 
  until it has been reduced to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> SKIP<span class="antiquote"><span class="antiquote">}</span></span></span></span>, then the sequential composition is 
  reduced to the second command. 

  A while command is reduced by unfolding the loop once.
    
  A scope command is reduced to the inner command, followed by 
  an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Assign_Locals<span class="antiquote"><span class="antiquote">}</span></span></span></span> command to restore the original local variables.

  A procedure scope command is reduced by performing a step in the inner command, 
  with the new procedure environment, until the inner command has been reduced to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> SKIP<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  Then, the whole command is reduced to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> SKIP<span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">small_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"program <span class="main">⇒</span> com <span class="main">×</span> state <span class="main">⇀</span> com <span class="main">×</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span><span class="main">::=</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>SKIP<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">(</span>aval <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">:=</span> aval <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[]</span><span class="main">::=</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>SKIP<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>  
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>SKIP<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>Assign_Locals <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>SKIP<span class="main">,</span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">&gt;</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>SKIP<span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">if</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;;</span>Assign_Locals <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">&gt;</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;;</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">ELSE</span> SKIP<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PCall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> Some <span class="bound">c</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PScope <span class="free"><span class="bound"><span class="entity">π'</span></span></span> SKIP<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>SKIP<span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PScope <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>PScope <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">small_step</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>SKIP<span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>SKIP<span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define the reflexive transitive closure of the step function.
›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">small_steps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"program <span class="main">⇒</span> com <span class="main">×</span> state <span class="main">⇒</span> <span class="main">(</span>com <span class="main">×</span> state<span class="main">)</span> option <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">small_steps</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> small_step <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> None <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">small_steps</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> small_step <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">cs1</span></span></span><span class="main">;</span> <span class="free">small_steps</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">cs1</span></span></span> <span class="free"><span class="bound"><span class="entity">cs2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">small_steps</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">cs2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> small_steps_append<span class="main">:</span> <span class="quoted"><span class="quoted">"small_steps <span class="free">π</span> <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Some <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟹</span> small_steps <span class="free">π</span> <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">cs<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⟹</span> small_steps <span class="free">π</span> <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">cs<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="quoted">"Some <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_steps.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Equivalence to Big-Step Semantics›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that the small-step semantics yields a final 
  configuration if and only if the big-step semantics terminates with the respective state.
  
  Moreover, we show that the big-step semantics gets stuck if the small-step semantics 
  yields an error.
  ›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> small_big_append<span class="main">:</span> <span class="quoted"><span class="quoted">"small_step <span class="free">π</span> <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span> <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span> <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_step.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> smalls_big_append<span class="main">:</span> <span class="quoted"><span class="quoted">"small_steps <span class="free">π</span> <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Some <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span> <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⟹</span> <span class="free">π</span><span class="main">:</span> <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="free">s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="quoted">"Some <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_steps.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_big_append<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> small_imp_big<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"small_steps <span class="free">π</span> <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Some <span class="main">(</span>SKIP<span class="main">,</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="free">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smalls_big_append<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> small_steps_skip_term<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"small_steps <span class="free">π</span> <span class="main">(</span>SKIP<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">cs'</span> <span class="main">⟷</span> <span class="free">cs'</span><span class="main">=</span>Some <span class="main">(</span>SKIP<span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>SKIP<span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">cs'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_steps.induct<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> small_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span><span class="main">≠</span>SKIP<span class="main">;</span> small_step <span class="free">π</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> small_step <span class="free">π</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span><span class="free">cx</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">c'</span><span class="main">;;</span><span class="free">cx</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_step.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> smalls_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>small_steps <span class="free">π</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> small_steps <span class="free">π</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span><span class="free">cx</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">c'</span><span class="main">;;</span><span class="free">cx</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_steps.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> small_seq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> small_seq small_step.simps<span class="main"><span class="main">(</span></span>31<span class="main"><span class="main">)</span></span> small_steps.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> small_pscope<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">c</span><span class="main">≠</span>SKIP<span class="main">;</span> small_step <span class="free">π'</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> small_step <span class="free">π</span> <span class="main">(</span>PScope <span class="free">π'</span> <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>PScope <span class="free">π'</span> <span class="free">c'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_step.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> smalls_pscope<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"small_steps <span class="free">π'</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> small_steps <span class="free">π</span> <span class="main">(</span>PScope <span class="free">π'</span> <span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>PScope <span class="free">π'</span> <span class="free">c'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_steps.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> option.inject prod.inject small_pscope small_steps.simps small_steps_append small_steps_skip_term<span class="main">)</span>
  
  
  
<span class="keyword1"><span class="command">lemma</span></span> big_imp_small<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="free">cs</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"small_steps <span class="free">π</span> <span class="free">cs</span> <span class="main">(</span>Some <span class="main">(</span>SKIP<span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">π</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AssignIdx <span class="skolem">π</span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">a</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ArrayCpy <span class="skolem">π</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ArrayClear <span class="skolem">π</span> <span class="skolem">x</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Seq <span class="skolem">π</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> small_step.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> small_steps.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> small_steps_append smalls_seq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfTrue <span class="skolem">b</span> <span class="skolem">s</span> <span class="skolem">π</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfFalse <span class="skolem">b</span> <span class="skolem">s</span> <span class="skolem">π</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Scope <span class="skolem">π</span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> small_step.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> small_step.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> small_step.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> small_steps.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> small_steps.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> small_steps_append smalls_seq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WhileFalse <span class="skolem">b</span> <span class="skolem">s</span> <span class="skolem">π</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WhileTrue <span class="skolem">b</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">π</span> <span class="skolem">c</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ca</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span>small_steps <span class="skolem">π</span> <span class="bound">p</span> <span class="main">(</span>Some <span class="main">(</span>SKIP<span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> Some <span class="main">(</span><span class="bound">ca</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≠</span> Some <span class="main">(</span><span class="keyword1">WHILE</span> <span class="skolem">b</span> <span class="keyword1">DO</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> small_step <span class="skolem">π</span> <span class="bound">p</span> <span class="main">≠</span> Some <span class="main">(</span><span class="skolem">c</span><span class="main">;;</span> <span class="bound">ca</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> WhileTrue.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WhileTrue.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> small_step.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> small_steps.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> small_steps_append smalls_seq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ca</span> <span class="bound">cb</span> <span class="bound">cc</span><span class="main">.</span> <span class="main">(</span>small_steps <span class="skolem">π</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="skolem">b</span> <span class="keyword1">THEN</span> <span class="bound">cc</span> <span class="keyword1">ELSE</span> <span class="bound">ca</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>SKIP<span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> Some <span class="main">(</span><span class="bound">cb</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">≠</span> Some <span class="main">(</span><span class="keyword1">WHILE</span> <span class="skolem">b</span> <span class="keyword1">DO</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> Some <span class="main">(</span><span class="bound">cc</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≠</span> Some <span class="main">(</span><span class="skolem">c</span><span class="main">;;</span> <span class="bound">cb</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> WhileTrue.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> small_step.simps<span class="main">(</span>18<span class="main">)</span> small_steps.intros<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PCall <span class="skolem">π</span> <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PScope <span class="skolem">π'</span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">π</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> small_step.simps<span class="main"><span class="main">(</span></span>20<span class="main"><span class="main">)</span></span> small_steps.simps small_steps_append smalls_pscope<span class="main">)</span>
  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Assign_Locals <span class="skolem">π</span> <span class="skolem">l</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> small_steps.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The big-step semantics yields a state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span>, iff and only iff there is a transition 
  of the small-step semantics to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(SKIP,t).›</span></span></span></span>
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> big_eq_small<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="free">cs</span><span class="main">⇒</span><span class="free">t</span> <span class="main">⟷</span> small_steps <span class="free">π</span> <span class="free">cs</span> <span class="main">(</span>Some <span class="main">(</span>SKIP<span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> big_imp_small small_imp_big <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> small_steps_determ<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"small_steps <span class="free">π</span> <span class="free">cs</span> None"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>small_steps <span class="free">π</span> <span class="free">cs</span> <span class="main">(</span>Some <span class="main">(</span>SKIP<span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="quoted">"None<span class="main">::</span><span class="main">(</span>com<span class="main">×</span>state<span class="main">)</span> option"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> small_steps.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> small_steps.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the small-step semantics reaches a failure state, the big-step semantics gets stuck.›</span></span>    
<span class="keyword1"><span class="command">corollary</span></span> small_imp_big_fail<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"small_steps <span class="free">π</span> <span class="free">cs</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">t</span><span class="main">.</span> <span class="free">π</span><span class="main">:</span> <span class="free">cs</span> <span class="main">⇒</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> big_eq_small small_steps_determ<span class="main">)</span>
   
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weakest Precondition›</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following definitions are made wrt.\ a fixed program <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>π›</span></span></span></span>, which becomes the first
  parameter of the defined constants when the context is left.›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">π</span> <span class="main">::</span> <span class="quoted">program</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Weakest precondition: 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> terminates with a state that satisfies <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q›</span></span></span></span>, when started from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span>.›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">wp</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">t</span>"</span></span>
    <span class="comment1">― ‹Note that this definition exploits that the semantics is deterministic! 
      In general, we must ensure absence of infinite executions›</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Weakest liberal precondition: 
    If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> terminates when started from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span>, the new state satisfies <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q›</span></span></span></span>.›</span></span>    
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">wlp</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">t</span>"</span></span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Properties›</span></span>
  
  <span class="keyword1"><span class="command">context</span></span> 
    <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">abs_def</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> wp_def wlp_def
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_imp_wlp<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">⟹</span> wlp <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> big_step_determ <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      
    <span class="keyword1"><span class="command">lemma</span></span> wlp_and_term_imp_wp<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">⟹</span> wp <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    
    <span class="keyword1"><span class="command">lemma</span></span> wp_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span> <span class="main">⟹</span> wp <span class="free">c</span> <span class="main">=</span> wp <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_conseq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="free">c</span> <span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">lemma</span></span> wlp_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span> <span class="main">⟹</span> wlp <span class="free">c</span> <span class="main">=</span> wlp <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wlp_conseq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="free">c</span> <span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> wlp <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
      
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Unfold Rules›</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_skip_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp SKIP <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_assign_idx_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">::=</span><span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="main">(</span><span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">(</span>aval <span class="free">i</span> <span class="free">s</span> <span class="main">:=</span> aval <span class="free">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_arraycpy_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_arrayinit_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free">x</span><span class="main">[]</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_assign_locals_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span>Assign_Locals <span class="free">l</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">l</span><span class="main">|</span><span class="free">s</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_seq_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;;</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wp <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>wp <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_if_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> 
      <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> bval <span class="free">b</span> <span class="free">s</span> <span class="keyword1">then</span> wp <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Q</span> <span class="free">s</span> <span class="keyword1">else</span> wp <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">lemma</span></span> wp_scope_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wp <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="bound">s'</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="free">s</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wp_pcall_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">c</span> <span class="main">⟹</span> wp <span class="main">(</span>PCall <span class="free">p</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wp <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    
    <span class="keyword1"><span class="command">lemmas</span></span> wp_eq <span class="main">=</span> wp_skip_eq wp_assign_idx_eq wp_arraycpy_eq wp_arrayinit_eq 
      wp_assign_locals_eq wp_seq_eq wp_scope_eq
    <span class="keyword1"><span class="command">lemmas</span></span> wp_eq' <span class="main">=</span> wp_eq wp_if_eq
    
    <span class="keyword1"><span class="command">lemma</span></span> wlp_skip_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp SKIP <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wlp_assign_idx_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">::=</span><span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="main">(</span><span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">(</span>aval <span class="free">i</span> <span class="free">s</span> <span class="main">:=</span> aval <span class="free">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wlp_arraycpy_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wlp_arrayinit_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free">x</span><span class="main">[]</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wlp_assign_locals_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span>Assign_Locals <span class="free">l</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">l</span><span class="main">|</span><span class="free">s</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wlp_seq_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;;</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wlp <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>wlp <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wlp_if_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> 
      <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> bval <span class="free">b</span> <span class="free">s</span> <span class="keyword1">then</span> wlp <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Q</span> <span class="free">s</span> <span class="keyword1">else</span> wlp <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">lemma</span></span> wlp_scope_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wlp <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="bound">s'</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="free">s</span><span class="main">&gt;</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> wlp_pcall_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">c</span> <span class="main">⟹</span> wlp <span class="main">(</span>PCall <span class="free">p</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wlp <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      
          
    <span class="keyword1"><span class="command">lemmas</span></span> wlp_eq <span class="main">=</span> wlp_skip_eq wlp_assign_idx_eq wlp_arraycpy_eq wlp_arrayinit_eq 
      wlp_assign_locals_eq wlp_seq_eq wlp_scope_eq
    <span class="keyword1"><span class="command">lemmas</span></span> wlp_eq' <span class="main">=</span> wlp_eq wlp_if_eq
  <span class="keyword2"><span class="keyword">end</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> wlp_while_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> bval <span class="free">b</span> <span class="free">s</span> <span class="keyword1">then</span> wlp <span class="free">c</span> <span class="main">(</span>wlp <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> wlp_equiv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> while_unfold<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wlp_eq'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> wp_while_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> bval <span class="free">b</span> <span class="free">s</span> <span class="keyword1">then</span> wp <span class="free">c</span> <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> wp_equiv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> while_unfold<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wp_eq'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹Context fixing program›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Unfold rules for procedure scope›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> wp_pscope_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span>PScope <span class="free">π'</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wp <span class="free">π'</span> <span class="main">(</span><span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wlp_pscope_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span>PScope <span class="free">π'</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wlp <span class="free">π'</span> <span class="main">(</span><span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Weakest precondition and Program Equivalence›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following three statements are equivalent:
  <span class="antiquoted"><span class="antiquoted">▸</span></span> The commands <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c'›</span></span></span></span> are equivalent
  <span class="antiquoted"><span class="antiquoted">▸</span></span> The weakest preconditions are equivalent, for all procedure environments
  <span class="antiquoted"><span class="antiquoted">▸</span></span> The weakest liberal preconditions are equivalent, for all procedure environments
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_equiv_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">π</span><span class="main">.</span> wp <span class="bound">π</span> <span class="free">c</span> <span class="main">=</span> wp <span class="bound">π</span> <span class="free">c'</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_c_def
  <span class="keyword1"><span class="command">using</span></span> big_step_determ <span class="keyword1"><span class="command">unfolding</span></span> wp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wlp_equiv_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">π</span><span class="main">.</span> wlp <span class="bound">π</span> <span class="free">c</span> <span class="main">=</span> wlp <span class="bound">π</span> <span class="free">c'</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">c</span> <span class="main">∼</span> <span class="free">c'</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_c_def wlp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹While Loops and Weakest Precondition›</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Exchanging the loop condition by an equivalent one, and the loop 
  body by one with the same weakest precondition, does not change the weakest 
  precondition of the loop.›</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> sim_while_wp_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bval <span class="free">b</span> <span class="main">=</span> bval <span class="free">b'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="free">c</span> <span class="main">=</span> wp <span class="free">π</span> <span class="free">c'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> WhileTrue big_step_determ wp_def<span class="main">)</span>
        
<span class="keyword1"><span class="command">lemma</span></span> sim_while_wp<span class="main">:</span> <span class="quoted"><span class="quoted">"bval <span class="free">b</span> <span class="main">=</span> bval <span class="free">b'</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">=</span> wp <span class="free">π</span> <span class="free">c'</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_while_wp_aux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The same lemma for weakest liberal preconditions.›</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> sim_while_wlp_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bval <span class="free">b</span> <span class="main">=</span> bval <span class="free">b'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="free">c</span> <span class="main">=</span> wlp <span class="free">π</span> <span class="free">c'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> WhileTrue wlp_def<span class="main">)</span>
        
<span class="keyword1"><span class="command">lemma</span></span> sim_while_wlp<span class="main">:</span> <span class="quoted"><span class="quoted">"bval <span class="free">b</span> <span class="main">=</span> bval <span class="free">b'</span> <span class="main">⟹</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="main">=</span> wlp <span class="free">π</span> <span class="free">c'</span> <span class="main">⟹</span> wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wlp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sim_while_wlp_aux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
      
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants for While-Loops›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove the standard invariant rules for while loops.
    We first prove them in a slightly non-standard form, summarizing the 
    loop step and loop exit assumptions. Then, we derive the standard form 
    with separate assumptions for step and loop exit.
  ›</span></span>
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Correctness›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> wlp_whileI'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">if</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="free">I</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wlp_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> INIT STEP
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> big_step_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WhileFalse <span class="skolem">s</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> STEP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WhileTrue <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">π</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> STEP' <span class="main">=</span> WhileTrue.prems<span class="main">(</span>2<span class="main">)</span>
      
      <span class="keyword1"><span class="command">from</span></span> STEP'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹bval <span class="free">b</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="skolem">π</span> <span class="free">c</span> <span class="free">I</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span><span class="main">:</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="skolem">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wlp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">s<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">Q</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span>›</span></span> <span class="keyword1"><span class="command">using</span></span> STEP' WhileTrue.hyps<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">s<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* Short proof (not the shortest possible one ;) ) *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">if</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="free">I</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> STEP
    <span class="keyword1"><span class="command">unfolding</span></span> wlp_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> t
      <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> INIT
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> big_step_induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">meson</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Total Correctness›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For total correctness, each step must decrease the state wrt.~a well-founded relation.›</span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> wp_whileI'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">if</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> WF INIT 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="comment1">(* Instantiation required to avoid strange HO-unification problem! *)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wp_while_unfold<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> bval <span class="free">b</span> <span class="skolem">s</span> <span class="keyword1">then</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span>wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">split</span> if_split<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> allI impI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bval <span class="free">b</span> <span class="skolem">s</span>"</span></span>
        
        <span class="keyword1"><span class="command">from</span></span> STEP <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span>wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wp_conseq<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> less.IH <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bval <span class="free">b</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> STEP <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="skolem">s</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* Short Proof *)</span>  
  <span class="keyword1"><span class="command">lemma</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">if</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> WF INIT 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> wp_while_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> STEP wp_conseq<span class="main">)</span>
    
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Standard Forms of While Rules›</span></span>  
  <span class="keyword1"><span class="command">lemma</span></span> wlp_whileI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">𝔰<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝔰</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">𝔰</span><span class="main">;</span> bval <span class="free">b</span> <span class="bound">𝔰</span> <span class="main">⟧</span> <span class="main">⟹</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="free">I</span> <span class="bound">𝔰</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FINAL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝔰</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="bound">𝔰</span><span class="main">;</span> <span class="main">¬</span>bval <span class="free">b</span> <span class="bound">𝔰</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">𝔰</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">𝔰<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms wlp_whileI' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    
  <span class="keyword1"><span class="command">lemma</span></span> wp_whileI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">𝔰<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝔰</span><span class="main">.</span> <span class="main">⟦</span><span class="free">I</span> <span class="bound">𝔰</span><span class="main">;</span> bval <span class="free">b</span> <span class="bound">𝔰</span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">𝔰'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">𝔰'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">𝔰'</span><span class="main">,</span><span class="bound">𝔰</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="bound">𝔰</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FINAL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝔰</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="bound">𝔰</span><span class="main">;</span> <span class="main">¬</span>bval <span class="free">b</span> <span class="bound">𝔰</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">𝔰</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">𝔰<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms wp_whileI' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Modularity of Programs›</span></span>    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Adding more procedures does not change the semantics of the existing ones.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_leD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span><span class="free">m'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domI map_le_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> big_step_mono_prog<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">π'</span>"</span></span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π'</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> big_step_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_leD<span class="main">)</span>
    
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Wrapping a set of recursive procedures into a procedure scope›</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> localize_recursion<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">π'</span><span class="main">:</span> <span class="main">(</span>PScope <span class="free">π</span> <span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">π</span><span class="main">:</span><span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strongest Postcondition›</span></span>  

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">π</span> <span class="main">::</span> <span class="quoted">program</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sp</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> sp_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword2"><span class="keyword">begin</span></span>
  
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intuition: There exists an old value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vx›</span></span></span></span> for the assigned variable›</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> sp_arraycpy_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"sp <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">y</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">vx</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">t</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="bound">vx</span><span class="main">)</span> <span class="keyword1">in</span> <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">s</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> big_step_simps<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Version with renaming of assigned variable›</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> sp_arraycpy_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"sp <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">y</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span> <span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">vx</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">t</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="bound">vx</span><span class="main">,</span><span class="free">y</span><span class="main">:=</span><span class="free">t</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> big_step_simps<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_triv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      
      
    <span class="keyword1"><span class="command">lemma</span></span> sp_skip_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"sp <span class="free">P</span> SKIP <span class="free">t</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> sp_seq_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"sp <span class="free">P</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;;</span><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">t</span> <span class="main">⟷</span> sp <span class="main">(</span>sp <span class="free">P</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword2"><span class="keyword">end</span></span>  
<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hoare-Triples›</span></span>    

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A Hoare-triple summarizes the precondition, command, and postcondition.›</span></span>
        
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HT</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HT</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> wp <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HT_partial</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HT_partial</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> wlp <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consequence rule---strengthen the precondition, weaken the postcondition.›</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> HT_conseq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">P'</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P'</span> <span class="free">c</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wp_conseq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HT_partial_conseq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">P'</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="free">P'</span> <span class="free">c</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wlp_conseq<span class="main">)</span>
  
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simple rule for presentation in lecture: Use a Hoare-triple during VCG.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> wp_modularity_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="free">s</span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="free">s</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="free">c</span> <span class="free">Q'</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wp_conseq<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sets of Hoare-Triples›</span></span>  
<span class="keyword1"><span class="command">type_synonym</span></span> htset <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>state <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">×</span> com <span class="main">×</span> <span class="main">(</span>state <span class="main">⇒</span> state <span class="main">⇒</span> bool<span class="main">)</span><span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">HTset</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">.</span> HT <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">P</span> <span class="bound">c</span> <span class="bound">Q</span>"</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">HTset_r</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">.</span> HT <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">c</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">Q</span>"</span></span>
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deriving Parameter Frame Adjustment Rules›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rules can be used to derive Hoare-triples when adding
  prologue and epilogue code, and wrapping the command into a scope.
  
  This will be used to implement the local variables and parameter passing protocol 
  of procedures.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Intuition: 
  New precondition is weakest one we need to ensure <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> after prologue.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> adjust_prologue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">body</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="main">(</span>wp <span class="free">π</span> <span class="free">prologue</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">prologue</span><span class="main">;;</span><span class="free">body</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> wp <span class="free">π</span> <span class="free">prologue</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> HT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> wp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Intuition:
  New postcondition is strongest one we can get from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q›</span></span></span></span> after epilogue.
  
  We have to be careful with non-terminating epilogue, though!
›</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> adjust_epilogue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">body</span> <span class="free">Q</span>"</span></span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> TERMINATES<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="free">epilogue</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="main">(</span><span class="free">body</span><span class="main">;;</span><span class="free">epilogue</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> sp <span class="free">π</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">epilogue</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> HT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wp_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sp_def wp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intuition: 
  Scope can be seen as assignment of locals before and after inner command.
  Thus, this rule is a combined forward and backward assignment rule, for
  the epilogue <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>locals:=&lt;&gt;›</span></span></span></span> and the prologue <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>locals:=old_locals›</span></span></span></span>.
›</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> adjust_scope<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">body</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="bound">s</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free">body</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&gt;</span><span class="main">)</span> <span class="main">(</span><span class="main">&lt;</span><span class="bound">l</span><span class="main">|</span><span class="bound">s</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_eq combine_nest<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> combine_collapse<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proof for Recursive Specifications›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prove correct any set of Hoare-triples, e.g., mutually recursive ones.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> HTsetI<span class="main">:</span>    
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">c</span> <span class="bound">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">⟦</span> HTset_r <span class="main">(</span><span class="main">λ</span><span class="bound">c'</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">)</span> <span class="free">π</span> <span class="free">Θ</span><span class="main">;</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">∈</span><span class="free">Θ</span><span class="main">;</span> <span class="bound">P</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HTset <span class="free">π</span> <span class="free">Θ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HTset_def HT_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span><span class="main">∈</span><span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wf <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="skolem">c</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">Q</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> RL <span class="keyword1"><span class="command">unfolding</span></span> HTset_r_def HT_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1"><span class="command">qed</span></span>  
    

<span class="keyword1"><span class="command">lemma</span></span> HT_simple_recursiveI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span>HT <span class="free">π</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s'</span><span class="main">,</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c</span> <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HTsetI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"inv_image <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> snd<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> π<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">π</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Θ <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">P</span><span class="main">,</span><span class="free">c</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HTset_r_def HTset_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> HT_simple_recursive_procI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span>HT <span class="free">π</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s'</span><span class="main">,</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span>PCall <span class="free">p</span><span class="main">)</span> <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="main">(</span>PCall <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="main">(</span>PCall <span class="free">p</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> HTsetI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"inv_image <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> snd<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> π<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">π</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Θ <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="free">P</span><span class="main">,</span>PCall <span class="free">p</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HTset_r_def HTset_def<span class="main">)</span>
  
  
    
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">P</span> <span class="bound">p</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> 
    <span class="main">⋀</span><span class="bound">P'</span> <span class="bound">p'</span> <span class="bound">Q'</span><span class="main">.</span> <span class="main">(</span><span class="bound">P'</span><span class="main">,</span><span class="bound">p'</span><span class="main">,</span><span class="bound">Q'</span><span class="main">)</span><span class="main">∈</span><span class="free">Θ</span> 
      <span class="main">⟹</span> HT <span class="free">π</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">p'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="bound">P'</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span>PCall <span class="bound">p'</span><span class="main">)</span> <span class="bound">Q'</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">p</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">∈</span><span class="free">Θ</span><span class="main">;</span> <span class="bound">P</span> <span class="bound">s</span> 
  <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="main">(</span>PCall <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">p</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">∈</span><span class="free">Θ</span><span class="main">.</span> HT <span class="free">π</span> <span class="bound">P</span> <span class="main">(</span>PCall <span class="bound">p</span><span class="main">)</span> <span class="bound">Q</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HTset <span class="free">π</span> <span class="main">{</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span> PCall <span class="bound">p</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">|</span><span class="bound">P</span> <span class="bound">p</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Θ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> HTsetI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"inv_image <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span>PCall <span class="bound">p</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> P c Q s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">P</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">unfolding</span></span> HTset_r_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span> <span class="skolem">P'</span> <span class="skolem">p'</span> <span class="skolem">Q'</span><span class="main">)</span>
        
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P'</span><span class="main">,</span>PCall <span class="skolem">p'</span><span class="main">,</span><span class="skolem">Q'</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="quoted">"1"</span><span class="main">(</span>2-<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HTset_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Completeness of While-Rule›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Idea: Use <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>wlp›</span></span></span></span> as invariant›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> wlp_whileI'_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">I</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="keyword1">if</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="free">I</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> bval <span class="free">b</span> <span class="skolem">s</span> <span class="keyword1">then</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="var">?I</span> <span class="skolem">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> wlp_while_unfold<span class="main">)</span> 
      <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>  
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Idea: Remaining loop iterations as variant›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">count_it</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">π</span> <span class="entity">b</span> <span class="entity">c</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>bval <span class="free">b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">count_it</span> <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>bval <span class="free">b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span> <span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">;</span> <span class="free">count_it</span> <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">count_it</span> <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> count_it_determ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"count_it <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free">s</span> <span class="free">n</span> <span class="main">⟹</span> count_it <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free">s</span> <span class="free">n'</span> <span class="main">⟹</span> <span class="free">n'</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> count_it.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> count_it.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> big_step_determ count_it.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_it_ex<span class="main">:</span>   
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> count_it <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free">s</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> count_it.intros<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">variant</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">n</span><span class="main">.</span> count_it <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">n</span>"</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> variant_decreases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEPB<span class="main">:</span> <span class="quoted"><span class="quoted">"bval <span class="free">b</span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> STEPC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">s'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> TERM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"variant <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free">s'</span> <span class="main">&lt;</span> variant <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> count_it_ex<span class="main">[</span><span class="operator">OF</span> TERM<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> CI'<span class="main">:</span> <span class="quoted"><span class="quoted">"count_it <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free">s'</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> count_it.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> STEPB STEPC this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_it <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free">s</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"variant <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free">s'</span> <span class="main">=</span> <span class="skolem">n'</span>"</span></span> <span class="quoted"><span class="quoted">"variant <span class="free">π</span> <span class="free">b</span> <span class="free">c</span> <span class="free">s</span> <span class="main">=</span> Suc <span class="skolem">n'</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> variant_def <span class="keyword1"><span class="command">using</span></span> count_it_determ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wp_whileI'_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">π</span> <span class="free">b</span> <span class="free">c</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">≡</span>measure <span class="main">(</span>variant <span class="free">π</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">I</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="keyword1">if</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>   
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹wf <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> bval <span class="free">b</span> <span class="skolem">s</span> <span class="keyword1">then</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="var">?I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> wp_while_unfold<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_def R_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> variant_decreases<span class="main">)</span>
      
  <span class="keyword1"><span class="command">}</span></span>  
<span class="keyword1"><span class="command">qed</span></span>  
    
    
      
  
  
<span class="keyword2"><span class="keyword">end</span></span>
                                 </pre>
</div><div id="Annotated_Syntax">
<div class="head">
<h1>Theory Annotated_Syntax</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Annotated Syntax›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Annotated_Syntax
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Semantics.html">Semantics</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Unfold theorems to strip annotations from program, before it is defined as constant›</span></span>
  <span class="keyword1"><span class="command">named_theorems</span></span> vcg_annotation_defs <span class="quoted">‹Definitions of Annotations›</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Marker that is inserted around all annotations by the specification parser.›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ANNOTATION</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Annotations›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The specification parser must interpret the annotations in the program.›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">WHILE_annotI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bexp <span class="main">⇒</span> com <span class="main">⇒</span> com"</span></span> 
    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">WHILE</span> <span class="keyword1">{</span>_<span class="keyword1">}</span> _<span class="keyword3">/ </span><span class="keyword1">DO</span> _<span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">vcg_annotation_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILE_annotI</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">::</span>state <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">≡</span> While"</span></span>
    
  <span class="keyword1"><span class="command">lemmas</span></span> annotate_whileI <span class="main">=</span> WHILE_annotI_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">WHILE_annotRVI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bexp <span class="main">⇒</span> com <span class="main">⇒</span> com"</span></span> 
      <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">WHILE</span> <span class="keyword1">{</span>_<span class="keyword1">}</span> <span class="keyword1">{</span>_<span class="keyword1">}</span> <span class="keyword1">{</span>_<span class="keyword1">}</span> _<span class="keyword3">/ </span><span class="keyword1">DO</span> _<span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">vcg_annotation_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILE_annotRVI</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> While"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">R</span> <span class="free">V</span> <span class="free">I</span>
    
  <span class="keyword1"><span class="command">lemmas</span></span> annotate_whileRVI <span class="main">=</span> WHILE_annotRVI_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">WHILE_annotVI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">⇒</span> int<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bexp <span class="main">⇒</span> com <span class="main">⇒</span> com"</span></span> 
    <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">WHILE</span> <span class="keyword1">{</span>_<span class="keyword1">}</span> <span class="keyword1">{</span>_<span class="keyword1">}</span> _<span class="keyword3">/ </span><span class="keyword1">DO</span> _<span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">vcg_annotation_defs</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">WHILE_annotVI</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> While"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">V</span> <span class="free">I</span>
  <span class="keyword1"><span class="command">lemmas</span></span> annotate_whileVI <span class="main">=</span> WHILE_annotVI_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hoare-Triples for Annotated Commands›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The command is a function from pre-state to command, as the annotations that are 
    contained in the command may depend on the pre-state!›</span></span>
  
  <span class="keyword1"><span class="command">type_synonym</span></span> HT'_type <span class="main">=</span> <span class="quoted"><span class="quoted">"program <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> com<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>state <span class="main">⇒</span> state<span class="main">⇒</span>bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">HT'_partial</span> <span class="main">::</span> <span class="quoted">HT'_type</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HT'_partial</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> wlp <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">HT'</span> <span class="main">::</span> <span class="quoted">HT'_type</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HT'</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> wp <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> HT'_eq_HT<span class="main">:</span> <span class="quoted"><span class="quoted">"HT' <span class="free">π</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> HT_def HT'_def <span class="keyword1"><span class="command">..</span></span>  
    
  <span class="keyword1"><span class="command">lemma</span></span> HT'_partial_eq_HT<span class="main">:</span> <span class="quoted"><span class="quoted">"HT'_partial <span class="free">π</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> HT_partial <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_def HT'_partial_def <span class="keyword1"><span class="command">..</span></span>  
  
  <span class="keyword1"><span class="command">lemmas</span></span> HT'_unfolds <span class="main">=</span> HT'_eq_HT HT'_partial_eq_HT
  
  
  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> Θelem_t <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state<span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span>state <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>state <span class="main">⇒</span> com<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>state <span class="main">⇒</span> state<span class="main">⇒</span>bool<span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">HT'set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"program <span class="main">⇒</span> <span class="tfree">'a</span> Θelem_t set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HT'set</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">.</span> HT' <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">P</span> <span class="bound">c</span> <span class="bound">Q</span>"</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">HT'set_r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> program <span class="main">⇒</span> <span class="tfree">'a</span> Θelem_t set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">HT'set_r</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span><span class="main">.</span> HT' <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">n</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">Q</span>"</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> HT'setI<span class="main">:</span>    
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">P</span> <span class="bound">c</span> <span class="bound">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">⟦</span> HT'set_r <span class="main">(</span><span class="main">λ</span><span class="bound">f'</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">f'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">f</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">)</span> <span class="free">π</span> <span class="free">Θ</span><span class="main">;</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">Θ</span><span class="main">;</span> <span class="bound">P</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT'set <span class="free">π</span> <span class="free">Θ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> HT'set_def HT'_def 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">Q</span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span><span class="main">(</span><span class="skolem">P</span><span class="main">,</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">Q</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">Θ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wf <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="skolem">c</span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">Q</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> less
      <span class="keyword1"><span class="command">note</span></span> RL' <span class="main">=</span> RL<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">s<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">P</span></span><span class="main">,</span> <span class="operator">OF</span> _ less.prems<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RL'<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> HT'set_r_def HT'_def <span class="keyword1"><span class="command">using</span></span> less.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
  
  <span class="keyword1"><span class="command">lemma</span></span> HT'setD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT'set <span class="free">π</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="main">(</span><span class="free">P</span><span class="main">,</span><span class="free">c</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">Θ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT' <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"HT'set <span class="free">π</span> <span class="free">Θ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT'set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  
  
  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2_Basic_Simpset">
<div class="head">
<h1>Theory IMP2_Basic_Simpset</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basic Simpset for VCG›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IMP2_Basic_Simpset
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Semantics.html">../basic/Semantics</a>"</span> <span class="quoted">"<a href="Named_Simpsets.html">../lib/Named_Simpsets</a>"</span> <span class="quoted">"<a href="IMP2_Utils.html">../lib/IMP2_Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We set up a simpset, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vcg_bb›</span></span></span></span>, which is invoked to unfold some commands in the VCG, 
    and to compute program analysis information.
   ›</span></span>
  
  <span class="keyword1"><span class="command">named_simpset</span></span> vcg_bb <span class="main">=</span> HOL_basic_ss
  
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="comment1">(* Handy shortcuts *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vcg_bb_simplify</span> <span class="entity">thms</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">simplify</span> <span class="main">(</span><span class="entity">Named_Simpsets.put</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> vcg_bb<span class="antiquote">}</span></span> <span class="entity">ctxt</span> addsimps <span class="entity">thms</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vcg_bb_simp_tac</span> <span class="entity">thms</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">simp_tac</span> <span class="main">(</span><span class="entity">Named_Simpsets.put</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> vcg_bb<span class="antiquote">}</span></span> <span class="entity">ctxt</span> addsimps <span class="entity">thms</span><span class="main">)</span>
  ›</span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Put in ASSUMPTION and NO_MATCH›</span></span>  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb <span class="quasi_keyword"><span class="quasi_keyword">cong</span></span><span class="main">]</span> <span class="main">=</span> ASSUMPTION_cong NO_MATCH_cong
  
  <span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹K
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">asm_sol</span> <span class="main">=</span> mk_solver <span class="inner_quoted">"ASSUMPTION"</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
        resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ASSUMPTION_I<span class="antiquote">}</span></span></span><span class="main">]</span> THEN'
        resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">Simplifier.prems_of</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">Named_Simpsets.map_ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> vcg_bb<span class="antiquote">}</span></span> <span class="main">(</span>
           <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> Simplifier.addSolver <span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">asm_sol</span><span class="main">)</span><span class="main">)</span>
        #&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">ctxt</span> addsimprocs <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">simproc</span> NO_MATCH<span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span>
      <span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  ›</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Congruence rules for short-circuit behaviour on if. 
    This is useful, as this simpset has to perform basic computations, 
    like variable name comparison, etc.
    
    Attention: Do not add short-circuit behaviour on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∧,∨›</span></span></span></span>, or anything that might
      clash with the evaluation of the semantics of aexp or bexp!
    
  ›</span></span>
  <span class="comment1">(*
    TODO: Conceptually, we have two different things here. The ∧,∨ which we use to compute,
      and the ∧,∨ that are part of the aval/bval semantics. 
      At the end, we should keep those separated!
  *)</span>
  
    
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb <span class="quasi_keyword">cong</span><span class="main">]</span> <span class="main">=</span> if_weak_cong <span class="comment1">(*conj_left_cong disj_left_cong*)</span>

  <span class="keyword1"><span class="command">lemma</span></span> short_circuit<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∧</span><span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> <span class="free">b</span> <span class="keyword1">else</span> False<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∨</span><span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="keyword1">then</span> True <span class="keyword1">else</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  
  
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Protection of user-specified terms, like pre/postcondition and invariants
    from bb-computation›</span></span>
  
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Tag to protect user annotations›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">BB_PROTECT</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span>"</span></span>  
  
  <span class="keyword1"><span class="command">lemma</span></span> BB_PROTECT_cong<span class="main">[</span><span class="operator">named_ss</span> vcg_bb <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">cong</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"BB_PROTECT <span class="free">a</span> <span class="main">=</span> BB_PROTECT <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">lemma</span></span> BB_PROTECT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≡</span> BB_PROTECT <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BB_PROTECT_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_BB_PROTECT</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span><span class="main">=</span>fastype_of <span class="entity">t</span> <span class="keyword2"><span class="keyword">in</span></span> 
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> BB_PROTECT<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">T</span> --&gt; <span class="entity">T</span><span class="main">)</span>$<span class="entity">t</span> <span class="keyword2"><span class="keyword">end</span></span> 
      
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_BB_PROTECT</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> BB_PROTECT<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span>$<span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">dest_BB_PROTECT</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM<span class="main">(</span><span class="inner_quoted">"dest_BB_PROTECT"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
  ›</span>
  
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic Logic›</span></span>  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span>
    refl if_True if_False HOL.simp_thms
    True_implies_equals False_implies_equals

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹String Comparison›</span></span>  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span>
    char.inject<span class="main">[</span><span class="operator">unfolded</span> short_circuit<span class="main">]</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">unfolded</span> short_circuit<span class="main">,</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">char</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">::</span> <span class="quoted">string</span>
    <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">=</span> <span class="free">y</span><span class="main">#</span><span class="free">ys</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span> <span class="main">∧</span> <span class="free">xs</span><span class="main">=</span><span class="free">ys</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">≠</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹State Query›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted">state</span>
    <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">v</span>"</span></span>  
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span> <span class="keyword1">then</span> <span class="free">v</span> <span class="keyword1">else</span> <span class="free">s</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(* For array indexing, we only decide syntactically equal queries, and leave the rest untouched *)</span>  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">val</span>
    <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">pv</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">pv</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Local/Global Variables ›</span></span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the next two lemmas, we use a crude heuristics to ensure that they are not 
    applied to symbolic variable names: A variable name must be a (non-empty) list.›</span></span>    
  <span class="keyword1"><span class="command">lemma</span></span> combine_query'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_global <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">t</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">s</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> combine_query<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> combine_upd'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_global <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">|</span><span class="free">t</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">&gt;</span> <span class="keyword1">else</span> <span class="main">&lt;</span><span class="free">s</span><span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">|</span><span class="free">t</span><span class="main">&gt;</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> combine_upd<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> combine_collapse combine_nest
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> combine_query' combine_upd'
    
    
  <span class="keyword1"><span class="command">lemma</span></span> query_prog<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">π</span><span class="main">(</span><span class="free">k</span><span class="main">↦</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">k'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k'</span><span class="main">=</span><span class="free">k</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> <span class="free">π</span> <span class="free">k'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">π</span> <span class="main">::</span> <span class="quoted">program</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sets and Computation of Variable Sets›</span></span>  
  <span class="keyword1"><span class="command">lemmas</span></span> vcg_bb_set<span class="main">[</span><span class="operator">unfolded</span> short_circuit<span class="main">,</span> <span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span>
    Un_insert_left Un_insert_right insert_commute insert_absorb2 Un_empty_left Un_empty_right
    insert_iff empty_iff

  <span class="keyword1"><span class="command">lemma</span></span> set_filter_simps<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Set.filter <span class="free">P</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"Set.filter <span class="free">P</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="free">x</span> <span class="keyword1">then</span> insert <span class="free">x</span> <span class="main">(</span>Set.filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">else</span> Set.filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> set_collect_simps<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Set.filter <span class="free">P</span> UNIV <span class="main">=</span> Collect <span class="free">P</span>"</span></span>
    <span class="quoted"><span class="quoted">"Set.filter <span class="free">P</span> <span class="main">(</span>Collect <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> Collect <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>UNIV"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>Collect <span class="free">P</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"insert <span class="free">x</span> UNIV <span class="main">=</span> UNIV"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    

    
        
  <span class="keyword1"><span class="command">method</span></span> i_vcg_bb <span class="main">=</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">named_ss</span> vcg_bb<span class="main"><span class="main">:</span></span> <span class="main">)</span>
  
    
    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Parser">
<div class="head">
<h1>Theory Parser</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Parser›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Parser
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Syntax.html">../basic/Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tagging›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a few tag constants.
    They are inserted by the parser, and tag certain situations, 
    like parameter passing or inlined commands.
   ›</span></span>
    
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inline</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Inline</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>  
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">Params</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Params</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Assignment commands to assign the return value. 
    The VCG will add a renaming, such that the assigned variable name rather
    the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>G_ret›</span></span></span></span> will be used for the VCs›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">AssignIdx_retv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">≡</span> AssignIdx <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span>"</span></span>      
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ArrayCpy_retv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">≡</span> ArrayCpy <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span>"</span></span>      
    
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Assign_retv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">≡</span> AssignIdx_retv <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>N <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Parser for IMP Programs›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The parser also understands annotated programs.
    However, the basic parser will leave the annotations uninterpreted,
    and it's up to the client of the parser to interpret them.
  ›</span></span>

  
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">While_Annot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bexp <span class="main">⇒</span> com <span class="main">⇒</span> com"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">While_Annot</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> While"</span></span>

  <span class="comment1">(* Note: Still a very early prototype *)</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">VARIABLEI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">VARIABLEI</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="comment1">(* Used to mark integer variables *)</span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">VARIABLEA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">VARIABLEA</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="comment1">(* Used to mark array variables *)</span>
  
  <span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_annotated_term"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"logic <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> logic"</span></span> <span class="comment1">(* Annotated term: term string pos *)</span>
  
  
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Term_Annot</span> <span class="main">:</span> <span class="keyword2"><span class="keyword">sig</span></span>
      <span class="comment1">(* Annotate terms *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> annotate_term<span class="main">:</span> term <span class="main">-&gt;</span> string * Position.T <span class="main">-&gt;</span> term
      <span class="keyword1"><span class="keyword">val</span></span> dest_annotated_term<span class="main">:</span> term <span class="main">-&gt;</span> <span class="main">(</span>string * Position.T<span class="main">)</span> * term
      
      <span class="comment1">(* Annotation = annotated dummy term *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> annotation<span class="main">:</span> string * Position.T <span class="main">-&gt;</span> term
      <span class="keyword1"><span class="keyword">val</span></span> dest_annotation<span class="main">:</span> term <span class="main">-&gt;</span> term

      <span class="comment1">(* Checking for annotations in Term *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> is_annotated_term<span class="main">:</span> term <span class="main">-&gt;</span> bool
      <span class="keyword1"><span class="keyword">val</span></span> has_annotations<span class="main">:</span> term <span class="main">-&gt;</span> bool

      <span class="comment1">(* Removing annotations *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> strip_annotations<span class="main">:</span> term <span class="main">-&gt;</span> term
      <span class="comment1">(* Replaces annotated terms by dummy term *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> strip_annotated_terms<span class="main">:</span> term <span class="main">-&gt;</span> term
            
      <span class="comment1">(* Parsing *)</span>
      <span class="comment1">(* Parse cartouche (independent of term annotations)*)</span>
      <span class="keyword1"><span class="keyword">val</span></span> parse_cartouche<span class="main">:</span> <span class="main">(</span>string * Position.T<span class="main">)</span> parser
      <span class="comment1">(* Parse cartouche into annotation *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> parse_annotation<span class="main">:</span> term parser
      <span class="comment1">(* Parse cartouche into annotation of syntax constant (used to get typed annotations) *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> parse_annotate<span class="main">:</span> string <span class="main">-&gt;</span> term parser
      
      <span class="comment1">(* Read term from cartouche and position *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> read_term<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> string * Position.T <span class="main">-&gt;</span> term
      
      <span class="comment1">(* Read annotation part of annotated term as term *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> read_annotation_as_term<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term * term
    <span class="keyword2"><span class="keyword">end</span></span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">annotate_term</span> <span class="entity">t</span> <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="entity">pos</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pos</span> <span class="main">=</span> Free <span class="main">(</span>Term_Position.encode <span class="entity">pos</span><span class="main">,</span>dummyT<span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">str</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">str</span><span class="main">,</span>dummyT<span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">c</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_annotated_term"<span class="antiquote">}</span></span><span class="main">,</span> dummyT --&gt; dummyT --&gt; dummyT --&gt; dummyT<span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">c</span>$<span class="entity">t</span>$<span class="entity">str</span>$<span class="entity">pos</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_annotated_term</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_annotated_term"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">t</span>$Free <span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$Free <span class="main">(</span><span class="entity">pos</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pos</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Term_Position.decode <span class="entity">pos</span> <span class="keyword2"><span class="keyword">of</span></span> 
              SOME <span class="entity">pos</span> <span class="main">=&gt;</span> <span class="entity">pos</span> <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"dest_term_annot: invalid pos"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">str</span><span class="main">,</span><span class="entity">pos</span><span class="main">)</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">|</span> <span class="entity">dest_annotated_term</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM<span class="main">(</span><span class="inner_quoted">"dest_annot"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>      
        
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">is_annotated_term</span> <span class="main">=</span> can <span class="entity">dest_annotated_term</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">has_annotations</span> <span class="main">=</span> Term.exists_subterm <span class="entity">is_annotated_term</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">annotation</span> <span class="main">=</span> <span class="entity">annotate_term</span> Term.dummy
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_annotation</span> <span class="main">=</span> <span class="entity">dest_annotated_term</span> #&gt; <span class="main">#</span><span class="inner_numeral">2</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_cartouche</span> <span class="main">=</span> Parse.position Parse.cartouche &gt;&gt; apfst cartouche

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_annotation</span> <span class="main">=</span> <span class="entity">parse_cartouche</span> &gt;&gt; <span class="entity">annotation</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_annotate</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">parse_cartouche</span> &gt;&gt; <span class="entity">annotate_term</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">n</span><span class="main">,</span>dummyT<span class="main">)</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_term_tk</span> <span class="entity">ctxt</span> <span class="entity">tk</span> <span class="main">=</span> Args.term <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">,</span> <span class="main">[</span><span class="entity">tk</span><span class="main">]</span><span class="main">)</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_term</span> <span class="entity">ctxt</span> <span class="entity">spos</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tk</span> <span class="main">=</span> Symbol_Pos.explode <span class="entity">spos</span> |&gt; Token.read_cartouche
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">read_term_tk</span> <span class="entity">ctxt</span> <span class="entity">tk</span>
      <span class="keyword2"><span class="keyword">end</span></span>  
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_annotation_as_term</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">dest_annotated_term</span> #&gt;&gt; <span class="entity">read_term</span> <span class="entity">ctxt</span> 
      
      
      <span class="comment1">(* Strip one level of term annotations. *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_annotations</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_annotated_term"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">t</span>$<span class="main">_</span>$<span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span>
        <span class="main">|</span> <span class="entity">strip_annotations</span> <span class="main">(</span><span class="entity">a</span>$<span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">strip_annotations</span> <span class="entity">a</span> $ <span class="entity">strip_annotations</span> <span class="entity">b</span>
        <span class="main">|</span> <span class="entity">strip_annotations</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">strip_annotations</span> <span class="entity">t</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">strip_annotations</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>

        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_annotated_terms</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_annotated_term"<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="main">_</span>$<span class="main">_</span>$<span class="main">_</span><span class="main">)</span> <span class="main">=</span> Term.dummy
        <span class="main">|</span> <span class="entity">strip_annotated_terms</span> <span class="main">(</span><span class="entity">a</span>$<span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">strip_annotated_terms</span> <span class="entity">a</span> $ <span class="entity">strip_annotated_terms</span> <span class="entity">b</span>
        <span class="main">|</span> <span class="entity">strip_annotated_terms</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">strip_annotated_terms</span> <span class="entity">t</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">strip_annotated_terms</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>
              
    <span class="keyword2"><span class="keyword">end</span></span>    
  ›</span>
   
  
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">IMP_Syntax</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">antf</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span>
        exists_type is_TFree <span class="entity">t</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="keyword3"><span class="keyword">raise</span></span> TERM<span class="main">(</span><span class="inner_quoted">"This won't support polymorphism in commands!"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
        <span class="entity">t</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_varname</span> <span class="main">=</span> <span class="entity">HOLogic.mk_string</span> 

      <span class="comment1">(*fun mk_aexp_V x = antf(@{term V})$x
      fun mk_aexp_Vidx x i = @{const Vidx}$x$i
      val mk_aexp_V' = mk_aexp_V o mk_var
      *)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_aexp_const</span> <span class="entity">i</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> N<span class="antiquote">}</span></span> $ <span class="entity">HOLogic.mk_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">int</span><span class="antiquote">}</span></span> <span class="entity">i</span>
                        
            
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_var_i</span> <span class="entity">x</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_abbrev</span> VARIABLEI<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">mk_varname</span> <span class="entity">x</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_var_a</span> <span class="entity">x</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_abbrev</span> VARIABLEA<span class="antiquote">}</span></span><span class="main">,</span> dummyT<span class="main">)</span> $ <span class="entity">mk_varname</span> <span class="entity">x</span>


      <span class="comment1">(* Caution: This must match the Isabelle function is_global! *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_global</span> <span class="inner_quoted">""</span> <span class="main">=</span> true
        <span class="main">|</span> <span class="entity">is_global</span> <span class="entity">s</span> <span class="main">=</span> nth_string <span class="entity">s</span> <span class="inner_numeral">0</span> <span class="main">=</span> <span class="inner_quoted">"G"</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">is_local</span> <span class="main">=</span> not o <span class="entity">is_global</span>              
      
      <span class="comment1">(* Expressions *)</span>

      <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">rval</span> <span class="main">=</span> <span class="entity">RV_AEXP</span> <span class="keyword2"><span class="keyword">of</span></span> term <span class="main">|</span> <span class="entity">RV_VAR</span> <span class="keyword2"><span class="keyword">of</span></span> string
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rv_t</span> <span class="main">(</span><span class="entity">RV_AEXP</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span>
        <span class="main">|</span> <span class="entity">rv_t</span> <span class="main">(</span><span class="entity">RV_VAR</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Vidx<span class="antiquote">}</span></span> $ <span class="entity">mk_var_i</span> <span class="entity">x</span> $ <span class="entity">mk_aexp_const</span> <span class="inner_numeral">0</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rv_var</span> <span class="main">=</span> <span class="entity">RV_VAR</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rv_var_idx</span> <span class="entity">x</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">RV_AEXP</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Vidx<span class="antiquote">}</span></span> $ <span class="entity">mk_var_a</span> <span class="entity">x</span> $ <span class="entity">rv_t</span> <span class="entity">i</span><span class="main">)</span>
      
      
      <span class="comment1">(*fun rv_int t = RV_AEXP (@{const N} $ (rv_t t))*)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rv_int'</span> <span class="main">=</span> <span class="entity">RV_AEXP</span> o <span class="entity">mk_aexp_const</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rv_unop</span> <span class="entity">f</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">RV_AEXP</span> <span class="main">(</span><span class="entity">f</span> $ <span class="entity">rv_t</span> <span class="entity">t</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rv_binop</span> <span class="entity">f</span> <span class="entity">a</span> <span class="entity">b</span> <span class="main">=</span> <span class="entity">RV_AEXP</span> <span class="main">(</span><span class="entity">f</span> $ <span class="entity">rv_t</span> <span class="entity">a</span> $ <span class="entity">rv_t</span> <span class="entity">b</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rv_BC</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">RV_AEXP</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Bc<span class="antiquote">}</span></span>$<span class="entity">t</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rv_BC'</span> true <span class="main">=</span> <span class="entity">rv_BC</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> True<span class="antiquote">}</span></span>
        <span class="main">|</span> <span class="entity">rv_BC'</span> false <span class="main">=</span> <span class="entity">rv_BC</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> False<span class="antiquote">}</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rv_not</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">RV_AEXP</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Not<span class="antiquote">}</span></span> $ <span class="entity">rv_t</span> <span class="entity">t</span><span class="main">)</span>
                      
      <span class="comment1">(* TODO: Add other constructors here *)</span>
      
      <span class="comment1">(* TODO: Interface for variable tagging mk_var_xxx is not clear! *)</span>
      
      <span class="comment1">(* Commands*)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_Skip</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> SKIP<span class="antiquote">}</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_Assign</span> <span class="entity">x</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">antf</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Assign</span><span class="antiquote">}</span></span><span class="main">)</span>$<span class="entity">x</span>$<span class="entity">t</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_AssignIdx</span> <span class="entity">x</span> <span class="entity">i</span> <span class="entity">t</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> AssignIdx<span class="antiquote">}</span></span>$<span class="entity">x</span>$<span class="entity">i</span>$<span class="entity">t</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_ArrayCpy</span> <span class="entity">d</span> <span class="entity">s</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> ArrayCpy<span class="antiquote">}</span></span>$<span class="entity">d</span>$<span class="entity">s</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_ArrayInit</span> <span class="entity">d</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> ArrayClear<span class="antiquote">}</span></span>$<span class="entity">d</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_Scope</span> <span class="entity">c</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Scope<span class="antiquote">}</span></span>$<span class="entity">c</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_Seq</span> <span class="entity">c1</span> <span class="entity">c2</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Seq<span class="antiquote">}</span></span>$<span class="entity">c1</span>$<span class="entity">c2</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_Inline</span> <span class="entity">t</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Inline<span class="antiquote">}</span></span>$<span class="entity">t</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_Params</span> <span class="entity">t</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Params<span class="antiquote">}</span></span>$<span class="entity">t</span>
        
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">While_Annot_c</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_abbrev</span> While_Annot<span class="antiquote">}</span></span><span class="main">,</span> dummyT --&gt; <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"bexp <span class="main">⇒</span> com <span class="main">⇒</span> com"</span><span class="antiquote">}</span></span><span class="main">)</span>
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_If</span> <span class="entity">b</span> <span class="entity">t</span> <span class="entity">e</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> If<span class="antiquote">}</span></span> $ <span class="entity">rv_t</span> <span class="entity">b</span> $ <span class="entity">t</span> $ <span class="entity">e</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_While_annot</span> <span class="entity">annots</span> <span class="entity">b</span> <span class="entity">c</span> <span class="main">=</span> <span class="entity">While_Annot_c</span> $ <span class="entity">annots</span> $ <span class="entity">rv_t</span> <span class="entity">b</span> $ <span class="entity">c</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_pcall</span> <span class="entity">name</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> PCall<span class="antiquote">}</span></span> $ <span class="main">(</span><span class="entity">HOLogic.mk_string</span> <span class="entity">name</span><span class="main">)</span>
      
              
      
      <span class="comment1">(* Derived Constructs *)</span>

      <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">varkind</span> <span class="main">=</span> <span class="entity">VAL</span> <span class="main">|</span> <span class="entity">ARRAY</span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">impvar</span> <span class="main">=</span> string * <span class="entity">varkind</span>      
      
      <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">lval</span> <span class="main">=</span> <span class="entity">LV_IDX</span> <span class="keyword2"><span class="keyword">of</span></span> string * term <span class="main">|</span> <span class="entity">LV_VAR</span> <span class="keyword2"><span class="keyword">of</span></span> string

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lv_idx</span> <span class="entity">x</span> <span class="entity">rv</span> <span class="main">=</span> <span class="entity">LV_IDX</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">rv_t</span> <span class="entity">rv</span><span class="main">)</span>
      
                    
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_lr_assign</span> <span class="main">(</span><span class="entity">LV_IDX</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">rv</span> <span class="main">=</span> <span class="entity">mk_AssignIdx</span> <span class="main">(</span><span class="entity">mk_var_a</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">rv_t</span> <span class="entity">rv</span><span class="main">)</span>  
        <span class="main">|</span> <span class="entity">mk_lr_assign</span> <span class="main">(</span><span class="entity">LV_VAR</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span><span class="entity">RV_AEXP</span> <span class="entity">e</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_Assign</span> <span class="main">(</span><span class="entity">mk_var_i</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">e</span>
        <span class="main">|</span> <span class="entity">mk_lr_assign</span> <span class="main">(</span><span class="entity">LV_VAR</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span><span class="entity">RV_VAR</span> <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_ArrayCpy</span> <span class="main">(</span><span class="entity">mk_var_i</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span><span class="entity">mk_var_i</span> <span class="entity">v</span><span class="main">)</span>
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list_Seq</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">mk_Skip</span>
        <span class="main">|</span> <span class="entity">list_Seq</span> <span class="main">[</span><span class="entity">c</span><span class="main">]</span> <span class="main">=</span> <span class="entity">c</span>
        <span class="main">|</span> <span class="entity">list_Seq</span> <span class="main">(</span><span class="entity">c</span>::<span class="entity">cs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_Seq</span> <span class="entity">c</span> <span class="main">(</span><span class="entity">list_Seq</span> <span class="entity">cs</span><span class="main">)</span>

        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_AssignIdx_retv</span> <span class="entity">x</span> <span class="entity">i</span> <span class="entity">y</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> AssignIdx_retv<span class="antiquote">}</span></span>$<span class="entity">x</span>$<span class="entity">i</span>$<span class="entity">y</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_ArrayCpy_retv</span> <span class="entity">d</span> <span class="entity">s</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> ArrayCpy_retv<span class="antiquote">}</span></span>$<span class="entity">d</span>$<span class="entity">s</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_Assign_retv</span> <span class="entity">x</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">antf</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Assign_retv</span><span class="antiquote">}</span></span><span class="main">)</span>$<span class="entity">x</span>$<span class="entity">t</span>
      

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_assign_from_retv</span> <span class="main">(</span><span class="entity">LV_IDX</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">y</span> <span class="main">=</span> <span class="entity">mk_AssignIdx_retv</span> <span class="main">(</span><span class="entity">mk_var_a</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">mk_var_i</span> <span class="entity">y</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">mk_assign_from_retv</span> <span class="main">(</span><span class="entity">LV_VAR</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">y</span> <span class="main">=</span> <span class="entity">mk_ArrayCpy_retv</span> <span class="main">(</span><span class="entity">mk_var_i</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span><span class="entity">mk_var_i</span> <span class="entity">y</span><span class="main">)</span>
      
              
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">param_varnames</span> <span class="entity">n</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="inner_quoted">"G_par_"</span>^Int.toString <span class="entity">i</span><span class="main">)</span> <span class="main">(</span><span class="inner_numeral">1</span> upto <span class="entity">n</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip_with_param_names</span> <span class="entity">xs</span> <span class="main">=</span> <span class="main">(</span><span class="entity">param_varnames</span> <span class="main">(</span>length <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> ~~ <span class="entity">xs</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip_with_param_lvs</span> <span class="entity">xs</span> <span class="main">=</span> map <span class="entity">LV_VAR</span> <span class="main">(</span><span class="entity">param_varnames</span> <span class="main">(</span>length <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> ~~ <span class="entity">xs</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip_with_param_rvs</span> <span class="entity">xs</span> <span class="main">=</span> map <span class="entity">RV_VAR</span> <span class="main">(</span><span class="entity">param_varnames</span> <span class="main">(</span>length <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> ~~ <span class="entity">xs</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ret_varnames</span> <span class="entity">n</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> <span class="inner_quoted">"G_ret_"</span>^Int.toString <span class="entity">i</span><span class="main">)</span> <span class="main">(</span><span class="inner_numeral">1</span> upto <span class="entity">n</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip_with_ret_names</span> <span class="entity">xs</span> <span class="main">=</span> <span class="main">(</span><span class="entity">ret_varnames</span> <span class="main">(</span>length <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> ~~ <span class="entity">xs</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip_with_ret_lvs</span> <span class="entity">xs</span> <span class="main">=</span> map <span class="entity">LV_VAR</span> <span class="main">(</span><span class="entity">ret_varnames</span> <span class="main">(</span>length <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> ~~ <span class="entity">xs</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">zip_with_ret_rvs</span> <span class="entity">xs</span> <span class="main">=</span> map <span class="entity">RV_VAR</span> <span class="main">(</span><span class="entity">ret_varnames</span> <span class="main">(</span>length <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> ~~ <span class="entity">xs</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_params</span> <span class="entity">ress</span> <span class="entity">name_t</span> <span class="entity">args</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_assigns</span> <span class="main">=</span> <span class="entity">zip_with_param_lvs</span> <span class="entity">args</span>
          |&gt; map <span class="main">(</span>uncurry <span class="entity">mk_lr_assign</span><span class="main">)</span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res_assigns</span> <span class="main">=</span> <span class="entity">zip_with_ret_names</span> <span class="entity">ress</span>
          |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">rv</span><span class="main">,</span><span class="entity">res</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mk_assign_from_retv</span> <span class="entity">res</span> <span class="entity">rv</span><span class="main">)</span>  
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">param_assigns</span> @ <span class="main">[</span><span class="entity">mk_Params</span> <span class="entity">name_t</span><span class="main">]</span> @ <span class="entity">res_assigns</span>  
          |&gt; <span class="entity">list_Seq</span>
          
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">res</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      
    <span class="keyword2"><span class="keyword">end</span></span>  
  
  ›</span>
  
    
   
  <span class="comment1">(* Syntax constants to discriminate annotation types *)</span>
  <span class="keyword1"><span class="command">syntax</span></span>
    <span class="quoted">"_invariant_annotation"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span>"</span></span>
    <span class="quoted">"_variant_annotation"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span>"</span></span>
    <span class="quoted">"_relation_annotation"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span>"</span></span>
  
  
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">IMP_Parser</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">scan_if_then_else</span> <span class="entity">scan1</span> <span class="entity">scan2</span> <span class="entity">scan3</span> <span class="entity">xs</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r</span> <span class="main">=</span> SOME <span class="main">(</span>Scan.catch <span class="entity">scan1</span> <span class="entity">xs</span><span class="main">)</span> <span class="keyword3"><span class="keyword">handle</span></span> Fail <span class="main">_</span> <span class="main">=&gt;</span> NONE
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">r</span> <span class="keyword2"><span class="keyword">of</span></span> 
          NONE <span class="main">=&gt;</span> <span class="entity">scan3</span> <span class="entity">xs</span>
        <span class="main">|</span> SOME <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">xs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">scan2</span> <span class="entity">a</span> <span class="entity">xs</span>
      <span class="keyword2"><span class="keyword">end</span></span>
      
    
      <span class="keyword1"><span class="keyword">infixr</span></span> <span class="inner_numeral">0</span> |||
      <span class="keyword1"><span class="keyword">infix</span></span> <span class="inner_numeral">5</span> ---
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="main">(</span><span class="entity">g</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="entity">|||</span> <span class="entity">e</span> <span class="main">=</span> <span class="entity">scan_if_then_else</span> <span class="entity">g</span> <span class="entity">p</span> <span class="entity">e</span>
          
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lastg</span> <span class="main">(</span><span class="entity">g</span><span class="main">,</span><span class="entity">p</span><span class="main">)</span> <span class="main">=</span> <span class="entity">g</span> :|-- <span class="entity">p</span>
    
    
      <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">op_kind</span> <span class="main">=</span> <span class="entity">Binop</span> <span class="main">|</span> <span class="entity">Unop</span>
      
      <span class="comment1">(*
      val int_c = @{const N}
      val bool_c = @{const Bc}
      val var_c = @{const V}
      *)</span>
      
      
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">op_decl</span> <span class="main">=</span> <span class="entity">op_kind</span> * <span class="main">(</span>string * term<span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">name_eq_op_decl</span> <span class="main">(</span><span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="entity">k'</span><span class="main">,</span><span class="main">(</span><span class="entity">b</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">k</span><span class="main">=</span><span class="entity">k'</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">a</span><span class="main">=</span><span class="entity">b</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_binop</span> <span class="main">(</span><span class="main">(</span><span class="entity">Binop</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">:</span><span class="entity">op_decl</span><span class="main">)</span> <span class="main">=</span> true <span class="main">|</span> <span class="entity">is_binop</span> <span class="main">_</span> <span class="main">=</span> false
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_unop</span> <span class="main">(</span><span class="main">(</span><span class="entity">Unop</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">:</span><span class="entity">op_decl</span><span class="main">)</span> <span class="main">=</span> true <span class="main">|</span> <span class="entity">is_unop</span> <span class="main">_</span> <span class="main">=</span> false
      
      <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Opr_Data</span> <span class="main">=</span> Generic_Data <span class="main">(</span>
        <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">op_decl</span> list Inttab.table
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> Inttab.empty
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">merge</span> <span class="main">=</span> Inttab.merge_list <span class="entity">name_eq_op_decl</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
      <span class="main">)</span>
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tab_add_unop</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">n</span><span class="main">,</span><span class="entity">f</span><span class="main">)</span> <span class="main">=</span> Inttab.insert_list <span class="entity">name_eq_op_decl</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="main">(</span><span class="entity">Unop</span><span class="main">,</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tab_add_binop</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="entity">n</span><span class="main">,</span><span class="entity">f</span><span class="main">)</span> <span class="main">=</span> Inttab.insert_list <span class="entity">name_eq_op_decl</span> <span class="main">(</span><span class="entity">p</span><span class="main">,</span><span class="main">(</span><span class="entity">Binop</span><span class="main">,</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_unop</span> <span class="main">=</span> Opr_Data.map o <span class="entity">tab_add_unop</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">add_binop</span> <span class="main">=</span> Opr_Data.map o <span class="entity">tab_add_binop</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_varname</span> <span class="main">=</span> <span class="main">(</span>Parse.short_ident || Parse.term_var<span class="main">)</span> 
            
      
      <span class="keyword2"><span class="keyword">local</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_level</span> <span class="entity">parse_opr</span> <span class="entity">op_decls</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        
          <span class="keyword3"><span class="keyword">open</span></span> IMP_Syntax
        
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">binops</span> <span class="main">=</span> filter <span class="entity">is_binop</span> <span class="entity">op_decls</span> |&gt; 
            map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> Parse.$$$ <span class="entity">k</span> &gt;&gt; <span class="main">(</span>K <span class="entity">c</span><span class="main">)</span><span class="main">)</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unops</span> <span class="main">=</span> filter <span class="entity">is_unop</span> <span class="entity">op_decls</span> |&gt;
            map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span><span class="entity">k</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> Parse.$$$ <span class="entity">k</span> &gt;&gt; <span class="main">(</span>K <span class="entity">c</span><span class="main">)</span><span class="main">)</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bopg</span> <span class="main">=</span> Parse.group <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_quoted">"Binary operator"</span><span class="main">)</span> <span class="main">(</span>Scan.first <span class="entity">binops</span><span class="main">)</span> 
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">uopg</span> <span class="main">=</span> Parse.group <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_quoted">"Unary operator"</span><span class="main">)</span> <span class="main">(</span>Scan.first <span class="entity">unops</span><span class="main">)</span> 
            
          
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_right</span> <span class="entity">a</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="entity">a</span>
            <span class="main">|</span> <span class="entity">mk_right</span> <span class="entity">a</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">b</span><span class="main">)</span>::<span class="entity">fxs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk_right</span> <span class="main">(</span><span class="entity">rv_binop</span> <span class="entity">f</span> <span class="entity">a</span> <span class="entity">b</span><span class="main">)</span> <span class="entity">fxs</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_bop</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_opr</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">a</span> <span class="main">=&gt;</span> Scan.repeat <span class="main">(</span><span class="entity">bopg</span> -- <span class="entity">parse_opr</span><span class="main">)</span> &gt;&gt; <span class="entity">mk_right</span> <span class="entity">a</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_unop</span> <span class="main">=</span> <span class="main">(</span><span class="entity">uopg</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="entity">parse_opr</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">rv_unop</span> <span class="entity">f</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_bop</span> <span class="entity">|||</span> <span class="entity">lastg</span> <span class="entity">parse_unop</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">parse</span>
        <span class="keyword2"><span class="keyword">end</span></span>
        
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_levels</span> <span class="entity">lvls</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword3"><span class="keyword">open</span></span> IMP_Syntax
        
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_int</span> <span class="main">=</span> Parse.nat &gt;&gt; <span class="entity">rv_int'</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_var</span> <span class="main">=</span> <span class="entity">parse_varname</span> &gt;&gt; <span class="entity">rv_var</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pbc</span> <span class="main">=</span> Parse.keyword_markup <span class="main">(</span>true<span class="main">,</span>Markup.keyword3<span class="main">)</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_bool</span> <span class="main">=</span> 
               <span class="entity">pbc</span> <span class="inner_quoted">"true"</span> &gt;&gt; <span class="main">(</span>K <span class="main">(</span><span class="entity">rv_BC'</span> true<span class="main">)</span><span class="main">)</span>
            || <span class="entity">pbc</span> <span class="inner_quoted">"false"</span> &gt;&gt; <span class="main">(</span>K <span class="main">(</span><span class="entity">rv_BC'</span> false<span class="main">)</span><span class="main">)</span>
        
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse</span> <span class="main">[</span><span class="main">]</span> <span class="entity">xs</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_int</span> || <span class="entity">parse_varidx</span> || <span class="entity">parse_var</span> || <span class="entity">parse_bool</span> || <span class="main">(</span>Parse.$$$ <span class="inner_quoted">"("</span> |-- <span class="entity">parse</span> <span class="entity">lvls</span> --| Parse.$$$ <span class="inner_quoted">")"</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span>
            <span class="main">|</span> <span class="entity">parse</span> <span class="main">(</span><span class="entity">lv</span>::<span class="entity">lvs</span><span class="main">)</span> <span class="entity">xs</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_level</span> <span class="main">(</span><span class="entity">parse</span> <span class="entity">lvs</span><span class="main">)</span> <span class="entity">lv</span><span class="main">)</span> <span class="entity">xs</span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_varidx</span> <span class="entity">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="entity">parse_varname</span> -- Args.bracks <span class="main">(</span><span class="entity">parse</span> <span class="entity">lvls</span><span class="main">)</span><span class="main">)</span> 
            &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">rv_var_idx</span> <span class="entity">n</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">xs</span>
            
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">parse</span> <span class="entity">lvls</span>
        <span class="keyword2"><span class="keyword">end</span></span>
        
      <span class="keyword2"><span class="keyword">in</span></span>      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_exp_tab</span> <span class="main">=</span> Inttab.dest #&gt; map snd #&gt; <span class="entity">parse_levels</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_exp</span> <span class="main">=</span> Context.Proof #&gt; Opr_Data.get #&gt; <span class="entity">parse_exp_tab</span>
      <span class="keyword2"><span class="keyword">end</span></span>  

      <span class="comment1">(* TODO/FIXME: Going through the Args.term parser feels like a hack *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_term_pos</span> <span class="entity">ctxt</span> <span class="entity">spos</span> <span class="main">=</span> Args.term <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">,</span> <span class="main">[</span>Token.make_string <span class="entity">spos</span><span class="main">]</span><span class="main">)</span> |&gt; fst
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_proc_name</span> <span class="entity">ctxt</span> <span class="main">=</span> 
        Parse.$$$ <span class="inner_quoted">"rec"</span> |-- Parse.name &gt;&gt; <span class="entity">IMP_Syntax.mk_pcall</span>
        || Parse.name &gt;&gt; Syntax.read_term <span class="entity">ctxt</span>
        <span class="comment1">(*|| Parse.position Parse.name &gt;&gt; (read_term_pos ctxt)*)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_args</span> <span class="entity">ctxt</span> <span class="main">=</span> Args.parens <span class="main">(</span>Parse.enum <span class="inner_quoted">","</span> <span class="main">(</span><span class="entity">parse_exp</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_lhs</span> <span class="entity">ctxt</span> <span class="main">=</span> 
         <span class="entity">parse_varname</span> -- Args.bracks <span class="main">(</span><span class="entity">parse_exp</span> <span class="entity">ctxt</span><span class="main">)</span> &gt;&gt; uncurry <span class="entity">IMP_Syntax.lv_idx</span>
      || <span class="entity">parse_varname</span> &gt;&gt; <span class="entity">IMP_Syntax.LV_VAR</span>     

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_multiret_lhs</span> <span class="entity">ctxt</span> <span class="main">=</span> 
        Args.parens <span class="main">(</span>Parse.enum <span class="inner_quoted">","</span> <span class="main">(</span><span class="entity">parse_lhs</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>  
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_rhs_call</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">parse_proc_name</span> <span class="entity">ctxt</span> -- <span class="entity">parse_args</span> <span class="entity">ctxt</span>
        

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">g_parse_call_assign</span> <span class="entity">ctxt</span> <span class="main">=</span> 
        <span class="main">(</span><span class="entity">parse_lhs</span> <span class="entity">ctxt</span> --| Parse.$$$ <span class="inner_quoted">"="</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lhs</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">parse_rhs_call</span> <span class="entity">ctxt</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">IMP_Syntax.mk_params</span> <span class="main">[</span><span class="entity">lhs</span><span class="main">]</span> <span class="entity">f</span> <span class="entity">args</span><span class="main">)</span>
                           || <span class="main">(</span><span class="entity">parse_exp</span> <span class="entity">ctxt</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">rhs</span> <span class="main">=&gt;</span> <span class="entity">IMP_Syntax.mk_lr_assign</span> <span class="entity">lhs</span> <span class="entity">rhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">g_parse_multiret_call</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="main">(</span>
        <span class="main">(</span><span class="entity">parse_multiret_lhs</span> <span class="entity">ctxt</span> --| Parse.$$$ <span class="inner_quoted">"="</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ress</span> <span class="main">=&gt;</span> <span class="entity">parse_rhs_call</span> <span class="entity">ctxt</span> 
                                      &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">IMP_Syntax.mk_params</span> <span class="entity">ress</span> <span class="entity">f</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                                      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">g_parse_void_call</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="main">(</span><span class="entity">parse_rhs_call</span> <span class="entity">ctxt</span><span class="main">,</span> 
            <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span> <span class="main">=&gt;</span> Scan.succeed <span class="main">(</span><span class="entity">IMP_Syntax.mk_params</span> <span class="main">[</span><span class="main">]</span> <span class="entity">f</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span>
                          
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fixed_keywords</span> <span class="main">=</span> <span class="main">[</span><span class="inner_quoted">"("</span><span class="main">,</span><span class="inner_quoted">")"</span><span class="main">,</span><span class="inner_quoted">"{"</span><span class="main">,</span><span class="inner_quoted">"}"</span><span class="main">,</span><span class="inner_quoted">"true"</span><span class="main">,</span><span class="inner_quoted">"false"</span><span class="main">,</span><span class="inner_quoted">"[]"</span><span class="main">,</span><span class="inner_quoted">"["</span><span class="main">,</span><span class="inner_quoted">"]"</span><span class="main">,</span>
        <span class="inner_quoted">"if"</span><span class="main">,</span><span class="inner_quoted">"else"</span><span class="main">,</span><span class="inner_quoted">"while"</span><span class="main">,</span><span class="inner_quoted">"scope"</span><span class="main">,</span><span class="inner_quoted">"skip"</span><span class="main">,</span><span class="inner_quoted">"="</span><span class="main">,</span><span class="inner_quoted">";"</span><span class="main">,</span><span class="inner_quoted">","</span><span class="main">,</span>
        <span class="inner_quoted">"call"</span><span class="main">,</span> <span class="inner_quoted">"sreturn"</span><span class="main">,</span> <span class="inner_quoted">"inline"</span><span class="main">,</span><span class="inner_quoted">"clear"</span><span class="main">,</span><span class="inner_quoted">"rec"</span><span class="main">,</span>
        <span class="inner_quoted">"@invariant"</span><span class="main">,</span> <span class="inner_quoted">"@variant"</span><span class="main">,</span> <span class="inner_quoted">"@relation"</span><span class="main">,</span>
        <span class="inner_quoted">"__term"</span><span class="main">]</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_command</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pkw</span> <span class="main">=</span> Parse.keyword_markup <span class="main">(</span>true<span class="main">,</span>Markup.keyword1<span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pcm</span> <span class="main">=</span> Parse.keyword_markup <span class="main">(</span>true<span class="main">,</span>Markup.keyword2<span class="main">)</span>
      
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">g_parse_skip</span> <span class="main">=</span> <span class="main">(</span><span class="entity">pcm</span> <span class="inner_quoted">"skip"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Scan.succeed <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">SKIP</span><span class="antiquote">}</span></span><span class="main">)</span>
        
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">g_parse_block</span> <span class="entity">p</span> <span class="main">=</span> <span class="main">(</span>Parse.$$$ <span class="inner_quoted">"{"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">p</span> --| Parse.$$$ <span class="inner_quoted">"}"</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">g_parse_clear</span> <span class="main">=</span> <span class="main">(</span><span class="entity">pcm</span> <span class="inner_quoted">"clear"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">parse_varname</span> --| Parse.$$$ <span class="inner_quoted">"[]"</span> 
              &gt;&gt; <span class="main">(</span><span class="entity">IMP_Syntax.mk_ArrayInit</span> o <span class="entity">IMP_Syntax.mk_var_a</span><span class="main">)</span><span class="main">)</span>
        
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_invar_annotation</span> <span class="main">=</span> <span class="main">(</span><span class="entity">pkw</span> <span class="inner_quoted">"@invariant"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Term_Annot.parse_annotate</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_invariant_annotation"<span class="antiquote">}</span></span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_var_annotation</span> <span class="main">=</span> <span class="main">(</span><span class="entity">pkw</span> <span class="inner_quoted">"@variant"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Term_Annot.parse_annotate</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_variant_annotation"<span class="antiquote">}</span></span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_rel_annotation</span> <span class="main">=</span> <span class="main">(</span><span class="entity">pkw</span> <span class="inner_quoted">"@relation"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Term_Annot.parse_annotate</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_relation_annotation"<span class="antiquote">}</span></span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_while_annots</span> <span class="main">=</span> Scan.repeat <span class="main">(</span><span class="entity">parse_invar_annotation</span> <span class="entity">|||</span> <span class="entity">parse_var_annotation</span> <span class="entity">|||</span> <span class="entity">lastg</span> <span class="entity">parse_rel_annotation</span><span class="main">)</span>
              &gt;&gt; <span class="entity">HOLogic.mk_tuple</span>
        
        
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_atomic_com</span> <span class="entity">xs</span> <span class="main">=</span> 
          <span class="main">(</span>
                <span class="entity">g_parse_call_assign</span> <span class="entity">ctxt</span>
            <span class="entity">|||</span> <span class="entity">g_parse_multiret_call</span> <span class="entity">ctxt</span>
            <span class="entity">|||</span> <span class="entity">g_parse_void_call</span> <span class="entity">ctxt</span>
            <span class="entity">|||</span> <span class="entity">g_parse_skip</span> 
            <span class="entity">|||</span> <span class="entity">g_parse_clear</span>
            <span class="entity">|||</span> <span class="entity">lastg</span> <span class="main">(</span><span class="entity">g_parse_block</span> <span class="entity">parse_com</span><span class="main">)</span>
          <span class="main">)</span> <span class="entity">xs</span>
        
        <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_com1</span> <span class="entity">xs</span> <span class="main">=</span> <span class="main">(</span>
            <span class="main">(</span><span class="entity">pkw</span> <span class="inner_quoted">"if"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">pkw</span> <span class="inner_quoted">"("</span> |-- <span class="entity">parse_exp</span> <span class="entity">ctxt</span> --| <span class="entity">pkw</span> <span class="inner_quoted">")"</span> -- <span class="entity">parse_com1</span> 
              -- <span class="entity">scan_if_then_else</span> <span class="main">(</span><span class="entity">pkw</span> <span class="inner_quoted">"else"</span><span class="main">)</span> <span class="main">(</span>K <span class="entity">parse_com1</span><span class="main">)</span> <span class="main">(</span>Scan.succeed <span class="entity">IMP_Syntax.mk_Skip</span><span class="main">)</span> 
                &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">b</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">,</span><span class="entity">e</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">IMP_Syntax.mk_If</span> <span class="entity">b</span> <span class="entity">t</span> <span class="entity">e</span><span class="main">)</span><span class="main">)</span>
         <span class="entity">|||</span> <span class="main">(</span><span class="entity">pkw</span> <span class="inner_quoted">"while"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">pkw</span> <span class="inner_quoted">"("</span> |-- <span class="entity">parse_exp</span> <span class="entity">ctxt</span> --| <span class="entity">pkw</span> <span class="inner_quoted">")"</span> -- <span class="entity">parse_while_annots</span> -- <span class="entity">parse_com1</span>
                &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">b</span><span class="main">,</span><span class="entity">annots</span><span class="main">)</span><span class="main">,</span><span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">IMP_Syntax.mk_While_annot</span> <span class="entity">annots</span> <span class="entity">b</span> <span class="entity">c</span><span class="main">)</span><span class="main">)</span>
         <span class="entity">|||</span> <span class="main">(</span><span class="entity">pkw</span> <span class="inner_quoted">"scope"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">parse_com1</span> &gt;&gt; <span class="entity">IMP_Syntax.mk_Scope</span><span class="main">)</span>
         <span class="entity">|||</span> <span class="main">(</span><span class="entity">pkw</span> <span class="inner_quoted">"__term"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Term_Annot.parse_cartouche</span> &gt;&gt; <span class="entity">Term_Annot.read_term</span> <span class="entity">ctxt</span><span class="main">)</span>
         <span class="entity">|||</span> <span class="main">(</span><span class="entity">pkw</span> <span class="inner_quoted">"inline"</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Parse.position Parse.name &gt;&gt; <span class="main">(</span><span class="entity">IMP_Syntax.mk_Inline</span> o <span class="entity">read_term_pos</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
         <span class="entity">|||</span> <span class="entity">parse_atomic_com</span>
        
        <span class="main">)</span> <span class="entity">xs</span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">parse_com</span> <span class="entity">xs</span> <span class="main">=</span> <span class="main">(</span>
           <span class="entity">parse_com1</span> -- <span class="main">(</span>Scan.unless <span class="main">(</span>Parse.$$$ <span class="inner_quoted">";"</span><span class="main">)</span> <span class="main">(</span>Scan.succeed NONE<span class="main">)</span> || Parse.$$$ <span class="inner_quoted">";"</span> |-- <span class="entity">parse_com</span> &gt;&gt; SOME <span class="main">)</span>
           &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span>SOME <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">IMP_Syntax.mk_Seq</span> <span class="entity">s</span> <span class="entity">t</span> <span class="main">|</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span>NONE<span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">s</span><span class="main">)</span>
        
        <span class="main">)</span> <span class="entity">xs</span>
      
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">parse_com</span> <span class="keyword2"><span class="keyword">end</span></span> 
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_all</span> <span class="entity">ctxt</span> <span class="entity">p</span> <span class="entity">src</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">src</span> <span class="main">=</span> map Token.init_assignable <span class="entity">src</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">res</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> Scan.catch <span class="main">(</span>Scan.finite Token.stopper <span class="main">(</span><span class="entity">p</span> --| Scan.ahead Parse.eof<span class="main">)</span><span class="main">)</span> <span class="entity">src</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rp</span> <span class="main">=</span> map Token.reports_of_value <span class="entity">src</span> |&gt; flat
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Context_Position.reports <span class="entity">ctxt</span> <span class="entity">rp</span>
        
        <span class="comment1">(* val src = map Token.closure src |&gt; @{print} *)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">res</span>
      <span class="keyword2"><span class="keyword">end</span></span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">keywords_of_tab</span> <span class="main">:</span> <span class="entity">op_decl</span> list Inttab.table <span class="main">-&gt;</span> string list 
        <span class="main">=</span> Inttab.dest_list #&gt; map <span class="main">(</span>snd#&gt;snd#&gt;fst<span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">keywords</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">kws</span> <span class="main">=</span> <span class="entity">ctxt</span> |&gt; Context.Proof |&gt; Opr_Data.get |&gt; <span class="entity">keywords_of_tab</span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">kws</span> <span class="main">=</span> <span class="main">(</span><span class="entity">kws</span> @ <span class="entity">fixed_keywords</span><span class="main">)</span>
          |&gt; Symtab.make_set |&gt; Symtab.keys
          |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">x</span><span class="main">,</span>Position.none<span class="main">)</span><span class="main">,</span>Keyword.no_spec<span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        Keyword.add_keywords <span class="entity">kws</span> Keyword.empty_keywords
      <span class="keyword2"><span class="keyword">end</span></span>
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_pos_text</span> <span class="entity">p</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">pos</span><span class="main">,</span><span class="entity">text</span><span class="main">)</span> <span class="main">=</span> 
          Token.explode <span class="main">(</span><span class="entity">keywords</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">pos</span> <span class="entity">text</span> 
        |&gt; filter Token.is_proper  
        |&gt; <span class="entity">parse_all</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">p</span> <span class="entity">ctxt</span><span class="main">)</span>
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_sympos</span> <span class="entity">p</span> <span class="entity">ctxt</span> <span class="entity">xs</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">kws</span> <span class="main">=</span> <span class="entity">keywords</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tks</span> <span class="main">=</span> Token.tokenize <span class="entity">kws</span> <span class="main">{</span>strict<span class="main">=</span>true<span class="main">}</span> <span class="entity">xs</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rp</span> <span class="main">=</span> map <span class="main">(</span>Token.reports <span class="entity">kws</span><span class="main">)</span> <span class="entity">tks</span> |&gt; flat  <span class="comment1">(* TODO: More detailed report AFTER parsing! *)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Context_Position.reports_text <span class="entity">ctxt</span> <span class="entity">rp</span>
      <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">tks</span> 
        |&gt; filter Token.is_proper  
        |&gt; <span class="entity">parse_all</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">p</span> <span class="entity">ctxt</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">variables_of</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_abbrev</span> VARIABLEI<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Symtab.default <span class="main">(</span><span class="entity">HOLogic.dest_string</span> <span class="entity">x</span><span class="main">,</span><span class="entity">IMP_Syntax.VAL</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">add</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_abbrev</span> VARIABLEA<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Symtab.update <span class="main">(</span><span class="entity">HOLogic.dest_string</span> <span class="entity">x</span><span class="main">,</span><span class="entity">IMP_Syntax.ARRAY</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">add</span> <span class="main">(</span><span class="entity">a</span>$<span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">add</span> <span class="entity">a</span> #&gt; <span class="entity">add</span> <span class="entity">b</span>
          <span class="main">|</span> <span class="entity">add</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">add</span> <span class="entity">t</span>
          <span class="main">|</span> <span class="entity">add</span> <span class="main">_</span> <span class="main">=</span> I
      
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">add</span> <span class="entity">t</span> Symtab.empty |&gt; Symtab.dest
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge_variables</span> <span class="entity">vars</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">IMP_Syntax.VAL</span><span class="main">)</span> <span class="main">=</span> Symtab.default <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">IMP_Syntax.VAL</span><span class="main">)</span> 
          <span class="main">|</span> <span class="entity">add</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">IMP_Syntax.ARRAY</span><span class="main">)</span> <span class="main">=</span> Symtab.update <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">IMP_Syntax.ARRAY</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        fold <span class="entity">add</span> <span class="entity">vars</span> Symtab.empty |&gt; Symtab.dest
      <span class="keyword2"><span class="keyword">end</span></span>
      
      
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse_command_at</span> <span class="entity">ctxt</span> <span class="entity">spos</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">syms</span> <span class="main">=</span> <span class="entity">spos</span> |&gt; Symbol_Pos.explode |&gt; Symbol_Pos.cartouche_content
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">parse_sympos</span> <span class="entity">parse_command</span> <span class="entity">ctxt</span> <span class="entity">syms</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> <span class="entity">variables_of</span> <span class="entity">res</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="entity">vars</span><span class="main">,</span><span class="entity">res</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    
      <span class="comment1">(* From Makarius: Protect a term such that it "survives" the subsequent translation phase *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mark_term</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Const <span class="main">(</span>Lexicon.mark_const <span class="entity">c</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">mark_term</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Const <span class="main">(</span>Lexicon.mark_fixed <span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">mark_term</span> <span class="main">(</span><span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mark_term</span> <span class="entity">t</span> $ <span class="entity">mark_term</span> <span class="entity">u</span>
        <span class="main">|</span> <span class="entity">mark_term</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">mark_term</span> <span class="entity">b</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">mark_term</span> <span class="entity">a</span> <span class="main">=</span> <span class="entity">a</span><span class="main">;</span>
      
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cartouche_tr</span> <span class="entity">ctxt</span> <span class="entity">args</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>  
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">err</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"imp"</span><span class="main">,</span><span class="entity">args</span><span class="main">)</span>
      
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse</span> <span class="entity">spos</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">parse_command_at</span> <span class="entity">ctxt</span> <span class="entity">spos</span> 
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Term_Annot.has_annotations</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span>warning <span class="inner_quoted">"Stripped annotations from program"</span><span class="main">;</span> <span class="entity">Term_Annot.strip_annotated_terms</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">t</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Syntax.check_term <span class="entity">ctxt</span> <span class="entity">t</span>
            |&gt; <span class="entity">mark_term</span>
        <span class="keyword2"><span class="keyword">in</span></span>  
          <span class="entity">t</span>
        <span class="keyword2"><span class="keyword">end</span></span>
        
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">args</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">[</span><span class="main">(</span><span class="entity">c</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_constrain"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ Free <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p</span><span class="main">]</span> <span class="main">=&gt;</span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Term_Position.decode_position <span class="entity">p</span> <span class="keyword2"><span class="keyword">of</span></span>
              SOME <span class="main">(</span><span class="entity">pos</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">c</span> $ <span class="entity">parse</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">pos</span><span class="main">)</span> $ <span class="entity">p</span>
            <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="entity">err</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">err</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
                
    <span class="keyword2"><span class="keyword">end</span></span>
  ›</span>

  
  
  <span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_Imp"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cartouche_position <span class="main">⇒</span> logic"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span>_"</span><span class="main">)</span>

  <span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹
    <span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_Imp"<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">IMP_Parser.cartouche_tr</span><span class="main">)</span><span class="main">]</span>
  ›</span>

  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹<span class="keyword2"><span class="keyword"><span class="keyword2">skip</span></span></span>›</span>›</span></span>
  
  
  
    
  <span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹K <span class="main">(</span> I
  #&gt; <span class="entity">IMP_Parser.add_unop</span> <span class="main">(</span><span class="inner_numeral">31</span><span class="main">,</span><span class="inner_quoted">"-"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Unop uminus"</span><span class="antiquote">}</span></span><span class="main">)</span>  
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">25</span><span class="main">,</span><span class="inner_quoted">"*"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Binop <span class="main">(*)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">25</span><span class="main">,</span><span class="inner_quoted">"/"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Binop <span class="keyword1">(div)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">25</span><span class="main">,</span><span class="inner_quoted">"mod"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Binop <span class="keyword1">(mod)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">21</span><span class="main">,</span><span class="inner_quoted">"+"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Binop <span class="main">(+)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">21</span><span class="main">,</span><span class="inner_quoted">"-"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Binop <span class="main">(-)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">11</span><span class="main">,</span><span class="inner_quoted">"&lt;"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Cmpop <span class="main">(&lt;)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">11</span><span class="main">,</span><span class="inner_quoted">"≤"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Cmpop <span class="main">(≤)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">11</span><span class="main">,</span><span class="inner_quoted">"&gt;"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Cmpop <span class="main">(&gt;)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">11</span><span class="main">,</span><span class="inner_quoted">"≥"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Cmpop <span class="main">(≥)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">11</span><span class="main">,</span><span class="inner_quoted">"=="</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Cmpop <span class="main">(=)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">11</span><span class="main">,</span><span class="inner_quoted">"≠"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Cmpop <span class="main">(≠)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_unop</span> <span class="main">(</span><span class="inner_numeral">7</span><span class="main">,</span><span class="inner_quoted">"¬"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Not"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">5</span><span class="main">,</span><span class="inner_quoted">"∧"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"BBinop <span class="main">(∧)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
  #&gt; <span class="entity">IMP_Parser.add_binop</span> <span class="main">(</span><span class="inner_numeral">3</span><span class="main">,</span><span class="inner_quoted">"∨"</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"BBinop <span class="main">(∨)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span>
    <span class="main">)</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>
    
<span class="keyword1"><span class="command">experiment</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p1</span> <span class="main">≡</span> <span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹ x <span class="main"><span class="main">=</span></span> 42 ›</span>›</span></span>

  <span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹Syntax.read_term <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="inner_quoted">"p1"</span>›</span>
  
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted">p1</span>
  
  
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹
    x<span class="main"><span class="main">=</span></span>y<span class="main"><span class="main">;</span></span>                      <span class="comment1">― ‹Variable assignment / array copy›</span>
    a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> x<span class="main"><span class="main">;</span></span>                 <span class="comment1">― ‹Assign array index›</span>
    <span class="keyword2"><span class="keyword"><span class="keyword2">clear</span></span></span> a<span class="main"><span class="main">[]</span></span><span class="main"><span class="main">;</span></span>                <span class="comment1">― ‹Array initialization›</span>
    
    
    a <span class="main"><span class="main">=</span></span> b<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>                 <span class="comment1">― ‹Array indexing›</span>
    b <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>1<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">+</span></span> x<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">[</span></span>a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>   
        
    
    p1<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>                     <span class="comment1">― ‹Function call, ignore return value›</span>
    
    p1<span class="main"><span class="main">(</span></span>x<span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">,</span></span>y<span class="main"><span class="main">[</span></span>a<span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>           <span class="comment1">― ‹Function call with parameters›</span>
    
    a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">=</span></span>p1<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>                <span class="comment1">― ‹Return value assigned to <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>a[i]›</span></span>›</span>  
    a<span class="main"><span class="main">=</span></span>p1<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>                   <span class="comment1">― ‹Returns array (also works for value)›</span>
    
    <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">,</span></span>c<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> p1<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>        <span class="comment1">― ‹Multiple return values›</span>
    
    
    <span class="comment1">― ‹Special syntax for recursive calls. TODO: Get rid of this? ›</span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> p<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> p<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    a <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> p<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">,</span></span>c<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> p<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    
    <span class="keyword2"><span class="keyword"><span class="keyword2">skip</span></span></span>
  ›</span>›</span></span>
  
  
  <span class="keyword1"><span class="command">term</span></span>  <span class="quoted"><span class="quoted">‹ <span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹
    a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span><span class="keyword2"><span class="keyword"><span class="keyword3">true</span></span></span><span class="main"><span class="keyword1">)</span></span> a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span><span class="keyword2"><span class="keyword"><span class="keyword3">false</span></span></span><span class="main"><span class="keyword1">)</span></span> <span class="keyword2"><span class="keyword"><span class="keyword2">skip</span></span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span><span class="keyword2"><span class="keyword"><span class="keyword2">skip</span></span></span><span class="main"><span class="main">;</span></span> <span class="keyword2"><span class="keyword"><span class="keyword2">skip</span></span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n <span class="main"><span class="main">&gt;</span></span> 0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted">‹not interpreted here›</span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted">‹not interpreted here›</span>
      <span class="main"><span class="keyword1">@relation</span></span> <span class="quoted">‹not interpreted here›</span>
    <span class="main"><span class="main">{</span></span>
      a <span class="main"><span class="main">=</span></span> a <span class="main"><span class="main">+</span></span> a<span class="main"><span class="main">;</span></span>
      
      <span class="main"><span class="keyword1">__term</span></span> <span class="quoted"><span class="quoted">‹SKIP<span class="main">;;</span> p1›</span></span><span class="main"><span class="main">;</span></span>
      
      <span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">p</span>1<span class="main"><span class="main">;</span></span>
      
      y <span class="main"><span class="main">=</span></span> p1<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> <span class="main"><span class="main">{</span></span>
        n<span class="main"><span class="main">=</span></span>0
      <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
      
      n <span class="main"><span class="main">=</span></span> n <span class="main"><span class="main">-</span></span> 1
    <span class="main"><span class="main">}</span></span>
  ›</span>›</span></span>  
   
<span class="keyword2"><span class="keyword">end</span></span>  

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹
    a<span class="main"><span class="main">=</span></span>1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
      a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span>
      n<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">-</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Parameter Passing›</span></span>  

<span class="keyword1"><span class="command">experiment</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The parser generates parameter and return value passing code, using the global
    variables <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>G_par_i›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>G_ret_i›</span></span></span></span>. 

    To illustrate this, we first define an example procedure. Its signature would be
      <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(int,int) f (int p1, int p2)›</span></span></span></span>
    
  ›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹<span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> <span class="main"><span class="main">{</span></span> p1 <span class="main"><span class="main">=</span></span> G_par_1<span class="main"><span class="main">;</span></span> p2 <span class="main"><span class="main">=</span></span> G_par_2<span class="main"><span class="main">;</span></span> G_ret_1<span class="main"><span class="main">=</span></span>x1<span class="main"><span class="main">+</span></span>x2<span class="main"><span class="main">;</span></span> G_ret_2<span class="main"><span class="main">=</span></span>x1<span class="main"><span class="main">-</span></span>x2 <span class="main"><span class="main">}</span></span>›</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The parser generates the corresponding caller-side code for the invocation of 
    this procedure:›</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹<span class="main"><span class="main">(</span></span>x1<span class="main"><span class="main">,</span></span>x2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> f<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">)</span></span>›</span>›</span></span>


<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2_Basic_Decls">
<div class="head">
<h1>Theory IMP2_Basic_Decls</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basic Declarations›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IMP2_Basic_Decls
<span class="keyword2"><span class="keyword">imports</span></span> <a href="IMP2_Basic_Simpset.html">IMP2_Basic_Simpset</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some declarations that are used at several places, and have been factored out.›</span></span>
  
  
  <span class="keyword1"><span class="command">named_theorems</span></span> analysis_unfolds <span class="quoted">‹Unfold theorems to be applied prior to program analysis functions›</span>
  
  <span class="keyword1"><span class="command">named_theorems</span></span> vcg_preprocess_rules <span class="quoted">‹Rules to be applied to goal before VCG›</span>
  
  <span class="keyword1"><span class="command">named_theorems</span></span> vcg_specs <span class="quoted">‹Specifications declared to VCG›</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2_Program_Analysis">
<div class="head">
<h1>Theory IMP2_Program_Analysis</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Program Analysis›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IMP2_Program_Analysis
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Annotated_Syntax.html">../basic/Annotated_Syntax</a>"</span> <span class="quoted">"<a href="Subgoal_Focus_Some.html">../lib/Subgoal_Focus_Some</a>"</span> <span class="quoted">"<a href="Parser.html">../parser/Parser</a>"</span> <a href="IMP2_Basic_Decls.html">IMP2_Basic_Decls</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Analysis Simproc›</span></span>

  
  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ANALYZE</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="comment1">(*lemma ANALYZE_cong[named_ss vcg_bb cong]: "ANALYZE x = ANALYZE x" by simp*)</span>
  
  <span class="keyword1"><span class="command">simproc_setup</span></span> ANALYZE <span class="main">(</span><span class="quoted"><span class="quoted">"ANALYZE <span class="free">x</span>"</span></span><span class="main">)</span> 
    <span class="main">=</span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
    
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">analysis_unfolds</span> <span class="main">=</span> 
          <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> ANALYZE_def<span class="antiquote">}</span></span></span> 
          :: <span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> analysis_unfolds<span class="antiquote">}</span></span>
          @ <span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> vcg_annotation_defs<span class="antiquote">}</span></span>
    
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unfold_conv</span> <span class="main">=</span> 
           map <span class="main">(</span>Local_Defs.meta_rewrite_rule <span class="entity">ctxt</span> #&gt; perhaps <span class="main">(</span>try Drule.abs_def<span class="main">)</span><span class="main">)</span> <span class="entity">analysis_unfolds</span>
        |&gt; Raw_Simplifier.rewrite <span class="entity">ctxt</span> true
    
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">unfold_conv</span> #&gt; SOME
    <span class="keyword2"><span class="keyword">end</span></span>  
  ›</span>
  <span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ANALYZE<span class="main">]</span><span class="main">]</span>

  <span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Named_Simpsets.map_ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> vcg_bb<span class="antiquote">}</span></span> <span class="main">(</span>
    <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">ctxt</span> addsimprocs <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">simproc</span> ANALYZE<span class="antiquote">}</span></span></span><span class="main">]</span>
  <span class="main">)</span>›</span>

  <span class="comment1">(* TODO: There's a more general concept here: 
    Activating specific simpsets depending on the context, or, in this case, a trigger constant.
    DUP with STRIP_ANNOT in VCG
  *)</span>

  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">analysis_unfolds</span><span class="main">]</span> <span class="main">=</span> Inline_def Params_def AssignIdx_retv_def ArrayCpy_retv_def
  

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Modifies Sets›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">modifies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname set <span class="main">⇒</span> state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">modifies</span> <span class="free"><span class="bound"><span class="entity">vars</span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∉</span><span class="free"><span class="bound"><span class="entity">vars</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> modifies_def <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">lemma</span></span> modifies_refl<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"modifies <span class="free">vs</span> <span class="free">a</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">lemma</span></span> modifies_sym<span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"modifies <span class="free">vs</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> modifies <span class="free">vs</span> <span class="free">b</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">lemma</span></span> modifies_trans'<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"modifies <span class="free">vs<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> modifies <span class="free">vs<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">b</span> <span class="free">c</span> <span class="main">⟹</span> modifies <span class="main">(</span><span class="free">vs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∪</span><span class="free">vs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">a</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">lemma</span></span> modifies_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"modifies <span class="free">vs</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> modifies <span class="free">vs</span> <span class="free">b</span> <span class="free">c</span> <span class="main">⟹</span> modifies <span class="free">vs</span> <span class="free">a</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
    <span class="comment1">(* Test for correct order of trans-rules *)</span>
    <span class="keyword1"><span class="command">notepad</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"modifies <span class="skolem">vs</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"modifies <span class="skolem">vs</span> <span class="skolem">b</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"modifies <span class="skolem">vs</span> <span class="skolem">a</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> <span class="comment1">(* This must be trivial. If you get vs∪vs, something went wrong! *)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
    
    
    <span class="keyword1"><span class="command">lemma</span></span> modifies_join<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> modifies <span class="free">vs<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span> <span class="free">b</span><span class="main">;</span> modifies <span class="free">vs<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> modifies <span class="main">(</span><span class="free">vs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">∩</span><span class="free">vs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">lemma</span></span> modifies_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">vs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⊆</span><span class="free">vs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span> modifies <span class="free">vs<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> modifies <span class="free">vs<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">lemma</span></span> modifies_equals<span class="main">:</span> <span class="quoted"><span class="quoted">"modifies <span class="free">vs</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∉</span><span class="free">vs</span> <span class="main">⟹</span> <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> <span class="free">s'</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> modifies_upd<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">vs</span> <span class="main">⟹</span> modifies <span class="free">vs</span> <span class="free">s</span> <span class="main">(</span><span class="free">s'</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> modifies <span class="free">vs</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">vs</span> <span class="main">⟹</span> modifies <span class="free">vs</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">s'</span> <span class="main">⟷</span> modifies <span class="free">vs</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
    <span class="keyword1"><span class="command">lemma</span></span> modifies_split<span class="main">:</span> <span class="quoted"><span class="quoted">"modifies <span class="free">vs</span> <span class="main">(</span><span class="main">&lt;</span><span class="free">l</span><span class="main">|</span><span class="free">g</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">(</span><span class="main">&lt;</span><span class="free">l'</span><span class="main">|</span><span class="free">g'</span><span class="main">&gt;</span><span class="main">)</span> 
      <span class="main">⟷</span> modifies <span class="main">(</span>Collect is_global <span class="main">∪</span> <span class="free">vs</span><span class="main">)</span> <span class="free">l</span> <span class="free">l'</span> <span class="main">∧</span> modifies <span class="main">(</span>Collect is_local <span class="main">∪</span> <span class="free">vs</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> combine_query<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> combine_query<span class="main">)</span>
      
  <span class="keyword2"><span class="keyword">end</span></span>  
    
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">wp_mod</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> wp <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> modifies <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> "</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">wlp_mod</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> wlp <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> modifies <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="bound">s'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> "</span></span>
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simplification of Modifies Tags›</span></span>  
    
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">simp_modifies_tac</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_modifies</span> <span class="main">_</span> <span class="entity">ct</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.term_of <span class="entity">ct</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">_</span>$<span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> modifies<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="main">_</span>$<span class="main">_</span>$<span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_modifies</span> <span class="main">(</span>Const <span class="main">_</span> $ <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> modifies<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">vs</span>$<span class="entity">s</span>$<span class="entity">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">vs</span><span class="main">,</span><span class="entity">s</span><span class="main">,</span><span class="entity">d</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">dest_modifies</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM<span class="main">(</span><span class="inner_quoted">"dest_modifies"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
        
        
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">Subgoal_Focus_Some.FOCUS_SOME_PREMS</span> <span class="entity">is_modifies</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context<span class="main">=</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="entity">concl</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sts</span> <span class="main">=</span> map <span class="main">(</span><span class="main">#</span><span class="inner_numeral">2</span> o <span class="entity">dest_modifies</span> o Thm.prop_of<span class="main">)</span> <span class="entity">prems</span> |&gt; Termtab.make_set
  
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">collect_vars</span> <span class="main">(</span><span class="entity">a</span>$<span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Termtab.defined <span class="entity">sts</span> <span class="entity">a</span> <span class="keyword2"><span class="keyword">then</span></span> Termtab.insert_set <span class="entity">b</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">collect_vars</span> <span class="entity">a</span> o <span class="entity">collect_vars</span> <span class="entity">b</span>
          <span class="main">|</span> <span class="entity">collect_vars</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">collect_vars</span> <span class="entity">t</span>
          <span class="main">|</span> <span class="entity">collect_vars</span> <span class="main">_</span> <span class="main">=</span> I
            
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> 
          Termtab.empty
          |&gt; <span class="entity">collect_vars</span> <span class="main">(</span>Thm.term_of <span class="entity">concl</span><span class="main">)</span> o fold <span class="entity">collect_vars</span> <span class="main">(</span>map Thm.prop_of <span class="entity">prems</span><span class="main">)</span>
          |&gt; Termtab.keys 
          |&gt; map <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span><span class="main">)</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt_bb</span> <span class="main">=</span> <span class="entity">Named_Simpsets.put</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> vcg_bb<span class="antiquote">}</span></span> <span class="entity">ctxt</span>  
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_mod_thm</span> <span class="entity">x</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> modifies_equals<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_triv</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.prop_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">prop</span> <span class="quoted">"True"</span><span class="antiquote">}</span></span> <span class="main">=&gt;</span> true <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Drule.infer_instantiate' <span class="entity">ctxt</span> <span class="main">[</span>SOME <span class="entity">x</span><span class="main">]</span> <span class="entity">thm</span>
            |&gt; <span class="entity">full_simplify</span> <span class="entity">ctxt_bb</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_triv</span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">then</span></span> NONE <span class="keyword2"><span class="keyword">else</span></span> SOME <span class="entity">thm</span>
        <span class="keyword2"><span class="keyword">end</span></span>
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> map_product <span class="main">(</span><span class="entity">mk_mod_thm</span><span class="main">)</span> <span class="entity">vars</span> <span class="entity">prems</span> |&gt; map_filter I 
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Simplifier.put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="entity">thms</span>
        
      
      <span class="keyword2"><span class="keyword">in</span></span> HEADGOAL <span class="main">(</span><span class="entity">asm_full_simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  ›</span>
  
  <span class="keyword1"><span class="command">method_setup</span></span> i_vcg_modifies_simp <span class="main">=</span> <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">simp_modifies_tac</span><span class="main">)</span>›</span>
  
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Syntactic Approximation of Modifies Set›</span></span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lhsv'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> vname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[]</span> <span class="main">::=</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span>Assign_Locals <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> Collect is_local"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> SKIP <span class="main">=</span> <span class="main">{}</span>"</span></span>  
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lhsv'</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free">lhsv'</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lhsv'</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free">lhsv'</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lhsv'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Set.filter is_global <span class="main">(</span><span class="free">lhsv'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span>PCall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="main">|</span> lhsv'_pscope_simp_orig<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">lhsv'</span> <span class="main">(</span>PScope <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>ran <span class="main">(</span>map_option <span class="free">lhsv'</span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="free">lhsv'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lhsvπ</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">c</span><span class="main">∈</span>ran <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">.</span> lhsv' <span class="bound">c</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> lhsv'_pscope_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lhsv' <span class="main">(</span>PScope <span class="free">π</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> lhsvπ <span class="free">π</span> <span class="main">∪</span> lhsv' <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def lhsv'_pscope_simp_orig lhsvπ_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> lhsvπ_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"lhsvπ Map.empty <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lhsvπ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> lhsvπ_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> lhsvπ <span class="main">(</span><span class="free">m</span><span class="main">(</span><span class="free">p</span><span class="main">↦</span><span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lhsv' <span class="free">c</span> <span class="main">∪</span> lhsvπ <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lhsvπ_def ran_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> lhsvπ_maplet<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> lhsvπ_empty lhsvπ_upd
  
  <span class="keyword1"><span class="command">notepad</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhsvπ <span class="main">[</span><span class="inner_quoted">''foo''</span> <span class="main">↦</span> <span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹a<span class="main"><span class="main">=</span></span>5›</span><span class="main">,</span> <span class="inner_quoted">''bar''</span> <span class="main">↦</span> <span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹c<span class="main"><span class="main">=</span></span>7<span class="main"><span class="main">;</span></span> b<span class="main"><span class="main">=</span></span>5<span class="main"><span class="main">;</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> foo<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span>›</span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="inner_quoted">''a''</span><span class="main">,</span> <span class="inner_quoted">''b''</span><span class="main">,</span> <span class="inner_quoted">''c''</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Params_def<span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  
  <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lhsv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"program <span class="main">⇒</span> com <span class="main">⇒</span> vname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[]</span> <span class="main">::=</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>Assign_Locals <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> Collect is_local"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> SKIP <span class="main">=</span> <span class="main">{}</span>"</span></span>  
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∪</span> <span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Set.filter is_global <span class="main">(</span><span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PCall <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> lhsvπ <span class="free"><span class="bound"><span class="entity">π</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lhsv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PScope <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> lhsvπ <span class="free"><span class="bound"><span class="entity">π'</span></span></span> <span class="main">∪</span> lhsv' <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
  
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Install special rule for procedure scope›</span></span>  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> lhsv'.simps
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> lhsv'_pscope_simp_orig 
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> lhsv'_pscope_simp
  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> lhsv.simps
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> lhsvπ_maplet
    
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> is_global.simps
  
  
          
    
  <span class="keyword1"><span class="command">lemma</span></span> modifies_lhsv'_gen<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhsvπ <span class="free">π</span> <span class="main">⊆</span> <span class="free">vs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lhsv' <span class="free">c</span> <span class="main">⊆</span> <span class="free">vs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"modifies <span class="free">vs</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Scope <span class="skolem">π</span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Scope.IH<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> vs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">∪</span> Collect is_local"</span></span><span class="main">]</span> Scope.prems 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_def combine_states_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PCall <span class="skolem">π</span> <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def lhsvπ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PScope <span class="skolem">π'</span> <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="skolem">π</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_le_iff ranI lhsvπ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_def combine_states_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> modifies_lhsvπ<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"modifies <span class="main">(</span>lhsvπ <span class="free">π</span><span class="main">)</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> modifies_lhsv'_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lhsvπ_def ran_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> lhsv_approx<span class="main">:</span> <span class="quoted"><span class="quoted">"lhsv <span class="free">π'</span> <span class="free">c</span> <span class="main">⊆</span> lhsvπ <span class="free">π'</span> <span class="main">∪</span> lhsv' <span class="free">c</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">π'</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lhsvπ_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
              

  <span class="keyword1"><span class="command">lemma</span></span> modifies_lhsv<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span><span class="main">:</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"modifies <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">all</span> <span class="quoted">‹(<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> modifies_def combine_states_def<span class="keyword3">;</span> <span class="operator">fail</span>)<span class="keyword3">?</span>›</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_lhsvπ<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> lhsv_approx <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
    
      
  <span class="keyword1"><span class="command">lemma</span></span> wp_strengthen_modset<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s'</span> <span class="main">∧</span> modifies <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span> <span class="bound">s'</span> <span class="free">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> modifies_lhsv<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> wlp_strengthen_modset<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">⟹</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s'</span> <span class="main">∧</span> modifies <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span> <span class="bound">s'</span> <span class="free">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wlp_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> modifies_lhsv<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> wp_mod_lhsv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wp_mod <span class="free">π</span> <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span> <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wp <span class="free">π</span> <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_mod_def
    <span class="keyword1"><span class="command">using</span></span> modifies_lhsv wp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> wlp_mod_lhsv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp_mod <span class="free">π</span> <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span> <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wlp_mod_def
    <span class="keyword1"><span class="command">using</span></span> modifies_lhsv wlp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Hoare-Triple with Modifies-Set›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a Hoare-Triple that contains a modifies declaration›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">HT_mods</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">mods</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> HT <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> modifies <span class="free"><span class="bound"><span class="entity">mods</span></span></span> <span class="bound">s</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">HT_partial_mods</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">mods</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> HT_partial <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span> <span class="main">∧</span> modifies <span class="free"><span class="bound"><span class="entity">mods</span></span></span> <span class="bound">s</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> HT_mods_cong<span class="main">[</span><span class="operator">named_ss</span> vcg_bb <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">cong</span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="free">vs'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">=</span><span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="free">c'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> modifies <span class="free">vs</span> <span class="bound">s</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span> <span class="main">=</span> <span class="free">Q'</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">vs</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span> <span class="main">=</span> HT_mods <span class="free">π</span> <span class="free">vs'</span> <span class="free">P'</span> <span class="free">c'</span> <span class="free">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> HT_mods_def HT_def <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wp_conseq<span class="main">)</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> HT_partial_mods_cong<span class="main">[</span><span class="operator">named_ss</span> vcg_bb <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">cong</span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="free">vs'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">=</span><span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">=</span><span class="free">c'</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> modifies <span class="free">vs</span> <span class="bound">s</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span> <span class="main">=</span> <span class="free">Q'</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_partial_mods <span class="free">π</span> <span class="free">vs</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span> <span class="main">=</span> HT_partial_mods <span class="free">π</span> <span class="free">vs'</span> <span class="free">P'</span> <span class="free">c'</span> <span class="free">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_mods_def HT_partial_def <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wlp_conseq<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> vcg_wp_conseq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span>modifies <span class="free">mods</span> <span class="bound">s'</span> <span class="free">s</span><span class="main">;</span> <span class="free">Q</span> <span class="free">s</span> <span class="bound">s'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="free">c</span> <span class="free">Q'</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_mods_def HT_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> wp_def<span class="main">)</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> vcg_wlp_conseq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_partial_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span>modifies <span class="free">mods</span> <span class="bound">s'</span> <span class="free">s</span><span class="main">;</span> <span class="free">Q</span> <span class="free">s</span> <span class="bound">s'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="free">c</span> <span class="free">Q'</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_mods_def HT_partial_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> wlp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The last rule allows us to re-use a total correctness verification in a partial 
    correctness proof.›</span></span>  
  <span class="keyword1"><span class="command">lemma</span></span> vcg_wlp_wp_conseq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span>modifies <span class="free">mods</span> <span class="bound">s'</span> <span class="free">s</span><span class="main">;</span> <span class="free">Q</span> <span class="free">s</span> <span class="bound">s'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="free">c</span> <span class="free">Q'</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms vcg_wp_conseq wp_imp_wlp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="comment1">(*
    TODO: Rules for combining proofs over the same program!
  *)</span>
        
    
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Free Variables of Expressions›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This function computes the set of variables that occur in an expression›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fv_aexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"aexp <span class="main">⇒</span> vname set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fv_aexp</span> <span class="main">(</span>N <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_aexp</span> <span class="main">(</span>Vidx <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">fv_aexp</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_aexp</span> <span class="main">(</span>Unop <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv_aexp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fv_aexp</span> <span class="main">(</span>Binop <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fv_aexp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∪</span> <span class="free">fv_aexp</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

    
<span class="keyword1"><span class="command">declare</span></span> fv_aexp.simps<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> aval_eq_on_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_aexp <span class="free">a</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">s'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> aval <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> aval <span class="free">a</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> aval_indep_non_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span>fv_aexp <span class="free">a</span> <span class="main">⟹</span> aval <span class="free">a</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">a</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> redundant_array_assignment<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">[]</span> <span class="main">::=</span> <span class="free">a</span><span class="main">;;</span> <span class="free">a</span><span class="main">[]</span> <span class="main">::=</span> <span class="free">x</span><span class="main">)</span> <span class="main">∼</span> <span class="main">(</span><span class="free">x</span><span class="main">[]</span> <span class="main">::=</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ArrayCpy fun_upd_def fun_upd_idem_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ArrayCpy Seq fun_upd_apply fun_upd_idem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> redundant_var_assignment<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span>fv_aexp <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span>fv_aexp <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">::=</span> Vidx <span class="free">a</span> <span class="free">j</span><span class="main">;;</span> <span class="free">a</span><span class="main">[</span><span class="free">j</span><span class="main">]</span> <span class="main">::=</span> Vidx <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">∼</span> <span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">::=</span> Vidx <span class="free">a</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">THEN</span> aval_indep_non_fv<span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Assign' aval.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fun_upd_apply fun_upd_idem_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Assign' fun_upd_twist<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Seq aval.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> big_step.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fun_upd_def fun_upd_triv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2_Var_Postprocessor">
<div class="head">
<h1>Theory IMP2_Var_Postprocessor</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Program Variables to Isabelle Variables›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IMP2_Var_Postprocessor
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Semantics.html">../basic/Semantics</a>"</span> <span class="quoted">"<a href="Parser.html">../parser/Parser</a>"</span> <span class="quoted">"<a href="Subgoal_Focus_Some.html">../lib/Subgoal_Focus_Some</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">RENAMING</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RENAMING</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> RENAMINGD<span class="main">:</span> <span class="quoted"><span class="quoted">"RENAMING <span class="free">s</span> <span class="free">d</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> RENAMING_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> RENAMINGI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> RENAMING <span class="free">s</span> <span class="bound">d</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> RENAMING_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Renaming</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">RENAMING_rl</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">d</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="comment1">(* FIXME: Rough approximation to hit ⋀d. … *)</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rn</span> <span class="main">(</span>Abs <span class="main">(</span><span class="inner_quoted">"d"</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="entity">d</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">rn</span> <span class="main">(</span><span class="entity">a</span>$<span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">rn</span> <span class="entity">a</span> $ <span class="entity">rn</span> <span class="entity">b</span>
          <span class="main">|</span> <span class="entity">rn</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>
    
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">s</span>
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> RENAMINGI<span class="antiquote">}</span></span></span>
          |&gt; Drule.infer_instantiate' <span class="entity">ctxt</span> <span class="main">[</span>SOME <span class="entity">s</span><span class="main">]</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">thm</span>  |&gt; Thm.prop_of |&gt; <span class="entity">rn</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm'</span> <span class="main">=</span> Thm.renamed_prop <span class="entity">t</span> <span class="entity">thm</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">thm'</span> <span class="keyword2"><span class="keyword">end</span></span>
  
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">apply_renamings_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_renaming</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> RENAMING<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="main">_</span>$<span class="main">_</span><span class="main">)</span> <span class="main">=</span> true <span class="main">|</span> <span class="entity">is_renaming</span> <span class="main">_</span> <span class="main">=</span> false
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="entity">Subgoal_Focus_Some.FOCUS_SOME_PREMS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Thm.term_of #&gt; <span class="entity">HOLogic.dest_Trueprop</span> #&gt; <span class="entity">is_renaming</span><span class="main">)</span>
          <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context<span class="main">=</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> 
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> RENAMINGD<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span> <span class="entity">prems</span>
          <span class="keyword2"><span class="keyword">in</span></span> 
            Local_Defs.unfold_tac <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">ctxt</span>
      
      <span class="keyword2"><span class="keyword">end</span></span>
      
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">remove_renamings_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="comment1">(* TODO: Unsafe. Should check that source does not occur elsewhere in goal! *)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        SELECT_GOAL <span class="main">(</span>
          REPEAT_DETERM <span class="main">(</span>HEADGOAL <span class="main">(</span>eresolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> thin_rl<span class="main">[</span><span class="operator">of</span> <span class="quoted">"RENAMING <span class="main">_</span> <span class="main">_</span>"</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span>
            THEN Local_Defs.unfold_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> triv_forall_equality<span class="antiquote">}</span></span></span>
          <span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
      
      
    <span class="keyword2"><span class="keyword">end</span></span>
  ›</span>  

  <span class="keyword1"><span class="command">method_setup</span></span> i_vcg_apply_renamings_tac <span class="main">=</span> <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">Renaming.apply_renamings_tac</span><span class="main">)</span>›</span>
  <span class="keyword1"><span class="command">method_setup</span></span> i_vcg_remove_renamings_tac <span class="main">=</span> <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">Renaming.remove_renamings_tac</span><span class="main">)</span>›</span>
      

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">NAMING_HINT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> string <span class="main">⇒</span> string <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">NAMING_HINT</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> True"</span></span>  
    
          
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="comment1">(*
      Postprocess VCs to convert states applied to variable names to actual logical variables.
    *)</span>
    <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">VC_Postprocessor</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    
      <span class="comment1">(* Guess suffix from name, e.g. "a<span class="hidden">⇩</span><sub>3</sub>" ↦ "<span class="hidden">⇩</span><sub>3</sub>" *)</span>  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">guess_suffix</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sfxs</span> <span class="main">=</span> <span class="main">[</span><span class="inner_quoted">"'"</span><span class="main">,</span><span class="inner_quoted">"⇩"</span><span class="main">,</span><span class="inner_quoted">"⇧"</span><span class="main">,</span><span class="inner_quoted">"⇘"</span><span class="main">,</span><span class="inner_quoted">"⇗"</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">in</span></span>  
        Symbol.explode #&gt; chop_prefix <span class="main">(</span>not o member <span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span> <span class="entity">sfxs</span><span class="main">)</span> #&gt; snd #&gt; implode
      <span class="keyword2"><span class="keyword">end</span></span>
    
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">guess_renaming</span> <span class="entity">param_rename_tab</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">kind</span><span class="main">,</span><span class="entity">vname</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">name_of</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">n</span>
          <span class="main">|</span> <span class="entity">name_of</span> <span class="main">_</span> <span class="main">=</span> <span class="inner_quoted">"v"</span>
            
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sname</span> <span class="main">=</span> the_default <span class="main">(</span><span class="entity">name_of</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>Termtab.lookup <span class="entity">param_rename_tab</span> <span class="entity">s</span><span class="main">)</span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sfx</span> <span class="main">=</span> <span class="entity">guess_suffix</span> <span class="entity">sname</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">src</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">kind</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="entity">IMP_Syntax.ARRAY</span> <span class="main">=&gt;</span> <span class="entity">s</span>$<span class="entity">x</span> <span class="main">|</span> <span class="entity">IMP_Syntax.VAL</span> <span class="main">=&gt;</span> <span class="entity">s</span>$<span class="entity">x</span>$ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">0</span><span class="main">::</span>int"</span><span class="antiquote">}</span></span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dst</span> <span class="main">=</span> suffix <span class="entity">sfx</span> <span class="entity">vname</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="entity">src</span><span class="main">,</span><span class="entity">dst</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
      
      
      <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Candtab</span> <span class="main">=</span> Table<span class="main">(</span><span class="keyword1"><span class="keyword">type</span></span> <span class="entity">key</span> <span class="main">=</span> term*term <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ord</span> <span class="main">=</span> prod_ord Term_Ord.fast_term_ord Term_Ord.fast_term_ord<span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_state_candidates</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span> <span class="keyword1"><span class="keyword">as</span></span> Free <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">state</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span> $ <span class="entity">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">HOLogic.dest_string</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">of</span></span>
          SOME <span class="entity">vname</span> <span class="main">=&gt;</span> apfst <span class="main">(</span>Candtab.update <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">IMP_Syntax.ARRAY</span><span class="main">,</span><span class="entity">vname</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> NONE <span class="main">=&gt;</span> apsnd <span class="main">(</span>insert <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">s</span><span class="main">)</span> #&gt; <span class="entity">add_state_candidates</span> <span class="entity">x</span>  
      <span class="main">)</span>
      <span class="main">|</span> <span class="entity">add_state_candidates</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span> <span class="keyword1"><span class="keyword">as</span></span> Free <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">state</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span> $ <span class="entity">x</span> $ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">0</span><span class="main">::</span>int"</span><span class="antiquote">}</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">HOLogic.dest_string</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">of</span></span>
          SOME <span class="entity">vname</span> <span class="main">=&gt;</span> apfst <span class="main">(</span>Candtab.default <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">IMP_Syntax.VAL</span><span class="main">,</span><span class="entity">vname</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> NONE <span class="main">=&gt;</span> apsnd <span class="main">(</span>insert <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">s</span><span class="main">)</span> #&gt; <span class="entity">add_state_candidates</span> <span class="entity">x</span>  
      <span class="main">)</span>
      <span class="main">|</span> <span class="entity">add_state_candidates</span> <span class="main">(</span><span class="entity">s</span> <span class="keyword1"><span class="keyword">as</span></span> Free <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">state</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> apsnd <span class="main">(</span>insert <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">s</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">add_state_candidates</span> <span class="main">(</span><span class="entity">a</span>$<span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">add_state_candidates</span> <span class="entity">a</span> #&gt; <span class="entity">add_state_candidates</span> <span class="entity">b</span>
      <span class="main">|</span> <span class="entity">add_state_candidates</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">add_state_candidates</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">add_state_candidates</span> <span class="main">_</span> <span class="main">=</span> I
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">hint_renaming</span> <span class="entity">hint_tab</span> <span class="main">(</span><span class="entity">rn</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">(</span><span class="entity">sx</span><span class="main">,</span><span class="main">(</span><span class="entity">kind</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Candtab.lookup <span class="entity">hint_tab</span> <span class="entity">sx</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> <span class="entity">rn</span>
      <span class="main">|</span> SOME <span class="entity">vname'</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">sx</span><span class="main">,</span><span class="main">(</span><span class="entity">kind</span><span class="main">,</span><span class="entity">vname'</span><span class="main">)</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compute_renamings</span> <span class="entity">param_rename_tab</span> <span class="entity">hint_tab</span> <span class="main">(</span><span class="entity">good</span><span class="main">,</span><span class="entity">bad</span><span class="main">)</span> <span class="main">=</span> 
        subtract <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">bs</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">bs</span><span class="main">=</span><span class="entity">s</span><span class="main">)</span> <span class="entity">bad</span> <span class="main">(</span>Candtab.dest <span class="entity">good</span><span class="main">)</span>
      |&gt; map <span class="main">(</span><span class="entity">hint_renaming</span> <span class="entity">hint_tab</span><span class="main">)</span>  
      |&gt; map <span class="main">(</span><span class="entity">guess_renaming</span> <span class="entity">param_rename_tab</span><span class="main">)</span>
      
      <span class="comment1">(* Naming hints go to hint-tab in #1, other premises go to list in #2 *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_naming_hint</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span>$<span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> NAMING_HINT<span class="antiquote">}</span></span>$<span class="entity">s</span>$<span class="entity">x</span>$<span class="entity">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">HOLogic.dest_string</span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">of</span></span>
          SOME <span class="entity">n</span> <span class="main">=&gt;</span> apfst <span class="main">(</span>Candtab.update <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">x</span><span class="main">)</span><span class="main">,</span><span class="entity">n</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">(</span>warning <span class="inner_quoted">"NAMING_HINT with non-string constant ignored"</span><span class="main">;</span> I<span class="main">)</span>
        <span class="main">)</span>
      <span class="main">|</span> <span class="entity">add_naming_hint</span> <span class="entity">t</span> <span class="main">=</span> apsnd <span class="main">(</span>cons <span class="entity">t</span><span class="main">)</span>
      
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">insert_vbind_tac</span> <span class="main">=</span> <span class="entity">Subgoal.FOCUS_PREMS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context<span class="main">=</span><span class="entity">ctxt</span><span class="main">,</span> <span class="entity">concl</span><span class="main">,</span> <span class="entity">params</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conclt</span> <span class="main">=</span> Thm.term_of <span class="entity">concl</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_rename_tab</span> <span class="main">=</span> <span class="entity">params</span> |&gt; map <span class="main">(</span>apsnd <span class="main">(</span>Thm.term_of<span class="main">)</span> #&gt; swap<span class="main">)</span> |&gt; Termtab.make 
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">hint_tab</span><span class="main">,</span><span class="entity">prem_ts</span><span class="main">)</span> <span class="main">=</span> 
            fold <span class="main">(</span><span class="entity">add_naming_hint</span> o Thm.prop_of<span class="main">)</span> <span class="entity">prems</span> <span class="main">(</span>Candtab.empty<span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> 
          
          <span class="comment1">(* val _ = @{print} (hint_tab,prem_ts)  *)</span>
            
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">renamings</span> <span class="main">=</span> 
              <span class="entity">add_state_candidates</span> <span class="entity">conclt</span> <span class="main">(</span>Candtab.empty<span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> 
            |&gt; fold <span class="main">(</span><span class="entity">add_state_candidates</span><span class="main">)</span> <span class="entity">prem_ts</span>
            |&gt; <span class="entity">compute_renamings</span> <span class="entity">param_rename_tab</span> <span class="entity">hint_tab</span>
            
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tacs</span> <span class="main">=</span> map <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> o single o <span class="entity">Renaming.RENAMING_rl</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">renamings</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          EVERY1 <span class="entity">tacs</span>
        <span class="keyword2"><span class="keyword">end</span></span>
        <span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">remove_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="comment1">(* TODO: Unsafe. Should check that source does not occur elsewhere in goal! *)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        SELECT_GOAL <span class="main">(</span>REPEAT_DETERM <span class="main">(</span>HEADGOAL <span class="main">(</span>eresolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> thin_rl<span class="main">[</span><span class="operator">of</span> <span class="quoted">"NAMING_HINT <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        THEN' <span class="entity">Renaming.remove_renamings_tac</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">end</span></span>
        
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">postprocess_vc_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
        <span class="entity">insert_vbind_tac</span> <span class="entity">ctxt</span>
        THEN' <span class="entity">Renaming.apply_renamings_tac</span> <span class="entity">ctxt</span>
        THEN' <span class="entity">remove_tac</span> <span class="entity">ctxt</span>
  
    <span class="keyword2"><span class="keyword">end</span></span>
  ›</span>  
  
  <span class="keyword1"><span class="command">method_setup</span></span> i_vcg_insert_vbind_tac <span class="main">=</span> <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">VC_Postprocessor.insert_vbind_tac</span><span class="main">)</span>›</span>
  <span class="keyword1"><span class="command">method_setup</span></span> i_vcg_postprocess_vars <span class="main">=</span> <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">VC_Postprocessor.postprocess_vc_tac</span><span class="main">)</span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2_Var_Abs">
<div class="head">
<h1>Theory IMP2_Var_Abs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstraction over Program Variables›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IMP2_Var_Abs
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Semantics.html">../basic/Semantics</a>"</span> <span class="quoted">"<a href="Parser.html">../parser/Parser</a>"</span> <a href="IMP2_Basic_Simpset.html">IMP2_Basic_Simpset</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">VAR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">VAR</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
    
    
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹ <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Program_Variables</span> 
  <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

    <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">AbsInfo</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="main">(</span>IMP_Syntax.impvar * string<span class="main">)</span> * term<span class="main">)</span> list * <span class="main">(</span>string * term<span class="main">)</span>
      <span class="comment1">(* (imp_var × sfx_name × Free) list × (statename × statev)
      
        where
          imp_var    -- IMP variable
          sfx_name   -- HOL variable name to bind to
          Free       -- Free variable in term that shall be abstracted
      
          statename  -- HOL variable name to bind state to
          statev     -- Free variable for state in term
        *)</span>
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stateN</span> <span class="main">=</span> <span class="inner_quoted">"𝔰"</span>           <span class="comment1">(* Base name for state variable *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nameT</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">vname</span><span class="antiquote">}</span></span>  <span class="comment1">(* HOL type of variable names *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">avalueT</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">val</span><span class="antiquote">}</span></span>    <span class="comment1">(* HOL type of array variable values *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pvalueT</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">pval</span><span class="antiquote">}</span></span>    <span class="comment1">(* HOL type of primitive variable values *)</span>

    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_vref_t</span> <span class="entity">state_t</span> <span class="main">(</span><span class="entity">ivname</span><span class="main">,</span><span class="entity">IMP_Syntax.VAL</span><span class="main">)</span> <span class="main">=</span> <span class="entity">state_t</span> $ <span class="entity">IMP_Syntax.mk_varname</span> <span class="entity">ivname</span> $ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">0</span><span class="main">::</span>int"</span><span class="antiquote">}</span></span>
      <span class="main">|</span> <span class="entity">mk_vref_t</span> <span class="entity">state_t</span> <span class="main">(</span><span class="entity">ivname</span><span class="main">,</span><span class="entity">IMP_Syntax.ARRAY</span><span class="main">)</span> <span class="main">=</span> <span class="entity">state_t</span> $ <span class="entity">IMP_Syntax.mk_varname</span> <span class="entity">ivname</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stateT</span> <span class="main">=</span> <span class="entity">nameT</span> --&gt; <span class="entity">avalueT</span>
      
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">abstract_var</span> <span class="entity">statev</span> <span class="main">(</span><span class="main">(</span><span class="entity">imp_var</span><span class="main">,</span> <span class="entity">sfx_name</span><span class="main">)</span><span class="main">,</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span> <span class="main">=</span> fastype_of <span class="entity">t</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vT</span> <span class="main">=</span> fastype_of <span class="entity">v</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Term.lambda_name <span class="main">(</span><span class="entity">sfx_name</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> <span class="entity">t</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vref_t</span> <span class="main">=</span> <span class="entity">mk_vref_t</span> <span class="entity">statev</span> <span class="entity">imp_var</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> VAR<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">vT</span> --&gt; <span class="main">(</span><span class="entity">vT</span> --&gt; <span class="entity">T</span><span class="main">)</span> --&gt; <span class="entity">T</span><span class="main">)</span> $ <span class="entity">vref_t</span> $ <span class="entity">t</span>
    <span class="keyword2"><span class="keyword">end</span></span> 
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_statev</span> <span class="main">(</span><span class="entity">AbsInfo</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">v</span>
    
    <span class="comment1">(*
      Create context and abstraction info that binds imp variables to Isabelle 
      variable names. Moreover, the state is bound to Isabelle variable with name stateN and specified suffix.
    *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_declare_variables</span> <span class="entity">imp_x_isa_names</span> <span class="entity">isa_suffix</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">ctxt</span> |&gt; Variable.set_body true

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">isa_statename</span> <span class="main">=</span> suffix <span class="entity">isa_suffix</span> <span class="entity">stateN</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">statev</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton Variable.add_fixes <span class="entity">isa_statename</span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">statev</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">statev</span><span class="main">,</span><span class="entity">stateT</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Variable.declare_constraints <span class="entity">statev</span> <span class="entity">ctxt</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">imp_var_isa_T</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">IMP_Syntax.VAL</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pvalueT</span>
        <span class="main">|</span> <span class="entity">imp_var_isa_T</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">IMP_Syntax.ARRAY</span><span class="main">)</span> <span class="main">=</span> <span class="entity">avalueT</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">declare_impv</span> <span class="main">(</span><span class="entity">imp_var</span><span class="main">,</span><span class="entity">isa_name</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">isa_name</span> <span class="main">=</span> suffix <span class="entity">isa_suffix</span> <span class="entity">isa_name</span> 
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">vname</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton Variable.add_fixes <span class="entity">isa_name</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">v</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">vname</span><span class="main">,</span> <span class="entity">imp_var_isa_T</span> <span class="entity">imp_var</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Variable.declare_constraints <span class="entity">v</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">imp_var</span><span class="main">,</span><span class="entity">isa_name</span><span class="main">)</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span><span class="main">,</span> Proof_Context.augment <span class="entity">v</span> <span class="entity">ctxt</span> <span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">vs</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> fold_map <span class="entity">declare_impv</span> <span class="entity">imp_x_isa_names</span> <span class="entity">ctxt</span>
          
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span><span class="entity">AbsInfo</span> <span class="main">(</span><span class="entity">vs</span><span class="main">,</span> <span class="main">(</span><span class="entity">isa_statename</span><span class="main">,</span> <span class="entity">statev</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctxt</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
    
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">declare_variables</span> <span class="entity">imp_vars</span> <span class="entity">sfx</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">imp_x_isa_names</span> <span class="main">=</span> <span class="entity">imp_vars</span> ~~ <span class="main">(</span>map fst <span class="entity">imp_vars</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">gen_declare_variables</span> <span class="entity">imp_x_isa_names</span> <span class="entity">sfx</span> <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">end</span></span>  

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">abstract_vars</span> <span class="main">(</span><span class="entity">AbsInfo</span> <span class="main">(</span><span class="entity">nsvs</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">statev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">frees</span> <span class="main">=</span> Term.add_frees <span class="entity">t</span> <span class="main">[</span><span class="main">]</span> |&gt; map Free |&gt; Termtab.make_set
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">absv</span> <span class="main">(</span><span class="entity">nss</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span> <span class="main">=</span> 
        <span class="keyword2"><span class="keyword">if</span></span> Termtab.defined <span class="entity">frees</span> <span class="entity">v</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">abstract_var</span> <span class="entity">statev</span> <span class="main">(</span><span class="entity">nss</span><span class="main">,</span><span class="entity">v</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span> I
    
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> fold <span class="entity">absv</span> <span class="entity">nsvs</span> <span class="entity">t</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">t</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">abstract_state</span> <span class="main">(</span><span class="entity">AbsInfo</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">(</span><span class="entity">staten</span><span class="main">,</span><span class="entity">statev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">t</span> <span class="main">=</span> Term.lambda_name <span class="main">(</span><span class="entity">staten</span><span class="main">,</span> <span class="entity">statev</span><span class="main">)</span> <span class="entity">t</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">abstract</span> <span class="entity">vinfo</span> <span class="main">=</span> <span class="entity">abstract_vars</span> <span class="entity">vinfo</span> #&gt; <span class="entity">abstract_state</span> <span class="entity">vinfo</span>
      
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2_VCG">
<div class="head">
<h1>Theory IMP2_VCG</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Verification Condition Generator›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IMP2_VCG
<span class="keyword2"><span class="keyword">imports</span></span> <a href="IMP2_Basic_Simpset.html">IMP2_Basic_Simpset</a> <a href="IMP2_Program_Analysis.html">IMP2_Program_Analysis</a> <a href="IMP2_Var_Postprocessor.html">IMP2_Var_Postprocessor</a> <a href="IMP2_Var_Abs.html">IMP2_Var_Abs</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preprocessing›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> HT'_I<span class="main">[</span><span class="operator">vcg_preprocess_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="main">(</span><span class="free">c</span> <span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT' <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> BB_PROTECT_def HT'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> HT'_partial_I<span class="main">[</span><span class="operator">vcg_preprocess_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟧</span> <span class="main">⟹</span> wlp <span class="free">π</span> <span class="main">(</span><span class="free">c</span> <span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="bound">𝔰<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT'_partial <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> BB_PROTECT_def HT'_partial_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">vcg_preprocess_rules</span><span class="main">]</span> <span class="main">=</span> allI impI conjI
    
  <span class="keyword1"><span class="command">method</span></span> i_vcg_preprocess <span class="main">=</span> 
    <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">vcg_preprocess_rules</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹VC rules›</span></span>


  <span class="keyword1"><span class="command">named_theorems</span></span> vcg_comb_rules <span class="quoted">‹VCG rules for Combinators›</span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Goal Indication›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A marker to indicate where a goal comes from.›</span></span>
  <span class="comment1">(* TODO: Noschinski has driven this to the extreme, allowing to generate a 
    complete isar case setup from such annotations. 
    We should adapt (at least parts of) this idea!
  *)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">GOAL_INDICATION</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">¶</span>_"</span> <span class="main">[</span>1000<span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">GOAL_INDICATION</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">≡</span> True"</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> move_goal_indication_to_front<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"NO_MATCH <span class="main">(</span><span class="main">¶</span><span class="free">x</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span><span class="main">⟹</span><span class="main">¶</span><span class="free">n</span><span class="main">⟹</span><span class="keyword1">PROP</span> <span class="free">Q</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">¶</span><span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟹</span> <span class="keyword1">PROP</span> <span class="free">Q</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> swap_prems_eq<span class="main">)</span>
    <span class="comment1">(* TODO: Would like to use PROP P here, to also move over 
      meta-premises like ‹⋀x. a⟹b›, but ‹NO_MATCH› requires type! *)</span>
  
  
  
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Modularity (Frame) Rules›</span></span>  
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Frame rules are only applied if their first assumption can be 
    discharged by a specification rule.›</span></span>
  <span class="keyword1"><span class="command">named_theorems</span></span> vcg_frame_rules <span class="quoted">‹Frame rules for VCG Approximation Phase›</span>

    
  <span class="keyword1"><span class="command">lemma</span></span> vcg_wlp_modularity_rl<span class="main">[</span><span class="operator">vcg_frame_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_partial_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span>modifies <span class="free">mods</span> <span class="bound">s'</span> <span class="free">s</span><span class="main">;</span> <span class="free">Q</span> <span class="free">s</span> <span class="bound">s'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">Q'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vcg_wlp_conseq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> vcg_wp_modularity_rl<span class="main">[</span><span class="operator">vcg_frame_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span>modifies <span class="free">mods</span> <span class="bound">s'</span> <span class="free">s</span> <span class="main">;</span> <span class="free">Q</span> <span class="free">s</span> <span class="bound">s'</span><span class="main">⟧</span> <span class="main">⟹</span><span class="free">Q'</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">Q'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vcg_wp_conseq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> vcg_wp_wlp_modularity_rl<span class="main">[</span><span class="operator">vcg_frame_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span>modifies <span class="free">mods</span> <span class="bound">s'</span> <span class="free">s</span><span class="main">;</span> <span class="free">Q</span> <span class="free">s</span> <span class="bound">s'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">Q'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vcg_wlp_wp_conseq assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> Params_def Inline_def
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Skip and Sequential Composition›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Skip and sequential composition are unfolded by the VCG basic simpset›</span></span>
        
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> 
    wp_skip_eq wp_seq_eq wlp_skip_eq wlp_seq_eq
    
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Assignments›</span></span>  

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Assignments are unfolded, using the UPD_STATE constants with a custom simpset 
    to efficiently handle state updates.
  ›</span></span>
  
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> 
    aval.simps bval.simps
  
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">UPD_STATE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> vname <span class="main">⇒</span> val <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">UPD_STATE</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">UPD_IDX</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> int <span class="main">⇒</span> pval <span class="main">⇒</span> val"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">UPD_IDX</span> <span class="free"><span class="bound"><span class="entity">av</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">pv</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">av</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">pv</span></span></span><span class="main">)</span>"</span></span>
        
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">UPD_STATE_IDX</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> vname <span class="main">⇒</span> int <span class="main">⇒</span> pval <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">UPD_STATE_IDX</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">:=</span>UPD_IDX <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
    

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"UPD_STATE <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">v</span> <span class="main">=</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span> <span class="main">⟹</span> UPD_STATE <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span>UPD_STATE <span class="free">s</span> <span class="free">y</span> <span class="free">v</span><span class="main">)</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">w</span><span class="main">)</span>"</span></span>  
    <span class="quoted"><span class="quoted">"NO_MATCH <span class="main">(</span><span class="free">SS</span><span class="main">(</span><span class="free">XX</span><span class="main">:=</span><span class="free">VV</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> UPD_STATE <span class="free">s</span> <span class="free">x</span> <span class="free">v</span> <span class="main">=</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UPD_STATE_def<span class="main">)</span>
        
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"UPD_STATE_IDX <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">i</span> <span class="free">v</span> <span class="main">=</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span>UPD_IDX <span class="free">w</span> <span class="free">i</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span> <span class="main">⟹</span> UPD_STATE_IDX <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span> <span class="free">i</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span>UPD_STATE_IDX <span class="free">s</span> <span class="free">y</span> <span class="free">i</span> <span class="free">v</span><span class="main">)</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">w</span><span class="main">)</span>"</span></span>  
    <span class="quoted"><span class="quoted">"NO_MATCH <span class="main">(</span><span class="free">SS</span><span class="main">(</span><span class="free">XX</span><span class="main">:=</span><span class="free">VV</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> UPD_STATE_IDX <span class="free">s</span> <span class="free">x</span> <span class="free">i</span> <span class="free">v</span> <span class="main">=</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span>UPD_IDX <span class="main">(</span><span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="free">i</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UPD_STATE_IDX_def<span class="main">)</span>
 
  <span class="comment1">(* Note (hack): These two rewrite rules exploit inner-to-outer rewrite order
    to ensure that the first rule is applied first.
  *)</span>  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>  
    <span class="quoted"><span class="quoted">"UPD_IDX <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> UPD_IDX <span class="free">a</span> <span class="free">i</span>"</span></span>
    <span class="quoted"><span class="quoted">"UPD_IDX <span class="free">a</span> <span class="free">i</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>          
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> UPD_IDX_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> vcg_assign_idx_unfolds<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">::=</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span>UPD_STATE_IDX <span class="free">s</span> <span class="free">x</span> <span class="main">(</span>aval <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>aval <span class="free">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">::=</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span>UPD_STATE_IDX <span class="free">s</span> <span class="free">x</span> <span class="main">(</span>aval <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>aval <span class="free">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> UPD_STATE_IDX_def UPD_IDX_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wlp_eq wp_eq<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> vcg_arraycpy_unfolds<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="free">x</span><span class="main">[]</span> <span class="main">::=</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span>UPD_STATE <span class="free">s</span> <span class="free">x</span> <span class="main">(</span><span class="free">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="free">x</span><span class="main">[]</span> <span class="main">::=</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span>UPD_STATE <span class="free">s</span> <span class="free">x</span> <span class="main">(</span><span class="free">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> UPD_STATE_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wlp_eq wp_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> vcg_arrayinit_unfolds<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free">x</span><span class="main">[]</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span>UPD_STATE <span class="free">s</span> <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">CLEAR</span> <span class="free">x</span><span class="main">[]</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span>UPD_STATE <span class="free">s</span> <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> UPD_STATE_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wlp_eq wp_eq<span class="main">)</span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Special case for procedure return value: 
    Insert a renaming to keep name of original variable›</span></span>  

    
  <span class="keyword1"><span class="command">lemma</span></span> vcg_AssignIdx_retv_wlp_unfold<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span>AssignIdx_retv <span class="free">x</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>NAMING_HINT <span class="free">s</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟶</span> wlp <span class="free">π</span> <span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">::=</span>V <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> AssignIdx_retv_def NAMING_HINT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> vcg_AssignIdx_retv_wp_unfold<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span>AssignIdx_retv <span class="free">x</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>NAMING_HINT <span class="free">s</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟶</span> wp <span class="free">π</span> <span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">::=</span>V <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> AssignIdx_retv_def NAMING_HINT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> vcg_ArrayCpy_retv_wlp_unfold<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span>ArrayCpy_retv <span class="free">x</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>NAMING_HINT <span class="free">s</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟶</span> wlp <span class="free">π</span> <span class="main">(</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">unfolding</span></span> ArrayCpy_retv_def NAMING_HINT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> vcg_ArrayCpy_retv_wp_unfold<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span>ArrayCpy_retv <span class="free">x</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span>NAMING_HINT <span class="free">s</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟶</span> wp <span class="free">π</span> <span class="main">(</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">a</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command">unfolding</span></span> ArrayCpy_retv_def NAMING_HINT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> naming_hint_impI_simp<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"Trueprop <span class="main">(</span>NAMING_HINT <span class="free">s</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟶</span> <span class="free">P</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span>NAMING_HINT <span class="free">s</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Scope›</span></span>    
    
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> 
    wp_scope_eq wlp_scope_eq


  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹While›</span></span>  
        
  <span class="keyword1"><span class="command">lemma</span></span> wlp_whileI_modset<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="free">π</span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">modset</span> <span class="main">≡</span> ANALYZE <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FINAL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span>bval <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wlp_whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> INIT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wlp_conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wlp_strengthen_modset<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> STEP<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> modifies_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_sym<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> FINAL <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> modifies_sym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> wp_whileI_modset<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="free">π</span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">modset</span> <span class="main">≡</span> ANALYZE <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> WF<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> INIT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> FINAL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span>bval <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wp_whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">∧</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">R</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> WF<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> INIT <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wp_conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wp_strengthen_modset<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> STEP<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> modifies_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_sym<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> FINAL <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> modifies_sym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">invar_var_goal</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">invar_var_goal</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> invar_var_goalI<span class="main">[</span><span class="operator">vcg_comb_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"invar_var_goal <span class="free">I</span> <span class="free">R</span> <span class="free">v</span> <span class="free">s</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¶</span><span class="inner_quoted">''Invar pres''</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¶</span><span class="inner_quoted">''Var pres''</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span> <span class="free">s'</span><span class="main">,</span><span class="free">v</span> <span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> invar_var_goal_def GOAL_INDICATION_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
        
  <span class="keyword1"><span class="command">lemma</span></span> wp_while_rl<span class="main">[</span><span class="operator">vcg_comb_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¶</span><span class="inner_quoted">''rel-wf''</span> <span class="main">⟹</span> wf <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¶</span><span class="inner_quoted">''invar-initial''</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> wp <span class="free">π</span> <span class="free">c</span> <span class="main">(</span>invar_var_goal <span class="free">I</span> <span class="free">R</span> <span class="free">v</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">¶</span><span class="inner_quoted">''invar-post''</span><span class="main">;</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span>bval <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">modset</span> <span class="main">=</span> ANALYZE <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span>WHILE_annotRVI <span class="free">R</span> <span class="free">v</span> <span class="free">I</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wp_whileI_modset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inv_image <span class="free">R</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">,</span> <span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILE_annotRVI_def GOAL_INDICATION_def invar_var_goal_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> wp_while_rl_dfltR<span class="main">[</span><span class="operator">vcg_comb_rules</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span>WHILE_annotRVI <span class="main">(</span>measure nat<span class="main">)</span> <span class="free">v</span> <span class="free">I</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="main">(</span>WHILE_annotVI <span class="free">v</span> <span class="free">I</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILE_annotRVI_def WHILE_annotVI_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    

  <span class="keyword1"><span class="command">lemma</span></span> wlp_while_rl<span class="main">[</span><span class="operator">vcg_comb_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¶</span><span class="inner_quoted">''invar-initial''</span> <span class="main">⟹</span> <span class="free">I</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">¶</span><span class="inner_quoted">''invar-pres''</span><span class="main">;</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> wlp <span class="free">π</span> <span class="free">c</span> <span class="free">I</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">¶</span><span class="inner_quoted">''invar-post''</span><span class="main">;</span> modifies <span class="free">modset</span> <span class="bound">s</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="main">¬</span>bval <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">modset</span> <span class="main">=</span> ANALYZE <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span>WHILE_annotI <span class="free">I</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wlp_whileI_modset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">,</span> <span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> WHILE_annotI_def GOAL_INDICATION_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> wlp_if_rl<span class="main">[</span><span class="operator">vcg_comb_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¶</span><span class="inner_quoted">''then''</span><span class="main">;</span> bval <span class="free">b</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wlp <span class="free">π</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¶</span><span class="inner_quoted">''else''</span><span class="main">;</span> <span class="main">¬</span>bval <span class="free">b</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wlp <span class="free">π</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">π</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> GOAL_INDICATION_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wlp_if_eq<span class="main">)</span>
        
  <span class="keyword1"><span class="command">lemma</span></span> wp_if_rl<span class="main">[</span><span class="operator">vcg_comb_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¶</span><span class="inner_quoted">''then''</span><span class="main">;</span> bval <span class="free">b</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¶</span><span class="inner_quoted">''else''</span><span class="main">;</span> <span class="main">¬</span>bval <span class="free">b</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">π</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> GOAL_INDICATION_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wp_if_eq<span class="main">)</span>

    
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹VCG Methods›</span></span>  
      
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Generation›</span></span>
  
  <span class="keyword1"><span class="command">method</span></span> i_vcg_step <span class="main">=</span> 
    <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">vcg_comb_rules</span></span><span class="main">)</span>
  <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">vcg_frame_rules</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">vcg_specs</span></span><span class="main">)</span><span class="main">)</span>
  <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">named_ss</span> vcg_bb<span class="main"><span class="main">:</span></span> <span class="main">)</span>
    
  <span class="keyword1"><span class="command">method</span></span> i_vcg_gen <span class="main">=</span> <span class="main">(</span><span class="operator">i_vcg_step</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">i_vcg_gen</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>  
    
  <span class="keyword1"><span class="command">method</span></span> i_vcg_rem_annot <span class="main">=</span> <span class="operator">simp</span> <span class="quasi_keyword">named_ss</span> vcg_bb<span class="main"><span class="main">:</span></span> ANNOTATION_def
  

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Postprocessing›</span></span>
  
  <span class="keyword1"><span class="command">method</span></span> i_vcg_remove_hints <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="operator">determ</span> <span class="quoted">‹<span class="operator">thin_tac</span> "modifies _ _ _"›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">i_vcg_remove_renamings_tac</span>
    
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Postprocessing exposes user annotations completely, and then abstracts over variable names.›</span></span>
  <span class="keyword1"><span class="command">method</span></span> i_vcg_postprocess <span class="main">=</span>
    <span class="operator">i_vcg_modifies_simp</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span>
    <span class="operator">i_vcg_apply_renamings_tac</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span>
    <span class="operator">i_vcg_remove_hints</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span>
    <span class="main">(</span><span class="operator">unfold</span> BB_PROTECT_def VAR_def<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span>
    <span class="operator">i_vcg_postprocess_vars</span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Main Method›</span></span>    
    
  <span class="keyword1"><span class="command">method</span></span> vcg <span class="main">=</span> 
    <span class="operator">i_vcg_preprocess</span><span class="main"><span class="keyword3">;</span></span> 
    <span class="operator">i_vcg_gen</span><span class="main"><span class="keyword3">;</span></span> 
    <span class="operator">i_vcg_rem_annot</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> 
    <span class="operator">i_vcg_postprocess</span>
    
  <span class="keyword1"><span class="command">method</span></span> vcg_cs <span class="main">=</span> <span class="operator">vcg</span><span class="main"><span class="keyword3">;</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2_Specification">
<div class="head">
<h1>Theory IMP2_Specification</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Specification Commands›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IMP2_Specification 
<span class="keyword2"><span class="keyword">imports</span></span> <a href="IMP2_Basic_Simpset.html">IMP2_Basic_Simpset</a> <a href="IMP2_Program_Analysis.html">IMP2_Program_Analysis</a> <a href="IMP2_Var_Postprocessor.html">IMP2_Var_Postprocessor</a> <a href="IMP2_Var_Abs.html">IMP2_Var_Abs</a>
<span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"ensures"</span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"returns"</span> <span class="quoted">"variant"</span> <span class="quoted">"relation"</span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"program_spec"</span> <span class="main">::</span> thy_goal
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"procedure_spec"</span> <span class="main">::</span> thy_goal
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"recursive_spec"</span> <span class="main">::</span> thy_goal
<span class="keyword2"><span class="keyword">begin</span></span>

  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstraction over Program Variables›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb <span class="quasi_keyword">cong</span><span class="main">]</span> <span class="main">=</span> refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ANNOTATION <span class="main">_</span>"</span></span><span class="main">]</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹ <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">IMP_Annotations</span> 
  <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_annotations</span> <span class="entity">ctxt</span> <span class="main">=</span> 
      Local_Defs.unfold <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> vcg_annotation_defs<span class="antiquote">}</span></span><span class="main">)</span>
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_annotations_term</span> <span class="entity">ctxt</span> <span class="main">=</span> 
      Thm.cterm_of <span class="entity">ctxt</span> #&gt; Drule.mk_term #&gt; 
      <span class="entity">strip_annotations</span> <span class="entity">ctxt</span> #&gt;
      Drule.dest_term #&gt; Thm.term_of

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_ANNOTATION</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">T</span><span class="main">=</span>fastype_of <span class="entity">t</span> <span class="keyword2"><span class="keyword">in</span></span> 
      Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> ANNOTATION<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">T</span> --&gt; <span class="entity">T</span><span class="main">)</span>$<span class="entity">t</span> <span class="keyword2"><span class="keyword">end</span></span> 
      
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_ANNOTATION</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> ANNOTATION<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span>$<span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">dest_ANNOTATION</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM<span class="main">(</span><span class="inner_quoted">"dest_ANNOTATION"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
      
    
    <span class="comment1">(* Provides a context for reading the term, and a postprocessing function *)</span>
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">term_annot_reader</span> <span class="main">=</span> <span class="entity">Proof.context</span> * <span class="main">(</span>term <span class="main">-&gt;</span> term<span class="main">)</span>  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_read_ta</span> <span class="entity">rd</span> <span class="main">(</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">post</span><span class="main">)</span><span class="main">:</span><span class="entity">term_annot_reader</span><span class="main">)</span> <span class="entity">src</span> <span class="main">=</span> <span class="entity">rd</span> <span class="entity">ctxt</span> <span class="entity">src</span> |&gt; <span class="entity">mk_BB_PROTECT</span> |&gt; <span class="entity">post</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read_ta_from_cartouche</span> <span class="main">=</span> <span class="entity">gen_read_ta</span> <span class="entity">Term_Annot.read_term</span>

    <span class="comment1">(* Annotations *)</span>
    
    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">cmd_annotation_readers</span> <span class="main">=</span> <span class="main">{</span>
      rel_rd <span class="main">:</span> <span class="entity">term_annot_reader</span><span class="main">,</span>
      variant_rd <span class="main">:</span> <span class="entity">term_annot_reader</span><span class="main">,</span>
      invar_rd <span class="main">:</span> <span class="entity">term_annot_reader</span><span class="main">,</span>
      com_post<span class="main">:</span> term <span class="main">-&gt;</span> term
    <span class="main">}</span>
    
          
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_interpret_annotations</span> <span class="main">(</span><span class="entity">annot_readers</span> <span class="main">:</span> <span class="entity">cmd_annotation_readers</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">prog_t</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    
      <span class="comment1">(* TODO/FIXME: Terms are read independently, which will cause too generic types to be inferred *)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read_invar</span> <span class="main">=</span> <span class="entity">read_ta_from_cartouche</span> <span class="main">(</span><span class="main">#</span>invar_rd <span class="entity">annot_readers</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read_variant</span> <span class="main">=</span> <span class="entity">read_ta_from_cartouche</span> <span class="main">(</span><span class="main">#</span>variant_rd <span class="entity">annot_readers</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">read_rel</span> <span class="main">=</span> <span class="entity">read_ta_from_cartouche</span> <span class="main">(</span><span class="main">#</span>rel_rd <span class="entity">annot_readers</span><span class="main">)</span>
          
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mpt</span> <span class="main">=</span> map_types <span class="main">(</span>map_type_tfree <span class="main">(</span>K dummyT<span class="main">)</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">interp_while_annot</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_invariant_annotation"<span class="antiquote">}</span></span><span class="main">)</span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">V</span><span class="main">,</span><span class="entity">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">V</span><span class="main">,</span><span class="entity">read_invar</span> <span class="entity">t</span> :: <span class="entity">I</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">interp_while_annot</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_variant_annotation"<span class="antiquote">}</span></span><span class="main">)</span>   <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">V</span><span class="main">,</span><span class="entity">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">read_variant</span> <span class="entity">t</span> :: <span class="entity">V</span><span class="main">,</span><span class="entity">I</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">interp_while_annot</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_relation_annotation"<span class="antiquote">}</span></span><span class="main">)</span>  <span class="main">(</span><span class="entity">R</span><span class="main">,</span><span class="entity">V</span><span class="main">,</span><span class="entity">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">read_rel</span> <span class="entity">t</span> :: <span class="entity">R</span><span class="main">,</span><span class="entity">V</span><span class="main">,</span><span class="entity">I</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">interp_while_annot</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">ty</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> error <span class="main">(</span><span class="inner_quoted">"Unknown annotation type for while loop: "</span> ^ <span class="entity">ty</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">interp_while_annots</span> <span class="entity">annots</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">annots</span> <span class="main">=</span> <span class="entity">HOLogic.strip_tuple</span> <span class="entity">annots</span>
          |&gt; map <span class="main">(</span>apsnd <span class="main">(</span>dest_Const #&gt; fst<span class="main">)</span> o <span class="entity">Term_Annot.dest_annotated_term</span><span class="main">)</span>
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Rs</span><span class="main">,</span><span class="entity">Vs</span><span class="main">,</span><span class="entity">Is</span><span class="main">)</span> <span class="main">=</span> fold <span class="entity">interp_while_annot</span> <span class="entity">annots</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span>
         
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> length <span class="entity">Rs</span> &gt; <span class="inner_numeral">1</span> <span class="keyword1"><span class="keyword">andalso</span></span> error <span class="inner_quoted">"Multiple relation annotations to loop"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> length <span class="entity">Vs</span> &gt; <span class="inner_numeral">1</span> <span class="keyword1"><span class="keyword">andalso</span></span> error <span class="inner_quoted">"Multiple variant annotations to loop"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> length <span class="entity">Is</span> &gt; <span class="inner_numeral">1</span> <span class="keyword1"><span class="keyword">andalso</span></span> error <span class="inner_quoted">"Multiple invariants not yet supported. Combine them into one"</span>
         
        <span class="keyword2"><span class="keyword">local</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">m</span> <span class="main">=</span> map <span class="entity">mk_ANNOTATION</span> <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">Rs</span><span class="main">,</span> <span class="entity">Vs</span><span class="main">,</span> <span class="entity">Is</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">m</span> <span class="entity">Rs</span><span class="main">,</span> <span class="entity">m</span> <span class="entity">Vs</span><span class="main">,</span> <span class="entity">m</span> <span class="entity">Is</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>
        
        
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="entity">Rs</span><span class="main">,</span><span class="entity">Vs</span><span class="main">,</span><span class="entity">Is</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mpt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> While<span class="antiquote">}</span></span>
        <span class="main">|</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="entity">I</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mpt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> WHILE_annotI<span class="antiquote">}</span></span> $ <span class="entity">I</span>
        <span class="main">|</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="entity">V</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="entity">I</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mpt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> WHILE_annotVI<span class="antiquote">}</span></span> $ <span class="entity">V</span> $ <span class="entity">I</span>
        <span class="main">|</span> <span class="main">(</span><span class="main">[</span><span class="entity">R</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="entity">V</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="entity">I</span><span class="main">]</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mpt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> WHILE_annotRVI <span class="main">(</span><span class="quoted"><span class="tfree">'a</span></span><span class="main">)</span><span class="antiquote">}</span></span> $ <span class="entity">R</span> $ <span class="entity">V</span> $ <span class="entity">I</span>
        <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="inner_quoted">"Illegal combination of annotations to while loop. The legal ones are: None, I, VI, RVI"</span>
      
      <span class="keyword2"><span class="keyword">end</span></span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">interp</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_abbrev</span> While_Annot<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">annots</span><span class="main">)</span> <span class="main">=</span> <span class="entity">interp_while_annots</span> <span class="entity">annots</span>
        <span class="main">|</span> <span class="entity">interp</span> <span class="main">(</span><span class="entity">a</span>$<span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="entity">interp</span> <span class="entity">a</span> $ <span class="entity">interp</span> <span class="entity">b</span>
        <span class="main">|</span> <span class="entity">interp</span> <span class="main">(</span>Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">T</span><span class="main">,</span><span class="entity">interp</span> <span class="entity">t</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">interp</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>
    
        
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prog_t</span> <span class="main">=</span> <span class="entity">interp</span> <span class="entity">prog_t</span>

      <span class="comment1">(* All terms have been abstracted over vinfo, and over the variables of v0info. 
        Now, the whole term is valid wrt vinfo0/ctxt0, which contains declarations 
        of variables0 and state0
        *** TODO: Ideally, one would like to check teh term in a context that does not include 
              variables, but only state decl!
      *)</span>      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prog_t</span> <span class="main">=</span> Syntax.check_term <span class="entity">ctxt</span> <span class="entity">prog_t</span>
      
            
      <span class="comment1">(* We now also abstract over state0, to make the program a function from state0 to an (annotated) command *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="main">(</span><span class="main">#</span>com_post <span class="entity">annot_readers</span><span class="main">)</span> <span class="entity">prog_t</span>

      <span class="comment1">(*
      (* Alternatively, we strip the annotations from the program. This should also remove state0! *)
      val prog_t = strip_annotations_term ctxt prog_t
      *)</span>
      
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">res</span>
    <span class="keyword2"><span class="keyword">end</span></span>


    <span class="comment1">(*
      Make a reader according to a list of program variable abstractions.
      Each list item has the form (vars,sfx,full), where vars is a list of IMP variables,
      sfx is a suffix to be appended to the Isabelle variables, and full indicates whether the
      abstraction over the state should be done immediately, or delayed.
      
      The result is a reader, and a second term transformation to do the delayed abstractions.
    *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_mk_reader</span> <span class="entity">rds</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span> I<span class="main">)</span><span class="main">,</span> I<span class="main">)</span>
        <span class="main">|</span> <span class="entity">mk</span> <span class="main">(</span><span class="main">(</span><span class="entity">vars</span><span class="main">,</span><span class="entity">sfx</span><span class="main">,</span><span class="entity">full</span><span class="main">)</span>::<span class="entity">rds</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> <span class="entity">IMP_Parser.merge_variables</span> <span class="entity">vars</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">vinfo</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Program_Variables.declare_variables</span> <span class="entity">vars</span> <span class="entity">sfx</span> <span class="entity">ctxt</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">pps1</span><span class="main">)</span><span class="main">,</span><span class="entity">pps2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">mk</span> <span class="entity">rds</span> <span class="entity">ctxt</span>
                        
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">absv</span> <span class="main">=</span> <span class="entity">Program_Variables.abstract_vars</span> <span class="entity">vinfo</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">abss</span> <span class="main">=</span> <span class="entity">Program_Variables.abstract_state</span> <span class="entity">vinfo</span>
            
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">pps1</span><span class="main">,</span><span class="entity">pps2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">full</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="entity">absv</span> #&gt; <span class="entity">pps1</span> #&gt; <span class="entity">abss</span><span class="main">,</span><span class="entity">pps2</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">absv</span> #&gt; <span class="entity">pps1</span><span class="main">,</span> <span class="entity">pps2</span> #&gt; <span class="entity">abss</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">(</span><span class="main">(</span><span class="entity">ctxt</span><span class="main">,</span><span class="entity">pps1</span><span class="main">)</span><span class="main">,</span><span class="entity">pps2</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
          
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">mk</span> <span class="entity">rds</span> <span class="entity">ctxt</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">rd_config</span> <span class="main">=</span> <span class="main">{</span>
      add_vars  <span class="main">:</span> <span class="entity">IMP_Syntax.impvar</span> list<span class="main">,</span>           <span class="comment1">(* Additional variable declarations *)</span>
      in_vars   <span class="main">:</span> string list option<span class="main">,</span>               <span class="comment1">(* Input variables: Default all vars *)</span>
      out_vars  <span class="main">:</span> string list option<span class="main">,</span>               <span class="comment1">(* Output variables: Default all vars *)</span>
      prog_vars <span class="main">:</span> <span class="entity">IMP_Syntax.impvar</span> list            <span class="comment1">(* Variables in program *)</span>
    <span class="main">}</span>
    
        
    <span class="keyword2"><span class="keyword">local</span></span>  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vars_dflt</span> <span class="main">(</span><span class="entity">cfg</span><span class="main">:</span><span class="entity">rd_config</span><span class="main">)</span> NONE <span class="main">=</span> <span class="main">(</span><span class="main">#</span>prog_vars <span class="entity">cfg</span><span class="main">)</span> @ <span class="main">(</span><span class="main">#</span>add_vars <span class="entity">cfg</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">vars_dflt</span> <span class="main">(</span><span class="entity">cfg</span><span class="main">:</span><span class="entity">rd_config</span><span class="main">)</span> <span class="main">(</span>SOME <span class="entity">vs</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">gvs</span><span class="main">,</span><span class="entity">lvs</span><span class="main">)</span> <span class="main">=</span> List.partition <span class="main">(</span><span class="entity">IMP_Syntax.is_global</span><span class="main">)</span> <span class="entity">vs</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">gvs</span> &lt;&gt; <span class="main">[</span><span class="main">]</span> <span class="keyword2"><span class="keyword">then</span></span> 
              Pretty.block <span class="main">[</span>Pretty.str <span class="inner_quoted">"Ignoring global parameter/return variables: "</span><span class="main">,</span>
                            Pretty.list <span class="inner_quoted">""</span> <span class="inner_quoted">""</span> <span class="main">(</span>map <span class="main">(</span>Pretty.str<span class="main">)</span> <span class="entity">gvs</span><span class="main">)</span><span class="main">]</span>
              |&gt; Pretty.string_of |&gt; warning             
            <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> 
        
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="main">(</span>filter <span class="main">(</span>fst #&gt; member <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">lvs</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>prog_vars <span class="entity">cfg</span> @ <span class="main">#</span>add_vars <span class="entity">cfg</span> <span class="main">)</span><span class="main">)</span>
          @ <span class="main">(</span>filter <span class="main">(</span>fst #&gt; <span class="entity">IMP_Syntax.is_global</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>add_vars <span class="entity">cfg</span><span class="main">)</span><span class="main">)</span>  
          <span class="keyword2"><span class="keyword">end</span></span>
       
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cfg_in_vars</span> <span class="entity">cfg</span> <span class="main">=</span> <span class="entity">vars_dflt</span> <span class="entity">cfg</span> <span class="main">(</span><span class="main">#</span>in_vars <span class="entity">cfg</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cfg_out_vars</span> <span class="entity">cfg</span> <span class="main">=</span> <span class="entity">vars_dflt</span> <span class="entity">cfg</span> <span class="main">(</span><span class="main">#</span>out_vars <span class="entity">cfg</span><span class="main">)</span>
        
    <span class="keyword2"><span class="keyword">in</span></span>        
      <span class="comment1">(* Standard annotation readers *)</span>
      
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_annot_readers</span> <span class="main">(</span><span class="entity">cfg</span><span class="main">:</span><span class="entity">rd_config</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">in_vars</span> <span class="main">=</span> <span class="entity">cfg_in_vars</span> <span class="entity">cfg</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prog_vars</span> <span class="main">=</span> <span class="main">(</span><span class="main">#</span>prog_vars <span class="entity">cfg</span><span class="main">)</span> @ <span class="main">(</span><span class="main">#</span>add_vars <span class="entity">cfg</span><span class="main">)</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">rel_rd</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">gen_mk_reader</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">annot_rd</span><span class="main">,</span><span class="entity">post</span><span class="main">)</span> <span class="main">=</span> <span class="entity">gen_mk_reader</span> <span class="main">[</span><span class="main">(</span><span class="entity">in_vars</span><span class="main">,</span><span class="inner_quoted">"<span class="hidden">⇩</span><sub>0</sub>"</span><span class="main">,</span>false<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">prog_vars</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span>true<span class="main">)</span><span class="main">]</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span> 
        <span class="main">{</span> 
          rel_rd <span class="main">=</span> <span class="entity">rel_rd</span><span class="main">,</span>
          variant_rd <span class="main">=</span> <span class="entity">annot_rd</span><span class="main">,</span>
          invar_rd <span class="main">=</span> <span class="entity">annot_rd</span><span class="main">,</span>
          com_post <span class="main">=</span> <span class="entity">post</span>
        <span class="main">}</span>
      <span class="keyword2"><span class="keyword">end</span></span>
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_pre_reader</span> <span class="entity">cfg</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">gen_mk_reader</span> <span class="main">[</span><span class="main">(</span><span class="entity">cfg_in_vars</span> <span class="entity">cfg</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span>true<span class="main">)</span><span class="main">]</span> <span class="entity">ctxt</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span>
        
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_post_reader</span> <span class="entity">cfg</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">in_vars</span> <span class="main">=</span> <span class="entity">cfg_in_vars</span> <span class="entity">cfg</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">out_vars</span> <span class="main">=</span> <span class="entity">cfg_out_vars</span> <span class="entity">cfg</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">gen_mk_reader</span> <span class="main">[</span><span class="main">(</span><span class="entity">in_vars</span><span class="main">,</span><span class="inner_quoted">"<span class="hidden">⇩</span><sub>0</sub>"</span><span class="main">,</span>true<span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="entity">out_vars</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span>true<span class="main">)</span><span class="main">]</span> <span class="entity">ctxt</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span>
      <span class="keyword2"><span class="keyword">end</span></span>  
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_variant_reader</span> <span class="entity">cfg</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">in_vars</span> <span class="main">=</span> <span class="entity">cfg_in_vars</span> <span class="entity">cfg</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">gen_mk_reader</span> <span class="main">[</span><span class="main">(</span><span class="entity">in_vars</span><span class="main">,</span><span class="inner_quoted">""</span><span class="main">,</span>true<span class="main">)</span><span class="main">]</span> <span class="entity">ctxt</span> |&gt; <span class="main">#</span><span class="inner_numeral">1</span>
      <span class="keyword2"><span class="keyword">end</span></span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_program</span> <span class="entity">cfg</span> <span class="entity">ctxt</span> <span class="entity">prog_t</span> <span class="main">=</span> 
        <span class="entity">gen_interpret_annotations</span> <span class="main">(</span><span class="entity">mk_annot_readers</span> <span class="entity">cfg</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">prog_t</span>
  
      
    <span class="keyword2"><span class="keyword">end</span></span>            
    
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hoare Triple Syntax›</span></span>
  
<span class="comment1">(* In-Term notation for Hoare Triples*)</span>   
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_Htriple"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cartouche_position <span class="main">⇒</span> cartouche_position <span class="main">⇒</span> cartouche_position <span class="main">⇒</span> logic"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">htriple</span><span class="hidden">&gt;</span></span>_ _ _"</span><span class="main">)</span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_Htriple_Partial"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cartouche_position <span class="main">⇒</span> cartouche_position <span class="main">⇒</span> cartouche_position <span class="main">⇒</span> logic"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">\&lt;^</span><span class="control">htriple_partial</span><span class="hidden">&gt;</span></span>_ _ _"</span><span class="main">)</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹ <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">VCG_Htriple_Syntax</span> 
  <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_htriple'</span> <span class="entity">total</span> <span class="entity">env</span> <span class="main">(</span><span class="entity">pre</span><span class="main">,</span><span class="entity">prog_t</span><span class="main">,</span><span class="entity">post</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>    
      <span class="comment1">(* Assemble Hoare-triple *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">HT_const</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">total</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> HT'<span class="antiquote">}</span></span> <span class="keyword2"><span class="keyword">else</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> HT'_partial<span class="antiquote">}</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">HT_const</span>$ <span class="entity">env</span> $<span class="entity">pre</span>$<span class="entity">prog_t</span>$<span class="entity">post</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">res</span>
    <span class="keyword2"><span class="keyword">end</span></span>
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decon_cartouche_ast</span> <span class="main">(</span><span class="main">(</span><span class="entity">c</span> <span class="keyword1"><span class="keyword">as</span></span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_constrain"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ Free <span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword2"><span class="keyword">case</span></span> Term_Position.decode_position <span class="entity">p</span> <span class="keyword2"><span class="keyword">of</span></span> 
        SOME <span class="main">(</span><span class="entity">pos</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span><span class="entity">pos</span><span class="main">)</span> <span class="comment1">(*, fn t =&gt; c$t$p*)</span><span class="main">)</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"cartouche with invalid pos"</span><span class="main">,</span><span class="main">[</span><span class="entity">c</span><span class="main">,</span><span class="entity">p</span><span class="main">]</span><span class="main">)</span>  
    <span class="main">)</span>
    <span class="main">|</span> <span class="entity">decon_cartouche_ast</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"decon_cartouche_ast"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>  
        
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">htriple_tr</span> <span class="entity">total</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">tpre</span><span class="main">,</span> <span class="entity">prog_t</span><span class="main">,</span> <span class="entity">tpost</span><span class="main">]</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword3"><span class="keyword">open</span></span> IMP_Annotations
    
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">vars</span><span class="main">,</span><span class="entity">prog_t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">decon_cartouche_ast</span> <span class="entity">prog_t</span> |&gt; <span class="entity">IMP_Parser.parse_command_at</span> <span class="entity">ctxt</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg</span> <span class="main">=</span> <span class="main">{</span> add_vars <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">,</span> in_vars<span class="main">=</span>NONE<span class="main">,</span> out_vars<span class="main">=</span>NONE<span class="main">,</span> prog_vars<span class="main">=</span><span class="entity">vars</span> <span class="main">}</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prog_t</span> <span class="main">=</span> <span class="entity">read_program</span> <span class="entity">cfg</span> <span class="entity">ctxt</span> <span class="entity">prog_t</span>
        
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tpre</span> <span class="main">=</span> <span class="entity">decon_cartouche_ast</span> <span class="entity">tpre</span> 
        |&gt; <span class="entity">read_ta_from_cartouche</span> <span class="main">(</span><span class="entity">mk_pre_reader</span> <span class="entity">cfg</span> <span class="entity">ctxt</span><span class="main">)</span>
        
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tpost</span> <span class="main">=</span> <span class="entity">decon_cartouche_ast</span> <span class="entity">tpost</span>
        |&gt; <span class="entity">read_ta_from_cartouche</span> <span class="main">(</span><span class="entity">mk_post_reader</span> <span class="entity">cfg</span> <span class="entity">ctxt</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">mk_htriple'</span> <span class="entity">total</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Map.empty <span class="main">::</span> program"</span><span class="antiquote">}</span></span> <span class="main">(</span><span class="entity">tpre</span><span class="main">,</span><span class="entity">prog_t</span><span class="main">,</span><span class="entity">tpost</span><span class="main">)</span>  
              
    <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="entity">IMP_Parser.mark_term</span> <span class="entity">res</span> |&gt; <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">print</span><span class="antiquote">}</span></span></span></span></span></span></span></span>
    <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">|</span> <span class="entity">htriple_tr</span> <span class="main">_</span> <span class="main">_</span> <span class="entity">args</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"htriple_tr"</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span>
      
    
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>
  
<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹<span class="main">[</span>
  <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_Htriple"<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">VCG_Htriple_Syntax.htriple_tr</span> true<span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_Htriple_Partial"<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">VCG_Htriple_Syntax.htriple_tr</span> false<span class="main">)</span>
  <span class="main">]</span>
›</span>
   
<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">htriple_partial</span><span class="hidden">&gt;</span></span> <span class="inner_cartouche"><span class="quoted">‹undefined <span class="skolem">x</span> <span class="main">::</span> bool›</span></span> <span class="inner_cartouche">‹<span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">=</span><span class="main">1</span><span class="main">+</span>undefined<span class="main">+</span><span class="skolem">n</span><span class="main">+</span><span class="free">foo</span>›</span></span> n <span class="main"><span class="main">=</span></span> n <span class="main"><span class="main">-</span></span> 1<span class="main"><span class="main">;</span></span> x<span class="main"><span class="main">=</span></span>x<span class="main"><span class="main">+</span></span>1›</span> <span class="inner_cartouche"><span class="quoted">‹True›</span></span>›</span></span> 

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">htriple_partial</span><span class="hidden">&gt;</span></span> <span class="inner_cartouche"><span class="quoted">‹<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span><span class="main">+</span><span class="skolem">x</span><span class="main">+</span><span class="free">notex</span>›</span></span> <span class="inner_cartouche">‹<span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> n <span class="main"><span class="main">=</span></span> n <span class="main"><span class="main">-</span></span> 1<span class="main"><span class="main">;</span></span> x<span class="main"><span class="main">=</span></span>x<span class="main"><span class="main">+</span></span>1›</span> <span class="inner_cartouche"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">=</span><span class="main">1</span><span class="main">+</span><span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>›</span></span> 
<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">htriple</span><span class="hidden">&gt;</span></span> <span class="inner_cartouche"><span class="quoted">‹<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span><span class="main">+</span><span class="skolem">x</span><span class="main">+</span><span class="free">notex</span>›</span></span> <span class="inner_cartouche">‹<span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> n <span class="main"><span class="main">=</span></span> n <span class="main"><span class="main">-</span></span> 1<span class="main"><span class="main">;</span></span> x<span class="main"><span class="main">=</span></span>x<span class="main"><span class="main">+</span></span>1›</span> <span class="inner_cartouche"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">=</span><span class="main">1</span><span class="main">+</span><span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Postprocessing of Proved Specifications›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Modified Sets›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> HT_to_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span> <span class="main">=</span> HT_mods <span class="free">π</span> <span class="main">(</span>ANALYZE <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HT_mods_def BB_PROTECT_def HT_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wp_strengthen_modset wp_conseq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HT_partial_to_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span> <span class="main">=</span> HT_partial_mods <span class="free">π</span> <span class="main">(</span>ANALYZE <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HT_partial_mods_def BB_PROTECT_def HT_partial_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wlp_strengthen_modset wlp_conseq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_lhsv_thm<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> <span class="free">cmd</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lhsv <span class="free">π</span> <span class="free">c</span> <span class="main">=</span> ANALYZE <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">cmd</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lhsv' <span class="free">c</span> <span class="main">=</span> ANALYZE <span class="main">(</span>lhsv' <span class="free">cmd</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  
  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹ <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">IMP2_Modified_Analysis</span> 
    <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_HT_mods</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> HT_mods<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">pi</span>$<span class="entity">mods</span>$<span class="entity">P</span>$<span class="entity">c</span>$<span class="entity">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>true<span class="main">,</span><span class="entity">pi</span><span class="main">,</span><span class="entity">mods</span><span class="main">,</span><span class="entity">P</span><span class="main">,</span><span class="entity">c</span><span class="main">,</span><span class="entity">Q</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">dest_HT_mods</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> HT_partial_mods<span class="antiquote">}</span></span><span class="main">,</span><span class="main">_</span><span class="main">)</span>$<span class="entity">pi</span>$<span class="entity">mods</span>$<span class="entity">P</span>$<span class="entity">c</span>$<span class="entity">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>false<span class="main">,</span><span class="entity">pi</span><span class="main">,</span><span class="entity">mods</span><span class="main">,</span><span class="entity">P</span><span class="main">,</span><span class="entity">c</span><span class="main">,</span><span class="entity">Q</span><span class="main">)</span>
        <span class="main">|</span> <span class="entity">dest_HT_mods</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM<span class="main">(</span><span class="inner_quoted">"dest_HT_mods"</span><span class="main">,</span><span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>
          

      <span class="comment1">(* Valid modset must be set literal of string literals *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">is_valid_modset</span> <span class="main">=</span> can <span class="main">(</span><span class="entity">HOLogic.dest_set</span> #&gt; map <span class="entity">HOLogic.dest_string</span><span class="main">)</span>
        
      <span class="comment1">(* Weaker criterion for valid modset  
      val is_valid_modset = not o exists_subterm (fn @{const lhsv} =&gt; true | _ =&gt; false)
      *)</span>
      
                
         
      <span class="comment1">(* HT → HT_mods *)</span> 
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_HT_mods</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="comment1">(* Local_Defs.unfold will destroy names of bound variables here!?, so using simplify! *)</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">simplified</span> <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">simplify</span> <span class="main">(</span>Simplifier.clear_simpset <span class="entity">ctxt</span> addsimps <span class="entity">thms</span><span class="main">)</span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Named_Simpsets.put</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> vcg_bb<span class="antiquote">}</span></span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
           <span class="entity">thm</span>
        |&gt; <span class="entity">simplified</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> HT_to_mod HT_partial_to_mod<span class="antiquote">}</span></span></span>
        |&gt; <span class="entity">Simplifier.simplify</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">end</span></span>    

      
      <span class="comment1">(* c≡com → [ lhsv c = …, lshv' c = … ] *)</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_lhsv_thms</span> <span class="entity">ctxt</span> <span class="entity">def_thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Named_Simpsets.put</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> vcg_bb<span class="antiquote">}</span></span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">def_thm</span> RS <span class="entity">thm</span><span class="main">)</span> |&gt; <span class="entity">Simplifier.simplify</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> mk_lhsv_thm<span class="antiquote">}</span></span></span>
      <span class="keyword2"><span class="keyword">end</span></span>
      
    <span class="keyword2"><span class="keyword">end</span></span>
  ›</span>
  
  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Parameter Passing›</span></span>  
<span class="comment1">(* Forward assignment rule + renaming of assigned variable *)</span>  
<span class="keyword1"><span class="command">lemma</span></span> adjust_assign_after<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">vx</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="bound">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="bound">vx</span><span class="main">,</span><span class="free">y</span><span class="main">:=</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_eq<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fun_upd_triv wp_conseq<span class="main">)</span>

<span class="comment1">(* Standard backwards assignment rule *)</span>
<span class="keyword1"><span class="command">lemma</span></span> adjust_assign_before<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> HT<span class="main">:</span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="bound">s</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">y</span><span class="main">;;</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_eq<span class="main">)</span>  
  <span class="keyword1"><span class="command">using</span></span> HT_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  
<span class="comment1">(* Forward + backward assignment rules, simultaneously for all local variables! *)</span>
<span class="keyword1"><span class="command">lemma</span></span> adjust_scope<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> HT<span class="main">:</span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="bound">s</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&gt;</span><span class="main">)</span> <span class="main">(</span><span class="main">&lt;</span><span class="bound">l</span><span class="main">|</span><span class="bound">s</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HT_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_eq<span class="main">)</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> HT_def assms combine_collapse combine_nest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wp_conseq<span class="main">)</span>

  
<span class="comment1">(* Forward assignment rule + renaming of assigned variable *)</span>  
<span class="keyword1"><span class="command">lemma</span></span> adjust_assign_after_partial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">vx</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="bound">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="bound">vx</span><span class="main">,</span><span class="free">y</span><span class="main">:=</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wlp_eq<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fun_upd_triv wlp_conseq<span class="main">)</span>

<span class="comment1">(* Standard backwards assignment rule *)</span>
<span class="keyword1"><span class="command">lemma</span></span> adjust_assign_before_partial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> HT<span class="main">:</span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">s</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="bound">s</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">[]</span><span class="main">::=</span><span class="free">y</span><span class="main">;;</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wlp_eq<span class="main">)</span>  
  <span class="keyword1"><span class="command">using</span></span> HT_partial_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  
<span class="comment1">(* Forward + backward assignment rules, simultaneously for all local variables! *)</span>
<span class="keyword1"><span class="command">lemma</span></span> adjust_scope_partial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> HT<span class="main">:</span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="bound">s</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&gt;</span><span class="main">)</span> <span class="main">(</span><span class="main">&lt;</span><span class="bound">l</span><span class="main">|</span><span class="bound">s</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wlp_eq<span class="main">)</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> HT_partial_def assms combine_collapse combine_nest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wlp_conseq<span class="main">)</span>
    

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADJUST_PRE_SCOPE</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="bound">s</span><span class="main">&gt;</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADJUST_PRE_PARAM</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">s</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">:=</span><span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADJUST_POST_SCOPE</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span><span class="main">&lt;</span><span class="main">&lt;&gt;</span><span class="main">|</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&gt;</span><span class="main">)</span> <span class="main">(</span><span class="main">&lt;</span><span class="bound">l</span><span class="main">|</span><span class="bound">s</span><span class="main">&gt;</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADJUST_POST_PARAM</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">:=</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ADJUST_POST_RETV</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">vx</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="bound">s</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">:=</span><span class="bound">vx</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">:=</span><span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  
<span class="keyword1"><span class="command">lemma</span></span> HT_strengthen_modset<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span> <span class="main">∧</span> modifies <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wp_strengthen_modset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HT_partial_strengthen_modset<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_partial <span class="free">π</span> <span class="free">P</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span> <span class="main">∧</span> modifies <span class="main">(</span>lhsv <span class="free">π</span> <span class="free">c</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wlp_strengthen_modset<span class="main">)</span>
      
    
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">abs_def</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> VAR_def 
    ADJUST_PRE_SCOPE_def ADJUST_PRE_PARAM_def ADJUST_POST_SCOPE_def ADJUST_POST_PARAM_def ADJUST_POST_RETV_def
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> combine_query
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A lot of straightforward lemmas, to transfer specification of function body to function specification›</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> ADJUST_PRE_SCOPE_unfolds<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_PRE_SCOPE <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_PRE_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="free">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> VAR <span class="free">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_PRE_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> is_global <span class="free">x</span> <span class="main">⟹</span> ADJUST_PRE_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_PRE_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> is_global <span class="free">x</span> <span class="main">⟹</span> ADJUST_PRE_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_PRE_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> ADJUST_PRE_PARAM_unfolds<span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="free">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> VAR <span class="free">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">G</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="free">x</span><span class="main">≠</span><span class="free">l</span> <span class="main">⟹</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="free">x</span><span class="main">≠</span><span class="free">l</span> <span class="main">⟹</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">lemma</span></span> ADJUST_POST_SCOPE_unfolds<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_SCOPE <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> is_global <span class="free">x</span> <span class="main">⟹</span> ADJUST_POST_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> is_global <span class="free">x</span> <span class="main">⟹</span> ADJUST_POST_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> is_global <span class="free">x</span> <span class="main">⟹</span> ADJUST_POST_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> is_global <span class="free">x</span> <span class="main">⟹</span> ADJUST_POST_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_SCOPE <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> ADJUST_POST_PARAM_unfolds<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span>"</span></span> 
    
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="free">x</span><span class="main">≠</span><span class="free">l</span> <span class="main">⟹</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="free">x</span><span class="main">≠</span><span class="free">l</span> <span class="main">⟹</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
  <span class="keyword1"><span class="command">lemma</span></span> ADJUST_POST_RETV_unfolds<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">G</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span><span class="free">x</span><span class="main">≠</span><span class="free">G</span><span class="main">;</span> <span class="free">x</span><span class="main">≠</span><span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span><span class="free">x</span><span class="main">≠</span><span class="free">G</span><span class="main">;</span> <span class="free">x</span><span class="main">≠</span><span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> VAR <span class="main">(</span><span class="bound">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">lemmas</span></span> ADJUST_unfolds <span class="main">=</span> ADJUST_PRE_SCOPE_unfolds ADJUST_PRE_PARAM_unfolds 
    ADJUST_POST_SCOPE_unfolds ADJUST_POST_PARAM_unfolds ADJUST_POST_RETV_unfolds
      
  <span class="comment1">(* TODO: Clean up these proofs! *)</span>  
  <span class="keyword1"><span class="command">lemma</span></span> HT_mods_adjust_scope<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">vs</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="main">(</span>Set.filter is_global <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>ADJUST_PRE_SCOPE <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>ADJUST_POST_SCOPE <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_mods_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> adjust_scope<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> HT_strengthen_modset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> HT_conseq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> modifies_join<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> modifies_mono<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> HT_mods_adjust_param<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">vs</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="main">(</span>insert <span class="free">l</span> <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">[]</span><span class="main">::=</span><span class="free">G</span><span class="main">;;</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_mods_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> adjust_assign_before<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">c</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">G</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> HT_conseq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> HT_mods_adjust_retv<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">vs</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="main">(</span>insert <span class="free">G</span> <span class="free">vs</span><span class="main">)</span> <span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span> <span class="free">G</span><span class="main">[]</span><span class="main">::=</span><span class="free">l</span><span class="main">)</span> <span class="main">(</span>ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_mods_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> HT_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wp_conseq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wp_eq modifies_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_triv<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> HT_partial_mods_adjust_scope<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_partial_mods <span class="free">π</span> <span class="free">vs</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_partial_mods <span class="free">π</span> <span class="main">(</span>Set.filter is_global <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>ADJUST_PRE_SCOPE <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SCOPE</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>ADJUST_POST_SCOPE <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_mods_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> adjust_scope_partial<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> HT_partial_strengthen_modset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> HT_partial_conseq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> modifies_join<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> modifies_mono<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> HT_partial_mods_adjust_param<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_partial_mods <span class="free">π</span> <span class="free">vs</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_partial_mods <span class="free">π</span> <span class="main">(</span>insert <span class="free">l</span> <span class="free">vs</span><span class="main">)</span> <span class="main">(</span>ADJUST_PRE_PARAM <span class="free">l</span> <span class="free">G</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">[]</span><span class="main">::=</span><span class="free">G</span><span class="main">;;</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>ADJUST_POST_PARAM <span class="free">l</span> <span class="free">G</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_mods_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> adjust_assign_before_partial<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">c</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">G</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> HT_partial_conseq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> modifies_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">lemma</span></span> HT_partial_mods_adjust_retv<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_partial_mods <span class="free">π</span> <span class="free">vs</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_partial_mods <span class="free">π</span> <span class="main">(</span>insert <span class="free">G</span> <span class="free">vs</span><span class="main">)</span> <span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span> <span class="free">G</span><span class="main">[]</span><span class="main">::=</span><span class="free">l</span><span class="main">)</span> <span class="main">(</span>ADJUST_POST_RETV <span class="free">G</span> <span class="free">l</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_partial_mods_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> HT_partial_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wlp_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> impE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> wlp_conseq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wlp_eq modifies_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_triv<span class="main">)</span>
    
        
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HT_generalize_penv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods Map.empty <span class="free">mods</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_mods_def HT_def wp_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">using</span></span> big_step_mono_prog map_le_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">IMP2_Parameters</span> 
  <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">adjust_retv_rl</span> <span class="entity">ctxt</span> <span class="entity">G</span> <span class="entity">l</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">G</span> <span class="main">=</span> <span class="entity">HOLogic.mk_string</span> <span class="entity">G</span> |&gt; Thm.cterm_of <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">HOLogic.mk_string</span> <span class="entity">l</span> |&gt; Thm.cterm_of <span class="entity">ctxt</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rs_thms</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> HT_mods_adjust_retv HT_partial_mods_adjust_retv<span class="antiquote">}</span></span></span>
        |&gt; map <span class="main">(</span>Drule.infer_instantiate' <span class="entity">ctxt</span> <span class="main">[</span>NONE<span class="main">,</span> NONE<span class="main">,</span> NONE<span class="main">,</span> NONE<span class="main">,</span> NONE<span class="main">,</span> SOME <span class="entity">G</span><span class="main">,</span> SOME <span class="entity">l</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">thm</span> <span class="entity">RS_fst</span> <span class="entity">rs_thms</span> <span class="keyword2"><span class="keyword">end</span></span>
  
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">adjust_param_rl</span> <span class="entity">ctxt</span> <span class="entity">G</span> <span class="entity">l</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">G</span> <span class="main">=</span> <span class="entity">HOLogic.mk_string</span> <span class="entity">G</span> |&gt; Thm.cterm_of <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">HOLogic.mk_string</span> <span class="entity">l</span> |&gt; Thm.cterm_of <span class="entity">ctxt</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rs_thms</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> HT_mods_adjust_param HT_partial_mods_adjust_param<span class="antiquote">}</span></span></span>
        |&gt; map <span class="main">(</span>Drule.infer_instantiate' <span class="entity">ctxt</span> <span class="main">[</span>NONE<span class="main">,</span> NONE<span class="main">,</span> NONE<span class="main">,</span> NONE<span class="main">,</span> NONE<span class="main">,</span> SOME <span class="entity">l</span><span class="main">,</span> SOME <span class="entity">G</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">thm</span> <span class="entity">RS_fst</span> <span class="entity">rs_thms</span> <span class="keyword2"><span class="keyword">end</span></span>
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">adjust_scope_rl</span> <span class="main">(</span><span class="main">_</span><span class="main">:</span><span class="entity">Proof.context</span><span class="main">)</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">thm</span> <span class="entity">RS_fst</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> HT_mods_adjust_scope HT_partial_mods_adjust_scope<span class="antiquote">}</span></span></span>
      
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">adjust_proc_rl</span> <span class="entity">imp_params</span> <span class="entity">imp_retvs</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">params</span> <span class="main">=</span> <span class="entity">IMP_Syntax.zip_with_param_names</span> <span class="entity">imp_params</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">retvs</span> <span class="main">=</span> <span class="entity">IMP_Syntax.zip_with_ret_names</span> <span class="entity">imp_retvs</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Named_Simpsets.put</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> vcg_bb<span class="antiquote">}</span></span> <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">ctxt</span> addsimps <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ADJUST_unfolds<span class="antiquote">}</span></span></span>
  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">thm</span>
        |&gt; fold_rev <span class="main">(</span>uncurry <span class="main">(</span><span class="entity">adjust_retv_rl</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">retvs</span>
        |&gt; fold_rev <span class="main">(</span>uncurry <span class="main">(</span><span class="entity">adjust_param_rl</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">params</span>
        |&gt; <span class="entity">adjust_scope_rl</span> <span class="entity">ctxt</span>
        |&gt; <span class="entity">Simplifier.simplify</span> <span class="entity">ctxt</span>
    
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">thm</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>
  
  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Recursion›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> HT_mods_fold_call<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="free">c</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="main">(</span>PCall <span class="free">p</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">unfolding</span></span> HT_mods_def HT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wp_eq wp_pcall_eq<span class="main">)</span>

    
<span class="keyword1"><span class="command">lemma</span></span> localize_HT_mods<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π</span> <span class="free">mods</span> <span class="free">P</span> <span class="main">(</span>PCall <span class="free">p</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT_mods <span class="free">π'</span> <span class="free">mods</span> <span class="free">P</span> <span class="main">(</span>PScope <span class="free">π</span> <span class="main">(</span>PCall <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HT_mods_def HT_def wp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> localize_recursion<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> localize_HT_mods' <span class="main">=</span> localize_HT_mods<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> π'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Map.empty"</span></span><span class="main">]</span>
  

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">PROVE_Θ</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span> <span class="bound">c</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">Q</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">∧</span> <span class="bound">P</span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">⟶</span> wp <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="bound">c</span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">Q</span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PROVE_ΘI<span class="main">[</span><span class="operator">vcg_preprocess_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"PROVE_Θ <span class="free">π</span> <span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{}</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⟦</span>RENAMING <span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">f</span><span class="main">;</span> BB_PROTECT <span class="main">(</span><span class="free">P</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">π</span> <span class="main">(</span><span class="free">c</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> PROVE_Θ <span class="free">π</span> <span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">Θ</span><span class="main">⟧</span> <span class="main">⟹</span> PROVE_Θ <span class="free">π</span> <span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>insert <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="main">(</span><span class="free">P</span><span class="main">,</span><span class="free">c</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">Θ</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> PROVE_Θ_def BB_PROTECT_def RENAMING_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">JOIN_VARS</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> JOIN_VARS<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">P</span><span class="main">.</span> JOIN_VARS <span class="main">(</span>VAR <span class="bound">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">g</span> <span class="bound">P</span> <span class="main">=</span> VAR <span class="bound">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> JOIN_VARS <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">g</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">P</span><span class="main">.</span> JOIN_VARS <span class="bound">f</span> <span class="main">(</span>VAR <span class="bound">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span> <span class="main">=</span> VAR <span class="bound">v</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> JOIN_VARS <span class="bound">f</span> <span class="main">(</span><span class="bound">g</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">P</span><span class="main">.</span> JOIN_VARS <span class="main">(</span>BB_PROTECT <span class="bound">f</span><span class="main">)</span> <span class="main">(</span>BB_PROTECT <span class="bound">g</span><span class="main">)</span> <span class="bound">P</span> <span class="main">=</span> <span class="bound">P</span> <span class="bound">f</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> JOIN_VARS_def BB_PROTECT_def VAR_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">join_vars_rl</span> <span class="entity">ctxt</span> <span class="entity">thm0</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Local_Defs.unfold <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> JOIN_VARS<span class="antiquote">}</span></span></span> <span class="entity">thm0</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Thm.prop_of <span class="entity">thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cns</span> <span class="main">=</span> Term.add_const_names <span class="entity">t</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> member <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">cns</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> JOIN_VARS<span class="antiquote">}</span></span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="keyword3"><span class="keyword">raise</span></span> THM<span class="main">(</span><span class="inner_quoted">"join_vars_rl: not joined"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">thm0</span><span class="main">,</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>  
  
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ASSUME_Θ</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span> <span class="main">≡</span> HT'set_r <span class="main">(</span><span class="main">λ</span><span class="bound">f'</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">f'</span> <span class="bound">s'</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">Θ</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> ASSUME_ΘE1 <span class="main">=</span> thin_rl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ASSUME_Θ <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">{}</span>"</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> ASSUME_ΘE2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ASSUME_Θ <span class="free">π</span> <span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">R</span> <span class="main">(</span>insert <span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="main">(</span><span class="free">P</span><span class="main">,</span><span class="free">c</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">Θ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"HT' <span class="free">π</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> JOIN_VARS <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">P</span><span class="main">.</span> BB_PROTECT <span class="main">(</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="main">(</span><span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">∧</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">c</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"ASSUME_Θ <span class="free">π</span> <span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">R</span> <span class="free">Θ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ASSUME_Θ_def HT'set_r_def JOIN_VARS_def BB_PROTECT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> ASSUME_ΘE <span class="main">=</span> ASSUME_ΘE1 ASSUME_ΘE2

<span class="keyword1"><span class="command">lemma</span></span> vcg_HT'setI<span class="main">:</span>    
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> RL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">⟦</span> ASSUME_Θ <span class="free">π</span> <span class="bound">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">R</span> <span class="free">Θ</span> <span class="main">⟧</span> <span class="main">⟹</span> PROVE_Θ <span class="free">π</span> <span class="bound">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">Θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"HT'set <span class="free">π</span> <span class="free">Θ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms HT'setI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">Θ</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> ASSUME_Θ_def PROVE_Θ_def HT'set_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Consistency Check›</span></span>  

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Spec_Consistency_Check</span> 
  <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_ht_mods</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">mods</span><span class="main">,</span><span class="entity">P</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">Q</span><span class="main">)</span> <span class="main">=</span> Thm.concl_of <span class="entity">thm</span> 
          |&gt; <span class="entity">HOLogic.dest_Trueprop</span> |&gt; <span class="entity">IMP2_Modified_Analysis.dest_HT_mods</span>
      
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fail</span> <span class="entity">msg</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"Consistency check: "</span>^<span class="entity">msg</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
        
        <span class="comment1">(* Check that modset is OK *)</span>  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">IMP2_Modified_Analysis.is_valid_modset</span> <span class="entity">mods</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">fail</span> <span class="inner_quoted">"invalid modset"</span>
        
        <span class="comment1">(* Check for relicts in pre/postcondition *)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bad_consts</span> <span class="main">=</span> <span class="main">[</span>
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> ADJUST_PRE_PARAM<span class="antiquote">}</span></span><span class="main">,</span> 
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> ADJUST_PRE_SCOPE<span class="antiquote">}</span></span><span class="main">,</span> 
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> ADJUST_POST_PARAM<span class="antiquote">}</span></span><span class="main">,</span> 
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> ADJUST_POST_RETV<span class="antiquote">}</span></span><span class="main">,</span> 
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> ADJUST_POST_SCOPE<span class="antiquote">}</span></span>
          <span class="main">]</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_bad_const</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> member <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">bad_consts</span> <span class="entity">n</span>
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> exists_Const <span class="entity">is_bad_const</span> <span class="entity">P</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">fail</span> <span class="inner_quoted">"VCG relict in precondition"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> exists_Const <span class="entity">is_bad_const</span> <span class="entity">Q</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">fail</span> <span class="inner_quoted">"VCG relict in precondition"</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>
  
<span class="comment1">(* Summarizes postprocessors for specifications *)</span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Spec_Postprocessing</span> 
  <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="comment1">(*
      Strip annotations
    *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cnv_HT'_to_HT</span> <span class="entity">ctxt</span> <span class="main">=</span> 
         <span class="entity">IMP_Annotations.strip_annotations</span> <span class="entity">ctxt</span>
      #&gt; Local_Defs.unfold <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> HT'_unfolds<span class="antiquote">}</span></span></span>
    
    <span class="comment1">(*
      Modifies Analysis
    *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cnv_HT_to_HTmod</span> <span class="main">=</span> <span class="entity">IMP2_Modified_Analysis.mk_HT_mods</span>
      
    <span class="comment1">(*
      Make procedure frame
    *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cnv_body_to_proc</span> <span class="main">=</span> <span class="entity">IMP2_Parameters.adjust_proc_rl</span>
    
    <span class="comment1">(*
      Generalize over procedure environment
    *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cnv_HTmod_generalize_penv</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">thm</span> <span class="entity">RS_fst</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> HT_generalize_penv asm_rl<span class="antiquote">}</span></span></span>
  
    <span class="comment1">(*
      Define command as constant
    *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">define_HTmod_const</span> <span class="entity">binding</span> <span class="entity">thm</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="comment1">(* Extract Command *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">cmd</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=</span> Thm.concl_of <span class="entity">thm</span> |&gt; <span class="entity">HOLogic.dest_Trueprop</span> |&gt; <span class="entity">IMP2_Modified_Analysis.dest_HT_mods</span>

      <span class="comment1">(* Define *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs</span> <span class="main">=</span> Free <span class="main">(</span>Binding.name_of <span class="entity">binding</span><span class="main">,</span> fastype_of <span class="entity">cmd</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eqn</span> <span class="main">=</span> Logic.mk_equals <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span><span class="entity">cmd</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">lhs</span><span class="main">,</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">def_thm</span><span class="main">)</span><span class="main">)</span><span class="main">,</span><span class="entity">lthy</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Specification.definition</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">binding</span><span class="main">,</span>NONE<span class="main">,</span>Mixfix.NoSyn<span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span>Binding.empty<span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="entity">eqn</span><span class="main">)</span> <span class="entity">lthy</span>
      
      <span class="comment1">(* Fold definition in theorem *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Local_Defs.fold <span class="entity">lthy</span> <span class="main">[</span><span class="entity">def_thm</span><span class="main">]</span> <span class="entity">thm</span>
      
      <span class="comment1">(* Sanity check: Has definition actually been folded? *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> exists_subterm <span class="main">(</span>curry <span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span> <span class="entity">lhs</span><span class="main">)</span> <span class="main">(</span>Thm.prop_of <span class="entity">thm</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">orelse</span></span> <span class="keyword3"><span class="keyword">raise</span></span> THM<span class="main">(</span><span class="inner_quoted">"spec_program_cmd: Failed to fold command definition"</span><span class="main">,</span><span class="inner_numeral">~1</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
      
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="main">(</span><span class="main">(</span><span class="entity">binding</span><span class="main">,</span><span class="entity">def_thm</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span> 
    
    <span class="comment1">(*
      Declare defined command and specification to VCG
    *)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">declare_defined_spec</span> <span class="main">(</span><span class="entity">binding</span><span class="main">,</span><span class="entity">def_thm</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="comment1">(* Sanity check: Various consistency checks *)</span>  
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">Spec_Consistency_Check.check_ht_mods</span> <span class="entity">thm</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">note</span> <span class="main">=</span> snd oo Local_Theory.note

      <span class="comment1">(* Note specification theorem, register as [vcg_rule] *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">spec_thm_name</span> <span class="main">=</span> Binding.suffix_name <span class="inner_quoted">"_spec"</span> <span class="entity">binding</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> <span class="entity">note</span> <span class="main">(</span><span class="main">(</span><span class="entity">spec_thm_name</span><span class="main">,</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">vcg_specs</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> <span class="entity">lthy</span> 
                
      <span class="comment1">(* Create lhsv-theorems, register as vcg_bb simp-rule *)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhsv_thms</span> <span class="main">=</span> <span class="entity">IMP2_Modified_Analysis.mk_lhsv_thms</span> <span class="entity">lthy</span> <span class="entity">def_thm</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhsv_thm_name</span> <span class="main">=</span> Binding.suffix_name <span class="inner_quoted">"_lhsv"</span> <span class="entity">binding</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> <span class="entity">note</span> <span class="main">(</span><span class="main">(</span><span class="entity">lhsv_thm_name</span><span class="main">,</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">,</span><span class="entity">lhsv_thms</span><span class="main">)</span> <span class="entity">lthy</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">lthy</span>
    <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">define_declare</span> <span class="entity">binding</span> <span class="entity">thm</span> <span class="main">=</span> 
        <span class="entity">define_HTmod_const</span> <span class="entity">binding</span> <span class="entity">thm</span> 
      #&gt; uncurry <span class="entity">declare_defined_spec</span>
        

  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Program Specification Commands›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Simple_Program_Specification</span> 
  <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">simple_spec_program_cmd</span> <span class="entity">binding</span> <span class="entity">partial</span> <span class="entity">add_vars</span> <span class="entity">params</span> <span class="entity">pre_src</span> <span class="entity">post_src</span> <span class="entity">cmd_src</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">total</span> <span class="main">=</span> not <span class="entity">partial</span>
      
      <span class="keyword3"><span class="keyword">open</span></span> IMP_Annotations
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">prog_vars</span><span class="main">,</span><span class="entity">prog_t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">IMP_Parser.parse_command_at</span> <span class="entity">lthy</span> <span class="entity">cmd_src</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">params</span> <span class="keyword2"><span class="keyword">of</span></span> 
        NONE <span class="main">=&gt;</span> <span class="main">{</span> add_vars <span class="main">=</span> <span class="entity">add_vars</span><span class="main">,</span> in_vars<span class="main">=</span>NONE<span class="main">,</span> out_vars<span class="main">=</span>NONE<span class="main">,</span> prog_vars<span class="main">=</span><span class="entity">prog_vars</span> <span class="main">}</span>
      <span class="main">|</span> SOME <span class="main">(</span><span class="entity">pvs</span><span class="main">,</span><span class="entity">rvs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">{</span> add_vars <span class="main">=</span> <span class="entity">add_vars</span><span class="main">,</span> in_vars<span class="main">=</span>SOME <span class="entity">pvs</span><span class="main">,</span> out_vars<span class="main">=</span>SOME <span class="entity">rvs</span><span class="main">,</span> prog_vars<span class="main">=</span><span class="entity">prog_vars</span> <span class="main">}</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prog_t</span> <span class="main">=</span> <span class="entity">read_program</span> <span class="entity">cfg</span> <span class="entity">lthy</span> <span class="entity">prog_t</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre</span> <span class="main">=</span> <span class="entity">gen_read_ta</span> Syntax.read_term <span class="main">(</span><span class="entity">mk_pre_reader</span> <span class="entity">cfg</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">pre_src</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">post</span> <span class="main">=</span> <span class="entity">gen_read_ta</span> Syntax.read_term <span class="main">(</span><span class="entity">mk_post_reader</span> <span class="entity">cfg</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">post_src</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> <span class="entity">VCG_Htriple_Syntax.mk_htriple'</span> <span class="entity">total</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Map.empty<span class="main">::</span>program"</span><span class="antiquote">}</span></span> <span class="main">(</span><span class="entity">pre</span><span class="main">,</span><span class="entity">prog_t</span><span class="main">,</span><span class="entity">post</span><span class="main">)</span>
      
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="entity">goal</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">after_qed</span> <span class="entity">thmss</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">param_post</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">params</span> <span class="keyword2"><span class="keyword">of</span></span> 
          NONE <span class="main">=&gt;</span> K I 
        <span class="main">|</span> SOME <span class="main">(</span><span class="entity">pvs</span><span class="main">,</span><span class="entity">rvs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Spec_Postprocessing.cnv_body_to_proc</span> <span class="entity">pvs</span> <span class="entity">rvs</span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> flat <span class="entity">thmss</span> 
          |&gt; the_single
          |&gt; <span class="entity">Spec_Postprocessing.cnv_HT'_to_HT</span> <span class="entity">lthy</span>
          |&gt; <span class="entity">Spec_Postprocessing.cnv_HT_to_HTmod</span> <span class="entity">lthy</span>
          |&gt; <span class="entity">param_post</span> <span class="entity">lthy</span>
          |&gt; <span class="entity">Spec_Postprocessing.cnv_HTmod_generalize_penv</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> <span class="entity">Spec_Postprocessing.define_declare</span> <span class="entity">binding</span> <span class="entity">thm</span> <span class="entity">lthy</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">lthy</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Proof.theorem</span> NONE <span class="entity">after_qed</span> <span class="main">[</span><span class="main">[</span><span class="main">(</span><span class="entity">goal</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">]</span> <span class="entity">lthy</span> <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>
›</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Recursive_Program_Specification</span> 
  <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">proc_spec_src</span> <span class="main">=</span> <span class="main">{</span>    
        binding<span class="main">:</span>  binding<span class="main">,</span>                   <span class="comment1">(* name *)</span>
        params<span class="main">:</span> string list<span class="main">,</span>                 <span class="comment1">(* parameters *)</span>
        retvs<span class="main">:</span> string list<span class="main">,</span>                  <span class="comment1">(* return variables *)</span>
        addvars<span class="main">:</span> <span class="entity">IMP_Syntax.impvar</span> list<span class="main">,</span>     <span class="comment1">(* additional variables *)</span>
        pre_src<span class="main">:</span> string<span class="main">,</span>                     <span class="comment1">(* precondition src *)</span>
        post_src<span class="main">:</span> string<span class="main">,</span>                    <span class="comment1">(* postcondition src *)</span>
        variant_src<span class="main">:</span> string<span class="main">,</span>                 <span class="comment1">(* variant src *)</span>
        cmd_src<span class="main">:</span> string * Position.T         <span class="comment1">(* body src *)</span>
      <span class="main">}</span>
  
      <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">proc_spec</span> <span class="main">=</span> <span class="main">{</span>    
        binding<span class="main">:</span>  binding<span class="main">,</span>                   <span class="comment1">(* name *)</span>
        params<span class="main">:</span> string list<span class="main">,</span>                 <span class="comment1">(* parameters *)</span>
        retvs<span class="main">:</span> string list<span class="main">,</span>                  <span class="comment1">(* return variables *)</span>
        addvars<span class="main">:</span> <span class="entity">IMP_Syntax.impvar</span> list<span class="main">,</span>     <span class="comment1">(* additional variables *)</span>
        pre<span class="main">:</span> term<span class="main">,</span>                           <span class="comment1">(* precondition src *)</span>
        post<span class="main">:</span> term<span class="main">,</span>                          <span class="comment1">(* postcondition src *)</span>
        variant<span class="main">:</span> term<span class="main">,</span>                       <span class="comment1">(* variant src *)</span>
        cmd<span class="main">:</span> term                            <span class="comment1">(* body src *)</span>
      <span class="main">}</span>
      
          
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_spec</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">spec_src</span> <span class="main">:</span> <span class="entity">proc_spec_src</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword3"><span class="keyword">open</span></span> IMP_Annotations
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">prog_vars</span><span class="main">,</span><span class="entity">prog_t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">IMP_Parser.parse_command_at</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="main">#</span>cmd_src <span class="entity">spec_src</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cfg</span> <span class="main">=</span> <span class="main">{</span> 
          add_vars <span class="main">=</span> <span class="main">#</span>addvars <span class="entity">spec_src</span><span class="main">,</span> 
          in_vars<span class="main">=</span>SOME <span class="main">(</span><span class="main">#</span>params <span class="entity">spec_src</span><span class="main">)</span><span class="main">,</span> 
          out_vars<span class="main">=</span>SOME <span class="main">(</span><span class="main">#</span>retvs <span class="entity">spec_src</span><span class="main">)</span><span class="main">,</span> 
          prog_vars<span class="main">=</span><span class="entity">prog_vars</span> <span class="main">}</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prog_t</span> <span class="main">=</span> <span class="entity">read_program</span> <span class="entity">cfg</span> <span class="entity">ctxt</span> <span class="entity">prog_t</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pre</span> <span class="main">=</span> <span class="entity">gen_read_ta</span> Syntax.read_term <span class="main">(</span><span class="entity">mk_pre_reader</span> <span class="entity">cfg</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>pre_src <span class="entity">spec_src</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">post</span> <span class="main">=</span> <span class="entity">gen_read_ta</span> Syntax.read_term <span class="main">(</span><span class="entity">mk_post_reader</span> <span class="entity">cfg</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>post_src <span class="entity">spec_src</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">variant</span> <span class="main">=</span> <span class="entity">gen_read_ta</span> Syntax.read_term <span class="main">(</span><span class="entity">mk_variant_reader</span> <span class="entity">cfg</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>variant_src <span class="entity">spec_src</span><span class="main">)</span>
        
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="main">(</span><span class="main">{</span>
          binding <span class="main">=</span> <span class="main">(</span><span class="main">#</span>binding <span class="entity">spec_src</span><span class="main">)</span><span class="main">,</span>
          params<span class="main">=</span><span class="main">(</span><span class="main">#</span>params <span class="entity">spec_src</span><span class="main">)</span><span class="main">,</span>
          retvs<span class="main">=</span><span class="main">(</span><span class="main">#</span>retvs <span class="entity">spec_src</span><span class="main">)</span><span class="main">,</span>
          addvars<span class="main">=</span><span class="main">(</span><span class="main">#</span>addvars <span class="entity">spec_src</span><span class="main">)</span><span class="main">,</span>
          pre<span class="main">=</span><span class="entity">pre</span><span class="main">,</span>
          post<span class="main">=</span><span class="entity">post</span><span class="main">,</span>
          variant<span class="main">=</span><span class="entity">variant</span><span class="main">,</span>
          cmd<span class="main">=</span><span class="entity">prog_t</span>
        <span class="main">}</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  
  
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">adjust_thm</span> <span class="entity">params</span> <span class="entity">retvs</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword3"><span class="keyword">open</span></span> Spec_Postprocessing
      <span class="keyword2"><span class="keyword">in</span></span>
        I
        #&gt; <span class="entity">cnv_HT'_to_HT</span> <span class="entity">ctxt</span>
        #&gt; <span class="entity">cnv_HT_to_HTmod</span> <span class="entity">ctxt</span>
        #&gt; <span class="entity">cnv_body_to_proc</span> <span class="entity">params</span> <span class="entity">retvs</span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">end</span></span>
      
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gen_spec_program_cmd</span> <span class="entity">rel_src</span> <span class="entity">spec_srcs</span> <span class="entity">lthy</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">lthy</span>
      
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trace</span> <span class="entity">msg</span> <span class="main">=</span> tracing <span class="entity">msg</span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Check Specification *)"</span>
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rel</span> <span class="main">=</span> the_default <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">‹measure nat›</span><span class="antiquote">}</span></span> <span class="main">(</span>Option.map <span class="main">(</span>Syntax.read_term <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">rel_src</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">relT</span> <span class="main">=</span> fastype_of <span class="entity">rel</span> |&gt; <span class="entity">HOLogic.dest_setT</span> |&gt; <span class="entity">HOLogic.dest_prodT</span> |&gt; fst
      
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">specs</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">check_spec</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">spec_srcs</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Create dummy procedure environment *)"</span>
        <span class="comment1">(*val ctxt0 = ctxt*)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">pe_var</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton Proof_Context.add_fixes <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> π<span class="antiquote">}</span></span></span><span class="main">,</span>SOME <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">program</span><span class="antiquote">}</span></span><span class="main">,</span>Mixfix.NoSyn<span class="main">)</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pe_var</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">pe_var</span><span class="main">,</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">program</span><span class="antiquote">}</span></span><span class="main">)</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Define initial goal *)"</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_theta_entry</span> <span class="main">{</span><span class="entity">variant</span><span class="main">,</span> <span class="entity">pre</span><span class="main">,</span> <span class="entity">cmd</span><span class="main">,</span> <span class="entity">post</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">HOLogic.mk_tuple</span> <span class="main">[</span><span class="entity">variant</span><span class="main">,</span> <span class="entity">HOLogic.mk_tuple</span> <span class="main">[</span><span class="entity">pre</span><span class="main">,</span><span class="entity">cmd</span><span class="main">,</span><span class="entity">post</span><span class="main">]</span><span class="main">]</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thetaT</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="tfree">'a</span> Θelem_t"</span><span class="antiquote">}</span></span> |&gt; typ_subst_atomic <span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'a</span></span><span class="antiquote">}</span></span><span class="main">,</span><span class="entity">relT</span><span class="main">)</span><span class="main">]</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">theta</span> <span class="main">=</span> map <span class="entity">mk_theta_entry</span> <span class="entity">specs</span> |&gt; <span class="entity">HOLogic.mk_set</span> <span class="entity">thetaT</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">HT'setC</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> HT'set <span class="main">(</span><span class="quoted"><span class="tfree">'a</span></span><span class="main">)</span><span class="antiquote">}</span></span> |&gt; subst_atomic_types <span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted"><span class="tfree">'a</span></span><span class="antiquote">}</span></span><span class="main">,</span><span class="entity">relT</span><span class="main">)</span><span class="main">]</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> <span class="entity">HT'setC</span> $ <span class="entity">pe_var</span> $ <span class="entity">theta</span>
          |&gt; <span class="entity">HOLogic.mk_Trueprop</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Start proof *)"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">goal</span> |&gt; Goal.init  
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Apply recursion rule, and solve wf-precondition *)"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">crel</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">rel</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">sr_rl</span> <span class="main">=</span> Drule.infer_instantiate' <span class="entity">ctxt</span> <span class="main">[</span>SOME <span class="entity">crel</span><span class="main">]</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> vcg_HT'setI<span class="antiquote">}</span></span></span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">Det_Goal_Refine.apply1</span> <span class="inner_quoted">""</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">sr_rl</span><span class="main">]</span><span class="main">)</span> <span class="entity">st</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">Det_Goal_Refine.apply1</span> <span class="inner_quoted">"Failed to solve wf-goal"</span> 
          <span class="main">(</span>SOLVED' <span class="main">(</span><span class="entity">force_tac</span> <span class="entity">ctxt</span> ORELSE' SELECT_GOAL <span class="main">(</span>print_tac <span class="entity">ctxt</span> <span class="inner_quoted">""</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Explode theta-assumptions *)"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">Det_Goal_Refine.apply1</span> <span class="inner_quoted">""</span> <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>ematch_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> ASSUME_ΘE<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span>
      
        <span class="comment1">(* At this point, we have: ⋀f<span class="hidden">⇩</span><sub>0</sub> s<span class="hidden">⇩</span><sub>0</sub>. ⟦ HT' π …; HT' π …; … ⟧ ⟹ PROVE_Θ π … *)</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Join VARs in preconditions *)"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">Det_Goal_Refine.apply1</span> <span class="inner_quoted">""</span> <span class="main">(</span><span class="entity">Thm_Mapping.map_all_prems_tac</span> <span class="entity">join_vars_rl</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">st</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Wrap premises *)"</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wrap_thm_rl</span> <span class="main">{</span><span class="entity">params</span><span class="main">,</span><span class="entity">retvs</span><span class="main">,</span><span class="main">...</span><span class="main">}</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">adjust_thm</span> <span class="entity">params</span> <span class="entity">retvs</span> <span class="entity">ctxt</span> <span class="entity">thm</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wrap_thm_rls</span> <span class="main">=</span> map <span class="entity">wrap_thm_rl</span> <span class="entity">specs</span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">Det_Goal_Refine.apply1</span> <span class="inner_quoted">""</span> <span class="main">(</span><span class="entity">Thm_Mapping.map_prems_tac</span> <span class="entity">wrap_thm_rls</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">st</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Read wrapped commands to define procedure environment *)"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cmds</span> <span class="main">=</span> Logic.prems_of_goal <span class="main">(</span>Thm.prop_of <span class="entity">st</span><span class="main">)</span> <span class="inner_numeral">1</span>
          |&gt; map <span class="main">(</span>
               <span class="entity">HOLogic.dest_Trueprop</span> 
            #&gt; <span class="entity">IMP2_Modified_Analysis.dest_HT_mods</span>
            #&gt; <span class="main">#</span><span class="inner_numeral">5</span>
          <span class="main">)</span>
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Define procedure environment *)"</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">proc_name_t_of</span> <span class="main">{</span><span class="entity">binding</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">HOLogic.mk_string</span> <span class="main">(</span>Binding.name_of <span class="entity">binding</span><span class="main">)</span>
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">penv_pairs</span> <span class="main">=</span> <span class="entity">specs</span> ~~ <span class="entity">cmds</span>
          |&gt; map <span class="main">(</span>apfst <span class="entity">proc_name_t_of</span><span class="main">)</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">penv</span> <span class="main">=</span> <span class="entity">HOLOption.mk_map_list</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">pname</span><span class="antiquote">}</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">com</span><span class="antiquote">}</span></span> <span class="entity">penv_pairs</span>
                  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eqn</span> <span class="main">=</span> Logic.mk_equals <span class="main">(</span><span class="entity">pe_var</span><span class="main">,</span><span class="entity">penv</span><span class="main">)</span> |&gt; Thm.cterm_of <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">pe_def</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> yield_singleton <span class="main">(</span>Assumption.add_assms Local_Defs.def_export<span class="main">)</span> <span class="entity">eqn</span> <span class="entity">ctxt</span>
  
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Add theorem for lhsvπ π *)"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhsv_pi_thm</span> <span class="main">=</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">lemma</span> <span class="quoted">‹<span class="main">⋀</span><span class="bound">π</span> <span class="bound">πr</span><span class="main">.</span> <span class="bound">π</span><span class="main">≡</span><span class="bound">πr</span> <span class="main">⟹</span> lhsvπ <span class="bound">π</span> <span class="main">=</span> ANALYZE <span class="main">(</span>lhsvπ <span class="bound">πr</span><span class="main">)</span>›</span> <span class="keyword1"><span class="keyword">by</span></span> <span class="operator">auto</span><span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">pe_def</span><span class="main">]</span><span class="main">)</span>
          |&gt; <span class="entity">vcg_bb_simplify</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span>
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Context.proof_map <span class="main">(</span><span class="entity">Named_Simpsets.add_simp</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_simpset</span> vcg_bb<span class="antiquote">}</span></span> <span class="entity">lhsv_pi_thm</span><span class="main">)</span> <span class="entity">ctxt</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Finish modifies-analysis in HT' assumptions *)"</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">finish_mdf</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> 
          <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">lemma</span> <span class="quoted">‹<span class="main">⋀</span><span class="bound">π</span> <span class="bound">vs</span> <span class="bound">P</span> <span class="bound">c</span> <span class="bound">Q</span><span class="main">.</span> HT_mods <span class="bound">π</span> <span class="bound">vs</span> <span class="bound">P</span> <span class="bound">c</span> <span class="bound">Q</span> <span class="main">⟹</span> HT_mods <span class="bound">π</span> <span class="main">(</span>ANALYZE <span class="bound">vs</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">c</span> <span class="bound">Q</span>›</span> <span class="keyword1"><span class="keyword">by</span></span> <span class="operator">auto</span><span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
          |&gt; <span class="entity">vcg_bb_simplify</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span>
          
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">Det_Goal_Refine.apply1</span> <span class="inner_quoted">""</span> <span class="main">(</span><span class="entity">Thm_Mapping.map_all_prems_tac</span> <span class="entity">finish_mdf</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">st</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Wrap assumptions into calls *)"</span>
        <span class="comment1">(** First, show unfold theorems *)</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_unfold_thm</span> <span class="main">(</span><span class="entity">pname</span><span class="main">,</span><span class="entity">com</span><span class="main">)</span> <span class="main">=</span> Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> 
          <span class="main">(</span><span class="entity">HOLogic.mk_eq</span> <span class="main">(</span><span class="entity">pe_var</span>$<span class="entity">pname</span><span class="main">,</span><span class="entity">HOLOption.mk_Some</span> <span class="entity">com</span><span class="main">)</span> |&gt; <span class="entity">HOLogic.mk_Trueprop</span><span class="main">)</span>
          <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context<span class="main">=</span><span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> ALLGOALS <span class="main">(</span><span class="entity">vcg_bb_simp_tac</span> <span class="main">[</span><span class="entity">pe_def</span><span class="main">]</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unfold_thms</span> <span class="main">=</span> map <span class="entity">mk_unfold_thm</span> <span class="entity">penv_pairs</span>
                
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wrap_call_rls</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ufthm</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">htthm</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> HT_mods_fold_call<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">ufthm</span><span class="main">,</span><span class="entity">htthm</span><span class="main">]</span><span class="main">)</span> <span class="entity">unfold_thms</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">Det_Goal_Refine.apply1</span> <span class="inner_quoted">""</span> <span class="main">(</span><span class="entity">Thm_Mapping.map_prems_tac</span> <span class="entity">wrap_call_rls</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">st</span>
  
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Focus on goal *)"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st_before_focus</span> <span class="main">=</span> <span class="entity">st</span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt_before_focus</span> <span class="main">=</span> <span class="entity">ctxt</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">focus</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span><span class="main">,</span><span class="entity">st</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Subgoal.focus</span> <span class="entity">ctxt</span> <span class="inner_numeral">1</span> NONE <span class="entity">st</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Note ht-premises *)"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="entity">ctxt</span><span class="main">)</span> <span class="main">=</span> Proof_Context.note_thms <span class="inner_quoted">""</span> 
            <span class="main">(</span><span class="main">(</span>Binding.name <span class="inner_quoted">"rec_rules"</span><span class="main">,</span><span class="main">[</span><span class="entity">Named_Theorems.add</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> vcg_specs<span class="antiquote">}</span></span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
              <span class="main">[</span><span class="main">(</span><span class="entity">prems</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="entity">ctxt</span>
        
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Prepare user proof *)"</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">termss</span> <span class="main">=</span> Thm.prems_of <span class="entity">st</span> |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
        
        <span class="comment1">(* --- user proof is logically here --- *)</span>
        
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">after_qed</span> <span class="entity">thmss</span> <span class="entity">goal_ctxt'</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> flat <span class="entity">thmss</span> |&gt; Proof_Context.export <span class="entity">goal_ctxt'</span> <span class="entity">ctxt</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Solve subgoals of st *)"</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">st</span> <span class="main">=&gt;</span> Thm.implies_elim <span class="entity">st</span> <span class="entity">thm</span><span class="main">)</span> <span class="entity">thms</span> <span class="entity">st</span> <span class="comment1">(* TODO: Use resolve_tac here? *)</span>
           
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> singleton <span class="main">(</span>Proof_Context.export <span class="entity">ctxt</span> <span class="main">(</span><span class="main">#</span>context <span class="entity">focus</span><span class="main">)</span><span class="main">)</span> <span class="entity">st</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* retrofit over focus, and finish goal *)"</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">Subgoal.retrofit</span> <span class="main">(</span><span class="main">#</span>context <span class="entity">focus</span><span class="main">)</span> <span class="entity">ctxt_before_focus</span> <span class="main">(</span><span class="main">#</span>params <span class="entity">focus</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>asms <span class="entity">focus</span><span class="main">)</span> <span class="inner_numeral">1</span> <span class="entity">st</span> <span class="entity">st_before_focus</span> 
            |&gt; <span class="entity">Det_Goal_Refine.seq_first</span> <span class="inner_quoted">""</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">ctxt_before_focus</span>  
            
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> Goal.finish <span class="entity">ctxt</span> <span class="entity">st</span> |&gt; Goal.norm_result <span class="entity">ctxt</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Explode HT'set goal into single HTs *)"</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">explode_HT'set</span> <span class="entity">thm</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> try <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> HT'setD<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
            NONE <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
          <span class="main">|</span> SOME <span class="entity">thm'</span> <span class="main">=&gt;</span> <span class="entity">thm'</span> :: <span class="entity">explode_HT'set</span> <span class="main">(</span><span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> HT'setD<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>
  
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">explode_HT'set</span> <span class="entity">thm</span>
                  
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Adjust theorems *)"</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">thms</span>
            |&gt; <span class="entity">Thm_Mapping.map_thms</span> <span class="entity">ctxt</span> <span class="entity">wrap_thm_rls</span>
            |&gt; <span class="entity">Thm_Mapping.map_thms</span> <span class="entity">ctxt</span> <span class="entity">wrap_call_rls</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> localize_HT_mods<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">thms</span>  
  
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">trace</span> <span class="inner_quoted">"(* Define constants *)"</span>
          
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> fold 
            <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">{</span><span class="entity">binding</span><span class="main">,</span><span class="main">...</span><span class="main">}</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Spec_Postprocessing.define_declare</span> <span class="entity">binding</span> <span class="entity">thm</span><span class="main">)</span> 
            <span class="main">(</span><span class="entity">specs</span> ~~ <span class="entity">thms</span><span class="main">)</span> <span class="entity">ctxt</span>
            
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">ctxt</span>
        <span class="keyword2"><span class="keyword">end</span></span>      
  
      <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Proof.theorem</span> NONE <span class="entity">after_qed</span> <span class="main">[</span><span class="entity">termss</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>


<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹ <span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Program_Specification_Parser</span> 
  <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_param_decls</span> <span class="main">=</span> Args.parens <span class="main">(</span>Parse.enum <span class="inner_quoted">","</span> Parse.name<span class="main">)</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_var_decl</span> <span class="main">=</span> Parse.name -- Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">[</span>›</span></span>--<span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">]</span>›</span></span> &gt;&gt; K <span class="entity">IMP_Syntax.ARRAY</span><span class="main">)</span> <span class="entity">IMP_Syntax.VAL</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_var_decls</span> <span class="main">=</span> Scan.optional <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">for</span>›</span></span> |-- Scan.repeat <span class="entity">parse_var_decl</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
  
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_returns_clause</span> <span class="main">=</span> Scan.optional <span class="main">(</span>
      <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">returns</span>›</span></span> |-- <span class="main">(</span>Args.parens <span class="main">(</span>Parse.enum <span class="inner_quoted">","</span> Parse.name<span class="main">)</span> || Parse.name &gt;&gt; single<span class="main">)</span>
    <span class="main">)</span> <span class="main">[</span><span class="main">]</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_proc_spec</span> <span class="main">=</span> <span class="main">(</span>
          Parse.binding 
       -- <span class="entity">parse_param_decls</span>
       -- <span class="entity">parse_returns_clause</span>
      --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">assumes</span>›</span></span> -- Parse.term 
      --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">ensures</span>›</span></span> -- Parse.term 
      --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">variant</span>›</span></span> -- Parse.term 
       -- <span class="entity">parse_var_decls</span>
      --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">defines</span>›</span></span> -- <span class="main">(</span>Parse.position <span class="main">(</span>Parse.cartouche&gt;&gt;cartouche<span class="main">)</span><span class="main">)</span> 
      <span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">binding</span><span class="main">,</span><span class="entity">params</span><span class="main">)</span><span class="main">,</span><span class="entity">retvs</span><span class="main">)</span><span class="main">,</span><span class="entity">pre_src</span><span class="main">)</span><span class="main">,</span><span class="entity">post_src</span><span class="main">)</span><span class="main">,</span><span class="entity">variant_src</span><span class="main">)</span><span class="main">,</span><span class="entity">addvars</span><span class="main">)</span><span class="main">,</span><span class="entity">cmd_src</span><span class="main">)</span> <span class="main">=&gt;</span> 
        <span class="main">{</span>
          binding <span class="main">=</span> <span class="entity">binding</span><span class="main">,</span> 
          params<span class="main">=</span><span class="entity">params</span><span class="main">,</span> 
          retvs<span class="main">=</span><span class="entity">retvs</span><span class="main">,</span> 
          pre_src<span class="main">=</span><span class="entity">pre_src</span><span class="main">,</span> 
          post_src<span class="main">=</span><span class="entity">post_src</span><span class="main">,</span> 
          variant_src<span class="main">=</span><span class="entity">variant_src</span><span class="main">,</span>
          addvars<span class="main">=</span><span class="entity">addvars</span><span class="main">,</span>
          cmd_src<span class="main">=</span><span class="entity">cmd_src</span><span class="main">}</span> <span class="main">:</span> <span class="entity">Recursive_Program_Specification.proc_spec_src</span>
      <span class="main">)</span>
    
    
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>


  <span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword3"><span class="keyword">open</span></span> Simple_Program_Specification Recursive_Program_Specification Program_Specification_Parser
    <span class="keyword2"><span class="keyword">in</span></span>
      
      <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">program_spec</span>›</span></span> <span class="inner_quoted">"Define IMP program and prove specification"</span>
        <span class="main">(</span><span class="main">(</span>Args.mode <span class="inner_quoted">"partial"</span> -- Parse.binding 
          --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">assumes</span>›</span></span> -- Parse.term 
          --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">ensures</span>›</span></span> -- Parse.term 
           -- <span class="entity">parse_var_decls</span>
          --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">defines</span>›</span></span> -- <span class="main">(</span>Parse.position <span class="main">(</span>Parse.cartouche&gt;&gt;cartouche<span class="main">)</span><span class="main">)</span> 
          <span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">partial</span><span class="main">,</span><span class="entity">bnd</span><span class="main">)</span><span class="main">,</span><span class="entity">pre_src</span><span class="main">)</span><span class="main">,</span><span class="entity">post_src</span><span class="main">)</span><span class="main">,</span><span class="entity">addvars</span><span class="main">)</span><span class="main">,</span><span class="entity">cmd_src</span><span class="main">)</span> <span class="main">=&gt;</span> 
                  <span class="entity">simple_spec_program_cmd</span> <span class="entity">bnd</span> <span class="entity">partial</span> <span class="entity">addvars</span> NONE <span class="entity">pre_src</span> <span class="entity">post_src</span> <span class="entity">cmd_src</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    
    
    <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">procedure_spec</span>›</span></span> <span class="inner_quoted">"Define IMP procedure and prove specification"</span>
      <span class="main">(</span><span class="main">(</span>Args.mode <span class="inner_quoted">"partial"</span> -- Parse.binding 
         -- <span class="entity">parse_param_decls</span>
         -- <span class="entity">parse_returns_clause</span>
        --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">assumes</span>›</span></span> -- Parse.term 
        --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">ensures</span>›</span></span> -- Parse.term 
         -- <span class="entity">parse_var_decls</span>
        --| <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">defines</span>›</span></span> -- <span class="main">(</span>Parse.position <span class="main">(</span>Parse.cartouche&gt;&gt;cartouche<span class="main">)</span><span class="main">)</span> 
        <span class="main">)</span> &gt;&gt;
        
          <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">partial</span><span class="main">,</span><span class="entity">bnd</span><span class="main">)</span><span class="main">,</span><span class="entity">params</span><span class="main">)</span><span class="main">,</span><span class="entity">retvs</span><span class="main">)</span><span class="main">,</span><span class="entity">pre_src</span><span class="main">)</span><span class="main">,</span><span class="entity">post_src</span><span class="main">)</span><span class="main">,</span><span class="entity">addvars</span><span class="main">)</span><span class="main">,</span><span class="entity">cmd_src</span><span class="main">)</span> <span class="main">=&gt;</span> 
                <span class="entity">simple_spec_program_cmd</span> <span class="entity">bnd</span> <span class="entity">partial</span> <span class="entity">addvars</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">params</span><span class="main">,</span><span class="entity">retvs</span><span class="main">)</span><span class="main">)</span> <span class="entity">pre_src</span> <span class="entity">post_src</span> <span class="entity">cmd_src</span>
             <span class="main">)</span>
         <span class="main">)</span><span class="main">;</span>
          
      <span class="entity">Outer_Syntax.local_theory_to_proof</span> <span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword1">recursive_spec</span>›</span></span> <span class="inner_quoted">"Define IMP procedure and prove specification"</span>
        <span class="main">(</span>    Scan.option <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span>‹<span class="keyword2">relation</span>›</span></span> |-- Parse.term<span class="main">)</span>
          -- Parse.and_list1 <span class="entity">parse_proc_spec</span> 
          &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">rel</span><span class="main">,</span><span class="entity">specs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">gen_spec_program_cmd</span> <span class="entity">rel</span> <span class="entity">specs</span><span class="main">)</span><span class="main">)</span>
        
    <span class="keyword2"><span class="keyword">end</span></span>
  ›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2">
<div class="head">
<h1>Theory IMP2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> IMP2
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="IMP2_VCG.html">automation/IMP2_VCG</a>"</span> <span class="quoted">"<a href="IMP2_Specification.html">automation/IMP2_Specification</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹IMP2 Setup›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">deriv_unfolds</span><span class="main">]</span> <span class="main">=</span> Params_def Inline_def AssignIdx_retv_def ArrayCpy_retv_def


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Ad-Hoc Regression Tests›</span></span>
  
<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upd_idxSame<span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">a</span><span class="main">,</span><span class="free">i</span><span class="main">:=</span><span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span> <span class="main">=</span> triv_forall_equality

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">eta_contract</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span> <span class="main">]</span><span class="main">]</span>  
<span class="keyword1"><span class="command">program_spec</span></span> <span class="main">(</span>partial<span class="main">)</span> <span class="entity">p2</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>  
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span>›</span></span> <span class="main"><span class="main">{</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">&gt;</span></span>1<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
    n<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">;</span></span> 
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    G1<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G2<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> G3<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G1<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G2<span class="main"><span class="main">;</span></span> n<span class="main"><span class="main">=</span></span>G3<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword2">skip</span></span></span>
  <span class="main"><span class="main">}</span></span> <span class="main"><span class="main">}</span></span>›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">p2'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>  
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span> <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span>›</span></span> <span class="main"><span class="main">{</span></span> n<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">-</span></span>1 <span class="main"><span class="main">}</span></span>›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">p2''</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>  
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="keyword1">@relation</span></span> <span class="quoted"><span class="quoted">‹measure nat›</span></span> <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span> <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span>›</span></span> <span class="main"><span class="main">{</span></span> n<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">-</span></span>1 <span class="main"><span class="main">}</span></span>›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">p3</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"True"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">N</span><span class="main">=</span><span class="numeral">42</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> <span class="main"><span class="main">{</span></span>n <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span> N<span class="main"><span class="main">=</span></span>42
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹More Regression Tests›</span></span>

<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> nat_distribs <span class="main">=</span> nat_add_distrib nat_diff_distrib Suc_diff_le nat_mult_distrib nat_div_distrib 


<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">exp_count_up1</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">-</span><span class="skolem">c</span>›</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">c</span>›</span></span>    
    <span class="main"><span class="main">{</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      
      
      c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>


<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">exp_count_up1'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">-</span><span class="skolem">c</span>›</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">c</span>›</span></span>    
    <span class="main"><span class="main">{</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> 
      
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>
  
  
<span class="comment1">(* We've made the program a little larger … *)</span>
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">exp_count_up</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">-</span><span class="skolem">c</span>›</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">c</span>›</span></span>    
    <span class="main"><span class="main">{</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      
      <span class="main"><span class="main">{</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>

      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>

      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>

      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>

      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>

      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>

      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>

      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>

      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>   a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>    a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>  a<span class="main"><span class="main">=</span></span>a <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword2">skip</span></span></span>
      <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
      
      c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">all</span> <span class="quoted">‹<span class="operator">simp</span><span class="keyword3">?</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">exp_count_up3</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">-</span><span class="skolem">c</span>›</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">c</span>›</span></span>    
    <span class="main"><span class="main">{</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      
      <span class="main"><span class="main">{</span></span> <span class="comment1">― ‹Note, this provokes exponential blowup of intermediate, unsimplified terms! ›</span>
      a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">/</span></span>8<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">/</span></span>8<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">/</span></span>8<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">;</span></span> a <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">/</span></span>2<span class="main"><span class="main">;</span></span>
      
      <span class="keyword2"><span class="keyword"><span class="keyword2">skip</span></span></span>
      <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
      
      c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">all</span> <span class="quoted">‹<span class="operator">simp</span><span class="keyword3">?</span>›</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  
    
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">experiment</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> nat_distribs <span class="main">=</span> nat_add_distrib nat_diff_distrib Suc_diff_le nat_mult_distrib nat_div_distrib


<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">exp_count_up</span> <span class="main">(</span>n<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> a
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
      a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
      c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> 
        <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">-</span><span class="skolem">c</span>›</span></span>
        <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">c</span>›</span></span>
      <span class="main"><span class="main">{</span></span>
        a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
        c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1
      <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">use_exp</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    n <span class="main"><span class="main">=</span></span> exp_count_up<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    n <span class="main"><span class="main">=</span></span> exp_count_up<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">)</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">add3</span> <span class="main">(</span>a<span class="main">,</span> b<span class="main">,</span> c<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span><span class="skolem">b</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span><span class="skolem">c</span><span class="main">≥</span><span class="main">0</span>"</span></span>  
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    r <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">+</span></span>b<span class="main"><span class="main">+</span></span>c
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">use_add3</span> <span class="main">(</span>a<span class="main">,</span> b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">≥</span><span class="main">0</span>"</span></span>  
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    r1 <span class="main"><span class="main">=</span></span> add3<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span> b<span class="main"><span class="main">,</span></span> b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    r2 <span class="main"><span class="main">=</span></span> add3<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span> b<span class="main"><span class="main">,</span></span> b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    r <span class="main"><span class="main">=</span></span> r1<span class="main"><span class="main">+</span></span>r2
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">divmod</span> <span class="main">(</span>a<span class="main">,</span>b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span>c<span class="main">,</span>d<span class="main">)</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">div</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">mod</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    c <span class="main"><span class="main">=</span></span> a <span class="main"><span class="main">/</span></span> b<span class="main"><span class="main">;</span></span>
    d <span class="main"><span class="main">=</span></span> a <span class="keyword2"><span class="keyword"><span class="quasi_keyword">mod</span></span></span> b
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">use_divmod</span> <span class="main">(</span>a<span class="main">,</span>b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="main"><span class="main">(</span></span>d<span class="main"><span class="main">,</span></span>m<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> divmod <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    r <span class="main"><span class="main">=</span></span> d<span class="main"><span class="main">*</span></span>b <span class="main"><span class="main">+</span></span> m
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  
    
<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">experiment</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> nat_distribs <span class="main">=</span> nat_add_distrib nat_diff_distrib Suc_diff_le nat_mult_distrib nat_div_distrib


<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">exp_count_up</span> <span class="main">(</span>n<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> a
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
      a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
      c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> 
        <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">-</span><span class="skolem">c</span>›</span></span> 
        <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">c</span>›</span></span>
      <span class="main"><span class="main">{</span></span>
        a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
        c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1
      <span class="main"><span class="main">}</span></span>
      
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>
  

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">use_exp</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    n <span class="main"><span class="main">=</span></span> exp_count_up<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    n <span class="main"><span class="main">=</span></span> exp_count_up<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">)</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Deriving big-step semantics›</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="quoted"><span class="quoted">"Map.empty<span class="main">:</span> <span class="main">(</span>use_exp<span class="main">,</span><span class="main">&lt;</span><span class="inner_quoted">''n''</span><span class="main">:=</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">2</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">⇒</span> <span class="var">?s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="inner_quoted">''G_ret_1''</span> <span class="main">0</span> <span class="main">=</span> <span class="numeral">16</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> use_exp_def exp_count_up_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">bs_simp</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="quoted"><span class="quoted">"Map.empty<span class="main">:</span> <span class="main">(</span>use_exp<span class="main">,</span><span class="main">&lt;</span><span class="inner_quoted">''n''</span><span class="main">:=</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">2</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">⇒</span> <span class="var">?s</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="inner_quoted">''G_ret_1''</span> <span class="main">0</span> <span class="main">=</span> <span class="numeral">16</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> use_exp_def exp_count_up_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">big_step'</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">bs_simp</span>
  
    
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">add3</span> <span class="main">(</span>a<span class="main">,</span> b<span class="main">,</span> c<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span><span class="skolem">b</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span><span class="skolem">c</span><span class="main">≥</span><span class="main">0</span>"</span></span>  
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    r <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">+</span></span>b<span class="main"><span class="main">+</span></span>c
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">use_add3</span> <span class="main">(</span>a<span class="main">,</span> b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">≥</span><span class="main">0</span>"</span></span>  
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    r1 <span class="main"><span class="main">=</span></span> add3<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span> b<span class="main"><span class="main">,</span></span> b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    r2 <span class="main"><span class="main">=</span></span> add3<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span> b<span class="main"><span class="main">,</span></span> b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    r <span class="main"><span class="main">=</span></span> r1<span class="main"><span class="main">+</span></span>r2
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">no_param</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"True"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="numeral">42</span>"</span></span>  
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹r <span class="main"><span class="main">=</span></span> 42›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">foobar</span> <span class="main">(</span>a<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">≥</span><span class="main">0</span>›</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">=</span><span class="numeral">84</span><span class="main">+</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    r1 <span class="main"><span class="main">=</span></span> no_param<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    add3<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span> a<span class="main"><span class="main">,</span></span> r1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    r2 <span class="main"><span class="main">=</span></span> add3<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span> r1<span class="main"><span class="main">,</span></span> r1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    r <span class="main"><span class="main">=</span></span> r2
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>  

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"BB_PROTECT True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> BB_PROTECT_def<span class="main">)</span>

  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">add</span> <span class="main">(</span>a<span class="main">,</span>b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">=</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹r <span class="main"><span class="main">=</span></span> a <span class="main"><span class="main">+</span></span> b›</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>

  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">test</span> <span class="main">(</span>a<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    x1 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x2 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x3 <span class="main"><span class="main">=</span></span> add <span class="main"><span class="main">(</span></span>x1<span class="main"><span class="main">-</span></span>x2<span class="main"><span class="main">,</span></span> a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    
    x1 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x2 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x3 <span class="main"><span class="main">=</span></span> add <span class="main"><span class="main">(</span></span>x1<span class="main"><span class="main">-</span></span>x2<span class="main"><span class="main">,</span></span> a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
  
    x1 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x2 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x3 <span class="main"><span class="main">=</span></span> add <span class="main"><span class="main">(</span></span>x1<span class="main"><span class="main">-</span></span>x2<span class="main"><span class="main">,</span></span> a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
  
    x1 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x2 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x3 <span class="main"><span class="main">=</span></span> add <span class="main"><span class="main">(</span></span>x1<span class="main"><span class="main">-</span></span>x2<span class="main"><span class="main">,</span></span> a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
  
    x1 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x2 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x3 <span class="main"><span class="main">=</span></span> add <span class="main"><span class="main">(</span></span>x1<span class="main"><span class="main">-</span></span>x2<span class="main"><span class="main">,</span></span> a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
  
    x1 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x2 <span class="main"><span class="main">=</span></span> add<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    x3 <span class="main"><span class="main">=</span></span> add <span class="main"><span class="main">(</span></span>x1<span class="main"><span class="main">-</span></span>x2<span class="main"><span class="main">,</span></span> a<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
  
    r <span class="main"><span class="main">=</span></span> x3
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>  

<span class="keyword1"><span class="command">lemmas</span></span> nat_distribs <span class="main">=</span> nat_add_distrib nat_diff_distrib Suc_diff_le nat_mult_distrib nat_div_distrib 
  
<span class="keyword1"><span class="command">recursive_spec</span></span> 
  <span class="keyword2"><span class="keyword">relation</span></span> <span class="quoted"><span class="quoted">‹measure nat›</span></span>
  <span class="entity">foo</span> <span class="main">(</span>a<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">≥</span><span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> b<span class="main"><span class="main">=</span></span>1
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
        b <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> foo <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
        b <span class="main"><span class="main">=</span></span> 2 <span class="main"><span class="main">*</span></span> b
      <span class="main"><span class="main">}</span></span>
    ›</span>
  <span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">vcg_specs</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nat_distribs <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Suc_pred le0 le_less nat_0_iff not_le power_Suc<span class="main">)</span>
  
<span class="keyword1"><span class="command">thm</span></span> foo_spec  
  
  
<span class="keyword1"><span class="command">recursive_spec</span></span> 
  <span class="entity">odd</span> <span class="main">(</span>a<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">≥</span><span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> odd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> b<span class="main"><span class="main">=</span></span>0
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
        b <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> even <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">}</span></span>
    ›</span>
  <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">even</span> <span class="main">(</span>a<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">≥</span><span class="main">0</span>›</span></span>
    <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> even <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> b<span class="main"><span class="main">=</span></span>1
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
        b <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> odd <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">}</span></span>
    ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

<span class="keyword1"><span class="command">thm</span></span> even_spec odd_spec
  

    
<span class="keyword2"><span class="keyword">end</span></span>  

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Quickstart_Guide">
<div class="head">
<h1>Theory Quickstart_Guide</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Quickstart Guide›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Quickstart_Guide
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="IMP2.html">../IMP2</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Introductory Examples›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹IMP2 provides commands to define program snippets or procedures together with their specification.›</span></span>

  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">div_ab</span> <span class="main">(</span>a<span class="main">,</span>b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> c 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span>›</span></span> 
    <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span><span class="main">=</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">div</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> 
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹c <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">/</span></span>b›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The specification consists of the signature (name, parameters, return variables),
    precondition, postcondition, and program text.›</span></span>  
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    <span class="antiquoted"><span class="antiquoted">➧</span></span>[Signature] The procedure name and variable names must be valid Isabelle names. 
      The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>returns›</span></span></span></span> declaration is optional, by default, nothing is returned. 
      Multiple values can be returned by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>returns (x<span class="hidden">⇩</span><sub>1</sub>,...,x<span class="hidden">⇩</span><sub>n</sub>)›</span></span></span></span>.
      
    <span class="antiquoted"><span class="antiquoted">➧</span></span>[Precondition] An Isabelle formula. Parameter names are valid variables.
    <span class="antiquoted"><span class="antiquoted">➧</span></span>[Postcondition] An Isabelle formula over the return variables, and parameter names suffixed with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span>.
    <span class="antiquoted"><span class="antiquoted">➧</span></span>[Program Text] The procedure body, in a C-like syntax.
  ›</span></span>  
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> procedure_spec<span class="antiquote"><span class="antiquote">}</span></span></span></span> command will open a proof to show that the program satisfies the specification.
    The default way of discharging this goal is by using IMP2's verification condition generator, followed by
    manual discharging of the generated VCs as necessary.
    
    Note that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">method</span></span> vcg_cs<span class="antiquote"><span class="antiquote">}</span></span></span></span> method will apply <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">method</span></span> clarsimp<span class="antiquote"><span class="antiquote">}</span></span></span></span> to all generated VCs, which, in our case,
    already solves them. You can use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">method</span></span> vcg<span class="antiquote"><span class="antiquote">}</span></span></span></span> to get the raw VCs.
  ›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the VCs have been discharged, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> procedure_spec<span class="antiquote"><span class="antiquote">}</span></span></span></span> adds prologue and epilogue code 
    for parameter passing, defines a constant for the procedure, and lifts the pre- and postcondition  
    over the constant definition.
  ›</span></span>
  <span class="keyword1"><span class="command">thm</span></span> div_ab_spec <span class="comment1">― ‹Final theorem proved›</span>
  <span class="keyword1"><span class="command">thm</span></span> div_ab_def  <span class="comment1">― ‹Constant definition, with parameter passing code›</span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The final theorem has the form <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹HT_mods <span class="free"><span class="free">π</span></span> <span class="free"><span class="free">vs</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">Q</span></span>›</span></span></span></span>,
    where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>π›</span></span></span></span> is an arbitrary procedure environment, 
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>vs›</span></span></span></span> is a syntactic approximation of the (global) variables modified by the procedure,
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P,Q›</span></span></span></span> are the pre- and postcondition, lifted over the parameter passing code,
    and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> is the defined constant for the procedure. 
  
    The precondition is a function <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹state<span class="main"><span class="main">⇒</span></span>bool›</span></span></span></span>. It starts with a series of variable bindings 
    that map program variables to logical variables,
    followed by precondition that was specified, wrapped in a <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span>‹BB_PROTECT›</span></span> constant, 
    which serves as a tag for the VCG, and is defined as the identity (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> BB_PROTECT_def<span class="antiquote"><span class="antiquote">}</span></span></span></span>).
    
    The final theorem is declared to the VCG, such that the specification will be 
    used automatically for calls to this procedure.
  ›</span></span>
  
  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">use_div_ab</span><span class="main">(</span>a<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">≠</span><span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">=</span><span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹r <span class="main"><span class="main">=</span></span> div_ab<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">)</span></span>›</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Variant and Invariant Annotations›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Loops must be annotated with variants and invariants.›</span></span>
  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">mult_ab</span><span class="main">(</span>a<span class="main">,</span>b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> c <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹True›</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">=</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">*</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">&lt;</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>a <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">-</span></span>a<span class="main"><span class="main">;</span></span> b <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">-</span></span>b<span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    c<span class="main"><span class="main">=</span></span>0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">a</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">≤</span><span class="main">¦</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">¦</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span> <span class="main">¦</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">¦</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> sgn <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>b<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">-</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The variant and invariant can use the program variables.
    Variables suffixed with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span> refer to the values of parameters at the start of the program.
  
    The variant must be an expression of type <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹int›</span></span></span></span>, which decreases with every loop iteration and is always <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>≥0›</span></span></span></span>.
    
    <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">❙</span></span>‹Pitfall›</span></span>: If the variant has a more general type, e.g., <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="tfree"><span class="tfree">'a</span></span>›</span></span></span></span>, an explicit type annotation
      must be added. Otherwise, you'll get an ugly error message directly from Isabelle's type checker!
  ›</span></span>  
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Recursive Procedures›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹IMP2 supports mutually recursive procedures. All procedures of a mutually recursive specification
    have to be specified and proved simultaneously. 
    
    Each procedure has to be annotated with a variant over the parameters. 
    On a recursive call, the variant of the callee for the arguments must be smaller than the 
    variant of the caller (for its initial arguments).
    
    Recursive invocations inside the specification have to be tagged by the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rec›</span></span></span></span> keyword.
  ›</span></span>

  <span class="keyword1"><span class="command">recursive_spec</span></span>
    <span class="entity">odd_imp</span><span class="main">(</span>n<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> odd <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span> 
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> b<span class="main"><span class="main">=</span></span>0 <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> b<span class="main"><span class="main">=</span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> even_imp<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span>›</span>
  <span class="keyword2"><span class="keyword">and</span></span>
    <span class="entity">even_imp</span><span class="main">(</span>n<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> even <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span> 
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> b<span class="main"><span class="main">=</span></span>1 <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> b<span class="main"><span class="main">=</span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> odd_imp<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span>›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹After proving the VCs, constants are defined as usual, and the correctness theorems 
    are lifted and declared to the VCG for future use.›</span></span>  
  <span class="keyword1"><span class="command">thm</span></span> odd_imp_spec even_imp_spec
    
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The VCG›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The VCG is designed to produce human-readable VCs. 
    It takes care of presenting the VCs with reasonable variable names, 
    and a location information from where a VC originates.
  ›</span></span>
  
  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">mult_ab'</span><span class="main">(</span>a<span class="main">,</span>b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> c <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹True›</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">=</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">*</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">&lt;</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>a <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">-</span></span>a<span class="main"><span class="main">;</span></span> b <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">-</span></span>b<span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    c<span class="main"><span class="main">=</span></span>0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">a</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">≤</span><span class="main">¦</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">¦</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span> <span class="main">¦</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">¦</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> sgn <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>b<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">-</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="main"><span class="main">¶</span></span><span class="free"><span class="free">xxx</span></span>›</span></span></span></span> tags in the premises give a hint to the origin of each VC. 
    Moreover, the variable names are derived from the actual variable names in the program.›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  
  <span class="comment1">(* program-spec, procedure-spec   *)</span>
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Advanced Features›</span></span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Custom Termination Relations›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Both for loops and recursive procedures, a custom termination relation can be specified, with the 
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>relation›</span></span></span></span> annotation. The variant must be a function into the domain of this relation.
  
  <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">❙</span></span>‹Pitfall›</span></span>: You have to ensure, by type annotations, that the most general type of 
    the relation and variant fit together. Otherwise, ugly low-level errors will be the result.
  ›</span></span>
  
  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">mult_ab''</span><span class="main">(</span>a<span class="main">,</span>b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> c <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹True›</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">=</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">*</span><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">&lt;</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>a <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">-</span></span>a<span class="main"><span class="main">;</span></span> b <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">-</span></span>b<span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    c<span class="main"><span class="main">=</span></span>0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@relation</span></span> <span class="quoted"><span class="quoted">‹measure nat›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">a</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">≤</span><span class="main">¦</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">¦</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span> <span class="main">¦</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">¦</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> sgn <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>b<span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">-</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">recursive_spec</span></span> <span class="keyword2"><span class="keyword">relation</span></span> <span class="quoted"><span class="quoted">‹measure nat›</span></span>
    <span class="entity">odd_imp'</span><span class="main">(</span>n<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> odd <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span> 
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> b<span class="main"><span class="main">=</span></span>0 <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> b<span class="main"><span class="main">=</span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> even_imp'<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span>›</span>
  <span class="keyword2"><span class="keyword">and</span></span>
    <span class="entity">even_imp'</span><span class="main">(</span>n<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> even <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span> 
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> b<span class="main"><span class="main">=</span></span>1 <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> b<span class="main"><span class="main">=</span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> odd_imp'<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span>›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Correctness›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹IMP2 supports partial correctness proofs only for while-loops. 
    Recursive procedures must always be proved totally correct<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">⁋</span></span>‹Adding partial correctness for recursion 
      is possible, however, compared to total correctness, showing that the prove rule is sound 
      requires some effort that we have not (yet) invested.›</span></span>›</span></span>
  
  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="main">(</span>partial<span class="main">)</span> <span class="entity">nonterminating</span><span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> a <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">=</span><span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">defines</span></span> 
    <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹True›</span></span>
      a<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">-</span></span>1›</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
      
        
      
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Arrays›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹IMP2 provides one-dimensional arrays of integers, which are indexed by integers.
    Arrays do not have to be declared or allocated. By default, every index maps to zero.
    
    In the specifications, arrays are modeled as functions of type <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹int<span class="main"><span class="main">⇒</span></span>int›</span></span></span></span>.
  ›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> array_sum_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">≤</span><span class="free">l</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">l</span> <span class="main">{</span><span class="free">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="free">l</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">array_sum</span><span class="main">(</span>a<span class="main">,</span>l<span class="main">,</span>h<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> s <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">i</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">defines</span></span> 
    <span class="quoted">‹ s<span class="main"><span class="main">=</span></span>0<span class="main"><span class="main">;</span></span> 
      <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> 
        <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">l</span>›</span></span>
        <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">≤</span><span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span><span class="main">)</span>›</span></span>
      <span class="main"><span class="main">{</span></span> s <span class="main"><span class="main">=</span></span> s<span class="main"><span class="main">+</span></span>a<span class="main"><span class="main">[</span></span>l<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span> l<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">+</span></span>1 <span class="main"><span class="main">}</span></span> ›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> array_sum_aux<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    

  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proving Techniques›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section contains a small collection of techniques to tackle large proofs.›</span></span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prove auxiliary lemmas, and try to keep the actual proof of the specification small.
    As a rule of thumb: All VCs that cannot be solved by a simple <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">method</span></span> auto<span class="antiquote"><span class="antiquote">}</span></span></span></span> invocation
    should go to an auxiliary lemma. 
    
    The auxiliary lemma may either re-state the whole VC, or only prove the ``essence'' of the VC, 
    such that the rest of its proof becomes automatic again.
    See the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> array_sum<span class="antiquote"><span class="antiquote">}</span></span></span></span> program above for an example or the latter case.
    
    <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">❙</span></span>‹Pitfall›</span></span> When extracting auxiliary lemmas, it is too easy to get too general types, which
      may render the lemmas unprovable. As an example, omitting the explicit type constraints
      from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] "array_sum_aux"<span class="antiquote"><span class="antiquote">}</span></span></span></span> will yield an unprovable statement.
  ›</span></span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Inlining›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹More complex procedure bodies can be modularized by either splitting them into 
    multiple procedures, or using inlining and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> program_spec<span class="antiquote"><span class="antiquote">}</span></span></span></span> to explicitly prove a 
    specification for a part of a program. Cf.\ the insertion sort example for the latter technique. ›</span></span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Refinement›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    Sometimes, it makes sense to state the algorithm functionally first, and then prove that
    the implementation behaves like the functional program, and, separately, that the functional 
    program is correct. Cf.\ the mergesort example.
  ›</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Data Refinement›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Moreover, it sometimes makes sense to abstract the concrete variables to abstract types, 
    over which the algorithm is then specified. For example, an array <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span> with a range <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l..&lt;h›</span></span></span></span> can 
    be understood as a list. Or an array can be used as a bitvector set. 
    Cf.\ the mergesort and dedup examples. ›</span></span>  
  
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Troubleshooting›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We list a few common problems and their solutions here›</span></span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invalid Variables in Annotations›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Undeclared variables in annotations are highlighted, however, no warning or error is produced. 
  Usually, the generated VCs will not be provable. The most common mistake is to 
  forget the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span><span class="hidden">⇩</span><sub>0</sub>›</span></span></span></span> suffix when referring to parameter values in (in)variants and postconditions.›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note the highlighting of unused variables in the following example›</span></span>
  <span class="keyword1"><span class="command">procedure_spec</span></span> foo<span class="main">(</span>x1<span class="main">,</span>x2<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> y <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span><span class="main">&gt;</span><span class="skolem">x2</span><span class="main">+</span><span class="free">x3</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x1<span class="hidden">⇩</span><sub>0</sub></span><span class="main">+</span><span class="free">x2</span>"</span></span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
      y<span class="main"><span class="main">=</span></span>0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>x1<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">+</span> <span class="free">x3</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span><span class="main">&gt;</span><span class="free">x3</span>›</span></span>
      <span class="main"><span class="main">{</span></span>
        x1<span class="main"><span class="main">=</span></span>x2
      <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command">oops</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Even worse, if the most general type of an annotation becomes too general,
    as free variables have type <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="tfree"><span class="tfree">'a</span></span>›</span></span></span></span> by default, you will see an internal type error.
    
    Try replacing the variant or invariant with a free variable in the above example.
  ›</span></span> <span class="comment1">(* TODO: Is there an expects-error unit-test command in Isabelle already? *)</span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Wrong Annotations›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For total correctness, you must annotate a loop variant and invariant. 
    For partial correctness, you must annotate an invariant, but <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">❙</span></span>‹no variant›</span></span>.
    
    When not following this rule, the VCG will get stuck in an internal state
  ›</span></span>

  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="main">(</span>partial<span class="main">)</span> foo <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span> <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹True›</span></span>
    <span class="main"><span class="main">{</span></span> n<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">-</span></span>1 <span class="main"><span class="main">}</span></span>
  ›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
    <span class="keyword1"><span class="command">oops</span></span>
    
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Calls to Undefined Procedures›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Calling an undefined procedure usually results in a type error, as the procedure 
    name gets interpreted as an Isabelle term, e.g., either it refers to an existing constant, 
    or is interpreted as a free variable›</span></span>
  
  <span class="comment1">(* term ‹<span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span>‹ undefined() ›› (* Type unification failed *) *)</span>
    
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Missing Features›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is an (incomplete) list of missing features.›</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Elaborate Warnings and Errors›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Currently, the IMP2 tools only produce minimal error and warning messages.
    Quite often, the user sees the raw error message as produced by Isabelle unfiltered, 
    including all internal details of the tools. 
  ›</span></span>
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Static Type Checking›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We do no static type checking at all. 
    In particular, we do not check, nor does our semantic enforce, that procedures are called 
    with the same number of arguments as they were declared. 
    Programs that violate this convention may even have provable properties, as argument 
    and parameter passing is modeled as macros on top of the semantics, and the semantics has no
    notion of failure.
  ›</span></span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Structure Types›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every variable is an integer arrays. Plain integer variables are implemented as 
    macros on top of this, by referring to index <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span>.
    
    The most urgent addition to increase usability would be record types. 
    With them, we could model encapsulation and data refinement more explicitly, by
    collecting all parts of a data structure in a single (record-typed) variable.

    An easy way of adding record types would follow a similar route as arrays, 
    modeling values of variables as a recursive tree-structured datatype.
    
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory_text</span></span> [display] <span class="raw_text"><span class="raw_text">‹<span class="keyword1"><span class="command"><span class="keyword1"><span class="command">datatype</span></span></span></span> val <span class="main"><span class="main">=</span></span> PRIM int <span class="main"><span class="main">|</span></span> STRUCT <span class="quoted"><span class="quoted">"fname ⇒ val"</span></span> <span class="main"><span class="main">|</span></span> ARRAY <span class="quoted"><span class="quoted">"int ⇒ val"</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

    However, for modeling the semantics, we most likely want to introduce an explicit error state,
    to distinguish type errors (e.g. accessing a record field of an integer value) from nontermination.
    ›</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Function Calls as Expressions›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Currently, function calls are modeled as statements, and thus, cannot be nested into 
    expressions. Doing so would require to simultaneously specify the semantics of 
    commands and expressions, which makes things more complex. 
    
    As the language is intended to be simple, we have not done this.
  ›</span></span>
    
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Ghost Variables›</span></span>  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Ghost variables are a valuable tool for expressing (data) refinement, 
    and hinting the VCG towards the abstract algorithm structure.
    
    We believe that we can add ghost variables with annotations on top of the VCG,
    without actually changing the program semantics.
  ›</span></span>
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Concurrency›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹IMP2 is a single threaded language. 
    We have no current plans to add concurrency, as this would greatly complicate both the 
    semantics and the VCG, which is contrary to the goal of a simple language for educational 
    purposes.
  ›</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pointers and Memory›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Adding pointers and memory allocation to IMP2 is theoretically possible, but, again, 
    this would complicate the semantics and the VCG.

    However, as the author has some experience in VCGs using separation logic, he might actually
    add pointers and memory allocation to IMP2 in the near future.
  ›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="IMP2_from_IMP">
<div class="head">
<h1>Theory IMP2_from_IMP</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Introduction to IMP2-VCG, based on IMP›</span></span>
<span class="keyword1"><span class="command">theory</span></span> IMP2_from_IMP
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="IMP2.html">../IMP2</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This document briefly introduces the extensions of IMP2 over IMP.›</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fancy Syntax›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Standard Syntax›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exp_count_up1</span> <span class="main">≡</span> 
    <span class="inner_quoted">''a''</span> <span class="main">::=</span> N <span class="main">1</span><span class="main">;;</span>
    <span class="inner_quoted">''c''</span> <span class="main">::=</span> N <span class="main">0</span><span class="main">;;</span>
    <span class="keyword1">WHILE</span> Cmpop <span class="main">(&lt;)</span> <span class="main">(</span>V <span class="inner_quoted">''c''</span><span class="main">)</span> <span class="main">(</span>V <span class="inner_quoted">''n''</span><span class="main">)</span> <span class="keyword1">DO</span> <span class="main">(</span>
      <span class="inner_quoted">''a''</span> <span class="main">::=</span> Binop <span class="main">(*)</span> <span class="main">(</span>N <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>V <span class="inner_quoted">''a''</span><span class="main">)</span><span class="main">;;</span> 
      <span class="inner_quoted">''c''</span> <span class="main">::=</span> Binop <span class="main">(+)</span> <span class="main">(</span>V <span class="inner_quoted">''c''</span><span class="main">)</span> <span class="main">(</span>N <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="comment1">(* Type \ &lt; ^ imp &gt; \open \close , without the spaces.
  
    for ‹…›, there is an autocompletion if you type a quote (")
    
    for ― ‹›, type \comment and use autocompletion
    
  *)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Fancy Syntax›</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">exp_count_up2</span> <span class="main">≡</span> <span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹
    <span class="comment1">― ‹Initialization›</span>
    a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span> <span class="comment1">― ‹Iterate until <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>c›</span></span> has reached <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>n›</span></span>›</span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span> <span class="comment1">― ‹Double <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>a›</span></span>›</span>
      c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1  <span class="comment1">― ‹Increment <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>c›</span></span>›</span>
    <span class="main"><span class="main">}</span></span>
  ›</span>"</span></span>    
      
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"exp_count_up1 <span class="main">=</span> exp_count_up2"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> exp_count_up1_def exp_count_up2_def <span class="keyword1"><span class="command">..</span></span>
  
  

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operators and Arrays›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We reflect arbitrary Isabelle functions into the syntax: ›</span></span>
  <span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"bval <span class="main">(</span>Cmpop <span class="main">(≤)</span> <span class="main">(</span>Binop <span class="main">(+)</span> <span class="main">(</span>Unop uminus <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">42</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">50</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span><span class="inner_quoted">''x''</span><span class="main">:=</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">-</span><span class="numeral">5</span><span class="main">)</span><span class="main">&gt;</span> "</span></span>
    
  <span class="keyword1"><span class="command">thm</span></span> aval.simps bval.simps

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every variable is an array, indexed by integers, no bounds.
    Syntax shortcuts to access index 0.
  ›</span></span>  

  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹Vidx <span class="inner_quoted">''a''</span> <span class="main">(</span><span class="free">i</span><span class="main">::</span>aexp<span class="main">)</span>›</span></span> <span class="comment1">― ‹Array access at index <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>i›</span></span>›</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"V <span class="inner_quoted">''x''</span> <span class="main">=</span> Vidx <span class="inner_quoted">''x''</span> <span class="main">(</span>N <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span> <span class="comment1">― ‹Shortcut for access at index <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>0›</span></span>›</span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹New commands:›</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹AssignIdx <span class="inner_quoted">''a''</span> <span class="main">(</span><span class="free">i</span><span class="main">::</span>aexp<span class="main">)</span> <span class="main">(</span><span class="free">v</span><span class="main">::</span>aexp<span class="main">)</span>›</span></span> <span class="comment1">― ‹Assign at index. Replaces assign.›</span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="inner_quoted">''a''</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">::=</span> <span class="free">v</span>›</span></span>  <span class="comment1">― ‹Standard syntax›</span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹ a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> v ›</span>›</span></span> <span class="comment1">― ‹Fancy syntax›</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">‹Assign <span class="inner_quoted">''x''</span> <span class="free">v</span> <span class="main">=</span> AssignIdx <span class="inner_quoted">''x''</span> <span class="main">(</span>N <span class="main">0</span><span class="main">)</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">..</span></span> <span class="comment1">― ‹Shortcut for assignment to index <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>0›</span></span>›</span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="inner_quoted">''x''</span> <span class="main">::=</span> <span class="free">v</span>›</span></span> <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹x <span class="main"><span class="main">=</span></span> v<span class="main"><span class="main">+</span></span>1›</span>›</span></span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note: In fancy syntax, assignment between variables is always parsed as array copy.
    This is no problem unless a variable is used as both, array and plain value, 
    which should be avoided anyway.
  ›</span></span>
    
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹ArrayCpy <span class="inner_quoted">''d''</span> <span class="inner_quoted">''s''</span>›</span></span> <span class="comment1">― ‹Copy whole array. Both operands are variable names.›</span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="inner_quoted">''d''</span><span class="main">[]</span> <span class="main">::=</span> <span class="inner_quoted">''s''</span>›</span></span> <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹d <span class="main"><span class="main">=</span></span> s›</span>›</span></span>
  
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹ArrayClear <span class="inner_quoted">''a''</span>›</span></span> <span class="comment1">― ‹Initialize array to all zeroes.›</span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">CLEAR</span> <span class="inner_quoted">''a''</span><span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹<span class="keyword2"><span class="keyword"><span class="keyword2">clear</span></span></span> a<span class="main"><span class="main">[]</span></span>›</span>›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Semantics of these is straightforward›</span></span>
  <span class="keyword1"><span class="command">thm</span></span> big_step.AssignIdx big_step.ArrayCpy big_step.ArrayClear
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Local and Global Variables›</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹is_global›</span></span> <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹is_local›</span></span> <span class="comment1">― ‹Partitions variable names›</span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main">&lt;</span><span class="free">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">|</span><span class="free">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">&gt;</span>›</span></span> <span class="comment1">― ‹State with locals from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>s<span class="hidden">⇩</span><sub>1</sub>›</span></span> and globals from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>s<span class="hidden">⇩</span><sub>2</sub>›</span></span>›</span>
  
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">SCOPE</span> <span class="free">c</span>›</span></span> <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹<span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> <span class="main"><span class="main">{</span></span> <span class="keyword2"><span class="keyword"><span class="keyword2">skip</span></span></span> <span class="main"><span class="main">}</span></span>›</span>›</span></span>    <span class="comment1">― ‹Execute <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>c›</span></span> with fresh set of local variables›</span>
  <span class="keyword1"><span class="command">thm</span></span> big_step.Scope
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Parameter Passing›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Parameters and return values by global variables: This is syntactic sugar only:›</span></span>
  <span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted">com</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹ <span class="main"><span class="main">(</span></span>r1<span class="main"><span class="main">,</span></span>r2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> f<span class="main"><span class="main">(</span></span>x1<span class="main"><span class="main">,</span></span>x2<span class="main"><span class="main">,</span></span>x3<span class="main"><span class="main">)</span></span>›</span>›</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
  
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Recursive procedures›</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹PCall <span class="inner_quoted">''name''</span>›</span></span> 
  <span class="keyword1"><span class="command">thm</span></span> big_step.PCall
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Procedure Scope›</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Execute command with local set of procedures›</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹PScope <span class="free">π</span> <span class="free">c</span>›</span></span>
  <span class="keyword1"><span class="command">thm</span></span> big_step.PScope
  
  <span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Syntactic sugar for procedure call with parameters›</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="hidden">\&lt;^</span><span class="control">imp</span><span class="hidden">&gt;</span></span><span class="inner_cartouche">‹<span class="main"><span class="main">(</span></span>r1<span class="main"><span class="main">,</span></span>r2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> name<span class="main"><span class="main">(</span></span>x1<span class="main"><span class="main">,</span></span>x2<span class="main"><span class="main">,</span></span>x3<span class="main"><span class="main">)</span></span>›</span>›</span></span>
  
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹More Readable VCs›</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> nat_distribs <span class="main">=</span> nat_add_distrib nat_diff_distrib Suc_diff_le nat_mult_distrib nat_div_distrib
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> wlp <span class="free">π</span> exp_count_up1 <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="inner_quoted">''a''</span> <span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> exp_count_up1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> annotate_whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
          I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="main">∧</span>  <span class="bound">s</span> <span class="inner_quoted">''a''</span> <span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> nat <span class="main">(</span><span class="bound">s</span> <span class="inner_quoted">''c''</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span> <span class="inner_quoted">''c''</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="inner_quoted">''c''</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span>"</span></span> 
        <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">i_vcg_preprocess</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">i_vcg_gen</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The postprocessor converts from states applied to string names to actual variables›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">i_vcg_postprocess</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>
        
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> wlp <span class="free">π</span> exp_count_up1 <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="inner_quoted">''a''</span> <span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="main">(</span><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> exp_count_up1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> annotate_whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
          I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="main">∧</span>  <span class="bound">s</span> <span class="inner_quoted">''a''</span> <span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> nat <span class="main">(</span><span class="bound">s</span> <span class="inner_quoted">''c''</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span> <span class="inner_quoted">''c''</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="inner_quoted">''c''</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span>"</span></span> 
        <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The postprocessor is invoked by default›</span></span>    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
    <span class="keyword1"><span class="command">oops</span></span>
    
    
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification Commands›</span></span>    
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹IMP2 provides a set of commands to simplify specification and annotation of programs.›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Old way of proving a specification: ›</span></span>  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="keyword1">in</span> <span class="bound">n</span> <span class="main">≥</span> <span class="main">0</span> 
    <span class="main">⟹</span> wlp <span class="free">π</span> exp_count_up1 <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">s</span> <span class="inner_quoted">''a''</span> <span class="main">0</span><span class="main">;</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="keyword1">in</span> <span class="bound">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="main">(</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> exp_count_up1_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> annotate_whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
          I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="main">=</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span> <span class="main">∧</span>  <span class="bound">s</span> <span class="inner_quoted">''a''</span> <span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> nat <span class="main">(</span><span class="bound">s</span> <span class="inner_quoted">''c''</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">s</span> <span class="inner_quoted">''c''</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">s</span> <span class="inner_quoted">''c''</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="inner_quoted">''n''</span> <span class="main">0</span>"</span></span> 
          <span class="comment1">(* Similar for invar! *)</span>
        <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"VAR <span class="main">(</span><span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span><span class="main">=</span><span class="free">s</span> <span class="free">x</span> <span class="keyword1">in</span> <span class="free">P</span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> VAR_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹IMP2 specification commands›</span></span>
  <span class="keyword1"><span class="command">program_spec</span></span> <span class="main">(</span>partial<span class="main">)</span> <span class="entity">exp_count_up</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>               <span class="comment1">― ‹Precondition. Use variable names of program.›</span>
    <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>       <span class="comment1">― ‹Postcondition. Use variable names of programs. 
                                      Suffix with <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>⋅<span class="hidden">⇩</span><sub>0</sub>›</span></span> to refer to initial state›</span>
    <span class="keyword2"><span class="keyword">defines</span></span>                     <span class="comment1">― ‹Program›</span>
    <span class="quoted">‹
      a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
      c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> 
        <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">c</span> <span class="main">∧</span> <span class="main">0</span><span class="main">≤</span><span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span><span class="main">≤</span><span class="skolem">n</span>›</span></span> <span class="comment1">― ‹
            Invar annotation. Variable names and suffix <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>⋅<span class="hidden">⇩</span><sub>0</sub>›</span></span> for variables from initial state.›</span>
      <span class="main"><span class="main">{</span></span>
        a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
        c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1
      <span class="main"><span class="main">}</span></span>
    ›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>

  <span class="keyword1"><span class="command">thm</span></span> exp_count_up_spec  
  <span class="keyword1"><span class="command">thm</span></span> exp_count_up_def
      
  <span class="comment1">(* 
    We can also annotate 
      @variant ‹measure-expression› 
        (interpreted over variables (v) and variables at program start (v<span class="hidden">⇩</span><sub>0</sub>) 
        
    or, both @variant ‹…› and @relation ‹R›:
      R :: 'a rel, and variant produces an 'a
      
  *)</span>
          
  
  <span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">exp_count_up_proc</span><span class="main">(</span>n<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> a
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>               
    <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>      
    <span class="keyword2"><span class="keyword">defines</span></span>                     
    <span class="quoted">‹
      a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
      c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> 
        <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">=</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">c</span> <span class="main">∧</span> <span class="main">0</span><span class="main">≤</span><span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span><span class="main">≤</span><span class="skolem">n</span>›</span></span> 
        <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">-</span><span class="skolem">c</span>›</span></span>
      <span class="main"><span class="main">{</span></span>
        a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
        c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1
      <span class="main"><span class="main">}</span></span>
    ›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simple Recursion›</span></span>
  <span class="keyword1"><span class="command">recursive_spec</span></span> 
    <span class="entity">exp_rec</span><span class="main">(</span>n<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> a <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> a<span class="main"><span class="main">=</span></span>1 <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>t<span class="main"><span class="main">=</span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> exp_rec<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>t<span class="main"><span class="main">}</span></span>›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_le_D diff_Suc_Suc dvd_1_left dvd_imp_le minus_nat.diff_0 nat_0_iff nat_int neq0_conv of_nat_0 order_class.order.antisym pos_int_cases power_Suc zless_nat_eq_int_zless<span class="main">)</span>
    
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mutual Recursion: See Examples›</span></span>
        

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Examples
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="IMP2.html">../IMP2</a>"</span> <span class="quoted">"<a href="IMP2_Aux_Lemmas.html">../lib/IMP2_Aux_Lemmas</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>  
<span class="keyword1"><span class="command">lemmas</span></span> nat_distribs <span class="main">=</span> nat_add_distrib nat_diff_distrib Suc_diff_le nat_mult_distrib nat_div_distrib

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Common Loop Patterns›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Count Up›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Counter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> counts from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span>, such that loop is executed <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> times. 
  The result is computed in an accumulator <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The invariant states that we have computed the function for the counter value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span>›</span></span>  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The variant is the difference between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span>, i.e., the number of 
  loop iterations that we still have to do›</span></span>  


<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">exp_count_up</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    c <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>c<span class="main"><span class="main">&lt;</span></span>n<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">-</span><span class="skolem">c</span>›</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">c</span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">c</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      G_par <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">;</span></span>   <span class="keyword2"><span class="keyword"><span class="keyword1">scope</span></span></span> <span class="main"><span class="main">{</span></span> a <span class="main"><span class="main">=</span></span> G_par<span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span> G_ret <span class="main"><span class="main">=</span></span> a <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span> a <span class="main"><span class="main">=</span></span> G_ret<span class="main"><span class="main">;</span></span>
      c<span class="main"><span class="main">=</span></span>c<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">sum_prog</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    s <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    i <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>i <span class="main"><span class="main">&lt;</span></span> n<span class="main"><span class="keyword1">)</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="skolem">i</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">i</span><span class="main">}</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      i <span class="main"><span class="main">=</span></span> i <span class="main"><span class="main">+</span></span> 1<span class="main"><span class="main">;</span></span>
      s <span class="main"><span class="main">=</span></span> s <span class="main"><span class="main">+</span></span> i
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intvs_incdec<span class="main">)</span>
  
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">sq_prog</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    z <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    i <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>i <span class="main"><span class="main">&lt;</span></span> n<span class="main"><span class="keyword1">)</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="skolem">i</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      a <span class="main"><span class="main">=</span></span> a <span class="main"><span class="main">+</span></span> z<span class="main"><span class="main">;</span></span>
      z <span class="main"><span class="main">=</span></span> z <span class="main"><span class="main">+</span></span> 2<span class="main"><span class="main">;</span></span>
      i <span class="main"><span class="main">=</span></span> i <span class="main"><span class="main">+</span></span> 1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">factorial</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">factorial</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">*</span> <span class="free">factorial</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">factorial_prog</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> factorial <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    i <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>i <span class="main"><span class="main">≤</span></span> n<span class="main"><span class="keyword1">)</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">i</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> factorial <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      a <span class="main"><span class="main">=</span></span> a <span class="main"><span class="main">*</span></span> i<span class="main"><span class="main">;</span></span>
      i <span class="main"><span class="main">=</span></span> i <span class="main"><span class="main">+</span></span> 1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> antisym_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fib</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fib</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">fib</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="free">fib</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fib_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> fib <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> fib <span class="free">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> fib <span class="free">i</span> <span class="main">=</span> fib <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> fib <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> fib.simps

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹With precondition›</span></span>
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">fib_prog</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> fib <span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span> b <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    i <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>i <span class="main"><span class="main">&lt;</span></span> n<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="skolem">i</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> fib <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">=</span> fib <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>›</span></span>    
    <span class="main"><span class="main">{</span></span>
      c <span class="main"><span class="main">=</span></span> b<span class="main"><span class="main">;</span></span>
      b <span class="main"><span class="main">=</span></span> a <span class="main"><span class="main">+</span></span> b<span class="main"><span class="main">;</span></span>
      a <span class="main"><span class="main">=</span></span> c<span class="main"><span class="main">;</span></span>
      i <span class="main"><span class="main">=</span></span> i <span class="main"><span class="main">+</span></span> 1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Without precondition, returning <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span> for negative numbers›</span></span>
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">fib_prog'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> fib <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span> b <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    i <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>i <span class="main"><span class="main">&lt;</span></span> n<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="skolem">i</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">∨</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> fib <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">=</span> fib <span class="main">(</span><span class="skolem">i</span><span class="main">+</span> <span class="main">1</span><span class="main">)</span>›</span></span>    
    <span class="main"><span class="main">{</span></span>
      c <span class="main"><span class="main">=</span></span> b<span class="main"><span class="main">;</span></span>
      b <span class="main"><span class="main">=</span></span> a <span class="main"><span class="main">+</span></span> b<span class="main"><span class="main">;</span></span>
      a <span class="main"><span class="main">=</span></span> c<span class="main"><span class="main">;</span></span>
      i <span class="main"><span class="main">=</span></span> i <span class="main"><span class="main">+</span></span> 1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Count down›</span></span>  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Essentially the same as count up, but we (ab)use the input variable as a counter.›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The invariant is the same as for count-up. 
  Only that we have to compute the actual number
  of loop iterations by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n<span class="hidden">⇩</span><sub>0</sub> - n›</span></span></span></span>. We locally introduce the name <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> for that.
›</span></span>  
  

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">exp_count_down</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">-</span><span class="skolem">n</span> <span class="keyword1">in</span> <span class="main">0</span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">n</span><span class="main">≤</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="numeral">2</span><span class="main">^</span>nat <span class="bound">c</span>›</span></span>    
    <span class="main"><span class="main">{</span></span>
      a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
      n<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">-</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_distribs<span class="main">)</span>

  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Approximate from Below›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Used to invert a monotonic function. 
  We count up, until we overshoot the desired result, 
  then we subtract one. 
›</span></span>  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The invariant states that the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r-1›</span></span></span></span> is not too big.
  When the loop terminates, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r-1›</span></span></span></span> is not too big, but <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> is already too big,
  so <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r-1›</span></span></span></span> is the desired value (rounding down).
›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The variant measures the gap that we have to the correct result.
  Note that the loop will do a final iteration, when the result has been reached 
  exactly. We account for that by adding one, such that the measure also decreases in this case.
›</span></span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">sqr_approx_below</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span>  
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">r</span> <span class="main">∧</span> <span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">r</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    r<span class="main"><span class="main">=</span></span>1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>r<span class="main"><span class="main">*</span></span>r <span class="main"><span class="main">≤</span></span> n<span class="main"><span class="keyword1">)</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">*</span><span class="skolem">r</span>›</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">r</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">r</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>    
      <span class="main"><span class="main">{</span></span> r <span class="main"><span class="main">=</span></span> r <span class="main"><span class="main">+</span></span> 1 <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    r <span class="main"><span class="main">=</span></span> r <span class="main"><span class="main">-</span></span> 1
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Bisection›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A more efficient way of inverting monotonic functions is by bisection,
  that is, one keeps track of a possible interval for the solution, and halfs the 
  interval in each step. The program will need $O(\log n)$ iterations, and is
  thus very efficient in practice.

  Although the final algorithm looks quite simple, getting it right can be
  quite tricky.
›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The invariant is surprisingly easy, just stating that the solution 
  is in the interval <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l..&lt;h›</span></span></span></span>. ›</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span> <span class="bound">l</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> int<span class="main">.</span>
       <span class="main">⟦</span><span class="main">¶</span><span class="inner_quoted">''invar-final''</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="main">¬</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">h</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">l</span><span class="main">;</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">h</span><span class="main">;</span> <span class="bound">l</span> <span class="main">*</span> <span class="bound">l</span> <span class="main">≤</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span>
        <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="bound">h</span> <span class="main">*</span> <span class="bound">h</span><span class="main">⟧</span>
       <span class="main">⟹</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="bound">l</span> <span class="main">*</span> <span class="bound">l</span> <span class="main">+</span> <span class="bound">l</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mult.commute semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">sqr_bisect</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">≤</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&lt;</span><span class="main">(</span><span class="skolem">r</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    l<span class="main"><span class="main">=</span></span>0<span class="main"><span class="main">;</span></span> h<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">+</span></span>1 <span class="main"><span class="main">&lt;</span></span> h<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">l</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">l</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">≤</span><span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">h</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>›</span></span>    
    <span class="main"><span class="main">{</span></span>
      m <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span>l <span class="main"><span class="main">+</span></span> h<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>m<span class="main"><span class="main">*</span></span>m <span class="main"><span class="main">≤</span></span> n<span class="main"><span class="keyword1">)</span></span> l<span class="main"><span class="main">=</span></span>m <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> h<span class="main"><span class="main">=</span></span>m
    <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    r<span class="main"><span class="main">=</span></span>l
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We use quick-and-dirty apply style proof to discharge the VCs›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span> add_pos_pos<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> not_sum_squares_lt_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mult.commute semiring_normalization_rules<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Debugging›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Testing Programs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Stepwise›</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"Map.empty<span class="main">:</span> <span class="main">(</span>sqr_approx_below<span class="main">,</span><span class="main">&lt;</span><span class="inner_quoted">''n''</span><span class="main">:=</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">4</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">⇒</span> <span class="var">?s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqr_approx_below_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step'</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step'</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step'</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step'</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step'</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step'</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step'</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step'</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">big_step'</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Or all steps at once›</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"Map.empty<span class="main">:</span> <span class="main">(</span>sqr_bisect<span class="main">,</span><span class="main">&lt;</span><span class="inner_quoted">''n''</span><span class="main">:=</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">4900000001</span><span class="main">&gt;</span><span class="main">)</span> <span class="main">⇒</span> <span class="var">?s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqr_bisect_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">big_step</span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹More Numeric Algorithms›</span></span>  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Euclid's Algorithm (with subtraction)›</span></span>

<span class="comment1">(* Crucial Lemmas *)</span>
<span class="keyword1"><span class="command">thm</span></span> gcd.commute gcd_diff1

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">euclid1</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">≠</span></span>b<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹gcd <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">a</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">&gt;</span><span class="main">0</span><span class="main">)</span>›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">+</span><span class="skolem">b</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">&lt;</span></span>b<span class="main"><span class="keyword1">)</span></span> b <span class="main"><span class="main">=</span></span> b<span class="main"><span class="main">-</span></span>a
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> a <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">-</span></span>b
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> gcd.commute gcd_diff1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> gcd_diff1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Euclid's Algorithm (with mod)›</span></span>

<span class="comment1">(* Crucial Lemmas *)</span>
<span class="keyword1"><span class="command">thm</span></span> gcd_red_int<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">euclid2</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>b<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹gcd <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">&gt;</span><span class="main">0</span>›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      t <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">;</span></span>
      a <span class="main"><span class="main">=</span></span> b<span class="main"><span class="main">;</span></span>
      b <span class="main"><span class="main">=</span></span> t <span class="keyword2"><span class="keyword"><span class="quasi_keyword">mod</span></span></span> b
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd_red_int<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Extended Euclid's Algorithm›</span></span>
<span class="comment1">(* Provided by Simon Wimmer. *)</span>

<span class="keyword1"><span class="command">locale</span></span> extended_euclid_aux_lemmas <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="free">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> gcd <span class="free">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="free">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gcd <span class="free">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="main">(</span><span class="free">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">*</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">*</span> <span class="free">q</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹gcd <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd_red_int<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> aux3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">t</span> <span class="main">*</span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="free">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">*</span> <span class="main">(</span><span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">smt</span> Euclidean_Division.pos_mod_sign cancel_div_mod_rules<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mult.commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is a direct translation of the pseudocode for the Extended Euclidean algorithm
as described by the English version of Wikipedia
(<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">🌐</span></span>‹https://en.wikipedia.org/wiki/Extended_Euclidean_algorithm›</span></span>):
›</span></span>
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">euclid_extended</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">old_r</span> <span class="main">=</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">old_s</span> <span class="main">+</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">old_t</span>"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    s <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>    old_s <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    t <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>    old_t <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    r <span class="main"><span class="main">=</span></span> b<span class="main"><span class="main">;</span></span>    old_r <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>r<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹
        gcd <span class="skolem">old_r</span> <span class="skolem">r</span> <span class="main">=</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">r</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">old_r</span><span class="main">&gt;</span><span class="main">0</span>
      <span class="main">∧</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">old_s</span> <span class="main">+</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">old_t</span> <span class="main">=</span> <span class="skolem">old_r</span> <span class="main">∧</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">r</span>
      ›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      quotient <span class="main"><span class="main">=</span></span> old_r <span class="main"><span class="main">/</span></span> r<span class="main"><span class="main">;</span></span>
      temp <span class="main"><span class="main">=</span></span> old_r<span class="main"><span class="main">;</span></span>
      old_r <span class="main"><span class="main">=</span></span> r<span class="main"><span class="main">;</span></span>
      r <span class="main"><span class="main">=</span></span> temp <span class="main"><span class="main">-</span></span> quotient <span class="main"><span class="main">*</span></span> r<span class="main"><span class="main">;</span></span>
      temp <span class="main"><span class="main">=</span></span> old_s<span class="main"><span class="main">;</span></span>
      old_s <span class="main"><span class="main">=</span></span> s<span class="main"><span class="main">;</span></span>
      s <span class="main"><span class="main">=</span></span> temp <span class="main"><span class="main">-</span></span> quotient <span class="main"><span class="main">*</span></span> s<span class="main"><span class="main">;</span></span>
      temp <span class="main"><span class="main">=</span></span> old_t<span class="main"><span class="main">;</span></span>
      old_t <span class="main"><span class="main">=</span></span> t<span class="main"><span class="main">;</span></span>
      t <span class="main"><span class="main">=</span></span> temp <span class="main"><span class="main">-</span></span> quotient <span class="main"><span class="main">*</span></span> t
    <span class="main"><span class="main">}</span></span>
  ›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> extended_euclid_aux_lemmas <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aux2 aux3 minus_div_mult_eq_mod<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
    
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Non-Wikipedia version›</span></span>
<span class="keyword1"><span class="command">context</span></span> extended_euclid_aux_lemmas <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> aux<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">q</span> <span class="free">x</span> <span class="free">y</span><span class="main">::</span> <span class="quoted">int</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">old_y</span> <span class="main">*</span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">old_x</span> <span class="main">*</span> <span class="free">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">y</span> <span class="main">*</span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="free">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">div</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">mod</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="free">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">+</span> <span class="free">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">euclid_extended'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">y</span>"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    x <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    y <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    old_x <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    old_y <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>b<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹
        gcd <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> gcd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">b</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">old_x</span> <span class="main">+</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">old_y</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">*</span> <span class="skolem">y</span>
      ›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      q <span class="main"><span class="main">=</span></span> a <span class="main"><span class="main">/</span></span> b<span class="main"><span class="main">;</span></span>
      t <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">;</span></span>
      a <span class="main"><span class="main">=</span></span> b<span class="main"><span class="main">;</span></span>
      b <span class="main"><span class="main">=</span></span> t <span class="keyword2"><span class="keyword"><span class="quasi_keyword">mod</span></span></span> b<span class="main"><span class="main">;</span></span>
      t <span class="main"><span class="main">=</span></span> x<span class="main"><span class="main">;</span></span>
      x <span class="main"><span class="main">=</span></span> old_x <span class="main"><span class="main">-</span></span> q <span class="main"><span class="main">*</span></span> x<span class="main"><span class="main">;</span></span>
      old_x <span class="main"><span class="main">=</span></span> t<span class="main"><span class="main">;</span></span>
      t <span class="main"><span class="main">=</span></span> y<span class="main"><span class="main">;</span></span>
      y <span class="main"><span class="main">=</span></span> old_y <span class="main"><span class="main">-</span></span> q <span class="main"><span class="main">*</span></span> y<span class="main"><span class="main">;</span></span>
      old_y <span class="main"><span class="main">=</span></span> t
    <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    x <span class="main"><span class="main">=</span></span> old_x<span class="main"><span class="main">;</span></span>
    y <span class="main"><span class="main">=</span></span> old_y
  ›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> extended_euclid_aux_lemmas <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd_red_int<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> aux<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Exponentiation by Squaring›</span></span>
<span class="comment1">(* Contributed by Simon Wimmer *)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_by_sq_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Suc_pred power.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A classic algorithm for computing <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇧</span><sup>n</sup>›</span></span></span></span> works by repeated squaring,
using the following recurrence:
  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇧</span><sup>n</sup> = x * x<span class="hidden">⇗</span><sup>(n-1)/2</sup><span class="hidden">⇖</span>›</span></span></span></span> if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> is odd
  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x<span class="hidden">⇧</span><sup>n</sup> = x<span class="hidden">⇗</span><sup>n/2</sup><span class="hidden">⇖</span>›</span></span></span></span> if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> is even

›</span></span>
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">ex_by_sq</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">^</span> nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    r <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹
        <span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">^</span> nat <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">^</span> nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>
      ›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n <span class="keyword2"><span class="keyword"><span class="quasi_keyword">mod</span></span></span> 2 <span class="main"><span class="main">==</span></span> 1<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
        r <span class="main"><span class="main">=</span></span> r <span class="main"><span class="main">*</span></span> x
      <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
      x <span class="main"><span class="main">=</span></span> x <span class="main"><span class="main">*</span></span> x<span class="main"><span class="main">;</span></span>
      n <span class="main"><span class="main">=</span></span> n <span class="main"><span class="main">/</span></span> 2
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ex_by_sq_aux<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> Suc_1 nat_1 nat_2 nat_mod_distrib nat_one_as_int<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_int_pos_iff int_div_less_self nat_div_distrib<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> semiring_normalization_rules nat_mult_distrib<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> semiring_normalization_rules nat_mult_distrib<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Power-Tower of 2s›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tower2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tower2</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tower2</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">tower2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tower2'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> int <span class="main">(</span>tower2 <span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">program_spec</span></span> tower2_imp
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">&gt;</span><span class="main">0</span>›</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> tower2' <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a<span class="main"><span class="main">=</span></span>1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>m<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">m</span> <span class="main">∧</span> <span class="skolem">m</span><span class="main">≤</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> tower2' <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">-</span><span class="skolem">m</span><span class="main">)</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      n<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">;</span></span>
      
      a <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> 
        <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span>›</span></span> 
        <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹True›</span></span> <span class="comment1">― ‹This will get ugly, there is no <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>n<span class="hidden">⇩</span><sub>0</sub>›</span></span> that we could use!›</span>   
      <span class="main"><span class="main">{</span></span>
        a<span class="main"><span class="main">=</span></span>2<span class="main"><span class="main">*</span></span>a<span class="main"><span class="main">;</span></span>
        n<span class="main"><span class="main">=</span></span>n<span class="main"><span class="main">-</span></span>1
      <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
      
      m<span class="main"><span class="main">=</span></span>m<span class="main"><span class="main">-</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove the inner loop separately instead! 
  (It happens to be exactly our <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span>‹exp_count_down›</span></span> program.)
›</span></span>  
  
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">tower2_imp</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span><span class="main">&gt;</span><span class="main">0</span>›</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> tower2' <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    a<span class="main"><span class="main">=</span></span>1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>m<span class="main"><span class="main">&gt;</span></span>0<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">m</span> <span class="main">∧</span> <span class="skolem">m</span><span class="main">≤</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> tower2' <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">-</span><span class="skolem">m</span><span class="main">)</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      n<span class="main"><span class="main">=</span></span>a<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">e</span>xp_count_down<span class="main"><span class="main">;</span></span>
      m<span class="main"><span class="main">=</span></span>m<span class="main"><span class="main">-</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> tower2'_def nat_distribs<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Array Algorithms›</span></span>  
  
<span class="comment1">(*
  Presentation in lecture:

  introduce array syntax and semantics
    CONVENTIONS: 
      * Every variable is an array. 
      * Arrays are modeled as int⇒int. Negative indexes allowed.
      * Syntactic sugar to use it at index 0 by default
      
    V vname ↦ Vidx vname aexp  Syntax: x[i]
    abbreviation "V x = Vidx x 0"
  
    Assign vname aexp ↦ AssignIdx vname aexp aexp  Syntax: x[i] = a
    abbreviation: Assign x a = AssignIdx x 0 a
  
    NEW COMMAND: ArrayCpy vname vname Syntax: x[] = y
      copy two arrays as a whole. Assign x (V y) only copies index 0
  
  semantics: Obvious
    aval (Vidx x i) s = s x (aval i s)
    
    (x[i] = a, s) ⇒ s(x := (s x)(aval i s := aval a s))
    
    (x[] = y, s) ⇒ s(x := s y)
    
  weakest preconditions: Also obvious
    …
    
Reasoning with arrays:    
    
  Usually: Model as int⇒int is appropriate.
  
  Common idioms: 
    * {l..&lt;h} the set of indexes i, l≤i&lt;h
    * a`{l..&lt;h} the set of values in range {l..&lt;h}
  
    * ran_sorted a l h = …
    
    Warning: Sledgehammer does not perform well on these!

Data Refinement    
  Sometimes, abstraction to list may be useful.
  
  Idea: Model an algorithm on lists first. Prove it correct.
    Then implement algorithm. Show that it implements the model.
    By transitivity, get: Algorithm is correct!

  
    
  Sometimes, abstraction to list may be useful    
    
*)</span>


  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Summation›</span></span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">array_sum</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    r <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">≤</span><span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">.</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">i</span><span class="main">)</span>›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">l</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      r <span class="main"><span class="main">=</span></span> r <span class="main"><span class="main">+</span></span> a<span class="main"><span class="main">[</span></span>l<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
      l<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intvs_incdec<span class="main">)</span>
  
<span class="comment1">(* Exercise: Remove l≤h precondition! *)</span>  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finding Least Index of Element›</span></span>  
  
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">find_least_idx</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>›</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">if</span> <span class="skolem">l</span><span class="main">=</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">then</span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">`</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="keyword1">else</span> <span class="skolem">l</span><span class="main">∈</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">∉</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">`</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span> ›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">&lt;</span></span>h <span class="main"><span class="main">∧</span></span> a<span class="main"><span class="main">[</span></span>l<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">≠</span></span> x<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">l</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">≤</span><span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">∉</span><span class="skolem">a</span><span class="main">`</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span>›</span></span>
      l<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">+</span></span>1
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastLessThan_iff imageI<span class="main">)</span>
  


  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Check for Sortedness›</span></span>  
  
<span class="keyword1"><span class="command">term</span></span> <span class="quoted">ran_sorted</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">check_sorted</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>›</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> ran_sorted <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">==</span></span>h<span class="main"><span class="keyword1">)</span></span> r<span class="main"><span class="main">=</span></span>1
    <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
      l<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">&lt;</span></span>h <span class="main"><span class="main">∧</span></span> a<span class="main"><span class="main">[</span></span>l<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">≤</span></span> a<span class="main"><span class="main">[</span></span>l<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword1">)</span></span> 
        <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">l</span>›</span></span>
        <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">&lt;</span><span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span> <span class="main">∧</span> ran_sorted <span class="skolem">a</span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l</span>›</span></span>
        l<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">;</span></span>
        
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">==</span></span>h<span class="main"><span class="keyword1">)</span></span> r<span class="main"><span class="main">=</span></span>1 <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> r<span class="main"><span class="main">=</span></span>0
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_sorted_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastLessThan_iff<span class="main">)</span> 

  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Find Equilibrium Index›</span></span>  
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_equil</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">equilibrium</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>›</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹is_equil <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">h</span> <span class="skolem">i</span> <span class="main">∨</span> <span class="skolem">i</span><span class="main">=</span><span class="skolem">h</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∄</span><span class="bound">i</span><span class="main">.</span> is_equil <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">h</span> <span class="bound">i</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    usum<span class="main"><span class="main">=</span></span>0<span class="main"><span class="main">;</span></span> i<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>i<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">i</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">≤</span><span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">usum</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">=</span><span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">j</span><span class="main">)</span>›</span></span>
    <span class="main"><span class="main">{</span></span> 
      usum <span class="main"><span class="main">=</span></span> usum <span class="main"><span class="main">+</span></span> a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span> i<span class="main"><span class="main">=</span></span>i<span class="main"><span class="main">+</span></span>1 
    <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    i<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span> lsum<span class="main"><span class="main">=</span></span>0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>usum <span class="main"><span class="main">≠</span></span> lsum <span class="main"><span class="main">∧</span></span> i<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">i</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">≤</span><span class="skolem">h</span> 
        <span class="main">∧</span> <span class="skolem">lsum</span><span class="main">=</span><span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">=</span><span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">j</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="skolem">usum</span><span class="main">=</span><span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">=</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">h</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">j</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="main">¬</span>is_equil <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">h</span> <span class="bound">j</span><span class="main">)</span>
      ›</span></span>
    <span class="main"><span class="main">{</span></span>
      lsum <span class="main"><span class="main">=</span></span> lsum <span class="main"><span class="main">+</span></span> a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
      usum <span class="main"><span class="main">=</span></span> usum <span class="main"><span class="main">-</span></span> a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
      i<span class="main"><span class="main">=</span></span>i<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intvs_incdec is_equil_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff eq_iff finite_atLeastLessThan_int sum_diff1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Rotate Right›</span></span>
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">rotate_right</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span><span class="skolem">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">(</span><span class="bound">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    i <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
    prev <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>n <span class="main"><span class="main">-</span></span> 1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>i <span class="main"><span class="main">&lt;</span></span> n<span class="main"><span class="keyword1">)</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹
        <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">j</span><span class="main">)</span>
        <span class="main">∧</span> <span class="skolem">prev</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">n</span><span class="main">)</span>
      ›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      temp <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
      a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> prev<span class="main"><span class="main">;</span></span>
      prev <span class="main"><span class="main">=</span></span> temp<span class="main"><span class="main">;</span></span>
      i <span class="main"><span class="main">=</span></span> i <span class="main"><span class="main">+</span></span> 1
    <span class="main"><span class="main">}</span></span>
    ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zmod_minus1<span class="main">)</span>

  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Binary Search, Leftmost Element›</span></span>  
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first specify the pre- and postcondition›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bin_search_pre</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∧</span> ran_sorted <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bin_search_post</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟷</span> 
  <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>    
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Then we prove that the program is correct›</span></span>  
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">binsearch</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹bin_search_pre <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">h</span>›</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹bin_search_post <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l <span class="main"><span class="main">&lt;</span></span> h<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">l</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">≤</span><span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">h</span><span class="main">≤</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="skolem">h</span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">a</span> <span class="bound">i</span><span class="main">)</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
        m <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span>l <span class="main"><span class="main">+</span></span> h<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
        <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">[</span></span>m<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">&lt;</span></span> x<span class="main"><span class="keyword1">)</span></span> l <span class="main"><span class="main">=</span></span> m <span class="main"><span class="main">+</span></span> 1 
        <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> h <span class="main"><span class="main">=</span></span> m
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> bin_search_pre_def bin_search_post_def<span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Driving sledgehammer to its limits ...›</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> div_add_self1 even_succ_div_two odd_two_times_div_two_succ ran_sorted_alt<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> div_add_self1 even_succ_div_two odd_two_times_div_two_succ ran_sorted_alt<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we show that our postcondition (which was easy to prove)
  implies the expected properties of the algorithm.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bin_search_pre <span class="free">a</span> <span class="free">l</span> <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"bin_search_post <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="free">x</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> bin_search_decide_membership<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">a</span><span class="main">`</span><span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">&lt;</span><span class="free">h</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">a</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bin_search_leftmost<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span><span class="free">a</span><span class="main">`</span><span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bin_search_post_def bin_search_pre_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> atLeastLessThan_iff ran_sorted_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Naive String Search›</span></span>  
<span class="comment1">(* By Simon Wimmer *)</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">match_string</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span> <span class="main">≤</span> <span class="skolem">h1</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">(</span><span class="skolem">l1</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span> <span class="main">⟶</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">b</span> <span class="main">(</span><span class="skolem">l1</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
  i <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
  <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l1 <span class="main"><span class="main">+</span></span> i <span class="main"><span class="main">&lt;</span></span> h1 <span class="main"><span class="main">∧</span></span> a<span class="main"><span class="main">[</span></span>l <span class="main"><span class="main">+</span></span> i<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">==</span></span> b<span class="main"><span class="main">[</span></span>l1 <span class="main"><span class="main">+</span></span> i<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword1">)</span></span>
    <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">(</span><span class="skolem">l1</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span>›</span></span>
    <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">l1</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>›</span></span>
  <span class="main"><span class="main">{</span></span>
    i <span class="main"><span class="main">=</span></span> i <span class="main"><span class="main">+</span></span> 1
  <span class="main"><span class="main">}</span></span>
›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lran_eq_iff'<span class="main">:</span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l1</span> <span class="main">(</span><span class="free">l1</span> <span class="main">+</span> <span class="main">(</span><span class="free">h</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="free">a'</span> <span class="free">l</span> <span class="free">h</span>
  <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">-</span> <span class="free">l</span> <span class="main">⟶</span> <span class="free">a</span> <span class="main">(</span><span class="free">l1</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">a'</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="free">h</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> nat <span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Suc.hyps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l1</span> <span class="main">(</span><span class="free">l1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="free">a</span> <span class="free">l1</span> <span class="main">(</span><span class="free">l1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span> <span class="main">(</span><span class="free">l1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="quoted"><span class="quoted">"lran <span class="free">a'</span> <span class="free">l</span> <span class="skolem">h</span> <span class="main">=</span> lran <span class="free">a'</span> <span class="free">l</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">a'</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lran_bwd_simp <span class="dynamic"><span class="dynamic">algebra_simps</span></span> lran_butlast<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> IH * Suc.hyps<span class="main">(</span>2<span class="main">)</span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="free">l</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">match_string'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span> <span class="main">≤</span> <span class="skolem">h1</span>"</span></span>
<span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span> <span class="main">⟷</span> lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="skolem">b</span> <span class="skolem">l1</span> <span class="skolem">h1</span>"</span></span>
<span class="keyword2"><span class="keyword">for</span></span> i h1 l1 l a<span class="main">[</span><span class="main">]</span> b<span class="main">[</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">m</span>atch_string›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lran_eq_iff'<span class="main">)</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">substring</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">l1</span> <span class="main">≤</span> <span class="skolem">h1</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">match</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span><span class="main">.</span> lran <span class="skolem">a</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="skolem">b</span> <span class="skolem">l1</span> <span class="skolem">h1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> a<span class="main">[</span><span class="main">]</span> b<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
  match <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
  <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l <span class="main"><span class="main">&lt;</span></span> h <span class="main"><span class="main">∧</span></span> match <span class="main"><span class="main">==</span></span> 0<span class="main"><span class="keyword1">)</span></span>
    <span class="main"><span class="keyword1">@invariant</span></span><span class="quoted"><span class="quoted">‹<span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">match</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">match</span> <span class="main">=</span> <span class="main">1</span>
     <span class="keyword1">then</span> lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="skolem">b</span> <span class="skolem">l1</span> <span class="skolem">h1</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">h</span>
     <span class="keyword1">else</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> lran <span class="skolem">a</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> lran <span class="skolem">b</span> <span class="skolem">l1</span> <span class="skolem">h1</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="main"><span class="keyword1">@variant</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">match</span><span class="main">)</span>›</span></span>
  <span class="main"><span class="main">{</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">m</span>atch_string'<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>i <span class="main"><span class="main">==</span></span> h1 <span class="main"><span class="main">-</span></span> l1<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>match <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">}</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>l <span class="main"><span class="main">=</span></span> l <span class="main"><span class="main">+</span></span> 1<span class="main"><span class="main">}</span></span>
  <span class="main"><span class="main">}</span></span>
›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">substring'</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">l1</span> <span class="main">≤</span> <span class="skolem">h1</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">match</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">-</span><span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> lran <span class="skolem">a</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="skolem">b</span> <span class="skolem">l1</span> <span class="skolem">h1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> a<span class="main">[</span><span class="main">]</span> b<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
  match <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
  <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>l <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">(</span></span>h1 <span class="main"><span class="main">-</span></span> l1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≤</span></span> h<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
    h <span class="main"><span class="main">=</span></span> h <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span>h1 <span class="main"><span class="main">-</span></span> l1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">+</span></span> 1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">s</span>ubstring
  <span class="main"><span class="main">}</span></span>
›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="operator">auto</span>

<span class="comment1">(* Or combined: *)</span>
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">substring''</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="main">∧</span> <span class="skolem">l1</span> <span class="main">≤</span> <span class="skolem">h1</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">match</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">-</span><span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> lran <span class="skolem">a</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="skolem">b</span> <span class="skolem">l1</span> <span class="skolem">h1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> a<span class="main">[</span><span class="main">]</span> b<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
  match <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
  <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>l <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">(</span></span>h1 <span class="main"><span class="main">-</span></span> l1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≤</span></span> h<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l <span class="main"><span class="main">+</span></span> <span class="main"><span class="main">(</span></span>h1 <span class="main"><span class="main">-</span></span> l1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">&lt;</span></span> h <span class="main"><span class="main">∧</span></span> match <span class="main"><span class="main">==</span></span> 0<span class="main"><span class="keyword1">)</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span><span class="quoted"><span class="quoted">‹<span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">match</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">}</span> <span class="main">∧</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">match</span> <span class="main">=</span> <span class="main">1</span>
       <span class="keyword1">then</span> lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="skolem">b</span> <span class="skolem">l1</span> <span class="skolem">h1</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">h</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">l</span><span class="main">}</span><span class="main">.</span> lran <span class="skolem">a</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">-</span> <span class="skolem">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> lran <span class="skolem">b</span> <span class="skolem">l1</span> <span class="skolem">h1</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span><span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">match</span><span class="main">)</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">m</span>atch_string'<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>i <span class="main"><span class="main">==</span></span> h1 <span class="main"><span class="main">-</span></span> l1<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>match <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">}</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>l <span class="main"><span class="main">=</span></span> l <span class="main"><span class="main">+</span></span> 1<span class="main"><span class="main">}</span></span>
    <span class="main"><span class="main">}</span></span>
  <span class="main"><span class="main">}</span></span>
›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lran_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> lran <span class="free">a</span> <span class="free">l</span> <span class="free">p</span> <span class="main">@</span> lran <span class="free">a</span> <span class="free">p</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lran.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lran_eq_append_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> <span class="free">as</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">h</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">=</span> lran <span class="free">a</span> <span class="free">l</span> <span class="bound">i</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> lran <span class="free">a</span> <span class="bound">i</span> <span class="free">h</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> append_Cons list.inject lran.simps lran_append1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> add1_zle_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> IH<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lran_prepend1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lran_split<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> lran_split'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">h</span> <span class="main">-</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> lran <span class="free">a</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span> <span class="main">@</span> <span class="bound">bs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l1</span> <span class="main">≤</span> <span class="free">h1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">h</span> <span class="main">-</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> match<span class="main">:</span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="skolem">j</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l1</span> <span class="main">≤</span> <span class="free">h1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> lran <span class="free">a</span> <span class="free">l</span> <span class="skolem">j</span> <span class="main">@</span> lran <span class="free">a</span> <span class="skolem">j</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> lran <span class="free">a</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> lran_split<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lran_split<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span> <span class="main">@</span> <span class="bound">bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> match<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span> <span class="skolem">bs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> that lran_eq_append_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="quoted">"lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> lran <span class="free">a</span> <span class="free">l</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"lran <span class="free">a</span> <span class="skolem">i</span> <span class="free">h</span> <span class="main">=</span> lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> lran_eq_append_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span>"</span></span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span>
    <span class="quoted"><span class="quoted">"lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span> <span class="main">=</span> lran <span class="free">a</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> lran <span class="free">a</span> <span class="skolem">j</span> <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>lran <span class="free">a</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> j<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">h</span> <span class="main">-</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> lran <span class="free">a</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="main">(</span><span class="free">h1</span> <span class="main">-</span> <span class="free">l1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lran <span class="free">b</span> <span class="free">l1</span> <span class="free">h1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">substring_final</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">len</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">match</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> lran <span class="skolem">a</span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> lran <span class="skolem">b</span> <span class="main">0</span> <span class="skolem">len</span> <span class="main">@</span> <span class="bound">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> l h len match a<span class="main">[</span><span class="main">]</span> b<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹l1 <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span> h1 <span class="main"><span class="main">=</span></span> len<span class="main"><span class="main">;</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">s</span>ubstring'›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> lran_split'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insertion Sort›</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We first prove the inner loop. 
  The specification here specifies what the algorithm does as closely as possible,
  such that it becomes easier to prove. In this case, sortedness is not a precondition
  for the inner loop to move the key element backwards over all greater elements.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">insort_insert_post</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>
  <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">key</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">in</span>
      <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">∈</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span>            <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>i›</span></span> is in range›</span>
    <span class="comment1">― ‹Content of new array›</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">k</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">key</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="numeral">2</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">k</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="keyword1">on</span> <span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span>
    <span class="comment1">― ‹Placement of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>key›</span></span>›</span>  
    <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="bound">key</span><span class="main">)</span>  <span class="comment1">― ‹Element at <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>i›</span></span> smaller than <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>key›</span></span>, if it exists ›</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="numeral">2</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="bound">key</span><span class="main">)</span> <span class="comment1">― ‹Elements <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>≥i+2›</span></span> greater than <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>key›</span></span>›</span>
    <span class="main">)</span>
    "</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">l</span> <span class="free">j</span> <span class="free">i</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int"</span></span>
  
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">insort_insert</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"insort_insert_post <span class="skolem">l</span> <span class="skolem">j</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">a</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    key <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
    i <span class="main"><span class="main">=</span></span> j<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>i<span class="main"><span class="main">≥</span></span>l <span class="main"><span class="main">∧</span></span> a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">&gt;</span></span>key<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">-</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">-</span><span class="main">1</span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">j</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">l</span><span class="main">..</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">k</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="skolem">key</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="bound">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>
        <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">on</span> <span class="main">-</span><span class="main">{</span><span class="skolem">l</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span>
        ›</span></span>
    <span class="main"><span class="main">{</span></span>
      a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
      i<span class="main"><span class="main">=</span></span>i<span class="main"><span class="main">-</span></span>1
    <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> key
  ›</span>
  <span class="keyword1"><span class="command">unfolding</span></span> insort_insert_post_def Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff<span class="main">)</span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we show that our specification that was easy to prove implies the 
  specification that the outer loop expects:›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invoking <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>insort_insert›</span></span></span></span> will sort in the element›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> insort_insert_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insort_insert_post <span class="free">l</span> <span class="free">j</span> <span class="free">a</span> <span class="free">a'</span> <span class="free">i'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a</span> <span class="free">l</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a'</span> <span class="free">l</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> insort_insert_post_def Let_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastAtMost_iff ran_sorted_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> ran_sorted_alt Ball_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Invoking <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>insort_insert›</span></span></span></span> will only mutate the elements›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> insort_insert_ran1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insort_insert_post <span class="free">l</span> <span class="free">j</span> <span class="free">a</span> <span class="free">a'</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a'</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">j</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> EQS<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="free">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">o</span> <span class="main">(+)</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> insort_insert_post_def eq_on_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">i</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">≤</span><span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> insort_insert_post_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">have</span></span> ranshift<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_ran <span class="main">(</span><span class="free">a</span> <span class="keyword1">o</span> <span class="main">(+)</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..</span><span class="free">j</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_ran_shift <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    
      
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a'</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">j</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">a'</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> <span class="main">{#</span> <span class="free">a'</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">#}</span> <span class="main">+</span> mset_ran <span class="free">a'</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>  
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span><span class="main">&lt;</span><span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span><span class="main">≤</span><span class="free">i</span><span class="main">+</span><span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">≤</span><span class="free">j</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_ran_combine<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"mset_ran <span class="free">a'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> <span class="main">{#</span> <span class="free">a</span> <span class="free">j</span> <span class="main">#}</span> <span class="main">+</span> mset_ran <span class="main">(</span><span class="free">a</span> <span class="keyword1">o</span> <span class="main">(+)</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> EQS<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> mset_ran_cong<span class="main">]</span> EQS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">+</span> <span class="main">{#</span> <span class="free">a</span> <span class="free">j</span> <span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_ran_shift <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span><span class="main">&lt;</span><span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span><span class="main">≤</span><span class="free">i</span><span class="main">+</span><span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">≤</span><span class="free">j</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_ran_combine<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The property <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> insort_insert_ran1<span class="antiquote"><span class="antiquote">}</span></span></span></span> extends to the whole array to be sorted›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> insort_insert_ran2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insort_insert_post <span class="free">l</span> <span class="free">j</span> <span class="free">a</span> <span class="free">a'</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a'</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a'</span><span class="main">=</span><span class="free">a</span> <span class="keyword1">on</span> <span class="main">-</span><span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> insort_insert_ran1 assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a'</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">j</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹insort_insert_post <span class="free">l</span> <span class="free">j</span> <span class="free">a</span> <span class="free">a'</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">on</span> <span class="main">{</span><span class="free">j</span><span class="main">&lt;..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> insort_insert_post_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a'</span> <span class="main">{</span><span class="free">j</span><span class="main">&lt;..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">j</span><span class="main">&lt;..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mset_ran_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>mset_ran_combine_eqs<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms ivl_disj_int_two<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> ivl_disj_un_two<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> le_less<span class="main">)</span>
    
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span>   
    <span class="keyword1"><span class="command">unfolding</span></span> insort_insert_post_def Let_def eq_on_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we specify and prove correct the outer loop›</span></span>
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">insort</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">h</span>"</span></span> 
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"ran_sorted <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">h</span> <span class="main">∧</span> mset_ran <span class="skolem">a</span> <span class="main">{</span><span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">h</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{</span><span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">h</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">on</span> <span class="main">-</span><span class="main">{</span><span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">h</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> a<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    j <span class="main"><span class="main">=</span></span> l <span class="main"><span class="main">+</span></span> 1<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>j<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">j</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹
          <span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">j</span> <span class="main">∧</span> <span class="skolem">j</span><span class="main">≤</span><span class="skolem">h</span>           <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>j›</span></span> in range›</span>
        <span class="main">∧</span> ran_sorted <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">j</span>     <span class="comment1">― ‹Array is sorted up to <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>j›</span></span>›</span>
        <span class="main">∧</span> mset_ran <span class="skolem">a</span> <span class="main">{</span><span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">h</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{</span><span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">h</span><span class="main">}</span> <span class="comment1">― ‹Elements in range only permuted›</span>
        <span class="main">∧</span> <span class="skolem">a</span><span class="main">=</span><span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">on</span> <span class="main">-</span><span class="main">{</span><span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">h</span><span class="main">}</span>
      ›</span></span>
    <span class="main"><span class="main">{</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">i</span>nsort_insert<span class="main"><span class="main">;</span></span>
      j<span class="main"><span class="main">=</span></span>j<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> insort_insert_sorted<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> insort_insert_ran2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> insort_insert_ran2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>    
  

  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Quicksort›</span></span>

<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">partition_aux</span><span class="main">(</span>a<span class="main">,</span>l<span class="main">,</span>h<span class="main">,</span>p<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span>a<span class="main">,</span>i<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="skolem">a</span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>
         <span class="main">∧</span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">≤</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span>
         <span class="main">∧</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">on</span> <span class="main">-</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
         "</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
  i<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span> j<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span>
  <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>j<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> 
    <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹ 
        <span class="skolem">l</span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">≤</span><span class="skolem">j</span> <span class="main">∧</span> <span class="skolem">j</span><span class="main">≤</span><span class="skolem">h</span>     
      <span class="main">∧</span> mset_ran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="skolem">a</span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">l</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">p</span><span class="main">)</span>  
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">p</span><span class="main">)</span>  
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j</span><span class="main">..&lt;</span><span class="skolem">h</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">a</span> <span class="bound">k</span><span class="main">)</span>  
      <span class="main">∧</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">on</span> <span class="main">-</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
    ›</span></span>
    <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">h</span><span class="main">-</span><span class="skolem">j</span><span class="main">)</span>›</span></span>
  <span class="main"><span class="main">{</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">&lt;</span></span>p<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>temp <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span> a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> temp<span class="main"><span class="main">;</span></span> i<span class="main"><span class="main">=</span></span>i<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    j<span class="main"><span class="main">=</span></span>j<span class="main"><span class="main">+</span></span>1
  <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> lran_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> lran_tail<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_ran_swap<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> swap_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  

<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">partition</span><span class="main">(</span>a<span class="main">,</span>l<span class="main">,</span>h<span class="main">,</span>p<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span>a<span class="main">,</span>i<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="skolem">a</span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">a</span> <span class="skolem">i</span><span class="main">)</span> 
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">a</span> <span class="skolem">i</span><span class="main">)</span>
         <span class="main">∧</span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="skolem">i</span>
         <span class="main">∧</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">on</span> <span class="main">-</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
         "</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    p <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>h<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
    <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>i<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> partition_aux<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>l<span class="main"><span class="main">,</span></span>h<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">,</span></span>p<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    a<span class="main"><span class="main">[</span></span>h<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
    a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> p
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def mset_ran_swap<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> swap_def<span class="main"><span class="main">]</span></span> intvs_incdec <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mset_ran_combine_eq_diff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  
  
<span class="keyword1"><span class="command">lemma</span></span> quicksort_sorted_aux<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> BOUNDS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">h</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">assumes</span></span> LESS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="free">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">i</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> GEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span><span class="main">.</span> <span class="free">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">i</span> <span class="main">≤</span> <span class="free">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">j</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">assumes</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">a<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">a<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">on</span> <span class="main">-</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">assumes</span></span> SL<span class="main">:</span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">l</span> <span class="free">i</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">assumes</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="keyword1">on</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> SH<span class="main">:</span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">l</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">i</span> <span class="main">=</span> <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E1 E2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_on_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">note</span></span> X1 <span class="main">=</span> mset_ran_xfer_pointwise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">p</span><span class="main">,</span> <span class="operator">OF</span> R1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> X2 <span class="main">=</span> eq_on_xfer_pointwise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">p</span><span class="main">,</span> <span class="operator">OF</span> E2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> LESS <span class="keyword1"><span class="command">have</span></span> LESS'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X1 X2<span class="main">)</span>
    
  
  <span class="keyword1"><span class="command">from</span></span> GEQ <span class="keyword1"><span class="command">have</span></span> GEQ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span><span class="main">.</span> <span class="free">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">i</span> <span class="main">≤</span> <span class="free">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">-</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> X3 <span class="main">=</span> eq_on_xfer_pointwise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">p</span><span class="main">,</span> <span class="operator">OF</span> E1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> X4 <span class="main">=</span> mset_ran_xfer_pointwise<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">‹<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">p</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">p</span><span class="main">,</span> <span class="operator">OF</span> R2<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>  
  <span class="keyword1"><span class="command">from</span></span> GEQ1 <span class="keyword1"><span class="command">have</span></span> GEQ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">h</span><span class="main">}</span><span class="main">.</span> <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">i</span> <span class="main">≤</span> <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X3 X4<span class="main">)</span>

  
  <span class="keyword1"><span class="command">from</span></span> SL eq_on_xfer_ran_sorted<span class="main">[</span><span class="operator">OF</span> E2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> SL'<span class="main">:</span> <span class="quoted"><span class="quoted">"ran_sorted <span class="free">a<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">l</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> combine_sorted_pivot<span class="main">[</span><span class="operator">OF</span> BOUNDS SL' SH LESS' GEQ'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>  
  
<span class="keyword1"><span class="command">lemma</span></span> quicksort_mset_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">aa</span> <span class="main">{</span><span class="free">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">aa</span> <span class="keyword1">on</span> <span class="main">-</span> <span class="main">{</span><span class="free">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">aa</span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">ab</span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aa</span> <span class="main">=</span> <span class="free">ab</span> <span class="keyword1">on</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset_ran <span class="free">a</span> <span class="main">{</span><span class="free">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="free">ab</span> <span class="main">{</span><span class="free">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="free">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mset_ran_eq_extend<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R1 E1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mset_ran_eq_extend<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R2 E2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 
  
  
<span class="keyword1"><span class="command">recursive_spec</span></span> <span class="entity">quicksort</span><span class="main">(</span>a<span class="main">,</span>l<span class="main">,</span>h<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> a 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"True"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"ran_sorted <span class="skolem">a</span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> mset_ran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">=</span> mset_ran <span class="skolem">a</span> <span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span><span class="main">=</span><span class="skolem">a</span> <span class="keyword1">on</span> <span class="main">-</span><span class="main">{</span><span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span><span class="main">-</span><span class="skolem">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
      <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>i<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> partition<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>l<span class="main"><span class="main">,</span></span>h<span class="main"><span class="main">,</span></span>a<span class="main"><span class="main">[</span></span>l<span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      a <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> quicksort<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>l<span class="main"><span class="main">,</span></span>i<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      a <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> quicksort<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>i<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">,</span></span>h<span class="main"><span class="main">)</span></span>
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vcg_cs</span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> quicksort_sorted_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> quicksort_mset_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> ComplD ComplI atLeastLessThan_iff eq_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_sorted_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data Refinement›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Filtering›</span></span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">array_filter_negative</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"lran <span class="skolem">a</span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">i</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">≥</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span>lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    i<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span> j<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>j<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹ 
          <span class="skolem">l</span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">≤</span><span class="skolem">j</span> <span class="main">∧</span> <span class="skolem">j</span><span class="main">≤</span><span class="skolem">h</span>     
        <span class="main">∧</span> lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">≥</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span>lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l</span> <span class="skolem">j</span><span class="main">)</span>
        <span class="main">∧</span> lran <span class="skolem">a</span> <span class="skolem">j</span> <span class="skolem">h</span> <span class="main">=</span> lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">j</span> <span class="skolem">h</span>
      ›</span></span>
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">j</span>›</span></span>
    <span class="main"><span class="main">{</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">≥</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span> i<span class="main"><span class="main">=</span></span>i<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
      j<span class="main"><span class="main">=</span></span>j<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> lran_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> lran_tail<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="comment1">(* Exercise: Use swap to modify this algorithm to partitioning! *)</span>
  

  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Merge Two Sorted Lists›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define the merge function abstractly first, as a functional program on lists.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free">merge</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>   

<span class="keyword1"><span class="command">lemma</span></span> merge_add_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"merge <span class="free">xs</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It's straightforward to show that this produces a sorted list with the same elements.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> merge_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">ys</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span> set <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> merge_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>merge <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">+</span> mset <span class="free">ys</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span>
  
  
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we prove an equation that characterizes one step of the while loop,
  on the list level.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> merge_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∨</span> <span class="free">ys</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟹</span> merge <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free">ys</span><span class="main">=</span><span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span><span class="free">xs</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> hd <span class="free">xs</span> <span class="main">&lt;</span> hd <span class="free">ys</span><span class="main">)</span> <span class="keyword1">then</span> hd <span class="free">xs</span> <span class="main">#</span> merge <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span>
  <span class="keyword1">else</span> hd <span class="free">ys</span> <span class="main">#</span> merge <span class="free">xs</span> <span class="main">(</span>tl <span class="free">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We do a first proof that our merge implementation on the arrays and indexes
  behaves like the functional merge on the corresponding lists.
  
  The annotations use the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lran<span class="antiquote"><span class="antiquote">}</span></span></span></span> function to map from the implementation level 
  to the list level. Moreover, the invariant of the implementation, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l≤h›</span></span></span></span>, is carried 
  through explicitly.
›</span></span>
<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">merge_imp'</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span><span class="main">≤</span><span class="skolem">h1</span> <span class="main">∧</span> <span class="skolem">l2</span><span class="main">≤</span><span class="skolem">h2</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">ms</span> <span class="main">=</span> lran <span class="skolem">m</span> <span class="main">0</span> <span class="skolem">j</span><span class="main">;</span> <span class="bound">xs<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> lran <span class="skolem">a1<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l1<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h1<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="bound">ys<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> lran <span class="skolem">a2<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l2<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h2<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">in</span>  
    <span class="skolem">j</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">ms</span> <span class="main">=</span> merge <span class="bound">xs<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    j<span class="main"><span class="main">=</span></span>0<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>l1<span class="main"><span class="main">≠</span></span>h1 <span class="main"><span class="main">∨</span></span> l2<span class="main"><span class="main">≠</span></span>h2<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h1</span> <span class="main">+</span> <span class="skolem">h2</span> <span class="main">-</span> <span class="skolem">l1</span> <span class="main">-</span> <span class="skolem">l2</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">let</span> 
          <span class="bound">xs</span><span class="main">=</span>lran <span class="skolem">a1</span> <span class="skolem">l1</span> <span class="skolem">h1</span><span class="main">;</span> <span class="bound">ys</span> <span class="main">=</span> lran <span class="skolem">a2</span> <span class="skolem">l2</span> <span class="skolem">h2</span><span class="main">;</span> <span class="bound">ms</span> <span class="main">=</span> lran <span class="skolem">m</span> <span class="main">0</span> <span class="skolem">j</span><span class="main">;</span>
          <span class="bound">xs<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> lran <span class="skolem">a1<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l1<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h1<span class="hidden">⇩</span><sub>0</sub></span><span class="main">;</span> <span class="bound">ys<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> lran <span class="skolem">a2<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l2<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h2<span class="hidden">⇩</span><sub>0</sub></span>
        <span class="keyword1">in</span> 
          <span class="skolem">l1</span><span class="main">≤</span><span class="skolem">h1</span> <span class="main">∧</span> <span class="skolem">l2</span><span class="main">≤</span><span class="skolem">h2</span> <span class="main">∧</span> <span class="main">0</span><span class="main">≤</span><span class="skolem">j</span> <span class="main">∧</span>
          merge <span class="bound">xs<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="bound">ms</span><span class="main">@</span>merge <span class="bound">xs</span> <span class="bound">ys</span>
      ›</span></span>
    <span class="main"><span class="main">{</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>l2<span class="main"><span class="main">==</span></span>h2 <span class="main"><span class="main">∨</span></span> <span class="main"><span class="main">(</span></span>l1<span class="main"><span class="main">≠</span></span>h1 <span class="main"><span class="main">∧</span></span> a1<span class="main"><span class="main">[</span></span>l1<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">&lt;</span></span> a2<span class="main"><span class="main">[</span></span>l2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
        m<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> a1<span class="main"><span class="main">[</span></span>l1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
        l1<span class="main"><span class="main">=</span></span>l1<span class="main"><span class="main">+</span></span>1
      <span class="main"><span class="main">}</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
        m<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> a2<span class="main"><span class="main">[</span></span>l2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
        l2<span class="main"><span class="main">=</span></span>l2<span class="main"><span class="main">+</span></span>1
      <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
      j<span class="main"><span class="main">=</span></span>j<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] merge_eq<span class="antiquote"><span class="antiquote">}</span></span></span></span> theorem, which captures the essence of a loop step,
    and the theorems <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> lran_append1<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> lran_tail<span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> hd_lran<span class="antiquote"><span class="antiquote">}</span></span></span></span>, which
    convert from the operations on arrays and indexes to operations on lists,
    the proof is straightforward
  ›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> merge_eq<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> merge_eq<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In a next step, we refine our proof to 
  combine it with the abstract properties we have proved about merge.
  The program does not change (we simply inline the original one here).
›</span></span>
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">merge_imp</span> <span class="main">(</span>a1<span class="main">,</span>l1<span class="main">,</span>h1<span class="main">,</span>a2<span class="main">,</span>l2<span class="main">,</span>h2<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span>m<span class="main">,</span>j<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span><span class="main">≤</span><span class="skolem">h1</span> <span class="main">∧</span> <span class="skolem">l2</span><span class="main">≤</span><span class="skolem">h2</span> <span class="main">∧</span> sorted <span class="main">(</span>lran <span class="skolem">a1</span> <span class="skolem">l1</span> <span class="skolem">h1</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>lran <span class="skolem">a2</span> <span class="skolem">l2</span> <span class="skolem">h2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">ms</span> <span class="main">=</span> lran <span class="skolem">m</span> <span class="main">0</span> <span class="skolem">j</span> <span class="keyword1">in</span> 
      <span class="skolem">j</span><span class="main">≥</span><span class="main">0</span> 
    <span class="main">∧</span> sorted <span class="bound">ms</span> 
    <span class="main">∧</span> mset <span class="bound">ms</span> <span class="main">=</span> mset <span class="main">(</span>lran <span class="skolem">a1<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l1<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h1<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">+</span> mset <span class="main">(</span>lran <span class="skolem">a2<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l2<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h2<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> l1 h1 l2 h2 a1<span class="main">[</span><span class="main">]</span> a2<span class="main">[</span><span class="main">]</span> m<span class="main">[</span><span class="main">]</span> j
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">m</span>erge_imp'›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def merge_mset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> merge_sorted<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">thm</span></span> merge_imp_spec  
<span class="keyword1"><span class="command">thm</span></span> merge_imp_def
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">named_ss</span> vcg_bb<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"UNIV <span class="main">∪</span> <span class="free">a</span> <span class="main">=</span> UNIV"</span></span>  
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∪</span> UNIV <span class="main">=</span> UNIV"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  
<span class="keyword1"><span class="command">lemma</span></span> merge_msets_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">l</span><span class="main">≤</span><span class="free">m</span><span class="main">;</span> <span class="free">m</span><span class="main">≤</span><span class="free">h</span><span class="main">⟧</span> <span class="main">⟹</span> mset <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> mset <span class="main">(</span>lran <span class="free">a</span> <span class="free">m</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>lran <span class="free">a</span> <span class="free">l</span> <span class="free">h</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_lran mset_ran_combine ivl_disj_un_two<span class="main">)</span>
  
  
  
  
<span class="keyword1"><span class="command">recursive_spec</span></span> <span class="entity">mergesort</span> <span class="main">(</span>a<span class="main">,</span>l<span class="main">,</span>h<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span>b<span class="main">,</span>j<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span><span class="main">≤</span><span class="skolem">j</span> <span class="main">∧</span> sorted <span class="main">(</span>lran <span class="skolem">b</span> <span class="main">0</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> mset <span class="main">(</span>lran <span class="skolem">b</span> <span class="main">0</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span>lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">l</span>›</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> a<span class="main">[</span><span class="main">]</span> b<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">==</span></span>h<span class="main"><span class="keyword1">)</span></span> j<span class="main"><span class="main">=</span></span>0
    <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>l<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">==</span></span>h<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
      b<span class="main"><span class="main">[</span></span>0<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>l<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
      j<span class="main"><span class="main">=</span></span>1
    <span class="main"><span class="main">}</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
      m <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span>h<span class="main"><span class="main">+</span></span>l<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      <span class="main"><span class="main">(</span></span>a1<span class="main"><span class="main">,</span></span>h1<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> mergesort <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>l<span class="main"><span class="main">,</span></span>m<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      <span class="main"><span class="main">(</span></span>a2<span class="main"><span class="main">,</span></span>h2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> mergesort <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">,</span></span>m<span class="main"><span class="main">,</span></span>h<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      <span class="main"><span class="main">(</span></span>b<span class="main"><span class="main">,</span></span>j<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> merge_imp <span class="main"><span class="main">(</span></span>a1<span class="main"><span class="main">,</span></span>0<span class="main"><span class="main">,</span></span>h1<span class="main"><span class="main">,</span></span>a2<span class="main"><span class="main">,</span></span>0<span class="main"><span class="main">,</span></span>h2<span class="main"><span class="main">)</span></span> 
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lran.simps<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def merge_msets_aux<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">print_theorems</span></span>    
  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Remove Duplicates from Array, using Bitvector Set›</span></span>  
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We use an array to represent a set of integers.

  If we only insert elements in range <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>{0..&lt;n}›</span></span></span></span>, this representation
  is called bit-vector (storing a single bit per index is enough).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">⇒</span> int<span class="main">)</span> <span class="main">⇒</span> int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_of</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> set_of_def <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> set_of_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_of <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> set_of_insert<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟹</span> set_of <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">i</span> <span class="main">(</span>set_of <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> set_of_remove<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_of <span class="main">(</span><span class="free">a</span><span class="main">(</span><span class="free">i</span><span class="main">:=</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set_of <span class="free">a</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">lemma</span></span> set_of_mem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">∈</span>set_of <span class="free">a</span> <span class="main">⟷</span> <span class="free">a</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">dedup</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>›</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    i<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span> j<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword2">clear</span></span></span> b<span class="main"><span class="main">[]</span></span><span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>j<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">j</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">≤</span><span class="skolem">j</span> <span class="main">∧</span> <span class="skolem">j</span><span class="main">≤</span><span class="skolem">h</span> 
        <span class="main">∧</span> set <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l</span> <span class="skolem">j</span><span class="main">)</span>
        <span class="main">∧</span> distinct <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span>
        <span class="main">∧</span> lran <span class="skolem">a</span> <span class="skolem">j</span> <span class="skolem">h</span> <span class="main">=</span> lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">j</span> <span class="skolem">h</span>
        <span class="main">∧</span> set_of <span class="skolem">b</span> <span class="main">=</span> set <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span>
       ›</span></span>
    <span class="main"><span class="main">{</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>b<span class="main"><span class="main">[</span></span>a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">==</span></span> 0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
        a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span> i<span class="main"><span class="main">=</span></span>i<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">;</span></span> b<span class="main"><span class="main">[</span></span>a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> 1
      <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
      j<span class="main"><span class="main">=</span></span>j<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lran_eq_iff lran_upd_inside <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">tl</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lran_eq_iff<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">bv_init</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹set_of <span class="skolem">b</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword"><span class="keyword2">clear</span></span></span> b<span class="main"><span class="main">[]</span></span>›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">bv_insert</span> <span class="main">(</span>x<span class="main">,</span> b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹set_of <span class="skolem">b</span> <span class="main">=</span> insert <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>set_of <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹b<span class="main"><span class="main">[</span></span>x<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> 1›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">bv_remove</span> <span class="main">(</span>x<span class="main">,</span> b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹set_of <span class="skolem">b</span> <span class="main">=</span> set_of <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹b<span class="main"><span class="main">[</span></span>x<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> 0›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">bv_elem</span> <span class="main">(</span>x<span class="main">,</span>b<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">∈</span>set_of <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹r <span class="main"><span class="main">=</span></span> b<span class="main"><span class="main">[</span></span>x<span class="main"><span class="main">]</span></span>›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  
  
<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">dedup'</span> <span class="main">(</span>a<span class="main">,</span>l<span class="main">,</span>h<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span>a<span class="main">,</span>l<span class="main">,</span>i<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">h</span>›</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹set <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">h<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span> ›</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> b<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    b <span class="main"><span class="main">=</span></span> bv_init<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
  
    i<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span> j<span class="main"><span class="main">=</span></span>l<span class="main"><span class="main">;</span></span>
    
    <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>j<span class="main"><span class="main">&lt;</span></span>h<span class="main"><span class="keyword1">)</span></span> 
      <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span><span class="main">-</span><span class="skolem">j</span>›</span></span>
      <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">≤</span><span class="skolem">j</span> <span class="main">∧</span> <span class="skolem">j</span><span class="main">≤</span><span class="skolem">h</span> 
        <span class="main">∧</span> set <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">l</span> <span class="skolem">j</span><span class="main">)</span>
        <span class="main">∧</span> distinct <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span>
        <span class="main">∧</span> lran <span class="skolem">a</span> <span class="skolem">j</span> <span class="skolem">h</span> <span class="main">=</span> lran <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">j</span> <span class="skolem">h</span>
        <span class="main">∧</span> set_of <span class="skolem">b</span> <span class="main">=</span> set <span class="main">(</span>lran <span class="skolem">a</span> <span class="skolem">l</span> <span class="skolem">i</span><span class="main">)</span>
       ›</span></span>
    <span class="main"><span class="main">{</span></span>
      mem <span class="main"><span class="main">=</span></span> bv_elem <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>mem <span class="main"><span class="main">==</span></span> 0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
        a<span class="main"><span class="main">[</span></span>i<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span> i<span class="main"><span class="main">=</span></span>i<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">;</span></span> b <span class="main"><span class="main">=</span></span> bv_insert<span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>b<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
      j<span class="main"><span class="main">=</span></span>j<span class="main"><span class="main">+</span></span>1
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lran_eq_iff lran_upd_inside <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">tl</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Recursion›</span></span>  

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Recursive Fibonacci›</span></span>

<span class="keyword1"><span class="command">recursive_spec</span></span> <span class="entity">fib_imp</span> <span class="main">(</span>i<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> fib <span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>i<span class="main"><span class="main">≤</span></span>0<span class="main"><span class="keyword1">)</span></span> r<span class="main"><span class="main">=</span></span>0
    <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>i<span class="main"><span class="main">==</span></span>1<span class="main"><span class="keyword1">)</span></span> r<span class="main"><span class="main">=</span></span>1
    <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
      r1<span class="main"><span class="main">=</span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> fib_imp <span class="main"><span class="main">(</span></span>i<span class="main"><span class="main">-</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      r2<span class="main"><span class="main">=</span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> fib_imp <span class="main"><span class="main">(</span></span>i<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      r <span class="main"><span class="main">=</span></span> r1<span class="main"><span class="main">+</span></span>r2
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>    
    
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Homeier's Cycling Termination›</span></span>  

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A contrived example from Homeier's thesis. 
  Only the termination proof is done.›</span></span>
<span class="comment1">(* TODO: Also show correctness: pedal (a,b) will multiply its arguments!
  correctness proof may be a good test how to handle specs with logical vars!
*)</span>  
  
<span class="keyword1"><span class="command">recursive_spec</span></span> 
  <span class="entity">pedal</span> <span class="main">(</span>n<span class="main">,</span>m<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">m</span><span class="main">≥</span><span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">+</span><span class="skolem">m</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">≠</span></span>0 <span class="main"><span class="main">∧</span></span> m<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
      G <span class="main"><span class="main">=</span></span> G <span class="main"><span class="main">+</span></span> m<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">&lt;</span></span>m<span class="main"><span class="keyword1">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> coast <span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">,</span></span>m<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> pedal<span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">,</span></span>m<span class="main"><span class="main">)</span></span>
    <span class="main"><span class="main">}</span></span>
  ›</span>
<span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">coast</span> <span class="main">(</span>n<span class="main">,</span>m<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">m</span><span class="main">≥</span><span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">+</span><span class="skolem">m</span><span class="main">+</span><span class="main">1</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    G <span class="main"><span class="main">=</span></span> G <span class="main"><span class="main">+</span></span> n<span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">&lt;</span></span>m<span class="main"><span class="keyword1">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> coast <span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">,</span></span>m<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> pedal <span class="main"><span class="main">(</span></span>n<span class="main"><span class="main">,</span></span>m<span class="main"><span class="main">)</span></span>
  ›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>  
  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Ackermann›</span></span>  
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ack</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ack</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ack</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free">ack</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ack</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">ack</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">ack</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> ack_add_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟹</span> ack <span class="free">m</span> <span class="main">0</span> <span class="main">=</span> ack <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">m</span><span class="main">≠</span><span class="main">0</span><span class="main">;</span> <span class="free">n</span><span class="main">≠</span><span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> ack <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> ack <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>ack <span class="free">m</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ack.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">recursive_spec</span></span> <span class="keyword2"><span class="keyword">relation</span></span> <span class="quoted"><span class="quoted">"less_than <span class="keyword1">&lt;*lex*&gt;</span> less_than"</span></span>
  <span class="entity">ack_imp</span> <span class="main">(</span>m<span class="main">,</span>n<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> r
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≥</span><span class="main">0</span> <span class="main">∧</span> <span class="skolem">n</span><span class="main">≥</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">=</span>int <span class="main">(</span>ack <span class="main">(</span>nat <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>nat <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="skolem">m</span><span class="main">,</span> nat <span class="skolem">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>m<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> r <span class="main"><span class="main">=</span></span> n<span class="main"><span class="main">+</span></span>1
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>n<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> r <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> ack_imp <span class="main"><span class="main">(</span></span>m<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
        t <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> ack_imp <span class="main"><span class="main">(</span></span>m<span class="main"><span class="main">,</span></span>n<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
        r <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> ack_imp <span class="main"><span class="main">(</span></span>m<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">,</span></span>t<span class="main"><span class="main">)</span></span>
      <span class="main"><span class="main">}</span></span>
    ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> nat_distribs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>
  
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹McCarthy's 91 Function›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A standard benchmark for verification of recursive functions.
  We use Homeier's version with a global variable.›</span></span>
  
<span class="keyword1"><span class="command">recursive_spec</span></span> <span class="entity">p91</span><span class="main">(</span>y<span class="main">)</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="numeral">100</span><span class="main">&lt;</span><span class="skolem">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">then</span> <span class="skolem">G</span> <span class="main">=</span> <span class="skolem">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">-</span><span class="numeral">10</span> <span class="keyword1">else</span> <span class="skolem">G</span> <span class="main">=</span> <span class="numeral">91</span>"</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">101</span><span class="main">-</span><span class="skolem">y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> G
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>100<span class="main"><span class="main">&lt;</span></span>y<span class="main"><span class="keyword1">)</span></span> G<span class="main"><span class="main">=</span></span>y<span class="main"><span class="main">-</span></span>10
    <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> p91 <span class="main"><span class="main">(</span></span>y<span class="main"><span class="main">+</span></span>11<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> p91 <span class="main"><span class="main">(</span></span>G<span class="main"><span class="main">)</span></span>
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Odd/Even›</span></span>  
  
<span class="keyword1"><span class="command">recursive_spec</span></span> 
  <span class="entity">odd_imp</span> <span class="main">(</span>a<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span>
    <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> odd <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">a</span><span class="main">¦</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> b<span class="main"><span class="main">=</span></span>0
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">&lt;</span></span>0<span class="main"><span class="keyword1">)</span></span> b <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> even_imp <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">)</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> even_imp <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span>
    ›</span>
  <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">even_imp</span> <span class="main">(</span>a<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> b
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span>
    <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟷</span> even <span class="skolem">a<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">a</span><span class="main">¦</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">==</span></span>0<span class="main"><span class="keyword1">)</span></span> b<span class="main"><span class="main">=</span></span>1
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>a<span class="main"><span class="main">&lt;</span></span>0<span class="main"><span class="keyword1">)</span></span> b <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> odd_imp <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">+</span></span>1<span class="main"><span class="main">)</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> b <span class="main"><span class="main">=</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> odd_imp <span class="main"><span class="main">(</span></span>a<span class="main"><span class="main">-</span></span>1<span class="main"><span class="main">)</span></span>
    ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg</span>  
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  

<span class="keyword1"><span class="command">thm</span></span> even_imp_spec

  
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pandya and Joseph's Product Producers›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Again, taking the version from Homeier's thesis, but with a 
  modification to also terminate for negative <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span>.
  ›</span></span>
  
<span class="keyword1"><span class="command">recursive_spec</span></span> <span class="keyword2"><span class="keyword">relation</span></span> <span class="quoted"><span class="quoted">‹measure nat <span class="keyword1">&lt;*lex*&gt;</span> less_than›</span></span>
  <span class="entity">product</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">GZ</span> <span class="main">=</span> <span class="skolem">GZ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="skolem">GX<span class="hidden">⇩</span><sub>0</sub></span><span class="main">*</span><span class="skolem">GY<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¦</span><span class="skolem">GY</span><span class="main">¦</span><span class="main">,</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> GX GY GZ
  <span class="keyword2"><span class="keyword">defines</span></span>
  <span class="quoted">‹
    e <span class="main"><span class="main">=</span></span> even_imp <span class="main"><span class="main">(</span></span>GY<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>e<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> evenproduct<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> oddproduct<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span>
  ›</span>
<span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">oddproduct</span><span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹odd <span class="skolem">GY</span>›</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">GZ</span> <span class="main">=</span> <span class="skolem">GZ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="skolem">GX<span class="hidden">⇩</span><sub>0</sub></span><span class="main">*</span><span class="skolem">GY<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¦</span><span class="skolem">GY</span><span class="main">¦</span><span class="main">,</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> GX GY GZ
  <span class="keyword2"><span class="keyword">defines</span></span>
  <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>GY<span class="main"><span class="main">&lt;</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
      GY <span class="main"><span class="main">=</span></span> GY <span class="main"><span class="main">+</span></span> 1<span class="main"><span class="main">;</span></span>
      GZ <span class="main"><span class="main">=</span></span> GZ <span class="main"><span class="main">-</span></span> GX
    <span class="main"><span class="main">}</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
      GY <span class="main"><span class="main">=</span></span> GY <span class="main"><span class="main">-</span></span> 1<span class="main"><span class="main">;</span></span>
      GZ <span class="main"><span class="main">=</span></span> GZ <span class="main"><span class="main">+</span></span> GX
    <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> evenproduct<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span>
  ›</span>
<span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">evenproduct</span><span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">‹even <span class="skolem">GY</span>›</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">GZ</span> <span class="main">=</span> <span class="skolem">GZ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="skolem">GX<span class="hidden">⇩</span><sub>0</sub></span><span class="main">*</span><span class="skolem">GY<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword2"><span class="keyword">variant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¦</span><span class="skolem">GY</span><span class="main">¦</span><span class="main">,</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> GX GY GZ
  <span class="keyword2"><span class="keyword">defines</span></span>
  <span class="quoted">‹
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>GY<span class="main"><span class="main">≠</span></span>0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
      GX <span class="main"><span class="main">=</span></span> 2<span class="main"><span class="main">*</span></span>GX<span class="main"><span class="main">;</span></span>
      GY <span class="main"><span class="main">=</span></span> GY <span class="main"><span class="main">/</span></span> 2<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">rec</span></span></span> product<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span>
    <span class="main"><span class="main">}</span></span>
  ›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  
<span class="comment1">(*
  TODO: 
    * Infrastructure to prove different specification for same program
      (DONE) We can use inline, and just give program a new name.

    * ghost variables. Keep them existentially qualified, with naming tag.
        ABS_GHOST ''name'' (λx. P x) ≡ ∃x. P x
        GHOST ''name'' value = True
        
        assumes ABS_GHOST name (λx. P x) 
        obtains x where "GHOST name x" "P x"
        
        assumes "GHOST name x" and "P x"
        shows "ABS_GHOST name (λx. P x)"
        
        Let_Ghost name (λx s. C x s) = skip
        
        assumes "∃x. C x s"
        assumes "⋀x. ⟦ GHOST name x; C x s ⟧ ⟹ Q s"
        shows "wp (Let_Ghost name (λx s. C x s)) Q s"
        
      Let specification command also abstract over ghost variables in program.
        
*)</span>  
  
<span class="comment1">(* IDEAS: 
  
  Extend arrays to multiple dimensions: int list ⇒ int
    Vidx vname "aexp list"
    AssignIdx vname "aexp list" aexp
    ArrayCpy vname vname  -- copy all dimensions (it's simpler)
    ArrayInit vname       -- Init all dimensions
    
    plain values on dimension []!

    then we can easily encode matrices and adjacency lists!
    
*)</span>  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Graph Algorithms›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹DFS›</span></span>
<span class="comment1">(* By Simon Wimmer *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A graph is stored as an array of integers. 
  Each node is an index into this array, pointing to a size-prefixed list of successors.

  Example for node <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span>, which has successors <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s1... sn›</span></span></span></span>:
  <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">▩</span></span><span class="raw_text"><span class="raw_text">‹
   Indexes: ... |  i  | i+1 | ... | i+n | ...
   Data:    ... |  n  | s1  | ... | sn  | ...
  ›</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">succs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succs</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">`</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Edges</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Edges</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> succs <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">push'</span> <span class="main">(</span>x<span class="main">,</span> stack<span class="main">,</span> ptr<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span>stack<span class="main">,</span> ptr<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ptr</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹lran <span class="skolem">stack</span> <span class="main">0</span> <span class="skolem">ptr</span> <span class="main">=</span> lran <span class="skolem">stack<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">0</span> <span class="skolem">ptr<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">ptr</span> <span class="main">=</span> <span class="skolem">ptr<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="main">1</span>›</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹stack<span class="main"><span class="main">[</span></span>ptr<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> x<span class="main"><span class="main">;</span></span> ptr <span class="main"><span class="main">=</span></span> ptr <span class="main"><span class="main">+</span></span> 1›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>

<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">push</span> <span class="main">(</span>x<span class="main">,</span> stack<span class="main">,</span> ptr<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span>stack<span class="main">,</span> ptr<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ptr</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">stack</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ptr</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">stack<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ptr<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">ptr</span> <span class="main">=</span> <span class="skolem">ptr<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="main">1</span>›</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> stack<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹stack<span class="main"><span class="main">[</span></span>ptr<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> x<span class="main"><span class="main">;</span></span> ptr <span class="main"><span class="main">=</span></span> ptr <span class="main"><span class="main">+</span></span> 1›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_image<span class="main">)</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">get_succs</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">stop</span> <span class="main">∧</span> <span class="skolem">stop</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"
    <span class="skolem">stack</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">j<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> Edges <span class="skolem">a</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> set_of <span class="skolem">visited</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">stack<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
    <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">for</span></span> i j stop stack<span class="main">[</span><span class="main">]</span> a<span class="main">[</span><span class="main">]</span> visited<span class="main">[</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">defines</span></span>
<span class="quoted">‹
  <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>j <span class="main"><span class="main">&lt;</span></span> stop<span class="main"><span class="keyword1">)</span></span>
  <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">stack</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">a</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">j<span class="hidden">⇩</span><sub>0</sub></span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∉</span> set_of <span class="skolem">visited</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">stack<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
    <span class="main">∧</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">stop</span> <span class="main">∧</span> <span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">j<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="skolem">j</span>
  ›</span></span>
  <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">stop</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span>›</span></span>
  <span class="main"><span class="main">{</span></span>
    succ <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>j<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
    is_elem <span class="main"><span class="main">=</span></span> bv_elem<span class="main"><span class="main">(</span></span>succ<span class="main"><span class="main">,</span></span>visited<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>is_elem <span class="main"><span class="main">==</span></span> 0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
      <span class="main"><span class="main">(</span></span>stack<span class="main"><span class="main">,</span></span> i<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> push <span class="main"><span class="main">(</span></span>succ<span class="main"><span class="main">,</span></span> stack<span class="main"><span class="main">,</span></span> i<span class="main"><span class="main">)</span></span>
    <span class="main"><span class="main">}</span></span><span class="main"><span class="main">;</span></span>
    j <span class="main"><span class="main">=</span></span> j <span class="main"><span class="main">+</span></span> 1
  <span class="main"><span class="main">}</span></span>
›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> intvs_incr_h Edges_def succs_def<span class="main">)</span>

<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">pop</span> <span class="main">(</span>stack<span class="main">,</span> ptr<span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> <span class="main">(</span>x<span class="main">,</span> ptr<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ptr</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">stack<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ptr<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">=</span> <span class="skolem">stack<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ptr</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">ptr<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">ptr</span> <span class="main">+</span> <span class="main">1</span>›</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> stack<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹ptr <span class="main"><span class="main">=</span></span> ptr <span class="main"><span class="main">-</span></span> 1<span class="main"><span class="main">;</span></span> x <span class="main"><span class="main">=</span></span> stack<span class="main"><span class="main">[</span></span>ptr<span class="main"><span class="main">]</span></span>›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intvs_upper_decr<span class="main">)</span>

<span class="keyword1"><span class="command">procedure_spec</span></span> <span class="entity">stack_init</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">returns</span></span> i
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">True</span> <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>›</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹i <span class="main"><span class="main">=</span></span> 0›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">vcg_cs</span>

<span class="keyword1"><span class="command">lemma</span></span> Edges_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Edges <span class="free">a</span> <span class="main">``</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≥</span> <span class="free">a</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> Edges_def succs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is one of the main insights of the algorithm: if a set of visited states is
closed w.r.t.\ to the edge relation, then it is guaranteed to contain all the states that
are reachable from any state within the set.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> reachability_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Edges <span class="free">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">visited</span><span class="main">.</span> Edges <span class="free">a</span> <span class="main">``</span> <span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">visited</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">visited</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">visited</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reachable start closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="main">(</span>partial<span class="main">)</span> <span class="entity">dfs</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>Edges <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted">‹
  b <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
  <span class="keyword2"><span class="keyword"><span class="keyword2">clear</span></span></span> stack<span class="main"><span class="main">[]</span></span><span class="main"><span class="main">;</span></span>
  i <span class="main"><span class="main">=</span></span> stack_init<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
  <span class="main"><span class="main">(</span></span>stack<span class="main"><span class="main">,</span></span> i<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> push <span class="main"><span class="main">(</span></span>s<span class="main"><span class="main">,</span></span> stack<span class="main"><span class="main">,</span></span> i<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
  <span class="keyword2"><span class="keyword"><span class="keyword2">clear</span></span></span> visited<span class="main"><span class="main">[]</span></span><span class="main"><span class="main">;</span></span>
  <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>b <span class="main"><span class="main">==</span></span> 0 <span class="main"><span class="main">∧</span></span> i <span class="main"><span class="main">≠</span></span> 0<span class="main"><span class="keyword1">)</span></span>
    <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">stack</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span> <span class="main">∨</span> <span class="skolem">s</span> <span class="main">∈</span> set_of <span class="skolem">visited</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
      <span class="skolem">stack</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span>Edges <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set_of <span class="skolem">visited</span><span class="main">.</span> <span class="main">(</span>Edges <span class="skolem">a</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">⊆</span> set_of <span class="skolem">visited</span> <span class="main">∪</span> <span class="skolem">stack</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∉</span> set_of <span class="skolem">visited</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>Edges <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">)</span>
  ›</span></span>
  <span class="main"><span class="main">{</span></span>
    <span class="main"><span class="main">(</span></span>next<span class="main"><span class="main">,</span></span> i<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> pop<span class="main"><span class="main">(</span></span>stack<span class="main"><span class="main">,</span></span> i<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span> <span class="comment1">―‹Take the top most element from the stack.›</span>
    visited <span class="main"><span class="main">=</span></span> bv_insert<span class="main"><span class="main">(</span></span>next<span class="main"><span class="main">,</span></span> visited<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span> <span class="comment1">―‹Mark it as visited,›</span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>next <span class="main"><span class="main">==</span></span> x<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
      b <span class="main"><span class="main">=</span></span> 1 <span class="comment1">―‹If it is the target, we are done.›</span>
    <span class="main"><span class="main">}</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
      <span class="comment1">―‹Else, put its successors on the stack if they are not yet visited.›</span>
      stop <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>next<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
      j <span class="main"><span class="main">=</span></span> next <span class="main"><span class="main">+</span></span> 1<span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>j <span class="main"><span class="main">≤</span></span> stop<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
        <span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">g</span>et_succs
      <span class="main"><span class="main">}</span></span>
    <span class="main"><span class="main">}</span></span>
  <span class="main"><span class="main">}</span></span>
›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> intvs_lower_incr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Edges_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reachability_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Assuming that the input graph is finite, we can also prove that the algorithm terminates.
We will thus use an <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Isabelle context›</span></span></span></span> to fix a certain finite graph and a start state:
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">start</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">edges</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_graph<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>Edges <span class="free">edges</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">start</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sub_insert_same_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊂</span> insert <span class="free">x</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">∉</span><span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">program_spec</span></span> <span class="entity">dfs1</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="free">start</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="free">edges</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">ensures</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>Edges <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> visited<span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">defines</span></span>
<span class="quoted">‹
  b <span class="main"><span class="main">=</span></span> 0<span class="main"><span class="main">;</span></span>
  <span class="comment1">―‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>i›</span></span> will point to the next free space in the stack (i.e. it is the size of the stack)›</span>
  i <span class="main"><span class="main">=</span></span> 1<span class="main"><span class="main">;</span></span>
  <span class="comment1">―‹Initially, we put <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>s›</span></span> on the stack.›</span>
  stack<span class="main"><span class="main">[</span></span>0<span class="main"><span class="main">]</span></span> <span class="main"><span class="main">=</span></span> s<span class="main"><span class="main">;</span></span>
  visited <span class="main"><span class="main">=</span></span> bv_init<span class="main"><span class="main">(</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
  <span class="keyword2"><span class="keyword"><span class="keyword1">while</span></span></span> <span class="main"><span class="keyword1">(</span></span>b <span class="main"><span class="main">==</span></span> 0 <span class="main"><span class="main">∧</span></span> i <span class="main"><span class="main">≠</span></span> 0<span class="main"><span class="keyword1">)</span></span>
    <span class="main"><span class="keyword1">@invariant</span></span> <span class="quoted"><span class="quoted">‹
    <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">∈</span> <span class="skolem">stack</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span> <span class="main">∨</span> <span class="skolem">s</span> <span class="main">∈</span> set_of <span class="skolem">visited</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
    set_of <span class="skolem">visited</span> <span class="main">⊆</span> <span class="main">(</span>Edges <span class="free">edges</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">start</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
      <span class="skolem">stack</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span>Edges <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set_of <span class="skolem">visited</span><span class="main">.</span> <span class="main">(</span>Edges <span class="skolem">a</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="main">⊆</span> set_of <span class="skolem">visited</span> <span class="main">∪</span> <span class="skolem">stack</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∉</span> set_of <span class="skolem">visited</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>Edges <span class="skolem">a</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">)</span>
    ›</span></span>
    <span class="main"><span class="keyword1">@relation</span></span> <span class="quoted"><span class="quoted">‹finite_psupset <span class="main">(</span><span class="main">(</span>Edges <span class="free">edges</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">start</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">&lt;*lex*&gt;</span> less_than›</span></span>
    <span class="main"><span class="keyword1">@variant</span></span> <span class="quoted"><span class="quoted">‹ <span class="main">(</span>set_of <span class="skolem">visited</span><span class="main">,</span> nat <span class="skolem">i</span><span class="main">)</span>›</span></span>
  <span class="main"><span class="main">{</span></span>
    <span class="comment1">―‹Take the top most element from the stack.›</span>
    <span class="main"><span class="main">(</span></span>next<span class="main"><span class="main">,</span></span> i<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> pop<span class="main"><span class="main">(</span></span>stack<span class="main"><span class="main">,</span></span> i<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
    <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>next <span class="main"><span class="main">==</span></span> x<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
      <span class="comment1">―‹If it is the target, we are done.›</span>
      visited <span class="main"><span class="main">=</span></span> bv_insert<span class="main"><span class="main">(</span></span>next<span class="main"><span class="main">,</span></span> visited<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      b <span class="main"><span class="main">=</span></span> 1
    <span class="main"><span class="main">}</span></span> <span class="keyword2"><span class="keyword"><span class="keyword1">else</span></span></span> <span class="main"><span class="main">{</span></span>
      is_elem <span class="main"><span class="main">=</span></span> bv_elem<span class="main"><span class="main">(</span></span>next<span class="main"><span class="main">,</span></span> visited<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
      <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>is_elem <span class="main"><span class="main">==</span></span> 0<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
        visited <span class="main"><span class="main">=</span></span> bv_insert<span class="main"><span class="main">(</span></span>next<span class="main"><span class="main">,</span></span> visited<span class="main"><span class="main">)</span></span><span class="main"><span class="main">;</span></span>
        <span class="comment1">―‹Else, put its successors on the stack if they are not yet visited.›</span>
        stop <span class="main"><span class="main">=</span></span> a<span class="main"><span class="main">[</span></span>next<span class="main"><span class="main">]</span></span><span class="main"><span class="main">;</span></span>
        j <span class="main"><span class="main">=</span></span> next <span class="main"><span class="main">+</span></span> 1<span class="main"><span class="main">;</span></span>
        <span class="keyword2"><span class="keyword"><span class="keyword1">if</span></span></span> <span class="main"><span class="keyword1">(</span></span>j <span class="main"><span class="main">≤</span></span> stop<span class="main"><span class="keyword1">)</span></span> <span class="main"><span class="main">{</span></span>
          <span class="keyword2"><span class="keyword"><span class="keyword1">inline</span></span></span> <span class="quoted">g</span>et_succs
        <span class="main"><span class="main">}</span></span>
      <span class="main"><span class="main">}</span></span>
    <span class="main"><span class="main">}</span></span>
  <span class="main"><span class="main">}</span></span>
›</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">vcg_cs</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_constant_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_psupset_def sub_insert_same_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_psupset_def sub_insert_same_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Edges_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_psupset_def sub_insert_same_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reachability_invariant<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>