<div id="Bell_Numbers">
<div class="head">
<h1>Theory Bell_Numbers</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Lukas Bulwahn &lt;lukas.bulwahn-at-gmail.com&gt; *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Bell Numbers and Spivey's Generalized Recurrence›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Bell_Numbers
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/FuncSet.html">HOL-Library.FuncSet</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Stirling.html">HOL-Library.Stirling</a>"</span>
  <a href="../Card_Partitions/Injectivity_Solver.html">Card_Partitions.Injectivity_Solver</a>
  <a href="../Card_Partitions/Card_Partitions.html">Card_Partitions.Card_Partitions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additions to FuncSet›</span></span>

<span class="comment1">(* this is clearly to be added to FuncSet *)</span>
<span class="keyword1"><span class="command">lemma</span></span> extensional_funcset_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> PiE_iff extensionalityI<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additions for Injectivity Proofs›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_impl_inj_on_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> inj_onI inj_on_image_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> injectivity_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∪</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">D</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">T</span><span class="main">.</span> <span class="free">P</span> <span class="bound">S</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">T</span> <span class="main">⟹</span> <span class="bound">S</span> <span class="main">∩</span> <span class="bound">T</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms Int_Un_distrib Int_commute inf_sup_absorb <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> injectivity_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">invert</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">invert</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> injectivity_image_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="free">F</span> <span class="bound">X</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="free">G</span> <span class="bound">X</span><span class="main">)</span> <span class="main">`</span> <span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">P'</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">F</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">P'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">G</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">∈</span> <span class="free">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∪</span> <span class="free">F</span> <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X'</span> <span class="main">∪</span> <span class="free">G</span> <span class="skolem">X'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="free">F</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">∈</span> <span class="free">P'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X'</span> <span class="main">∪</span> <span class="free">G</span> <span class="skolem">X'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">∈</span> <span class="free">P'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">∈</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∪</span> <span class="free">F</span> <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X'</span> <span class="main">∪</span> <span class="free">G</span> <span class="skolem">X'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> imageE image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span> <span class="main">∪</span> <span class="free">F</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">∈</span> <span class="free">P'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X'</span> <span class="main">∪</span> <span class="free">G</span> <span class="skolem">X'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of Bell Numbers›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Bell</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Bell</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span> <span class="bound">P</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Bell_altdef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Bell <span class="main">(</span>card <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_bij_betw_nat_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> bij <span class="keyword1"><span class="command">have</span></span> image_f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_surj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="bound">P</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊆</span> Pow <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this inj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span><span class="main">(`)</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inj_on_impl_inj_on_image<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Pow <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span>
     inj_on_impl_inj_on_image<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> inj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="main">(</span><span class="main">(`)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="bound">P</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> image_f_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_of_partition_on_map<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span><span class="main">(`)</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="free">A</span><span class="main">}</span> <span class="bound">P</span><span class="main">}</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free">A</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bij_betw_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Bell_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bij_betw_iff_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finitely_many_partition_on<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Bell_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Bell <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Bell_def partition_on_empty<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Construction of the Partitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">construct_partition_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">construct_partition_on</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span>
    <span class="keyword1">do</span> <span class="main">{</span>
       <span class="bound">k</span>  <span class="main">←</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>card <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">;</span>
       <span class="bound">j</span>  <span class="main">←</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>card <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span><span class="main">;</span>
       <span class="bound">P</span>  <span class="main">←</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="bound">j</span><span class="main">}</span><span class="main">;</span>
       <span class="bound">B'</span> <span class="main">←</span> <span class="main">{</span><span class="bound">B'</span><span class="main">.</span> <span class="bound">B'</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> card <span class="bound">B'</span> <span class="main">=</span> <span class="bound">k</span><span class="main">}</span><span class="main">;</span>
       <span class="bound">Q</span>  <span class="main">←</span> <span class="main">{</span><span class="bound">Q</span><span class="main">.</span> partition_on <span class="bound">B'</span> <span class="bound">Q</span><span class="main">}</span><span class="main">;</span>
       <span class="bound">f</span>  <span class="main">←</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">-</span> <span class="bound">B'</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">P</span><span class="main">;</span>
       <span class="bound">P'</span>  <span class="main">←</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">-</span> <span class="bound">B'</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="bound">P</span><span class="main">}</span><span class="main">;</span>
       <span class="main">{</span><span class="bound">P'</span> <span class="main">∪</span> <span class="bound">Q</span><span class="main">}</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> construct_partition_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"construct_partition_on <span class="free">B</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI'<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> construct_partition_on <span class="free">B</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="skolem"><span class="skolem">f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> card <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> card <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="free">C</span> <span class="skolem">P</span> <span class="main">∧</span> card <span class="skolem">P</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">∧</span> card <span class="skolem">B'</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="skolem">B'</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="skolem">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">=</span> <span class="skolem">P'</span> <span class="main">∪</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> construct_partition_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> P f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P' <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partition_on_insert_elements<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this Q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="main">∪</span> <span class="skolem">B'</span><span class="main">)</span> <span class="skolem">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q' <span class="keyword1"><span class="command">using</span></span> B' <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> partition_on_union<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_partition sup.assoc sup.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="bound">P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q'</span>
  <span class="keyword3"><span class="command">assume</span></span> Q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">Q'</span><span class="main">.</span> partition_on <span class="main">(</span><span class="free">B</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="bound">Q'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Q' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">Q'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">B</span> <span class="keyword1">then</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Q'</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">B</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="bound">X</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Q'</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> P' Q <span class="quoted"><span class="quoted">‹<span class="main">{}</span> <span class="main">∉</span> <span class="skolem">Q'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> Q'_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">=</span> <span class="skolem">P'</span> <span class="main">∪</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> P'_nosubset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Q' P' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> P'_witness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∩</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">=</span> <span class="main">⋃</span><span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> Q_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="skolem">B'</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B' Q' Q'_prop partition_on_split2 mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P'</span> <span class="main">=</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">Q'</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∪</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">Q'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">X'</span><span class="main">∈</span><span class="skolem">Q'</span><span class="main">.</span> <span class="bound">X</span> <span class="main">≠</span> <span class="bound">X'</span> <span class="main">⟶</span> <span class="bound">X</span> <span class="main">∩</span> <span class="bound">X'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Q' <span class="keyword1"><span class="command">unfolding</span></span> partition_on_def disjoint_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="skolem">P'</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> P' B' Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="free">C</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">Q'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Q' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff Un_iff mem_Collect_eq partition_on_partition_on_unique<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="skolem">Q'</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟶</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="skolem">B'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> B' Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this X <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="free">C</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">Q'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> partition_on_P'<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> partition_on_split1 Q'_prop Q' mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> P partition_on_P' P'_witness <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="free">C</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> partition_on_intersect_on_elements <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">C</span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> P'_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> X_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">)</span> <span class="main">∪</span> <span class="free">C</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> partition_on_P' <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> this X_subset <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">)</span> <span class="main">∪</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">xa</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> partition_on_P' <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_the_part_eq<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span>›</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">xa</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> partition_on_P' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_on_partition_on_unique<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> x_in X_subset <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">from</span></span> P'_nosubset <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> X_subset assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
           <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">from</span></span> this eq <span class="keyword1"><span class="command">have</span></span> y_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command">from</span></span> y y_in <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">X</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> partition_on_P' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_partition_on_unique<span class="main">)</span>
           <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> ex1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> the1I2<span class="main">)</span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">from</span></span> this ex1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the1I2<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x_in_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">}</span> <span class="main">=</span>  <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> partition_on_P' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_on_partition_on_unique<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> in_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> theI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∩</span> <span class="skolem">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> P'_witness <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">∈</span> <span class="skolem">P'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> partition_on_P'<span class="main">[</span><span class="operator">unfolded</span> partition_on_def disjoint_def<span class="main">]</span> in_p <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ex1 <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> x_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> the_equality<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="main">∪</span> <span class="free">C</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> partition_on_P' <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">B'</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∩</span> <span class="free">C</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">from</span></span> this x_in_image <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">P</span> <span class="main">⊆</span> <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> partition_on_P' <span class="keyword1"><span class="command">have</span></span> f_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partition_on_the_part_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Q B' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> card <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B'</span> <span class="main">⊆</span> <span class="free">B</span>›</span></span> k <span class="keyword1"><span class="command">have</span></span> k_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>card <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> card <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> j <span class="quoted"><span class="quoted">‹partition_on <span class="free">C</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> j_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>card <span class="free">C</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> partition_on_le_set_elements<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹partition_on <span class="free">C</span> <span class="skolem">P</span>›</span></span> j <span class="keyword1"><span class="command">have</span></span> P_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="free">C</span> <span class="skolem">P</span> <span class="main">∧</span> card <span class="skolem">P</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> k <span class="quoted"><span class="quoted">‹<span class="skolem">B'</span> <span class="main">⊆</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> B'_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">∧</span> card <span class="skolem">B'</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> construct_partition_on <span class="free">B</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_prop k_prop P_prop B'_prop Q_prop P'_prop f_prop Q'_prop
    <span class="keyword1"><span class="command">unfolding</span></span> construct_partition_on_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> atLeastAtMost_iff<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Injectivity of the Set Construction›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> injectivity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>partition_on <span class="free">C</span> <span class="free">P</span> <span class="main">∧</span> card <span class="free">P</span> <span class="main">=</span> <span class="free">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>partition_on <span class="free">C</span> <span class="free">P'</span> <span class="main">∧</span> card <span class="free">P'</span> <span class="main">=</span> <span class="free">j'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B'</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">∧</span> card <span class="free">B'</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">B''</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">∧</span> card <span class="free">B''</span> <span class="main">=</span> <span class="free">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"partition_on <span class="free">B'</span> <span class="free">Q</span> <span class="main">∧</span> partition_on <span class="free">B''</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">P</span> <span class="main">∧</span> <span class="free">g</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B''</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P''</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span> <span class="main">∧</span>
    <span class="free">P'''</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B''</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq_result<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P''</span> <span class="main">∪</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">P'''</span> <span class="main">∪</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> <span class="free">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B'</span> <span class="main">=</span> <span class="free">B''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">j'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">k'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> P_nonempty_sets<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">P'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">P''</span><span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">P'''</span><span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P' P_nonempty_sets <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Q'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> Q B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eq_result <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P''</span> <span class="main">=</span> <span class="free">P'''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> <span class="free">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> injectivity_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 1 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this Q <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> <span class="free">Q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B'</span> <span class="main">=</span> <span class="free">B''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> partition_on_eq_implies_eq_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> subset_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">P'</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B''</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P' <span class="quoted"><span class="quoted">‹<span class="free">P''</span> <span class="main">=</span> <span class="free">P'''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> injectivity_image_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subset_C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B'</span> <span class="main">=</span> <span class="free">B''</span>›</span></span> eq_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> P_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="bound">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> invert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="bound">X</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> P_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eq3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> injectivity_image<span class="main">[</span><span class="operator">OF</span> eq2 invert<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> eq4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> partition_onE<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∩</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">∩</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">⊆</span> <span class="free">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> eq3 <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this disjoint <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> injectivity_union<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> eq4 f <span class="keyword1"><span class="command">have</span></span> eq5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">∈</span><span class="free">B</span> <span class="main">-</span> <span class="free">B'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> eq5 f <span class="quoted"><span class="quoted">‹<span class="free">B'</span> <span class="main">=</span> <span class="free">B''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> eq6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extensional_funcset_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">=</span> <span class="free">P'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> B' <span class="quoted"><span class="quoted">‹<span class="free">B'</span> <span class="main">=</span> <span class="free">B''</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Generalized Bell Recurrence Relation›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Bell_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Bell <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="bound">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="free">m</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">{</span><span class="free">n</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">B</span> <span class="main">∪</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∩</span> <span class="skolem">C</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">B</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">C</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def B_def C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> step1<span class="main">:</span> <span class="quoted"><span class="quoted">"Bell <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Bell_def A_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">B</span> <span class="main">∪</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">∩</span> <span class="skolem">C</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">C</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> step2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">A</span> <span class="bound">P</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span>construct_partition_on <span class="skolem">B</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> construct_partition_on<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> injectivity <span class="main">=</span> injectivity<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">B</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">∩</span></span></span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem"><span class="skolem">C</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">{}</span></span></span></span></span></span>›</span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">k</span>  <span class="main">←</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>card <span class="skolem">B</span><span class="main">}</span><span class="main">;</span>
    <span class="bound">j</span>  <span class="main">←</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>card <span class="skolem">C</span><span class="main">}</span><span class="main">;</span>
    <span class="bound">P</span>  <span class="main">←</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">C</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="bound">j</span><span class="main">}</span><span class="main">;</span>
    <span class="bound">B'</span> <span class="main">←</span> <span class="main">{</span><span class="bound">B'</span><span class="main">.</span> <span class="bound">B'</span> <span class="main">⊆</span> <span class="skolem">B</span> <span class="main">∧</span> card <span class="bound">B'</span> <span class="main">=</span> <span class="bound">k</span><span class="main">}</span><span class="main">;</span>
    <span class="bound">Q</span>  <span class="main">←</span> <span class="main">{</span><span class="bound">Q</span><span class="main">.</span> partition_on <span class="bound">B'</span> <span class="bound">Q</span><span class="main">}</span><span class="main">;</span>
    <span class="bound">f</span>  <span class="main">←</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="bound">B'</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="bound">P</span><span class="main">;</span>
    <span class="bound">P'</span>  <span class="main">←</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">-</span> <span class="bound">B'</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="bound">P</span><span class="main">}</span><span class="main">;</span>
    <span class="main">{</span><span class="bound">P'</span> <span class="main">∪</span> <span class="bound">Q</span><span class="main">}</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{..</span>card <span class="skolem">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?comp</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{..</span> card <span class="skolem">C</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?comp</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_Collect_conjI disjI1 finitely_many_partition_on<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
        <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">C</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partition_on <span class="skolem">C</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?comp</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> P <span class="quoted"><span class="quoted">‹finite <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_elements<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B'</span>
          <span class="keyword3"><span class="command">assume</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">B'</span><span class="main">.</span> <span class="bound">B'</span> <span class="main">⊆</span> <span class="skolem">B</span> <span class="main">∧</span> card <span class="bound">B'</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?comp</span> <span class="skolem">B'</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">Q</span><span class="main">.</span> partition_on <span class="skolem">B'</span> <span class="bound">Q</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finitely_many_partition_on<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span>
            <span class="keyword3"><span class="command">assume</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">Q</span><span class="main">.</span> partition_on <span class="skolem">B'</span> <span class="bound">Q</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?comp</span> <span class="skolem">Q</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">B</span> <span class="main">-</span> <span class="skolem">B'</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="skolem">P</span>"</span></span>
              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?comp</span> <span class="skolem">f</span>"</span></span>
              <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⤜</span> <span class="var">?comp</span>"</span></span> <span class="main">=</span> <span class="var"><span class="quoted"><span class="var">?expr</span></span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> disjoint_family_onI<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_bind_constant<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_bind<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span> <span class="main">∧</span> card <span class="var">?expr</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_PiE<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> P B' Q
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> local.injectivity<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="skolem">B'</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> B' <span class="quoted"><span class="quoted">‹finite <span class="skolem">B'</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">B</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Diff_subset<span class="main">)</span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> P
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_PiE<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_constant<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_bind_constant<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">P</span><span class="main">.</span> partition_on <span class="skolem">C</span> <span class="bound">P</span> <span class="main">∧</span> card <span class="bound">P</span> <span class="main">=</span> <span class="skolem">j</span><span class="main">}</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_bind<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span> <span class="main">∧</span> card <span class="var">?expr</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> inner <span class="main">=</span> this
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> Bell <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> B' <span class="quoted"><span class="quoted">‹finite <span class="skolem">B'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Bell_altdef<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> P B'
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> local.injectivity<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_bind_constant<span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> inner <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_bind<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span> <span class="main">∧</span> card <span class="var">?expr</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> inner <span class="main">=</span> this
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">B</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_subsets<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> P
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> local.injectivity<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_bind_constant<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inner <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_bind<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span> <span class="main">∧</span> card <span class="var">?expr</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> inner <span class="main">=</span> this
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S</span> <span class="main">=</span> Stirling <span class="free">m</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">C</span> <span class="main">=</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_partition_on<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> local.injectivity<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="free">m</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_bind_constant<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inner <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_bind<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span> <span class="main">∧</span> card <span class="var">?expr</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="free">m</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> inner <span class="main">=</span> this
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> local.injectivity<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?expr</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="bound">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="free">m</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?formula</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">C</span> <span class="main">=</span> <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_bind<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inner <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_bind<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?expr</span> <span class="main">∧</span> card <span class="var">?expr</span> <span class="main">=</span> <span class="var">?formula</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"disjoint_family_on <span class="var">?comp</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">injectivity_solver</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> local.injectivity<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> step3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>construct_partition_on <span class="skolem">B</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> <span class="bound">j</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> Stirling <span class="free">m</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> construct_partition_on_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="skolem">B</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_bind<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> step1 step2 step3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Corollaries of the Generalized Bell Recurrence›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> Bell_Stirling_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Bell <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> Stirling <span class="free">m</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Bell <span class="free">m</span> <span class="main">=</span> Bell <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">≤</span><span class="free">m</span><span class="main">.</span> Stirling <span class="free">m</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Bell_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Bell_0<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> Bell_recursive_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Bell <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> Bell <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Bell_eq<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>