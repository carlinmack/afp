<div id="Graph">
<div class="head">
<h1>Theory Graph</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Graph
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>



<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Rooted Graphs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we model rooted graphs and their sub\hyp{}paths and paths. We give a number 
of lemmas that will help proofs in the following theories, but that are very specific to our 
approach.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we will need the following simple lemma, which is not graph related, but that will 
prove useful when we will want to exhibit the last element of a non-empty sequence.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> neq_Nil_conv2 <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="bound">xs'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Definitions and Properties›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Edges›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We model edges by a record <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v edge›</span></span></span></span> which is parameterized by the type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v›</span></span></span></span> 
of vertices. This allows us to represent the red part
of red-black graphs as well as the black part (i.e. LTS) using extensible records (more on this later). Edges have two 
components, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">src</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">tgt</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which respectively give their source and target.›</span></span>


<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'v</span> edge <span class="main">=</span> 
  src   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span>"</span></span>
  tgt   <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Rooted graphs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We model rooted graphs by the record <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v rgraph›</span></span></span></span>. It consists of two components: its 
root and its set of edges.›</span></span>


<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'v</span> rgraph <span class="main">=</span>
  root  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span>"</span></span>
  edges <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> edge set"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Vertices›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of vertices of a rooted graph is made of its root and the endpoints of its 
edges. Isabelle/HOL provides \emph{extensible records}, i.e.\ it is possible to define records using 
existing records by adding components. The following definition suppose that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is of type 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>('v,'x) rgraph_scheme›</span></span></span></span>, i.e.\ an object that has at least all the components of a 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v rgraph›</span></span></span></span>. The second type parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'x›</span></span></span></span> stands for the hypothetical type 
parameters that such an object could have in addition of the type of vertices <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v›</span></span></span></span>. 
Using <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>('v,'x) rgraph_scheme›</span></span></span></span> instead of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v rgraph›</span></span></span></span> allows to reuse the following 
definition(s) for all type of objects that have at least the components of a rooted graph. For 
example, we will reuse the following definition to characterize the set of locations of a LTS (see 
\verb?LTS.thy?).›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vertices</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vertices</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">{</span>root <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">}</span> <span class="main">∪</span> src <span class="main">`</span>edges <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∪</span> tgt <span class="main">`</span> edges <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic properties of rooted graphs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, we will be only interested in loop free rooted graphs
and in what we call 
\emph{well formed rooted graphs}. A well formed rooted graph is rooted graph that has an empty set 
of edges or, if this is not the case, has at least one edge whose source is its root.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">loop_free</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">loop_free</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> edges <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">.</span> src <span class="bound">e</span> <span class="main">≠</span> tgt <span class="bound">e</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wf_rgraph</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wf_rgraph</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> root <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> src <span class="main">`</span> edges <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span>edges <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Even if we are only interested in this kind of rooted graphs, we will not assume the graphs 
are loop free or well formed when this is not needed.›</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Out-going edges›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This abbreviation will prove handy in the following.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">out_edges</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> edge set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">out_edges</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> edges <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">.</span> src <span class="bound">e</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span>"</span></span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Consistent Edge Sequences, Sub-paths and Paths›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Consistency of a sequence of edges›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A sequence of edges <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is consistent from
vertex <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to another vertex <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if it is empty, or, if it is 
not empty:
\begin{itemize}
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the source of its first element, and
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the target of its last element, and
  \item the target of each of its elements is the source of its follower.
\end{itemize}›</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ces</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> edge list <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ces</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ces</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">∧</span> <span class="free">ces</span> <span class="main">(</span>tgt <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-paths and paths›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a rooted graph, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a sequence of edges and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v2›</span></span></span></span> two vertices. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a sub-path in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if:
\begin{itemize}
  \item it is consistent from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a vertex of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  \item all of its elements are edges of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{itemize}

The second constraint is needed in the case of the empty sequence: without it,
the empty sequence would be a sub-path of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> even when <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not one of 
its vertices.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subpath</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> edge list <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subpath</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">≡</span> ces <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">∈</span> vertices <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">⊆</span> edges <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a sub-path of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> leading from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are both vertices of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> fst_of_sp_is_vert <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∈</span> vertices <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> lst_of_sp_is_vert <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">∈</span> vertices <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subpath_def vertices_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty sequence of edges is a sub-path from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if and only if 
they are equal and belong to the graph.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty sequence is a sub-path from the root of any rooted graph.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="main">(</span>root <span class="free">g</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span>root <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def subpath_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, we will not always be interested in the final vertex of a sub-path. We 
will use the abbreviation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">subpath_from</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whenever this final vertex has no importance, and 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">subpath</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> otherwise.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subpath_from</span>  <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> edge list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subpath_from</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> subpath <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="bound">v'</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subpaths_from</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> edge list set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subpaths_from</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">es</span><span class="main">.</span> subpath_from <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">es</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A path is a sub-path starting at the root of the graph.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">path</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'v</span> edge list <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">path</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> subpath <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">paths</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'a</span> edge list set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">paths</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">es</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> path <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">es</span> <span class="bound">v</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty sequence is a path of any rooted graph.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> paths <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def vertices_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some useful simplification lemmas for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"subpath"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_one <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="free">v2</span> <span class="main">=</span> <span class="main">(</span>src <span class="free">e</span> <span class="main">=</span> <span class="free">v1</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> edges <span class="free">g</span> <span class="main">∧</span> tgt <span class="free">e</span> <span class="main">=</span> <span class="free">v2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def vertices_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> sp_Cons <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">(</span><span class="free">e</span><span class="main">#</span><span class="free">es</span><span class="main">)</span> <span class="free">v2</span> <span class="main">=</span> <span class="main">(</span>src <span class="free">e</span> <span class="main">=</span> <span class="free">v1</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> edges <span class="free">g</span> <span class="main">∧</span> subpath <span class="free">g</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="free">es</span> <span class="free">v2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def vertices_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> sp_append_one <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">(</span><span class="free">es</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="free">v2</span> <span class="main">=</span> <span class="main">(</span>subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> edges <span class="free">g</span> <span class="main">∧</span> tgt <span class="free">e</span> <span class="main">=</span> <span class="free">v2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def vertices_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> sp_append <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">(</span><span class="free">es1</span><span class="main">@</span><span class="free">es2</span><span class="main">)</span> <span class="free">v2</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es1</span> <span class="bound">v</span> <span class="main">∧</span> subpath <span class="free">g</span> <span class="bound">v</span> <span class="free">es2</span> <span class="free">v2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es1</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span>
   <span class="main">(</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fst_of_sp_is_vert sp_Cons<span class="main">)</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A sub-path leads to a unique vertex.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_same_src_imp_same_tgt <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v</span> <span class="free">es</span> <span class="free">v1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v</span> <span class="free">es</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span>  sp_Cons subpath_def vertices_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, we are interested in the evolution of the set of sub-paths of our symbolic 
execution graph after symbolic execution of a transition from the LTS representation of the program 
under analysis. Symbolic execution of a transition results in adding to the graph a new edge whose 
source is already a vertex of this graph, but not its target. The following lemma describes 
sub-paths ending in the target of such an edge.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be an edge whose target has not out-going edges. A sub-path <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
containing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> ends by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and this occurrence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is unique along 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_through_de_decomp <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="free">g</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">es'</span><span class="main">.</span> <span class="free">es</span> <span class="main">=</span> <span class="bound">es'</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∉</span> set <span class="bound">es'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e'</span> <span class="skolem">es</span><span class="main">)</span> 
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="skolem">e'</span> <span class="main">∨</span> <span class="main">(</span><span class="free">e</span> <span class="main">≠</span> <span class="skolem">e'</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> set <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sp_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">e'</span>"</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Adding Edges›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This definition and the following lemma are here mainly to ease the definitions and proofs 
in the next theories.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">add_edge</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'v</span> edge <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_edge</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> rgraph.edges_update <span class="main">(</span><span class="main">λ</span> <span class="bound">edges</span><span class="main">.</span> <span class="bound">edges</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a sub-path from a vertex other than the target of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the 
graph obtained from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by the addition of edge <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Moreover, assume that the 
target of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not a vertex of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an element of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_ends_in_tgt_imp_mem <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tgt <span class="free">e</span> <span class="main">∉</span> vertices <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> tgt <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>add_edge <span class="free">g</span> <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="free">es</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> neq_Nil_conv2<span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one vertices_def image_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trees›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define trees as rooted-graphs in which there exists a unique path leading to each vertex.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_tree</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_tree</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> Graph.vertices <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">.</span> <span class="main">∃!</span> <span class="bound">p</span><span class="main">.</span> Graph.path <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">p</span> <span class="bound">l</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty graph is thus a tree.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> empty_graph_is_tree <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"edges <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_tree <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> is_tree_def subpath_def vertices_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Aexp">
<div class="head">
<h1>Theory Aexp</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Aexp
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Arithmetic Expressions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we model arithmetic expressions as total functions from valuations of 
program variables to values. This modeling does not take into consideration the syntactic aspects 
of arithmetic expressions. Thus, our modeling holds for any operator. However, some classical 
notions, like the set of variables occurring in a given expression for example, must be rethought 
and defined accordingly.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Variables and their domain›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\textbf{Note}: in the following theories, we distinguish the set of \emph{program variables} 
and the set 
of \emph{symbolic variables}. A number of types we define are parameterized by a type of variables. 
For example, we make a distinction between expressions (arithmetic or boolean) over program 
variables and expressions over symbolic variables. This distinction eases some parts of the following 
formalization.›</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Symbolic variables.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A \emph{symbolic variable} is an indexed version of a program variable. In the following 
type-synonym, we consider that the abstract type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v›</span></span></span></span> represent the set of program 
variables. By set 
of program variables, we do not mean \emph{the set of variables of a given program}, but 
\emph{the set of variables of all possible programs}. This distinction justifies some of the 
modeling choices done later. Within Isabelle/HOL, nothing is known about this set. The set of 
program variables is infinite, though it is not needed to make this assumption. On the other hand, 
the set of symbolic variables is infinite, independently of the fact that the set of program 
variables is finite or not.›</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'v</span> symvar <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">×</span> nat"</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> finite <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'v</span> symvar set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_prod<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The previous lemma has no name and thus cannot be referenced in the following. Indeed, it is 
of no use for proving the properties we are interested in. In the following, we will give other
unnamed lemmas when we think they might help the reader to understand the ideas behind our modeling 
choices.›</span></span>


<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Domain of variables.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We call <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">D</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the domain of program and symbolic variables. In the following, we 
suppose that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">D</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the set of integers.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Program and symbolic states›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A state is a total function giving values in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">D</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to variables. The latter are 
represented by elements of type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v›</span></span></span></span>. Unlike in the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v symvar›</span></span></span></span> type-synonym, here 
the type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v›</span></span></span></span> can stand for program variables as well as symbolic variables. States over 
program variables are called \emph{program states}, and states over symbolic variables are called 
\emph{symbolic states}.›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The \emph{aexp} type-synonym›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Arithmetic (and boolean, see \verb?Bexp.thy?) expressions are represented by their 
semantics, i.e.\ 
total functions giving values in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">D</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to states. This way of representing expressions has 
the benefit that it is not necessary to define the syntax of terms (and formulae) appearing 
in program statements and path predicates.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> aexp <span class="main">=</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to represent expressions over program variables as well as symbolic variables, 
the type synonym <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> "aexp"<span class="antiquote"><span class="antiquote">}</span></span></span></span> is parameterized by the type of variables. Arithmetic and boolean 
expressions over program variables are used to express program statements. Arithmetic and boolean 
expressions over symbolic variables are used to represent the constraints occurring in path 
predicates during symbolic execution.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Variables of an arithmetic expression›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Expressions being represented by total functions, one can not say that a given variable is 
occurring in a given expression. We define the set of variables of an expression as the set of 
variables that can actually have an influence on the value associated by an expression to a state. 
For example, the set of variables of the expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">σ</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">σ</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">σ</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
provided that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are distinct variables, and the empty set otherwise. In 
the second case, this expression would evaluate to $0$ for any state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Similarly, an expression like
 <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">σ</span></span><span class="main"><span class="main">.</span></span>  <span class="bound"><span class="bound">σ</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>nat<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is considered as having no
 variable as if a static evaluation of the multiplication had occurred.
›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vars</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> aexp <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">σ</span> <span class="bound">val</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="bound">v</span> <span class="main">:=</span> <span class="bound">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">σ</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> vars_example_1 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span>integer<span class="main">)</span> aexp"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="free">x</span> <span class="main">-</span> <span class="bound">σ</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"vars <span class="free">e</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> vars <span class="free">e</span>"</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">val</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">e</span> <span class="skolem">σ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span>"</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> vars <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vars_def<span class="main">)</span> 
     <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">0</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> vars_example_2 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span>integer<span class="main">)</span> aexp"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="free">x</span> <span class="main">-</span> <span class="bound">σ</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"vars <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vars_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Fresh variables›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our notion of symbolic execution suppose \emph{static single assignment 
form}. In order to symbolically execute an assignment, we require the existence of a fresh 
symbolic variable for the configuration from which symbolic execution is performed. We define here 
the notion of \emph{freshness} of a variable for an arithmetic expression.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A variable is fresh for an expression if does not belong to its set of variables.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fresh</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> aexp <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fresh</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∉</span> vars <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
 
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Bexp">
<div class="head">
<h1>Theory Bexp</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Bexp
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Aexp.html">Aexp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Boolean Expressions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We proceed as in \verb?Aexp.thy?.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Basic definitions›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The $\mathit{bexp}$ type-synonym›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We represent boolean expressions, their set of variables and the notion of freshness of a 
variable in the same way than for arithmetic expressions.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vars</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">σ</span> <span class="bound">val</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="bound">σ</span><span class="main">(</span><span class="bound">v</span> <span class="main">:=</span> <span class="bound">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">σ</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fresh</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fresh</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∉</span> vars <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Satisfiability of an expression›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A boolean expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is satisfiable if there exists a state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such 
that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span> <span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is \emph{true}.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sat</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">σ</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Entailment›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A boolean expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> entails another boolean expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ψ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if all 
states making <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> true also make <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ψ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> true.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">entails</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span>"</span> 55<span class="main">)</span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>B</sub></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">σ</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Conjunction›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, path predicates are represented by sets of boolean expressions. We define 
the conjunction of a set of boolean expressions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">E</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as the expression that 
associates \emph{true} to a state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if, for all elements <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>e›</span></span></span></span> of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">E</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> associates \emph{true} to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">conjunct</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">conjunct</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">.</span> <span class="bound">e</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Properties about the variables of an expression›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As said earlier, our definition of symbolic execution requires the existence of a fresh 
symbolic variable in the case of an assignment. In the following, a number of proof relies on this 
fact. We will show the existence of such variables assuming the set of symbolic variables already in 
use is finite and show that symbolic execution preserves the finiteness of this set, under certain 
conditions. This in turn 
requires a number of lemmas about the finiteness of boolean expressions.
More precisely, when symbolic execution goes through a guard or an assignment, it conjuncts a new 
expression to the path predicate. In the case of an assignment, this new expression is an equality 
linking the new symbolic variable associated to the defined program variable to its symbolic value. 
In the following, we prove that:
\begin{enumerate}
  \item the conjunction of a finite set of expressions whose sets of variables are finite has a 
finite set of variables,
  \item the equality of two arithmetic expressions whose sets of variables are finite has a finite 
set of variables.
\end{enumerate}›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Variables of a conjunction›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of variables of the conjunction of two expressions is a subset of the union of the 
sets of variables of the two sub-expressions. As a consequence, the set of variables of the conjunction 
of a finite set of expressions whose sets of variables are finite is also finite.›</span></span> 


<span class="keyword1"><span class="command">lemma</span></span> vars_of_conj <span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="free">e1</span> <span class="bound">σ</span> <span class="main">∧</span> <span class="free">e2</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">⊆</span> vars <span class="free">e1</span> <span class="main">∪</span> vars <span class="free">e2</span>"</span></span> 
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"vars <span class="var">?e</span> <span class="main">⊆</span> vars <span class="free">e1</span> <span class="main">∪</span> vars <span class="free">e2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> subset_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> vars <span class="var">?e</span>"</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">val</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?e</span> <span class="skolem">σ</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">e1</span> <span class="skolem">σ</span> <span class="main">∨</span> <span class="free">e2</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">e2</span> <span class="skolem">σ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> vars <span class="free">e1</span> <span class="main">∪</span> vars <span class="free">e2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> finite_conj <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span><span class="main">.</span> finite <span class="main">(</span>vars <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vars <span class="main">(</span>conjunct <span class="free">E</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vars_def conjunct_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">e</span> <span class="skolem">E</span><span class="main">)</span> 

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">using</span></span> vars_of_conj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="quoted">"conjunct <span class="skolem">E</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rev_finite_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> conjunct_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Variables of an equality›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We proceed analogously for the equality of two arithmetic expressions.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> vars_of_eq_a <span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="free">e1</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">e2</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">⊆</span> Aexp.vars <span class="free">e1</span> <span class="main">∪</span> Aexp.vars <span class="free">e2</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"vars <span class="var">?e</span> <span class="main">⊆</span> Aexp.vars <span class="free">e1</span> <span class="main">∪</span> Aexp.vars <span class="free">e2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> subset_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> vars <span class="var">?e</span>"</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?e</span> <span class="skolem">σ</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">e1</span> <span class="skolem">σ</span> <span class="main">∨</span> <span class="free">e2</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">e2</span> <span class="skolem">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> Aexp.vars <span class="free">e1</span> <span class="main">∪</span> Aexp.vars <span class="free">e2</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Aexp.vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> finite_vars_of_a_eq <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Aexp.vars <span class="free">e1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Aexp.vars <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vars <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="free">e1</span> <span class="bound">σ</span> <span class="main">=</span> <span class="free">e2</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms vars_of_eq_a<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e1</span></span> <span class="quoted"><span class="free">e2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rev_finite_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Labels">
<div class="head">
<h1>Theory Labels</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Labels
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Aexp.html">Aexp</a> <a href="Bexp.html">Bexp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* DEF : 2 *)</span>
<span class="comment1">(* LEM : 0 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Labels›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, we model programs by control flow graphs where edges (rather than vertices) are labelled 
with either assignments or with the condition associated with a branch of a conditional statement.
We put a label on every edge : statements that do not modify the program state (like \verb?jump?, 
\verb?break?, etc) are labelled by a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Skip</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label <span class="main">=</span> Skip <span class="main">|</span> Assume <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp"</span></span> <span class="main">|</span> Assign <span class="tfree"><span class="quoted"><span class="tfree">'v</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> aexp"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We say that a label is \emph{finite} if the set of variables of its sub-expression is 
finite (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Skip</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> labels are thus considered finite).›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finite_label</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finite_label</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> 
                    Assume <span class="bound">e</span>   <span class="main">⇒</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span> 
                  <span class="main">|</span> Assign <span class="main"><span class="bound">_</span></span> <span class="bound">e</span> <span class="main">⇒</span> finite <span class="main">(</span>Aexp.vars <span class="bound">e</span><span class="main">)</span> 
                  <span class="main">|</span> <span class="main"><span class="bound">_</span></span>          <span class="main">⇒</span> True"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">finite_labels</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label list <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finite_labels</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">.</span> finite_label <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Store">
<div class="head">
<h1>Theory Store</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Store
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Aexp.html">Aexp</a> <a href="Bexp.html">Bexp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Stores›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we introduce the type of stores, which we use to link program variables 
with their symbolic counterpart during symbolic execution. We define the notion of consistency 
of a pair of program and symbolic states w.r.t.\ a store. This notion will prove helpful when 
defining various concepts and proving facts related to subsumption (see \verb?Conf.thy?). Finally, we 
model substitutions that will be performed during symbolic execution (see \verb?SymExec.thy?) by two 
operations: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">adapt_aexp</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">adapt_bexp</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic definitions›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">store</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> type-synonym›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Symbolic execution performs over configurations (see \verb?Conf.thy?), which are pairs made 
of:
\begin{itemize} 
\item a \emph{store} mapping program variables to symbolic variables,
\item a set of boolean expressions which records constraints over symbolic variables and whose 
conjunction is the actual path predicate of the configuration.
\end{itemize}
We define stores as total functions from program variables to indexes.›</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> store <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Symbolic variables of a store›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The symbolic variable associated to a program variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by a store 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the couple <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">v</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">s</span></span> <span class="free"><span class="free">v</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">symvar</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> store <span class="main">⇒</span> <span class="tfree">'a</span> symvar"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">symvar</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function associating symbolic variables to program variables obtained from 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is injective.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> symvar <span class="bound">v</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> inj_on_def symvar_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The sets of symbolic variables of a store is the image set of the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"symvar"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">symvars</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> store <span class="main">⇒</span> <span class="tfree">'a</span> symvar set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">symvars</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> symvar <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Fresh symbolic variables›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A symbolic variable is said to be fresh for a store if it is not a member of its set of 
symbolic variables.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fresh_symvar</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> symvar <span class="main">⇒</span> <span class="tfree">'v</span> store <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">fresh_symvar</span> <span class="free"><span class="bound"><span class="entity">sv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sv</span></span></span> <span class="main">∉</span> symvars <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Consistency›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We say that a program state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a symbolic state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are 
\emph{consistent} with respect to a store <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if, for each variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the 
value associated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is equal to the value associated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
to the symbolic variable associated to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> symvar<span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'v</span> store <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">consistent</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span></span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">v</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There always exists a couple of consistent states for a given store.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ</span> <span class="bound">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span><span class="main">.</span> consistent <span class="bound">σ</span> <span class="bound">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> consistent_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Moreover, given a store and a program (resp. symbolic) state, one can always build a symbolic 
(resp. program) state such that the two states are coherent wrt.\ the store. The four following 
lemmas show how to build the second state given the first one.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> consistent_eq1 <span class="main">:</span>
  <span class="quoted"><span class="quoted">"consistent <span class="free">σ</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">sv</span> <span class="main">∈</span> symvars <span class="free">s</span><span class="main">.</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">sv</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">(</span>fst <span class="bound">sv</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> consistent_def symvars_def symvar_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> consistent_eq2 <span class="main">:</span>
  <span class="quoted"><span class="quoted">"consistent <span class="free">σ</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="free">store</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free">store</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> consistent_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> consistentI1 <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"consistent <span class="free">σ</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">sv</span><span class="main">.</span> <span class="free">σ</span> <span class="main">(</span>fst <span class="bound">sv</span><span class="main">)</span><span class="main">)</span> <span class="free">store</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> consistent_eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">lemma</span></span> consistentI2 <span class="main">:</span>
  <span class="quoted"><span class="quoted">"consistent <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free">store</span><span class="main">)</span><span class="main">)</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="free">store</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> consistent_eq2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Adaptation of an arithmetic expression to a store›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Suppose that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a term representing an arithmetic expression over program 
variables and let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a store. We call \emph{adaptation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>} 
the term obtained by substituting occurrences of program variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by their 
symbolic counterpart given by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Since we model arithmetic expressions by total 
functions and not terms, we define the adaptation of such expressions as follows.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adapt_aexp</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> aexp <span class="main">⇒</span> <span class="tfree">'v</span> store <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> symvar<span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> aexp"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">adapt_aexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given an arithmetic expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, a program state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a symbolic 
state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> coherent with a store <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the value associated to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by 
the adaptation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the same than the value associated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This confirms the fact that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"adapt_aexp"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> models the act of substituting 
occurrences of program variables by their symbolic counterparts in a term over program variables.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> adapt_aexp_is_subst <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">σ</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">=</span> <span class="free">e</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> consistent_eq2 adapt_aexp_def<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As said earlier, we will later need to prove that symbolic execution preserves finiteness 
of the set of symbolic variables in use, which requires that the adaptation of an arithmetic 
expression to a store preserves finiteness of the set of variables of expressions. We proceed as 
follows.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we show that if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a variable of an expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
then the symbolic variable associated to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by a store is a variable of the adaptation of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to this store.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> var_imp_symvar_var <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Aexp.vars <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"symvar <span class="free">v</span> <span class="free">s</span> <span class="main">∈</span> Aexp.vars <span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sv</span> <span class="main">∈</span> Aexp.vars <span class="var">?e'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">e</span> <span class="skolem">σ</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Aexp.vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">sv</span><span class="main">.</span> <span class="skolem">σ</span> <span class="main">(</span>fst <span class="bound">sv</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="var">?sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="bound">va</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> symvar_def<span class="main">)</span>  

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aexp.vars_def mem_Collect_eq
  <span class="keyword1"><span class="command">using</span></span> consistentI1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> 
        consistentI2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">sv</span><span class="main">.</span> <span class="skolem">σ</span> <span class="main">(</span>fst <span class="bound">sv</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="var">?sv</span><span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">sv</span><span class="main">.</span> <span class="skolem">σ</span> <span class="main">(</span>fst <span class="bound">sv</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">val</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> adapt_aexp_is_subst<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹On the other hand, if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">sv</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a symbolic variable in the adaptation of an expression 
to a store, then the program variable it represents is a variable of this expression. This requires 
to prove that the set of variables of the adaptation of an expression to a store is a subset of the 
symbolic variables of this store.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> symvars_of_adapt_aexp <span class="main">:</span>
  <span class="quoted"><span class="quoted">"Aexp.vars <span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> symvars <span class="free">s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Aexp.vars <span class="var">?e'</span> <span class="main">⊆</span> symvars <span class="free">s</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> subset_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sv</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">∈</span> Aexp.vars <span class="var">?e'</span>"</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span> <span class="skolem"><span class="skolem">val</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e'</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?e'</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Aexp.vars_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="bound">x</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="bound">x</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span><span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="bound">x</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="bound">x</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e'</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?e'</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> adapt_aexp_def<span class="main">)</span>
    
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?e'</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?e'</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="skolem">v</span> <span class="free">s</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="skolem">v</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">=</span> symvar <span class="skolem">v</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">=</span> symvar <span class="skolem">v</span> <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">∈</span> symvars <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> symvars_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> symvar_var_imp_var <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sv</span> <span class="main">∈</span> Aexp.vars <span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">sv</span> <span class="main">∈</span> Aexp.vars <span class="var">?e'</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="free">sv</span> <span class="main">∈</span> Aexp.vars <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sv</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">s</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> symvars_of_adapt_aexp 
  <span class="keyword1"><span class="command">unfolding</span></span> symvars_def symvar_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e'</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?e'</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Aexp.vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sv</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">s</span> <span class="skolem">v</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> symvar_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sv</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">s</span> <span class="skolem">v</span><span class="main">)</span>›</span></span> 
        consistentI2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> 
        consistentI2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aexp.vars_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> adapt_aexp_is_subst<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Thus, we have that the set of variables of the adaptation of an expression to a store is 
the set of symbolic variables associated by this store to the variables of this 
expression.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> adapt_aexp_vars <span class="main">:</span>
  <span class="quoted"><span class="quoted">"Aexp.vars <span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> symvar <span class="bound">v</span> <span class="free">s</span><span class="main">)</span> <span class="main">`</span> Aexp.vars <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff image_def mem_Collect_eq Bex_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">=</span> symvar <span class="main">(</span>fst <span class="skolem">sv</span><span class="main">)</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> 1 symvars_of_adapt_aexp 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  symvar_def symvars_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> symvar_var_imp_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">sv</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> var_imp_symvar_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The fact that the adaptation of an arithmetic expression to a store preserves finiteness 
of the set of variables trivially follows the previous lemma.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> finite_vars_imp_finite_adapt_a <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Aexp.vars <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Aexp.vars <span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> adapt_aexp_vars <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Adaptation of a boolean expression to a store›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We proceed analogously for the adaptation of boolean expressions to a store.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adapt_bexp</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp <span class="main">⇒</span> <span class="tfree">'v</span> store <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> symvar<span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">adapt_bexp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">(</span>symvar <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> adapt_bexp_is_subst <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">σ</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>adapt_bexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span> <span class="free">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">=</span> <span class="free">e</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> consistent_eq2 adapt_bexp_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> var_imp_symvar_var2 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Bexp.vars <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"symvar <span class="free">v</span> <span class="free">s</span> <span class="main">∈</span> Bexp.vars <span class="main">(</span>adapt_bexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sv</span> <span class="main">∈</span> Bexp.vars <span class="var">?e'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="keyword2"><span class="keyword">where</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">e</span> <span class="skolem">σ</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Bexp.vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">sv</span><span class="main">.</span> <span class="skolem">σ</span> <span class="main">(</span>fst <span class="bound">sv</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="var">?sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="bound">va</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> symvar_def<span class="main">)</span>  

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Bexp.vars_def mem_Collect_eq
  <span class="keyword1"><span class="command">using</span></span> consistentI1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> 
        consistentI2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">sv</span><span class="main">.</span> <span class="skolem">σ</span> <span class="main">(</span>fst <span class="bound">sv</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="var">?sv</span><span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">sv</span><span class="main">.</span> <span class="skolem">σ</span> <span class="main">(</span>fst <span class="bound">sv</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">val</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> adapt_bexp_is_subst<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> symvars_of_adapt_bexp <span class="main">:</span>
  <span class="quoted"><span class="quoted">"Bexp.vars <span class="main">(</span>adapt_bexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> symvars <span class="free">s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Bexp.vars <span class="var">?e'</span> <span class="main">⊆</span> <span class="var">?SV</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sv</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">∈</span> Bexp.vars <span class="var">?e'</span>"</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span> <span class="skolem"><span class="skolem">val</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e'</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?e'</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Bexp.vars_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="bound">x</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="bound">x</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> adapt_bexp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free">s</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="skolem">v</span> <span class="free">s</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="skolem">v</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">=</span> symvar <span class="skolem">v</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">=</span> symvar <span class="skolem">v</span> <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">∈</span> symvars <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> symvars_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> symvar_var_imp_var2 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sv</span> <span class="main">∈</span> Bexp.vars <span class="main">(</span>adapt_bexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">sv</span> <span class="main">∈</span> Bexp.vars <span class="var">?e'</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="free">sv</span> <span class="main">∈</span> Bexp.vars <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sv</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">s</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms symvars_of_adapt_bexp 
  <span class="keyword1"><span class="command">unfolding</span></span> symvars_def symvar_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e'</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?e'</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="bound">v</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sv</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">s</span> <span class="skolem">v</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> symvar_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sv</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="free">s</span> <span class="skolem">v</span><span class="main">)</span>›</span></span> 
        consistentI2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> 
        consistentI2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">sv</span> <span class="main">:=</span> <span class="skolem">val</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> adapt_bexp_is_subst<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> adapt_bexp_vars <span class="main">:</span>
  <span class="quoted"><span class="quoted">"Bexp.vars <span class="main">(</span>adapt_bexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> symvar <span class="bound">v</span> <span class="free">s</span><span class="main">)</span> <span class="main">`</span> Bexp.vars <span class="free">e</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Bexp.vars <span class="var">?e'</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff image_def mem_Collect_eq Bex_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">sv</span> <span class="main">∈</span> vars <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> symvar_var_imp_var2<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">=</span> symvar <span class="main">(</span>fst <span class="skolem">sv</span><span class="main">)</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> 1 symvars_of_adapt_bexp 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  symvar_def symvars_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">sv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> vars <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">=</span> symvar <span class="skolem">v</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> var_imp_symvar_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> 


<span class="keyword1"><span class="command">lemma</span></span> finite_vars_imp_finite_adapt_b <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Bexp.vars <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Bexp.vars <span class="main">(</span>adapt_bexp <span class="free">e</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> adapt_bexp_vars <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Conf">
<div class="head">
<h1>Theory Conf</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Conf
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Store.html">Store</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Configurations, Subsumption and Symbolic Execution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we first introduce most elements related to our modeling of program 
behaviors. We first define the type of configurations, on which symbolic execution performs, and 
define the various concepts we will rely upon in the following and state and prove properties about 
them. Then, we introduce symbolic execution. After giving a number of basic properties about 
symbolic execution, we prove that symbolic execution is monotonic with respect to the subsumption 
relation, which is a crucial point in order to prove the main theorems of \verb?RB.thy?. Moreover, 
Isabelle/HOL requires the actual formalization of a number of facts one would not worry when 
implementing or writing a sketch proof. Here, we will need to prove that there exist successors of 
the configurations on which symbolic execution is performed. Although this seems quite obvious in 
practice, proofs of such facts will be needed a number of times in the following theories. Finally, 
we define the feasibility of a sequence of labels.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Definitions and Properties›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Configurations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Configurations are pairs <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">store</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">pred</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where:
\begin{itemize}
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">store</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a store mapping program variable to symbolic variables,
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pred</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a set of boolean expressions over program variables whose conjunction is
the actual path predicate.
\end{itemize}›</span></span>


<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">=</span> 
  store <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> store"</span></span>
  pred  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> symvar<span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp set"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Symbolic variables of a configuration.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of symbolic variables of a configuration is the union of the set of symbolic 
variables of its store component with the set of variables of its path predicate.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">symvars</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="tfree">'v</span> symvar set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">symvars</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Store.symvars <span class="main">(</span>store <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∪</span> Bexp.vars <span class="main">(</span>conjunct <span class="main">(</span>pred <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Freshness.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A symbolic variable is said to be fresh for a configuration if it is not an element of its 
set of symbolic variables.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fresh_symvar</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> symvar <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fresh_symvar</span> <span class="free"><span class="bound"><span class="entity">sv</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sv</span></span></span> <span class="main">∉</span> symvars <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Satisfiability›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A configuration is said to be satisfiable if its path predicate is satisfiable.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sat</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> Bexp.sat <span class="main">(</span>conjunct <span class="main">(</span>pred <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹States of a configuration›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Configurations represent sets of program states. The set of program states represented by a 
configuration, or simply its set of program states, is defined as the set of program states such that 
consistent symbolic states wrt.\ the store component of the configuration satisfies its path 
predicate.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">states</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> state set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span><span class="main">.</span> consistent <span class="bound">σ</span> <span class="bound">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>store <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">∧</span> conjunct <span class="main">(</span>pred <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="bound">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A configuration is satisfiable if and only if its set of states is not empty.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sat_eq <span class="main">:</span>  
  <span class="quoted"><span class="quoted">"sat <span class="free">c</span> <span class="main">=</span> <span class="main">(</span>states <span class="free">c</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> consistentI2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sat_def states_def<span class="main">)</span> <span class="operator">fast</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Subsumption›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A configuration <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is subsumed by a configuration <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the set of 
states of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a subset of the set of states of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subsums</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊑</span>"</span> 55<span class="main">)</span> 
<span class="keyword2"><span class="keyword">where</span></span>     
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≡</span> <span class="main">(</span>states <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⊆</span> states <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The subsumption relation is reflexive and transitive.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> subsums_refl <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊑</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span> <span class="main"><span class="main">:</span></span> subsums_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> subsums_trans <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">⊑</span> <span class="free">c2</span> <span class="main">⟹</span> <span class="free">c2</span> <span class="main">⊑</span> <span class="free">c3</span> <span class="main">⟹</span> <span class="free">c1</span> <span class="main">⊑</span> <span class="free">c3</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subsums_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹However, it is not anti-symmetric. This is due to the fact that different configurations 
can have the same sets of program states. However, the following lemma trivially follows the 
definition of subsumption.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">⊑</span> <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">⊑</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"states <span class="free">c1</span> <span class="main">=</span> states <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A satisfiable configuration can only be subsumed by satisfiable configurations.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sat_sub_by_sat <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊑</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sat <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sat_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> sat_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">]</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_def<span class="main">)</span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹On the other hand, an unsatisfiable configuration can only subsume unsatisfiable 
configurations.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> unsat_subs_unsat <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">⊑</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sat_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c1</span></span><span class="main">]</span> sat_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c2</span></span><span class="main">]</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics of a configuration›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The semantics of a configuration <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a boolean expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> over 
program states associating \emph{true} to a program state if it is a state of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In 
practice, given two configurations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it is not possible to enumerate 
their sets of states to establish the inclusion in order to detect a subsumption. We detect the 
subsumption of the former by the latter by asking a constraint solver if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">sem</span></span> <span class="free"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> entails 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">sem</span></span> <span class="free"><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The following theorem shows that the way we detect subsumption in practice is 
correct.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sem</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">sem</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> states <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">theorem</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊑</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟷</span> sem <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> sem <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subsums_def sem_def subset_iff entails_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Abstractions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Abstracting a configuration consists in removing a given expression from its <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pred"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
component, i.e.\ weakening its path predicate. This definition of abstraction motivates the fact 
that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pred"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> component of configurations has been defined as a set of boolean expressions 
instead of a boolean expression.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">abstract</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abstract</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>a</sub></span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>a</sub></span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Entailment›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A configuration \emph{entails} a boolean expression if its semantics entails this expression. 
This is equivalent to say that this expression holds for any state of this configuration.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">entails</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span>"</span> 55<span class="main">)</span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> sem <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="quoted"><span class="quoted">"sem <span class="free">c</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>B</sub></span> <span class="free">e</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">σ</span> <span class="main">∈</span> states <span class="free">c</span><span class="main">.</span> <span class="free">e</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> states_def sem_def entails_def<span class="main">)</span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SymExec">
<div class="head">
<h1>Theory SymExec</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> SymExec
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Conf.html">Conf</a> <a href="Labels.html">Labels</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Symbolic Execution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We model symbolic execution by an inductive predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">se</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which takes two 
configurations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a label <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and evaluates to \emph{true} if 
and only if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a \emph{possible result} of the symbolic execution of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We say that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a possible result because, when <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is of the 
form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Assign <span class="free"><span class="free">v</span></span> <span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we associate a fresh symbolic variable to the program variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
but we do no specify how this fresh variable is chosen (see the two assumptions in the third case). 
We could have model <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">se</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">se_star</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) by a function producing the new 
configuration, instead of using inductive predicates. However this would require to provide the two 
said assumptions in each lemma involving <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">se</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which is not necessary using a predicate. Modeling 
symbolic execution in this way has the advantage that it simplifies the following proofs while not 
requiring additional lemmas.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions of $\mathit{se}$ and $\mathit{se\_star}$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Symbolic execution of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Skip"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> does not change the configuration from which it is 
performed.›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When the label 
is of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Assume <span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the adaptation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the store is added to the 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pred"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> component.›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the case of an assignment, the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"store"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> component is updated 
such that it now maps a fresh symbolic variable to the assigned program variable. A constraint 
relating this program variable with its new symbolic value is added to the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pred"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
component.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The second assumption in the third case requires that there exists at least one fresh 
symbolic variable for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In the following, a number of theorems are needed
to show that such variables exist for the configurations on which symbolic execution is performed.  
›</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">se</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">se</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> Skip <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">se</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Assume <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⦇</span> store <span class="main">=</span> store <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> pred <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∪</span> <span class="main">{</span>adapt_bexp <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>store <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">⦈</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"fst <span class="free"><span class="bound"><span class="entity">sv</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>        <span class="main">⟹</span>
   fresh_symvar <span class="free"><span class="bound"><span class="entity">sv</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span>
   <span class="free">se</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Assign <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⦇</span> store <span class="main">=</span> <span class="main">(</span>store <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">:=</span> snd <span class="free"><span class="bound"><span class="entity">sv</span></span></span><span class="main">)</span><span class="main">,</span> 
                       pred  <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">sv</span></span></span> <span class="main">=</span> <span class="main">(</span>adapt_aexp <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>store <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span><span class="main">}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the same spirit, we extend symbolic execution to sequence of labels.›</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">se_star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">se_star</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"se <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">⟹</span> <span class="free">se_star</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="free"><span class="bound"><span class="entity">c3</span></span></span> <span class="main">⟹</span> <span class="free">se_star</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c3</span></span></span>"</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic properties of $\mathit{se}$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If symbolic execution yields a satisfiable configuration, then it has been performed from 
a satisfiable configuration.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> se_sat_imp_sat <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="free">l</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sat <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sat_def conjunct_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If symbolic execution is performed from an unsatisfiable configuration, then it will yield 
an unsatisfiable configuration.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> unsat_imp_se_unsat <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="free">l</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sat_def conjunct_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given two configurations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a label <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"se <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">l</span></span> <span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the three following lemmas express <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as a function of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"se <span class="free">c</span> Skip <span class="free">c'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se.simps<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> se_Assume_eq <span class="main">:</span>
  <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="main">(</span>Assume <span class="free">e</span><span class="main">)</span> <span class="free">c'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="main">⦇</span> store <span class="main">=</span> store <span class="free">c</span><span class="main">,</span> pred <span class="main">=</span> pred <span class="free">c</span> <span class="main">∪</span> <span class="main">{</span>adapt_bexp <span class="free">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">}</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se.simps<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> se_Assign_eq <span class="main">:</span>
  <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="main">(</span>Assign <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="free">c'</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">∃</span> <span class="bound">sv</span><span class="main">.</span> fresh_symvar <span class="bound">sv</span> <span class="free">c</span> 
       <span class="main">∧</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="free">v</span> 
       <span class="main">∧</span> <span class="free">c'</span> <span class="main">=</span> <span class="main">⦇</span> store <span class="main">=</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> snd <span class="bound">sv</span><span class="main">)</span><span class="main">,</span> 
                pred  <span class="main">=</span> insert <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="bound">sv</span> <span class="main">=</span> adapt_aexp <span class="free">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span> <span class="main"><span class="main">:</span></span> se.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given two configurations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a label <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"se <span class="free"><span class="free">c</span></span> <span class="free"><span class="free">l</span></span> <span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the two following lemmas express the path predicate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as 
a function of the path predicate of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> models a guard or an 
assignment.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> path_pred_of_se_Assume <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="main">(</span>Assume <span class="free">e</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"conjunct <span class="main">(</span>pred <span class="free">c'</span><span class="main">)</span> <span class="main">=</span> 
            <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> conjunct <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">∧</span> adapt_bexp <span class="free">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms se_Assume_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">]</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> conjunct_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> path_pred_of_se_Assign <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="main">(</span>Assign <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sv</span><span class="main">.</span> conjunct <span class="main">(</span>pred <span class="free">c'</span><span class="main">)</span> <span class="main">=</span> 
            <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> conjunct <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">∧</span> <span class="bound">σ</span> <span class="bound">sv</span> <span class="main">=</span> adapt_aexp <span class="free">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms se_Assign_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> conjunct_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be two configurations  such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is obtained 
from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by symbolic execution of a label of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Assume <span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The states of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are the states of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that satisfy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This theorem will help prove 
that symbolic execution is monotonic wrt.\ subsumption.›</span></span>


<span class="keyword1"><span class="command">theorem</span></span> states_of_se_assume <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="main">(</span>Assume <span class="free">e</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">σ</span></span> <span class="main">∈</span> states <span class="free">c</span><span class="main">.</span> <span class="free">e</span> <span class="bound">σ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms se_Assume_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">]</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> adapt_bexp_is_subst states_def conjunct_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be two configurations  such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is obtained 
from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by symbolic execution of a label of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Assign <span class="free"><span class="free">v</span></span> <span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We want to 
express the set of states of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as a function of the set of states of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Since 
the proof requires a number of details, we split into two sub lemmas.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we show that if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a state of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then it has been obtain from 
an adequate update of a state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> states_of_se_assign1 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="main">(</span>Assign <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> states <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ</span> <span class="main">∈</span> states <span class="free">c</span><span class="main">.</span> <span class="free">σ'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">σ</span> <span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 1 <span class="main">:</span> <span class="quoted"><span class="quoted">"consistent <span class="free">σ'</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>store <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   2 <span class="main">:</span> <span class="quoted"><span class="quoted">"conjunct <span class="main">(</span>pred <span class="free">c'</span><span class="main">)</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> states_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> 3 <span class="main">:</span> <span class="quoted"><span class="quoted">"consistent <span class="skolem">σ</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> consistentI2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conjunct <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_Assign_eq conjunct_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> states <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> states_def<span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="free">e</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="free">v</span> <span class="main">=</span> <span class="free">e</span> <span class="skolem">σ</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="free">v</span> <span class="main">(</span>store <span class="free">c'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> consistent_def<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="free">v</span> <span class="main">(</span>store <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 se_Assign_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> symvar_def conjunct_def<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">=</span> <span class="free">e</span> <span class="skolem">σ</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> adapt_aexp_is_subst<span class="main">)</span>
    
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">⟶</span> <span class="free">σ'</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="skolem">x</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">unfolding</span></span> consistent_def symvar_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_Assign_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>symvar <span class="skolem">x</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> consistent_def<span class="main">)</span>
      
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> states_def<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Then, we show that if there exists a state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from which 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is obtained by an adequate update, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a state of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> states_of_se_assign2 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="main">(</span>Assign <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ</span> <span class="main">∈</span> states <span class="free">c</span><span class="main">.</span> <span class="free">σ'</span> <span class="main">=</span> <span class="bound">σ</span> <span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> states <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> states <span class="free">c</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="free">e</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> 1 <span class="main">:</span> <span class="quoted"><span class="quoted">"consistent <span class="skolem">σ</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   2 <span class="main">:</span> <span class="quoted"><span class="quoted">"conjunct <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> states_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sv</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> 3 <span class="main">:</span> <span class="quoted"><span class="quoted">"fresh_symvar <span class="skolem">sv</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   4 <span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">sv</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   5 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="main">⦇</span> store <span class="main">=</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> snd <span class="skolem">sv</span><span class="main">)</span><span class="main">,</span> 
                    pred    <span class="main">=</span> insert <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="skolem">sv</span> <span class="main">=</span> adapt_aexp <span class="free">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> se_Assign_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'</span> <span class="main">=</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">sv</span> <span class="main">:=</span> <span class="free">e</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">σ'</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'</span> <span class="main">(</span>store <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">σ'</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="free">e</span> <span class="skolem">σ</span><span class="main">)</span>›</span></span> 1 4 5 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> symvar_def consistent_def σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conjunct <span class="main">(</span>pred <span class="free">c'</span><span class="main">)</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conjunct <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fresh_symvar_def symvars_def Bexp.vars_def σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'</span> <span class="skolem">sv</span> <span class="main">=</span> <span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Aexp.fresh <span class="skolem">sv</span> <span class="main">(</span>adapt_aexp <span class="free">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 3 symvars_of_adapt_aexp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="quoted">"store <span class="free">c</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fresh_symvar_def symvars_def<span class="main">)</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> adapt_aexp_is_subst<span class="main">[</span><span class="operator">OF</span> 1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">e</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Aexp.vars_def σ<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>y</sub><span class="hidden">⇩</span><sub>m</sub>'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conjunct_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> states_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following theorem expressing the set of states of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c'</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as a function of the set 
of states of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> trivially follows the two preceding lemmas.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> states_of_se_assign <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="main">(</span>Assign <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ</span> <span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="free">e</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">|</span> <span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="main">∈</span> states <span class="free">c</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms states_of_se_assign1 states_of_se_assign2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity of $\mathit{se}$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We are now ready to prove that symbolic execution is monotonic with respect to subsumption. 
›</span></span>


<span class="keyword1"><span class="command">theorem</span></span> se_mono_for_sub <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c1</span> <span class="free">l</span> <span class="free">c1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c2</span> <span class="free">l</span> <span class="free">c2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">⊑</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">c2'</span> <span class="main">⊑</span> <span class="free">c1'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> <span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> states_of_se_assume subsums_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> states_of_se_assign subsums_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A stronger version of the previous theorem: symbolic execution is monotonic with respect to 
states equality.›</span></span>


<span class="keyword1"><span class="command">theorem</span></span> se_mono_for_states_eq <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c1</span> <span class="main">=</span> states <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c1</span> <span class="free">l</span> <span class="free">c1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c2</span> <span class="free">l</span> <span class="free">c2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"states <span class="free">c2'</span> <span class="main">=</span> states <span class="free">c1'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
      se_mono_for_sub<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
      se_mono_for_sub<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The previous theorem confirms the fact that the way the fresh symbolic variable is chosen 
in the case of symbolic execution of an assignment does not matter as long as the new symbolic 
variable is indeed fresh, which is more precisely expressed by the following lemma.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> se_succs_states <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="free">l</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="free">l</span> <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"states <span class="free">c1</span> <span class="main">=</span> states <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms se_mono_for_states_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic properties of $\mathit{se\_star}$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some simplification lemmas for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"se_star"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"se_star <span class="free">c</span> <span class="main">[]</span> <span class="free">c'</span> <span class="main">=</span> <span class="main">(</span><span class="free">c'</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> se_star.simps<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> se_star_Cons <span class="main">:</span>
  <span class="quoted"><span class="quoted">"se_star <span class="free">c1</span> <span class="main">(</span><span class="free">l</span> <span class="main">#</span> <span class="free">ls</span><span class="main">)</span> <span class="free">c2</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> se <span class="free">c1</span> <span class="free">l</span> <span class="bound">c</span> <span class="main">∧</span> se_star <span class="bound">c</span> <span class="free">ls</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> se_star.simps<span class="main">)</span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">lemma</span></span> se_star_one <span class="main">:</span>
  <span class="quoted"><span class="quoted">"se_star <span class="free">c1</span> <span class="main">[</span><span class="free">l</span><span class="main">]</span> <span class="free">c2</span> <span class="main">=</span> se <span class="free">c1</span> <span class="free">l</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> se_star_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>


<span class="keyword1"><span class="command">lemma</span></span> se_star_append <span class="main">:</span>
  <span class="quoted"><span class="quoted">"se_star <span class="free">c1</span> <span class="main">(</span><span class="free">ls1</span> <span class="main">@</span> <span class="free">ls2</span><span class="main">)</span> <span class="free">c2</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> se_star <span class="free">c1</span> <span class="free">ls1</span> <span class="bound">c</span> <span class="main">∧</span> se_star <span class="bound">c</span> <span class="free">ls2</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls1</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_Cons<span class="main">)</span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">lemma</span></span> se_star_append_one <span class="main">:</span>
  <span class="quoted"><span class="quoted">"se_star <span class="free">c1</span> <span class="main">(</span><span class="free">ls</span> <span class="main">@</span> <span class="main">[</span><span class="free">l</span><span class="main">]</span><span class="main">)</span> <span class="free">c2</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> se_star <span class="free">c1</span> <span class="free">ls</span> <span class="bound">c</span> <span class="main">∧</span> se <span class="bound">c</span> <span class="free">l</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> se_star_append se_star_one <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Symbolic execution of a sequence of labels from an unsatisfiable configuration yields 
an unsatisfiable configuration.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> unsat_imp_se_star_unsat <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="free">c</span> <span class="free">ls</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_Cons unsat_imp_se_unsat<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If symbolic execution yields a satisfiable configuration, then it has been performed from 
a satisfiable configuration.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> se_star_sat_imp_sat <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="free">c</span> <span class="free">ls</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sat <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_Cons se_sat_imp_sat<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity of $\mathit{se\_star}$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"se"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> extends to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"se_star"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">theorem</span></span> se_star_mono_for_sub <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="free">c1</span> <span class="free">ls</span> <span class="free">c1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="free">c2</span> <span class="free">ls</span> <span class="free">c2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span>  <span class="main">⊑</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">c2'</span> <span class="main">⊑</span> <span class="free">c1'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="free">c2</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span>  se_star_Cons se_mono_for_sub<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> se_star_mono_for_states_eq <span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c1</span> <span class="main">=</span> states <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="free">c1</span> <span class="free">ls</span> <span class="free">c1'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="free">c2</span> <span class="free">ls</span> <span class="free">c2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"states <span class="free">c2'</span> <span class="main">=</span> states <span class="free">c1'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
      se_star_mono_for_sub<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
      se_star_mono_for_sub<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> se_star_succs_states <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="free">c</span> <span class="free">ls</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="free">c</span> <span class="free">ls</span> <span class="free">c2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"states <span class="free">c1</span> <span class="main">=</span> states <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms se_star_mono_for_states_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Existence of successors›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here, we are interested in proving that, under certain assumptions, there will always exist 
fresh symbolic variables for configurations on which symbolic execution is performed. Thus symbolic 
execution cannot ``block'' when an assignment is met. For symbolic execution not to block in this 
case, the configuration from which it is performed must be such that there exist fresh symbolic 
variables for each program variable. Such configurations are said to be \emph{updatable}.›</span></span> 


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">updatable</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">updatable</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">sv</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">∧</span> fresh_symvar <span class="bound">sv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma shows that being updatable is a sufficient condition for a configuration 
in order for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"se"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> not to block.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> updatable_imp_ex_se_suc <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"updatable <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> se <span class="free">c</span> <span class="free">l</span> <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span>  se_Assume_eq se_Assign_eq updatable_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A sufficient condition for a configuration to be updatable is that its path predicate has 
a finite number of variables. The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"store"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> component has no influence here, since its set of 
symbolic variables is always a strict subset of the set of symbolic variables (i.e.\ there always 
exist fresh symbolic variables for a store). To establish this proof, we need the following 
intermediate lemma.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We want to prove that if the set of symbolic variables of the path predicate of a 
configuration is finite, then we can find a fresh symbolic variable for it. However, we express this 
with a more general lemma. We show that given a finite set of symbolic variables <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">SV</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a
program variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that there exist symbolic variables in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">SV</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that are 
indexed versions of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then there exists a symbolic variable for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whose index 
is greater or equal than the index of any other symbolic variable for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">SV</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> finite_symvars_imp_ex_greatest_symvar <span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">SV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> symvar set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">SV</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sv</span> <span class="main">∈</span> <span class="free">SV</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sv</span>  <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">sv</span></span> <span class="main">∈</span> <span class="free">SV</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span><span class="main">.</span> 
           <span class="main">∀</span> <span class="bound">sv'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">sv</span></span> <span class="main">∈</span> <span class="free">SV</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span><span class="main">.</span> snd <span class="bound">sv'</span> <span class="main">≤</span> snd <span class="bound">sv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">sv</span></span> <span class="main">∈</span> <span class="free">SV</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">sv</span></span> <span class="main">∈</span> <span class="free">SV</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">E</span><span class="main">::</span>nat set<span class="main">)</span><span class="main">.</span> finite <span class="bound">E</span> <span class="main">∧</span> <span class="bound">E</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">n</span> <span class="main">∈</span> <span class="bound">E</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> <span class="bound">E</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct_tac</span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span> finite_ne_induct<span class="main">)</span> 
     <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">sv</span></span> <span class="main">∈</span> <span class="free">SV</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">m</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">sv</span></span> <span class="main">∈</span> <span class="free">SV</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sv</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sv</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">sv</span></span> <span class="main">∈</span> <span class="free">SV</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">sv</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Thus, a configuration whose path predicate has a finite set of variables is updatable. For
example, for any program variable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the symbolic variable  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(v,i+1)›</span></span></span></span> is fresh for 
this configuration, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the greater index associated to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> among the 
symbolic variables of this configuration. In practice, this is how we choose the fresh symbolic 
variable.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> finite_pred_imp_se_updatable <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Bexp.vars <span class="main">(</span>conjunct <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?V</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"updatable <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> updatable_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sv</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> fresh_symvar <span class="bound">sv</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sv</span> <span class="main">∈</span> <span class="var">?V</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">max_sv</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span>       <span class="quoted"><span class="quoted">"<span class="skolem">max_sv</span> <span class="main">∈</span> <span class="var">?V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>         <span class="quoted"><span class="quoted">"fst <span class="skolem">max_sv</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   max <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sv'</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">sv</span></span> <span class="main">∈</span> <span class="var">?V</span><span class="main">.</span> fst <span class="bound">sv</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span><span class="main">.</span> snd <span class="bound">sv'</span> <span class="main">≤</span> snd <span class="skolem">max_sv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms finite_symvars_imp_ex_greatest_symvar<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> max 
    <span class="keyword1"><span class="command">unfolding</span></span> fresh_symvar_def symvars_def Store.symvars_def symvar_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">max_sv</span> <span class="main">≤</span> store <span class="free">c</span> <span class="skolem">v</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span>Suc <span class="main">(</span>store <span class="free">c</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span>Suc <span class="main">(</span>snd <span class="skolem">max_sv</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> Suc <span class="main">(</span>store <span class="free">c</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fresh_symvar_def symvars_def Store.symvars_def symvar_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The path predicate of a configuration whose <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pred"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> component is finite and whose 
elements all have finite sets of variables has a finite set of variables. Thus, this configuration 
is updatable, and it has a successor by symbolic execution of any label. The following lemma 
starts from these two assumptions and use the previous ones in order to directly get to the 
conclusion (this will ease some of the following proofs).›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> finite_imp_ex_se_succ <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="free">c</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> se <span class="free">c</span> <span class="free">l</span> <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite_pred_imp_se_updatable<span class="main">[</span><span class="operator">OF</span> finite_conj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> updatable_imp_ex_se_suc<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For symbolic execution not to block \emph{along a sequence of labels}, it is not sufficient 
for the first configuration to be updatable. It must also be such that (all) its successors are 
updatable. A sufficient condition for this is that the set of variables of its path predicate is 
finite and that the sub-expression of the label that is executed also has a finite set of variables. 
Under these assumptions, symbolic execution preserves finiteness of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pred"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> component and 
of the sets of variables of its elements. Thus, successors <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"se"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are also updatable because 
they also have a path predicate with a finite set of variables. In the following, to prove 
this we need two intermediate lemmas: 
\begin{itemize}
  \item one stating that symbolic execution perserves the finiteness of the set of variables of the 
elements of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pred"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> component, provided that the sub expression of the label that is 
executed has a finite set of variables, 
  \item one stating that symbolic execution preserves the finiteness of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pred"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
component.
\end{itemize}›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> se_preserves_finiteness1 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_label <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="free">l</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="free">c</span><span class="main">.</span>  finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="free">c'</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Skip <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> <span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Assume <span class="skolem">e</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms finite_vars_imp_finite_adapt_b
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_Assume_eq finite_label_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Assign <span class="skolem">v</span> <span class="skolem">e</span><span class="main">)</span> 

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sv</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fresh_symvar <span class="skolem">sv</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"fst <span class="skolem">sv</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="main">⦇</span> store <span class="main">=</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">(</span><span class="skolem">v</span> <span class="main">:=</span> snd <span class="skolem">sv</span><span class="main">)</span><span class="main">,</span>
                pred  <span class="main">=</span> insert <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="skolem">sv</span> <span class="main">=</span> adapt_aexp <span class="skolem">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> se_Assign_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Bexp.vars <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="skolem">sv</span> <span class="main">=</span> adapt_aexp <span class="skolem">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Aexp.vars <span class="main">(</span><span class="main">λ</span><span class="bound">σ</span><span class="main">.</span> <span class="bound">σ</span> <span class="skolem">sv</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Aexp.vars_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Aexp.vars <span class="main">(</span>adapt_aexp <span class="skolem">e</span> <span class="main">(</span>store <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Assign finite_vars_imp_finite_adapt_a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_label_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_vars_of_a_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> se_preserves_finiteness2 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="free">l</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="free">c'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span>  se_Assume_eq se_Assign_eq<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We are now ready to prove that a sufficient condition for symbolic execution not to block 
along a sequence of labels is that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"pred"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> component of the ``initial 
configuration'' is finite, as well as the set of variables of its elements,  and that the 
sub-expression of the label that is executed also has a finite set of variables.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> finite_imp_ex_se_star_succ <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="free">c</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_labels <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> se_star <span class="free">c</span> <span class="free">ls</span> <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_star.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">l</span> <span class="skolem">ls</span> <span class="skolem">c</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se <span class="skolem">c</span> <span class="skolem">l</span> <span class="skolem">c1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_imp_ex_se_succ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="skolem">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="skolem">c1</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> 2 se_preserves_finiteness1 se_preserves_finiteness2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_labels <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se_star <span class="skolem">c1</span> <span class="skolem">ls</span> <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c</span> <span class="skolem">l</span> <span class="skolem">c1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> se_star_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Feasibility of a sequence of labels›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A sequence of labels <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ls</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is said to be feasible from a configuration <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
if there exists a satisfiable configuration <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> obtained by symbolic execution of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ls</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">feasible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">feasible</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> se_star <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="bound">c'</span> <span class="main">∧</span> sat <span class="bound">c'</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A simplification lemma for the case where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ls</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not empty.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> feasible_Cons <span class="main">:</span>
  <span class="quoted"><span class="quoted">"feasible <span class="free">c</span> <span class="main">(</span><span class="free">l</span><span class="main">#</span><span class="free">ls</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> se <span class="free">c</span> <span class="free">l</span> <span class="bound">c'</span> <span class="main">∧</span> sat <span class="bound">c'</span> <span class="main">∧</span> feasible <span class="bound">c'</span> <span class="free">ls</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> se_star_sat_imp_sat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> feasible_def se_star_Cons<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> feasible_def se_star_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following theorem is very important for the rest of this formalization. It states that, 
given two 
configurations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> subsums <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then 
any feasible sequence of labels from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is also feasible from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This is a crucial 
point in order to prove that our approach preserves the set of feasible paths of the original LTS. 
This proof requires a number of assumptions about the finiteness of the sequence of labels, of 
the path predicates of the two configurations and of their states of variables. 
Those assumptions are needed in order to show that there exist successors of 
both configurations by symbolic execution of the sequence of labels.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> subsums_imp_feasible <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_labels <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="free">c1</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="free">c2</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c2</span> <span class="main">⊑</span> <span class="free">c1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"feasible <span class="free">c2</span> <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"feasible <span class="free">c1</span> <span class="free">ls</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="free">c2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> feasible_def sat_sub_by_sat<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">l</span> <span class="skolem">ls</span> <span class="skolem">c1</span> <span class="skolem">c2</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se <span class="skolem">c2</span> <span class="skolem">l</span> <span class="skolem">c2'</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"sat <span class="skolem">c2'</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"feasible <span class="skolem">c2'</span> <span class="skolem">ls</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> feasible_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se <span class="skolem">c1</span> <span class="skolem">l</span> <span class="skolem">c1'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_conj<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
        finite_pred_imp_se_updatable
        updatable_imp_ex_se_suc
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"sat <span class="skolem">c1'</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span>  se_mono_for_sub<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹se <span class="skolem">c2</span> <span class="skolem">l</span> <span class="skolem">c2'</span>›</span></span> Cons<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span>
         sat_sub_by_sat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹sat <span class="skolem">c2'</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"feasible <span class="skolem">c1'</span> <span class="skolem">ls</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_label  <span class="skolem">l</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"finite_labels <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="skolem">c1'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> se_preserves_finiteness2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c1</span> <span class="skolem">l</span> <span class="skolem">c1'</span>›</span></span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="skolem">c2'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> se_preserves_finiteness2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c2</span> <span class="skolem">l</span> <span class="skolem">c2'</span>›</span></span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>pred <span class="skolem">c1'</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> se_preserves_finiteness1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite_label <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c1</span> <span class="skolem">l</span> <span class="skolem">c1'</span>›</span></span> Cons<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>pred <span class="skolem">c2'</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> se_preserves_finiteness1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite_label <span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c2</span> <span class="skolem">l</span> <span class="skolem">c2'</span>›</span></span> Cons<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2'</span> <span class="main">⊑</span> <span class="skolem">c1'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> se_mono_for_sub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c1</span> <span class="skolem">l</span> <span class="skolem">c1'</span>›</span></span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c2</span> <span class="skolem">l</span> <span class="skolem">c2'</span>›</span></span> Cons<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹feasible <span class="skolem">c2'</span> <span class="skolem">ls</span>›</span></span> <span class="quoted"><span class="quoted">‹finite_labels <span class="skolem">ls</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> feasible_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Concrete execution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We illustrate our notion of symbolic execution by relating it with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ce</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, an inductive 
predicate describing concrete execution. Unlike symbolic execution, concrete execution describes 
program behavior given program states, i.e.\ concrete valuations for program variables. The 
goal of this section is to show that our notion of symbolic execution is correct, that is: given two 
configurations such that one results from the symbolic execution of a sequence of labels from the 
other, then the resulting configuration represents the set of states that are reachable by 
concrete execution from the states of the original configuration.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ce</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ce</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> Skip <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free">ce</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Assume <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ce</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Assign <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ce_star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ce_star</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"ce <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">⟹</span> <span class="free">ce_star</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="free"><span class="bound"><span class="entity">c3</span></span></span> <span class="main">⟹</span> <span class="free">ce_star</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c3</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"ce <span class="free">σ</span> Skip <span class="free">σ'</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">=</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> ce.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"ce <span class="free">σ</span> <span class="main">(</span>Assume <span class="free">e</span><span class="main">)</span> <span class="free">σ'</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">∧</span> <span class="free">e</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> ce.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"ce <span class="free">σ</span> <span class="main">(</span>Assign <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="free">σ'</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">=</span> <span class="free">σ</span><span class="main">(</span><span class="free">v</span> <span class="main">:=</span> <span class="free">e</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> ce.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> se_as_ce <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se <span class="free">c</span> <span class="free">l</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">σ</span> <span class="main">∈</span> states <span class="free">c</span><span class="main">.</span> ce <span class="bound">σ</span> <span class="free">l</span> <span class="bound">σ'</span><span class="main">}</span> "</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> states_of_se_assume states_of_se_assign<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"ce_star <span class="free">σ</span> <span class="main">[]</span> <span class="free">σ'</span> <span class="main">=</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">=</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ce_star.simps<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ce_star_Cons <span class="main">:</span>
  <span class="quoted"><span class="quoted">"ce_star <span class="free">σ1</span> <span class="main">(</span><span class="free">l</span> <span class="main">#</span> <span class="free">ls</span><span class="main">)</span> <span class="free">σ2</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">σ</span><span class="main">.</span> ce <span class="free">σ1</span> <span class="free">l</span> <span class="bound">σ</span> <span class="main">∧</span> ce_star <span class="bound">σ</span> <span class="free">ls</span> <span class="free">σ2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ce_star.simps<span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> se_star_as_ce_star <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="free">c</span> <span class="free">ls</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">σ'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">σ</span> <span class="main">∈</span> states <span class="free">c</span><span class="main">.</span> ce_star <span class="bound">σ</span> <span class="free">ls</span> <span class="bound">σ'</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">l</span> <span class="skolem">ls</span> <span class="skolem">c</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se <span class="skolem">c</span> <span class="skolem">l</span> <span class="skolem">c''</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"se_star <span class="skolem">c''</span> <span class="skolem">ls</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> se_star_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff Bex_def mem_Collect_eq
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">σ'</span><span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ''</span> <span class="main">∈</span> states <span class="skolem">c''</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ce_star <span class="skolem">σ''</span> <span class="skolem">ls</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹se_star <span class="skolem">c''</span> <span class="skolem">ls</span> <span class="free">c'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> states <span class="skolem">c</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ce <span class="skolem">σ</span> <span class="skolem">l</span> <span class="skolem">σ''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c</span> <span class="skolem">l</span> <span class="skolem">c''</span>›</span></span>  se_as_ce <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ce_star_Cons<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">σ'</span><span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> states <span class="skolem">c</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ce_star <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">l</span><span class="main">#</span><span class="skolem">ls</span><span class="main">)</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ce <span class="skolem">σ</span> <span class="skolem">l</span> <span class="skolem">σ''</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ce_star <span class="skolem">σ''</span> <span class="skolem">ls</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ce_star_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹se_star <span class="skolem">c''</span> <span class="skolem">ls</span> <span class="free">c'</span>›</span></span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c</span> <span class="skolem">l</span> <span class="skolem">c''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_as_ce<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LTS">
<div class="head">
<h1>Theory LTS</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> LTS
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Graph.html">Graph</a> <a href="Labels.html">Labels</a> <a href="SymExec.html">SymExec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Labelled Transition Systems›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory is motivated by the need of an  abstract representation of control-flow graphs
(CFG). It is a refinement of the prior theory of (unlabelled) graphs and proceeds by decorating
their edges with \emph{labels} expressing assumptions and effects (assignments) on an underlying 
state. In this theory, we define LTSs and introduce a number of abbreviations that will ease 
stating and proving lemmas in the following theories.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Basic definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The labelled transition systems (LTS) we are heading for are constructed by
extending  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rgraph›</span></span></span></span>'s by a labelling function of the edges, using Isabelle extensible 
records.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> lts <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vert</span> rgraph"</span></span> <span class="main">+</span>
  labelling <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vert</span> edge <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We call \emph{initial location} the root of the underlying graph.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">init</span> <span class="main">::</span> 
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> <span class="tfree">'vert</span>"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="main">≡</span> root <span class="free"><span class="bound"><span class="entity">lts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of labels of a LTS is the image set of its labelling function over its set of edges. 
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">labels</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">labels</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="main">≡</span> labelling <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="main">`</span> edges <span class="free"><span class="bound"><span class="entity">lts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, we will sometimes need to use the notion of \emph{trace} of 
a given sequence of edges with respect to the transition relation of an LTS.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'vert</span> edge list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span> edge <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> label list"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> map <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We are interested in a special form of Labelled Transition Systems; the prior
record definition is too liberal. We will constrain it to \emph{well-formed labelled transition
systems}.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first define an application that, given an LTS, returns its underlying graph.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">graph</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> <span class="tfree">'vert</span> rgraph"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">graph</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="main">≡</span> rgraph.truncate <span class="free"><span class="bound"><span class="entity">lts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An LTS is well-formed if its underlying <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rgraph›</span></span></span></span> is well-formed.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wf_lts</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">wf_lts</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="main">≡</span> wf_rgraph <span class="main">(</span>graph <span class="free"><span class="bound"><span class="entity">lts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following theories, we will sometimes need to account for the fact that we consider 
LTSs with a finite number of edges.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">finite_lts</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finite_lts</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">l</span> <span class="main">∈</span> range <span class="main">(</span>labelling <span class="free"><span class="bound"><span class="entity">lts</span></span></span><span class="main">)</span><span class="main">.</span> finite_label <span class="bound">l</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Feasible sub-paths and paths›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A sequence of edges is a feasible sub-path of an LTS <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lts›</span></span></span></span> from a configuration 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span> if it is a sub-path of the underlying graph of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lts›</span></span></span></span> and if it is feasible 
from the configuration <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>c›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">feasible_subpath</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="tfree">'vert</span> <span class="main">⇒</span> <span class="tfree">'vert</span> edge list <span class="main">⇒</span> <span class="tfree">'vert</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">feasible_subpath</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">≡</span> Graph.subpath <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> 
                                    <span class="main">∧</span> feasible <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>trace <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span>labelling <span class="free"><span class="bound"><span class="entity">lts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similarly to sub-paths in rooted-graphs, we will not be always interested in the final 
vertex of a feasible sub-path. We use the following notion when we are not interested in this 
vertex.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">feasible_subpath_from</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="tfree">'vert</span> <span class="main">⇒</span> <span class="tfree">'vert</span> edge list <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">feasible_subpath_from</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">l'</span><span class="main">.</span> feasible_subpath <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="bound">l'</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">feasible_subpaths_from</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="tfree">'vert</span> <span class="main">⇒</span> <span class="tfree">'vert</span> edge list set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">feasible_subpaths_from</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> feasible_subpath_from <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">ts</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As earlier, feasible paths are defined as feasible sub-paths starting at the initial 
location of the LTS.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">feasible_path</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="tfree">'vert</span> edge list <span class="main">⇒</span> <span class="tfree">'vert</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">feasible_path</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> feasible_subpath <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">(</span>init <span class="free"><span class="bound"><span class="entity">lts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">feasible_paths</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> lts_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf <span class="main">⇒</span> <span class="tfree">'vert</span> edge list set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">feasible_paths</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">l</span><span class="main">.</span> feasible_path <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="bound">as</span> <span class="bound">l</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SubRel">
<div class="head">
<h1>Theory SubRel</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> SubRel
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Graph.html">Graph</a>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Graphs equipped with a subsumption relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we define subsumption relations and the notion of sub\hyp{}paths in 
rooted graphs equipped with such relations. Sub-paths are defined in the same way than in 
\verb?Graph.thy?: first we define the consistency of a sequence of edges in presence of a 
subsumption relation, then sub-paths. We are interested in subsumptions taking places between red 
vertices of red-black graphs (see \verb?RB.thy?), i.e.\ occurrences of locations of LTSs. Here 
subsumptions are defined as pairs of indexed vertices of a LTS, and subsumption relations as sets 
of subsumptions. The type of vertices of such LTSs is represented by the abstract type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'v›</span></span></span></span> 
in the following.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic definitions and properties›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Subsumptions and subsumption relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Subsumptions take place between occurrences of the vertices of a graph. We represent 
such occurrences by indexed versions of vertices. A subsumption is defined as pair of indexed 
vertices.›</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'v</span> sub_t <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A subsumption relation is a set of subsumptions.›</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'v</span> sub_rel_t <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> sub_t set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We consider the left member to be subsumed by the right one. The left member of a 
subsumption is called its \emph{subsumee}, the right member its \emph{subsumer}.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subsumee</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> sub_t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">subsumee</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">≡</span> fst <span class="free"><span class="bound"><span class="entity">sub</span></span></span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subsumer</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> sub_t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">subsumer</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">≡</span> snd <span class="free"><span class="bound"><span class="entity">sub</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We will need to talk about the sets of subsumees and subsumers of a subsumption relation.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subsumees</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> sub_rel_t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">subsumees</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">≡</span> subsumee <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subsumers</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> sub_rel_t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">subsumers</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">≡</span> subsumer <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The two following lemmas will prove useful in the following.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> subsumees_conv <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subsumees <span class="free">subs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>


<span class="keyword1"><span class="command">lemma</span></span> subsumers_conv <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subsumers <span class="free">subs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We call set of vertices of the relation the union of its sets of subsumees and subsumers.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vertices</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> sub_rel_t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vertices</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">≡</span> subsumers <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">∪</span> subsumees <span class="free"><span class="bound"><span class="entity">subs</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-formed subsumption relation of a graph›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Well-formed subsumption relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, we make an intensive use of \emph{locales}. We use them as a convenient 
way to add assumptions to the following lemmas, in order to ease their reading. Locales can be 
built from locales, allowing some modularity in the formalization. The following locale simply 
states that we suppose there exists  a subsumption relation called \emph{subs}. It will 
be used later in order to constrain subsumption relations.›</span></span>


<span class="keyword1"><span class="command">locale</span></span> sub_rel <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">subs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> sub_rel_t"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We are only interested in subsumptions involving two different
occurrences of the same LTS 
location. Moreover, once a vertex has been subsumed, there is no point in trying to subsume it again
by another subsumer: subsumees must have a unique subsumer. Finally, we do not allow chains of 
subsumptions, thus the intersection of the sets of subsumers and subsumees must be empty. Such 
subsumption relations are said to be \emph{well-formed}.›</span></span>


<span class="keyword1"><span class="command">locale</span></span> wf_sub_rel <span class="main">=</span> sub_rel <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub_imp_same_verts <span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">∈</span> <span class="free">subs</span> <span class="main">⟹</span> fst <span class="main">(</span>subsumee <span class="free">sub</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>subsumer <span class="free">sub</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">assumes</span></span> subsumed_by_one <span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> subsumees <span class="free">subs</span><span class="main">.</span> <span class="main">∃!</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">assumes</span></span> inter_empty <span class="main">:</span> 
    <span class="quoted"><span class="quoted">"subsumers <span class="free">subs</span> <span class="main">∩</span> subsumees <span class="free">subs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> wf_sub_rel <span class="main">=</span> sub_imp_same_verts subsumed_by_one inter_empty

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A rephrasing of the assumption <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">subsumed_by_one</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel<span class="main">)</span> subsumed_by_two_imp <span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms wf_sub_rel <span class="keyword1"><span class="command">unfolding</span></span> subsumees_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A well-formed subsumption relation is equal to its transitive closure. We will see in the 
  following one has to handle transitive closures of such relations.›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> in_trancl_imp <span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tranclD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> tranclD<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span>
        rtranclD<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span>  
        inter_empty 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">lemma</span></span> trancl_eq <span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="free">subs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_trancl_imp r_into_trancl<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty subsumption relation is well-formed.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"wf_sub_rel <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Subsumption relation of a graph›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We consider subsumption relations to equip rooted graphs. However, nothing in the previous 
definitions relates these relations to graphs: subsumptions relations involve objects that are of 
the type of indexed vertices, but that might to not be vertices of an actual graph. We equip 
graphs with subsumption relations using the notion of \emph{sub-relation of a graph}. Such a 
relation must only involve vertices of the graph it equips.›</span></span>


<span class="keyword1"><span class="command">locale</span></span> rgraph <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">locale</span></span> sub_rel_of <span class="main">=</span> rgraph <span class="main">+</span> sub_rel <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> related_are_verts <span class="main">:</span> <span class="quoted"><span class="quoted">"vertices <span class="free">subs</span> <span class="main">⊆</span> Graph.vertices <span class="free">g</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> sub_rel_of <span class="main">=</span> related_are_verts

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The transitive closure of a sub-relation of a graph <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is also a sub-relation of 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> trancl_sub_rel_of <span class="main">:</span>
     <span class="quoted"><span class="quoted">"sub_rel_of <span class="free">g</span> <span class="main">(</span><span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tranclD<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span> tranclD2<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span> sub_rel_of
  <span class="keyword1"><span class="command">unfolding</span></span> sub_rel_of_def subsumers_conv subsumees_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty relation is a sub-relation of any graph.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"sub_rel_of <span class="free">g</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sub_rel_of_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Well-formed sub-relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We pack both previous locales into a third one. We speak about 
\emph{well-formed sub-relations}.›</span></span>


<span class="keyword1"><span class="command">locale</span></span> wf_sub_rel_of <span class="main">=</span> rgraph <span class="main">+</span> sub_rel <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub_rel_of <span class="main">:</span> <span class="quoted"><span class="quoted">"sub_rel_of <span class="free">g</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_sub_rel <span class="main">:</span> <span class="quoted"><span class="quoted">"wf_sub_rel <span class="free">subs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> wf_sub_rel_of <span class="main">=</span> sub_rel_of wf_sub_rel                                                       
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty relation is a well-formed sub-relation of any graph.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"wf_sub_rel_of <span class="free">g</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sub_rel_of_def wf_sub_rel_def wf_sub_rel_of_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As previously, even if, in the end, we are only interested by well-formed sub-relations, we 
assume the relation is such only when needed.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Consistent Edge Sequences, Sub-paths›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Consistency in presence of a subsumption relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We model sub-paths in the same spirit than in \verb?Graph.thy?, by starting with 
defining the consistency of a sequence of edges wrt.\ a subsumption relation. The idea is 
that subsumption links can ``fill the gaps'' between subsequent edges that would have made 
the sequence inconsistent otherwise. For now, we define consistency of a sequence wrt.\ any 
subsumption relation. Thus, we cannot account yet for the fact that we only consider relations 
without chains of subsumptions. The empty sequence is consistent wrt.\ to a subsumption relation 
from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if these two vertices are equal or if they belong to the 
transitive closure of the relation. A non-empty sequence is consistent if it is made of consistent 
sequences whose extremities are linked in the transitive closure of the subsumption relation.›</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> edge list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'v</span> sub_rel_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ces</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>  <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ces</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> src <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span>src <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">∧</span> <span class="free">ces</span> <span class="main">(</span>tgt <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A consistent sequence from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> without a  subsumption relation is 
consistent between these two vertices in presence of any relation.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Graph.ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consistency in presence of the empty subsumption relation reduces to consistency as defined 
in \verb?Graph.thy?.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Graph.ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">v1</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">v2</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be an element of a subsumption relation, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a sequence of 
edges consistent wrt.\ this relation from vertex <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is also consistent 
from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Even if this lemma will not be used much in the following, this is the base fact 
for saying that paths feasible from a subsumee are also feasible from its subsumer.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> acas_imp_dcas <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ces <span class="free">v2</span> <span class="free">es</span> <span class="free">v</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">es</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a sequence of edges consistent wrt. a subsumption relation. Extending 
this relation preserves the consistency of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> ces_Un <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span>  <span class="free">subs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="main">(</span><span class="free">subs1</span> <span class="main">∪</span> <span class="free">subs2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> trancl_mono<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A rephrasing of the previous lemma.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> cas_subset <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span>  <span class="free">subs1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">subs1</span> <span class="main">⊆</span> <span class="free">subs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> trancl_mono<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplification lemmas for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ces"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> ces_append_one <span class="main">:</span>
  <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="main">(</span><span class="free">es</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">=</span> <span class="main">(</span>ces <span class="free">v1</span> <span class="free">es</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="free">subs</span> <span class="main">∧</span> ces <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="free">v2</span> <span class="free">subs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> ces_append <span class="main">:</span>
  <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="main">(</span><span class="free">es1</span> <span class="main">@</span> <span class="free">es2</span><span class="main">)</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> ces <span class="free">v1</span> <span class="free">es1</span> <span class="bound">v</span> <span class="free">subs</span> <span class="main">∧</span> ces <span class="bound">v</span> <span class="free">es2</span> <span class="free">v2</span> <span class="free">subs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es1</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span>  
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span> <span class="main"><span class="main">:</span></span> split_paired_Ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es1</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil <span class="skolem">v1</span><span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ces <span class="skolem">v1</span> <span class="main">[]</span> <span class="skolem">v</span> <span class="free">subs</span>"</span></span> 
                  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ces <span class="skolem">v</span> <span class="free">es2</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ces.simps
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">es2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a sequence of edges consistent from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> wrt.\ a 
sub-relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">subs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of a graph <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Suppose elements of this sequence are edges of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a vertex of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is also a vertex of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sub_rel_of<span class="main">)</span> ces_imp_ends_vertices <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">es</span> <span class="main">⊆</span> edges <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms trancl_sub_rel_of 
<span class="keyword1"><span class="command">unfolding</span></span> sub_rel_of_def subsumers_conv vertices_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span> <span class="main"><span class="main">:</span></span> split_paired_Ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-paths›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A sub-path leading from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, two vertices of a graph <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
equipped with a subsumption relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">subs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is a sequence of edges consistent wrt.\ 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">subs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whose elements are edges of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
Moreover, we must assume that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">subs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a sub-relation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, otherwise 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> could ``exit'' <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> through subsumption links.›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subpath</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> edge list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subpath</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">≡</span> sub_rel_of <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> 
                           <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">∈</span> Graph.vertices <span class="free"><span class="bound"><span class="entity">g</span></span></span>
                           <span class="main">∧</span> ces <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span>  
                           <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">⊆</span> edges <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once again, in some cases, we will not be interested in the ending vertex of a sub-path.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subpath_from</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> edge list <span class="main">⇒</span> <span class="tfree">'v</span> sub_rel_t <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subpath_from</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> subpath <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="bound">v'</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplification lemmas for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">subpath</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> Nil_sp <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">[]</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> sub_rel_of <span class="free">g</span> <span class="free">subs</span> 
                             <span class="main">∧</span> <span class="free">v1</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span> 
                             <span class="main">∧</span> <span class="main">(</span><span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹When the subsumption relation is well-formed (denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(in wf_sub_rel)›</span></span></span></span>), 
there is no need to account for the transitive closure of the relation.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel<span class="main">)</span> Nil_sp <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">[]</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> sub_rel_of <span class="free">g</span> <span class="free">subs</span> 
                             <span class="main">∧</span> <span class="free">v1</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span> 
                             <span class="main">∧</span> <span class="main">(</span><span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> trancl_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Nil_sp<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplification lemma for the one-element sequence.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_one <span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> sub_rel_of <span class="free">g</span> <span class="free">subs</span> 
                                      <span class="main">∧</span> <span class="main">(</span><span class="free">v1</span> <span class="main">=</span> src <span class="free">e</span> <span class="main">∨</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span>src <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> 
                                      <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> edges <span class="free">g</span> 
                                      <span class="main">∧</span> <span class="main">(</span>tgt <span class="free">e</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sub_rel_of.trancl_sub_rel_of<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def sub_rel_of_def subpath_def<span class="main">)</span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once again, when the subsumption relation is well-formed, the previous lemma can be 
simplified since, in this case, the transitive closure of the relation is the relation itself.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel_of<span class="main">)</span> sp_one <span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> sub_rel_of <span class="free">g</span> <span class="free">subs</span> 
                                    <span class="main">∧</span> <span class="main">(</span><span class="free">v1</span> <span class="main">=</span> src <span class="free">e</span> <span class="main">∨</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span>src <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main">)</span> 
                                    <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> edges <span class="free">g</span> 
                                    <span class="main">∧</span> <span class="main">(</span>tgt <span class="free">e</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sp_one wf_sub_rel.trancl_eq<span class="main">[</span><span class="operator">OF</span> wf_sub_rel<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplification lemma for the non-empty sequence (which might contain more than one element).›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_Cons <span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">(</span><span class="free">e</span> <span class="main">#</span> <span class="free">es</span><span class="main">)</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> sub_rel_of <span class="free">g</span> <span class="free">subs</span> 
                                           <span class="main">∧</span> <span class="main">(</span><span class="free">v1</span> <span class="main">=</span> src <span class="free">e</span>  <span class="main">∨</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span>src <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> 
                                           <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> edges <span class="free">g</span> 
                                           <span class="main">∧</span> subpath <span class="free">g</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sub_rel_of.trancl_sub_rel_of<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def vertices_def sub_rel_of_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The same lemma when the subsumption relation is well-formed.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel_of<span class="main">)</span> sp_Cons <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">(</span><span class="free">e</span> <span class="main">#</span> <span class="free">es</span><span class="main">)</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> sub_rel_of <span class="free">g</span> <span class="free">subs</span> 
                                   <span class="main">∧</span> <span class="main">(</span><span class="free">v1</span> <span class="main">=</span> src <span class="free">e</span> <span class="main">∨</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span>src <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main">)</span> 
                                   <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> edges <span class="free">g</span> 
                                   <span class="main">∧</span> subpath <span class="free">g</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sp_Cons wf_sub_rel.trancl_eq<span class="main">[</span><span class="operator">OF</span> wf_sub_rel<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplification lemma for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"subpath"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when the sequence is known to end by a given 
edge.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_append_one <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">(</span><span class="free">es</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="free">subs</span> 
                                     <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> edges <span class="free">g</span>  
                                     <span class="main">∧</span> <span class="main">(</span>tgt <span class="free">e</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">,</span> <span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subpath_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span>  ces_append_one<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simpler version in the case of a well-formed subsumption relation.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel<span class="main">)</span> sp_append_one <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">(</span><span class="free">es</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="free">subs</span> 
                                     <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> edges <span class="free">g</span>  
                                     <span class="main">∧</span> <span class="main">(</span>tgt <span class="free">e</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">,</span> <span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sp_append_one in_trancl_imp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simplification lemma when the sequence is known to be the concatenation of two 
sub-sequences.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_append <span class="main">:</span>
  <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">(</span><span class="free">es1</span> <span class="main">@</span> <span class="free">es2</span><span class="main">)</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> 
   <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es1</span> <span class="bound">v</span> <span class="free">subs</span> <span class="main">∧</span> subpath <span class="free">g</span> <span class="bound">v</span> <span class="free">es2</span> <span class="free">v2</span> <span class="free">subs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">using</span></span> sub_rel_of.ces_imp_ends_vertices 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def ces_append<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> subpath_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span> <span class="main"><span class="main">:</span></span> ces_append<span class="main">)</span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a sub-path of a graph <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> starting at vertex <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
By definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"subpath"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a vertex of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Even if this is a 
direct consequence of the definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"subpath"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, this lemma will ease the proofs of some 
goals in the following.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> fst_of_sp_is_vert <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The same property (which also follows the definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"subpath"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but not as 
trivially as the previous lemma) can be established for the final vertex <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> lst_of_sp_is_vert <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sub_rel_of.trancl_sub_rel_of<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def sub_rel_of_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A sub-path ending in a subsumed vertex can be extended to the subsumer of this vertex, 
provided that the subsumption relation is a sub-relation of the graph it equips.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_append_sub <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v2</span><span class="main">,</span><span class="free">v3</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v3</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Nil_sp<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> 
        Nil_sp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span> 
        trancl_into_trancl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quoted"><span class="free">v3</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> neq_Nil_conv2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">es</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms trancl_into_trancl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be a graph equipped with a well-formed sub-relation. A sub-path starting at 
a subsumed vertex <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whose set of out-edges is empty is either:
\begin{enumerate}
  \item empty,
  \item a sub-path starting at the subsumer <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{enumerate}
The third assumption represent the fact that, when building red-black graphs, we do not allow to 
build the successor of a subsumed vertex.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel_of<span class="main">)</span> sp_from_subsumee <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="free">g</span> <span class="free">v1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>               
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> subpath <span class="free">g</span> <span class="free">v2</span> <span class="free">es</span> <span class="free">v</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
      wf_sub_rel.subsumed_by_two_imp<span class="main">[</span><span class="operator">OF</span> wf_sub_rel assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main">)</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that it is not possible to split this lemma into two lemmas (one for each member of the 
disjunctive conclusion). Suppose <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> could be empty or it could also be a non-empty sub-path leading from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, it could be <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">v2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> could 
be empty or not.›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A sub-path starting at a non-subsumed vertex whose set of out-edges is empty is also empty.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_from_de_empty <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∉</span> subsumees <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="free">g</span> <span class="free">v1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms tranclD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> be an edge whose target is not subsumed and has not out-going edges. A 
sub-path <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> containing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> ends by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and this occurrence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
is unique along <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sp_through_de_decomp <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tgt <span class="free">e</span> <span class="main">∉</span> subsumees <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="free">g</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">es'</span><span class="main">.</span> <span class="free">es</span> <span class="main">=</span> <span class="bound">es'</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∉</span> set <span class="bound">es'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil <span class="skolem">v1</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e'</span> <span class="skolem">es</span> <span class="skolem">v1</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="main">(</span>tgt <span class="skolem">e'</span><span class="main">)</span> <span class="skolem">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="skolem">e'</span> <span class="main">∨</span> <span class="main">(</span><span class="free">e</span> <span class="main">≠</span> <span class="skolem">e'</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∈</span> set <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> sp_from_de_empty<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">e'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consider a sub-path ending at the target of a recently added edge <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, whose target 
did not belong to the graph prior to its addition. If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">es</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> starts in another vertex than 
the target of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then it contains <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">e</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sub_rel_of<span class="main">)</span> sp_ends_in_tgt_imp_mem <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tgt <span class="free">e</span> <span class="main">∉</span> Graph.vertices <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> tgt <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>add_edge <span class="free">g</span> <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="free">es</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tgt <span class="free">e</span> <span class="main">∉</span> subsumers <span class="free">subs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> sub_rel_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span>tgt <span class="free">e</span><span class="main">)</span> <span class="main">∉</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tranclD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Nil_sp<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> neq_Nil_conv2<span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">∈</span> edges <span class="main">(</span>add_edge <span class="free">g</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">e'</span> <span class="main">=</span> tgt <span class="free">e</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> tranclD2 assms<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹tgt <span class="free">e</span> <span class="main">∉</span> subsumers <span class="free">subs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">e'</span><span class="main">]</span>›</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> vertices_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ArcExt">
<div class="head">
<h1>Theory ArcExt</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ArcExt
<span class="keyword2"><span class="keyword">imports</span></span> <a href="SubRel.html">SubRel</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Extending rooted graphs with edges›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we formalize the operation of adding to a rooted graph an edge whose source 
is already a vertex of the given graph but not its target. We call this operation an extension of the given graph by adding 
an edge. This corresponds to an abstraction of 
the act of adding an edge to the red part of a red\hyp{}black graph as a result of symbolic execution 
of the corresponding transition in the LTS under analysis, where all details about symbolic 
execution would have been abstracted.  We then state and prove a number of facts 
describing the evolution of the set of paths of the given graph, first without considering 
subsumption links then in the case of rooted graph equipped with a subsumption relation.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition and Basic properties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extending a rooted graph with an edge consists in adding to its set of edges an edge whose 
source is a vertex of this graph but whose target is not.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">extends</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'v</span> edge <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extends</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">≡</span> src <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∈</span> Graph.vertices <span class="free"><span class="bound"><span class="entity">g</span></span></span> 
                  <span class="main">∧</span> tgt <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∉</span> Graph.vertices <span class="free"><span class="bound"><span class="entity">g</span></span></span> 
                  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> <span class="main">(</span>add_edge <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹After such an extension, the set of out-edges of the target of the new edge is empty.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extends_tgt_out_edges <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">e</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"out_edges <span class="free">g'</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> vertices_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consider a graph equipped with a sub-relation. This relation is also a sub-relation of any 
extension of this graph.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sub_rel_of<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">e</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sub_rel_of <span class="free">g'</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sub_rel_of <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sub_rel_of_def vertices_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extending a graph with an edge preserves the existing sub-paths.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sp_in_extends <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">e</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="free">g</span>  <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Graph.subpath <span class="free">g'</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.subpath_def vertices_def<span class="main">)</span>






<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extending trees›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that extending a rooted graph that is already a tree yields a new tree. Since 
the empty rooted graph is a tree, all graphs produced using only the extension by edge are trees.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extends_is_tree <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_tree <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">e</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_tree <span class="free">g'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_tree_def Ball_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">g'</span> <span class="main">=</span> root <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> Graph.vertices <span class="free">g'</span>"</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">=</span> tgt <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">es</span><span class="main">.</span> path <span class="free">g'</span> <span class="bound">es</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Graph.path <span class="free">g</span> <span class="skolem">es</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">es'</span><span class="main">.</span> Graph.path <span class="free">g</span> <span class="bound">es'</span> <span class="skolem">v</span> <span class="main">⟶</span> <span class="bound">es'</span> <span class="main">=</span> <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Ex1_def is_tree_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Graph.path <span class="free">g'</span> <span class="skolem">es</span> <span class="skolem">v</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> sp_in_extends<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹root <span class="free">g'</span> <span class="main">=</span> root <span class="free">g</span>›</span></span><span class="main">)</span>
    
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">es'</span><span class="main">.</span> Graph.path <span class="free">g'</span> <span class="bound">es'</span> <span class="skolem">v</span> <span class="main">⟶</span> <span class="bound">es'</span> <span class="main">=</span>  <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">es'</span>
  
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Graph.path <span class="free">g'</span> <span class="skolem">es'</span> <span class="skolem">v</span>"</span></span>
  
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">es</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="skolem">es'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
  
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es''</span></span> 
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">es''</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∉</span> set <span class="skolem">es''</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Graph.path <span class="free">g'</span> <span class="skolem">es'</span> <span class="skolem">v</span>›</span></span>
              Graph.sp_through_de_decomp<span class="main">[</span><span class="operator">OF</span> extends_tgt_out_edges<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> tgt <span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Graph.path <span class="free">g'</span> <span class="skolem">es'</span> <span class="skolem">v</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one<span class="main">)</span>
  
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
              Graph.lst_of_sp_is_vert<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Graph.path <span class="free">g</span> <span class="skolem">es</span> <span class="skolem">v</span>›</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms 
              <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">es'</span><span class="main">.</span> Graph.path <span class="free">g</span> <span class="bound">es'</span> <span class="skolem">v</span> <span class="main">⟶</span> <span class="bound">es'</span> <span class="main">=</span> <span class="skolem">es</span>›</span></span> <span class="quoted"><span class="quoted">‹Graph.path <span class="free">g'</span> <span class="skolem">es'</span> <span class="skolem">v</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.subpath_def vertices_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Graph.path <span class="free">g</span> <span class="skolem">es</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">es'</span><span class="main">.</span> Graph.path <span class="free">g</span> <span class="bound">es'</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">es'</span> <span class="main">=</span> <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_tree_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Graph.path <span class="free">g'</span> <span class="skolem">es</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sp_in_extends<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹root <span class="free">g'</span> <span class="main">=</span> root <span class="free">g</span>›</span></span><span class="main">)</span>
  
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Graph.path <span class="free">g'</span> <span class="main">(</span><span class="skolem">es</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one<span class="main">)</span>
    
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">es'</span><span class="main">.</span> Graph.path <span class="free">g'</span> <span class="bound">es'</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">es'</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">es'</span>
  
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Graph.path <span class="free">g'</span> <span class="skolem">es'</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span>"</span></span>
  
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="skolem">es'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms 
            sp_ends_in_tgt_imp_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"root <span class="free">g</span>"</span></span> <span class="quoted"><span class="skolem">es'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.subpath_def vertices_def<span class="main">)</span>
  
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span>   <span class="quoted"><span class="quoted">"out_edges <span class="free">g'</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> extends_tgt_out_edges<span class="main">)</span>
  
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">es''</span><span class="main">.</span> <span class="skolem">es'</span> <span class="main">=</span> <span class="bound">es''</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∉</span> set <span class="bound">es''</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> Graph.sp_through_de_decomp<span class="main">)</span>
  
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es''</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">es''</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∉</span> set <span class="skolem">es''</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Graph.path <span class="free">g'</span> <span class="skolem">es''</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Graph.path <span class="free">g'</span> <span class="skolem">es'</span>  <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one<span class="main">)</span>
  
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Graph.path <span class="free">g</span> <span class="skolem">es''</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">∉</span> set <span class="skolem">es''</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.subpath_def vertices_def<span class="main">)</span>
  
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es''</span> <span class="main">=</span> <span class="skolem">es</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span> <span class="bound">as'</span><span class="main">.</span> Graph.path <span class="free">g</span> <span class="bound">as'</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">as'</span> <span class="main">=</span> <span class="skolem">es</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">es</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es'</span> <span class="main">=</span> <span class="skolem">es''</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of sub-paths in an extension›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extending a graph by an edge preserves the existing sub-paths.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sp_in_extends_w_subs <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">a</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span>  <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g'</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def sub_rel_of_def vertices_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In an extension, the target of the new edge has no out-edges. Thus sub-paths of the 
extension starting and ending in old vertices are sub-paths of the graph prior to its extension.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sub_rel_of<span class="main">)</span> sp_from_old_verts_imp_sp_in_old <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">e</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g'</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g</span>  <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∉</span> set <span class="free">es</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">=</span> tgt <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tgt <span class="free">e</span> <span class="main">∉</span> subsumees <span class="free">subs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub_rel_of assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"out_edges <span class="free">g'</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extends_tgt_out_edges<span class="main">)</span>
    
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">es'</span><span class="main">.</span> <span class="free">es</span> <span class="main">=</span> <span class="bound">es'</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∉</span> set <span class="bound">es'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span>  assms<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">∈</span> set <span class="free">es</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sp_through_de_decomp<span class="main">)</span>
    
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∉</span> set <span class="skolem">es'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tgt <span class="free">e</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
  
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹tgt <span class="free">e</span> <span class="main">∉</span> subsumees <span class="free">subs</span>›</span></span> tranclD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tgt <span class="free">e</span>"</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">subs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">using</span></span> sub_rel_of assms
  <span class="keyword1"><span class="command">unfolding</span></span> subpath_def sub_rel_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the same reason, sub-paths starting at the target of the new edge are empty.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sub_rel_of<span class="main">)</span> sp_from_tgt_in_extends_is_Nil <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">e</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g'</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="free">es</span> <span class="free">v</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sub_rel_of assms
      extends_tgt_out_edges
      sp_from_de_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tgt <span class="free">e</span>"</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quoted"><span class="free">g'</span></span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Moreover, a sub-path <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">es</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> starting in another vertex than the target of the new edge 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> but ending in this target has <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as last element. This occurrence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is 
unique among <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">es</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The prefix of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">es</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> preceding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a sub-path leading at the 
source of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the original graph.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sub_rel_of<span class="main">)</span> sp_to_new_edge_tgt_imp <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">e</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g'</span> <span class="free">v</span> <span class="free">es</span> <span class="main">(</span>tgt <span class="free">e</span><span class="main">)</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> tgt <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">es'</span><span class="main">.</span> <span class="free">es</span> <span class="main">=</span> <span class="bound">es'</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">∉</span> set <span class="bound">es'</span> <span class="main">∧</span> subpath <span class="free">g</span> <span class="free">v</span> <span class="bound">es'</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∉</span> set <span class="skolem">es'</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> sub_rel_of assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
        extends_tgt_out_edges<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        sp_through_de_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quoted"><span class="free">g'</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="quoted">"tgt <span class="free">e</span>"</span></span><span class="main">]</span>
        sp_ends_in_tgt_imp_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">es</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v</span> <span class="skolem">es'</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="free">subs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> fst_of_sp_is_vert<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SubRel.subpath <span class="free">g'</span> <span class="free">v</span> <span class="skolem">es'</span> <span class="main">(</span>src <span class="free">e</span><span class="main">)</span> <span class="free">subs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">es</span> <span class="main">=</span> <span class="skolem">es'</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> sub_rel_of <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">∉</span> set <span class="skolem">es'</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subpath_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sub_rel_of_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SubExt">
<div class="head">
<h1>Theory SubExt</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> SubExt
<span class="keyword2"><span class="keyword">imports</span></span> <a href="SubRel.html">SubRel</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Extending subsomption relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we are interested in the evolution of the set of sub-paths of a rooted 
graph equipped with a subsumption relation after adding a subsumption to this relation. We are 
only interested in adding subsumptions such that the resulting relation is a well-formed 
sub-relation of the graph (provided the original relation was such). As
for the extension 
by edges, a number of side conditions must be met for the new subsumption to be added.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extending a subsumption relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> consists in adding a subsumption <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">sub</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
such that:
\begin{itemize}
  \item the two vertices involved are distinct,
  \item they are occurrences of the same vertex,
  \item they are both vertices of the graph,
  \item the subsumee must not already be a subsumer or a subsumee,
  \item the subsumer must not be a subsumee (but it can already be a subsumer),
  \item the subsumee must have no out-edges.
\end{itemize}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once again, in order to ease proofs, we use a predicate stating when a 
subsumpion relation is the extension of another instead of using a function that would produce the 
extension.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">extends</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> rgraph_scheme <span class="main">⇒</span> <span class="tfree">'v</span> sub_rel_t <span class="main">⇒</span> <span class="tfree">'v</span> sub_t <span class="main">⇒</span> <span class="tfree">'v</span> sub_rel_t <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extends</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">subs'</span></span></span> <span class="main">≡</span> <span class="main">(</span>
     subsumee <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">≠</span> subsumer <span class="free"><span class="bound"><span class="entity">sub</span></span></span>              
   <span class="main">∧</span> fst <span class="main">(</span>subsumee <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span>  <span class="main">=</span> fst <span class="main">(</span>subsumer <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span>  
   <span class="main">∧</span> subsumee <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">∈</span> Graph.vertices <span class="free"><span class="bound"><span class="entity">g</span></span></span>
   <span class="main">∧</span> subsumee <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">∉</span> subsumers <span class="free"><span class="bound"><span class="entity">subs</span></span></span>
   <span class="main">∧</span> subsumee <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">∉</span> subsumees <span class="free"><span class="bound"><span class="entity">subs</span></span></span>
   <span class="main">∧</span> subsumer <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">∈</span> Graph.vertices <span class="free"><span class="bound"><span class="entity">g</span></span></span>
   <span class="main">∧</span> subsumer <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">∉</span> subsumees <span class="free"><span class="bound"><span class="entity">subs</span></span></span>
   <span class="main">∧</span> out_edges <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>subsumee <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">subs'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">subs</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of extensions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we show that such extensions yield sub-relations (resp.\ well-formed relations), 
provided the original relation is a sub-relation (resp.\ well-formed relation).›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extending the sub-relation of a graph yields a new sub-relation for this graph.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sub_rel_of<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">subs</span> <span class="free">sub</span> <span class="free">subs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sub_rel_of <span class="free">g</span> <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms sub_rel_of <span class="keyword1"><span class="command">unfolding</span></span> sub_rel_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extending a well-formed relation yields a well-formed relation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel<span class="main">)</span> extends_imp_wf_sub_rel <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">subs</span> <span class="free">sub</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"wf_sub_rel <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> wf_sub_rel_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_sub_rel assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Ball_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> subsumees <span class="free">subs'</span>"</span></span> 

    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> subsumee <span class="free">sub</span> <span class="main">∨</span> <span class="skolem">v</span> <span class="main">∈</span> subsumees <span class="free">subs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Ex1_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"subsumer <span class="free">sub</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> subsumer <span class="free">sub</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> subsumees <span class="free">subs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs'</span> <span class="main">⟶</span> <span class="bound">v'</span> <span class="main">=</span> subsumer <span class="free">sub</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> subsumee <span class="free">sub</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> subsumees_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span> <span class="main"><span class="main">:</span></span> split_paired_All split_paired_Ex<span class="main">)</span>
 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms 
            <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">≠</span> subsumee <span class="free">sub</span>›</span></span> 
            <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>›</span></span> subsumed_by_one 
      <span class="keyword1"><span class="command">unfolding</span></span> subsumees_conv Ex1_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span> <span class="main"><span class="main">:</span></span> split_paired_All split_paired_Ex<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_sub_rel assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Thus, extending a well-formed sub-relation yields a well-formed sub-relation.›</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel_of<span class="main">)</span> extends_imp_wf_sub_rel_of <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">subs</span> <span class="free">sub</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"wf_sub_rel_of <span class="free">g</span> <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sub_rel_of assms
      wf_sub_rel.extends_imp_wf_sub_rel<span class="main">[</span><span class="operator">OF</span> wf_sub_rel assms<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel_of_def sub_rel_of_def<span class="main">)</span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of sub-paths in an extension›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extending a sub-relation of a graph preserves the existing sub-paths.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sp_in_extends <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">subs</span> <span class="free">sub</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms ces_Un<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">subs</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">sub</span><span class="main">}</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def sub_rel_of_def<span class="main">)</span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We want to describe how the addition of a subsumption modifies the set of sub-paths in the 
graph. As in the previous theories, we will focus on a small number of theorems expressing 
sub-paths in extensions as functions of sub-paths in the graphs before extending them (their 
subsumption relations). 
We first express sub-paths starting at the subsumee of the new subsumption, then the sub-paths 
starting at any other vertex.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First, we are interested in sub-paths starting at the subsumee of the new subsumption. Since 
such vertices have no out-edges, these sub-paths must be either empty or must  be sub-paths from 
the subsumer of this subsumption.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel_of<span class="main">)</span> sp_in_extends_imp1 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">subs</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> subpath <span class="free">g</span> <span class="free">v2</span> <span class="free">es</span> <span class="free">v</span> <span class="free">subs'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
      extends_imp_wf_sub_rel_of<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      wf_sub_rel_of.sp_from_subsumee<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">subs'</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹After an extension, sub-paths starting at any other vertex than the new subsumee are either:
\begin{itemize}
  \item sub-paths of the graph before the extension if they do not ``use'' the new subsumption,
  \item made of a finite number of sub-paths of the graph before the extension if they use the 
new subsumption.
\end{itemize}
In order to state the lemmas expressing these facts, we first need to introduce the concept of 
\emph{usage} of a subsumption by a sub-path.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The idea is that, if a sequence of edges that uses a subsumption <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sub</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is consistent 
wrt.\ a subsumption relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sub</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must occur in the transitive closure 
of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> i.e.\ the consistency of the sequence directly (and partially) depends on 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sub</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In the case of well-formed subsumption relations, whose transitive 
closures equal the relations themselves, the dependency of the consistency reduces to the fact that 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sub</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a member of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">uses_sub</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> edge list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">uses_sub</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span>     <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">uses_sub</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">≠</span> src <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span>src <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="free">uses_sub</span> <span class="main">(</span>tgt <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order for a sequence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">es</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using the subsumption <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sub</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to be consistent wrt.\ 
to a subsumption relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the subsumption <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sub</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must occur in the transitive 
closure of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uses_sub <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">sub</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This reduces to the membership of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">sub</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">subs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when the latter is 
well-formed.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uses_sub <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">sub</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms trancl_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sub-paths prior to the extension do not use the new subsumption.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extends_and_sp_imp_not_using_sub <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">subs</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> uses_sub <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span>"</span></span>  
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"uses_sub <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ces <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> subsumees_conv 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="main">(</span><span class="operator">frule</span> tranclD<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>





<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Suppose that the empty sequence is a sub-path leading from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v1</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v2</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> after 
the extension. Then, the empty sequence is a sub-path leading from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v1</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v2</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
in the graph before the extension if and only if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">v1</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">v2</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not the new subsumption.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel_of<span class="main">)</span> sp_Nil_in_extends_imp <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">subs</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">[]</span> <span class="free">v2</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">[]</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">v1</span> <span class="main">≠</span> <span class="free">v</span> <span class="main">∨</span> <span class="free">v2</span> <span class="main">≠</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
        extends_and_sp_imp_not_using_sub<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">v2</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
        wf_sub_rel.extends_imp_wf_sub_rel<span class="main">[</span><span class="operator">OF</span> wf_sub_rel assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel.Nil_sp<span class="main">)</span>
  
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span> <span class="main">∨</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">∈</span> Graph.vertices <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lst_of_sp_is_vert<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="main">[]</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> sub_rel_of <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Thus, sub-paths after the extension that do not use the new subsumption are also sub-paths 
before the extension.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel_of<span class="main">)</span> sp_in_extends_not_using_sub <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">subs</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> uses_sub <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> sub_rel_of assms extends_imp_wf_sub_rel_of 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Nil_in_extends_imp wf_sub_rel_of.sp_Cons sp_Cons<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We are finally able to describe sub-paths starting at any other vertex than the new 
subsumee after the extension. Such sub-paths are made of a finite number of sub-paths before the 
extension: the usage of the new subsumption between such (sub-)sub-paths makes them sub-paths 
after the extension. We express this idea as follows. Sub-paths starting at any other vertex 
than the new subsumee are either: 
\begin{itemize}
  \item sub-paths of the graph before the extension,
  \item made of a non-empty prefix that is a sub-path leading to the new subsumee in the original 
graph and a (potentially empty) suffix that is a sub-path starting at the new subsumer after 
the extension.
\end{itemize}
For the second case, the lemma \verb?sp_in_extends_imp1? as well as the following lemma could be 
applied to the suffix in order to decompose it into sub-paths of the graph before extension 
(combined with the fact that we only consider finite sub-paths, we indirectly obtain that sub-paths 
after the extension are made of a finite number of sub-paths before the extension, that are made 
consistent with the new relation by using the new subsumption).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wf_sub_rel_of<span class="main">)</span> sp_in_extends_imp2 <span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"extends <span class="free">g</span> <span class="free">subs</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="free">subs</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">es1</span> <span class="bound">es2</span><span class="main">.</span> <span class="free">es</span> <span class="main">=</span> <span class="bound">es1</span> <span class="main">@</span> <span class="bound">es2</span> 
                                               <span class="main">∧</span> <span class="bound">es1</span> <span class="main">≠</span> <span class="main">[]</span> 
                                               <span class="main">∧</span> subpath <span class="free">g</span> <span class="free">v1</span> <span class="bound">es1</span> <span class="free">v</span> <span class="free">subs</span> 
                                               <span class="main">∧</span> subpath <span class="free">g</span> <span class="free">v</span> <span class="bound">es2</span> <span class="free">v2</span> <span class="free">subs'</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">es</span> <span class="free">v1</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"uses_sub <span class="free">v1</span> <span class="free">es</span> <span class="free">v2</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil <span class="skolem">v1</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">edge</span> <span class="skolem">es</span> <span class="skolem">v1</span><span class="main">)</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> src <span class="skolem">edge</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">v1</span><span class="main">,</span> src <span class="skolem">edge</span><span class="main">)</span> <span class="main">∈</span> <span class="free">subs'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">edge</span> <span class="main">∈</span> edges <span class="free">g</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="skolem">es</span> <span class="free">v2</span> <span class="free">subs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> extends_imp_wf_sub_rel_of 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel_of.sp_Cons<span class="main">)</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="skolem">v1</span> <span class="main">[</span><span class="skolem">edge</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="free">subs'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span>  wf_sub_rel_of.sp_one<span class="main">[</span><span class="operator">OF</span> extends_imp_wf_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="free">g</span> <span class="skolem">v1</span> <span class="main">[</span><span class="skolem">edge</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="free">subs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> uses_sub <span class="skolem">v1</span> <span class="main">[</span><span class="skolem">edge</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Cons<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹subpath <span class="free">g</span> <span class="skolem">v1</span> <span class="main">[</span><span class="skolem">edge</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="free">subs'</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> sp_in_extends_not_using_sub<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">edge</span> <span class="main">=</span> <span class="free">v</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>  
      <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="free">g</span> <span class="skolem">v1</span> <span class="main">[</span><span class="skolem">edge</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="free">subs</span>›</span></span>  
            <span class="quoted"><span class="quoted">‹subpath <span class="free">g</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="skolem">es</span> <span class="free">v2</span> <span class="free">subs'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">edge</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uses_sub <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="skolem">es</span> <span class="free">v2</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">es</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="free">g</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="skolem">es</span> <span class="free">v2</span> <span class="free">subs'</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons.IH<span class="main">)</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="free">g</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="skolem">es</span> <span class="free">v2</span> <span class="free">subs'</span>›</span></span> 
              <span class="quoted"><span class="quoted">‹uses_sub <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="skolem">es</span> <span class="free">v2</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span>›</span></span> 
              extends_and_sp_imp_not_using_sub<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">es1</span> <span class="skolem">es2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">es</span> <span class="main">=</span> <span class="skolem">es1</span> <span class="main">@</span> <span class="skolem">es2</span>›</span></span> 
              <span class="quoted"><span class="quoted">‹subpath <span class="free">g</span> <span class="skolem">v1</span> <span class="main">[</span><span class="skolem">edge</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">edge</span><span class="main">)</span> <span class="free">subs</span>›</span></span> 
              <span class="quoted"><span class="quoted">‹subpath <span class="free">g</span> <span class="free">v</span> <span class="skolem">es2</span> <span class="free">v2</span> <span class="free">subs'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">edge</span> <span class="main">#</span> <span class="skolem">es1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_in_extends_not_using_sub<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="RB">
<div class="head">
<h1>Theory RB</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> RB
<span class="keyword2"><span class="keyword">imports</span></span> <a href="LTS.html">LTS</a> <a href="ArcExt.html">ArcExt</a> <a href="SubExt.html">SubExt</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Red-Black Graphs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we define red\hyp{}black graphs and the five operators that perform over 
them. Then, we state and prove a number of intermediate lemmas about red\hyp{}black graphs 
built using only these five operators, in other words: invariants about our method of transformation 
of red\hyp{}black graphs.

Then, we define the notion of red\hyp{}black paths and state and prove the main properties of our 
method, namely its correctness and the fact that it preserves the set of feasible paths of the 
program under analysis.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Definitions›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The type of Red-Black Graphs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We represent red-black graph with the following record. We detail its fields:
\begin{itemize}
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">red</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the red graph, called \emph{red part}, which represents the unfolding of 
the black part. Its vertices are indexed black vertices,
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">black</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the original LTS, the \emph{black part},
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">subs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the subsumption relation over the vertices of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">red</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">init_conf</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the initial configuration,
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">confs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a function associating configurations to the vertices of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">red</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">marked</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a function associating truth values to the vertices of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">red</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
We use it to represent the fact that a particular configuration (associated to a red location) is 
known to be unsatisfiable,
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">strengthenings</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a function associating boolean expressions over program 
variables to vertices of the red graph. Those boolean expressions can be seen as invariants that 
the configuration associated to the ``strengthened'' red vertex has to model.
\end{itemize}

We are only interested by red-black graphs obtained by the inductive relation 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">RedBlack</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. From now on, we call ``red-black graphs" the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">pre_RedBlack</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s 
obtained by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">RedBlack</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and ``pre-red-black graphs" all other ones.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack <span class="main">=</span>
  red            <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> rgraph"</span></span>
  black          <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> lts"</span></span>
  subs           <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'vert</span> sub_rel_t"</span></span>
  init_conf      <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf"</span></span>
  confs          <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf"</span></span>
  marked         <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  strengthenings <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We call \emph{red vertices} the set of vertices of the red graph.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">red_vertices</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'x</span><span class="main">)</span> pre_RedBlack_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">red_vertices</span> <span class="free"><span class="bound"><span class="entity">lts</span></span></span> <span class="main">≡</span> Graph.vertices <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">lts</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ui_edge</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the operation of ``unindexing'' the ends of a red edge, thus giving the 
corresponding black edge.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ui_edge</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> edge <span class="main">⇒</span> <span class="tfree">'vert</span> edge"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ui_edge</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> src <span class="main">=</span> fst <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span> tgt <span class="main">=</span> fst <span class="main">(</span>tgt <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We extend this idea to sequences of edges.›</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ui_es</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> edge list <span class="main">⇒</span> <span class="tfree">'vert</span> edge list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ui_es</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">≡</span> map ui_edge <span class="free"><span class="bound"><span class="entity">es</span></span></span>"</span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Well-formed and finite red-black graphs›</span></span>

<span class="keyword1"><span class="command">locale</span></span> pre_RedBlack <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">prb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">structure</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A pre-red-black graph is well-formed if :
\begin{itemize}
  \item its red and black parts are well-formed,
  \item the root of its red part is an indexed version of the root of its black part,
  \item all red edges are indexed versions of black edges. 
\end{itemize}›</span></span>

<span class="keyword1"><span class="command">locale</span></span> wf_pre_RedBlack <span class="main">=</span> pre_RedBlack <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> red_wf           <span class="main">:</span> <span class="quoted"><span class="quoted">"wf_rgraph <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> black_wf         <span class="main">:</span> <span class="quoted"><span class="quoted">"wf_lts <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> consistent_roots <span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> root <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ui_re_are_be     <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">⟹</span> ui_edge <span class="free">e</span> <span class="main">∈</span> edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> wf_pre_RedBlack <span class="main">=</span> red_wf black_wf consistent_roots ui_re_are_be
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We say that a pre-red-black graph is finite if :
\begin{itemize}
  \item the path predicate of its initial configuration contains a finite number of constraints,
  \item each of these constraints contains a finite number of variables,
  \item its black part is finite (cf. definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"finite_lts"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.).
\end{itemize}›</span></span>


<span class="keyword1"><span class="command">locale</span></span> finite_RedBlack <span class="main">=</span> pre_RedBlack <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_init_pred         <span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="main">(</span>init_conf <span class="free">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_init_pred_symvars <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="main">(</span>init_conf <span class="free">prb</span><span class="main">)</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_lts               <span class="main">:</span> <span class="quoted"><span class="quoted">"finite_lts <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> finite_RedBlack <span class="main">=</span> finite_init_pred finite_init_pred_symvars finite_lts
<span class="keyword2"><span class="keyword">end</span></span>






<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extensions of Red-Black Graphs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now define the five basic operations that can be performed over red-black graphs. Since 
we do not want to model the heuristics part of our prototype, a number of conditions must be met 
for each operator to apply. For example, in our prototype abstractions are performed at nodes that 
actually have successors, and these abstractions must be propagated to these successors in order to 
keep the symbolic execution graph consistent. Propagation is a complex task, and it is hard to model 
in Isabelle/HOL. This is partially due to the fact that we model the red part as a graph, in which 
propagation might not terminate. Instead, we suppose that abstraction must be performed only at 
leaves of the red part. This is equivalent to implicitly assume the existence of an oracle that 
would tell that we will need to abstract some red vertex and how to abstract it, as soon as this red 
vertex is added to the red part.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As in the previous theories, we use predicates instead of functions to model these 
transformations to ease writing and reading definitions, proofs, etc.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Extension by symbolic execution›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The core abstract operation of symbolic execution: take a black edge and
turn it red, by symbolic execution of its label. In the following abbreviation, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">re</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the 
red edge obtained from the (hypothetical) black edge <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that we want to symbolically execute 
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the configuration obtained by symbolic execution of the label of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">e</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Note that 
this extension could have been defined as a 
predicate that takes only two <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">pre_RedBlack</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s and evaluates to \emph{true} if and only if 
the second has been obtained by adding a red edge as a result of symbolic execution. However, 
making the red edge and the configuration explicit allows for lighter definitions, lemmas and proofs 
in the following.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">se_extends</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack 
   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> edge 
   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf 
   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">se_extends</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">re</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">≡</span> 
     ui_edge <span class="free"><span class="bound"><span class="entity">re</span></span></span> <span class="main">∈</span> edges <span class="main">(</span>black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> 
   <span class="main">∧</span> ArcExt.extends <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">re</span></span></span> <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb'</span></span></span><span class="main">)</span> 
   <span class="main">∧</span> src <span class="free"><span class="bound"><span class="entity">re</span></span></span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span>
   <span class="main">∧</span> se  <span class="main">(</span>confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">re</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="free"><span class="bound"><span class="entity">re</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span> <span class="main">⦇</span> red       <span class="main">=</span> red <span class="free"><span class="bound"><span class="entity">prb'</span></span></span><span class="main">,</span>
              black     <span class="main">=</span> black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              subs      <span class="main">=</span> subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              init_conf <span class="main">=</span> init_conf <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              confs     <span class="main">=</span> <span class="main">(</span>confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">(</span>tgt <span class="free"><span class="bound"><span class="entity">re</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span>
              marked    <span class="main">=</span> <span class="main">(</span>marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span><span class="main">(</span>tgt <span class="free"><span class="bound"><span class="entity">re</span></span></span> <span class="main">:=</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">(</span>src <span class="free"><span class="bound"><span class="entity">re</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
              strengthenings <span class="main">=</span> strengthenings <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hiding the new red edge (using an existential quantifier) and the new configuration makes 
the following abbreviation more 
intuitive. However, this would require using \verb?obtain? or \verb?let ... = ... in ...? constructs 
in the following lemmas and proofs, making them harder to read and write.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">se_extends2</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">se_extends2</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">≡</span> 
   <span class="main">∃</span> <span class="bound">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb'</span></span></span><span class="main">)</span><span class="main">.</span> 
     ui_edge <span class="bound">re</span> <span class="main">∈</span> edges <span class="main">(</span>black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span>
   <span class="main">∧</span> ArcExt.extends <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="bound">re</span> <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb'</span></span></span><span class="main">)</span> 
   <span class="main">∧</span> src <span class="bound">re</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span>
   <span class="main">∧</span> se <span class="main">(</span>confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">(</span>src <span class="bound">re</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="bound">re</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>confs <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">(</span>tgt <span class="bound">re</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> black <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span> black <span class="free"><span class="bound"><span class="entity">prb</span></span></span>
   <span class="main">∧</span> subs <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>  <span class="main">=</span> subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span>
   <span class="main">∧</span> init_conf <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span> init_conf <span class="free"><span class="bound"><span class="entity">prb</span></span></span>
   <span class="main">∧</span> confs <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span> <span class="main">(</span>confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">(</span>tgt <span class="bound">re</span> <span class="main">:=</span> confs <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">(</span>tgt <span class="bound">re</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> marked <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span> <span class="main">(</span>marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span><span class="main">(</span>tgt <span class="bound">re</span> <span class="main">:=</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">(</span>src <span class="bound">re</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> strengthenings <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span> strengthenings <span class="free"><span class="bound"><span class="entity">prb</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Extension by marking›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The abstract operation of mark-as-unsat. It manages the information
- provided, for example, by an external automated prover -, that the 
configuration of the red vertex <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">rv</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has been proved unsatisfiable.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mark_extends</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mark_extends</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">≡</span>  
     <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">∈</span> red_vertices <span class="free"><span class="bound"><span class="entity">prb</span></span></span>
   <span class="main">∧</span> out_edges <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">=</span> <span class="main">{}</span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">∉</span> subsumers <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">¬</span> sat <span class="main">(</span>confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span> <span class="main">⦇</span> red       <span class="main">=</span> red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              black     <span class="main">=</span> black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              subs      <span class="main">=</span> subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              init_conf <span class="main">=</span> init_conf <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              confs     <span class="main">=</span> confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              marked    <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">rv'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">rv'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="bound">rv'</span><span class="main">)</span><span class="main">,</span>
              strengthenings <span class="main">=</span> strengthenings <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              <span class="main">…</span>        <span class="main">=</span> more <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">⦈</span> "</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Extension by subsumption›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The abstract operation of introducing a subsumption link.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">subsum_extends</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack <span class="main">⇒</span> <span class="tfree">'vert</span> sub_t <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subsum_extends</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">≡</span>
     SubExt.extends <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb'</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">¬</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">(</span>subsumer <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">¬</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">(</span>subsumee <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span>
   <span class="main">∧</span> confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">(</span>subsumee <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span> <span class="main">⊑</span> confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">(</span>subsumer <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span> <span class="main">⦇</span> red       <span class="main">=</span> red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              black     <span class="main">=</span> black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              subs      <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span><span class="main">,</span>
              init_conf <span class="main">=</span> init_conf <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              confs     <span class="main">=</span> confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              marked    <span class="main">=</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              strengthenings <span class="main">=</span> strengthenings <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
              <span class="main">…</span>        <span class="main">=</span> more <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Extension by abstraction›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This operation replaces the configuration of a red vertex <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">rv</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by an abstraction of 
this configuration. The way the abstraction is computed is not specified. However, besides a number 
of side conditions, it must subsume the former configuration of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">rv</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and must entail its 
safeguard condition, if any.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">abstract_extends</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> conf 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack 
    <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abstract_extends</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>a</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">≡</span> 
     <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">∈</span> red_vertices <span class="free"><span class="bound"><span class="entity">prb</span></span></span>
   <span class="main">∧</span> <span class="main">¬</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span>  
   <span class="main">∧</span> out_edges <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">=</span> <span class="main">{}</span> 
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span>
   <span class="main">∧</span> abstract <span class="main">(</span>confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>a</sub></span></span></span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>a</sub></span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span>strengthenings <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span>
   <span class="main">∧</span> finite <span class="main">(</span>pred <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>a</sub></span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>a</sub></span></span></span><span class="main">.</span> finite <span class="main">(</span>vars <span class="bound">e</span><span class="main">)</span><span class="main">)</span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span>  <span class="main">⦇</span> red       <span class="main">=</span> red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span> 
               black     <span class="main">=</span> black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span> 
               subs      <span class="main">=</span> subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span> 
               init_conf <span class="main">=</span> init_conf <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
               confs     <span class="main">=</span> <span class="main">(</span>confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>a</sub></span></span></span><span class="main">)</span><span class="main">,</span>
               marked    <span class="main">=</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
               strengthenings <span class="main">=</span> strengthenings <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
               <span class="main">…</span>        <span class="main">=</span> more <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">⦈</span>"</span></span>
      

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Extension by strengthening›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This operation consists in labeling a red vertex with a safeguard condition. It does not 
actually change the red part, but model the mechanism of preventing too crude abstractions.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">strengthen_extends</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack 
   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> 
   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> bexp 
   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack 
   <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strengthen_extends</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">≡</span>  
     <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">∈</span> red_vertices <span class="free"><span class="bound"><span class="entity">prb</span></span></span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span>
   <span class="main">∧</span> confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>
   <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span> <span class="main">=</span>  <span class="main">⦇</span> red       <span class="main">=</span> red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span> 
               black     <span class="main">=</span> black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span> 
               subs      <span class="main">=</span> subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span> 
               init_conf <span class="main">=</span> init_conf <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
               confs     <span class="main">=</span> confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
               marked    <span class="main">=</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">,</span>
               strengthenings <span class="main">=</span> <span class="main">(</span>strengthenings <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">(</span>strengthenings <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="bound">σ</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
               <span class="main">…</span>        <span class="main">=</span> more <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">⦈</span>"</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Building Red-Black Graphs using Extensions›</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Red-black graphs are pre-red-black graphs built with the following inductive relation, i.e.\ 
using only the five previous pre-red-black graphs transformation operators, starting from an 
empty red part.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">RedBlack</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span><span class="tfree">'var</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pre_RedBlack <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  base <span class="main">:</span> 
    <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> init <span class="main">(</span>black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span>      <span class="main">⟹</span>
     edges <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>                         <span class="main">⟹</span>
     subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">=</span> <span class="main">{}</span>                                <span class="main">⟹</span>
     <span class="main">(</span>confs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> init_conf <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">⟹</span>
     marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">rv</span><span class="main">.</span> False<span class="main">)</span>                   <span class="main">⟹</span> 
     strengthenings <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">rv</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span>     <span class="main">⟹</span> <span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span>"</span></span>

<span class="main">|</span> se_step <span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span>                                 <span class="main">⟹</span>
     se_extends <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">re</span></span></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>                    <span class="main">⟹</span> <span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>"</span></span>

<span class="main">|</span> mark_step <span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span>                                 <span class="main">⟹</span>
     mark_extends <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>                     <span class="main">⟹</span> <span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>"</span></span>
                                                 
<span class="main">|</span> subsum_step <span class="main">:</span>                                  
    <span class="quoted"><span class="quoted">"<span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span>                                 <span class="main">⟹</span>
     subsum_extends <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>                  <span class="main">⟹</span> <span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>"</span></span>
                                                 
<span class="main">|</span> abstract_step <span class="main">:</span>                                
    <span class="quoted"><span class="quoted">"<span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span>                                 <span class="main">⟹</span> 
     abstract_extends <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>a</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>             <span class="main">⟹</span> <span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>"</span></span>

<span class="main">|</span> strengthen_step <span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span>                                 <span class="main">⟹</span> 
     strengthen_extends <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>             <span class="main">⟹</span> <span class="free">RedBlack</span> <span class="free"><span class="bound"><span class="entity">prb'</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of Red-Black-Graphs›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Invariants of the Red\hyp{}Black Graphs›</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The red part of a red-black graph is loop free.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"loop_free <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A red edge can not lead to the (red) root.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"tgt <span class="free">re</span> <span class="main">≠</span> root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Red edges are specific versions of black edges.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ui_re_is_be <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ui_edge <span class="free">re</span> <span class="main">∈</span> edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span> RedBlack.induct<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The set of out-going edges from a red vertex is a subset of the set of out-going edges from 
the black location it represents.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> red_OA_subset_black_OA <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv</span> <span class="main">⊆</span> out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">rv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The red root is an indexed version of the black initial location.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_roots <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> init <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The red part of a red-black graph is a tree.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_tree <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> empty_graph_is_tree ArcExt.extends_is_tree<span class="main">)</span>

 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A red-black graph whose black part is well-formed is also well-formed.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_lts <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"wf_pre_RedBlack <span class="free">prb</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_rgraph <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
       <span class="keyword1"><span class="command">using</span></span> assms consistent_roots ui_re_is_be 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_pre_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Red locations of a red-black graph are indexed versions of its black locations.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ui_rv_is_bv <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="free">rv</span> <span class="main">∈</span> Graph.vertices <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms consistent_roots ui_re_is_be 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def image_def Bex_def<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The subsumption of a red-black graph is a sub-relation of its red part.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subs_sub_rel_of <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sub_rel_of <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sub_rel_of_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> se_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> mark_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> subsum_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abstract_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The subsumption relation of red-black graph is well-formed.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subs_wf_sub_rel <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"wf_sub_rel <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> se_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> mark_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> subsum_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel.extends_imp_wf_sub_rel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abstract_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using the two previous lemmas, we have that the subsumption relation of a red-black graph 
is a well-formed sub-relation of its red-part.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subs_wf_sub_rel_of <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"wf_sub_rel_of <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms subs_sub_rel_of subs_wf_sub_rel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel_of_def<span class="main">)</span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Subsumptions only involve red locations representing the same black location.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subs_to_same_BL <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">∈</span> subs <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="main">(</span>subsumee <span class="free">sub</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>subsumer <span class="free">sub</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms subs_wf_sub_rel <span class="keyword1"><span class="command">unfolding</span></span> wf_sub_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If a red edge sequence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">res</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is consistent between red locations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with respect to the subsumption relation of a red-black graph, then its unindexed 
version is consistent between the black locations represented by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rces_imp_bces <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SubRel.ces <span class="free">rv1</span> <span class="free">res</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>                        
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Graph.ces <span class="main">(</span>fst <span class="free">rv1</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="free">res</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">rv2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">res</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rv1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil <span class="skolem">rv1</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">using</span></span> wf_sub_rel.in_trancl_imp<span class="main">[</span><span class="operator">OF</span> subs_wf_sub_rel<span class="main">]</span> subs_to_same_BL
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">re</span> <span class="skolem">res</span> <span class="skolem">rv1</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> 1 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span> src <span class="skolem">re</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   2 <span class="main">:</span> <span class="quoted"><span class="quoted">"ces <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="skolem">res</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">rv1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1  wf_sub_rel.in_trancl_imp<span class="main">[</span><span class="operator">OF</span> subs_wf_sub_rel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span>"</span></span><span class="main">]</span>
              subs_to_same_BL<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span>src <span class="skolem">re</span><span class="main">)</span>"</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.ces <span class="main">(</span>tgt <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">rv2</span><span class="main">)</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Cons<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The unindexed version of a subpath in the red part of a red-black graph is a subpath in its 
black part. This is an important fact: in the end, it helps proving that set of paths we consider 
in red-black graphs are paths of the original LTS. Thus, the same states are computed along 
these paths.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> red_sp_imp_black_sp <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv1</span> <span class="free">res</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">rv1</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="free">res</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">rv2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms rces_imp_bces ui_rv_is_bv ui_re_is_be
<span class="keyword1"><span class="command">unfolding</span></span> subpath_def Graph.subpath_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Any constraint in the path predicate of a configuration associated to a red location of a 
red-black graph contains a finite number of variables.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_pred_constr_symvars <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv</span><span class="main">)</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>se_step <span class="skolem">prb</span> <span class="skolem">re</span> <span class="skolem">c'</span> <span class="skolem">prb'</span><span class="main">)</span> 

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span> <span class="main">∨</span> <span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
  
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_RedBlack <span class="skolem">prb</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>"</span></span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_label <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">e</span> <span class="main">∈</span> pred <span class="main">(</span>confs <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> se_step se_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"se <span class="main">(</span>confs <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step se_preserves_finiteness1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> mark_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> subsum_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abstract_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The path predicate of a configuration associated to a red location of a 
red-black graph contains a finite number of constraints.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_pred <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>se_step <span class="skolem">prb</span> <span class="skolem">re</span> <span class="skolem">c'</span> <span class="skolem">prb'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span> <span class="main">∨</span> <span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rv</span></span><span class="main">]</span> se_step<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="main">(</span>confs <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span>"</span></span><span class="main">]</span> se_step<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
  
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> se_preserves_finiteness2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> mark_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> subsum_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abstract_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Hence, for a red location <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of a red-black graph and any label <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
there exists a configuration that can be obtained by symbolic execution of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from the 
configuration associated to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_RedBlack<span class="main">)</span> ex_se_succ <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> se <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv</span><span class="main">)</span> <span class="free">l</span> <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite_RedBlack assms 
      finite_imp_ex_se_succ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"confs <span class="free">prb</span> <span class="free">rv</span>"</span></span><span class="main">]</span>
      finite_pred<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">prb</span></span> <span class="quoted"><span class="free">rv</span></span> <span class="main">]</span>
      finite_pred_constr_symvars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">prb</span></span> <span class="quoted"><span class="free">rv</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Generalization of the previous lemma to a list of labels.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_RedBlack<span class="main">)</span> ex_se_star_succ <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite_labels <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> se_star <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv</span><span class="main">)</span> <span class="free">ls</span> <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite_RedBlack assms 
      finite_imp_ex_se_star_succ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"confs <span class="free">prb</span> <span class="free">rv</span>"</span></span> <span class="quoted"><span class="free">ls</span></span><span class="main">]</span>
      finite_pred<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">rv</span></span><span class="main">]</span> 
      finite_pred_constr_symvars<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">rv</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Hence, for any red sub-path, there exists a configuration that can be obtained by symbolic 
execution of its trace from the configuration associated to its source.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_RedBlack<span class="main">)</span> sp_imp_ex_se_star_succ <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv1</span> <span class="free">res</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> se_star 
                  <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv1</span><span class="main">)</span> 
                  <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="free">res</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                  <span class="bound">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite_RedBlack assms ex_se_star_succ 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def finite_RedBlack_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The configuration associated to a red location <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rl</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is update-able.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_RedBlack<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"updatable <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> finite_RedBlack assms 
      finite_conj<span class="main">[</span><span class="operator">OF</span> finite_pred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> 
                     finite_pred_constr_symvars<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      finite_pred_imp_se_updatable
<span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The configuration associated to the first member of a subsumption is subsumed by the 
configuration at its second member.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sub_subsumed <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">∈</span> subs <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"confs <span class="free">prb</span> <span class="main">(</span>subsumee <span class="free">sub</span><span class="main">)</span> <span class="main">⊑</span> confs <span class="free">prb</span> <span class="main">(</span>subsumer <span class="free">sub</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>se_step <span class="skolem">prb</span> <span class="skolem">re</span> <span class="skolem">c'</span> <span class="skolem">prb'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">∈</span> subs <span class="skolem">prb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subsumee <span class="free">sub</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"subsumer <span class="free">sub</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>1<span class="main">)</span> subs_sub_rel_of 
        <span class="keyword1"><span class="command">unfolding</span></span> sub_rel_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">∉</span> red_vertices <span class="skolem">prb</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> mark_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subsum_step <span class="skolem">prb</span> <span class="skolem">sub</span> <span class="skolem">prb'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abstract_step <span class="skolem">prb</span> <span class="skolem">rv</span> <span class="skolem">c<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">prb'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> subsumee <span class="free">sub</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> subsumer <span class="free">sub</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> subsumer <span class="free">sub</span>"</span></span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span>  <span class="quoted"><span class="quoted">"confs <span class="skolem">prb</span> <span class="main">(</span>subsumer <span class="free">sub</span><span class="main">)</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>subsumer <span class="free">sub</span><span class="main">)</span>"</span></span> 
           <span class="keyword1"><span class="command">using</span></span> abstract_step abstract_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
         <span class="keyword1"><span class="command">using</span></span> abstract_step
               subsums_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"confs <span class="skolem">prb</span>  <span class="main">(</span>subsumee <span class="free">sub</span><span class="main">)</span>"</span></span> 
                                <span class="quoted"><span class="quoted">"confs <span class="skolem">prb</span>  <span class="main">(</span>subsumer <span class="free">sub</span><span class="main">)</span>"</span></span> 
                                <span class="quoted"><span class="quoted">"confs <span class="skolem">prb'</span> <span class="main">(</span>subsumer <span class="free">sub</span><span class="main">)</span>"</span></span><span class="main">]</span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> subsumer <span class="free">sub</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> abstract_step <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">≠</span> subsumee <span class="free">sub</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Simplification lemmas for sub-paths of the red part.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rb_Nil_sp <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv1</span> <span class="main">[]</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">(</span><span class="free">rv1</span> <span class="main">∈</span> red_vertices <span class="free">prb</span> <span class="main">∧</span> <span class="main">(</span><span class="free">rv1</span> <span class="main">=</span> <span class="free">rv2</span> <span class="main">∨</span> <span class="main">(</span><span class="free">rv1</span><span class="main">,</span><span class="free">rv2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms subs_wf_sub_rel subs_sub_rel_of wf_sub_rel.Nil_sp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">lemma</span></span> rb_sp_one <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv1</span> <span class="main">[</span><span class="free">re</span><span class="main">]</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span> <span class="main">=</span> 
         <span class="main">(</span> sub_rel_of <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="free">rv1</span> <span class="main">=</span> src <span class="free">re</span> <span class="main">∨</span> <span class="main">(</span><span class="free">rv1</span><span class="main">,</span> src <span class="free">re</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span><span class="main">)</span> 
         <span class="main">∧</span> <span class="free">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>tgt <span class="free">re</span> <span class="main">=</span> <span class="free">rv2</span> <span class="main">∨</span> <span class="main">(</span>tgt <span class="free">re</span><span class="main">,</span> <span class="free">rv2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms subs_wf_sub_rel_of wf_sub_rel_of.sp_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">lemma</span></span> rb_sp_Cons <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv1</span> <span class="main">(</span><span class="free">re</span> <span class="main">#</span> <span class="free">res</span><span class="main">)</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span> sub_rel_of <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>
            <span class="main">∧</span> <span class="main">(</span><span class="free">rv1</span> <span class="main">=</span> src <span class="free">re</span> <span class="main">∨</span> <span class="main">(</span><span class="free">rv1</span><span class="main">,</span> src <span class="free">re</span><span class="main">)</span> <span class="main">∈</span> subs <span class="free">prb</span><span class="main">)</span> 
            <span class="main">∧</span> <span class="free">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>                       
            <span class="main">∧</span> subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>tgt <span class="free">re</span><span class="main">)</span> <span class="free">res</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms subs_wf_sub_rel_of wf_sub_rel_of.sp_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">lemma</span></span> rb_sp_append_one <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv1</span> <span class="main">(</span><span class="free">res</span> <span class="main">@</span> <span class="main">[</span><span class="free">re</span><span class="main">]</span><span class="main">)</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span> subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv1</span> <span class="free">res</span> <span class="main">(</span>src <span class="free">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span> 
            <span class="main">∧</span> <span class="free">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> 
            <span class="main">∧</span> <span class="main">(</span>tgt <span class="free">re</span> <span class="main">=</span> <span class="free">rv2</span> <span class="main">∨</span> <span class="main">(</span>tgt <span class="free">re</span><span class="main">,</span> <span class="free">rv2</span><span class="main">)</span> <span class="main">∈</span> subs <span class="free">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms subs_wf_sub_rel wf_sub_rel.sp_append_one sp_append_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation between red-vertices›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following key-theorem describes the relation between two red locations that are linked by 
a red sub-path. In a classical symbolic execution tree, the configuration at the end should be the 
result of symbolic execution of the trace of the sub-path from the configuration at its source. 
Here, due to the facts that abstractions might have occurred and that we consider sub-paths going 
through subsumption links, the configuration at the end subsumes the configuration one would obtain 
by symbolic execution of the trace. Note however that this is only true for configurations computed 
during the analysis: concrete execution of the sub-paths would yield the same program states 
than their counterparts in the original LTS.›</span></span> 

<span class="keyword1"><span class="command">thm</span></span> RedBlack.induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_RedBlack<span class="main">)</span> SE_rel <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv1</span> <span class="free">res</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv1</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="free">res</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊑</span> <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms finite_RedBlack
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rv1</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">rv2</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span> RedBlack.induct<span class="main">)</span> 
  <span class="comment1">(* If the red part is empty, then @{term "rv1 = rv2 = root (red prb)"}, and 
     @{term "confs prb rv1 = confs prb rv2"} which prooves the goal, subsumption 
     being reflexive. *)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">prb</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="skolem">c</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def Nil_sp subsums_refl<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">(* We split the goal into four cases :
     - rv1 and rv2 are vertices of the old red part,
     - rv1 is a vertex in the old red part, rv2 is the target of ra,
     - rv1 is the target of ra, rv2 is a vertex of the old red part,
     - rv1 are rv2 both equal to the target of ra. *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>se_step <span class="skolem">prb</span> <span class="skolem">re</span> <span class="skolem">c'</span> <span class="skolem">prb'</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="skolem">c</span><span class="main">)</span>

       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">∈</span> red_vertices <span class="skolem">prb'</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">∈</span> red_vertices <span class="skolem">prb'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> fst_of_sp_is_vert<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
                  lst_of_sp_is_vert<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
           
       <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span> <span class="main">∧</span> <span class="skolem">rv1</span> <span class="main">≠</span> tgt <span class="skolem">re</span> <span class="main">∨</span> <span class="skolem">rv1</span> <span class="main">=</span> tgt <span class="skolem">re</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span> <span class="main">∧</span> <span class="skolem">rv2</span> <span class="main">≠</span> tgt <span class="skolem">re</span> <span class="main">∨</span> <span class="skolem">rv2</span> <span class="main">=</span> tgt <span class="skolem">re</span>"</span></span>
             <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>                             

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="comment1">(* rv1 are rv2 vertices of the old red part *)</span>
    <span class="keyword3"><span class="command">case</span></span> 1

    <span class="comment1">(* hence res is also a subpath from rv1 to rv2 in the old red part *)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span>
                sub_rel_of.sp_from_old_verts_imp_sp_in_old 
                <span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">prb</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb'</span>"</span></span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">rv2</span></span> <span class="quoted"><span class="skolem">res</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="comment1">(* thus, the IH can be used to conclude. *)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step 
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>

  <span class="keyword1"><span class="command">next</span></span> 
    <span class="comment1">(* rv1 is a vertex of the old red part, rv2 is the target of ra. *)</span>
    <span class="keyword3"><span class="command">case</span></span> 2 

    <span class="comment1">(* hence res is empty or ra occurs only one time in res : at its end. *)</span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">res'</span><span class="main">.</span> <span class="skolem">res</span> <span class="main">=</span> <span class="bound">res'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span>
                    <span class="main">∧</span> <span class="skolem">re</span> <span class="main">∉</span> set <span class="bound">res'</span>
                    <span class="main">∧</span> subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="bound">res'</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> se_step 
                 sub_rel_of.sp_to_new_edge_tgt_imp<span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">prb</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb'</span>"</span></span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">res</span></span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
      <span class="comment1">(* If res = res'@[ra], then there exists a configuration c' such that :
         - c' is obtained from (confs prb rv1) by symbolic execution of (the trace of) res,
         - c' is subsumed by (confs prb (src ra)) (by IH),
         - c is obtained from c' by symbolic execution of (the label of) ra.

         Moreover, we have :
         - (confs prb rv2) is obtained from (confs prb (src ra) by symbolic execution 
           of (the label of) ra.

         Ultimately, we proof the goal by monotonicity of symbolic execution wrt subsumption. *)</span>  
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res'</span>

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="skolem">res'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∉</span> set <span class="skolem">res'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res'</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res'</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"se <span class="skolem">c'</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> se_step 2 se_star_append_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
        
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">⊑</span> <span class="main">(</span>confs <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
           <span class="keyword1"><span class="command">using</span></span> se_step <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">≠</span> tgt <span class="skolem">re</span>›</span></span> 2 
                 <span class="quoted"><span class="quoted">‹se <span class="skolem">c'</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>›</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_mono_for_sub<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">(* rv1 is the target of ra. Hence res is empty and rv2 also equals (tgt ra), 
       which contradicts our hypothesis. *)</span> 
    <span class="keyword3"><span class="command">case</span></span> 3 

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> <span class="skolem">rv2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>      
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span><span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> se_step 3 
            sub_rel_of.sp_from_tgt_in_extends_is_Nil
                <span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb'</span>"</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="skolem">rv2</span></span><span class="main">]</span>
            rb_Nil_sp<span class="main">[</span><span class="operator">OF</span> RedBlack.se_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">rv2</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">∈</span> subsumees <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
           <span class="keyword1"><span class="command">using</span></span> se_step <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span>  <span class="main"><span class="main">:</span></span> sub_rel_of_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">(* Finally, if rv1 and rv2 both equal (tgt ra), then we conclude using the fact that 
       the subsumption is reflexive. *)</span>
    <span class="keyword3"><span class="command">case</span></span> 4

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> se_step 
                sub_rel_of.sp_from_tgt_in_extends_is_Nil 
                    <span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb'</span>"</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="skolem">rv2</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">(* Marking a red vertex does not affect the configurations associated to red vertices,
     hence this case is trivial when observing that a subpath after marking is a subpath 
     before marking (which allows to apply the IH). *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mark_step <span class="skolem">prb</span> <span class="skolem">rv</span> <span class="skolem">prb'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subsum_step <span class="skolem">prb</span> <span class="skolem">sub</span> <span class="skolem">prb'</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="skolem">c</span><span class="main">)</span>

  <span class="comment1">(* The fact that prb' is also red-black will be needed several times in the following. *)</span>
  <span class="keyword1"><span class="command">have</span></span> RB' <span class="main">:</span> <span class="quoted"><span class="quoted">"RedBlack <span class="skolem">prb'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RedBlack.subsum_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subsum_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="comment1">(* First, we suppose that res starts at the newly subsumed red vertex. *)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> subsumee <span class="skolem">sub</span>"</span></span><span class="main">)</span>

   <span class="comment1">(* In this case, res is either empty, or a subpath starting at the subsumer of the new 
       subsumption. *)</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> subsumee <span class="skolem">sub</span>"</span></span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>subsumer <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> 
                wf_sub_rel_of.sp_in_extends_imp1 <span class="main">[</span> <span class="operator">OF</span> subs_wf_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> 
                                                   <span class="operator">of</span> <span class="quoted"><span class="quoted">"subsumee <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="quoted">"subsumer <span class="skolem">sub</span>"</span></span> <span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="comment1">(* If res is empty, then rv1 equals rv2 or (rv1,rv2) is in the new subsumption relation. *)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> <span class="skolem">rv2</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span><span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
             <span class="keyword1"><span class="command">using</span></span> subsum_step rb_Nil_sp<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="comment1">(* If rv1 = rv2, "their" configurations are also equal. Moreover, res being empty, c is the 
           configuration at rv1. We conclude using reflexivity of subsumption. *)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> <span class="skolem">rv2</span>"</span></span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
             <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">res</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> 
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="comment1">(* If (rv1, rv2) is in the new subsumption relation, then the configuration at rv1 is 
           subsumed by the configuration at rv2. We conclude using the fact c is the configuration 
           at rv1. *)</span> 
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span> <span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
             <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">res</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> 
                   sub_subsumed<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span><span class="skolem">rv2</span><span class="main">)</span>"</span></span><span class="main">]</span> 
             <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      
    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">(* If res is also a subpath from the subsumer of the new subsumption, we show the goal 
         by (backward) induction on res *)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>subsumer <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">res</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">rv2</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="comment1">(* If the red subpath is empty, then (rv1,rv2) is the new subsumption, which gives the goal 
           by definition of subsum_extends. *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">rv2</span> <span class="skolem">c</span><span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">=</span> subsumer <span class="skolem">sub</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subsumer <span class="skolem">sub</span><span class="main">,</span><span class="skolem">rv2</span><span class="main">)</span> <span class="main">∉</span> subs <span class="skolem">prb'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subsumer <span class="skolem">sub</span><span class="main">,</span><span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb'</span>"</span></span>

            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subsumer <span class="skolem">sub</span> <span class="main">∈</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"subsumer <span class="skolem">sub</span> <span class="main">∈</span> subsumers <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                 <span class="keyword1"><span class="command">using</span></span> subs_wf_sub_rel<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span> 
                 <span class="keyword1"><span class="command">unfolding</span></span> wf_sub_rel_def 
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> rb_Nil_sp<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> 1<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> subsumee <span class="skolem">sub</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">next</span></span>
        <span class="comment1">(* Inductive case : the red subpath has the form res@[ra]. *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">re</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="skolem">c</span><span class="main">)</span>

        <span class="comment1">(* We call :
           - c' the configuration obtained by symbolic execution of res from the configuration at 
             rv1,
           - c'' the configuration obtained by symbolic execution of ra from the configuration at 
             the source of ra.

           We show that c' is subsumed by the configuration at the source of ra (using "internal" 
           IH), hence c is subsumed by c'', by monotonicity of symbolic execution for subsumption.
           
           Moreover, we show that c'' is subsumed by the configuration at the target of ra, 
           using the fact that [ra] is subpath from the source of ra to its target in the old 
           red part with the "external" IH. 

           Finally, we show that the configuration at the target of ra is subsumed by the 
           configuration at rv2 by observing that the target of ra is either rv2, either subsumed 
           by rv2. 
           
           We conclude using transitivity of subsumption.  *)</span>

        <span class="keyword1"><span class="command">hence</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>subsumer <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">res</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>   B <span class="main">:</span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one sp_one<span class="main">)</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> 
        <span class="keyword2"><span class="keyword">where</span></span> C <span class="main">:</span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>   D <span class="main">:</span> <span class="quoted"><span class="quoted">"se <span class="skolem">c'</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_append_one<span class="main">)</span> <span class="operator">blast</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c''</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> E <span class="main">:</span> <span class="quoted"><span class="quoted">"se <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>6-8<span class="main">)</span>
              <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
              RB' finite_RedBlack.ex_se_succ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_one fst_of_sp_is_vert<span class="main">)</span> <span class="operator">blast</span>        

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> <span class="skolem">c''</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> A B C D <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> D E se_mono_for_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c''</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb'</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb'</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def sp_one<span class="main">)</span>

            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                 <span class="keyword1"><span class="command">using</span></span> subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_one<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
               <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>6-8<span class="main">)</span> E 
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_one<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="skolem">rv2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">=</span> <span class="skolem">rv2</span> <span class="main">∨</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">,</span><span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb'</span>"</span></span> 
               <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> rb_sp_append_one<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">=</span> <span class="skolem">rv2</span>"</span></span> 
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_refl<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tgt <span class="skolem">re</span><span class="main">,</span> <span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sub_subsumed RB' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
              
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subsums_trans subsums_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">next</span></span>
  
    <span class="comment1">(* If res does not start at the newly subsumed red vertex, then either res is a subpath in 
       the old red part, either it can be splitted into two parts res1 and res2 such that :
       - res1 is a subpath in the old red part from rv1 to the newly subsumed vertex, 
       - res2 is a subpath in the new red part from the newly subsumed vertex to rv2. *)</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">≠</span> subsumee <span class="skolem">sub</span>"</span></span>

    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span> <span class="main">∨</span> 
            <span class="main">(</span><span class="main">∃</span> <span class="bound">res1</span> <span class="bound">res2</span><span class="main">.</span> <span class="skolem">res</span> <span class="main">=</span> <span class="bound">res1</span> <span class="main">@</span> <span class="bound">res2</span> 
                        <span class="main">∧</span> <span class="bound">res1</span> <span class="main">≠</span> <span class="main">[]</span> 
                        <span class="main">∧</span> subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="bound">res1</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span> 
                        <span class="main">∧</span> subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span> <span class="bound">res2</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> 
                 wf_sub_rel_of.sp_in_extends_imp2  <span class="main">[</span><span class="operator">OF</span> subs_wf_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> 
                                                    <span class="operator">of</span> <span class="quoted"><span class="quoted">"subsumee <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="quoted">"subsumer <span class="skolem">sub</span>"</span></span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
      <span class="comment1">(* In the first case, we conclude by "external" IH. *)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subsum_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">(* We call :
         - c1 the configuration obtained from the configuration at rv1 by symbolic execution 
           of res1 and such that c is obtained from c1 by symbolic execution of res2,
         - c2 the configuration obtained from the configuration at the newly subsumed red vertex 
           by symbolic execution of res2.

         We show that c is subsumed by c2 and that c2 is subsumed by the configuration at rv2.
         We conclude by transitivity of subsumption. *)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res1</span> <span class="skolem">res2</span>
       
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t_res1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t_res1</span> <span class="main">=</span> trace <span class="main">(</span>ui_es <span class="skolem">res1</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t_res2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t_res2</span> <span class="main">=</span> trace <span class="main">(</span>ui_es <span class="skolem">res2</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">res2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="skolem">res1</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res1</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">res2</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="skolem">t_res1</span> <span class="skolem">c1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"se_star <span class="skolem">c1</span> <span class="skolem">t_res2</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t_res2</span> <span class="skolem">c2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5<span class="main">,</span>6-8<span class="main">)</span> RB'
                  finite_RedBlack.ex_se_star_succ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb</span></span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">t_res1</span></span><span class="main">]</span>
                  finite_RedBlack.ex_se_star_succ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span> <span class="quoted"><span class="quoted">"subsumee <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="skolem">t_res2</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def t_res1_def t_res2_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span>  <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fst_of_sp_is_vert  se_star_append<span class="main">)</span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> <span class="skolem">c2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span>"</span></span> 
             <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>6-8<span class="main">)</span> 
                   <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res1</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>›</span></span>
                   <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="skolem">t_res1</span> <span class="skolem">c1</span>›</span></span>
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> t_res1_def t_res2_def<span class="main">)</span>
        
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
             <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹se_star <span class="skolem">c1</span> <span class="skolem">t_res2</span> <span class="skolem">c</span>›</span></span> 
                   <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t_res2</span> <span class="skolem">c2</span>›</span></span>
                   se_star_mono_for_sub
             <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="comment1">(* Here we have to proceed by beckward induction on res2. *)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="skolem">rv2</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">res2</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
                 <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t_res2</span> <span class="skolem">c2</span>›</span></span>
           <span class="keyword1"><span class="command">unfolding</span></span> t_res2_def
           <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">res2</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">rv2</span></span> <span class="quoted"><span class="skolem">c2</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
           <span class="comment1">(* If the suffix is empty, then either subsumee sub equals rv2, either 
              (subsumee sub,rv2) is in the new subsumption relation. *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">rv2</span> <span class="skolem">c2</span><span class="main">)</span> 

           <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subsumee <span class="skolem">sub</span> <span class="main">=</span> <span class="skolem">rv2</span> <span class="main">∨</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">,</span> <span class="skolem">rv2</span><span class="main">)</span><span class="main">∈</span>subs <span class="skolem">prb'</span>"</span></span> 
           <span class="keyword1"><span class="command">using</span></span> rb_Nil_sp<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
          <span class="comment1">(* In the first case, we have : 
               c = confs prb' (subsumee sub) = confs prb' rv2.
             We conclude by reflexivity of the subsumption. *)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"subsumee <span class="skolem">sub</span> <span class="main">=</span> <span class="skolem">rv2</span>"</span></span> 
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
               <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_refl<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(* In the second case, we have : 
               c = confs prb' (subsumee sub) ⊑ confs prb' rv2, 
             qed.  *)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">,</span> <span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb'</span>"</span></span> 
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> 
                sub_subsumed<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">,</span> <span class="skolem">rv2</span><span class="main">)</span>"</span></span><span class="main">]</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">next</span></span> 
        <span class="comment1">(* Inductive case : the suffix has the form res2@[ra]. *)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">re</span> <span class="skolem">res2</span> <span class="skolem">rv2</span> <span class="skolem">c2</span><span class="main">)</span>

        <span class="comment1">(* We call : 
           - c3 the configuration obtained from the configuration at the newly subsumed red 
             vertex. c2 is obtained from c3 by symbolic execution of ra,
           - c4 the configuration obtained from the configuration at the source of ra by 
             symbolic execution of ra.

           By internal IH, we first show that c3 is subsumed by the configuration at the source of 
           ra. Thus c2 is subsumed by c4, by monotonicity of symbolic execution for the 
           subsumption. 

           Then we show that c4 is subsumed by the configuration at the target of ra, using the 
           external IH.

           Finally, we show that the configuration at the target of ra is subsumed by the 
           configuration at rv2, by observing that either tgt ra = rv2, either (tgt ra,rv2) 
           is in the new subsumption relation. 

           We conclude by transitivity of the subsumption relation. *)</span>

        <span class="keyword1"><span class="command">have</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span> <span class="skolem">res2</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>  B <span class="main">:</span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> subs_wf_sub_rel<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span> subs_wf_sub_rel_of<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> wf_sub_rel.sp_append_one<span class="main">)</span>
                    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel_of.sp_one wf_sub_rel_of_def<span class="main">)</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c3</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> C <span class="main">:</span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>subsumee <span class="skolem">sub</span><span class="main">)</span><span class="main">)</span> 
                           <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res2</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                           <span class="main">(</span><span class="skolem">c3</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>   D <span class="main">:</span> <span class="quoted"><span class="quoted">"se <span class="skolem">c3</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c2</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> subsum_step<span class="main">(</span>6-8<span class="main">)</span> RB' 
                        finite_RedBlack.ex_se_succ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_append_one<span class="main">)</span> <span class="operator">blast</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c4</span></span> 
        <span class="keyword2"><span class="keyword">where</span></span> E <span class="main">:</span> <span class="quoted"><span class="quoted">"se <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>ui_edge <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c4</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>6-8<span class="main">)</span> RB' B 
                        finite_RedBlack.ex_se_succ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span>  <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fst_of_sp_is_vert se_star_append<span class="main">)</span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">⊑</span> <span class="skolem">c4</span>"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c3</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> A C <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> D E se_mono_for_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c4</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb'</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb'</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def sp_one<span class="main">)</span>

            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                 <span class="keyword1"><span class="command">using</span></span> subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_one<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">thus</span></span>  <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>6-8<span class="main">)</span> E 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_one<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="skolem">rv2</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">=</span> <span class="skolem">rv2</span> <span class="main">∨</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">,</span> <span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> subsum_step 2 rb_sp_append_one<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"subsumee <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="skolem">res2</span></span> <span class="quoted"><span class="skolem">re</span></span><span class="main">]</span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def subpath_def<span class="main">)</span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">=</span> <span class="skolem">rv2</span>"</span></span> 
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_refl<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tgt <span class="skolem">re</span><span class="main">,</span> <span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                 <span class="keyword1"><span class="command">using</span></span> sub_subsumed RB' 
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subsums_trans subsums_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsums_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abstract_step <span class="skolem">prb</span> <span class="skolem">rv</span> <span class="skolem">c<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">prb'</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="skolem">c</span><span class="main">)</span> 

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> <span class="skolem">rv</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> 
    <span class="comment1">(* We first suppose that rv1 is the red vertex where the abstraction took place. In this case, 
       we have that res is empty and rv2 = rv1. Hence c is the configuration at rv2 (after 
       abstraction). We conclude using reflexivity of subsumption. *)</span>
    <span class="keyword3"><span class="command">case</span></span> 1

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> abstract_step
                sp_from_de_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="quoted">"subs <span class="skolem">prb</span>"</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb</span>"</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="skolem">rv2</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> <span class="skolem">rv2</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span> <span class="skolem">rv2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> abstract_step <span class="quoted"><span class="quoted">‹<span class="skolem">res</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> 
                 rb_Nil_sp<span class="main">[</span><span class="operator">OF</span> RedBlack.abstract_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> abstract_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
           <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span> <span class="skolem">rv2</span><span class="main">)</span> <span class="main">∉</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> abstract_step 1 
           <span class="keyword1"><span class="command">unfolding</span></span> Ball_def subsumees_conv
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">blast</span>
      
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subsums_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">(* Suppose that rv1 is not the red vertex where the subsumption took place. *)</span> 
    <span class="keyword3"><span class="command">case</span></span> 2

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv</span>"</span></span><span class="main">)</span>
      <span class="comment1">(* We first suppose that rv2 is the newly abstracted red vertex. Then we have that the new 
         configuration at rv2 subsums the old configuration at this red vertex. We conclude 
         by use of IH and transitivity of subsumption. *)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"confs <span class="skolem">prb</span> <span class="skolem">rv2</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="skolem">rv2</span>"</span></span> 
             <span class="keyword1"><span class="command">using</span></span> abstract_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> abstract_def<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> confs <span class="skolem">prb</span> <span class="skolem">rv2</span>"</span></span> 
             <span class="keyword1"><span class="command">using</span></span> abstract_step 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subsums_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">≠</span> <span class="skolem">rv</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> abstract_step 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">(* Strengthening a red vertex does not affect the red part, thus this case is trivial. *)</span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>









<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Properties about marking.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A configuration which is indeed satisfiable can not be marked.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_not_marked <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="free">rv</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>se_step <span class="skolem">prb</span> <span class="skolem">re</span> <span class="skolem">c</span> <span class="skolem">prb'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span> <span class="main">∨</span> <span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> se_sat_imp_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mark_step <span class="skolem">prb</span> <span class="skolem">rv'</span> <span class="skolem">prb'</span><span class="main">)</span> 

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> <span class="skolem">rv'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv</span><span class="main">,</span><span class="skolem">rv'</span><span class="main">)</span> <span class="main">∉</span> subs <span class="skolem">prb</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sub_subsumed<span class="main">[</span><span class="operator">OF</span> mark_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv</span><span class="main">,</span><span class="skolem">rv'</span><span class="main">)</span>"</span></span><span class="main">]</span> unsat_subs_unsat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> subsum_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abstract_step <span class="skolem">prb</span> <span class="skolem">rv'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">prb'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv'</span> <span class="main">=</span> <span class="skolem">rv</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹On the other hand, a red-location which is marked unsat is indeed logically unsatisfiable.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"marked <span class="free">prb</span> <span class="free">rv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>se_step <span class="skolem">prb</span> <span class="skolem">re</span> <span class="skolem">c</span> <span class="skolem">prb'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span> <span class="main">∨</span> <span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"marked <span class="skolem">prb</span> <span class="skolem">rv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> se_step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="skolem">re</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"marked <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="main">(</span>confs <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> unsat_imp_se_unsat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mark_step <span class="skolem">prb</span> <span class="skolem">rv'</span> <span class="skolem">prb'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv'</span> <span class="main">=</span> <span class="skolem">rv</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> subsum_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abstract_step _ <span class="skolem">rv'</span> _<span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv'</span> <span class="main">=</span> <span class="skolem">rv</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>




<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Red vertices involved in subsumptions are not marked.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> subsumee_not_marked <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">∈</span> subs <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="main">(</span>subsumee <span class="free">sub</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>se_step <span class="skolem">prb</span> <span class="skolem">re</span> <span class="skolem">c</span> <span class="skolem">prb'</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"subsumee <span class="free">sub</span> <span class="main">≠</span> tgt <span class="skolem">re</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subs_wf_sub_rel_of<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel_of_def sub_rel_of_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> mark_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> subsum_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abstract_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> subsumer_not_marked <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="main">∈</span> subs <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="main">(</span>subsumer <span class="free">sub</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>se_step <span class="skolem">prb</span> <span class="skolem">re</span> <span class="skolem">c</span> <span class="skolem">prb'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"subsumer <span class="free">sub</span> <span class="main">≠</span> tgt <span class="skolem">re</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subs_wf_sub_rel_of<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> wf_sub_rel_of_def sub_rel_of_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mark_step <span class="skolem">prb</span> <span class="skolem">rv</span> <span class="skolem">prb'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subsum_step <span class="skolem">prb</span> <span class="skolem">sub'</span> <span class="skolem">prb'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abstract_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If the target of a red edge is not marked, then its source is also not marked.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tgt_not_marked_imp <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="main">(</span>tgt <span class="free">re</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="main">(</span>src <span class="free">re</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">re</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> se_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def image_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mark_step <span class="skolem">prb</span> <span class="skolem">rv</span> <span class="skolem">prb'</span> <span class="skolem">re</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">=</span> <span class="skolem">rv</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> subsum_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abstract_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Given a red subpath leading from red location <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to red location <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not marked, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is also not marked (this
lemma is not used).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="free">rv1</span> <span class="free">res</span> <span class="free">rv2</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="free">rv2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="free">rv1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">res</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rv1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil 
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> <span class="free">rv2</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span><span class="free">rv2</span><span class="main">)</span> <span class="main">∈</span> subs <span class="free">prb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> rb_Nil_sp<span class="main">)</span>
  
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Nil subsumee_not_marked<span class="main">[</span><span class="operator">OF</span> Nil<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">re</span> <span class="skolem">res</span><span class="main">)</span>  
  
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> rb_sp_Cons<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="free">rv2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> conjE disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> rb_sp_Cons<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="free">rv2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tgt_not_marked_imp<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subsumee_not_marked<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Fringe of a red-black graph›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We have stated and proved a number of properties of red-black graphs. In the end, we are 
mainly interested in proving that the set of paths of such red-black graphs are subsets of the set 
of feasible paths of their black part. Before defining the set of paths of red-black graphs, we 
first introduce the intermediate concept of \emph{fringe} of the red part. Intuitively, the fringe 
is the set of red vertices from which we can approximate more precisely the set of feasible paths of 
the black part. This includes red vertices that have not been subsumed yet, that are not marked and 
from which some black edges have not been yet symbolically executed (i.e.\ that have no red 
counterpart from these red vertices).›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The fringe is the set of red locations from which there exist black edges that have not 
been followed yet.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fringe</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'x</span><span class="main">)</span> pre_RedBlack_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fringe</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">rv</span></span> <span class="main">∈</span> red_vertices <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">.</span> 
                   <span class="bound">rv</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">∧</span> 
                   <span class="main">¬</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="bound">rv</span>           <span class="main">∧</span>
                   ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="bound">rv</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">rv</span><span class="main">)</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Fringe of an empty red-part›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹At the beginning of the analysis, i.e.\ when the red part is empty, the fringe consists of the 
red root.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fringe_of_empty_red1 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subs <span class="free">prb</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"marked <span class="free">prb</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">rv</span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fringe <span class="free">prb</span> <span class="main">=</span> <span class="main">{</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Evolution of the fringe after extension›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Simplification lemmas for the fringe of the new red-black graph after adding an edge by 
symbolic execution. If the configuration from which symbolic execution is performed is not marked 
yet, and if there exists black edges going out of the target of the executed edge, the target of 
the new red edge enters the fringe. Moreover, if there still exist black edges that have no red 
counterpart yet at the source of the new edge, then its source was and stays in the fringe.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> seE_fringe1 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sub_rel_of <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_extends <span class="free">prb</span> <span class="free">re</span> <span class="free">c'</span> <span class="free">prb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="main">(</span>src <span class="free">re</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> <span class="main">(</span>out_edges <span class="main">(</span>red <span class="free">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="free">re</span><span class="main">)</span><span class="main">)</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>src <span class="free">re</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="free">re</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fringe <span class="free">prb'</span> <span class="main">=</span> fringe <span class="free">prb</span> <span class="main">∪</span> <span class="main">{</span>tgt <span class="free">re</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff Un_iff singleton_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span> <span class="main">∨</span> <span class="skolem">rv</span> <span class="main">=</span> tgt <span class="free">re</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span> 

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="free">prb'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> fringe <span class="free">prb</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="free">re</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> sub_rel_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> <span class="main">(</span>out_edges <span class="main">(</span>red <span class="free">prb'</span><span class="main">)</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="free">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> fringe <span class="free">prb</span>"</span></span> 
    
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> src <span class="free">re</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> src <span class="free">re</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> src <span class="free">re</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">∈</span> fringe <span class="free">prb</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="free">re</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> extends_tgt_out_edges<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">re</span></span> <span class="quoted"><span class="quoted">"red <span class="free">prb</span>"</span></span> <span class="quoted"><span class="quoted">"red <span class="free">prb'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb'</span> <span class="skolem">rv</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="free">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹On the other hand, if all possible black edges have been executed from the source of the new 
edge after the extension, then the source is removed from the fringe.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>  seE_fringe4 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sub_rel_of <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_extends <span class="free">prb</span> <span class="free">re</span> <span class="free">c'</span> <span class="free">prb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="main">(</span>src <span class="free">re</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>ui_edge <span class="main">`</span> <span class="main">(</span>out_edges <span class="main">(</span>red <span class="free">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="free">re</span><span class="main">)</span><span class="main">)</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>src <span class="free">re</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="free">re</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fringe <span class="free">prb'</span> <span class="main">=</span> fringe <span class="free">prb</span> <span class="main">-</span> <span class="main">{</span>src <span class="free">re</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>tgt <span class="free">re</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff Un_iff singleton_iff Diff_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span> <span class="main">∨</span> <span class="skolem">rv</span> <span class="main">=</span> tgt <span class="free">re</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> src <span class="free">re</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span> 

  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="free">prb'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> fringe <span class="free">prb</span> <span class="main">∧</span> <span class="skolem">rv</span> <span class="main">≠</span> src <span class="free">re</span>"</span></span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="free">re</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> sub_rel_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> <span class="main">(</span>out_edges <span class="main">(</span>red <span class="free">prb'</span><span class="main">)</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="free">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> fringe <span class="free">prb</span> <span class="main">∧</span> <span class="skolem">rv</span> <span class="main">≠</span> src <span class="free">re</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="free">re</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> extends_tgt_out_edges<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">re</span></span> <span class="quoted"><span class="quoted">"red <span class="free">prb</span>"</span></span> <span class="quoted"><span class="quoted">"red <span class="free">prb'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb'</span> <span class="skolem">rv</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 2
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="free">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the source of the new edge is marked, then its target does not enter the fringe (and the 
source was not part of it in the first place).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> seE_fringe2 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_extends <span class="free">prb</span> <span class="free">re</span> <span class="free">c</span> <span class="free">prb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"marked <span class="free">prb</span> <span class="main">(</span>src <span class="free">re</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fringe <span class="free">prb'</span> <span class="main">=</span> fringe <span class="free">prb</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff Un_iff singleton_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> fringe_def mem_Collect_eq
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3 

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="free">re</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fringe_def mem_Collect_eq
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="free">re</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If there exists no black edges going out of the target of the new edge, then this target 
does not enter the fringe.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> seE_fringe3 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_extends <span class="free">prb</span> <span class="free">re</span> <span class="free">c'</span> <span class="free">prb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> <span class="main">(</span>out_edges <span class="main">(</span>red <span class="free">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="free">re</span><span class="main">)</span><span class="main">)</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>src <span class="free">re</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="free">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fringe <span class="free">prb'</span> <span class="main">=</span> fringe <span class="free">prb</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff Un_iff singleton_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> fringe_def mem_Collect_eq
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="free">re</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="free">re</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> <span class="main">(</span>out_edges <span class="main">(</span>red <span class="free">prb'</span><span class="main">)</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> src <span class="free">re</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> src <span class="free">re</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> src <span class="free">re</span>"</span></span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Moreover, if all possible black edges have been executed from the source of the new edge 
after the extension, then this source is removed from the fringe.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> seE_fringe5 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"se_extends <span class="free">prb</span> <span class="free">re</span> <span class="free">c'</span> <span class="free">prb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>ui_edge <span class="main">`</span> <span class="main">(</span>out_edges <span class="main">(</span>red <span class="free">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="free">re</span><span class="main">)</span><span class="main">)</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>src <span class="free">re</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="free">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fringe <span class="free">prb'</span> <span class="main">=</span> fringe <span class="free">prb</span> <span class="main">-</span> <span class="main">{</span>src <span class="free">re</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff Un_iff singleton_iff Diff_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> src <span class="free">re</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 1 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span>  <span class="comment1">(* slow *)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="skolem">rv</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"marked <span class="free">prb</span> <span class="skolem">rv</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"marked <span class="free">prb'</span> <span class="skolem">rv</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="free">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹marked <span class="free">prb</span> <span class="skolem">rv</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="free">prb'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> <span class="main">(</span>out_edges <span class="main">(</span>red <span class="free">prb'</span><span class="main">)</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="free">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> 2 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb'</span> <span class="skolem">rv</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="free">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
    
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Adding a subsumption to the subsumption relation removes the first member of the 
subsumption from the fringe.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subsumE_fringe <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subsum_extends <span class="free">prb</span> <span class="free">sub</span> <span class="free">prb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fringe <span class="free">prb'</span> <span class="main">=</span> fringe <span class="free">prb</span> <span class="main">-</span> <span class="main">{</span>subsumee <span class="free">sub</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Red-Black Sub-Paths and Paths›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The set of red-black subpaths starting in red location <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the union of :
\begin{itemize}
  \item the set of black sub-paths that have a red counterpart starting at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and leading 
to a non-marked red location,
  \item the set of black sub-paths that have a prefix represented in the red part starting 
at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">rv</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and leading to an element of the fringe. Moreover, the remainings of these black 
sub-paths must have no non-empty counterpart in the red part. Otherwise, the set of red-black paths 
would simply be the set of paths of the black part.
\end{itemize}
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">RedBlack_subpaths_from</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'x</span><span class="main">)</span> pre_RedBlack_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'vert</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'vert</span> edge list set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RedBlack_subpaths_from</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">≡</span> 
     ui_es <span class="main">`</span> <span class="main">{</span><span class="bound">res</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">rv'</span><span class="main">.</span> subpath <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="bound">res</span> <span class="bound">rv'</span> <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> marked <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="bound">rv'</span><span class="main">}</span>
   <span class="main">∪</span> <span class="main">{</span>ui_es <span class="bound">res1</span> <span class="main">@</span> <span class="bound">bes2</span> 
      <span class="main">|</span> <span class="bound">res1</span> <span class="bound">bes2</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">rv1</span><span class="main">.</span> <span class="bound">rv1</span> <span class="main">∈</span> fringe <span class="free"><span class="bound"><span class="entity">prb</span></span></span> 
                        <span class="main">∧</span> subpath <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="bound">res1</span> <span class="bound">rv1</span> <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span>
                        <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="bound">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                              <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                              <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="bound">rv1</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span><span class="main">)</span>
                        <span class="main">∧</span> Graph.subpath_from <span class="main">(</span>black <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">rv1</span><span class="main">)</span> <span class="bound">bes2</span><span class="main">}</span>"</span></span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Red-black paths are red-black subpaths starting at the root of the red part.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RedBlack_paths</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vert</span><span class="main">,</span> <span class="tfree">'var</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'x</span><span class="main">)</span> pre_RedBlack_scheme <span class="main">⇒</span> <span class="tfree">'vert</span> edge list set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">RedBlack_paths</span> <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">≡</span> RedBlack_subpaths_from <span class="free"><span class="bound"><span class="entity">prb</span></span></span> <span class="main">(</span>root <span class="main">(</span>red <span class="free"><span class="bound"><span class="entity">prb</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹When the red part is empty, the set of red-black subpaths starting at the red root is the set 
of black paths.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_RedBlack<span class="main">)</span> base_RedBlack_paths <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> init <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"edges <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"subs <span class="free">prb</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"confs <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> init_conf <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"marked <span class="free">prb</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">rv</span><span class="main">.</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strengthenings <span class="free">prb</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">rv</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">σ</span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RedBlack_paths <span class="free">prb</span> <span class="main">=</span> Graph.paths <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_eq_iff
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffI<span class="main">)</span>

     <span class="keyword3"><span class="command">fix</span></span>    <span class="skolem">bes</span>   
     <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>   
     <span class="keyword3"><span class="command">thus</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> Graph.paths <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">unfolding</span></span>  RedBlack_subpaths_from_def Un_iff
     <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
       <span class="keyword3"><span class="command">case</span></span> 1
       
       <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>
       
       <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.subpath_def vertices_def<span class="main">)</span>
     <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">case</span></span> 2
   
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res1</span></span> <span class="skolem"><span class="skolem">bes2</span></span> <span class="skolem"><span class="skolem">rv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span>
                                <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> fringe <span class="free">prb</span>"</span></span>
                                <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">res1</span> <span class="skolem">rv</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
                                <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="skolem">bes2</span>"</span></span>
                   <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
       <span class="keyword1"><span class="command">moreover</span></span>
       <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res1</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>
   
       <span class="keyword1"><span class="command">ultimately</span></span>
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">∈</span> fringe <span class="free">prb</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span>
     <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bes</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> Graph.paths <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>init <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>init <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
             <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
               <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span> 
               <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sub_rel_of_def subpath_def vertices_def<span class="main">)</span>
             <span class="keyword1"><span class="command">next</span></span>
               <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command">next</span></span>
               <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">[]</span>"</span></span> 
               <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> Graph.paths <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>›</span></span> 
                     <span class="quoted"><span class="quoted">‹out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>init <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bes</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_Cons<span class="main">)</span>
             <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>init <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                 <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
                 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> 
                        <span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                         <span class="keyword1"><span class="command">unfolding</span></span> Bex_def
                         <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>          
                             <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">∈</span> fringe <span class="free">prb</span>"</span></span>
                                 <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">,</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹out_edges <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>init <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> 
                                 fringe_of_empty_red1 
                                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                         <span class="keyword1"><span class="command">next</span></span>
                             <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="main">[]</span><span class="main">)</span><span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
                                <span class="keyword1"><span class="command">using</span></span> subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> RedBlack.base<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
                                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def vertices_def sub_rel_of_def<span class="main">)</span>
                         <span class="keyword1"><span class="command">next</span></span> 
                             <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main">)</span>
                                   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv</span>
                                   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span>
                                   <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
                                   <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span> <span class="skolem">res21</span> <span class="skolem">rv</span> <span class="main">(</span>subs <span class="free">prb</span><span class="main">)</span>"</span></span>
                                   <span class="keyword1"><span class="command">moreover</span></span>
                                   <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def<span class="main">)</span>
                                   <span class="keyword1"><span class="command">ultimately</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main">)</span>
                                <span class="keyword1"><span class="command">qed</span></span>
                        <span class="keyword1"><span class="command">next</span></span>
                             <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
                                <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> Graph.paths <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">qed</span></span>
                 <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>     
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>












<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Red-black sub-paths and paths are sub-paths and paths of the black part.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RedBlack_subpaths_are_black_subpaths <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RedBlack_subpaths_from <span class="free">prb</span> <span class="free">rv</span> <span class="main">⊆</span> Graph.subpaths_from <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">rv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subset_iff mem_Collect_eq RedBlack_subpaths_from_def Un_iff image_def Bex_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> disjE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">bes</span> <span class="skolem">res</span> <span class="skolem">rv'</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms red_sp_imp_black_sp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">bes</span> <span class="skolem">res1</span> <span class="skolem">bes2</span> <span class="skolem">rv1</span> <span class="skolem">bv2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">using</span></span> red_sp_imp_black_sp<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">rv</span></span>  <span class="quoted"><span class="skolem">res1</span></span> <span class="quoted"><span class="skolem">rv1</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bv2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RedBlack_paths_are_black_paths <span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"RedBlack_paths <span class="free">prb</span> <span class="main">⊆</span> Graph.paths <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
      RedBlack_subpaths_are_black_subpaths<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">prb</span></span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span><span class="main">]</span>
      consistent_roots<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">prb</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preservation of feasible paths›</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following theorem states that we do not loose feasible paths using
our five operators,
and moreover, configurations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at the end of feasible red paths in
some graph <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">prb</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will have corresponding feasible red paths in
successors that
lead to configurations that subsume <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">c</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. As a corollary, our calculus is correct
wrt. to execution.›</span></span>



<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_RedBlack<span class="main">)</span> feasible_subpaths_preserved <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> red_vertices <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"feasible_subpaths_from <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>confs <span class="free">prb</span> <span class="free">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">rv</span><span class="main">)</span> 
           <span class="main">⊆</span> RedBlack_subpaths_from <span class="free">prb</span> <span class="free">rv</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms finite_RedBlack
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rv</span></span><span class="main">)</span>

  <span class="comment1">(* Base case : the red part is empty. In this case, rl is the root of the red part. Hence, the 
     set of feasible subpaths starting at (fst rl) is the set of feasible paths of the black part.
     We conclude using the fact that when the red part is empty, the set of red-black subpaths is 
     the set of paths of the black part, which includes feasible paths. *)</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">prb</span> <span class="skolem">rv</span><span class="main">)</span> 

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> root <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> 
         <span class="main">=</span> feasible_paths <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> base <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span>
        ui_edge <span class="main">`</span>out_edges<span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span><span class="main">(</span>root <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span> <span class="main">⊂</span> out_edges<span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> base <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> finite_RedBlack.base_RedBlack_paths<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>

  <span class="comment1">(* Adding an edge by symbolic execution. *)</span>
    
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>se_step <span class="skolem">prb</span> <span class="skolem">re</span> <span class="skolem">c</span> <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> RB' <span class="main">:</span> <span class="quoted"><span class="quoted">"RedBlack <span class="skolem">prb'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RedBlack.se_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subset_iff
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bes</span> 

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span> <span class="main">∨</span> <span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb'</span> <span class="skolem">rv</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="comment1">(* We first suppose that bes does not start at the target of the new edge. In this case, we 
         can use the IH to show that bes is a red-black subpath in the old red-black graph. We then 
         proceed by case distinction. *)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">≠</span> tgt <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb</span> <span class="skolem">rv</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> se_step <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> RedBlack_subpaths_from_def<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> Un_iff image_def Bex_def mem_Collect_eq
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
          <span class="comment1">(* Suppose that bes is entirely represented in the old red part. Then it is also entirely 
             represented in the new red part, qed. *)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res</span> <span class="skolem">rv'</span>
        
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv'</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb</span> <span class="skolem">rv'</span>"</span></span>
        
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="skolem">rv'</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> lst_of_sp_is_vert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb</span>"</span></span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="skolem">rv'</span></span> <span class="quoted"><span class="quoted">"subs <span class="skolem">prb</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span> <span class="operator">auto</span>
        
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> sp_in_extends_w_subs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb</span>"</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb'</span>"</span></span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="skolem">rv'</span></span> <span class="quoted"><span class="quoted">"subs <span class="skolem">prb</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span> 
             <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        
        <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(* Suppose that bes is not entirely represented in the old red part, ie bes is of the form 
             ui_es res1 @ bes2 where res1 is a (maximal) red subpath (leading to a non-marked element 
             rv1 of the old fringe) and bes2 is black subpath (starting at the black vertex 
             represented by rv1. We then proceed by distinguishing the cases where the rv1 is the 
             source of the new edge or is an "old" red vertex. *)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res1</span> <span class="skolem">bes2</span> <span class="skolem">rv1</span> <span class="skolem">bl</span>
        
          <span class="keyword3"><span class="command">assume</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span>    B <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">∈</span> fringe <span class="skolem">prb</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span>    C <span class="main">:</span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv1</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
          <span class="comment1">(*and    D : "¬ marked prb rv1"*)</span>
          <span class="keyword2"><span class="keyword">and</span></span>    E <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                 <span class="main">∧</span>  <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                 <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span>    F <span class="main">:</span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span> <span class="skolem">bes2</span> <span class="skolem">bl</span>"</span></span>
        
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">≠</span> tgt <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
        
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span>"</span></span><span class="main">)</span>
            <span class="comment1">(* If rv1 is the source of the new edge, we proceed by cases on the black suffix. *)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span>"</span></span>
            
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
              <span class="comment1">(* If the black suffix is empty, then bes is in fact entirely represented in the old 
                 red part and also in the new red part, qed. *)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
              
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv1</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_in_extends_w_subs<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">≠</span> tgt <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="skolem">rv1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">qed</span></span>
        
            <span class="keyword1"><span class="command">next</span></span>
              <span class="comment1">(* If the black suffix is not empty, we first suppose that its first edge is the new 
                 edge. *)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>              
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">be</span></span> <span class="skolem"><span class="skolem">bes2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> <span class="skolem">be</span> <span class="main">#</span> <span class="skolem">bes2'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>        
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span><span class="main">)</span>
                <span class="comment1">(* If the first edge of the black suffix is represented by the new edge, then 
                   res1@[ra] is a red subpath leading to the target of the new edge, which is the 
                   fringe and not marked. Moreover, it is maximal, as there are no out-going edges 
                   from the target of the new edge in the new red part yet. Moreover, the tail of 
                   the black suffix is a suitable "new" black suffix, qed. *)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span> 
        
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
        
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>        
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>

                    <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                     <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                       <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span>›</span></span> C
                             sp_in_extends_w_subs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb</span>"</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb'</span>"</span></span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="skolem">res1</span></span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="quoted">"subs <span class="skolem">prb</span>"</span></span><span class="main">]</span>
                             rb_sp_append_one<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="skolem">res1</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command">next</span></span>
                       <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span>›</span></span> B 
                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
                     <span class="keyword1"><span class="command">next</span></span>
                       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> F <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> <span class="skolem">be</span> <span class="main">#</span> <span class="skolem">bes2'</span>›</span></span> 
                             <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span> <span class="quoted"><span class="quoted">‹out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bes2'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  Graph.sp_Cons<span class="main">)</span>
                       
                       <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">(</span><span class="skolem">res1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> <span class="skolem">be</span> <span class="main">#</span> <span class="skolem">bes2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                     <span class="keyword1"><span class="command">qed</span></span>
        
                <span class="keyword1"><span class="command">next</span></span>
        
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>                    
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>

                  <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span>"</span></span>     <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">(</span><span class="skolem">res1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bes2'</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> <span class="skolem">be</span> <span class="main">#</span> <span class="skolem">bes2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span> 
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">next</span></span>
                    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                           <span class="keyword1"><span class="command">using</span></span> B <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>        
                      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> 
                               seE_fringe1<span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> se_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
                               seE_fringe4<span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> se_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res1</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span>›</span></span> C
                               sp_in_extends_w_subs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb</span>"</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb'</span>"</span></span> 
                                                       <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="skolem">res1</span></span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="quoted">"subs <span class="skolem">prb</span>"</span></span><span class="main">]</span>
                               rb_sp_append_one<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="skolem">res1</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2'</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                           <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                           <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main">)</span>
                        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv2</span>
                        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span>
                        <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                        <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="skolem">res21</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>    
                        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> 
                             <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> 
                                   sub_rel_of.sp_from_tgt_in_extends_is_Nil
                                   <span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb'</span>"</span></span> <span class="quoted"><span class="skolem">res21</span></span> <span class="quoted"><span class="skolem">rv2</span></span><span class="main">]</span>
                             <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                      <span class="keyword1"><span class="command">qed</span></span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bes2'</span>"</span></span> 
                           <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> F <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> <span class="skolem">be</span> <span class="main">#</span> <span class="skolem">bes2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span> 
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_Cons<span class="main">)</span> 
                    <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">qed</span></span>  
                <span class="keyword1"><span class="command">qed</span></span>
        
              <span class="keyword1"><span class="command">next</span></span>
                <span class="comment1">(* If the first edge of the black suffix is not represented by the new edge, then 
                   this first edge is still not represented in the new red part. Hence, the source 
                   of the new edge is in the fringe of the new red part (and not marked). We 
                   conclude by showing that res1 is a suitable red prefix, and bes2 a suitable 
                   black suffix. *)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">≠</span> ui_edge <span class="skolem">re</span>"</span></span> 
        
                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
                <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
       
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span>
                       <span class="keyword1"><span class="command">unfolding</span></span> fringe_def mem_Collect_eq
                       <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                         <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">∈</span> red_vertices <span class="skolem">prb'</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def vertices_def<span class="main">)</span>
                       <span class="keyword1"><span class="command">next</span></span>
                         <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
                       <span class="keyword1"><span class="command">next</span></span>
                         <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="skolem">rv1</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> B se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">≠</span> tgt <span class="skolem">re</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span>›</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
                       <span class="keyword1"><span class="command">next</span></span>
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∉</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span>"</span></span>
                              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span>
                                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span>"</span></span>
                            
                                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re'</span>"</span></span>
                                                <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">re'</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span>"</span></span>
                                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                            
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                                <span class="keyword1"><span class="command">using</span></span> E
                                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main">)</span>
                                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re'</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="main">[</span><span class="skolem">re'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bes2'</span>"</span></span>
                                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> <span class="skolem">be</span> <span class="main">#</span> <span class="skolem">bes2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                <span class="keyword1"><span class="command">next</span></span>
                                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re'</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                <span class="keyword1"><span class="command">next</span></span>
                                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re'</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span>"</span></span> 
                                  <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">re'</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span>›</span></span> 
                                        <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">≠</span> ui_edge <span class="skolem">re</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re'</span>›</span></span> 
                                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
                            
                                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="main">[</span><span class="skolem">re'</span><span class="main">]</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
                                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">re'</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span>›</span></span> 
                                        subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
                                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
                                     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> rb_sp_one<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                                <span class="keyword1"><span class="command">qed</span></span>
                              <span class="keyword1"><span class="command">qed</span></span>
                       
                         <span class="keyword1"><span class="command">moreover</span></span>
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>"</span></span> 
                              <span class="keyword1"><span class="command">using</span></span> F <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> <span class="skolem">be</span> <span class="main">#</span> <span class="skolem">bes2'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_Cons<span class="main">)</span>
                       
                         <span class="keyword1"><span class="command">ultimately</span></span>
                         <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>"</span></span>
                              <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> red_OA_subset_black_OA<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                       <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv1</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                        <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_in_extends_w_subs<span class="main">)</span>
                <span class="comment1">(*next  show "¬ marked prb' rv1" using se_step(3) D `rv1 ≠ tgt ra` by auto*)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                         <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                         <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv3</span>                    
                    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res21</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>        
                    <span class="keyword1"><span class="command">moreover</span></span>
                    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re'</span></span> <span class="skolem"><span class="skolem">res21'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re'</span> <span class="main">#</span> <span class="skolem">res21'</span>"</span></span> 
                                           <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re'</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> <span class="skolem">be</span> <span class="main">#</span> <span class="skolem">bes2'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span> <span class="operator">simp</span>        
                    <span class="keyword1"><span class="command">ultimately</span></span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re'</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main">)</span>       
                    <span class="keyword1"><span class="command">moreover</span></span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re'</span> <span class="main">∉</span> edges <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> E
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main">)</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re'</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                         <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                           <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="main">[</span><span class="skolem">re'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bes2'</span>"</span></span> 
                           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> <span class="skolem">be</span> <span class="main">#</span> <span class="skolem">bes2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                         <span class="keyword1"><span class="command">next</span></span>
                           <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re'</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                         <span class="keyword1"><span class="command">next</span></span>
                           <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re'</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span>"</span></span>                           
                           <span class="keyword3"><span class="command">thus</span></span>   <span class="quoted"><span class="quoted">"subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="main">[</span><span class="skolem">re'</span><span class="main">]</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
                                  <span class="keyword1"><span class="command">using</span></span>  subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
                                        <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res21</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                        <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re'</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span>
                                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rb_sp_Cons<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RB'<span class="main"><span class="main">]</span></span><span class="main">)</span>
                                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> rb_sp_one<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                                  <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                         <span class="keyword1"><span class="command">qed</span></span>
        
                    <span class="keyword1"><span class="command">ultimately</span></span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                         <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">≠</span> ui_edge <span class="skolem">re</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re'</span>›</span></span>   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">qed</span></span>                           
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span> <span class="skolem">bes2</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>  
          <span class="keyword1"><span class="command">next</span></span>
            <span class="comment1">(* If rv1 is not the source of the new edge, then the out-going red edges of rv1 in the 
               new red part are the same as in the old red part. Thus res1 is a suitable red prefix, 
               and bes2 a suitable black suffix. *)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">≠</span> src <span class="skolem">re</span>"</span></span>
              
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
             <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
               <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>›</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command">next</span></span>
               <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
               <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>      
                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> 
                      <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> B <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">≠</span> src <span class="skolem">re</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">≠</span> tgt <span class="skolem">re</span>›</span></span>
                            seE_fringe1<span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> se_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
                            seE_fringe2<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
                            seE_fringe3<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
                            seE_fringe4<span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> se_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
                            seE_fringe5<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"marked <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span>"</span></span><span class="main">)</span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">⊂</span> 
                                       out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> 
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>   
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
               <span class="keyword1"><span class="command">next</span></span>
                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv1</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                       <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span>sp_in_extends_w_subs<span class="main">)</span>
                       <span class="comment1">(*next
                         show "¬ marked prb' rv1" 
                         using se_step(3) B D by (elim conjE) (auto simp add : fringe_def)*)</span>
               <span class="keyword1"><span class="command">next</span></span>
                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                        <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                        <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main">)</span>
                   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv2</span>             
                   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span>
                   <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                   <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res21</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>             
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re'</span></span> <span class="skolem"><span class="skolem">res21'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re'</span> <span class="main">#</span> <span class="skolem">res21'</span>"</span></span> 
                        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
             
                   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re'</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span>src <span class="skolem">re'</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb</span>"</span></span>
                   <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">re'</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> rb_sp_Cons<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span>
                             <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res21</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re'</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             
                   <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re'</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re'</span> <span class="main">≠</span> <span class="skolem">re</span>"</span></span>
                               <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re'</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span>src <span class="skolem">re'</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb</span>›</span></span>
                               <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                                 <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">≠</span> src <span class="skolem">re</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                               <span class="keyword1"><span class="command">next</span></span>
                                 <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
                                             <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">unfolding</span></span> fringe_def subsumees_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
                               <span class="keyword1"><span class="command">qed</span></span>                              
                               <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">re'</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">qed</span></span>
                   
                   <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                        <span class="keyword1"><span class="command">using</span></span> E
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re'</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ui_es <span class="skolem">res21'</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="main">[</span><span class="skolem">re'</span><span class="main">]</span> <span class="main">@</span> ui_es <span class="skolem">res21'</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span>
                               <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re'</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">next</span></span>
                         <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re'</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">next</span></span>
                          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="main">[</span><span class="skolem">re'</span><span class="main">]</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
                               <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>1<span class="main">)</span> 
                                     <span class="quoted"><span class="quoted">‹<span class="skolem">rv1</span> <span class="main">=</span> src <span class="skolem">re'</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">rv1</span><span class="main">,</span>src <span class="skolem">re'</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb</span>›</span></span> 
                                     <span class="quoted"><span class="quoted">‹<span class="skolem">re'</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span>›</span></span>
                                     rb_sp_one subs_sub_rel_of 
                               <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
                        <span class="keyword1"><span class="command">qed</span></span>
                 <span class="keyword1"><span class="command">qed</span></span>
               <span class="keyword1"><span class="command">next</span></span>
                 <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        
        <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">next</span></span> 
      <span class="comment1">(* If rl is the target of the new red edge, then we show that the empty (red) subpath is 
         suitable prefix and bes a suitable suffix, using the fact that the target of the new edge 
         is in the new fringe and can not be marked. *)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>"</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
        
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>

           <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
           <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
             <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">[]</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> rb_Nil_sp<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
           <span class="keyword1"><span class="command">next</span></span>
             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span>
                       <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> se_star_sat_imp_sat
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> feasible_def<span class="main">)</span>
          
             <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> sat_not_marked<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
           <span class="keyword1"><span class="command">next</span></span>
             <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">[]</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> <span class="quoted"><span class="quoted">‹out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
                        <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bes</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_Cons<span class="main">)</span>
           <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> 
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">[]</span> <span class="main">@</span> <span class="skolem">bes</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2   
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span>
                         <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> se_star_sat_imp_sat
                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> feasible_def<span class="main">)</span>

              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                    <span class="keyword1"><span class="command">using</span></span> se_step se_sat_imp_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span> <span class="main">≠</span> tgt <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> se_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb</span> <span class="main">(</span>src <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                   <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>

              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                   <span class="keyword1"><span class="command">using</span></span> se_step sat_not_marked<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span>"</span></span><span class="main">]</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
            <span class="keyword1"><span class="command">qed</span></span>
  
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> <span class="quoted"><span class="quoted">‹out_edges <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> 
                       seE_fringe1<span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> se_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
                       seE_fringe4<span class="main">[</span><span class="operator">OF</span> subs_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>  se_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
          <span class="keyword1"><span class="command">next</span></span>
  
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">[]</span> <span class="skolem">rv</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> subpath_def vertices_def<span class="main">)</span>
  
          <span class="keyword1"><span class="command">next</span></span>
  
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                 <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                 <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main">)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res1</span> <span class="skolem">bes22</span> <span class="skolem">rv'</span>
  
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="skolem">res1</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv'</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
  
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∨</span> tgt <span class="skolem">re</span> <span class="main">∈</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re'</span></span> <span class="skolem"><span class="skolem">res2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res1</span> <span class="main">=</span> <span class="skolem">re'</span><span class="main">#</span><span class="skolem">res2</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">res1</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> src <span class="skolem">re'</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">rv</span><span class="main">,</span>src <span class="skolem">re'</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv'</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
                            rb_sp_Cons<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="skolem">re'</span></span> <span class="quoted"><span class="skolem">res2</span></span> <span class="quoted"><span class="skolem">rv'</span></span><span class="main">]</span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span> 
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> src <span class="skolem">re'</span>"</span></span>
                  
                  <span class="keyword1"><span class="command">moreover</span></span>
                  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re'</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv'</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                              <span class="quoted"><span class="quoted">‹<span class="skolem">res1</span> <span class="main">=</span> <span class="skolem">re'</span><span class="main">#</span><span class="skolem">res2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> 
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main">)</span>
                  
                  <span class="keyword1"><span class="command">ultimately</span></span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv</span><span class="main">,</span>src <span class="skolem">re'</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb</span>"</span></span>
  
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span> 
                        <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv</span> <span class="main">=</span> tgt <span class="skolem">re</span>›</span></span> subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
                        <span class="keyword1"><span class="command">unfolding</span></span> sub_rel_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
                  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
  
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> 
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> 
                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def image_def<span class="main">)</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">∈</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span> <span class="main">∈</span> red_vertices <span class="skolem">prb</span>"</span></span> 
                       <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> se_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
                       <span class="keyword1"><span class="command">unfolding</span></span> subsumees_conv sub_rel_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="skolem">bes</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> se_step<span class="main">(</span>3<span class="main">)</span> 
                       <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mark_step <span class="skolem">prb</span> <span class="skolem">rv2</span> <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_RedBlack <span class="skolem">prb</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mark_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> subset_iff
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span> 
    <span class="comment1">(* Suppose that bes is a (black) feasible subpath starting at the black vertex represented by  
       red vertex rv1. Hence, by IH, bes is a red-black subpath starting at rv1 in the old red-black 
       graph. We proceed by case distinction. *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bes</span>    
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>trace <span class="skolem">bes</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"sat <span class="skolem">c</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> mark_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>›</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> feasible_def<span class="main">)</span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb</span> <span class="skolem">rv1</span>"</span></span> 
         <span class="keyword1"><span class="command">using</span></span> mark_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span><span class="main">]</span> mark_step<span class="main">(</span>3-7<span class="main">)</span> 
               <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>›</span></span> 
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb'</span> <span class="skolem">rv1</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> RedBlack_subpaths_from_def<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Un_iff image_def Bex_def mem_Collect_eq
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
      <span class="comment1">(* Suppose that bes is entirely represented in the old red part and let us call rv3 the red 
         vertex where it ends. We show that it is still fully represented in the new red-part and 
         that rv3 is still not marked in the new red-black graph. We call res the red subpath 
         representing bes in the old red part. *)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res</span> <span class="skolem">rv3</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb</span> <span class="skolem">rv3</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 

      <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">intro</span> conjI<span class="main">)</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rv'</span><span class="main">.</span> subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="bound">rv'</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="bound">rv'</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>       
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> mark_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>›</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(* We then show that rv3 is not marked. *)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="skolem">rv3</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="comment1">(* res being a red subpath from rv1 to rv3, and c being the configuration obtained 
               from the configuration at rv1 by symbolic execution of the trace of bes (and hence 
               res), we have that c is subsumed by the configuration at rv3. Hence, this 
               configuration is satisfiable, c being satisfiable. Thus, rv3 can not be marked. *)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv3</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> confs <span class="skolem">prb</span> <span class="skolem">rv3</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> mark_step<span class="main">(</span>1<span class="main">)</span> 
                                 <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>›</span></span> 
                                 <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span>›</span></span>
                                 <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>trace <span class="skolem">bes</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>›</span></span>
                                 <span class="quoted"><span class="quoted">‹finite_RedBlack <span class="skolem">prb</span>›</span></span>
                                 finite_RedBlack.SE_rel
                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                
                    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>trace <span class="skolem">bes</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>›</span></span> 
                               <span class="quoted"><span class="quoted">‹sat <span class="skolem">c</span>›</span></span>
                               sat_sub_by_sat
                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
                  <span class="keyword1"><span class="command">qed</span></span> 
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                 <span class="keyword1"><span class="command">using</span></span> mark_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>›</span></span>
                       lst_of_sp_is_vert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb</span>"</span></span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="skolem">rv3</span></span> <span class="quoted"><span class="quoted">"subs <span class="skolem">prb</span>"</span></span><span class="main">]</span>
                       sat_not_marked<span class="main">[</span><span class="operator">OF</span> RedBlack.mark_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mark_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">next</span></span>
        <span class="comment1">(* By construction, res represents bes. *)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">(* Suppose that bes has a maximal red prefix res1 leading to non-marked element rv3 of the old 
         fringe, and a black suffix bes2. We show that res1 and bes2 are still suitable red prefix 
         and black prefix, respectively, in the new red part. *)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res1</span> <span class="skolem">bes2</span> <span class="skolem">rv3</span> <span class="skolem">bl</span>

      <span class="keyword3"><span class="command">assume</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    B <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv3</span> <span class="main">∈</span> fringe <span class="skolem">prb</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    C <span class="main">:</span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res1</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span> <span class="comment1">(*and    D : "¬ marked prb rv3"*)</span>
      <span class="keyword2"><span class="keyword">and</span></span>    E <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                             <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                             <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv3</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    F <span class="main">:</span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv3</span><span class="main">)</span> <span class="skolem">bes2</span> <span class="skolem">bl</span>"</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>    
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="comment1">(* Marking a red vertex does not change the fringe, so rv3 is in the new fringe. *)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv3</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res1</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c'</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"se_star <span class="skolem">c'</span> <span class="main">(</span>trace <span class="skolem">bes2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"sat <span class="skolem">c'</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>trace <span class="skolem">bes</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹sat <span class="skolem">c</span>›</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_append se_star_sat_imp_sat<span class="main">)</span> <span class="operator">blast</span>
              
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">⊑</span> confs <span class="skolem">prb</span> <span class="skolem">rv3</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite_RedBlack <span class="skolem">prb</span>›</span></span> mark_step<span class="main">(</span>1<span class="main">)</span> C finite_RedBlack.SE_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sat_sub_by_sat<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv3</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mark_step<span class="main">(</span>3<span class="main">)</span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>       
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res1</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> mark_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res1</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>›</span></span>
               <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(* We show that res1 is a maximal prefix, which is trivial because the new red part 
             contains less subpaths than the old, and res1 was already maximal. *)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                               <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                               <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv3</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
               <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main">)</span>
         
                 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv4</span>
         
                 <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span>
                 <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                 <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv3</span> <span class="skolem">res21</span> <span class="skolem">rv4</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
         
                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                      <span class="keyword1"><span class="command">using</span></span> E
                      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res21</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span>
                             <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes22</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">intro</span> conjI<span class="main">)</span>
                        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>›</span></span><span class="main">)</span>
                      <span class="keyword1"><span class="command">next</span></span>
                        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main">)</span>
                      <span class="keyword1"><span class="command">next</span></span>
                        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv3</span> <span class="skolem">res21</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
                             <span class="keyword1"><span class="command">using</span></span> mark_step<span class="main">(</span>3<span class="main">)</span> 
                                   <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv3</span> <span class="skolem">res21</span> <span class="skolem">rv4</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
                             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span> <span class="main"><span class="main">:</span></span> split_paired_Ex<span class="main">)</span>  <span class="operator">blast</span>
                      <span class="keyword1"><span class="command">qed</span></span>
               <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv3</span><span class="main">)</span> <span class="skolem">bes2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mark_step<span class="main">(</span>3<span class="main">)</span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>  
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>subsum_step <span class="skolem">prb</span> <span class="skolem">sub</span> <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite_RedBlack <span class="skolem">prb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span>  RB' <span class="main">:</span> <span class="quoted"><span class="quoted">"RedBlack <span class="skolem">prb'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RedBlack.subsum_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subsum_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> subset_iff
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="comment1">(* Let bes be a feasible subpath starting at a black vertex represented by rl. By IH, bes is 
       a red-black subpath in the old red-black graph. We proceed by case distinction. *)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bes</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb</span> <span class="skolem">rv</span>"</span></span> 
           <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rv</span></span><span class="main">]</span> subsum_step<span class="main">(</span>3-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword3"><span class="command">thus</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb'</span> <span class="skolem">rv</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> RedBlack_subpaths_from_def<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> Un_iff image_def Bex_def mem_Collect_eq
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
      <span class="comment1">(* Suppose that bes is entirely represented in the old red part, then it is also entirely 
         represented in the new red part, qed. *)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res</span> <span class="skolem">rv'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv'</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb</span> <span class="skolem">rv'</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb'</span> <span class="skolem">rv</span>"</span></span> 
             <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> sp_in_extends<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb</span>"</span></span><span class="main">]</span>
             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span> <span class="main"><span class="main">:</span></span> RedBlack_subpaths_from_def Un_iff image_def 
                                      Bex_def mem_Collect_eq<span class="main"><span class="keyword3">,</span></span>
                 <span class="operator">intro</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
                <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">(* Suppose that bes was of the form ui_es res1 @ bes2, with res1 ending in a red vertex that 
         we call rv'. *)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res1</span> <span class="skolem">bes2</span> <span class="skolem">rv'</span> <span class="skolem">bl</span>
      <span class="keyword3"><span class="command">assume</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    B <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv'</span> <span class="main">∈</span> fringe <span class="skolem">prb</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    C <span class="main">:</span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv'</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
      <span class="comment1">(*and    D : "¬ marked prb rv'"*)</span>
      <span class="keyword2"><span class="keyword">and</span></span>    E <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                 <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                 <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv'</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>    F <span class="main">:</span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="skolem">bes2</span> <span class="skolem">bl</span>"</span></span>      
      <span class="keyword3"><span class="command">show</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb'</span> <span class="skolem">rv</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv'</span> <span class="main">=</span> subsumee <span class="skolem">sub</span>"</span></span><span class="main">)</span>
        <span class="comment1">(* Suppose that rv' is the newly subsumed red vertex. The idea here is to show that 
           either bes2 is a suitable black suffix from the new subsumer, either it is of the form 
           ui_es res21 @ bes22 such that res21 is maximal and ends in a non-marked element of the 
           (new) fringe, making res1@res21 a suitable red prefix and bes22 a suitable black suffix 
           for bes to be a red-black subpath of the new red-black graph (note that bes2 and bes22 
           might be empty).

           However, assumptions from subsum_step and facts 1 to 6 are not sufficient to 
           to conclude. We proceed by beckward induction on bes2. *)</span>

        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv'</span> <span class="main">=</span> subsumee <span class="skolem">sub</span>"</span></span> 

        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
             <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span> A C F
             <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">bes2</span></span> <span class="quasi_keyword">arbitrary</span> <span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">bes</span></span> <span class="quoted"><span class="skolem">bl</span></span> <span class="quasi_keyword">rule</span> <span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
               <span class="comment1">(* Suppose that the black suffix is empty, then bes is entirely representend by res1 in 
                  the new red part and ends in rv' which is not marked, qed. *)</span>
               <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">bes</span> <span class="skolem">bl</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                    <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> B sp_in_extends<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sub</span></span> <span class="quoted"><span class="quoted">"red <span class="skolem">prb</span>"</span></span><span class="main">]</span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span> <span class="main"><span class="main">:</span></span> 
                          RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq<span class="main"><span class="keyword3">,</span></span>
                        <span class="operator">intro</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
                       <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
                    
        <span class="keyword1"><span class="command">next</span></span>
          <span class="comment1">(* Suppose that the black subpath is not empty. We call bes2 the prefix obtained from this
             subpath by removing its last edge, which we call be. 

             We first show that ui_es res1 @ bes2 is a red-black subpath in the old new-black graph.
             using our "internal" induction hypothesis. We then proceed by case distinction. *)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">be</span> <span class="skolem">bes2</span> <span class="skolem">bes</span> <span class="skolem">bl</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="skolem"><span class="skolem">c3</span></span> 
               <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res1</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c1</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"se_star <span class="skolem">c1</span> <span class="main">(</span>trace <span class="skolem">bes2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c2</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"se <span class="skolem">c2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">be</span><span class="main">)</span> <span class="skolem">c3</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"sat <span class="skolem">c3</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span>
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> feasible_def se_star_append se_star_append_one se_star_one<span class="main">)</span> <span class="operator">blast</span>
             
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb'</span> <span class="skolem">rv</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>"</span></span> 
                 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
               
                   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span><span class="main">)</span>"</span></span>
                   <span class="keyword1"><span class="command">using</span></span> subsum_step 2<span class="main">(</span>5<span class="main">)</span> red_sp_imp_black_sp<span class="main">[</span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> C<span class="main">]</span>
                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append<span class="main">)</span> <span class="operator">blast</span>
               
                   <span class="keyword1"><span class="command">moreover</span></span>
                   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> 
                                  <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> 
                                   <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res1</span><span class="main">@</span><span class="skolem">bes2</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                                   <span class="skolem">c2</span>"</span></span>
                          <span class="keyword1"><span class="command">using</span></span> subsum_step 
                                <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res1</span><span class="main">)</span> 
                                         <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c1</span><span class="main">)</span>›</span></span>
                                <span class="quoted"><span class="quoted">‹se_star <span class="skolem">c1</span> <span class="main">(</span>trace <span class="skolem">bes2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c2</span>›</span></span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_append<span class="main">)</span> <span class="operator">blast</span>
               
                     <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="skolem">c2</span>"</span></span> 
                          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹se <span class="skolem">c2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">be</span><span class="main">)</span> <span class="skolem">c3</span>›</span></span> <span class="quoted"><span class="quoted">‹sat <span class="skolem">c3</span>›</span></span>  
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_sat_imp_sat<span class="main">)</span>
               
                     <span class="keyword1"><span class="command">ultimately</span></span>
                     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> feasible_def<span class="main">)</span> <span class="operator">blast</span>
                   <span class="keyword1"><span class="command">qed</span></span>
               
                   <span class="keyword1"><span class="command">ultimately</span></span>
                   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command">qed</span></span>
  
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="skolem">bes2</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one<span class="main">)</span>
  
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> RedBlack_subpaths_from_def<span class="main">)</span>
               <span class="keyword1"><span class="command">unfolding</span></span> Un_iff image_def Bex_def mem_Collect_eq
               <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                 <span class="comment1">(* Suppose that ui_es res1 @ bes2 is entirely represented in the new red part by 
                    a red subpath that we call res, and ends in a red vertex that we call rv''. 
                    We conclude depending on the fact that be is represented by an out-going 
                    (red edge) from rv'' or not. *)</span>
                 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">res</span> <span class="skolem">rv''</span><span class="main">)</span>  
                 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span><span class="main">)</span>
                   <span class="comment1">(* If this is the case, then bes = ui_es res1 @ bes2 @ [be] is entirely 
                    represented in the new red part. We call ra the red edge representing be from 
                    rv''. 
               
                    Moreover, we showed earlier that the configuration c3 that is obtained from the 
                    configuration at rl by symbolic execution of (the trace of) 
                    bes = ui_es res1 @ bes2 @ [be] is satisfiable. As c3 is subsumed by the 
                    configuration at the target of ra, this last configuration is also satisfiable, 
                    and  thus not marked, qed. *)</span>
                   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span>
                                  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                                              
                   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                        <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">intro</span> conjI<span class="main">)</span>
                          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                               <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>›</span></span> 
                               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
                        <span class="keyword1"><span class="command">next</span></span>
                          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span>
                            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                                   <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>›</span></span> 
                                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
                        
                              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> 
                              <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> 
                                             <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                                             <span class="skolem">c</span>"</span></span>
                                    <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> RB'
                                          finite_RedBlack.sp_imp_ex_se_star_succ
                                                 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                                    <span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def 
                                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
                        
                              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sat <span class="skolem">c</span>"</span></span> 
                                    <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span>
                                          <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res1</span><span class="main">)</span> 
                                                   <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c1</span><span class="main">)</span>›</span></span>
                                          <span class="quoted"><span class="quoted">‹se_star <span class="skolem">c1</span> <span class="main">(</span>trace <span class="skolem">bes2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c2</span>›</span></span>
                                          <span class="quoted"><span class="quoted">‹se <span class="skolem">c2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">be</span><span class="main">)</span> <span class="skolem">c3</span>›</span></span> 
                                          <span class="quoted"><span class="quoted">‹sat <span class="skolem">c3</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span>
                                          se_star_succs_states
                                                  <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"confs <span class="skolem">prb'</span> <span class="skolem">rv</span>"</span></span> 
                                                      <span class="quoted"><span class="quoted">"trace<span class="main">(</span>ui_es<span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>labelling<span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                                                      <span class="quoted"><span class="skolem">c3</span></span><span class="main">]</span>
                                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span>
                                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_append_one se_star_append 
                                                        se_star_one sat_eq<span class="main">)</span>
                        
                              <span class="keyword1"><span class="command">moreover</span></span>
                              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                                   <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> 
                                         <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                         <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span><span class="main">(</span>trace <span class="main">(</span>ui_es <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
                                                  <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">c</span><span class="main">)</span>›</span></span>
                                         finite_RedBlack.SE_rel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span><span class="main">]</span> RB'
                                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
                        
                              <span class="keyword1"><span class="command">ultimately</span></span>
                              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sat_sub_by_sat<span class="main">)</span>
                            <span class="keyword1"><span class="command">qed</span></span>
                        
                            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>›</span></span> 
                                       sat_not_marked<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
                          <span class="keyword1"><span class="command">qed</span></span>
                        <span class="keyword1"><span class="command">next</span></span>
                          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> 2<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command">qed</span></span>
                        
                 <span class="keyword1"><span class="command">next</span></span>
                   <span class="comment1">(* Suppose that be is not represented from rv''. We cannot conclude that [be] is 
                      a suitable suffix starting from rv'' for proving the goal, because rv'' might 
                      have been subsumed earlier. If this is the case, we have to show that [be] is 
                      a suitable suffix from the red vertex that subsums rv''. *)</span>
                   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∉</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
               
                   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv''</span> <span class="main">∈</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span><span class="main">)</span>
                     <span class="comment1">(* We suppose that rv'' is subsumed by a red vertex arv''. We conclude depen-
                        ding on the fact that be is represented in the out-going edges of arv'' or 
                        not. *)</span>
                     <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv''</span> <span class="main">∈</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
               
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">arv''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv''</span><span class="main">,</span><span class="skolem">arv''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               
                     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">arv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                           <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_sub<span class="main">)</span>
               
                     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                     <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>"</span></span><span class="main">)</span>
                       <span class="comment1">(* If be is represented in the out-going edges of arv'', then bes is entirely 
                          represented in the new red part, from rl to tgt ra. Moreover, the 
                          configuration at the target of ra subsums c, which is satisfiable, thus 
                          tgt ra can not be marked, qed. *)</span>
                       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>"</span></span>
               
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>"</span></span>
                                      <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               
                       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                            <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def 
                                      Bex_def mem_Collect_eq
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">intro</span> conjI<span class="main">)</span>
                            
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">arv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                         <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>›</span></span>
                                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
                            
                            <span class="keyword1"><span class="command">next</span></span>
                            
                              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span>
                              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                                     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">arv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                             <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>›</span></span>
                                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
                            
                                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> 
                                <span class="keyword2"><span class="keyword">where</span></span> se <span class="main">:</span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
                                                    <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span><span class="main">)</span>"</span></span>
                                      <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> RB'
                                            finite_RedBlack.sp_imp_ex_se_star_succ
                                                <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                                      <span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def 
                                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
                            
                                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sat <span class="skolem">c</span>"</span></span> 
                                      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span>
                                            <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res1</span><span class="main">)</span> 
                                                     <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c1</span><span class="main">)</span>›</span></span>
                                            <span class="quoted"><span class="quoted">‹se_star <span class="skolem">c1</span> <span class="main">(</span>trace <span class="skolem">bes2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c2</span>›</span></span>
                                            <span class="quoted"><span class="quoted">‹se <span class="skolem">c2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">be</span><span class="main">)</span> <span class="skolem">c3</span>›</span></span> <span class="quoted"><span class="quoted">‹sat <span class="skolem">c3</span>›</span></span> 
                                            <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span>
                                            se_star_succs_states
                                                    <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"confs <span class="skolem">prb'</span> <span class="skolem">rv</span>"</span></span> 
                                                        <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ui_es<span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                                                               <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                                                        <span class="quoted"><span class="quoted">"<span class="skolem">c3</span>"</span></span><span class="main">]</span>
                                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span>
                                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_append_one se_star_append 
                                                          se_star_one sat_eq<span class="main">)</span>
                            
                                <span class="keyword1"><span class="command">moreover</span></span>
                                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                                     <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> se RB' 
                                           finite_RedBlack.SE_rel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span><span class="main">]</span>
                                           <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>                          
                                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
                            
                                <span class="keyword1"><span class="command">ultimately</span></span>
                                <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sat_sub_by_sat<span class="main">)</span>
                              <span class="keyword1"><span class="command">qed</span></span>
                            
                              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>›</span></span> 
                                    sat_not_marked<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
                            
                            <span class="keyword1"><span class="command">next</span></span>
                            
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">(</span><span class="skolem">res</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span>"</span></span> 
                              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span> 
                                    <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res</span>›</span></span>
                                    <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span>
                              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                            
                            <span class="keyword1"><span class="command">qed</span></span>
                            
                     <span class="keyword1"><span class="command">next</span></span>
                       <span class="comment1">(* Suppose that be is not represented in the out-going edges of arv''. We 
                          show that res is a suitable red prefix and [be] a suitable black prefix.*)</span>
                       <span class="keyword3"><span class="command">assume</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∉</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>"</span></span>
               
                       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">be</span> <span class="main">=</span> fst <span class="skolem">arv''</span>"</span></span>
                       <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">arv''</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res</span>›</span></span> 
                               <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">arv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                               red_sp_imp_black_sp<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               
                         <span class="keyword1"><span class="command">moreover</span></span>
                         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span>"</span></span>
                         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span>
                               <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append Graph.sp_append_one Graph.sp_one<span class="main">)</span>
               
                         <span class="keyword1"><span class="command">ultimately</span></span>
                         <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                         <span class="keyword1"><span class="command">using</span></span> sp_same_src_imp_same_tgt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
                       <span class="keyword1"><span class="command">qed</span></span>
               
                       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                       <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                       <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                         
                         <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span> 
                         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span> 
                               <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res</span>›</span></span>
                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
               
                       <span class="keyword1"><span class="command">next</span></span>
               
                         <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">arv''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                         <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span> 
                           
                           <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">arv''</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> 
                           <span class="keyword1"><span class="command">unfolding</span></span> fringe_def mem_Collect_eq
                           <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                             <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">arv''</span> <span class="main">∈</span> red_vertices <span class="skolem">prb'</span>"</span></span> 
                             <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">arv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
                             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> lst_of_sp_is_vert<span class="main">)</span>
                           <span class="keyword1"><span class="command">next</span></span>
                             <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">arv''</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                             <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">rv''</span><span class="main">,</span><span class="skolem">arv''</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb'</span>›</span></span> subs_wf_sub_rel<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span>
                             <span class="keyword1"><span class="command">unfolding</span></span> wf_sub_rel_def Ball_def
                             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span> <span class="main"><span class="main">:</span></span> split_paired_All<span class="main">)</span>
                           <span class="keyword1"><span class="command">next</span></span>
                             <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="skolem">arv''</span>"</span></span>
                             <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">rv''</span><span class="main">,</span><span class="skolem">arv''</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> subsumer_not_marked<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span>
                             <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                           <span class="keyword1"><span class="command">next</span></span>
                             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                             <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span>
                                   <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bl</span>›</span></span>
                             <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one<span class="main">)</span>
               
                             <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span> <span class="main">⊂</span> out_edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> 
                                                                                    <span class="main">(</span>fst <span class="skolem">arv''</span><span class="main">)</span>"</span></span>
                             <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹src <span class="skolem">be</span> <span class="main">=</span> fst <span class="skolem">arv''</span>›</span></span> A  red_OA_subset_black_OA<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">arv''</span></span><span class="main">]</span>
                             <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                           <span class="keyword1"><span class="command">qed</span></span>
               
                         <span class="keyword1"><span class="command">next</span></span>
               
                           <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">arv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">arv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span><span class="main">)</span>
               
                         <span class="keyword1"><span class="command">next</span></span>
               
                           <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                                <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                                <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                           <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                             <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv'''</span><span class="main">)</span>
                               
                             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>"</span></span> 
                             <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                               <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="skolem"><span class="skolem">res21'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>"</span></span>
                               <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               
                               <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>"</span></span> 
                               <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                               <span class="keyword1"><span class="command">next</span></span>
                                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                                      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main">)</span>
                                 
                                 <span class="keyword1"><span class="command">moreover</span></span>
                                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span> <span class="main">=</span> <span class="skolem">arv''</span>"</span></span>
                                 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">arv''</span><span class="main">,</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">∉</span> subs <span class="skolem">prb'</span>"</span></span> 
                                        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">rv''</span><span class="main">,</span><span class="skolem">arv''</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb'</span>›</span></span> subs_wf_sub_rel<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span>
                                        <span class="keyword1"><span class="command">unfolding</span></span> wf_sub_rel_def Ball_def 
                                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span> <span class="main"><span class="main">:</span></span> split_paired_All<span class="main">)</span>
               
                                   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                                        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span>
                                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> rb_sp_Cons<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RB'<span class="main"><span class="main">]</span></span><span class="main">)</span>
                                 <span class="keyword1"><span class="command">qed</span></span>
               
                                 <span class="keyword1"><span class="command">ultimately</span></span>
                                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">arv''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                               <span class="keyword1"><span class="command">qed</span></span>
                               
                               <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                             <span class="keyword1"><span class="command">qed</span></span>
               
                             <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main">)</span>
                           <span class="keyword1"><span class="command">qed</span></span>
               
                         <span class="keyword1"><span class="command">next</span></span>
               
                           <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">arv''</span><span class="main">)</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span> 
                                <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span>
                                      <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bl</span>›</span></span>
                                      <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">rv''</span><span class="main">,</span><span class="skolem">arv''</span><span class="main">)</span> <span class="main">∈</span> subs <span class="skolem">prb'</span>›</span></span>
                                      <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">arv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
                                      <span class="quoted"><span class="quoted">‹src <span class="skolem">be</span> <span class="main">=</span> fst <span class="skolem">arv''</span>›</span></span>
                                      RB' red_sp_imp_black_sp subs_to_same_BL
                                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one Graph.sp_one<span class="main">)</span>
                         <span class="keyword1"><span class="command">qed</span></span>
                       <span class="keyword1"><span class="command">qed</span></span>
                     <span class="keyword1"><span class="command">qed</span></span>
               
                   <span class="keyword1"><span class="command">next</span></span>
                     <span class="comment1">(* Now suppose that rv'' is not subsumed in the new red-black graph. If be is 
                        represented in the out-going edges pf rv'', then ui_es res1 @ bes2 @ [be] 
                        is entirely represented in the new red part. Otherwise, res is a suitable 
                        red prefix and [be] a suitable black prefix. *)</span>
                     <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv''</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                     
                     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                     <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span><span class="main">)</span>
               
                       <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
               
                       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span>
                                      <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                       
                       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                            <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def 
                                      Bex_def mem_Collect_eq
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span><span class="operator">intro</span> conjI<span class="main">)</span>
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
                                         <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>›</span></span>
                                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
                            <span class="keyword1"><span class="command">next</span></span>
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span>
                              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span>
                                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                               <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>›</span></span>
                                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
                            
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> 
                                  <span class="keyword2"><span class="keyword">where</span></span> se <span class="main">:</span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span><span class="main">(</span>trace <span class="main">(</span>ui_es <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
                                                      <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="skolem">c</span><span class="main">)</span>"</span></span>
                                        <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> RB'
                                            finite_RedBlack.sp_imp_ex_se_star_succ
                                                      <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                                        <span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def 
                                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
                            
                                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sat <span class="skolem">c</span>"</span></span> 
                                        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span>
                                        <span class="quoted"><span class="quoted">‹se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="skolem">res1</span><span class="main">)</span> 
                                                 <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c1</span><span class="main">)</span>›</span></span>
                                        <span class="quoted"><span class="quoted">‹se_star <span class="skolem">c1</span> <span class="main">(</span>trace <span class="skolem">bes2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c2</span>›</span></span>
                                        <span class="quoted"><span class="quoted">‹se <span class="skolem">c2</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">be</span><span class="main">)</span> <span class="skolem">c3</span>›</span></span> <span class="quoted"><span class="quoted">‹sat <span class="skolem">c3</span>›</span></span> 
                                        <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span> 
                                        se_star_succs_states
                                              <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"confs <span class="skolem">prb'</span> <span class="skolem">rv</span>"</span></span> 
                                                  <span class="quoted"><span class="quoted">"trace <span class="main">(</span>ui_es <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                                                  <span class="quoted"><span class="quoted">"<span class="skolem">c3</span>"</span></span><span class="main">]</span>
                                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span>
                                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> se_star_append_one se_star_append 
                                                            se_star_one sat_eq<span class="main">)</span>
                            
                                  <span class="keyword1"><span class="command">moreover</span></span>
                                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                                       <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> se RB' 
                                             finite_RedBlack.SE_rel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span><span class="main">]</span>
                                             <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>  
                                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
                            
                                  <span class="keyword1"><span class="command">ultimately</span></span>
                                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sat_sub_by_sat<span class="main">)</span>
                                <span class="keyword1"><span class="command">qed</span></span>
                            
                                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                                     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>›</span></span> 
                                           sat_not_marked<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
                              <span class="keyword1"><span class="command">qed</span></span>
                            <span class="keyword1"><span class="command">next</span></span>
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">(</span><span class="skolem">res</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span>"</span></span> 
                                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span> 
                                         <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res</span>›</span></span>
                                         <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span>
                                   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                            <span class="keyword1"><span class="command">qed</span></span>
                     
                     <span class="keyword1"><span class="command">next</span></span>
                       <span class="keyword3"><span class="command">assume</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∉</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
               
                       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                            <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff Bex_def mem_Collect_eq
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span> 
                                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res</span>›</span></span> 
                                         <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span>
                                   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                            <span class="keyword1"><span class="command">next</span></span>
                            
                              <span class="keyword3"><span class="command">case</span></span> 2 
                            
                              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">be</span> <span class="main">=</span> fst <span class="skolem">rv''</span>"</span></span>
                              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span>"</span></span>
                                     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> 
                                                                         <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span>
                                           <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span> 
                                           <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res</span>›</span></span>
                                           red_sp_imp_black_sp
                                               <span class="main">[</span><span class="operator">OF</span> RB' <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span><span class="main">]</span>
                                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span> 
                                        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append Graph.sp_one<span class="main">)</span>
                            
                                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                                <span class="keyword1"><span class="command">using</span></span> red_sp_imp_black_sp
                                          <span class="main">[</span><span class="operator">OF</span> RB' <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span><span class="main">]</span>
                                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sp_same_src_imp_same_tgt<span class="main">)</span>
                              <span class="keyword1"><span class="command">qed</span></span>
                            
                              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                            
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv''</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> 
                                <span class="keyword1"><span class="command">unfolding</span></span> fringe_def mem_Collect_eq
                                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv''</span> <span class="main">∈</span> red_vertices <span class="skolem">prb'</span>"</span></span> 
                                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
                                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> lst_of_sp_is_vert<span class="main">)</span>
                                <span class="keyword1"><span class="command">next</span></span>
                                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv''</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv''</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span><span class="main">)</span>
                                <span class="keyword1"><span class="command">next</span></span>
                                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="skolem">rv''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="skolem">rv''</span>›</span></span><span class="main">)</span>
                                <span class="keyword1"><span class="command">next</span></span>
                                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                                       <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span>
                                            <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bl</span>›</span></span>
                                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one<span class="main">)</span>
                            
                                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span> <span class="main">⊂</span> 
                                           out_edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv''</span><span class="main">)</span>"</span></span>
                                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹src <span class="skolem">be</span> <span class="main">=</span> fst <span class="skolem">rv''</span>›</span></span> A 
                                             red_OA_subset_black_OA<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv''</span></span><span class="main">]</span>
                                       <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                <span class="keyword1"><span class="command">qed</span></span>
                            
                              <span class="keyword1"><span class="command">next</span></span>
                            
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span><span class="main">)</span>
                            
                              <span class="keyword1"><span class="command">next</span></span>
                            
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                                       <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                                       <span class="main">∧</span> SubRel.subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rv''</span><span class="main">)</span> 
                                                                             <span class="main">(</span><span class="bound">res21</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                                  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv'''</span><span class="main">)</span>
                                    
                                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span> 
                                  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="skolem"><span class="skolem">res21'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>"</span></span>
                                           <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                            
                                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span>
                                    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span> 
                                    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span><span class="main">#</span><span class="skolem">res21'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                    <span class="keyword1"><span class="command">next</span></span>
                                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                                      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons<span class="main">)</span>
                                      
                                      <span class="keyword1"><span class="command">moreover</span></span>
                                      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">re</span> <span class="main">=</span> <span class="skolem">rv''</span>"</span></span>
                                      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rv''</span><span class="main">,</span>src <span class="skolem">re</span><span class="main">)</span> <span class="main">∉</span> subs <span class="skolem">prb'</span>"</span></span> 
                                             <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv''</span> <span class="main">∉</span> subsumees <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                            
                                        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                                              <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span>
                                              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> rb_sp_Cons<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RB'<span class="main"><span class="main">]</span></span><span class="main">)</span>
                                      <span class="keyword1"><span class="command">qed</span></span>
                            
                                      <span class="keyword1"><span class="command">ultimately</span></span>
                                      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                    <span class="keyword1"><span class="command">qed</span></span>
                                    
                                    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                  <span class="keyword1"><span class="command">qed</span></span>
                            
                                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main">)</span>
                                <span class="keyword1"><span class="command">qed</span></span>
                            
                              <span class="keyword1"><span class="command">next</span></span>
                            
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv''</span><span class="main">)</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span>
                                     <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> 
                                           <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bl</span>›</span></span> 
                                           <span class="quoted"><span class="quoted">‹src <span class="skolem">be</span> <span class="main">=</span> fst <span class="skolem">rv''</span>›</span></span>
                                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">be</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
                                        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one Graph.sp_one<span class="main">)</span>
                            
                              <span class="keyword1"><span class="command">qed</span></span>
                            <span class="keyword1"><span class="command">qed</span></span>
                     <span class="keyword1"><span class="command">qed</span></span>
                   <span class="keyword1"><span class="command">qed</span></span>
                 <span class="keyword1"><span class="command">qed</span></span>
               
               <span class="keyword1"><span class="command">next</span></span>
                 <span class="comment1">(* Now suppose that ui_es res1 @ bes2 is of the form ui_es res1' @ bes2'.
                    Then there exists a red vertex rv'' such that :
                    - res1' is a maximal red prefix ending in rv'', which is not marked and 
                      in the new  fringe,
                    - bes2' starts at the black vertex represented by rv''. 
               
                    Note that bes2' can be empty. If this is the case, then we conclude depending 
                    on the  fact that be is represented or not in the out-going edges of rv''.
               
                    If this is not the case, we show that bes2'@[be] is also a suitable black 
                    suffix. *)</span>
                 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">res1'</span> <span class="skolem">bes2'</span> <span class="skolem">rv''</span> <span class="skolem">bl'</span><span class="main">)</span>
               
                 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
                   <span class="comment1">(* Suppose that bes2' is empty. Then either be is represented in the 
                      out-going edges of rv'', either it is not. *)</span>
                   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
               
                   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bl</span>"</span></span>
                   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res1'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span>"</span></span> 
                     <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="skolem">bes2</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span>"</span></span>
                            <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> 
                                  <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bes2</span><span class="main">@</span><span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bl</span>›</span></span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one<span class="main">)</span>
               
                       <span class="keyword1"><span class="command">moreover</span></span>
                       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv'</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                            <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv'</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>›</span></span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_in_extends<span class="main">)</span>
               
                       <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span>"</span></span>
                             <span class="keyword1"><span class="command">using</span></span> RB' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> red_sp_imp_black_sp<span class="main">)</span>
               
                       <span class="keyword1"><span class="command">ultimately</span></span>
                       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="skolem">bes2'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2'</span> <span class="main">=</span> <span class="main">[]</span>›</span></span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append<span class="main">)</span>
                     <span class="keyword1"><span class="command">qed</span></span>
               
                     <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span> <span class="skolem">bl</span>"</span></span> 
                          <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bes2</span><span class="main">@</span><span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bl</span>›</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one Graph.sp_one<span class="main">)</span>
               
                     <span class="keyword1"><span class="command">ultimately</span></span>
                     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append<span class="main">)</span>
                   <span class="keyword1"><span class="command">qed</span></span>
               
                   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res1'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span>"</span></span>
                   <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                   <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"tgt <span class="skolem">be</span> <span class="main">=</span> <span class="skolem">bl</span>"</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one<span class="main">)</span>
               
                   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">rv''</span> <span class="main">=</span> src <span class="skolem">be</span>"</span></span>
                   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res1'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv''</span><span class="main">)</span>"</span></span>
                          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1'</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                red_sp_imp_black_sp<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
               
                     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>ui_es <span class="skolem">res1'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span>›</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_same_src_imp_same_tgt<span class="main">)</span>
                   <span class="keyword1"><span class="command">qed</span></span>
               
                   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span><span class="main">)</span> 
                     <span class="comment1">(* If be is represented in the out-going edges of rv'' by a red edge that 
                        we call ra. Then ui_es res1'@[be] is entirely represented in the new 
                        red part. Moreover, the configuration at the target of ra subsums c 
                        which is satisfiable, and is in turn also satisfiable and thus not marked, 
                        qed. *)</span>
                     <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∈</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
               
                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span>
                                    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               
                     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                          <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff 
                                    image_def Bex_def mem_Collect_eq
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1'</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1'</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                       <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>›</span></span>
                                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
                          <span class="keyword1"><span class="command">next</span></span>
                            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>                    
                              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                                   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="main">(</span><span class="skolem">res1'</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                                          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1'</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                                  <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>›</span></span>
                                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_append_one<span class="main">)</span>
                                   
                                     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> 
                                     <span class="keyword2"><span class="keyword">where</span></span> se <span class="main">:</span> <span class="quoted"><span class="quoted">"se_star <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span>ui_es <span class="main">(</span><span class="skolem">res1'</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
                                                         <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span><span class="main">)</span>"</span></span>
                                         <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> RB'
                                               finite_RedBlack.sp_imp_ex_se_star_succ
                                                      <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span> <span class="quoted"><span class="skolem">rv</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res1'</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                                         <span class="keyword1"><span class="command">unfolding</span></span> finite_RedBlack_def 
                                         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
                                   
                                     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sat <span class="skolem">c</span>"</span></span>
                                           <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                             <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">(</span><span class="skolem">res1'</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span>"</span></span> 
                                                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span> 
                                                        <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2'</span> <span class="main">=</span> <span class="main">[]</span>›</span></span>
                                                        <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="skolem">bes2'</span>›</span></span> 
                                                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                           
                                             <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                                                  <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> se_star_succs_states<span class="main">[</span><span class="operator">OF</span> se<span class="main">]</span>
                                                        <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> 
                                                                                   <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> 
                                                                                   <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span>           
                                                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> feasible_def sat_eq<span class="main">)</span>
                                           <span class="keyword1"><span class="command">qed</span></span>
                                   
                                     <span class="keyword1"><span class="command">moreover</span></span>
                                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> confs <span class="skolem">prb'</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span>"</span></span> 
                                          <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> se 
                                                finite_RedBlack.SE_rel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">prb'</span></span><span class="main">]</span> RB'
                                                <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rv</span><span class="main">)</span> <span class="main">(</span><span class="skolem">res1'</span><span class="main">@</span><span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span> 
                                                         <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
                                   
                                     <span class="keyword1"><span class="command">ultimately</span></span>
                                     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sat_sub_by_sat<span class="main">)</span>
                                   <span class="keyword1"><span class="command">qed</span></span>
                          
                              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>›</span></span> 
                                         sat_not_marked<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
                            <span class="keyword1"><span class="command">qed</span></span>
                          <span class="keyword1"><span class="command">next</span></span>
                            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">(</span><span class="skolem">res1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span><span class="main">)</span>"</span></span>
                            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span> 
                                  <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="skolem">bes2'</span>›</span></span>
                                  <span class="quoted"><span class="quoted">‹<span class="skolem">bes2'</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span>
                            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                          <span class="keyword1"><span class="command">qed</span></span>
                   
                   <span class="keyword1"><span class="command">next</span></span>
                     <span class="comment1">(* If be is not represented in the out-going edges of rv'', then we show that 
                        [be] is a suitable black suffix, res1' being known to be a suitable red 
                         prefix. *)</span>
                     <span class="keyword3"><span class="command">assume</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">∉</span> ui_edge <span class="main">`</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
                     <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
               
                          <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                          
                            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span>
                                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span> 
                                       <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="skolem">bes2'</span>›</span></span>
                                       <span class="quoted"><span class="quoted">‹<span class="skolem">bes2'</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> 
                                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                          
                          <span class="keyword1"><span class="command">next</span></span>
                          
                            <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
                            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                          
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv''</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv''</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>›</span></span><span class="main">)</span>
                          
                            <span class="keyword1"><span class="command">next</span></span>
                          
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1'</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1'</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span><span class="main">)</span>
                          
                            <span class="comment1">(*next
                          
                              show "¬ marked prb' rv''" by (rule `¬ marked prb' rv''`)*)</span>
                          
                            <span class="keyword1"><span class="command">next</span></span>
                          
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                                   <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                                   <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rv''</span><span class="main">)</span> 
                                                                  <span class="main">(</span><span class="bound">res21</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                                <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv'''</span><span class="main">)</span>
                          
                                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="skolem"><span class="skolem">res21'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">be</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span>
                                                      <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>"</span></span>
                                     <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                                
                                <span class="keyword1"><span class="command">moreover</span></span>
                                <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span>"</span></span>
                                      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv''</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>›</span></span> RB'
                                      <span class="keyword1"><span class="command">unfolding</span></span> subsumees_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def 
                                                                                    rb_sp_Cons<span class="main">)</span>
                                  
                                <span class="keyword1"><span class="command">ultimately</span></span>
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                              <span class="keyword1"><span class="command">qed</span></span>
                          
                            <span class="keyword1"><span class="command">next</span></span>
                          
                              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv''</span><span class="main">)</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span>
                                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span><span class="main">(</span>ui_es <span class="skolem">res1'</span><span class="main">@</span><span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bl</span>›</span></span> 
                                         <span class="quoted"><span class="quoted">‹fst <span class="skolem">rv''</span> <span class="main">=</span> src <span class="skolem">be</span>›</span></span> 
                                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one Graph.sp_one<span class="main">)</span>
                          
                            <span class="keyword1"><span class="command">qed</span></span>
                          <span class="keyword1"><span class="command">qed</span></span>
                   <span class="keyword1"><span class="command">qed</span></span>
               
                 <span class="keyword1"><span class="command">next</span></span>
                   <span class="comment1">(* Suppose that bes2' is not empty. Then appending be at the end of bes2' gives a 
                      suitable black suffix, qed. *)</span>
                   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
               
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">be'</span></span> <span class="skolem"><span class="skolem">bes2''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span> <span class="main">=</span> <span class="skolem">be'</span> <span class="main">#</span> <span class="skolem">bes2''</span>"</span></span>
                        <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
               
                   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                        <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span><span class="main">@</span><span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                        
                          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="skolem">bes2'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>"</span></span>
                          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span> 
                                <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="skolem">bes2'</span>›</span></span>
                          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                        
                        <span class="keyword1"><span class="command">next</span></span>
                        
                          <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
                              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                              
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">rv''</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹ <span class="skolem">rv''</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>›</span></span><span class="main">)</span>
                              
                              <span class="keyword1"><span class="command">next</span></span>
                              
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1'</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                                     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1'</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span><span class="main">)</span>
                              
                              <span class="keyword1"><span class="command">next</span></span>
                              
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                                     <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                                     <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rv''</span><span class="main">)</span> 
                                                                    <span class="main">(</span><span class="bound">res21</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                                  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv'''</span><span class="main">)</span>
                              
                                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="skolem"><span class="skolem">res21'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>"</span></span>
                                                        <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="skolem">be'</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>"</span></span>
                                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2'</span> <span class="main">=</span> <span class="skolem">be'</span> <span class="main">#</span> <span class="skolem">bes2''</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                              
                                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2'</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                                             <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                                             <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rv''</span><span class="main">)</span> 
                                                                             <span class="main">(</span><span class="bound">res21</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>›</span></span>
                                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main">)</span>
                                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                                       <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                                         <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2'</span> <span class="main">=</span> ui_es <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bes2''</span>"</span></span>
                                              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>›</span></span> 
                                                    <span class="quoted"><span class="quoted">‹<span class="skolem">bes2'</span> <span class="main">=</span> <span class="skolem">be'</span> <span class="main">#</span> <span class="skolem">bes2''</span>›</span></span>
                                                    <span class="quoted"><span class="quoted">‹<span class="skolem">be'</span> <span class="main">=</span> ui_edge <span class="skolem">re</span>›</span></span>
                                              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                       <span class="keyword1"><span class="command">next</span></span>
                                         <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                       <span class="keyword1"><span class="command">next</span></span>
                                         <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                                              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv''</span> <span class="skolem">res21</span> <span class="skolem">rv'''</span><span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> 
                                                    <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span>
                                              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_Cons Nil_sp vertices_def<span class="main">)</span>
                                       <span class="keyword1"><span class="command">qed</span></span>
                                <span class="keyword1"><span class="command">qed</span></span>
                              
                              <span class="keyword1"><span class="command">next</span></span>
                              
                                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bes2'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span>"</span></span>
                                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> 
                                                      <span class="main">(</span>ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="skolem">bes2'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span>"</span></span>
                                  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                                    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span> 
                                                        <span class="main">(</span>ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span>"</span></span>
                                         <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> 
                                                                             <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv</span><span class="main">)</span> 
                                                                             <span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span>›</span></span>
                                               <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span>›</span></span>
                                         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append Graph.sp_one<span class="main">)</span>
                              
                                    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res1'</span><span class="main">@</span><span class="skolem">bes2'</span>›</span></span> 
                                                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                                  <span class="keyword1"><span class="command">qed</span></span>
                              
                                  <span class="keyword1"><span class="command">moreover</span></span>
                                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span><span class="main">(</span>fst <span class="skolem">rv</span><span class="main">)</span><span class="main">(</span>ui_es <span class="skolem">res1'</span> <span class="main">@</span> <span class="skolem">bes2'</span><span class="main">)</span> <span class="skolem">bl'</span>"</span></span>
                                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv''</span><span class="main">)</span> <span class="skolem">bes2'</span> <span class="skolem">bl'</span>›</span></span>
                                             red_sp_imp_black_sp<span class="main">[</span><span class="operator">OF</span> RB' 
                                                                   <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span><span class="main">(</span><span class="skolem">rv</span><span class="main">)</span><span class="main">(</span><span class="skolem">res1'</span><span class="main">)</span> 
                                                                            <span class="main">(</span><span class="skolem">rv''</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span><span class="main">]</span>
                                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append<span class="main">)</span>
                                  
                                  <span class="keyword1"><span class="command">ultimately</span></span>
                                       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"src <span class="skolem">be</span> <span class="main">=</span> <span class="skolem">bl'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sp_same_src_imp_same_tgt<span class="main">)</span>
                              
                                  <span class="keyword1"><span class="command">moreover</span></span>
                                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>src <span class="skolem">be</span><span class="main">)</span> <span class="main">[</span><span class="skolem">be</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">be</span><span class="main">)</span>"</span></span> 
                                       <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> 
                                             <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bes2</span><span class="main">@</span><span class="main">[</span><span class="skolem">be</span><span class="main">]</span><span class="main">)</span> <span class="skolem">bl</span>›</span></span> 
                                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one Graph.sp_one<span class="main">)</span>
                              
                                  <span class="keyword1"><span class="command">ultimately</span></span>
                                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                                       <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Graph.subpath <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv''</span><span class="main">)</span> <span class="skolem">bes2'</span> <span class="skolem">bl'</span>›</span></span>
                                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_append_one Graph.sp_one<span class="main">)</span>
                                <span class="keyword1"><span class="command">qed</span></span>
                              <span class="keyword1"><span class="command">qed</span></span>
                        <span class="keyword1"><span class="command">qed</span></span>
                 <span class="keyword1"><span class="command">qed</span></span>
               <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
          
      <span class="keyword1"><span class="command">next</span></span>
        <span class="comment1">(* Suppose that rv' is not the newly subsumed red vertex. Hence, rv' is still not marked 
           and in the fringe and res1 is still maximal, which makes res1 and bes2 suitable red 
           prefix and black suffix in the new red part. *)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv'</span> <span class="main">≠</span> subsumee <span class="skolem">sub</span>"</span></span>
        
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
             <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
             <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
               <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>›</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command">next</span></span>
             
               <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
               <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv'</span><span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> subsumE_fringe<span class="main">[</span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> B <span class="quoted"><span class="quoted">‹<span class="skolem">rv'</span> <span class="main">≠</span> subsumee <span class="skolem">sub</span>›</span></span> 
                 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
               <span class="keyword1"><span class="command">next</span></span>
                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv</span> <span class="skolem">res1</span> <span class="skolem">rv'</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> sp_in_extends<span class="main">)</span>
               <span class="comment1">(*next
                 show "¬ marked prb' rv'" using subsum_step(3) D by auto*)</span>
               <span class="keyword1"><span class="command">next</span></span>
                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                      <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                      <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv'</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main">)</span>
                   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res21</span> <span class="skolem">bes22</span> <span class="skolem">rv''</span>
             
                   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span>
                   <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                   <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv'</span> <span class="skolem">res21</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
             
                   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="skolem"><span class="skolem">res21'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>"</span></span> 
                   <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
             
                   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv'</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
                   <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> uses_sub <span class="skolem">rv'</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">(</span>tgt <span class="skolem">re</span><span class="main">)</span> <span class="skolem">sub</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv'</span> <span class="main">≠</span> subsumee <span class="skolem">sub</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             
                     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                     <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span>
                         <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv'</span> <span class="skolem">res21</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span>
                         wf_sub_rel_of.sp_in_extends_not_using_sub
                         <span class="main">[</span><span class="operator">OF</span> subs_wf_sub_rel_of<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
                          <span class="operator">of</span> <span class="quoted"><span class="quoted">"subsumee <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="quoted">"subsumer <span class="skolem">sub</span>"</span></span> <span class="quoted"><span class="quoted">"subs <span class="skolem">prb'</span>"</span></span> <span class="quoted"><span class="skolem">rv'</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                         rb_sp_Cons<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv'</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="skolem">res21'</span></span> <span class="quoted"><span class="skolem">rv''</span></span><span class="main">]</span>
                         rb_sp_one<span class="main">[</span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv'</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                         subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">qed</span></span>
             
                   <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                   <span class="keyword1"><span class="command">using</span></span> E
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> notE<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ui_es <span class="skolem">res21'</span><span class="main">@</span><span class="skolem">bes22</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                     <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">@</span> ui_es <span class="skolem">res21'</span> <span class="main">@</span> <span class="skolem">bes22</span>"</span></span>
                     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="skolem">res21</span> <span class="main">@</span> <span class="skolem">bes22</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                   <span class="keyword1"><span class="command">next</span></span>
                     <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                   <span class="keyword1"><span class="command">next</span></span>
                     <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv'</span> <span class="main">[</span><span class="skolem">re</span><span class="main">]</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                     <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span>
                         <span class="quoted"><span class="quoted">‹<span class="skolem">rv'</span> <span class="main">≠</span> subsumee <span class="skolem">sub</span>›</span></span> <span class="quoted"><span class="quoted">‹subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv'</span> <span class="skolem">res21</span> <span class="skolem">rv''</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>›</span></span>
                         <span class="quoted"><span class="quoted">‹<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>›</span></span>
                         rb_sp_Cons<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv'</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="skolem">res21'</span></span> <span class="quoted"><span class="skolem">rv''</span></span><span class="main">]</span>
                         rb_sp_one<span class="main">[</span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">rv'</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="quoted">"tgt <span class="skolem">re</span>"</span></span><span class="main">]</span>
                         subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> subsum_step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> subs_sub_rel_of<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span>
                     <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                   <span class="keyword1"><span class="command">qed</span></span>
                 <span class="keyword1"><span class="command">qed</span></span>
               <span class="keyword1"><span class="command">next</span></span>
                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv'</span><span class="main">)</span> <span class="skolem">bes2</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> subsum_step<span class="main">(</span>3<span class="main">)</span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span> 

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abstract_step <span class="skolem">prb</span> <span class="skolem">rv2</span> <span class="skolem">c<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> RB' <span class="main">:</span> <span class="quoted"><span class="quoted">"RedBlack <span class="skolem">prb'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RedBlack.abstract_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> abstract_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_RedBlack <span class="skolem">prb</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> abstract_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subset_iff
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="comment1">(* Suppose that bes is a feasible subpath starting at the black vertex represented by the red 
         vertex rv1. We proceed depending on the fact that rv1 is the red vertex where the abstrac-
         tion  took place or not. We have to make this distinction to be able to use our IH, in the 
         case where rv1 ≠ rv2. *)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bes</span>
    
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>"</span></span>
      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb'</span> <span class="skolem">rv1</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv1</span>"</span></span><span class="main">)</span>
        <span class="comment1">(* If this is the case, then the only possible red prefix is the empty edge sequence. By 
           definition of the abstraction operator, we have that the empty sequence is indeed a 
           suitable red prefix and that bes is suitable black prefix. *)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv1</span>"</span></span>
    
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
             <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
               <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
               <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                     <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="main">[]</span> <span class="skolem">rv1</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>4<span class="main">)</span> rb_Nil_sp<span class="main">[</span><span class="operator">OF</span> RB'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
                      <span class="keyword1"><span class="command">next</span></span>
                        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb'</span> <span class="skolem">rv1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                      <span class="keyword1"><span class="command">next</span></span>
                        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">[]</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>›</span></span>
                              <span class="quoted"><span class="quoted">‹out_edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>›</span></span>
                        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bes</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> Graph.sp_Cons<span class="main">)</span>
                      <span class="keyword1"><span class="command">qed</span></span>
                
             <span class="keyword1"><span class="command">next</span></span>
               <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"out_edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
               
               <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
               <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span>  <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
               <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
             
                 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="main">[]</span> <span class="main">@</span> <span class="skolem">bes</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
             
               <span class="keyword1"><span class="command">next</span></span>
             
                 <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
             
                   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv1</span> <span class="main">∈</span> fringe <span class="skolem">prb'</span>"</span></span> 
                   <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv1</span>›</span></span> <span class="quoted"><span class="quoted">‹out_edges <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
                   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> fringe_def<span class="main">)</span>
             
                 <span class="keyword1"><span class="command">next</span></span>
             
                   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="main">[]</span> <span class="skolem">rv1</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span> 
                   <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv1</span>›</span></span> 
                         rb_Nil_sp<span class="main">[</span><span class="operator">OF</span> RedBlack.abstract_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> abstract_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
                   <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
             
                 <span class="comment1">(*next
             
                   show "¬ marked prb' rv1"  using abstract_step(3) `rv2 = rv1` by simp*)</span>
             
                 <span class="keyword1"><span class="command">next</span></span>
             
                   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                        <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                        <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main">)</span>
                     <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res21</span> <span class="skolem">rv3</span>
             
                     <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
                     <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res21</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb'</span><span class="main">)</span>"</span></span>
             
                     <span class="keyword1"><span class="command">moreover</span></span>
                     <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="skolem"><span class="skolem">res21'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res21</span> <span class="main">=</span> <span class="skolem">re</span> <span class="main">#</span> <span class="skolem">res21'</span>"</span></span> 
                          <span class="keyword1"><span class="command">unfolding</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
             
                     <span class="keyword1"><span class="command">ultimately</span></span>
                     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">∈</span> out_edges <span class="main">(</span>red <span class="skolem">prb'</span><span class="main">)</span> <span class="skolem">rv1</span>"</span></span>
                     <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv1</span>›</span></span>
                           rb_sp_Cons<span class="main">[</span><span class="operator">OF</span> RedBlack.abstract_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> abstract_step<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> 
                                      <span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span> <span class="quoted"><span class="skolem">re</span></span> <span class="quoted"><span class="skolem">res21'</span></span> <span class="quoted"><span class="skolem">rv3</span></span><span class="main">]</span>
                     <span class="keyword1"><span class="command">unfolding</span></span> subsumees_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
             
                     <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rv2</span> <span class="main">=</span> <span class="skolem">rv1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command">qed</span></span>
             
                 <span class="keyword1"><span class="command">next</span></span>
             
                   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span> <span class="skolem">bes</span>"</span></span>
                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>›</span></span>
                   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
             
                 <span class="keyword1"><span class="command">qed</span></span>
               <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">qed</span></span>
             
      <span class="keyword1"><span class="command">next</span></span>
        <span class="comment1">(* Suppose that rv1 is not the red vertex where the abstraction took place. Then, as 
           abstracting a configuration has no effect on the rest of the red tree, we can show by IH 
           that bes is red-black supbeth of the old red-black graph. We conclude by case 
            distinction. *)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv2</span> <span class="main">≠</span> <span class="skolem">rv1</span>"</span></span>
    
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>confs <span class="skolem">prb</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>trace <span class="skolem">bes</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>3<span class="main">)</span> 
                    <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb</span> <span class="skolem">rv1</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span><span class="main">]</span> abstract_step<span class="main">(</span>3-7<span class="main">)</span>
                    <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> RedBlack_subpaths_from_def<span class="main">)</span>
             <span class="keyword1"><span class="command">unfolding</span></span> Un_iff image_def Bex_def mem_Collect_eq
             <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
             
               <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res</span> <span class="skolem">rv3</span>
             
               <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb</span> <span class="skolem">rv3</span>"</span></span>
             
               <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
               <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>3<span class="main">)</span>
               <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
               <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
                  <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
             <span class="keyword1"><span class="command">next</span></span>
             
               <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res1</span> <span class="skolem">bes2</span> <span class="skolem">rv3</span> <span class="skolem">bl</span>
               <span class="keyword3"><span class="command">assume</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>    B <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv3</span> <span class="main">∈</span> fringe <span class="skolem">prb</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>    C <span class="main">:</span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res1</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>    E <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                      <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                      <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv3</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span>    F <span class="main">:</span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv3</span><span class="main">)</span> <span class="skolem">bes2</span> <span class="skolem">bl</span>"</span></span>
             
               <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                    <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                      <span class="keyword1"><span class="command">using</span></span> abstract_step<span class="main">(</span>3<span class="main">)</span> B C E F <span class="keyword1"><span class="command">unfolding</span></span> fringe_def
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">qed</span></span>
             <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">(* Strengthening a configuration with an invariant will help refuse "brutal" abstractions. As 
     all abstractions preserves the set of feasible paths, we conclude. *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>strengthen_step <span class="skolem">prb</span> <span class="skolem">rv2</span> <span class="skolem">e</span> <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span><span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> subset_iff
       <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
     
         <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bes</span> 
         <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="skolem">prb'</span><span class="main">)</span> <span class="main">(</span>confs <span class="skolem">prb'</span> <span class="skolem">rv1</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv1</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb</span> <span class="skolem">rv1</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> strengthen_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rv1</span></span><span class="main">]</span> strengthen_step<span class="main">(</span>3-7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     
         <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">∈</span> RedBlack_subpaths_from <span class="skolem">prb'</span> <span class="skolem">rv1</span>"</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> RedBlack_subpaths_from_def<span class="main">)</span>
         <span class="keyword1"><span class="command">unfolding</span></span> Un_iff image_def Bex_def mem_Collect_eq
         <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE exE conjE<span class="main">)</span>
     
           <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res</span> <span class="skolem">rv2</span>
           <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res</span> <span class="skolem">rv2</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span>    <span class="quoted"><span class="quoted">"<span class="main">¬</span> marked <span class="skolem">prb</span> <span class="skolem">rv2</span>"</span></span>
           <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command">using</span></span> strengthen_step<span class="main">(</span>3<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff image_def Bex_def mem_Collect_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> disjI1<span class="main">)</span> <span class="operator">fastforce</span>
     
         <span class="keyword1"><span class="command">next</span></span>
     
           <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res1</span> <span class="skolem">bes2</span> <span class="skolem">rv3</span> <span class="skolem">bl</span>
     
           <span class="keyword3"><span class="command">assume</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span>    B <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rv3</span> <span class="main">∈</span> fringe <span class="skolem">prb</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span>    C <span class="main">:</span> <span class="quoted"><span class="quoted">"subpath <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv1</span> <span class="skolem">res1</span> <span class="skolem">rv3</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span>"</span></span>
           <span class="comment1">(*and    D : "¬ marked prb rv3"*)</span>
           <span class="keyword2"><span class="keyword">and</span></span>    E <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">res21</span> <span class="bound">bes22</span><span class="main">.</span> <span class="skolem">bes2</span> <span class="main">=</span> ui_es <span class="bound">res21</span> <span class="main">@</span> <span class="bound">bes22</span> 
                                  <span class="main">∧</span> <span class="bound">res21</span> <span class="main">≠</span> <span class="main">[]</span> 
                                  <span class="main">∧</span> subpath_from <span class="main">(</span>red <span class="skolem">prb</span><span class="main">)</span> <span class="skolem">rv3</span> <span class="bound">res21</span> <span class="main">(</span>subs <span class="skolem">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span>    F <span class="main">:</span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="skolem">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">rv3</span><span class="main">)</span> <span class="skolem">bes2</span> <span class="skolem">bl</span>"</span></span>
     
           <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command">unfolding</span></span> RedBlack_subpaths_from_def Un_iff mem_Collect_eq
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> disjI2<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">res1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bes2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">bes</span> <span class="main">=</span> ui_es <span class="skolem">res1</span> <span class="main">@</span> <span class="skolem">bes2</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> 2 
                  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                       <span class="keyword1"><span class="command">using</span></span> strengthen_step<span class="main">(</span>3<span class="main">)</span> B C E F <span class="keyword1"><span class="command">unfolding</span></span> fringe_def 
                       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">rv3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span>
     
         <span class="keyword1"><span class="command">qed</span></span>
       <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Red-black paths being red-black sub-path starting from the red root, and feasible paths 
being feasible sub-paths starting at the black initial location, it follows from the previous 
theorem that the set of feasible paths when considering the configuration of the root is a 
subset of the set of red-black paths.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_RedBlack<span class="main">)</span> feasible_path_inclusion <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"feasible_paths <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>confs <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> RedBlack_paths <span class="free">prb</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> feasible_subpaths_preserved<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span><span class="main">]</span> consistent_roots<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The configuration at the red root might have been abstracted. In this case, the initial 
configuration is subsumed by the current configuration at the root. Thus the set of feasible paths 
when considering the initial configuration is also a subset of the set of red-black paths.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_subsumed <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"init_conf <span class="free">prb</span> <span class="main">⊑</span> confs <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">prb</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsums_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> se_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> mark_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> subsum_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abstract_step <span class="skolem">prb</span> <span class="skolem">rv</span> <span class="skolem">c<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">prb'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> abstract_def subsums_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> strengthen_step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> finite_RedBlack<span class="main">)</span> feasible_path_inclusion_from_init <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"RedBlack <span class="free">prb</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"feasible_paths <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>init_conf <span class="free">prb</span><span class="main">)</span> <span class="main">⊆</span> RedBlack_paths <span class="free">prb</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subset_iff mem_Collect_eq
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">es</span> <span class="skolem">bl</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>init_conf <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> consistent_roots<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">∈</span> feasible_subpaths_from <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>confs <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst<span class="main">(</span>root<span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">bl'</span><span class="main">)</span>
       
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">bl'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Graph.subpath <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">es</span> <span class="skolem">bl'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite_labels <span class="main">(</span>trace <span class="skolem">es</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> finite_RedBlack <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="main">(</span>confs <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> finite_RedBlack finite_pred<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def finite_RedBlack_def<span class="main">)</span>
            
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pred <span class="main">(</span>init_conf <span class="free">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_init_pred<span class="main">)</span>
       
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>pred <span class="main">(</span>confs <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> finite_RedBlack finite_pred_constr_symvars<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
                 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> finite_RedBlack_def vertices_def<span class="main">)</span>
       
            <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span>pred <span class="main">(</span>init_conf <span class="free">prb</span><span class="main">)</span><span class="main">.</span> finite <span class="main">(</span>Bexp.vars <span class="bound">e</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_init_pred_symvars<span class="main">)</span>
       
            <span class="keyword1"><span class="command">moreover</span></span>
                 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"init_conf <span class="free">prb</span> <span class="main">⊑</span> confs <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> init_subsumed<span class="main">)</span>
       
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>confs <span class="free">prb</span> <span class="main">(</span>root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>trace <span class="skolem">es</span> <span class="main">(</span>labelling <span class="main">(</span>black <span class="free">prb</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                 <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsums_imp_feasible<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
       <span class="keyword1"><span class="command">using</span></span> feasible_subpaths_preserved<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"root <span class="main">(</span>red <span class="free">prb</span><span class="main">)</span>"</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span> <span class="main"><span class="main">:</span></span> vertices_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>