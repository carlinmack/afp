<div id="NDFS_SI_Statistics">
<div class="head">
<h1>Theory NDFS_SI_Statistics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> NDFS_SI_Statistics
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../CAVA_Base/CAVA_Base.html">CAVA_Base.CAVA_Base</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">code_module</span></span> NDFS_SI_Statistics <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">‹
    structure NDFS_SI_Statistics = struct
      val active = Unsynchronized.ref false
      val cur_limit = Unsynchronized.ref 1000000
      val blue_vis = Unsynchronized.ref 0
      val blue_match = Unsynchronized.ref 0
      val red_vis = Unsynchronized.ref 0
      val time = Unsynchronized.ref Time.zeroTime

      fun is_active () = !active
      fun vis_blue () = (
            if !cur_limit &lt; !blue_vis then (
              TextIO.print("*** " ^ IntInf.toString((!cur_limit) div 1000000) ^ "e+06 states\n");
              cur_limit := !cur_limit + 1000000)
            else ();
            blue_vis := !blue_vis + 1)
      fun match_blue () = blue_match := !blue_match + 1
      fun vis_red () = red_vis := !red_vis + 1

      fun start () = (active := true; time := Time.now ())
      fun stop () = (time := Time.- (Time.now (), !time))

      fun to_string () = let
        val t = Time.toReal (!time)
        val states_per_s = real (!blue_vis) / t
        val realStr = Real.fmt (StringCvt.FIX (SOME 2))

      in
        "Required time  : " ^ realStr t ^ "s\n"
      ^ "States per sec : " ^ realStr states_per_s ^ "\n"
      ^ "Blue states (v): " ^ IntInf.toString (!blue_vis) ^ "\n"
      ^ "Blue states (m): " ^ IntInf.toString (!blue_match) ^ "\n"
      ^ "Blue edges     : " ^ IntInf.toString (!blue_match + !blue_vis) ^ "\n"
      ^ "Red states     : " ^ IntInf.toString (!red_vis) ^ "\n"
      end
        
      val _ = Statistics.register_stat ("NDFS",is_active,to_string)
    end
›</span>
<span class="keyword1"><span class="command">code_reserved</span></span> SML NDFS_SI_Statistics

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">hd</span><span class="antiquote">}</span></span></span>›</span>

<span class="keyword1"><span class="command">consts</span></span> 
  vis_red <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> unit"</span></span>
  vis_blue <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> unit"</span></span>
  match_blue <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> unit"</span></span>
  start <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> unit"</span></span>
  stop <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> unit"</span></span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">vis_red</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"NDFS'_SI'_Statistics.vis'_red"</span>
<span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">vis_blue</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"NDFS'_SI'_Statistics.vis'_blue"</span>
<span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">match_blue</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"NDFS'_SI'_Statistics.match'_blue"</span>
<span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">start</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"NDFS'_SI'_Statistics.start"</span>
<span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">stop</span> <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> <span class="quoted">"NDFS'_SI'_Statistics.stop"</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>vis_red<span class="main">,</span>vis_red<span class="main">)</span> <span class="main">∈</span> unit_rel <span class="main">→</span> unit_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>vis_blue<span class="main">,</span>vis_blue<span class="main">)</span> <span class="main">∈</span> unit_rel <span class="main">→</span> unit_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>match_blue<span class="main">,</span>match_blue<span class="main">)</span> <span class="main">∈</span> unit_rel <span class="main">→</span> unit_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>start<span class="main">,</span>start<span class="main">)</span> <span class="main">∈</span> unit_rel <span class="main">→</span> unit_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>stop<span class="main">,</span>stop<span class="main">)</span> <span class="main">∈</span> unit_rel <span class="main">→</span> unit_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">vis_red_nres</span> <span class="main">≡</span> RETURN <span class="main">(</span>vis_red <span class="main">()</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">vis_blue_nres</span> <span class="main">≡</span> RETURN <span class="main">(</span>vis_blue <span class="main">()</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">match_blue_nres</span> <span class="main">≡</span> RETURN <span class="main">(</span>match_blue <span class="main">()</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">start_nres</span> <span class="main">≡</span> RETURN <span class="main">(</span>start <span class="main">()</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">stop_nres</span> <span class="main">≡</span> RETURN <span class="main">(</span>stop <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> vis_red vis_blue match_blue start stop
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> vis_red_nres vis_blue_nres match_blue_nres start_nres stop_nres

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">List.append</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML <span class="comment1">(* Verification that code-module did 
  not mess up something. *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="NDFS_SI">
<div class="head">
<h1>Theory NDFS_SI</h1>
</div>
<pre class="source"><span class="comment1">(**
  Author: Peter Lammich
  Inspired by Rene Neumann's DFS-Framework and Nested DFS formalization
**)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nested DFS using Standard Invariants Approach›</span></span>
<span class="keyword1"><span class="command">theory</span></span> NDFS_SI
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../CAVA_Automata/Automata_Impl.html">CAVA_Automata.Automata_Impl</a>
  <a href="../CAVA_Automata/Lasso.html">CAVA_Automata.Lasso</a>
  <a href="NDFS_SI_Statistics.html">NDFS_SI_Statistics</a>
  <a href="../CAVA_Base/CAVA_Code_Target.html">CAVA_Base.CAVA_Code_Target</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Implementation of a nested DFS algorithm for accepting cycle detection
  using the refinement framework. The algorithm uses the improvement of 
  Holzmann et al.~\cite{HPY97}, i.e., it reports a cycle if the inner 
  DFS finds a path back to 
  the stack of the outer DFS. Moreover, an early cycle detection optimization is
  implemented~\cite{SE05}, i.e., the outer DFS may already report a cycle on 
  a back-edge involving an accepting node.

  The algorithm returns a witness in case that an accepting cycle is detected.
  
  The design approach to this algorithm is to first establish invariants of a
  generic DFS-Algorithm, which are then used to instantiate the concrete
  nested DFS-algorithm for B\"uchi emptiness check. This formalization can be
  seen as a predecessor of the formalization of 
  Gabow's algorithm~\cite{La14_ITP}, where this technique has been
  further developed.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Tools for DFS Algorithms"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Invariants"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_dfs_pre</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>   <span class="comment1">― ‹Upper bound is closed under transitions›</span>
  <span class="main">∧</span> finite <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="comment1">― ‹Upper bound is finite›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>    <span class="comment1">― ‹Visited set below upper bound›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>   <span class="comment1">― ‹Start node in upper bound›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="comment1">― ‹Visited nodes closed under reachability, or on stack›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span><span class="main">∉</span><span class="free"><span class="bound"><span class="entity">V</span></span></span>     <span class="comment1">― ‹Start node not yet visited›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>    <span class="comment1">― ‹Stack is visited›</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u0</span></span></span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">∩</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">×</span>UNIV<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>u0›</span></span> reachable from stack, only over stack›</span>
  "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_dfs_var</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">≡</span> finite_psupset <span class="free"><span class="bound"><span class="entity">U</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_dfs_fe_inv</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">V0</span></span></span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">brk</span></span></span> <span class="main">≡</span> 
  <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">brk</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>  <span class="comment1">― ‹Visited set closed under reachability›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">u0</span></span></span><span class="main">}</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>     <span class="comment1">― ‹Successors of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>u0›</span></span> visited›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">V0</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>               <span class="comment1">― ‹Visited set increasing›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V0</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">-</span> UNIV<span class="main">×</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">u0</span></span></span><span class="main">}</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="comment1">― ‹All visited nodes reachable›</span>
"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_dfs_post</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">V0</span></span></span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">brk</span></span></span> <span class="main">≡</span> 
  <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">brk</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="comment1">― ‹Visited set closed under reachability›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>               <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>u0›</span></span> visited›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">V0</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>               <span class="comment1">― ‹Visited set increasing›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V0</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">-</span> UNIV<span class="main">×</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">u0</span></span></span><span class="main">}</span> <span class="comment1">― ‹All visited nodes reachable›</span>
"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_dfs_outer</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">V0</span></span></span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">brk</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">V0</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>      <span class="comment1">― ‹Start nodes below upper bound›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>  <span class="comment1">― ‹Upper bound is closed under transitions›</span>
  <span class="main">∧</span> finite <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="comment1">― ‹Upper bound is finite›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>    <span class="comment1">― ‹Visited set below upper bound›</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">brk</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>  <span class="comment1">― ‹Visited set closed under reachability›</span>
  <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V0</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="comment1">― ‹Start nodes already iterated over are visited›</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Invariant Preservation"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_outer_initial<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">V0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_outer <span class="free">E</span> <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">V0</span><span class="main">)</span> <span class="free">V0</span> <span class="free">V0</span> <span class="main">{}</span> <span class="free">brk</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_outer_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_ImageI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_pre_initial<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_outer <span class="free">E</span> <span class="free">U</span> <span class="free">V0</span> <span class="free">it</span> <span class="free">V</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v0</span><span class="main">∈</span><span class="free">U</span> <span class="main">-</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="main">{}</span> <span class="free">V</span> <span class="free">v0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_pre_def gen_dfs_outer_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> fin_U_imp_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>gen_dfs_var <span class="free">U</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_var_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_pre_imp_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>gen_dfs_var <span class="free">U</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_pre_def gen_dfs_var_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_pre_imp_fin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">E</span> <span class="main">``</span> <span class="main">{</span><span class="free">u0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">U</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_pre_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inserted <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u0›</span></span></span></span> on stack and to visited set›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_pre_imp_fe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> <span class="free">u0</span> 
    <span class="main">(</span><span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="free">u0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_pre_def gen_dfs_fe_inv_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_fe_inv_pres_visited<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> <span class="free">u0</span> <span class="free">it</span> <span class="free">V'</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">it</span><span class="main">⊆</span><span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="free">u0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> <span class="free">u0</span> <span class="main">(</span><span class="free">it</span><span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">V'</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_fe_inv_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_upper_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">E'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u0</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u0</span><span class="main">∈</span><span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">E'</span><span class="main">⊆</span><span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">``</span><span class="free">U</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span><span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_fe_inv_imp_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> <span class="free">u0</span> <span class="free">it</span> <span class="free">V'</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">it</span><span class="main">⊆</span><span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="free">u0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∉</span><span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">V'</span><span class="main">,</span><span class="free">V</span><span class="main">)</span> <span class="main">∈</span> gen_dfs_var <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_fe_inv_def gen_dfs_pre_def gen_dfs_var_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_psupset_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> gen_dfs_upper_aux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_fe_inv_imp_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> <span class="free">u0</span> <span class="free">it</span> <span class="free">V'</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">it</span><span class="main">⊆</span><span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="free">u0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∉</span><span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="free">V'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_fe_inv_def gen_dfs_pre_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> gen_dfs_upper_aux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">u0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ rtrancl_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">×</span> UNIV"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_post_imp_fe_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> <span class="free">u0</span> <span class="free">it</span> <span class="free">V'</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">it</span><span class="main">⊆</span><span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="free">u0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∉</span><span class="free">V'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="free">V'</span> <span class="free">t</span> <span class="free">V''</span> <span class="free">cyc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> <span class="free">u0</span> <span class="main">(</span><span class="free">it</span><span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span> <span class="free">V''</span> <span class="free">cyc</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_fe_inv_def gen_dfs_post_def gen_dfs_pre_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> order_trans<span class="main"><span class="main">[</span></span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"insert <span class="free">u0</span> <span class="main">(</span><span class="free">V</span> <span class="main">∪</span> <span class="main">(</span><span class="free">E</span> <span class="main">-</span> UNIV <span class="main">×</span> insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> 
        <span class="main">``</span> <span class="main">(</span><span class="free">E</span> <span class="main">``</span> <span class="main">{</span><span class="free">u0</span><span class="main">}</span> <span class="main">-</span> <span class="free">it</span> <span class="main">-</span> insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cyc</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_post_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u0</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">E</span> <span class="main">-</span> UNIV <span class="main">×</span> insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">⊆</span><span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∉</span><span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u0</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">E</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> 1 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u0</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">E</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">E</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2 rtrancl_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_fe_imp_post_brk<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> <span class="free">u0</span> <span class="free">it</span> <span class="free">V'</span> True"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">it</span><span class="main">⊆</span><span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="free">u0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span> <span class="free">V'</span> True"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_pre_def gen_dfs_fe_inv_def gen_dfs_post_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_post_aux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_fe_inv_imp_post<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> <span class="free">u0</span> <span class="main">{}</span> <span class="free">V'</span> <span class="free">cyc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">cyc</span><span class="main">⟶</span><span class="free">cyc'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span> <span class="free">V'</span> <span class="free">cyc'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_pre_def gen_dfs_fe_inv_def gen_dfs_post_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_post_aux<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_pre_imp_post_brk<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V</span> <span class="free">u0</span> <span class="main">(</span>insert <span class="free">u0</span> <span class="free">V</span><span class="main">)</span> True"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_pre_def gen_dfs_post_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Consequences of Postcondition"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_post_imp_reachable<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V0</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V0</span> <span class="free">u0</span> <span class="free">V</span> <span class="free">brk</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">V0</span> <span class="main">∪</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">u0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_post_def gen_dfs_pre_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ rtrancl_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_post_imp_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="main">{}</span> <span class="free">V0</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="main">{}</span> <span class="free">V0</span> <span class="free">u0</span> <span class="free">V</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V0</span> <span class="main">∪</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">u0</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_post_def gen_dfs_pre_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Image_closed_trancl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_post_imp_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="main">{}</span> <span class="free">V0</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="main">{}</span> <span class="free">V0</span> <span class="free">u0</span> <span class="free">V</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">V0</span> <span class="main">∪</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">u0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gen_dfs_post_imp_reachable<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> gen_dfs_post_imp_complete<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_post_imp_below_U<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V0</span> <span class="free">u0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="free">S</span> <span class="free">V0</span> <span class="free">u0</span> <span class="free">V</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_pre_def gen_dfs_post_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ rtrancl_mono<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Image_closed_trancl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_post_imp_outer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_outer <span class="free">E</span> <span class="free">U</span> <span class="free">V0</span> <span class="free">it</span> <span class="free">Vis0</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="main">{}</span> <span class="free">Vis0</span> <span class="free">v0</span> <span class="free">Vis</span> False"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v0</span> <span class="main">∈</span> <span class="free">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">it</span> <span class="main">⊆</span> <span class="free">V0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v0</span> <span class="main">∉</span> <span class="free">Vis0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_outer <span class="free">E</span> <span class="free">U</span> <span class="free">V0</span> <span class="main">(</span><span class="free">it</span> <span class="main">-</span> <span class="main">{</span><span class="free">v0</span><span class="main">}</span><span class="main">)</span> <span class="free">Vis</span> False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">v0</span> <span class="main">∈</span> <span class="free">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">it</span> <span class="main">⊆</span> <span class="free">V0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">V0</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">``</span> <span class="free">U</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">v0</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> empty_subsetI insert_subset rtrancl_reachable_induct subset_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> AUX<span class="main">=</span>this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_outer_def gen_dfs_post_def
    <span class="keyword1"><span class="command">using</span></span> AUX
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_dfs_outer_already_vis<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v0</span> <span class="main">∈</span> <span class="free">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">it</span> <span class="main">⊆</span> <span class="free">V0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v0</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen_dfs_outer <span class="free">E</span> <span class="free">U</span> <span class="free">V0</span> <span class="free">it</span> <span class="free">V</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen_dfs_outer <span class="free">E</span> <span class="free">U</span> <span class="free">V0</span> <span class="main">(</span><span class="free">it</span> <span class="main">-</span> <span class="main">{</span><span class="free">v0</span><span class="main">}</span><span class="main">)</span> <span class="free">V</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_outer_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Abstract Algorithm"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Inner (red) DFS›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A witness of the red algorithm is a node on the stack and a path
  to this node›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'v</span> red_witness <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> list <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> option"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prepend node to red witness›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">prep_wit_red</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> red_witness <span class="main">⇒</span> <span class="tfree">'v</span> red_witness"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prep_wit_red</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> None <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prep_wit_red</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Initial witness for node <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> with onstack successor <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> 
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">red_init_witness</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> red_witness"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">red_init_witness</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">]</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">red_dfs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">red_dfs</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">onstack</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">V</span><span class="main">=</span>insert <span class="bound">u</span> <span class="bound">V</span><span class="main">;</span>
      NDFS_SI_Statistics.vis_red_nres<span class="main">;</span>

      <span class="comment1">― ‹Check whether we have a successor on stack›</span>
      <span class="bound">brk</span> <span class="main">←</span> <span class="keyword1">FOREACH<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="main">{</span><span class="bound">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">brk</span><span class="main">.</span> <span class="bound">brk</span><span class="main">=</span>None<span class="main">)</span> 
        <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> 
          <span class="keyword1">if</span> <span class="bound">t</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">onstack</span></span></span> <span class="keyword1">then</span> 
            RETURN <span class="main">(</span>red_init_witness <span class="bound">u</span> <span class="bound">t</span><span class="main">)</span> 
          <span class="keyword1">else</span> 
          RETURN None
        <span class="main">)</span>
        None<span class="main">;</span>

      <span class="comment1">― ‹Recurse for successors›</span>
      <span class="keyword1">case</span> <span class="bound">brk</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span>
          <span class="keyword1">FOREACH<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="main">{</span><span class="bound">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">brk</span><span class="main">)</span><span class="main">.</span> <span class="bound">brk</span><span class="main">=</span>None<span class="main">)</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> 
              <span class="keyword1">if</span> <span class="bound">t</span><span class="main">∉</span><span class="bound">V</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">brk</span><span class="main">)</span> <span class="main">←</span> <span class="bound">D</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">;</span>
                RETURN <span class="main">(</span><span class="bound">V</span><span class="main">,</span>prep_wit_red <span class="bound">u</span> <span class="bound">brk</span><span class="main">)</span>
              <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">V</span><span class="main">,</span>None<span class="main">)</span><span class="main">)</span>
            <span class="main">(</span><span class="bound">V</span><span class="main">,</span>None<span class="main">)</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RETURN <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">brk</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>
  "</span></span>


<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'v</span> blue_witness <span class="main">=</span> 
  NO_CYC                    <span class="comment1">― ‹No cycle detected›</span>
<span class="main">|</span> REACH <span class="quoted"><span class="quoted">"<span class="tfree">'v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> list"</span></span>      <span class="comment1">― ‹Path from current start node to node on 
  stack, path contains accepting node.›</span>
<span class="comment1">(* REACH u p: u is on stack, p is non-empty path from u0 to u, a node 
  in u or p is accepting *)</span>
<span class="main">|</span> CIRC <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> list"</span></span>  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"CIRI pr pl"</span><span class="antiquote">}</span></span>: Lasso found from 
  current start node.›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prepend node to witness›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">prep_wit_blue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> blue_witness <span class="main">⇒</span> <span class="tfree">'v</span> blue_witness"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prep_wit_blue</span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> NO_CYC <span class="main">=</span> NO_CYC"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prep_wit_blue</span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> <span class="main">(</span>REACH <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span>
    CIRC <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u0</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span>
    REACH <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u0</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prep_wit_blue</span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> <span class="main">(</span>CIRC <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="free"><span class="bound"><span class="entity">pl</span></span></span><span class="main">)</span> <span class="main">=</span> CIRC <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u0</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">pr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">pl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initialize blue witness›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">init_wit_blue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> red_witness <span class="main">⇒</span> <span class="tfree">'v</span> blue_witness"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_wit_blue</span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> None <span class="main">=</span> NO_CYC"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">init_wit_blue</span> <span class="free"><span class="bound"><span class="entity">u0</span></span></span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">u0</span></span></span> <span class="keyword1">then</span>
    CIRC <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
  <span class="keyword1">else</span> REACH <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_wit_blue_early</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> blue_witness"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_wit_blue_early</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> CIRC <span class="main">[]</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span> <span class="keyword1">else</span> REACH <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extract result from witness›</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">lasso_ext</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">extract_res</span> <span class="free"><span class="bound"><span class="entity">cyc</span></span></span> 
  <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cyc</span></span></span> <span class="keyword1">of</span> 
      CIRC <span class="bound">pr</span> <span class="bound">pl</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">pr</span><span class="main">,</span><span class="bound">pl</span><span class="main">)</span>
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Outer (Blue) DFS›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">blue_dfs</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> b_graph_rec_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> option nres"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blue_dfs</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    NDFS_SI_Statistics.start_nres<span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span> <span class="main">←</span> FOREACHc <span class="main">(</span>g_V0 <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> <span class="bound">cyc</span><span class="main">=</span>NO_CYC<span class="main">)</span> 
      <span class="main">(</span><span class="main">λ</span><span class="bound">v0</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="keyword1">if</span> <span class="bound">v0</span> <span class="main">∉</span> <span class="bound">blues</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span> <span class="main">←</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
            <span class="keyword1">let</span> <span class="bound">blues</span><span class="main">=</span>insert <span class="bound">s</span> <span class="bound">blues</span><span class="main">;</span>
            <span class="keyword1">let</span> <span class="bound">onstack</span><span class="main">=</span>insert <span class="bound">s</span> <span class="bound">onstack</span><span class="main">;</span>
            <span class="keyword1">let</span> <span class="bound">s_acc</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∈</span> bg_F <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">;</span>
            NDFS_SI_Statistics.vis_blue_nres<span class="main">;</span>
            <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span> <span class="main">←</span> 
            <span class="keyword1">FOREACH<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="main">(</span>g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">``</span><span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> <span class="bound">cyc</span><span class="main">=</span>NO_CYC<span class="main">)</span> 
              <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> 
                <span class="keyword1">if</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">onstack</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s_acc</span> <span class="main">∨</span> <span class="bound">t</span> <span class="main">∈</span> bg_F <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>
                  RETURN <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span> init_wit_blue_early <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span>
                <span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">t</span><span class="main">∉</span><span class="bound">blues</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                  <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span> <span class="main">←</span> <span class="bound">D</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">;</span>
                  RETURN <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="main">(</span>prep_wit_blue <span class="bound">s</span> <span class="bound">cyc</span><span class="main">)</span><span class="main">)</span>
                <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
                  NDFS_SI_Statistics.match_blue_nres<span class="main">;</span>
                  RETURN <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span>
                <span class="main">}</span><span class="main">)</span>
              <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span>NO_CYC<span class="main">)</span><span class="main">;</span>

            <span class="main">(</span><span class="bound">reds</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span> <span class="main">←</span> 
            <span class="keyword1">if</span> <span class="bound">cyc</span><span class="main">=</span>NO_CYC <span class="main">∧</span> <span class="bound">s_acc</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
              <span class="main">(</span><span class="bound">reds</span><span class="main">,</span><span class="bound">rcyc</span><span class="main">)</span> <span class="main">←</span> red_dfs <span class="main">(</span>g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="bound">onstack</span> <span class="bound">reds</span> <span class="bound">s</span><span class="main">;</span>
              RETURN <span class="main">(</span><span class="bound">reds</span><span class="main">,</span> init_wit_blue <span class="bound">s</span> <span class="bound">rcyc</span><span class="main">)</span>
            <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">reds</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">;</span>

            <span class="keyword1">let</span> <span class="bound">onstack</span><span class="main">=</span><span class="bound">onstack</span> <span class="main">-</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">;</span>
            RETURN <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span>
          <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span><span class="bound">blues</span><span class="main">,</span> <span class="bound">reds</span><span class="main">,</span> <span class="bound">cyc</span><span class="main">)</span>
        <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
          RETURN <span class="main">(</span><span class="bound">blues</span><span class="main">,</span> <span class="bound">reds</span><span class="main">,</span> NO_CYC<span class="main">)</span>
        <span class="main">}</span>
      <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span>NO_CYC<span class="main">)</span><span class="main">;</span>
    NDFS_SI_Statistics.stop_nres<span class="main">;</span>
    RETURN <span class="main">(</span>extract_res <span class="bound">cyc</span><span class="main">)</span>
  <span class="main">}</span>
  "</span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">blue_dfs_fe</span> <span class="keyword2"><span class="keyword">uses</span></span> blue_dfs_def 
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"blue_dfs <span class="free">G</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    NDFS_SI_Statistics.start_nres<span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span> <span class="main">←</span> <span class="var">?FE</span><span class="main">;</span>
    NDFS_SI_Statistics.stop_nres<span class="main">;</span>
    RETURN <span class="main">(</span>extract_res <span class="bound">cyc</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">blue_dfs_body</span> <span class="keyword2"><span class="keyword">uses</span></span> blue_dfs_fe_def
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≡</span> FOREACHc <span class="main">(</span>g_V0 <span class="free">G</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> <span class="bound">cyc</span><span class="main">=</span>NO_CYC<span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">v0</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">if</span> <span class="bound">v0</span><span class="main">∉</span><span class="bound">blues</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span> <span class="main">←</span> <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="var">?B</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span><span class="bound">v0</span><span class="main">)</span><span class="main">;</span>
        RETURN <span class="main">(</span><span class="bound">blues</span><span class="main">,</span> <span class="bound">reds</span><span class="main">,</span> <span class="bound">cyc</span><span class="main">)</span>
      <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>RETURN <span class="main">(</span><span class="bound">blues</span><span class="main">,</span> <span class="bound">reds</span><span class="main">,</span> NO_CYC<span class="main">)</span><span class="main">}</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span><span class="main">{}</span><span class="main">,</span>NO_CYC<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">thm</span></span> blue_dfs_body_def

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Correctness"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional invariant to be maintained between calls of red dfs›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">red_dfs_inv</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">reds</span></span></span> <span class="free"><span class="bound"><span class="entity">onstack</span></span></span> <span class="main">≡</span> 
  <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>           <span class="comment1">― ‹Upper bound is closed under transitions›</span>
  <span class="main">∧</span> finite <span class="free"><span class="bound"><span class="entity">U</span></span></span>         <span class="comment1">― ‹Upper bound is finite›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">reds</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span>         <span class="comment1">― ‹Red set below upper bound›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="free"><span class="bound"><span class="entity">reds</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">reds</span></span></span>   <span class="comment1">― ‹Red nodes closed under reachability›</span>
  <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="free"><span class="bound"><span class="entity">reds</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">onstack</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="comment1">― ‹No red node with edge to stack›</span>
"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> red_dfs_inv_initial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">V0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"red_dfs_inv <span class="free">E</span> <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">V0</span><span class="main">)</span> <span class="main">{}</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> red_dfs_inv_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_ImageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the red DFS.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> red_dfs_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v0</span> <span class="free">u0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'v</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PRE<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"red_dfs_inv <span class="free">E</span> <span class="free">U</span> <span class="free">reds</span> <span class="free">onstack</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u0</span><span class="main">∈</span><span class="free">U</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u0</span><span class="main">∉</span><span class="free">reds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"red_dfs <span class="free">E</span> <span class="free">onstack</span> <span class="free">reds</span> <span class="free">u0</span> 
    <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">reds'</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">cyc</span> <span class="keyword1">of</span>
      Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">∈</span><span class="free">onstack</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> path <span class="free">E</span> <span class="free">u0</span> <span class="bound">p</span> <span class="bound">v</span>
    <span class="main">|</span> None <span class="main">⇒</span> 
        red_dfs_inv <span class="free">E</span> <span class="free">U</span> <span class="bound">reds'</span> <span class="free">onstack</span> 
        <span class="main">∧</span> <span class="free">u0</span><span class="main">∈</span><span class="bound">reds'</span> 
        <span class="main">∧</span> <span class="bound">reds'</span> <span class="main">⊆</span> <span class="free">reds</span> <span class="main">∪</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">u0</span><span class="main">}</span>
  <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dfs_red</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"
    <span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">D</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="keyword1">let</span> <span class="bound">V</span><span class="main">=</span>insert <span class="bound">u</span> <span class="bound">V</span><span class="main">;</span>
      NDFS_SI_Statistics.vis_red_nres<span class="main">;</span>

      <span class="comment1">― ‹Check whether we have a successor on stack›</span>
      <span class="bound">brk</span> <span class="main">←</span> <span class="keyword1">FOREACH<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="bound">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">brk</span><span class="main">.</span> <span class="bound">brk</span><span class="main">=</span>None<span class="main">)</span> 
        <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">t</span><span class="main">∈</span><span class="free">onstack</span> <span class="keyword1">then</span> 
            RETURN <span class="main">(</span>red_init_witness <span class="bound">u</span> <span class="bound">t</span><span class="main">)</span> 
          <span class="keyword1">else</span> RETURN None<span class="main">)</span> 
        None<span class="main">;</span>

      <span class="comment1">― ‹Recurse for successors›</span>
      <span class="keyword1">case</span> <span class="bound">brk</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span>
          <span class="keyword1">FOREACH<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="bound">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">brk</span><span class="main">)</span><span class="main">.</span> <span class="bound">brk</span><span class="main">=</span>None<span class="main">)</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> 
              <span class="keyword1">if</span> <span class="bound">t</span><span class="main">∉</span><span class="bound">V</span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
                <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">brk</span><span class="main">)</span> <span class="main">←</span> <span class="bound">D</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span><span class="main">;</span>
                RETURN <span class="main">(</span><span class="bound">V</span><span class="main">,</span>prep_wit_red <span class="bound">u</span> <span class="bound">brk</span><span class="main">)</span>
              <span class="main">}</span> <span class="keyword1">else</span> RETURN <span class="main">(</span><span class="bound">V</span><span class="main">,</span>None<span class="main">)</span><span class="main">)</span>
            <span class="main">(</span><span class="bound">V</span><span class="main">,</span>None<span class="main">)</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RETURN <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">brk</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span><span class="main">,</span><span class="free">u</span><span class="main">)</span>
"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="var">?body</span> <span class="var">?init</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?dfs_red</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">S</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">u0</span><span class="main">)</span><span class="main">.</span> gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="bound">S</span> <span class="bound">V</span> <span class="bound">u0</span> <span class="main">∧</span> <span class="free">E</span><span class="main">``</span><span class="bound">V</span> <span class="main">∩</span> <span class="free">onstack</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">post</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">post</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">S</span> <span class="main">(</span><span class="bound">V0</span><span class="main">,</span><span class="bound">u0</span><span class="main">)</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="bound">S</span> <span class="bound">V0</span> <span class="bound">u0</span> <span class="bound">V</span> <span class="main">(</span><span class="bound">cyc</span><span class="main">≠</span>None<span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">cyc</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">E</span><span class="main">``</span><span class="bound">V</span> <span class="main">∩</span> <span class="free">onstack</span> <span class="main">=</span> <span class="main">{}</span>
      <span class="main">|</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">∈</span><span class="free">onstack</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> path <span class="free">E</span> <span class="bound">u0</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
    "</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fe_inv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">S</span> <span class="bound">V0</span> <span class="bound">u0</span> <span class="bound">it</span> <span class="main">(</span><span class="bound">V</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> 
    gen_dfs_fe_inv <span class="free">E</span> <span class="free">U</span> <span class="bound">S</span> <span class="bound">V0</span> <span class="bound">u0</span> <span class="bound">it</span> <span class="bound">V</span> <span class="main">(</span><span class="bound">cyc</span><span class="main">≠</span>None<span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">cyc</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">E</span><span class="main">``</span><span class="bound">V</span> <span class="main">∩</span> <span class="free">onstack</span> <span class="main">=</span> <span class="main">{}</span>
      <span class="main">|</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">∈</span><span class="free">onstack</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> path <span class="free">E</span> <span class="bound">u0</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
    "</span></span>


  <span class="keyword1"><span class="command">from</span></span> PRE <span class="keyword1"><span class="command">have</span></span> GENPRE<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_dfs_pre <span class="free">E</span> <span class="free">U</span> <span class="main">{}</span> <span class="free">reds</span> <span class="free">u0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> red_dfs_inv_def gen_dfs_pre_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> PRE <span class="keyword1"><span class="command">have</span></span> PRE'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">{}</span> <span class="main">(</span><span class="free">reds</span><span class="main">,</span><span class="free">u0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pre_def red_dfs_inv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> IMP_POST<span class="main">:</span> <span class="quoted"><span class="quoted">"SPEC <span class="main">(</span><span class="skolem">post</span> <span class="main">{}</span> <span class="main">(</span><span class="free">reds</span><span class="main">,</span><span class="free">u0</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">reds'</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">cyc</span> <span class="keyword1">of</span>
      Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">∈</span><span class="free">onstack</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> path <span class="free">E</span> <span class="free">u0</span> <span class="bound">p</span> <span class="bound">v</span>
    <span class="main">|</span> None <span class="main">⇒</span> 
        red_dfs_inv <span class="free">E</span> <span class="free">U</span> <span class="bound">reds'</span> <span class="free">onstack</span> 
        <span class="main">∧</span> <span class="free">u0</span><span class="main">∈</span><span class="bound">reds'</span> 
        <span class="main">∧</span> <span class="bound">reds'</span> <span class="main">⊆</span> <span class="free">reds</span> <span class="main">∪</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">u0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> impI conjI allI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">reds'</span> <span class="skolem">p</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">post</span> <span class="main">{}</span> <span class="main">(</span><span class="free">reds</span><span class="main">,</span><span class="free">u0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">reds'</span><span class="main">,</span>Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">onstack</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u0</span> <span class="skolem">p</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> post_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">reds'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">post</span> <span class="main">{}</span> <span class="main">(</span><span class="free">reds</span><span class="main">,</span> <span class="free">u0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">reds'</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> GPOST<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="free">E</span> <span class="free">U</span> <span class="main">{}</span> <span class="free">reds</span> <span class="free">u0</span> <span class="skolem">reds'</span> False"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> NS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">``</span><span class="skolem">reds'</span> <span class="main">∩</span> <span class="free">onstack</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> post_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> GPOST <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u0</span><span class="main">∈</span><span class="skolem">reds'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_post_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"red_dfs_inv <span class="free">E</span> <span class="free">U</span> <span class="skolem">reds'</span> <span class="free">onstack</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> red_dfs_inv_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> GENPRE<span class="main">[</span><span class="operator">unfolded</span> gen_dfs_pre_def<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gen_dfs_post_imp_below_U<span class="main"><span class="main">[</span></span><span class="operator">OF</span> GENPRE GPOST<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> GPOST<span class="main">[</span><span class="operator">unfolded</span> gen_dfs_post_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">from</span></span> GPOST <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">reds'</span> <span class="main">⊆</span> <span class="free">reds</span> <span class="main">∪</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="free">u0</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_post_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">S</span>
    <span class="keyword3"><span class="command">assume</span></span> INV0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="skolem">S</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="var">?body</span> <span class="skolem">σ</span>
      <span class="main">≤</span> SPEC <span class="main">(</span><span class="skolem">post</span> <span class="skolem">S</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RECT_rule_arb<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
        pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">pre</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span>
        V<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"gen_dfs_var <span class="free">U</span> <span class="keyword1">&lt;*lex*&gt;</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span>
        arb<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">S</span>"</span></span>
        <span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_mono</span>

      <span class="keyword1"><span class="command">using</span></span> INV0<span class="main">[</span><span class="operator">unfolded</span> pre_def<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_pre_imp_wf<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> D S u<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>

      <span class="comment1">(* First foreach loop, checking for onstack-successor*)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it</span> <span class="bound">cyc</span><span class="main">.</span> 
        <span class="main">(</span><span class="keyword1">case</span> <span class="bound">cyc</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="improper">b</span><span class="main">}</span> <span class="main">-</span> <span class="bound">it</span><span class="main">)</span> <span class="main">∩</span> <span class="free">onstack</span> <span class="main">=</span> <span class="main">{}</span>
          <span class="main">|</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">v</span><span class="main">∈</span><span class="free">onstack</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> path <span class="free">E</span> <span class="improper">b</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> FOREACHc_rule<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def gen_dfs_pre_imp_fin<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> red_init_witness_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path1<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>

      <span class="comment1">(* Second foreach loop, iterating over sucessors *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="improper">b</span> <span class="improper">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="improper">b</span> <span class="improper">a</span><span class="main">)</span> <span class="improper">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>
        FOREACHc_rule
      <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def gen_dfs_pre_imp_fin<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def gen_dfs_pre_imp_fe<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>

      <span class="comment1">(* Recursive call *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rprems</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gen_dfs_fe_inv_imp_pre<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_fe_inv_imp_var<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def post_def fe_inv_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm prod.split_asm
        <span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_post_imp_fe_inv<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_post_imp_fe_inv path_prepend<span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def post_def fe_inv_def 
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_fe_inv_pres_visited<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def post_def fe_inv_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_fe_inv_imp_post<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def post_def fe_inv_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_fe_imp_post_brk<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def post_def fe_inv_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_pre_imp_post_brk<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def post_def fe_inv_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_pre_imp_post_brk<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> GEN<span class="main">=</span>this

  <span class="keyword1"><span class="command">note</span></span> GEN<span class="main">[</span><span class="operator">OF</span> PRE'<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> IMP_POST
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> red_dfs_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Main theorem: Correctness of the blue DFS›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> blue_dfs_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> b_graph_rec_scheme"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"b_graph <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finitely_reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blue_dfs <span class="free">G</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> 
    <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="main">∀</span><span class="bound">L</span><span class="main">.</span> <span class="main">¬</span>b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">L</span><span class="main">)</span>
  <span class="main">|</span> Some <span class="bound">L</span> <span class="main">⇒</span> b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> b_graph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"bg_F <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"g_E <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"g_V0 <span class="free">G</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="var">?V0</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">add_inv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">add_inv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">blues</span> <span class="bound">reds</span> <span class="bound">onstack</span><span class="main">.</span> 
    <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">∈</span><span class="main">(</span><span class="bound">blues</span><span class="main">-</span><span class="bound">onstack</span><span class="main">)</span><span class="main">∩</span><span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>  <span class="comment1">― ‹No cycles over finished, accepting states›</span>
    <span class="main">∧</span> <span class="bound">reds</span> <span class="main">⊆</span> <span class="bound">blues</span>                     <span class="comment1">― ‹Red nodes are also blue›</span>
    <span class="main">∧</span> <span class="bound">reds</span> <span class="main">∩</span> <span class="bound">onstack</span> <span class="main">=</span> <span class="main">{}</span>              <span class="comment1">― ‹No red nodes on stack›</span>
    <span class="main">∧</span> red_dfs_inv <span class="var">?E</span> <span class="var">?U</span> <span class="bound">reds</span> <span class="bound">onstack</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cyc_post</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cyc_post</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">blues</span> <span class="bound">reds</span> <span class="bound">onstack</span> <span class="bound">u0</span> <span class="bound">cyc</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">cyc</span> <span class="keyword1">of</span> 
      NO_CYC <span class="main">⇒</span> <span class="skolem">add_inv</span> <span class="bound">blues</span> <span class="bound">reds</span> <span class="bound">onstack</span>
    <span class="main">|</span> REACH <span class="bound">u</span> <span class="bound">p</span> <span class="main">⇒</span> 
          path <span class="var">?E</span> <span class="bound">u0</span> <span class="bound">p</span> <span class="bound">u</span> 
        <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="bound">onstack</span><span class="main">-</span><span class="main">{</span><span class="bound">u0</span><span class="main">}</span> 
        <span class="main">∧</span> insert <span class="bound">u</span> <span class="main">(</span>set <span class="bound">p</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>
    <span class="main">|</span> CIRC <span class="bound">pr</span> <span class="bound">pl</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> 
          <span class="bound">pl</span><span class="main">≠</span><span class="main">[]</span> 
        <span class="main">∧</span> path <span class="var">?E</span> <span class="bound">v</span> <span class="bound">pl</span> <span class="bound">v</span> 
        <span class="main">∧</span> path <span class="var">?E</span> <span class="bound">u0</span> <span class="bound">pr</span> <span class="bound">v</span> 
        <span class="main">∧</span> set <span class="bound">pl</span> <span class="main">∩</span> <span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>
    <span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pre</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">u</span><span class="main">::</span><span class="tfree">'v</span><span class="main">)</span><span class="main">.</span>  
    gen_dfs_pre <span class="var">?E</span> <span class="var">?U</span> <span class="bound">onstack</span> <span class="bound">blues</span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">add_inv</span> <span class="bound">blues</span> <span class="bound">reds</span> <span class="bound">onstack</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">post</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">post</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">blues0</span><span class="main">,</span><span class="bound">reds0</span><span class="main">::</span><span class="tfree">'v</span> set<span class="main">,</span><span class="bound">onstack0</span><span class="main">,</span><span class="bound">u0</span><span class="main">)</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> 
    <span class="bound">onstack</span> <span class="main">=</span> <span class="bound">onstack0</span>
    <span class="main">∧</span> gen_dfs_post <span class="var">?E</span> <span class="var">?U</span> <span class="bound">onstack0</span> <span class="bound">blues0</span> <span class="bound">u0</span> <span class="bound">blues</span> <span class="main">(</span><span class="bound">cyc</span><span class="main">≠</span>NO_CYC<span class="main">)</span>
    <span class="main">∧</span> <span class="skolem">cyc_post</span> <span class="bound">blues</span> <span class="bound">reds</span> <span class="bound">onstack</span> <span class="bound">u0</span> <span class="bound">cyc</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fe_inv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">blues0</span> <span class="bound">u0</span> <span class="bound">onstack0</span> <span class="bound">it</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">onstack</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span> 
    <span class="bound">onstack</span><span class="main">=</span><span class="bound">onstack0</span> 
    <span class="main">∧</span> gen_dfs_fe_inv <span class="var">?E</span> <span class="var">?U</span> <span class="bound">onstack0</span> <span class="bound">blues0</span> <span class="bound">u0</span> <span class="bound">it</span> <span class="bound">blues</span> <span class="main">(</span><span class="bound">cyc</span><span class="main">≠</span>NO_CYC<span class="main">)</span>
    <span class="main">∧</span> <span class="skolem">cyc_post</span> <span class="bound">blues</span> <span class="bound">reds</span> <span class="bound">onstack</span> <span class="bound">u0</span> <span class="bound">cyc</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">outer_inv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">outer_inv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">it</span> <span class="main">(</span><span class="bound">blues</span><span class="main">,</span><span class="bound">reds</span><span class="main">,</span><span class="bound">cyc</span><span class="main">)</span><span class="main">.</span>
    <span class="keyword1">case</span> <span class="bound">cyc</span> <span class="keyword1">of</span> 
      NO_CYC <span class="main">⇒</span> 
        <span class="skolem">add_inv</span> <span class="bound">blues</span> <span class="bound">reds</span> <span class="main">{}</span>
      <span class="main">∧</span> gen_dfs_outer <span class="var">?E</span> <span class="var">?U</span> <span class="var">?V0</span> <span class="bound">it</span> <span class="bound">blues</span> False
    <span class="main">|</span> CIRC <span class="bound">pr</span> <span class="bound">pl</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">v0</span><span class="main">∈</span><span class="var">?V0</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> 
        <span class="bound">pl</span><span class="main">≠</span><span class="main">[]</span> 
      <span class="main">∧</span> path <span class="var">?E</span> <span class="bound">v</span> <span class="bound">pl</span> <span class="bound">v</span> 
      <span class="main">∧</span> path <span class="var">?E</span> <span class="bound">v0</span> <span class="bound">pr</span> <span class="bound">v</span> 
      <span class="main">∧</span> set <span class="bound">pl</span> <span class="main">∩</span> <span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> OUTER_INITIAL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">outer_inv</span> V0 <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> NO_CYC<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> outer_inv_def add_inv_def
    <span class="keyword1"><span class="command">using</span></span> finitely_reachable
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> red_dfs_inv_initial gen_dfs_outer_initial<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">onstack</span> <span class="skolem">blues</span> <span class="skolem">u0</span> <span class="skolem">reds</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues</span><span class="main">)</span> <span class="skolem">u0</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack</span><span class="main">)</span> <span class="main">(</span><span class="var">?E</span><span class="main">``</span><span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span> 
      <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span>insert <span class="skolem">u0</span> <span class="skolem">onstack</span><span class="main">,</span>NO_CYC<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fe_inv_def add_inv_def cyc_post_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def gen_dfs_pre_imp_fe<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def add_inv_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def add_inv_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def add_inv_def gen_dfs_pre_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def add_inv_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> pre_def add_inv_def red_dfs_inv_def gen_dfs_pre_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> PRE_IMP_FE <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">cyc</span><span class="main">.</span> prep_wit_blue <span class="bound">u</span> <span class="bound">cyc</span> <span class="main">=</span> NO_CYC <span class="main">⟷</span> <span class="bound">cyc</span><span class="main">=</span>NO_CYC"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">cyc</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">blues0</span> <span class="skolem">reds0</span> <span class="skolem">onstack0</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">u0</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'v</span></span></span>  <span class="keyword2"><span class="keyword">and</span></span>
      <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">onstack</span> <span class="skolem">blues'</span> <span class="skolem">reds'</span> <span class="skolem">onstack'</span> 
      <span class="skolem">cyc</span> <span class="skolem">it</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> PRE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span><span class="skolem">reds0</span><span class="main">,</span><span class="skolem">onstack0</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> FEI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues0</span><span class="main">)</span> <span class="skolem">u0</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack0</span><span class="main">)</span> 
        <span class="skolem">it</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span>NO_CYC<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span><span class="skolem">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">it</span><span class="main">⊆</span><span class="var">?E</span><span class="main">``</span><span class="main">{</span><span class="skolem">u0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∉</span><span class="skolem">blues</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> POST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">post</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">blues'</span><span class="main">,</span><span class="skolem">reds'</span><span class="main">,</span><span class="skolem">onstack'</span><span class="main">,</span><span class="skolem">cyc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span> <span class="main">=</span> path_simps
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues0</span><span class="main">)</span> <span class="skolem">u0</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">it</span><span class="main">-</span><span class="main">{</span><span class="skolem">t</span><span class="main">}</span><span class="main">)</span> 
      <span class="main">(</span><span class="skolem">blues'</span><span class="main">,</span><span class="skolem">reds'</span><span class="main">,</span><span class="skolem">onstack'</span><span class="main">,</span>prep_wit_blue <span class="skolem">u0</span> <span class="skolem">cyc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fe_inv_def
      <span class="keyword1"><span class="command">using</span></span> PRE FEI IT POST
      <span class="keyword1"><span class="command">unfolding</span></span> fe_inv_def post_def pre_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_post_imp_fe_inv<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> cyc_post_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> blue_witness.split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> FE_INV_PRES<span class="main">=</span>this


  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">onstack</span> <span class="skolem">u0</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="var">?V0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_def gen_dfs_pre_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> PRE_IMP_REACH <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">blues0</span> <span class="skolem">reds0</span> <span class="skolem">onstack0</span> <span class="skolem">u0</span> <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">onstack</span> 
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span><span class="skolem">reds0</span><span class="main">,</span><span class="skolem">onstack0</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues0</span><span class="main">)</span> <span class="skolem">u0</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack0</span><span class="main">)</span> 
        <span class="main">{}</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span>NO_CYC<span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span><span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∉</span><span class="skolem">reds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A
      <span class="keyword1"><span class="command">unfolding</span></span> fe_inv_def add_inv_def pre_def cyc_post_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> FE_IMP_RED_PRE <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">blues0</span> <span class="skolem">reds0</span> <span class="skolem">onstack0</span> <span class="skolem">u0</span> <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">onstack</span> <span class="skolem">rcyc</span> <span class="skolem">reds'</span>
    <span class="keyword3"><span class="command">assume</span></span> PRE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span><span class="skolem">reds0</span><span class="main">,</span><span class="skolem">onstack0</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> FEI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues0</span><span class="main">)</span> <span class="skolem">u0</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack0</span><span class="main">)</span> 
        <span class="main">{}</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span>NO_CYC<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span><span class="var">?A</span>"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> SPECR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">rcyc</span> <span class="keyword1">of</span>
      Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">∈</span><span class="skolem">onstack</span> <span class="main">∧</span> <span class="bound">p</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> path <span class="var">?E</span> <span class="skolem">u0</span> <span class="bound">p</span> <span class="bound">v</span>
    <span class="main">|</span> None <span class="main">⇒</span> 
        red_dfs_inv <span class="var">?E</span> <span class="var">?U</span> <span class="skolem">reds'</span> <span class="skolem">onstack</span> 
        <span class="main">∧</span> <span class="skolem">u0</span><span class="main">∈</span><span class="skolem">reds'</span> 
        <span class="main">∧</span> <span class="skolem">reds'</span> <span class="main">⊆</span> <span class="skolem">reds</span> <span class="main">∪</span> <span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">post</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span><span class="skolem">reds0</span><span class="main">,</span><span class="skolem">onstack0</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span> 
      <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds'</span><span class="main">,</span><span class="skolem">onstack</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">,</span>init_wit_blue <span class="skolem">u0</span> <span class="skolem">rcyc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> post_def add_inv_def cyc_post_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
      <span class="keyword1"><span class="command">from</span></span> PRE FEI <span class="keyword3"><span class="command">show</span></span> OS0<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">onstack</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">onstack0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def add_inv_def gen_dfs_pre_def<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> PRE FEI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">onstack</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pre_def gen_dfs_pre_def fe_inv_def gen_dfs_fe_inv_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> PRE FEI 
      <span class="keyword3"><span class="command">show</span></span> POST<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_dfs_post <span class="var">?E</span> <span class="main">(</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="var">?V0</span><span class="main">)</span> <span class="skolem">onstack0</span> <span class="skolem">blues0</span> <span class="skolem">u0</span> <span class="skolem">blues</span> 
        <span class="main">(</span>init_wit_blue <span class="skolem">u0</span> <span class="skolem">rcyc</span> <span class="main">≠</span> NO_CYC<span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_fe_inv_imp_post<span class="main">)</span>

      <span class="keyword3"><span class="command">case</span></span> 3

      <span class="keyword1"><span class="command">from</span></span> FEI <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">onstack</span><span class="main">=</span>insert <span class="skolem">u0</span> <span class="skolem">onstack0</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> fe_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> FEI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">blues</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fe_inv_def gen_dfs_fe_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rcyc</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_paired_all<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rcyc</span><span class="main">=</span>None"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="main">(</span><span class="skolem">blues</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">∧</span>
          <span class="skolem">reds'</span> <span class="main">⊆</span> <span class="skolem">blues</span> <span class="main">∧</span>
          <span class="skolem">reds'</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
          red_dfs_inv <span class="var">?E</span> <span class="main">(</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="var">?V0</span><span class="main">)</span> <span class="skolem">reds'</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> SPECR <span class="keyword1"><span class="command">have</span></span> RINV<span class="main">:</span> <span class="quoted"><span class="quoted">"red_dfs_inv <span class="var">?E</span> <span class="var">?U</span> <span class="skolem">reds'</span> <span class="skolem">onstack</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">reds'</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> REDS'R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">reds'</span> <span class="main">⊆</span> <span class="skolem">reds</span> <span class="main">∪</span> <span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="skolem">u0</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">from</span></span> RINV <span class="keyword3"><span class="command">show</span></span> 
            RINV'<span class="main">:</span> <span class="quoted"><span class="quoted">"red_dfs_inv <span class="var">?E</span> <span class="main">(</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="var">?V0</span><span class="main">)</span> <span class="skolem">reds'</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> red_dfs_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">from</span></span> RINV'<span class="main">[</span><span class="operator">unfolded</span> red_dfs_inv_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
            REDS'CL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span><span class="main">``</span><span class="skolem">reds'</span> <span class="main">⊆</span> <span class="skolem">reds'</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> DJ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="main">``</span> <span class="skolem">reds'</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">from</span></span> RINV<span class="main">[</span><span class="operator">unfolded</span> red_dfs_inv_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
            DJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="main">``</span> <span class="skolem">reds'</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">onstack</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">reds'</span> <span class="main">⊆</span> <span class="skolem">blues</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> 
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">reds'</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> REDS'R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">reds</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">u0</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">blues</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">reds</span>"</span></span> 
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> FEI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">reds</span><span class="main">⊆</span><span class="skolem">blues</span>"</span></span> 
                <span class="keyword1"><span class="command">unfolding</span></span> fe_inv_def add_inv_def cyc_post_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">from</span></span> POST<span class="main">[</span><span class="operator">unfolded</span> gen_dfs_post_def OS0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
                CL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?E</span> <span class="main">``</span> <span class="main">(</span><span class="skolem">blues</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">blues</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">blues</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> PRE FEI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">onstack0</span> <span class="main">⊆</span> <span class="skolem">blues</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> pre_def fe_inv_def gen_dfs_pre_def gen_dfs_fe_inv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u0</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">blues</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_last_visit<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">onstack</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> no_visit
                <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">blues</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">blues</span>›</span></span> CL 
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtranclE<span class="main">)</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>last_visit_point <span class="skolem">u</span><span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u0</span><span class="main">,</span><span class="skolem">uh</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">uh</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tranclD2<span class="main">)</span> 
                <span class="keyword1"><span class="command">with</span></span> REDS'CL DJ' <span class="quoted"><span class="quoted">‹<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">reds'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">uh</span><span class="main">∈</span><span class="skolem">reds'</span>"</span></span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Image_closed_trancl<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> DJ' <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">uh</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">onstack</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="main">(</span><span class="skolem">blues</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?A</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∉</span> <span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> 
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
            <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">blues</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?A</span>"</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∉</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">=</span><span class="skolem">u0</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">≠</span><span class="skolem">u0</span>"</span></span> 
              <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="main">(</span><span class="skolem">blues</span> <span class="main">-</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> FEI <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
                <span class="keyword1"><span class="command">unfolding</span></span> fe_inv_def add_inv_def cyc_post_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">=</span><span class="skolem">u0</span>"</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u0</span><span class="main">,</span><span class="skolem">uh</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">uh</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span>"</span></span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> tranclD2<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> REDS'CL DJ <span class="quoted"><span class="quoted">‹<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">reds'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">uh</span><span class="main">∈</span><span class="skolem">reds'</span>"</span></span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Image_closed_trancl<span class="main">)</span>
                <span class="keyword1"><span class="command">with</span></span> DJ <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">uh</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u0</span> <span class="main">∈</span> <span class="skolem">onstack</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">reds'</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">reds'</span> <span class="main">∩</span> <span class="main">(</span><span class="skolem">onstack0</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">reds'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">onstack0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">≠</span><span class="skolem">u0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
            <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span><span class="skolem">reds'</span>›</span></span> REDS'R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">reds</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">u0</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">reds</span>"</span></span> 
              <span class="keyword1"><span class="command">with</span></span> FEI<span class="main">[</span><span class="operator">unfolded</span> fe_inv_def add_inv_def cyc_post_def<span class="main">]</span> 
                <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span><span class="skolem">onstack0</span>›</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u0</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">≠</span><span class="skolem">u0</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u0</span><span class="main">,</span><span class="skolem">uh</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">uh</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtranclE<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> REDS'CL DJ <span class="quoted"><span class="quoted">‹<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">reds'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">uh</span><span class="main">∈</span><span class="skolem">reds'</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Image_closed_trancl<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> DJ <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">uh</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span><span class="var">?E</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">onstack0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">p</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rcyc</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"
          <span class="main">(</span><span class="skolem">u</span> <span class="main">=</span> <span class="skolem">u0</span> <span class="main">⟶</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> path <span class="var">?E</span> <span class="skolem">u0</span> <span class="skolem">p</span> <span class="skolem">u0</span> <span class="main">∧</span> set <span class="skolem">p</span> <span class="main">∩</span> <span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="skolem">u</span> <span class="main">≠</span> <span class="skolem">u0</span> <span class="main">⟶</span> 
              path <span class="var">?E</span> <span class="skolem">u0</span> <span class="skolem">p</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="skolem">u</span> <span class="main">∈</span> <span class="skolem">onstack0</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">∨</span> set <span class="skolem">p</span> <span class="main">∩</span> <span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> SPECR <span class="quoted"><span class="quoted">‹<span class="skolem">u0</span><span class="main">∈</span><span class="var">?A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> 
            <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">≠</span><span class="skolem">u0</span> <span class="main">⟹</span> <span class="skolem">u</span><span class="main">∈</span><span class="skolem">onstack0</span>"</span></span> 
            <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">≠</span><span class="main">[]</span>"</span></span> 
            <span class="quoted"><span class="quoted">"path <span class="var">?E</span> <span class="skolem">u0</span> <span class="skolem">p</span> <span class="skolem">u</span>"</span></span> 
            <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">=</span><span class="skolem">u0</span> <span class="main">⟹</span> path <span class="var">?E</span> <span class="skolem">u0</span> <span class="skolem">p</span> <span class="skolem">u0</span>"</span></span>
            <span class="quoted"><span class="quoted">"set <span class="skolem">p</span> <span class="main">∩</span> F <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> F <span class="main">∨</span> set <span class="skolem">p</span> <span class="main">∩</span> F <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv path_simps<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> RED_IMP_POST <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">blues0</span> <span class="skolem">reds0</span> <span class="skolem">onstack0</span> <span class="skolem">u0</span> <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">onstack</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">cyc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> blue_witness"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> PRE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span><span class="skolem">reds0</span><span class="main">,</span><span class="skolem">onstack0</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> FEI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues0</span><span class="main">)</span> <span class="skolem">u0</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack0</span><span class="main">)</span> 
        <span class="main">{}</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span>NO_CYC<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> FC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cyc</span><span class="main">=</span>NO_CYC"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> NCOND<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∉</span><span class="var">?A</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> PRE FEI <span class="keyword1"><span class="command">have</span></span> OS0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">onstack0</span> <span class="main">=</span> <span class="skolem">onstack</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def add_inv_def gen_dfs_pre_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command">from</span></span> PRE FEI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">onstack</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_def gen_dfs_pre_def fe_inv_def gen_dfs_fe_inv_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> OS0 <span class="keyword1"><span class="command">have</span></span> OS1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">onstack</span> <span class="main">=</span> insert <span class="skolem">u0</span> <span class="skolem">onstack0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">post</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span><span class="skolem">reds0</span><span class="main">,</span><span class="skolem">onstack0</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">,</span>NO_CYC<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> post_def cyc_post_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OS0<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> PRE FEI <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_fe_inv_imp_post<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      
      <span class="keyword1"><span class="command">using</span></span> FEI<span class="main">[</span><span class="operator">unfolded</span> fe_inv_def cyc_post_def<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> add_inv_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> NCOND <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> red_dfs_inv_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> NCOND_IMP_POST<span class="main">=</span>this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">blues0</span> <span class="skolem">reds0</span> <span class="skolem">onstack0</span> <span class="skolem">u0</span> <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">onstack</span> <span class="skolem">it</span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">cyc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> blue_witness"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> PRE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span><span class="skolem">reds0</span><span class="main">,</span><span class="skolem">onstack0</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> FEI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues0</span><span class="main">)</span> <span class="skolem">u0</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack0</span><span class="main">)</span> 
        <span class="skolem">it</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span><span class="skolem">cyc</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> NC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cyc</span><span class="main">≠</span>NO_CYC"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">it</span><span class="main">⊆</span><span class="var">?E</span><span class="main">``</span><span class="main">{</span><span class="skolem">u0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> PRE FEI <span class="keyword1"><span class="command">have</span></span> OS0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">onstack0</span> <span class="main">=</span> <span class="skolem">onstack</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def add_inv_def gen_dfs_pre_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command">from</span></span> PRE FEI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span><span class="skolem">onstack</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_def gen_dfs_pre_def fe_inv_def gen_dfs_fe_inv_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> OS0 <span class="keyword1"><span class="command">have</span></span> OS1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">onstack</span> <span class="main">=</span> insert <span class="skolem">u0</span> <span class="skolem">onstack0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">post</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span><span class="skolem">reds0</span><span class="main">,</span><span class="skolem">onstack0</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u0</span><span class="main">}</span><span class="main">,</span><span class="skolem">cyc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> post_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OS0<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> PRE FEI IT NC <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_fe_imp_post_brk<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> FEI<span class="main">[</span><span class="operator">unfolded</span> fe_inv_def<span class="main">]</span> NC 
      <span class="keyword1"><span class="command">unfolding</span></span> cyc_post_def 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> blue_witness.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> OS1<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> BREAK_IMP_POST <span class="main">=</span> this


  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">blues0</span> <span class="skolem">reds0</span> <span class="skolem">onstack0</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">u0</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'v</span></span></span>  <span class="keyword2"><span class="keyword">and</span></span>
      <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">onstack</span> <span class="skolem">cyc</span> <span class="skolem">it</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> PRE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span><span class="skolem">reds0</span><span class="main">,</span><span class="skolem">onstack0</span><span class="main">,</span><span class="skolem">u0</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> FEI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues0</span><span class="main">)</span> <span class="skolem">u0</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack0</span><span class="main">)</span> 
        <span class="skolem">it</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span>NO_CYC<span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">it</span><span class="main">⊆</span><span class="var">?E</span><span class="main">``</span><span class="main">{</span><span class="skolem">u0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span><span class="skolem">it</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> T_OS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">onstack</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> U0ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u0</span><span class="main">∈</span>F <span class="main">∨</span> <span class="skolem">t</span><span class="main">∈</span>F"</span></span>


    <span class="keyword1"><span class="command">from</span></span> T_OS <span class="keyword1"><span class="command">have</span></span> TIB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">blues</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PRE FEI 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fe_inv_def pre_def gen_dfs_fe_inv_def gen_dfs_pre_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">blues0</span><span class="main">)</span> <span class="skolem">u0</span> <span class="main">(</span>insert <span class="skolem">u0</span> <span class="skolem">onstack0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">it</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">t</span><span class="main">}</span><span class="main">)</span> 
      <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span><span class="skolem">reds</span><span class="main">,</span><span class="skolem">onstack</span><span class="main">,</span>init_wit_blue_early <span class="skolem">u0</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fe_inv_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> it_step_insert_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> IT<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>

      <span class="keyword1"><span class="command">using</span></span> PRE FEI <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fe_inv_def pre_def<span class="main">)</span>

      <span class="comment1">(* TODO: This is a generic early-break condition. However, it requires
        t ∈ V. Do we really need such a strict invar in case of break? *)</span>
      <span class="keyword1"><span class="command">using</span></span> FEI TIB <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fe_inv_def gen_dfs_fe_inv_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command">unfolding</span></span> cyc_post_def init_wit_blue_early_def
      <span class="keyword1"><span class="command">using</span></span> IT T_OS U0ACC <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> EARLY_DET_OPT <span class="main">=</span> this


  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span>
    <span class="keyword3"><span class="command">assume</span></span> INV0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="skolem">σ</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">REC<span class="hidden">⇩</span><sub>T</sub></span> <span class="main">(</span>blue_dfs_body <span class="free">G</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="skolem">post</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span>
        RECT_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pre<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">pre</span>"</span></span>
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> V<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"gen_dfs_var <span class="var">?U</span> <span class="keyword1">&lt;*lex*&gt;</span> <span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> blue_dfs_body_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">refine_mono</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fin_U_imp_wf finitely_reachable<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INV0<span class="main">)</span>

      <span class="comment1">(* Body *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> blue_dfs_body_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>


      <span class="comment1">(* Foreach loop *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> 
        I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">fe_inv</span> <span class="main">(</span>insert <span class="improper">bb</span> <span class="improper">a</span><span class="main">)</span> <span class="improper">bb</span> <span class="main">(</span>insert <span class="improper">bb</span> <span class="improper">ab</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> FOREACHc_rule'<span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def gen_dfs_pre_imp_fin<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> PRE_IMP_FE<span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>

      <span class="comment1">(* Early detection of cycles *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> EARLY_DET_OPT<span class="main">)</span>

      <span class="comment1">(* Recursive call *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rprems</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def cyc_post_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gen_dfs_fe_inv_imp_pre<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def fe_inv_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_fe_inv_imp_var<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> FE_INV_PRES<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_def post_def fe_inv_def 
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_fe_inv_pres_visited<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>

      <span class="comment1">(* Nested DFS call *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> red_dfs_correct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> U<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="var">?V0</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fe_inv_def add_inv_def cyc_post_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> PRE_IMP_REACH<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> FE_IMP_RED_PRE<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> RED_IMP_POST<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> NCOND_IMP_POST<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> BREAK_IMP_POST<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> GEN<span class="main">=</span>this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v0</span> <span class="skolem">it</span> <span class="skolem">blues</span> <span class="skolem">reds</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v0</span> <span class="main">∈</span> <span class="skolem">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">it</span> <span class="main">⊆</span> V0"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v0</span> <span class="main">∉</span> <span class="skolem">blues</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">outer_inv</span> <span class="skolem">it</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span> <span class="skolem">reds</span><span class="main">,</span> NO_CYC<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pre</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span> <span class="skolem">reds</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="skolem">v0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_def outer_inv_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_pre_initial<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> OUTER_IMP_PRE <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v0</span> <span class="skolem">it</span> <span class="skolem">blues0</span> <span class="skolem">reds0</span> <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">onstack</span> <span class="skolem">cyc</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v0</span> <span class="main">∈</span> <span class="skolem">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">it</span> <span class="main">⊆</span> V0"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v0</span> <span class="main">∉</span> <span class="skolem">blues0</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">outer_inv</span> <span class="skolem">it</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span> <span class="skolem">reds0</span><span class="main">,</span> NO_CYC<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">post</span> <span class="main">(</span><span class="skolem">blues0</span><span class="main">,</span> <span class="skolem">reds0</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="skolem">v0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span> <span class="skolem">reds</span><span class="main">,</span> <span class="skolem">onstack</span><span class="main">,</span> <span class="skolem">cyc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">outer_inv</span> <span class="main">(</span><span class="skolem">it</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">v0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span> <span class="skolem">reds</span><span class="main">,</span> <span class="skolem">cyc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> post_def outer_inv_def cyc_post_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> blue_witness.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_post_imp_outer<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> POST_IMP_OUTER <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v0</span> <span class="skolem">it</span> <span class="skolem">blues</span> <span class="skolem">reds</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v0</span> <span class="main">∈</span> <span class="skolem">it</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">it</span> <span class="main">⊆</span> V0"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">outer_inv</span> <span class="skolem">it</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span> <span class="skolem">reds</span><span class="main">,</span> NO_CYC<span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">v0</span> <span class="main">∈</span> <span class="skolem">blues</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">outer_inv</span> <span class="main">(</span><span class="skolem">it</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">v0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span> <span class="skolem">reds</span><span class="main">,</span> NO_CYC<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> outer_inv_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gen_dfs_outer_already_vis<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> OUTER_ALREX <span class="main">=</span> this


  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">it</span> <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">cyc</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">outer_inv</span> <span class="skolem">it</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span> <span class="skolem">reds</span><span class="main">,</span> <span class="skolem">cyc</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cyc</span> <span class="main">≠</span> NO_CYC"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> extract_res <span class="skolem">cyc</span> <span class="keyword1">of</span> 
        None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">L</span><span class="main">.</span> <span class="main">¬</span> is_lasso_prpl <span class="bound">L</span> 
      <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> is_lasso_prpl <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> outer_inv_def extract_res_def is_lasso_prpl_def
        is_lasso_prpl_pre_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cyc</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IMP_POST_CYC <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">pr</span>"</span> <span class="skolem">pl</span> <span class="skolem">blues</span> <span class="skolem">reds</span>
    <span class="keyword3"><span class="command">assume</span></span> ADD_INV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">add_inv</span> <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> GEN_INV<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_dfs_outer E <span class="main">(</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> V0<span class="main">)</span> V0 <span class="main">{}</span> <span class="skolem">blues</span> False"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> LASSO<span class="main">:</span> <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="main">(</span><span class="skolem">pr</span><span class="main">,</span> <span class="skolem">pl</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">from</span></span> LASSO<span class="main">[</span><span class="operator">unfolded</span> is_lasso_prpl_def is_lasso_prpl_pre_def<span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v0</span></span> <span class="skolem"><span class="skolem">va</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">v0</span><span class="main">∈</span>V0"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pl</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      PR<span class="main">:</span> <span class="quoted"><span class="quoted">"path E <span class="skolem">v0</span> <span class="skolem">pr</span> <span class="skolem">va</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PL<span class="main">:</span> <span class="quoted"><span class="quoted">"path E <span class="skolem">va</span> <span class="skolem">pl</span> <span class="skolem">va</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">pl</span> <span class="main">∩</span> F <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> F <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pl1</span></span> <span class="skolem"><span class="skolem">vf</span></span> <span class="skolem"><span class="skolem">pl2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pl</span><span class="main">=</span><span class="skolem">pl1</span><span class="main">@</span><span class="skolem">vf</span><span class="main">#</span><span class="skolem">pl2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vf</span><span class="main">∈</span>F"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_decomp<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> PR PL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path E <span class="skolem">v0</span> <span class="main">(</span><span class="skolem">pr</span><span class="main">@</span><span class="skolem">pl1</span><span class="main">)</span> <span class="skolem">vf</span>"</span></span> <span class="quoted"><span class="quoted">"path E <span class="skolem">vf</span> <span class="main">(</span><span class="skolem">vf</span><span class="main">#</span><span class="skolem">pl2</span><span class="main">@</span><span class="skolem">pl1</span><span class="main">)</span> <span class="skolem">vf</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v0</span><span class="main">,</span><span class="skolem">vf</span><span class="main">)</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">vf</span><span class="main">,</span><span class="skolem">vf</span><span class="main">)</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> path_is_rtrancl path_is_trancl<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> GEN_INV <span class="quoted"><span class="quoted">‹<span class="skolem">v0</span><span class="main">∈</span>V0›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v0</span><span class="main">,</span><span class="skolem">vf</span><span class="main">)</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vf</span><span class="main">∈</span><span class="skolem">blues</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> gen_dfs_outer_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_closed_trancl rev_ImageI rev_subsetD<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> ADD_INV<span class="main">[</span><span class="operator">unfolded</span> add_inv_def<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">vf</span><span class="main">∈</span><span class="skolem">blues</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">vf</span><span class="main">∈</span>F›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">vf</span><span class="main">,</span><span class="skolem">vf</span><span class="main">)</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>+</sup></span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IMP_POST_NOCYC_AUX <span class="main">=</span> this
    
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">blues</span> <span class="skolem">reds</span> <span class="skolem">cyc</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">outer_inv</span> <span class="main">{}</span> <span class="main">(</span><span class="skolem">blues</span><span class="main">,</span> <span class="skolem">reds</span><span class="main">,</span> <span class="skolem">cyc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> extract_res <span class="skolem">cyc</span> <span class="keyword1">of</span> 
        None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">L</span><span class="main">.</span> <span class="main">¬</span> is_lasso_prpl <span class="bound">L</span> 
      <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> is_lasso_prpl <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">cyc</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IMP_POST_CYC<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> outer_inv_def extract_res_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IMP_POST_NOCYC_AUX<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IMP_POST_NOCYC <span class="main">=</span> this


  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> blue_dfs_fe.refine blue_dfs_body.refine
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> 
      FOREACHc_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">outer_inv</span></span><span class="main"><span class="main">]</span></span>
      <span class="dynamic"><span class="dynamic">refine_vcg</span></span>
    <span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finitely_reachable finite_V0<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> OUTER_INITIAL<span class="main">)</span>
    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> GEN<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OUTER_IMP_PRE<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> POST_IMP_OUTER<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OUTER_ALREX<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IMP_POST_NOCYC<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> IMP_POST_CYC<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Refinement"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Setup for Custom Datatypes›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This effort can be automated, but currently, such an automation is
  not yet implemented›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">red_wit_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟩</span>list_rel<span class="main">,</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟩</span>prod_rel<span class="main">⟩</span>option_rel"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">i_red_wit</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list<span class="main">,</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_option"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">blue_wit_rel</span> <span class="main">≡</span> <span class="main">(</span>Id<span class="main">::</span><span class="main">(</span><span class="main">_</span> blue_witness <span class="main">×</span> <span class="main">_</span><span class="main">)</span> set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">consts</span></span> i_blue_wit <span class="main">::</span> <span class="quoted">interface</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">blue_wit_rel</span> <span class="quoted">i_blue_wit</span><span class="main">]</span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">init_wit_blue_early</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"NO_CYC <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_blue_wit"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(=)</span> <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_blue_wit <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_blue_wit <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool"</span></span>
  <span class="quoted"><span class="quoted">"init_wit_blue <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_red_wit <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_blue_wit"</span></span>
  <span class="quoted"><span class="quoted">"init_wit_blue_early <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_blue_wit"</span></span>
  <span class="quoted"><span class="quoted">"prep_wit_blue <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_blue_wit <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_blue_wit"</span></span>
  <span class="quoted"><span class="quoted">"red_init_witness <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_red_wit <span class="free">I</span>"</span></span>
  <span class="quoted"><span class="quoted">"prep_wit_red <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_red_wit <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_red_wit <span class="free">I</span>"</span></span>
  <span class="quoted"><span class="quoted">"extract_res <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_blue_wit <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list<span class="main">,</span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_option"</span></span>
  <span class="quoted"><span class="quoted">"red_dfs <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> 
    <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set<span class="main">,</span> i_red_wit <span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_nres"</span></span>
  <span class="quoted"><span class="quoted">"blue_dfs <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bg i_unit <span class="free">I</span> 
    <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list<span class="main">,</span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_list<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_option<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_nres"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"NO_CYC <span class="main">≡</span> <span class="keyword1">OP</span> NO_CYC <span class="keyword1">:::<span class="hidden">⇩</span><sub>i</sub></span> i_blue_wit"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">lasso_rel_ext</span>


<span class="keyword1"><span class="command">lemma</span></span> autoref_wit<span class="main">[</span><span class="operator">autoref_rules_raw</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>NO_CYC<span class="main">,</span>NO_CYC<span class="main">)</span><span class="main">∈</span>blue_wit_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> blue_wit_rel <span class="main">→</span> blue_wit_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> PREFER_id <span class="bound">R</span> 
    <span class="main">⟹</span> <span class="main">(</span>init_wit_blue<span class="main">,</span> init_wit_blue<span class="main">)</span> <span class="main">∈</span> <span class="bound">R</span> <span class="main">→</span> red_wit_rel <span class="bound">R</span> <span class="main">→</span> blue_wit_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> PREFER_id <span class="bound">R</span> 
    <span class="main">⟹</span> <span class="main">(</span>init_wit_blue_early<span class="main">,</span> init_wit_blue_early<span class="main">)</span> <span class="main">∈</span> <span class="bound">R</span> <span class="main">→</span> <span class="bound">R</span> <span class="main">→</span> blue_wit_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> PREFER_id <span class="bound">R</span> 
    <span class="main">⟹</span> <span class="main">(</span>prep_wit_blue<span class="main">,</span>prep_wit_blue<span class="main">)</span><span class="main">∈</span><span class="bound">R</span> <span class="main">→</span> blue_wit_rel <span class="main">→</span> blue_wit_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> PREFER_id <span class="bound">R</span> 
    <span class="main">⟹</span> <span class="main">(</span>red_init_witness<span class="main">,</span> red_init_witness<span class="main">)</span> <span class="main">∈</span> <span class="bound">R</span><span class="main">→</span><span class="bound">R</span><span class="main">→</span>red_wit_rel <span class="bound">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> PREFER_id <span class="bound">R</span> 
    <span class="main">⟹</span> <span class="main">(</span>prep_wit_red<span class="main">,</span>prep_wit_red<span class="main">)</span> <span class="main">∈</span> <span class="bound">R</span> <span class="main">→</span> red_wit_rel <span class="bound">R</span> <span class="main">→</span> red_wit_rel <span class="bound">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> PREFER_id <span class="bound">R</span> 
    <span class="main">⟹</span> <span class="main">(</span>extract_res<span class="main">,</span>extract_res<span class="main">)</span> 
        <span class="main">∈</span> blue_wit_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel<span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span><span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel<span class="main">⟩</span>option_rel"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Actual Refinement›</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">red_dfs</span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"map2set_rel <span class="main">(</span>rbt_map_rel <span class="free">ord</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="free">rbt_set_rel</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> red_dfs_refine_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> red_dfs<span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">×</span> <span class="main">_</span><span class="main">)</span> set<span class="main">⇒</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>dflt_rs_rel"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> red_dfs_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">impl_red_dfs</span> <span class="keyword2"><span class="keyword">uses</span></span> red_dfs_refine_aux

<span class="keyword1"><span class="command">lemma</span></span> impl_red_dfs_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>impl_red_dfs<span class="main">,</span> red_dfs<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>dflt_rs_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>dflt_rs_rel <span class="main">→</span> <span class="free">R</span> 
    <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>dflt_rs_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> red_wit_rel <span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms impl_red_dfs.refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">autoref_itype</span></span><span class="main">(</span>1-10<span class="main">)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> code_red_dfs_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> impl_red_dfs <span class="free">E</span> <span class="free">onstack</span> <span class="free">V</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> impl_red_dfs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span> the_resI<span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">code_red_dfs</span> <span class="keyword2"><span class="keyword">uses</span></span> code_red_dfs_aux
<span class="keyword1"><span class="command">prepare_code_thms</span></span> code_red_dfs_def
<span class="keyword1"><span class="command">declare</span></span> code_red_dfs.refine<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">code_red_dfs</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">schematic_goal</span></span> red_dfs_hash_refine_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> red_dfs<span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>hashable <span class="main">×</span> <span class="main">_</span><span class="main">)</span> set<span class="main">⇒</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>hs.rel"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> red_dfs_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">impl_red_dfs_hash</span> <span class="keyword2"><span class="keyword">uses</span></span> red_dfs_hash_refine_aux

<span class="keyword1"><span class="command">thm</span></span> impl_red_dfs_hash.refine

<span class="keyword1"><span class="command">lemma</span></span> impl_red_dfs_hash_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">::</span>hashable<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>impl_red_dfs_hash<span class="main">,</span> red_dfs<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>hs.rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>hs.rel <span class="main">→</span> <span class="free">R</span> 
    <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>hs.rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> red_wit_rel <span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms impl_red_dfs_hash.refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> code_red_dfs_hash_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> impl_red_dfs_hash <span class="free">E</span> <span class="free">onstack</span> <span class="free">V</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> impl_red_dfs_hash_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span> the_resI<span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">code_red_dfs_hash</span> <span class="keyword2"><span class="keyword">uses</span></span> code_red_dfs_hash_aux
<span class="keyword1"><span class="command">prepare_code_thms</span></span> code_red_dfs_hash_def
<span class="keyword1"><span class="command">declare</span></span> code_red_dfs_hash.refine<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">code_red_dfs_hash</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">schematic_goal</span></span> red_dfs_ahs_refine_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> red_dfs<span class="main">::</span><span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>hashable <span class="main">×</span> <span class="main">_</span><span class="main">)</span> set<span class="main">⇒</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>hashable set"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>ahs.rel"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> red_dfs_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">impl_red_dfs_ahs</span> <span class="keyword2"><span class="keyword">uses</span></span> red_dfs_ahs_refine_aux

<span class="keyword1"><span class="command">lemma</span></span> impl_red_dfs_ahs_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">::</span>hashable<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>impl_red_dfs_ahs<span class="main">,</span> red_dfs<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ahs.rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ahs.rel <span class="main">→</span> <span class="free">R</span> 
    <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>ahs.rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> red_wit_rel <span class="free">R</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms impl_red_dfs_ahs.refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> code_red_dfs_ahs_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> impl_red_dfs_ahs <span class="free">E</span> <span class="free">onstack</span> <span class="free">V</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> impl_red_dfs_ahs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span> the_resI<span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">code_red_dfs_ahs</span> <span class="keyword2"><span class="keyword">uses</span></span> code_red_dfs_ahs_aux
<span class="keyword1"><span class="command">prepare_code_thms</span></span> code_red_dfs_ahs_def
<span class="keyword1"><span class="command">declare</span></span> code_red_dfs_ahs.refine<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">code_red_dfs_ahs</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="comment1">(*abbreviation "blue_dfs_annot E A u ≡ blue_dfs E (A:::<span class="hidden">⇩</span><sub>r</sub>⟨Id⟩fun_set_rel) u"*)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> blue_dfs_refine_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> blue_dfs<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder b_graph_rec<span class="main">⇒</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span>
    ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Id"</span></span><span class="main">]</span>
    ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>dflt_rs_rel"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> blue_dfs_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">impl_blue_dfs</span> <span class="keyword2"><span class="keyword">uses</span></span> blue_dfs_refine_aux

<span class="keyword1"><span class="command">thm</span></span> impl_blue_dfs.refine

<span class="keyword1"><span class="command">lemma</span></span> impl_blue_dfs_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>impl_blue_dfs<span class="main">,</span> blue_dfs<span class="main">)</span> 
  <span class="main">∈</span> bg_impl_rel_ext unit_rel <span class="free">R</span> 
   <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">⟩</span>Relators.option_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms impl_blue_dfs.refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> code_blue_dfs_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> impl_blue_dfs <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> impl_blue_dfs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span> the_resI
    order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> det_RETURN code_red_dfs.refine<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">code_blue_dfs</span> <span class="keyword2"><span class="keyword">uses</span></span> code_blue_dfs_aux
<span class="keyword1"><span class="command">prepare_code_thms</span></span> code_blue_dfs_def
<span class="keyword1"><span class="command">declare</span></span> code_blue_dfs.refine<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">code_blue_dfs</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">schematic_goal</span></span> blue_dfs_hash_refine_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> blue_dfs<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>hashable b_graph_rec<span class="main">⇒</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span>
    ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Id"</span></span><span class="main">]</span>
    ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>hashable set"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>hs.rel"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> blue_dfs_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">impl_blue_dfs_hash</span> <span class="keyword2"><span class="keyword">uses</span></span> blue_dfs_hash_refine_aux

<span class="keyword1"><span class="command">lemma</span></span> impl_blue_dfs_hash_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>hashable<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>impl_blue_dfs_hash<span class="main">,</span> blue_dfs<span class="main">)</span> <span class="main">∈</span> bg_impl_rel_ext unit_rel <span class="free">R</span> 
    <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">⟩</span>Relators.option_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms impl_blue_dfs_hash.refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> code_blue_dfs_hash_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> impl_blue_dfs_hash <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> impl_blue_dfs_hash_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_transfer</span> the_resI
    order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> det_RETURN code_red_dfs_hash.refine<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">code_blue_dfs_hash</span> <span class="keyword2"><span class="keyword">uses</span></span> code_blue_dfs_hash_aux
<span class="keyword1"><span class="command">prepare_code_thms</span></span> code_blue_dfs_hash_def
<span class="keyword1"><span class="command">declare</span></span> code_blue_dfs_hash.refine<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">code_blue_dfs_hash</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">schematic_goal</span></span> blue_dfs_ahs_refine_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> blue_dfs<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>hashable b_graph_rec<span class="main">⇒</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span>
    ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Id"</span></span><span class="main">]</span>
    ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>hashable set"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>ahs.rel"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> blue_dfs_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">impl_blue_dfs_ahs</span> <span class="keyword2"><span class="keyword">uses</span></span> blue_dfs_ahs_refine_aux

<span class="keyword1"><span class="command">lemma</span></span> impl_blue_dfs_ahs_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>hashable<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"MINOR_PRIO_TAG <span class="numeral">5</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PREFER_id <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>impl_blue_dfs_ahs<span class="main">,</span> blue_dfs<span class="main">)</span> <span class="main">∈</span> bg_impl_rel_ext unit_rel <span class="free">R</span> 
    <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">⟩</span>Relators.option_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms impl_blue_dfs_ahs.refine <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> impl_blue_dfs_ahs_def

<span class="keyword1"><span class="command">schematic_goal</span></span> code_blue_dfs_ahs_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> impl_blue_dfs_ahs <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> impl_blue_dfs_ahs_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_transfer</span> the_resI
    order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> det_RETURN code_red_dfs_ahs.refine<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">code_blue_dfs_ahs</span> <span class="keyword2"><span class="keyword">uses</span></span> code_blue_dfs_ahs_aux
<span class="keyword1"><span class="command">prepare_code_thms</span></span> code_blue_dfs_ahs_def
<span class="keyword1"><span class="command">declare</span></span> code_blue_dfs_ahs.refine<span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">code_blue_dfs_ahs</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness theorem›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> code_blue_dfs_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>bg_impl_rel_ext unit_rel Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>code_blue_dfs <span class="free">Gi</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> 
    <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">prpl</span><span class="main">.</span> <span class="main">¬</span>b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">prpl</span>
  <span class="main">|</span> Some <span class="bound">L</span> <span class="main">⇒</span> b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> code_blue_dfs.refine
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> impl_blue_dfs.refine<span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">OF</span> REL<span class="main">,</span> <span class="operator">THEN</span> nres_relD<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> blue_dfs_correct<span class="main">[</span><span class="operator">OF</span> G<span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> code_blue_dfs_correct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>bg_impl_rel_ext unit_rel Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> code_blue_dfs <span class="free">Gi</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">prpl</span><span class="main">.</span> <span class="main">¬</span>b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">prpl</span>
    <span class="main">|</span> Some <span class="bound">L</span> <span class="main">⇒</span> b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> code_blue_dfs_correct<span class="main">[</span><span class="operator">OF</span> G REL<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> code_blue_dfs_hash_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>bg_impl_rel_ext unit_rel Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>code_blue_dfs_hash <span class="free">Gi</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span>
    <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">prpl</span><span class="main">.</span> <span class="main">¬</span>b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">prpl</span>
  <span class="main">|</span> Some <span class="bound">L</span> <span class="main">⇒</span> b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> code_blue_dfs_hash.refine
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> impl_blue_dfs_hash.refine<span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">OF</span> REL<span class="main">,</span> <span class="operator">THEN</span> nres_relD<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> blue_dfs_correct<span class="main">[</span><span class="operator">OF</span> G<span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> code_blue_dfs_hash_correct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>bg_impl_rel_ext unit_rel Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> code_blue_dfs_hash <span class="free">Gi</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">prpl</span><span class="main">.</span> <span class="main">¬</span>b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">prpl</span>
    <span class="main">|</span> Some <span class="bound">L</span> <span class="main">⇒</span> b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> code_blue_dfs_hash_correct<span class="main">[</span><span class="operator">OF</span> G REL<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> code_blue_dfs_ahs_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>bg_impl_rel_ext unit_rel Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>code_blue_dfs_ahs <span class="free">Gi</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> 
    <span class="keyword1">case</span> <span class="bound">r</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">prpl</span><span class="main">.</span> <span class="main">¬</span>b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">prpl</span>
  <span class="main">|</span> Some <span class="bound">L</span> <span class="main">⇒</span> b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> code_blue_dfs_ahs.refine
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> impl_blue_dfs_ahs.refine<span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">OF</span> REL<span class="main">,</span> <span class="operator">THEN</span> nres_relD<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> blue_dfs_correct<span class="main">[</span><span class="operator">OF</span> G<span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> option.case_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> code_blue_dfs_ahs_correct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> REL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>bg_impl_rel_ext unit_rel Id"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> code_blue_dfs_ahs <span class="free">Gi</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">prpl</span><span class="main">.</span> <span class="main">¬</span>b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">prpl</span>
    <span class="main">|</span> Some <span class="bound">L</span> <span class="main">⇒</span> b_graph.is_lasso_prpl <span class="free">G</span> <span class="bound">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> code_blue_dfs_ahs_correct<span class="main">[</span><span class="operator">OF</span> G REL<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Export for benchmarking›</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> acc_of_list_impl_hash<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> 
    ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"nat set"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⟨</span>nat_rel<span class="main">⟩</span>iam_set_rel"</span></span><span class="main">]</span>

  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span><span class="main">λ</span><span class="bound">l</span><span class="main">::</span>nat list<span class="main">.</span> 
    <span class="keyword1">let</span> <span class="bound">s</span><span class="main">=</span><span class="main">(</span>set <span class="bound">l</span><span class="main">)</span><span class="keyword1">:::<span class="hidden">⇩</span><sub>r</sub></span><span class="main">⟨</span>nat_rel<span class="main">⟩</span>iam_set_rel 
    <span class="keyword1">in</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="bound">s</span><span class="main">)</span>
  <span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">acc_of_list_impl_hash</span> <span class="keyword2"><span class="keyword">uses</span></span> acc_of_list_impl_hash
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">acc_of_list_impl_hash</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">code_blue_dfs_nat</span> 
  <span class="main">≡</span> code_blue_dfs <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">×</span> <span class="main">_</span><span class="main">)</span> option"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">code_blue_dfs_hash_nat</span> 
  <span class="main">≡</span> code_blue_dfs_hash <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">×</span> <span class="main">_</span><span class="main">)</span> option"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">code_blue_dfs_ahs_nat</span> 
  <span class="main">≡</span> code_blue_dfs_ahs <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">×</span> <span class="main">_</span><span class="main">)</span> option"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ_of_list_impl_int</span> <span class="main">≡</span> 
  succ_of_list_impl <span class="keyword1">o</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nat_of_integer <span class="bound">u</span><span class="main">,</span> nat_of_integer <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">acc_of_list_impl_hash_int</span> <span class="main">≡</span> 
  acc_of_list_impl_hash <span class="keyword1">o</span> map nat_of_integer"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> 
  <span class="quoted"><span class="quoted">code_blue_dfs_nat</span></span> 
  <span class="quoted"><span class="quoted">code_blue_dfs_hash_nat</span></span>
  <span class="quoted"><span class="quoted">code_blue_dfs_ahs_nat</span></span>
  <span class="quoted"><span class="quoted">succ_of_list_impl_int</span></span>
  <span class="quoted"><span class="quoted">acc_of_list_impl_hash_int</span></span>
  <span class="quoted"><span class="quoted">nat_of_integer</span></span>
  <span class="quoted"><span class="quoted">integer_of_nat</span></span>
  <span class="quoted"><span class="quoted">lasso_ext</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> HPY_new_hash
  <span class="keyword2"><span class="keyword">file</span></span> <span class="quoted">‹nested_dfs_hash.sml›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CAVA_Abstract">
<div class="head">
<h1>Theory CAVA_Abstract</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract Model-Checker›</span></span>
<span class="keyword1"><span class="command">theory</span></span> CAVA_Abstract
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../CAVA_Base/CAVA_Base.html">CAVA_Base.CAVA_Base</a>
  <a href="../CAVA_Automata/Automata.html">CAVA_Automata.Automata</a>
  <a href="../LTL/LTL.html">LTL.LTL</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory defines the abstract version of the cava model checker, 
  as well as a generic implementation.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification of an LTL Model-Checker›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Abstractly, an LTL model-checker consists of three components:
  \begin{enumerate}
    \item A conversion of LTL-formula to Indexed Generalized Buchi Automata 
      (IGBA) over sets of atomic propositions.       
    \item An intersection construction, which takes a system and an IGBA, and 
      creates an Indexed Generalized Buchi Graph (IGBG) and a projection 
      function to project runs of the IGBG back to runs of the system.
    \item An emptiness check for IGBGs.
  \end{enumerate}
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given an LTL formula, the LTL to Buchi conversion
  returns a Generalized Buchi Automaton that accepts the same language.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ltl_to_gba_spec</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'prop</span> ltlc <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'q</span><span class="main">,</span> <span class="tfree">'prop</span> set<span class="main">,</span> <span class="main">_</span><span class="main">)</span> igba_rec_scheme nres"</span></span>
  <span class="comment1">― ‹Conversion of LTL formula to generalized buchi automaton›</span>  
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ltl_to_gba_spec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">gba</span><span class="main">.</span> 
    igba.lang <span class="bound">gba</span> <span class="main">=</span> language_ltlc <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> igba <span class="bound">gba</span> <span class="main">∧</span> finite <span class="main">(</span><span class="main">(</span>g_E <span class="bound">gba</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="bound">gba</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inter_spec</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'prop</span> set<span class="main">,</span><span class="main">_</span><span class="main">)</span> sa_rec_scheme 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="tfree">'prop</span> set<span class="main">,</span><span class="main">_</span><span class="main">)</span> igba_rec_scheme
  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'prod_state</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> igb_graph_rec_scheme <span class="main">×</span> <span class="main">(</span><span class="tfree">'prod_state</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span><span class="main">)</span> nres"</span></span>
  <span class="comment1">― ‹Intersection of system and IGBA›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sys</span> <span class="bound">ba</span><span class="main">.</span> <span class="free">inter_spec</span> <span class="bound">sys</span> <span class="bound">ba</span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span>sa <span class="bound">sys</span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span>finite <span class="main">(</span><span class="main">(</span>g_E <span class="bound">sys</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="bound">sys</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span>igba <span class="bound">ba</span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span>finite <span class="main">(</span><span class="main">(</span>g_E <span class="bound">ba</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="bound">ba</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    SPEC <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">G</span><span class="main">,</span><span class="bound">project</span><span class="main">)</span><span class="main">.</span> igb_graph <span class="bound">G</span> <span class="main">∧</span> finite <span class="main">(</span><span class="main">(</span>g_E <span class="bound">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="bound">G</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> 
      <span class="main">(</span><span class="main">∃</span><span class="bound">r'</span><span class="main">.</span> igb_graph.is_acc_run <span class="bound">G</span> <span class="bound">r'</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">project</span> <span class="keyword1">o</span> <span class="bound">r'</span><span class="main">)</span>
        <span class="main">⟷</span> <span class="main">(</span>graph_defs.is_run <span class="bound">sys</span> <span class="bound">r</span> <span class="main">∧</span> sa_L <span class="bound">sys</span> <span class="keyword1">o</span> <span class="bound">r</span> <span class="main">∈</span> igba.lang <span class="bound">ba</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_ce_spec</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> igb_graph_rec_scheme <span class="main">⇒</span> <span class="tfree">'q</span> word option option nres"</span></span>
  <span class="comment1">― ‹Check Generalized Buchi graph for emptiness, with optional counterexample›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">find_ce_spec</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span>igb_graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span>finite <span class="main">(</span><span class="main">(</span>g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">res</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">res</span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span>igb_graph.is_acc_run <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">|</span> Some None <span class="main">⇒</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> igb_graph.is_acc_run <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> igb_graph.is_acc_run <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">r</span>
    <span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Using the specifications from above, we can specify the essence
  of the model-checking algorithm: Convert the LTL-formula to a GBA,
  make an intersection with the system and check the result for emptiness.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">abs_model_check</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'ba_state</span> itself <span class="main">⇒</span> <span class="tfree">'ba_more</span> itself 
  <span class="main">⇒</span> <span class="tfree">'prod_state</span> itself <span class="main">⇒</span> <span class="tfree">'prod_more</span> itself
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'prop</span> set<span class="main">,</span><span class="main">_</span><span class="main">)</span> sa_rec_scheme <span class="main">⇒</span> <span class="tfree">'prop</span> ltlc 
  <span class="main">⇒</span> <span class="tfree">'s</span> word option option nres"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abs_model_check</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">gba</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'ba_state</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="tfree">'ba_more</span><span class="main">)</span> igba_rec_scheme 
      <span class="main">←</span> ltl_to_gba_spec <span class="main">(</span>Not_ltlc <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span>igba <span class="bound">gba</span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span>sa <span class="free"><span class="bound"><span class="entity">sys</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">Gprod</span><span class="main">::</span><span class="main">(</span><span class="tfree">'prod_state</span><span class="main">,</span><span class="tfree">'prod_more</span><span class="main">)</span>igb_graph_rec_scheme<span class="main">,</span> <span class="bound">map_state</span><span class="main">)</span> 
      <span class="main">←</span> inter_spec <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="bound">gba</span><span class="main">;</span>
    ASSERT <span class="main">(</span>igb_graph <span class="bound">Gprod</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">ce</span> <span class="main">←</span> find_ce_spec <span class="bound">Gprod</span><span class="main">;</span>

    <span class="keyword1">case</span> <span class="bound">ce</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> RETURN None
    <span class="main">|</span> Some None <span class="main">⇒</span> RETURN <span class="main">(</span>Some None<span class="main">)</span>
    <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> RETURN <span class="main">(</span>Some <span class="main">(</span>Some <span class="main">(</span><span class="bound">map_state</span> <span class="keyword1">o</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The main correctness theorem states that our abstract model checker
  really checks whether the system satisfies the formula, and a
  correct counterexample is returned (if any). 
  Note that, if the model does not satisfy the formula, 
  returning a counterexample is optional.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> abs_model_check_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_model_check <span class="free">T1</span> <span class="free">T2</span> <span class="free">T3</span> <span class="free">T4</span> <span class="free">sys</span> <span class="free">φ</span> <span class="main">≤</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span>sa <span class="free">sys</span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span>finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">sys</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">sys</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">res</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">res</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> sa.lang <span class="free">sys</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>
    <span class="main">|</span> Some None <span class="main">⇒</span> <span class="main">¬</span> sa.lang <span class="free">sys</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>
    <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> graph_defs.is_run <span class="free">sys</span> <span class="bound">r</span> <span class="main">∧</span> sa_L <span class="free">sys</span> <span class="main">∘</span> <span class="bound">r</span> <span class="main">∉</span> language_ltlc <span class="free">φ</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> abs_model_check_def ltl_to_gba_spec_def inter_spec_def 
    find_ce_spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> ASSERT_leI le_ASSERTI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sa.lang_def
    sa.accept_def<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> meta_eq_to_obj_eq<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> ext<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sa.accept <span class="free">sys</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> <span class="main"><span class="main">]</span></span><span class="main">)</span> 
    <span class="comment1">(* TODO: We really need an extended abs_def attribute, that digests 
      conditional definitions! *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generic Implementation›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we define a generic implementation of an LTL model checker,
  that is parameterized with implementations of its components.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ltl_rel</span> <span class="main">≡</span> Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> ltlc <span class="main">×</span> <span class="main">_</span><span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> impl_model_checker <span class="main">=</span>
  <span class="comment1">― ‹Assembly of a generic model-checker›</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sa_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sai</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'prop</span> set<span class="main">,</span><span class="tfree">'sa_more</span><span class="main">)</span> sa_rec_scheme<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">igba_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'igbai</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'q</span><span class="main">,</span> <span class="tfree">'prop</span> set<span class="main">,</span> <span class="tfree">'igba_more</span><span class="main">)</span> igba_rec_scheme<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">igbg_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'igbgi</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'sq</span><span class="main">,</span> <span class="tfree">'igbg_more</span><span class="main">)</span> igb_graph_rec_scheme<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ce_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'cei</span> <span class="main">×</span> <span class="tfree">'sq</span> word<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">mce_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'mcei</span> <span class="main">×</span> <span class="tfree">'s</span> word<span class="main">)</span> set"</span></span>
  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ltl_to_gba_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'cfg_l2b</span> <span class="main">⇒</span> <span class="tfree">'prop</span> ltlc <span class="main">⇒</span> <span class="tfree">'igbai</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">inter_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'cfg_int</span> <span class="main">⇒</span> <span class="tfree">'sai</span> <span class="main">⇒</span> <span class="tfree">'igbai</span> <span class="main">⇒</span> <span class="tfree">'igbgi</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'sq</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">find_ce_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'cfg_ce</span> <span class="main">⇒</span> <span class="tfree">'igbgi</span> <span class="main">⇒</span> <span class="tfree">'cei</span> option option"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">map_run_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'sq</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'cei</span> <span class="main">⇒</span> <span class="tfree">'mcei</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">mce_rel</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> ltl_to_gba_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span><span class="main">.</span> <span class="main">(</span><span class="free">ltl_to_gba_impl</span> <span class="bound">cfg</span><span class="main">,</span>ltl_to_gba_spec<span class="main">)</span> 
      <span class="main">∈</span> ltl_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">igba_rel</span><span class="main">⟩</span>plain_nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inter_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span><span class="main">.</span> <span class="main">(</span><span class="free">inter_impl</span> <span class="bound">cfg</span><span class="main">,</span>inter_spec<span class="main">)</span> 
      <span class="main">∈</span> <span class="free">sa_rel</span> <span class="main">→</span> <span class="free">igba_rel</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">igbg_rel</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span>Id <span class="main">→</span> Id<span class="main">)</span><span class="main">⟩</span>plain_nres_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> find_ce_refine<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cfg</span><span class="main">.</span> <span class="main">(</span><span class="free">find_ce_impl</span> <span class="bound">cfg</span><span class="main">,</span>find_ce_spec<span class="main">)</span>
      <span class="main">∈</span> <span class="free">igbg_rel</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">ce_rel</span><span class="main">⟩</span>option_rel<span class="main">⟩</span>option_rel<span class="main">⟩</span>plain_nres_rel"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> map_run_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">map_run_impl</span><span class="main">,</span><span class="keyword1">(o)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Id <span class="main">→</span> Id<span class="main">)</span> <span class="main">→</span> <span class="free">ce_rel</span> <span class="main">→</span> <span class="free">mce_rel</span>"</span></span>


<span class="keyword2"><span class="keyword">begin</span></span>


  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">cfg_l2b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg_l2b</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">cfg_int</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg_int</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">cfg_ce</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cfg_ce</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c3</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">impl_model_check</span> 
    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'cfg_l2b</span><span class="main">×</span><span class="tfree">'cfg_int</span><span class="main">×</span><span class="tfree">'cfg_ce</span><span class="main">)</span> 
      <span class="main">⇒</span> <span class="tfree">'sai</span> <span class="main">⇒</span> <span class="tfree">'prop</span> ltlc <span class="main">⇒</span> <span class="tfree">'mcei</span> option option"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">impl_model_check</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span>
      <span class="bound">ba</span> <span class="main">=</span> <span class="free">ltl_to_gba_impl</span> <span class="main">(</span>cfg_l2b <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span> <span class="main">(</span>Not_ltlc <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">G</span><span class="main">,</span><span class="bound">map_q</span><span class="main">)</span> <span class="main">=</span> <span class="free">inter_impl</span> <span class="main">(</span>cfg_int <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sys</span></span></span> <span class="bound">ba</span><span class="main">;</span>
      <span class="bound">ce</span> <span class="main">=</span> <span class="free">find_ce_impl</span> <span class="main">(</span>cfg_ce <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span> <span class="bound">G</span>
    <span class="keyword1">in</span>
      <span class="keyword1">case</span> <span class="bound">ce</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> None
      <span class="main">|</span> Some None <span class="main">⇒</span> Some None
      <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">ce</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>Some <span class="main">(</span><span class="free">map_run_impl</span> <span class="bound">map_q</span> <span class="bound">ce</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">lemma</span></span> impl_model_check_refine<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>impl_model_check <span class="free">cfg</span><span class="main">,</span>abs_model_check 
        <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'q</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'igba_more</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'sq</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'igbg_more</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">∈</span> <span class="free">sa_rel</span> <span class="main">→</span> ltl_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">mce_rel</span><span class="main">⟩</span>option_rel<span class="main">⟩</span>option_rel<span class="main">⟩</span>plain_nres_rel"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI plain_nres_relI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_model_check_def impl_model_check_def

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> let_to_bind_conv pull_out_let_conv 
      pull_out_RETURN_case_option<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span>
      ltl_to_gba_refine<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> plain_nres_relD<span class="main"><span class="main">]</span></span>
      rel_arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Not_ltlc"</span></span><span class="main"><span class="main">]</span></span>
      inter_refine<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> plain_nres_relD<span class="main"><span class="main">]</span></span>
      find_ce_refine<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> plain_nres_relD<span class="main"><span class="main">]</span></span>
    <span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option_relE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">parametricity</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_run_refine<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">theorem</span></span> impl_model_check_correct<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sysi</span><span class="main">,</span><span class="free">sys</span><span class="main">)</span><span class="main">∈</span><span class="free">sa_rel</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sa <span class="free">sys</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">sys</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">sys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> impl_model_check <span class="free">cfg</span> <span class="free">sysi</span> <span class="free">φ</span> <span class="keyword1">of</span>
      None 
        <span class="main">⇒</span> sa.lang <span class="free">sys</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>
    <span class="main">|</span> Some None 
        <span class="main">⇒</span> <span class="main">¬</span> sa.lang <span class="free">sys</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>
    <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">ri</span><span class="main">)</span> 
        <span class="main">⇒</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">ri</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span><span class="main">∈</span><span class="free">mce_rel</span> 
           <span class="main">∧</span> graph_defs.is_run <span class="free">sys</span> <span class="bound">r</span> <span class="main">∧</span> sa_L <span class="free">sys</span> <span class="keyword1">o</span> <span class="bound">r</span> <span class="main">∉</span> language_ltlc <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> impl_model_check_refine<span class="main">[</span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cfg<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">cfg</span></span><span class="main">,</span>
      <span class="operator">param_fo</span><span class="main">,</span> 
      <span class="operator">THEN</span> plain_nres_relD<span class="main">,</span> 
      <span class="operator">OF</span> R IdI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> abs_model_check_correct
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option_relE<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">theorem</span></span> impl_model_check_correct_no_ce<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sysi</span><span class="main">,</span><span class="free">sys</span><span class="main">)</span><span class="main">∈</span><span class="free">sa_rel</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> SA<span class="main">:</span> <span class="quoted"><span class="quoted">"sa <span class="free">sys</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">sys</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">sys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"impl_model_check <span class="free">cfg</span> <span class="free">sysi</span> <span class="free">φ</span> <span class="main">=</span> None 
    <span class="main">⟷</span> sa.lang <span class="free">sys</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> impl_model_check_correct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> cfg<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">cfg</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sa.lang_def<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SA<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> sa.accept_def<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SA<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BoolProgs">
<div class="head">
<h1>Theory BoolProgs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Boolean Programs›</span></span>
<span class="keyword1"><span class="command">theory</span></span> BoolProgs
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../CAVA_Base/CAVA_Base.html">CAVA_Base.CAVA_Base</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax and Semantics›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> bexp <span class="main">=</span> TT <span class="main">|</span> FF <span class="main">|</span> V <span class="quoted">nat</span> <span class="main">|</span> Not <span class="quoted">bexp</span> <span class="main">|</span> And <span class="quoted">bexp</span> <span class="quoted">bexp</span> <span class="main">|</span> Or <span class="quoted">bexp</span> <span class="quoted">bexp</span>

<span class="keyword1"><span class="command">type_synonym</span></span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"bitset"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bexp <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bval</span> TT <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bval</span> FF <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bval</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> bs_mem <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bval</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">bval</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bval</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">bval</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&amp;</span> <span class="free">bval</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bval</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">bval</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">|</span> <span class="free">bval</span> <span class="free"><span class="bound"><span class="entity">b<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> instr <span class="main">=</span>
  AssI <span class="quoted"><span class="quoted">"nat list"</span></span> <span class="quoted"><span class="quoted">"bexp list"</span></span> <span class="main">|</span>
  TestI <span class="quoted">bexp</span> <span class="quoted">int</span> <span class="main">|</span>
  ChoiceI <span class="quoted"><span class="quoted">"<span class="main">(</span>bexp <span class="main">*</span> int<span class="main">)</span> list"</span></span> <span class="main">|</span>
  GotoI <span class="quoted">int</span>

<span class="keyword1"><span class="command">type_synonym</span></span> config <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">*</span> state"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> bprog <span class="main">=</span> <span class="quoted"><span class="quoted">"instr array"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Semantics Notice:
  To be equivalent in semantics with SPIN, there is no such thing as a
  finite run:
  \begin{itemize}
    \item Deadlocks (i.e. empty Choice) are self-loops
    \item program termination is self-loop
  \end{itemize}
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"instr <span class="main">⇒</span> config <span class="main">⇒</span> config list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec</span> <span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="keyword1">of</span>
  AssI <span class="bound">ns</span> <span class="bound">bs</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">bvs</span> <span class="main">=</span> zip <span class="bound">ns</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> bval <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">in</span>
               <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">bv</span><span class="main">)</span><span class="main">.</span> set_bit <span class="bound">s</span> <span class="bound">n</span> <span class="bound">bv</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">bvs</span><span class="main">)</span><span class="main">]</span> <span class="main">|</span>
  TestI <span class="bound">b</span> <span class="bound">d</span> <span class="main">⇒</span> <span class="main">[</span><span class="keyword1">if</span> bval <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>nat<span class="main">(</span>int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="bound">d</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">]</span> <span class="main">|</span>
  ChoiceI <span class="bound">bis</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">succs</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>nat<span class="main">(</span>int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>b<span class="main">,</span>i<span class="main">)</span> <span class="main">&lt;-</span> <span class="bound">bis</span><span class="main">,</span> bval <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span> 
                <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">succs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">]</span> <span class="keyword1">else</span> <span class="bound">succs</span> <span class="main">|</span>
  GotoI <span class="bound">d</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">(</span>nat<span class="main">(</span>int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="bound">d</span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="comment1">(* exec' is merely a stuttering optimization. It summarizes chains of choices
  or jumps, as long as they go forward in the program. The forward-condition is
  to ensure termination. 

  TODO: Make this explicit, and prove stuttering equivalence!
*)</span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">exec'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bprog <span class="main">⇒</span> state <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exec'</span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> array_length <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="main">(</span>array_get <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      AssI <span class="bound">ns</span> <span class="bound">bs</span> <span class="main">⇒</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">]</span> <span class="main">|</span>
      TestI <span class="bound">b</span> <span class="bound">d</span> <span class="main">⇒</span> <span class="main">(</span>
        <span class="keyword1">if</span> bval <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free">exec'</span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> 
        <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">pc'</span><span class="main">=</span><span class="main">(</span>nat<span class="main">(</span>int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">pc'</span><span class="main">&gt;</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="keyword1">then</span> <span class="free">exec'</span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">pc'</span>
        <span class="keyword1">else</span> <span class="main">[</span><span class="bound">pc'</span><span class="main">]</span>
      <span class="main">)</span> <span class="main">|</span>
      ChoiceI <span class="bound">bis</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">succs</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span>nat<span class="main">(</span>int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>b<span class="main">,</span>i<span class="main">)</span> <span class="main">&lt;-</span> <span class="bound">bis</span><span class="main">,</span> bval <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span>
                    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">succs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">]</span> <span class="keyword1">else</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">pc'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">pc'</span><span class="main">&gt;</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="keyword1">then</span> <span class="free">exec'</span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">pc'</span> <span class="keyword1">else</span> <span class="main">[</span><span class="bound">pc'</span><span class="main">]</span><span class="main">)</span> <span class="bound">succs</span><span class="main">)</span> <span class="main">|</span>
      GotoI <span class="bound">d</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">pc'</span> <span class="main">=</span> nat<span class="main">(</span>int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="bound">d</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">pc'</span><span class="main">&gt;</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="keyword1">then</span> <span class="free">exec'</span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">pc'</span> <span class="keyword1">else</span> <span class="main">[</span><span class="bound">pc'</span><span class="main">]</span><span class="main">)</span>
  <span class="main">)</span> <span class="keyword1">else</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">]</span>
<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">%</span><span class="main">(</span><span class="bound">ins</span><span class="main">,</span><span class="bound">s</span><span class="main">,</span><span class="bound">pc</span><span class="main">)</span><span class="main">.</span> array_length <span class="bound">ins</span> <span class="main">-</span> <span class="bound">pc</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nexts1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bprog <span class="main">⇒</span> config <span class="main">⇒</span> config list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nexts1</span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span> <span class="main">&lt;</span> array_length <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="keyword1">then</span> 
    exec <span class="main">(</span>array_get <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> 
  <span class="keyword1">else</span> 
    <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nexts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bprog <span class="main">⇒</span> config <span class="main">⇒</span> config list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nexts</span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>
    map 
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pc</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">pc</span><span class="main">.</span> <span class="main">(</span><span class="bound">pc</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>exec' <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="bound">s</span> <span class="bound">pc</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>nexts1 <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pc</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> nexts.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">datatype</span></span>
  com <span class="main">=</span> SKIP
      <span class="main">|</span> Assign <span class="quoted"><span class="quoted">"nat list"</span></span> <span class="quoted"><span class="quoted">"bexp list"</span></span>    
      <span class="main">|</span> Seq    <span class="quoted">com</span>  <span class="quoted">com</span>         
      <span class="main">|</span> GC  <span class="quoted"><span class="quoted">"<span class="main">(</span>bexp <span class="main">*</span> com<span class="main">)</span>list"</span></span>  
      <span class="main">|</span> IfTE  <span class="quoted">bexp</span> <span class="quoted">com</span> <span class="quoted">com</span>      
      <span class="main">|</span> While  <span class="quoted">bexp</span> <span class="quoted">com</span>         

<span class="keyword1"><span class="command">locale</span></span> BoolProg_Syntax <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">notation</span></span> 
        Assign       <span class="main">(</span><span class="quoted">"_ <span class="keyword1">::=</span> _"</span> <span class="main">[</span>999<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> Seq          <span class="main">(</span><span class="quoted">"_<span class="keyword1">;</span><span class="keyword3">/ </span>_"</span>  <span class="main">[</span>60<span class="main">,</span> 61<span class="main">]</span> 60<span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> GC           <span class="main">(</span><span class="quoted">"<span class="keyword1">IF</span> _ <span class="keyword1">FI</span>"</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> IfTE         <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">IF</span> _<span class="keyword3">/ </span><span class="keyword1">THEN</span> _<span class="keyword3">/ </span><span class="keyword1">ELSE</span> _<span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 61<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> While        <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">WHILE</span> _<span class="keyword3">/ </span><span class="keyword1">DO</span> _<span class="keyword3">)</span>"</span>  <span class="main">[</span>0<span class="main">,</span> 61<span class="main">]</span> 61<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> BoolProg_Syntax <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">comp'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> instr list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">comp'</span> SKIP <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">comp'</span> <span class="main">(</span>Assign <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>AssI <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">comp'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">comp'</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">@</span> <span class="free">comp'</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">comp'</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">gcs</span></span></span> <span class="keyword1">FI</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">cgcs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="free">comp'</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">gcs</span></span></span> <span class="keyword1">in</span>
   <span class="keyword1">let</span> <span class="bound">addbc</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">cc</span><span class="main">)</span> <span class="main">(</span><span class="bound">bis</span><span class="main">,</span><span class="bound">ins</span><span class="main">)</span><span class="main">.</span>
         <span class="keyword1">let</span> <span class="bound">cc'</span> <span class="main">=</span> <span class="bound">cc</span> <span class="main">@</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">ins</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span>GotoI <span class="main">(</span>int<span class="main">(</span>length <span class="bound">ins</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">in</span>
         <span class="keyword1">let</span> <span class="bound">bis'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">i</span> <span class="main">+</span> int<span class="main">(</span>length <span class="bound">cc'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">bis</span>
         <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">#</span><span class="bound">bis'</span><span class="main">,</span> <span class="bound">cc'</span> <span class="main">@</span> <span class="bound">ins</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
   <span class="keyword1">let</span> <span class="main">(</span><span class="bound">bis</span><span class="main">,</span><span class="bound">ins</span><span class="main">)</span> <span class="main">=</span> foldr <span class="bound">addbc</span> <span class="bound">cgcs</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>
   <span class="keyword1">in</span> ChoiceI <span class="bound">bis</span> <span class="main">#</span> <span class="bound">ins</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">comp'</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ins1</span> <span class="main">=</span> <span class="free">comp'</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">in</span> <span class="keyword1">let</span> <span class="bound">ins2</span> <span class="main">=</span> <span class="free">comp'</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="keyword1">in</span>
   <span class="keyword1">let</span> <span class="bound">i1</span> <span class="main">=</span> int<span class="main">(</span>length <span class="bound">ins1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">let</span> <span class="bound">i2</span> <span class="main">=</span> int<span class="main">(</span>length <span class="bound">ins2</span><span class="main">)</span>
   <span class="keyword1">in</span> TestI <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">i1</span> <span class="main">#</span> <span class="bound">ins1</span> <span class="main">@</span> GotoI <span class="bound">i2</span> <span class="main">#</span> <span class="bound">ins2</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">comp'</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ins</span> <span class="main">=</span> <span class="free">comp'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">in</span>
   <span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> int<span class="main">(</span>length <span class="bound">ins</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
   <span class="keyword1">in</span> TestI <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">i</span> <span class="main">#</span> <span class="bound">ins</span> <span class="main">@</span> <span class="main">[</span>GotoI <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="comment1">(* a test: *)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"comp' <span class="main">(</span><span class="keyword1">IF</span> <span class="main">[</span><span class="main">(</span>V <span class="main">0</span><span class="main">,</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>TT<span class="main">,</span> FF<span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>V <span class="main">1</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>TT<span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">FI</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> bprog"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">comp</span> <span class="main">=</span> array_of_list <span class="main">∘</span> comp'"</span></span>

<span class="comment1">(* 
  Optimization

- Gotos: Resolve Goto-Chains: If a Goto referres to another Goto -- add the second offset to the first one. 
                              If a Goto has a negative offset ignore it, to avoid problems with loops.

*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">opt'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt'</span> <span class="main">(</span>GotoI <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">next</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> GotoI <span class="bound">d</span> <span class="main">⇒</span> <span class="bound">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>
                        <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> nat <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≥</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>GotoI <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span>
                           <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">d'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">+</span> <span class="bound">next</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">!</span> nat <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>
                           <span class="keyword1">in</span> <span class="main">(</span>GotoI <span class="bound">d'</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">opt'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"instr list <span class="main">⇒</span> instr list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="main">=</span> foldr opt' <span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">optcomp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> bprog"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">optcomp</span> <span class="main">≡</span> array_of_list <span class="main">∘</span> opt <span class="main">∘</span> comp'"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finiteness of reachable configurations›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">reachable_configs</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">bp</span> <span class="main">::</span> <span class="quoted">bprog</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">c<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted">config</span> <span class="comment1">― ‹start configuration›</span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">∈</span> <span class="free">reachable_configs</span> <span class="free">bp</span> <span class="free">c<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> <span class="free">reachable_configs</span> <span class="free">bp</span> <span class="free">c<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="main">(</span>nexts <span class="free">bp</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">reachable_configs</span> <span class="free">bp</span> <span class="free">c<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> reachable_configs_induct <span class="main">=</span> reachable_configs.induct<span class="main">[</span><span class="operator">split_format</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">complete</span><span class="main"><span class="main">)</span></span><span class="main">,</span><span class="operator">case_names</span> 0 1<span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">offsets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"instr <span class="main">⇒</span> int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offsets</span> <span class="main">(</span>AssI <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">offsets</span> <span class="main">(</span>TestI <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">offsets</span> <span class="main">(</span>ChoiceI <span class="free"><span class="bound"><span class="entity">bis</span></span></span><span class="main">)</span> <span class="main">=</span> set<span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">bis</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">offsets</span> <span class="main">(</span>GotoI <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">offsets_is</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"instr list <span class="main">⇒</span> int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offsets_is</span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">instr</span> <span class="main">:</span> set <span class="free"><span class="bound"><span class="entity">ins</span></span></span><span class="main">.</span> offsets <span class="bound">instr</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_next_pcs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"instr list <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">max_next_pcs</span> <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="main">=</span> <span class="main">{</span>nat<span class="main">(</span>int<span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ins</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">:</span> offsets_is <span class="free"><span class="bound"><span class="entity">ins</span></span></span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> finite_max_next_pcs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite<span class="main">(</span>max_next_pcs <span class="free">bp</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">instr</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>offsets <span class="skolem">instr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">instr</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ins</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_next_pcs <span class="skolem">ins</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">UN</span> <span class="bound">i</span> <span class="main">:</span> offsets_is <span class="skolem">ins</span><span class="main">.</span> <span class="main">{</span>nat<span class="main">(</span>int<span class="main">(</span>length <span class="skolem">ins</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_next_pcs_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offsets_is_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder<span class="main">)</span> le_Max_insertI1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">A</span><span class="main">;</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> Max <span class="main">(</span>insert <span class="free">b</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_ge finite.insertI insert_iff order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder<span class="main">)</span> le_Max_insertI2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">A</span><span class="main">;</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="free">x</span> <span class="main">≤</span> Max <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> Max <span class="main">(</span>insert <span class="free">b</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def not_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Max_less_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_next_pcs_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">pc</span><span class="main">&lt;</span>length <span class="free">bp</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">:</span> set <span class="main">(</span>exec <span class="main">(</span><span class="free">bp</span><span class="main">!</span><span class="free">pc</span><span class="main">)</span> <span class="main">(</span><span class="free">pc</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> max_next_pcs <span class="free">bp</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> nth_mem<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_next_pcs_def offsets_is_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> instr.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_lem2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> length <span class="free">bp</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pc'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>exec <span class="main">(</span><span class="free">bp</span><span class="main">!</span><span class="free">pc</span><span class="main">)</span> <span class="main">(</span><span class="free">pc</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc'</span> <span class="main">≤</span> Max <span class="main">(</span>max_next_pcs <span class="free">bp</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">bp</span> <span class="main">!</span> <span class="free">pc</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ChoiceI <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pc'</span> <span class="main">=</span> <span class="free">pc</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assms ChoiceI <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_ge_iff max_next_pcs_not_empty finite_max_next_pcs<span class="main">)</span> 
         <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_next_pcs_def offsets_is_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> ChoiceI assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      bi<span class="main">:</span> <span class="quoted"><span class="quoted">"bval <span class="skolem">b</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc'</span> <span class="main">=</span> nat<span class="main">(</span>int<span class="main">(</span><span class="free">pc</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ChoiceI assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>offsets <span class="main">`</span> <span class="main">(</span>set <span class="free">bp</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bi assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">∈</span> max_next_pcs <span class="free">bp</span> <span class="main">∧</span> <span class="free">pc'</span> <span class="main">≤</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> max_next_pcs_def offsets_is_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_ge_iff max_next_pcs_not_empty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> finite_max_next_pcs<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_ge_iff max_next_pcs_not_empty finite_max_next_pcs<span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_next_pcs_def offsets_is_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nth_mem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_lem1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">pc</span> <span class="main">&lt;</span> length <span class="free">bp</span><span class="main">;</span> <span class="main">(</span><span class="free">pc'</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>exec <span class="main">(</span><span class="free">bp</span> <span class="main">!</span> <span class="free">pc</span><span class="main">)</span> <span class="main">(</span><span class="free">pc</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">pc'</span> <span class="main">≤</span> Max <span class="main">(</span>insert <span class="free">x</span> <span class="main">(</span>max_next_pcs <span class="free">bp</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> le_Max_insertI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_max_next_pcs<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_next_pcs_not_empty<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_lem2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>exec.simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc_bound</span> <span class="free"><span class="bound"><span class="entity">bp</span></span></span> <span class="main">≡</span> max 
    <span class="main">(</span>Max <span class="main">(</span>max_next_pcs <span class="main">(</span>list_of_array <span class="free"><span class="bound"><span class="entity">bp</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
    <span class="main">(</span>array_length <span class="free"><span class="bound"><span class="entity">bp</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> exec'.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>list_of_array <span class="free">a</span><span class="main">)</span> <span class="main">=</span> array_length <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> aux2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> array_length <span class="free">ins</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ofs</span> <span class="main">∈</span> offsets_is <span class="main">(</span>list_of_array <span class="free">ins</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">1</span> <span class="main">+</span> int <span class="free">pc</span> <span class="main">+</span> <span class="free">ofs</span><span class="main">)</span> <span class="main">&lt;</span> pc_bound <span class="free">ins</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>int <span class="main">(</span><span class="main">1</span> <span class="main">+</span> array_length <span class="free">ins</span><span class="main">)</span> <span class="main">+</span> <span class="free">ofs</span><span class="main">)</span> 
    <span class="main">∈</span> max_next_pcs <span class="main">(</span>list_of_array <span class="free">ins</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">unfolding</span></span> max_next_pcs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pc_bound_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> max.strict_coboundedI1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> Max_ge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_max_next_pcs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> array_idx_in_set<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">pc</span> <span class="main">&lt;</span> array_length <span class="free">ins</span><span class="main">;</span> array_get <span class="free">ins</span> <span class="free">pc</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>list_of_array <span class="free">ins</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ins</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rcs_aux<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> pc_bound <span class="free">bp</span>"</span></span>    
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc'</span><span class="main">∈</span>set <span class="main">(</span>exec' <span class="free">bp</span> <span class="free">s</span> <span class="free">pc</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">pc'</span> <span class="main">&lt;</span> pc_bound <span class="free">bp</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bp</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">pc</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">pc'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec'.induct<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>C <span class="skolem">ins</span> <span class="skolem">s</span> <span class="skolem">pc</span> <span class="skolem">pc'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> C.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> exec'.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> if_split_asm instr.split_asm<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pc_bound_def<span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> C.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pc_bound_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> C.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> bexp int<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">int</span> <span class="main">∈</span> offsets_is <span class="main">(</span>list_of_array <span class="skolem">ins</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> aux2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> offsets_is_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"TestI <span class="improper">bexp</span> <span class="improper">int</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> array_idx_in_set<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> C.IH<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">ba</span> <span class="main">∈</span> offsets_is <span class="main">(</span>list_of_array <span class="skolem">ins</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> aux2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> offsets_is_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ChoiceI <span class="improper">list</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> array_idx_in_set<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> int<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> C.IH<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">int</span> <span class="main">∈</span> offsets_is <span class="main">(</span>list_of_array <span class="skolem">ins</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> aux2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> offsets_is_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"GotoI <span class="improper">int</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> array_idx_in_set<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">bexp_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bexp <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> TT <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> FF <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">∪</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bexp_vars</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">∪</span> <span class="free">bexp_vars</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">instr_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"instr <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">instr_vars</span> <span class="main">(</span>AssI <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">(</span>bexp_vars<span class="main">`</span>set <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">instr_vars</span> <span class="main">(</span>TestI <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> bexp_vars <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">instr_vars</span> <span class="main">(</span>ChoiceI <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>bexp_vars<span class="main">`</span>fst<span class="main">`</span>set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">instr_vars</span> <span class="main">(</span>GotoI <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">find_consts</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> array <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bprog_vars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bprog <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">bprog_vars</span> <span class="free"><span class="bound"><span class="entity">bp</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>instr_vars<span class="main">`</span>set <span class="main">(</span>list_of_array <span class="free"><span class="bound"><span class="entity">bp</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">state_bound</span> <span class="free"><span class="bound"><span class="entity">bp</span></span></span> <span class="free"><span class="bound"><span class="entity">s0</span></span></span> 
  <span class="main">≡</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> bs_α <span class="bound">s</span> <span class="main">-</span> bprog_vars <span class="free"><span class="bound"><span class="entity">bp</span></span></span> <span class="main">=</span> bs_α <span class="free"><span class="bound"><span class="entity">s0</span></span></span> <span class="main">-</span> bprog_vars <span class="free"><span class="bound"><span class="entity">bp</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">config_bound</span> <span class="free"><span class="bound"><span class="entity">bp</span></span></span> <span class="free"><span class="bound"><span class="entity">s0</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> pc_bound <span class="free"><span class="bound"><span class="entity">bp</span></span></span><span class="main">}</span> <span class="main">×</span> state_bound <span class="free"><span class="bound"><span class="entity">bp</span></span></span> <span class="free"><span class="bound"><span class="entity">s0</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exec_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PCB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> array_length <span class="free">bp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> state_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>exec <span class="main">(</span>array_get <span class="free">bp</span> <span class="free">pc</span><span class="main">)</span> <span class="main">(</span><span class="free">pc</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> config_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> exec.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">instrs</span></span> <span class="keyword2"><span class="keyword">where</span></span> BP_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bp</span> <span class="main">=</span> Array <span class="skolem">instrs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">bp</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> PCB <span class="keyword1"><span class="command">have</span></span> PCB'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pc</span> <span class="main">&lt;</span> length <span class="skolem">instrs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pc'</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pc'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>exec <span class="main">(</span>array_get <span class="free">bp</span> <span class="free">pc</span><span class="main">)</span> <span class="main">(</span><span class="free">pc</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> STEP'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pc'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>exec <span class="main">(</span><span class="skolem">instrs</span><span class="main">!</span><span class="free">pc</span><span class="main">)</span> <span class="main">(</span><span class="free">pc</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pc'</span> <span class="main">&lt;</span> pc_bound <span class="free">bp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_lem2<span class="main">[</span><span class="operator">OF</span> PCB' STEP'<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> pc_bound_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> state_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> STEP' SB
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">instrs</span><span class="main">!</span><span class="free">pc</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AssI <span class="skolem">xs</span> <span class="skolem">vs</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> instr_vars <span class="main">(</span><span class="skolem">instrs</span><span class="main">!</span><span class="free">pc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AssI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> bprog_vars <span class="free">bp</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bprog_vars_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> PCB' UN_upper nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> XSB<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> bprog_vars <span class="free">bp</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>


    <span class="keyword1"><span class="command">{</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">s</span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> bprog_vars <span class="free">bp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> state_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> SB_CNV<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_α <span class="main">(</span>set_bit <span class="skolem">s</span> <span class="skolem">x</span> <span class="skolem">v</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">v</span> <span class="keyword1">then</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>bs_α <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>bs_α <span class="skolem">s</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> bs_insert_def bs_delete_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bs_correct<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_bit <span class="skolem">s</span> <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">∈</span> state_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> state_bound_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SB_CNV<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux<span class="main">=</span>this

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> set_bit <span class="bound">s</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">s</span> <span class="main">(</span>zip <span class="skolem">xs</span> <span class="skolem">vs</span><span class="main">)</span> 
        <span class="main">∈</span> state_bound <span class="main">(</span>Array <span class="skolem">instrs</span><span class="main">)</span> <span class="free">s0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> SB XSB
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">vs</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">vs</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> aux
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux2<span class="main">=</span>this

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> STEP'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> AssI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_bound_step<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> exec.simps
  <span class="keyword2"><span class="keyword">assumes</span></span> BOUND<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> config_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> STEP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c'</span><span class="main">∈</span>set <span class="main">(</span>nexts <span class="free">bp</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">∈</span> config_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> BOUND STEP
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nexts.simps 
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> exec_bound<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rcs_aux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> exec_bound<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rcs_aux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_configs_in_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> config_bound <span class="free">bp</span> <span class="free">s0</span> <span class="main">⟹</span> reachable_configs <span class="free">bp</span> <span class="free">c</span> <span class="main">⊆</span> config_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> reachable_configs <span class="free">bp</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> config_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">∈</span> config_bound <span class="free">bp</span> <span class="free">s0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_bound_step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> reachable_configs_out_of_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pc'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span>reachable_configs <span class="free">bp</span> <span class="main">(</span><span class="free">pc</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="main">¬</span> <span class="free">pc</span> <span class="main">&lt;</span> pc_bound <span class="free">bp</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">pc'</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">pc</span><span class="main">,</span><span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reachable_configs_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">pc'</span> <span class="skolem">s'</span> <span class="skolem">pc''</span> <span class="skolem">s''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc'</span><span class="main">=</span><span class="free">pc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span><span class="main">=</span><span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">pc</span> <span class="main">&lt;</span> array_length <span class="free">bp</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pc_bound_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nexts.simps exec'.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_bexp_vars<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bexp_vars <span class="free">be</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">be</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_instr_vars<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>instr_vars <span class="free">ins</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ins</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_bprog_vars<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>bprog_vars <span class="free">bp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bprog_vars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_state_bound<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>state_bound <span class="free">bp</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_bound_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">bs_α</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
    B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">-</span> bprog_vars <span class="free">bp</span> <span class="main">=</span> bs_α <span class="free">s0</span> <span class="main">-</span> bprog_vars <span class="free">bp</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_if_eq_beyond_finite<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> bs_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs_eq_correct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_config_bound<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>config_bound <span class="free">bp</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_configs_finite<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reachable_configs <span class="free">bp</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pc</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reachable_configs <span class="free">bp</span> <span class="main">(</span><span class="skolem">pc</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">pc</span> <span class="main">&lt;</span> pc_bound <span class="free">bp</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">from</span></span> reachable_configs_out_of_bound<span class="main">[</span><span class="operator">OF</span> _ False<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable_configs <span class="free">bp</span> <span class="main">(</span><span class="skolem">pc</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pc</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> config_bound <span class="free">bp</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_bound_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> reachable_configs_in_bound<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bpc_is_run</span> <span class="free"><span class="bound"><span class="entity">bpc</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">bp</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">bpc</span></span></span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>BoolProgs.nexts <span class="bound">bp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bpc_props</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> bs_α <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bpc_lang</span> <span class="free"><span class="bound"><span class="entity">bpc</span></span></span> <span class="main">≡</span> <span class="main">{</span>bpc_props <span class="keyword1">o</span> <span class="bound">r</span> <span class="main">|</span> <span class="bound">r</span><span class="main">.</span> bpc_is_run <span class="free"><span class="bound"><span class="entity">bpc</span></span></span> <span class="bound">r</span><span class="main">}</span>"</span></span>

<span class="comment1">(* Printing *)</span>
<span class="comment1">(*definition print_list where
  "print_list f sep s = (let f' = (λstr s. if str = [] then f s
                                       else str @ sep @ f s)
                     in ''['' @ (foldl f' [] s) @ '']'')"

fun bool_list_to_prop_list where
  "bool_list_to_prop_list _ [] props = props"
| "bool_list_to_prop_list n (x#xs) props = (let props' = if x then n#props else props 
                                            in bool_list_to_prop_list (Suc n) xs props')"
*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">print_config</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> string<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>bitset <span class="main">⇒</span> string<span class="main">)</span> <span class="main">⇒</span> config <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">print_config</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">fx</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">@</span> <span class="inner_quoted">'' ''</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">fx</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BoolProgs_Extras">
<div class="head">
<h1>Theory BoolProgs_Extras</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BoolProgs_Extras
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="BoolProgs.html">BoolProgs</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> BoolProg_Syntax <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Macros›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Counters ≈ bounded natural numbers›</span></span>

<span class="comment1">(* Vars: offset, number of vars, value *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">set_counter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> bexp list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_counter</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">set_counter</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">set_counter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">(</span>FF<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">set_counter</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">set_counter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">(</span>TT<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="comment1">(* Vars: offset, number of vars, value to compare to *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">counter_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">counter_eq</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> FF <span class="keyword1">else</span>
                           <span class="keyword1">let</span> <span class="bound">posT</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span> <span class="keyword1">in</span>
                           <span class="keyword1">let</span> <span class="bound">posF</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span> <span class="keyword1">in</span>
                           <span class="keyword1">let</span> <span class="bound">bexps</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> V <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="bound">posT</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Not <span class="main">(</span>V <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">posF</span><span class="main">)</span> <span class="keyword1">in</span>
                           foldl And TT <span class="bound">bexps</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Vars: offset, number of vars *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inc_counter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> bexp list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inc_counter</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">inc_counter</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">IF</span> V <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">THEN</span> <span class="free">inc_counter</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">ELSE</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">::=</span> <span class="main">(</span>TT<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dec_counter_toggle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> bexp list <span class="main">⇒</span> bool <span class="main">⇒</span> nat <span class="main">⇒</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">dec_counter_toggle</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> False <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>
<span class="main">|</span><span class="quoted"><span class="quoted">"<span class="free">dec_counter_toggle</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> True <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">::=</span> <span class="main">(</span>FF<span class="main">#</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dec_counter'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> bexp list <span class="main">⇒</span> bool <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> com"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dec_counter'</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">start</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">0</span> <span class="main">=</span> dec_counter_toggle <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">start</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dec_counter'</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">start</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> 
                      <span class="keyword1">IF</span> Not <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span>dec_counter_toggle <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">start</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">)</span>
                      <span class="keyword1">ELSE</span> <span class="free">dec_counter'</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> True <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="comment1">(* Vars: offset, number of vars *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec_counter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> bexp list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dec_counter</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> dec_counter' <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> False"</span></span>

<span class="comment1">(* Array access via run-time variable. Emulated by checking all possible values.
Vars: ctr: function 'nat ⇒ bexp' - returns true if the counter is of a specific value
      act: function 'nat ⇒ com' - action to take with value if counter is value
        m: number of values (checked are [0,m[) *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">array_access</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_access</span> <span class="free"><span class="bound"><span class="entity">ctr</span></span></span> <span class="free"><span class="bound"><span class="entity">act</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">bexp</span> <span class="bound">c</span><span class="main">.</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">ctr</span></span></span> <span class="bound">c</span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">act</span></span></span> <span class="bound">c</span> <span class="keyword1">ELSE</span> <span class="bound">bexp</span><span class="main">)</span> SKIP <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">array_check</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">array_check</span> <span class="free"><span class="bound"><span class="entity">ctr</span></span></span> <span class="free"><span class="bound"><span class="entity">chk</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">bexp</span> <span class="bound">c</span><span class="main">.</span> And <span class="main">(</span>Or <span class="main">(</span>Not <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ctr</span></span></span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">chk</span></span></span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Or <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ctr</span></span></span> <span class="bound">c</span><span class="main">)</span> <span class="bound">bexp</span><span class="main">)</span><span class="main">)</span> FF <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Gather statistics›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stat'</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stat'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">instr</span></span></span> <span class="keyword1">of</span>
  AssI <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>
<span class="main">|</span> TestI <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span>Suc <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>
<span class="main">|</span> ChoiceI <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span>Suc <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>
<span class="main">|</span> GotoI <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>Suc <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stats</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stats</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> foldl stat' <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Misc›</span></span>
<span class="comment1">(* this is only used for the code setup in Programs/* *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> const_map <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>String.literal<span class="main">,</span> bexp<span class="main">)</span> mapping"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> fun_map <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>String.literal<span class="main">,</span> nat <span class="main">⇒</span> bexp<span class="main">)</span> mapping"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mapping_from_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapping_from_list</span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">m</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> Mapping.update <span class="bound">k</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">)</span> Mapping.empty"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BoolProgs_LTL_Conv">
<div class="head">
<h1>Theory BoolProgs_LTL_Conv</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BoolProgs_LTL_Conv
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="BoolProgs_Extras.html">BoolProgs_Extras</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span>
  <a href="../LTL/LTL.html">LTL.LTL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">b2l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bexp <span class="main">⇒</span> nat ltlc"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">b2l</span> TT <span class="main">=</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">b2l</span> FF <span class="main">=</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">b2l</span> <span class="main">(</span>bexp.V <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>c</sub>(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">b2l</span> <span class="main">(</span>bexp.Not <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">not<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">b2l</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">b2l</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">b2l</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">b2l</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">b2l</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">b2l</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">b2l</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span>
  propc <span class="main">=</span> CProp <span class="quoted">String.literal</span> <span class="main">|</span> FProp <span class="quoted"><span class="quoted">"String.literal <span class="main">*</span> integer"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_conv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"const_map <span class="main">⇒</span> fun_map <span class="main">⇒</span> propc ltlc <span class="main">⇒</span> <span class="main">(</span>nat ltlc <span class="main">+</span> String.literal<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> True_ltlc <span class="main">=</span> Inl True_ltlc"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> False_ltlc <span class="main">=</span> Inl False_ltlc"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Prop_ltlc <span class="main">(</span>CProp <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
                                              Some <span class="bound">c</span> <span class="main">⇒</span> Inl <span class="main">(</span>b2l <span class="bound">c</span><span class="main">)</span>
                                             <span class="main">|</span> None <span class="main">⇒</span> Inr <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Unknown constant: ''</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Prop_ltlc <span class="main">(</span>FProp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">argm</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
                                                    Some <span class="bound">f</span> <span class="main">⇒</span> <span class="main">(</span>Inl <span class="main">∘</span> b2l <span class="main">∘</span> <span class="bound">f</span> <span class="main">∘</span> nat_of_integer<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">argm</span></span></span>
                                                  <span class="main">|</span> None <span class="main">⇒</span> Inr <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Unknown function: ''</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Not_ltlc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">l</span> <span class="main">⇒</span> Inl <span class="main">(</span>Not_ltlc <span class="bound">l</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Next_ltlc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">l</span> <span class="main">⇒</span> Inl <span class="main">(</span>Next_ltlc <span class="bound">l</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Final_ltlc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">l</span> <span class="main">⇒</span> Inl <span class="main">(</span>Final_ltlc <span class="bound">l</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Global_ltlc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">l</span> <span class="main">⇒</span> Inl <span class="main">(</span>Global_ltlc <span class="bound">l</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>And_ltlc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> 
                                    Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span>
                                  <span class="main">|</span> Inl <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">r</span> <span class="main">⇒</span> Inl <span class="main">(</span>And_ltlc <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Or_ltlc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> 
                                    Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span>
                                  <span class="main">|</span> Inl <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">r</span> <span class="main">⇒</span> Inl <span class="main">(</span>Or_ltlc <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Implies_ltlc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> 
                                    Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span>
                                  <span class="main">|</span> Inl <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">r</span> <span class="main">⇒</span> Inl <span class="main">(</span>Implies_ltlc <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Until_ltlc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> 
                                    Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span>
                                  <span class="main">|</span> Inl <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">r</span> <span class="main">⇒</span> Inl <span class="main">(</span>Until_ltlc <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Release_ltlc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> 
                                    Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span>
                                  <span class="main">|</span> Inl <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ltl_conv</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">r</span> <span class="main">⇒</span> Inl <span class="main">(</span>Release_ltlc <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">s</span> <span class="main">⇒</span> Inr <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BoolProgs_Philosophers">
<div class="head">
<h1>Theory BoolProgs_Philosophers</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BoolProgs_Philosophers
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="BoolProgs_Extras.html">../BoolProgs_Extras</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> BoolProg_Syntax <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eat</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">one</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Eat</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> V<span class="main">(</span>eat <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Free</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Free</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> V<span class="main">(</span>free <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">One</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">One</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> V<span class="main">(</span>one <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">phil_const</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> const_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">phil_const</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> Mapping.empty"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">phil_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> fun_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">phil_fun</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> mapping_from_list <span class="main">[</span>
              <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''eat''</span><span class="main">,</span> Eat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''one''</span><span class="main">,</span> One <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''free''</span><span class="main">,</span> Free <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">]</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">phil_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">phil_init</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">i</span><span class="main">.</span> bs_insert <span class="main">(</span>free <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>bs_empty <span class="main">()</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>

<span class="comment1">(*definition phil_init :: "nat ⇒ state" where
  "phil_init n = replicate (2 * n) False @ replicate n True"
*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dining</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>bexp <span class="main">×</span> com<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">dining</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">dining</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>
  <span class="main">(</span>
   And <span class="main">(</span>Not <span class="main">(</span>Eat <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
   <span class="main">[</span>one <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> free <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>TT<span class="main">,</span> FF<span class="main">]</span>
  <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
   And <span class="main">(</span>One <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
   <span class="main">[</span>one <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> free <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> eat <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span> FF<span class="main">,</span> TT<span class="main">]</span>
  <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
   Eat <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>
   <span class="main">[</span>free <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> free <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> eat <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>TT<span class="main">,</span> TT<span class="main">,</span> FF<span class="main">]</span>
  <span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="free">dining</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">philosophers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" nat <span class="main">⇒</span> bprog <span class="main">×</span> config"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">philosophers</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>optcomp <span class="main">(</span><span class="keyword1">WHILE</span> TT <span class="keyword1">DO</span> <span class="keyword1">IF</span> dining <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">FI</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> phil_init <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> eat one free Eat Free One

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BoolProgs_ReaderWriter">
<div class="head">
<h1>Theory BoolProgs_ReaderWriter</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BoolProgs_ReaderWriter
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="BoolProgs_Extras.html">../BoolProgs_Extras</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*
   Reader/Writers case study
   adapted from BEEM library (hTTp://anna.fi.muni.cz/models/)
*)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> BoolProg_Syntax <span class="keyword1"><span class="command">.</span></span>


<span class="comment1">(* variables *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ready</span> <span class="main">≡</span> <span class="main">0</span><span class="main">::</span>nat"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">readers_active</span> <span class="main">≡</span> <span class="main">1</span><span class="main">::</span>nat"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">writers_active</span> <span class="main">≡</span> <span class="numeral">2</span><span class="main">::</span>nat"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">q_error</span> <span class="main">≡</span> <span class="numeral">3</span><span class="main">::</span>nat"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">reading</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">(</span>q_error <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">writing</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">(</span>reading <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">activeR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> writing <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_activeR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> set_counter <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>activeR <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inc_activeR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> inc_counter <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>activeR <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec_activeR</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> dec_counter <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>activeR <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">activeR_eq</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> counter_eq <span class="main">(</span>activeR <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rw_const</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> const_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rw_const</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> mapping_from_list <span class="main">[</span>
              <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''ready''</span><span class="main">,</span> V ready<span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''readers_active''</span><span class="main">,</span> V readers_active<span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''writers_active''</span><span class="main">,</span> V writers_active<span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''q_error''</span><span class="main">,</span> V q_error<span class="main">)</span> <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rw_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> fun_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rw_fun</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> mapping_from_list <span class="main">[</span>
             <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''reading''</span><span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> V <span class="main">(</span>reading <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
             <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''writing''</span><span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> V <span class="main">(</span>writing <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
             <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''activeR_eq''</span><span class="main">,</span> activeR_eq <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">]</span>"</span></span>


<span class="comment1">(* init variable list *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rw_init</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rw_init</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> bs_insert ready <span class="main">(</span>bs_empty <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="comment1">(* program *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reader_control</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reader_control</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">[</span>
     <span class="main">(</span>
      V ready<span class="main">,</span>
      <span class="main">[</span>ready<span class="main">,</span> readers_active<span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">]</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
      And <span class="main">(</span>V readers_active<span class="main">)</span> <span class="main">(</span>Not <span class="main">(</span>V <span class="main">(</span>reading <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      inc_activeR <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">[</span>reading <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">[</span>TT<span class="main">]</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
      And <span class="main">(</span>V readers_active<span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>reading <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      dec_activeR <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">[</span>reading <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">[</span>FF<span class="main">]</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
      And <span class="main">(</span>V readers_active<span class="main">)</span> <span class="main">(</span>activeR_eq <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
      <span class="main">[</span>readers_active<span class="main">,</span> ready<span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">]</span>
     <span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">writer_control</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">writer_control</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">[</span>
     <span class="main">(</span>
      V ready<span class="main">,</span>
      <span class="main">[</span>ready<span class="main">,</span> writers_active<span class="main">,</span> writing <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">,</span> TT<span class="main">]</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
      And <span class="main">(</span>V readers_active<span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>writing <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">[</span>readers_active<span class="main">,</span> q_error<span class="main">,</span> writing <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span>TT<span class="main">,</span>FF<span class="main">]</span>
    <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
      And <span class="main">(</span>V writers_active<span class="main">)</span> <span class="main">(</span>V <span class="main">(</span>writing <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">[</span>writers_active<span class="main">,</span> ready<span class="main">,</span> writing <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">,</span> FF<span class="main">]</span>
    <span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rw_body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>bexp <span class="main">×</span> com<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rw_body</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">0</span> <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rw_body</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">r'</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> reader_control <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">@</span> <span class="free">rw_body</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rw_body</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">w'</span></span></span><span class="main">)</span> <span class="main">=</span> writer_control <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span> <span class="main">@</span> <span class="free">rw_body</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r'</span></span></span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reader_writer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bprog <span class="main">×</span> config"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reader_writer</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span>
     <span class="main">(</span>optcomp<span class="main">(</span><span class="keyword1">WHILE</span> TT <span class="keyword1">DO</span> <span class="keyword1">IF</span> <span class="main">(</span>rw_body <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="keyword1">FI</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> rw_init <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(*
// Interesting property e.g.:
// G (not q_error)

// An "error" can be injected by changing the lines
//  // decrement actvR
//  IF actvR_1 THEN (actvR_0 := TT; actvR_1 := FF);
//  IF actvR_2 THEN (actvR_1 := TT; actvR_2 := FF);
// 
// to 
// (actvR_1 := TT; actvR_0 := FF; actvR_2 := FF)
// (actvR := 1 instead of actvR := actvR - 1)
// With only 2 writers, this is not really an error :)
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BoolProgs_Simple">
<div class="head">
<h1>Theory BoolProgs_Simple</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BoolProgs_Simple
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="BoolProgs_Extras.html">../BoolProgs_Extras</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> BoolProg_Syntax <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_prog</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>bexp <span class="main">×</span> com<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_prog</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">simple_prog</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">simple_prog</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bprog <span class="main">×</span> config"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">simple</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>optcomp 
    <span class="main">(</span><span class="keyword1">WHILE</span> TT <span class="keyword1">DO</span> <span class="keyword1">IF</span> simple_prog <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">FI</span><span class="main">)</span><span class="main">,</span> 
    <span class="main">(</span><span class="main">0</span><span class="main">,</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">i</span><span class="main">.</span> bs_insert <span class="bound">i</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>bs_empty <span class="main">()</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_const</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> const_map"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_const</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> Mapping.empty"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simple_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> fun_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">simple_fun</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> mapping_from_list <span class="main">[</span><span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''var''</span><span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> V <span class="bound">i</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BoolProgs_LeaderFilters">
<div class="head">
<h1>Theory BoolProgs_LeaderFilters</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BoolProgs_LeaderFilters
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="BoolProgs_Extras.html">../BoolProgs_Extras</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> BoolProg_Syntax <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">(* variables *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">elected</span> <span class="main">≡</span> <span class="main">0</span> <span class="main">::</span> nat"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">error</span> <span class="main">≡</span> <span class="main">1</span> <span class="main">::</span> nat"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">turn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> error <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> turn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> b <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">curr</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">curr</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> c <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> curr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> L_1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_3</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> L_2 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_4</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> L_3 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_5</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> L_4 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_8</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> L_5 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_9</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> L_8 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_turn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> set_counter <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>turn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inc_turn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> inc_counter <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>turn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec_turn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> dec_counter <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>turn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">turn_eq</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> counter_eq <span class="main">(</span>turn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_curr</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> set_counter <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>curr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inc_curr</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> inc_counter <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>curr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec_curr</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> dec_counter <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>curr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">curr_eq</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> counter_eq <span class="main">(</span>curr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">curr_access</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">act</span></span></span> <span class="main">≡</span> array_access <span class="main">(</span>curr_eq <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">act</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">curr_check</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">chk</span></span></span> <span class="main">≡</span> array_check <span class="main">(</span>curr_eq <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">chk</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lf_const</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> const_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lf_const</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> mapping_from_list <span class="main">[</span>
              <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''elected''</span><span class="main">,</span> V elected<span class="main">)</span><span class="main">,</span>
              <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''error''</span><span class="main">,</span> V error<span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lf_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> fun_map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lf_fun</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> mapping_from_list <span class="main">[</span>
             <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''b''</span><span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> V <span class="main">(</span>b <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
             <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''c''</span><span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> V <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>


<span class="comment1">(* init variable list *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lf_init</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lf_init</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> foldl 
    <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">c</span><span class="main">.</span> bs_insert <span class="bound">c</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>bs_empty <span class="main">()</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span>L_1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">..&lt;</span><span class="main">(</span>L_1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">process</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">process</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">[</span>
     <span class="main">(</span>
       V <span class="main">(</span>L_1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
       curr_access <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> set_turn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">[</span>L_1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> L_2 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">]</span><span class="main">)</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
       And <span class="main">(</span>V <span class="main">(</span>L_2 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curr_check <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Not <span class="main">(</span>V <span class="main">(</span>b <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       <span class="main">[</span>L_2 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> L_3 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">]</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
       V <span class="main">(</span>L_3 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
       curr_access <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">[</span>b <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v</span><span class="main">,</span> L_3 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> L_4 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>TT<span class="main">,</span> FF<span class="main">,</span> TT<span class="main">]</span><span class="main">)</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
       V <span class="main">(</span>L_4 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
       curr_access <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">IF</span> Not <span class="main">(</span>turn_eq <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">[</span>L_4 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> L_5 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">]</span> <span class="keyword1">ELSE</span> <span class="main">[</span>L_4 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> L_8 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">]</span><span class="main">)</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
       V <span class="main">(</span>L_5 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
       curr_access <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">[</span>c <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v</span><span class="main">,</span> b <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v</span><span class="main">,</span> L_5 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>TT<span class="main">,</span> FF<span class="main">,</span> FF<span class="main">]</span><span class="main">)</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
       V <span class="main">(</span>L_8 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
       <span class="keyword1">IF</span> curr_eq <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="keyword1">THEN</span> <span class="main">(</span>inc_curr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">[</span>L_8 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> L_1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">]</span><span class="main">)</span>
       <span class="keyword1">ELSE</span> curr_access <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">IF</span> Not <span class="main">(</span>V <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">[</span>L_8 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> L_9 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">]</span> <span class="keyword1">ELSE</span> inc_curr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">[</span>L_8 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> L_1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">[</span>FF<span class="main">,</span> TT<span class="main">]</span><span class="main">)</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
       And <span class="main">(</span>V <span class="main">(</span>L_9 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>V elected<span class="main">)</span><span class="main">,</span>
       <span class="main">[</span>error<span class="main">,</span> L_9 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>TT<span class="main">,</span> FF<span class="main">]</span>
     <span class="main">)</span><span class="main">,</span> <span class="main">(</span>
       V <span class="main">(</span>L_9 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
       <span class="main">[</span>elected<span class="main">,</span> L_9 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">::=</span> <span class="main">[</span>TT<span class="main">,</span> FF<span class="main">]</span>
     <span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">processes</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">processes</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span>process <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">leader_filters</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bprog <span class="main">×</span> config"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">leader_filters</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
     <span class="main">(</span>optcomp<span class="main">(</span><span class="keyword1">WHILE</span> TT <span class="keyword1">DO</span> <span class="keyword1">IF</span> processes <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">FI</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> lf_init <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> b c turn error curr

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BoolProgs_Programs">
<div class="head">
<h1>Theory BoolProgs_Programs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> BoolProgs_Programs
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="BoolProgs_Philosophers.html">BoolProgs_Philosophers</a>
  <a href="BoolProgs_ReaderWriter.html">BoolProgs_ReaderWriter</a>
  <a href="BoolProgs_Simple.html">BoolProgs_Simple</a>
  <a href="BoolProgs_LeaderFilters.html">BoolProgs_LeaderFilters</a>
  <a href="../CAVA_Base/Code_String.html">CAVA_Base.Code_String</a>
  <span class="comment1">(*"HOL-Library.List_lexord"*)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">progs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>String.literal<span class="main">,</span> String.literal <span class="main">×</span> String.literal <span class="main">×</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="main">(</span>bprog <span class="main">×</span> config<span class="main">)</span> <span class="main">×</span> const_map <span class="main">×</span> fun_map<span class="main">)</span><span class="main">)</span> mapping"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">progs</span> <span class="main">=</span>  mapping_from_list <span class="main">[</span>
                <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''RW''</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Reader/Writer''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''# Readers and # Writers''</span><span class="main">,</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>reader_writer <span class="bound">n</span> <span class="bound">n</span><span class="main">,</span> rw_const <span class="bound">n</span><span class="main">,</span> rw_fun <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''S''</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Simple Variable Setting''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''# Variables''</span><span class="main">,</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>simple <span class="bound">n</span><span class="main">,</span> simple_const <span class="bound">n</span><span class="main">,</span> simple_fun <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''P''</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Dining Philosophers''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''# Philosophers''</span><span class="main">,</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>philosophers <span class="bound">n</span><span class="main">,</span> phil_const <span class="bound">n</span><span class="main">,</span> phil_fun <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''LF''</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Leader Filters''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''# Processes''</span><span class="main">,</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>leader_filters <span class="bound">n</span><span class="main">,</span> lf_const <span class="bound">n</span><span class="main">,</span> lf_fun <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">]</span>"</span></span>

<span class="comment1">(* ensure this is an actual key *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">default_prog</span> <span class="main">≡</span> <span class="keyword1">STR</span> <span class="inner_quoted">''S''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">keys_of_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>String.literal<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> mapping <span class="main">⇒</span> String.literal list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">keys_of_map</span> <span class="main">≡</span> Mapping.ordered_keys"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">chose_prog</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal <span class="main">⇒</span> nat <span class="main">⇒</span> String.literal <span class="main">×</span> String.literal <span class="main">×</span> <span class="main">(</span>bprog <span class="main">×</span> config<span class="main">)</span> <span class="main">×</span> const_map <span class="main">×</span> fun_map"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">chose_prog</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup progs <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">of</span> 
                          Some <span class="main">(</span><span class="bound">descr</span><span class="main">,</span> <span class="bound">ndescr</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">descr</span><span class="main">,</span> <span class="bound">ndescr</span><span class="main">,</span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> 
                        <span class="main">|</span> None <span class="main">⇒</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">descr</span><span class="main">,</span> <span class="bound">ndescr</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>Mapping.lookup progs default_prog<span class="main">)</span>
                                 <span class="keyword1">in</span> <span class="main">(</span><span class="bound">descr</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' (fallback)''</span><span class="main">,</span> <span class="bound">ndescr</span><span class="main">,</span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_progs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>String.literal <span class="main">×</span> String.literal <span class="main">×</span> String.literal<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_progs</span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">keys</span> <span class="main">=</span> keys_of_map progs <span class="keyword1">in</span>
                map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">descr</span><span class="main">,</span> <span class="bound">ndescr</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>Mapping.lookup progs <span class="bound">k</span><span class="main">)</span>
                         <span class="keyword1">in</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">descr</span><span class="main">,</span> <span class="bound">ndescr</span><span class="main">)</span><span class="main">)</span> <span class="bound">keys</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CAVA_Impl">
<div class="head">
<h1>Theory CAVA_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Actual Implementation of the CAVA Model Checker›</span></span>
<span class="keyword1"><span class="command">theory</span></span> CAVA_Impl
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CAVA_Abstract.html">CAVA_Abstract</a>
  <a href="../CAVA_Automata/Automata_Impl.html">CAVA_Automata.Automata_Impl</a>

  <a href="../LTL/Rewriting.html">LTL.Rewriting</a>

  <a href="../LTL_to_GBA/LTL_to_GBA_impl.html">LTL_to_GBA.LTL_to_GBA_impl</a> <span class="comment1">(* LTL to BA *)</span>

  <a href="../Gabow_SCC/Gabow_GBG_Code.html">Gabow_SCC.Gabow_GBG_Code</a> <span class="comment1">(* Gabow's Algorithm *)</span>
  <span class="quoted">"<a href="NDFS_SI.html">Nested_DFS/NDFS_SI</a>"</span> <span class="comment1">(* Nested-DFS, standard-invars formalization *)</span>

  <span class="quoted">"<a href="BoolProgs.html">BoolProgs/BoolProgs</a>"</span>                   <span class="comment1">(* Boolean Programs *)</span>
  <span class="quoted">"<a href="BoolProgs_Programs.html">BoolProgs/Programs/BoolProgs_Programs</a>"</span> <span class="comment1">(* the actual programs *)</span>
  <span class="quoted">"<a href="BoolProgs_LTL_Conv.html">BoolProgs/BoolProgs_LTL_Conv</a>"</span>          <span class="comment1">(* LTL parsing setup *)</span>

  <a href="../Promela/PromelaLTL.html">Promela.PromelaLTL</a>     <span class="comment1">(* Promela *)</span>
  <a href="../Promela/PromelaLTLConv.html">Promela.PromelaLTLConv</a> <span class="comment1">(* LTL parsing setup *)</span>

  <span class="quoted">"<a href="../../HOL/HOL-Library/AList_Mapping.html">HOL-Library.AList_Mapping</a>"</span>
  <a href="../CAVA_Base/CAVA_Code_Target.html">CAVA_Base.CAVA_Code_Target</a>
  <a href="../SM/SM_Wrapup.html">SM.SM_Wrapup</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> SM_Cfg.cfg

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous Lemmata›</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">instantiation</span></span> uint32 <span class="main">::</span> <span class="quoted">hashable</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"hashcode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"def_hashmap_size <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">::</span>uint32 itself<span class="main">)</span> <span class="main">≡</span> <span class="numeral">8</span>"</span></span>  
  
  <span class="keyword1"><span class="command">instance</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
    <span class="keyword1"><span class="command">unfolding</span></span> def_hashmap_size_uint32_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Exporting Graphs›</span></span>

<span class="comment1">(* TODO: frv_export is going to be replaced by more explicit implementation 
  of graphs.
  For the moment, we just keep it here.
*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">frv_edge_set</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∩</span> <span class="main">(</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">frv_edge_set_aimpl</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> FOREACHi <span class="main">(</span><span class="main">λ</span><span class="bound">it</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">-</span> <span class="bound">it</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> 
  <span class="main">(</span><span class="main">λ</span><span class="bound">u</span> <span class="bound">r</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="keyword1">let</span> <span class="bound">E</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>succ_of_E <span class="main">(</span>g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span><span class="bound">E</span> <span class="main">∩</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">E</span> <span class="main">∪</span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> 
  <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frv_edge_set_aimpl_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> frv_edge_set_aimpl <span class="free">G</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> frv_edge_set <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> frv_edge_set_aimpl_def frv_edge_set_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> succ_of_E_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> frv_edge_set_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">eq</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> frv_edge_set_aimpl<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rx</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>frgv_impl_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">R</span><span class="main">⟩</span>list_set_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> frv_edge_set_aimpl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">frv_edge_set_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> frv_edge_set_impl_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> frv_edge_set_impl.refine<span class="main">[</span><span class="operator">OF</span> GEN_OP_D PREFER_sv_D<span class="main">]</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> frv_edge_set_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> frv_edge_set_impl <span class="free">eq</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> frv_edge_set_impl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">frv_edge_set_code</span> <span class="keyword2"><span class="keyword">for</span></span> eq G <span class="keyword2"><span class="keyword">uses</span></span> frv_edge_set_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> frv_edge_set_code.refine

<span class="keyword1"><span class="command">lemma</span></span> frv_edge_set_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> EQ<span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">eq</span> <span class="main">(=)</span> <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SV<span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"PREFER single_valued <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>frv_edge_set_code <span class="free">eq</span><span class="main">,</span>frv_edge_set<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rx</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>frgv_impl_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">R</span><span class="main">⟩</span>list_set_rel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Gi</span> <span class="skolem">G</span>
  <span class="keyword3"><span class="command">assume</span></span> Gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Gi</span><span class="main">,</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rx</span><span class="main">,</span> <span class="free">R</span><span class="main">⟩</span>frgv_impl_rel_ext"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V <span class="skolem">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> frgv_impl_rel_ext_def g_impl_rel_ext_def
      gen_g_impl_rel_ext_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_set_rel_def br_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">note</span></span> frv_edge_set_code.refine
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> frv_edge_set_impl.refine<span class="main">[</span><span class="operator">OF</span> EQ SV<span class="main">,</span> <span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> Gr<span class="main">,</span> <span class="operator">THEN</span> nres_relD<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> frv_edge_set_aimpl_correct
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>frv_edge_set_code <span class="free">eq</span> <span class="skolem">Gi</span><span class="main">,</span> frv_edge_set <span class="skolem">G</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">R</span><span class="main">⟩</span>list_set_rel"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> RETURN_ref_SPECD<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">frv_export</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">nodes</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> set <span class="bound">l</span> <span class="main">=</span> g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> distinct <span class="bound">l</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">V0</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> set <span class="bound">l</span> <span class="main">=</span> g_V0 <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> distinct <span class="bound">l</span><span class="main">)</span><span class="main">;</span>
  <span class="bound">E</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">l</span><span class="main">.</span> set <span class="bound">l</span> <span class="main">=</span> frv_edge_set <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">∧</span> distinct <span class="bound">l</span><span class="main">)</span><span class="main">;</span>
  RETURN <span class="main">(</span><span class="bound">nodes</span><span class="main">,</span><span class="bound">V0</span><span class="main">,</span><span class="bound">E</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> frv_export_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span> <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">R</span><span class="main">⟩</span>list_set_rel"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> EQ<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">eq</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SVR<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> frv_export<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rx</span><span class="main">,</span><span class="free">R</span><span class="main">⟩</span>frgv_impl_rel_ext 
  <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> frv_export_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">frv_export_impl</span> <span class="keyword2"><span class="keyword">for</span></span> eq <span class="keyword2"><span class="keyword">uses</span></span> frv_export_impl_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> frv_export_impl.refine<span class="main">[</span><span class="operator">OF</span> GEN_OP_D PREFER_sv_D<span class="main">]</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> frv_export_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> frv_export_impl <span class="free">eq</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> frv_export_impl_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">frv_export_code</span> <span class="keyword2"><span class="keyword">for</span></span> eq G <span class="keyword2"><span class="keyword">uses</span></span> frv_export_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> frv_export_code.refine

<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹LTL to GBA conversion›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, we set up the algorithms for LTL to GBA conversion.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_ltl_to_gba_algo</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> ltlc <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">,</span> unit<span class="main">)</span> igbav_impl_scheme<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="comment1">― ‹Predicate that must be satisfied by an LTL to GBA conversion›</span>
  <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">is_ltl_to_gba_algo</span> <span class="free"><span class="bound"><span class="entity">algo</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">algo</span></span></span><span class="main">,</span> ltl_to_gba_spec<span class="main">)</span> 
    <span class="main">∈</span> ltl_rel 
    <span class="main">→</span> <span class="main">⟨</span>igbav_impl_rel_ext unit_rel nat_rel <span class="main">(</span><span class="main">⟨</span>Id<span class="main">⟩</span>fun_set_rel<span class="main">)</span><span class="main">⟩</span>plain_nres_rel"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gerth_ltl_to_gba</span> 
  <span class="comment1">― ‹Conversion based on Gerth's Algorithm›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gerth_ltl_to_gba</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> create_name_igba <span class="main">(</span>ltln_to_ltlr <span class="main">(</span>simplify Slow <span class="main">(</span>ltlc_to_ltln <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gerth_ltl_to_gba_refine<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gerth_ltl_to_gba <span class="free">φ</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="main">(</span>ltl_to_gba_spec <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">unfolding</span></span> ltl_to_gba_spec_def gerth_ltl_to_gba_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_name_igba_correct<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SPEC_rule<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> equalityI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> igba_rec"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"igba <span class="skolem">G</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> igba <span class="quoted"><span class="skolem">G</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V <span class="skolem">G</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ξ</span><span class="main">.</span> accept <span class="bound">ξ</span> <span class="main">⟷</span> <span class="bound">ξ</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub></span> ltln_to_ltlr <span class="main">(</span>simplify Slow <span class="main">(</span>ltlc_to_ltln <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">=</span> language_ltlc <span class="free">φ</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> lang_def language_ltlc_def ltln_to_ltlr_semantics simplify_correct ltlc_to_ltln_semantics <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="skolem">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 reachable_V <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gerth_ltl_to_gba_code</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> create_name_igba_code <span class="main">(</span>ltln_to_ltlr <span class="main">(</span>simplify Slow <span class="main">(</span>ltlc_to_ltln <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> gerth_ltl_to_gba_code_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"is_ltl_to_gba_algo gerth_ltl_to_gba_code"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> RETURN <span class="main">(</span>gerth_ltl_to_gba_code <span class="bound">φ</span><span class="main">)</span> 
    <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span>igbav_impl_rel_ext unit_rel nat_rel <span class="main">(</span><span class="main">⟨</span>Id<span class="main">⟩</span>fun_set_rel<span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>gerth_ltl_to_gba <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gerth_ltl_to_gba_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> gerth_ltl_to_gba_code_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> create_name_igba_code.refine<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> create_name_igba_impl.refine<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fun_relD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> nres_relD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> gerth_ltl_to_gba_refine
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> is_ltl_to_gba_algo_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> plain_nres_relI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a function that chooses between the possible conversion 
  algorithms. (Currently there is only one)›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> config_l2b <span class="main">=</span> CFG_L2B_GERTHS

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ltl_to_gba_code</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> 
  <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="keyword1">of</span> CFG_L2B_GERTHS <span class="main">⇒</span> gerth_ltl_to_gba_code"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltl_to_gba_code_refine<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_ltl_to_gba_algo <span class="main">(</span>ltl_to_gba_code <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cfg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_gba_code_def

  <span class="keyword1"><span class="command">using</span></span> gerth_ltl_to_gba_code_refine
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Counterexample Search›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_find_ce_algo</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span>igbg_impl_scheme <span class="main">⇒</span> <span class="tfree">'a</span> lasso option option<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> 
  <span class="comment1">― ‹Predicate that must be satisfied by counterexample search algorithm›</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_find_ce_algo</span> <span class="free"><span class="bound"><span class="entity">algo</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">algo</span></span></span><span class="main">,</span> find_ce_spec<span class="main">)</span> 
    <span class="main">∈</span> igbg_impl_rel_ext unit_rel Id 
  <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span>Id<span class="main">⟩</span>lasso_run_rel<span class="main">⟩</span>Relators.option_rel<span class="main">⟩</span>Relators.option_rel<span class="main">⟩</span>plain_nres_rel"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gabow_find_ce_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>hashable lasso option option"</span></span>
  <span class="comment1">― ‹Emptiness check based on Gabow's SCC Algorithm›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gabow_find_ce_code</span>
  <span class="main">≡</span> map_option <span class="main">(</span>Some <span class="keyword1">o</span> lasso_of_prpl<span class="main">)</span> <span class="keyword1">o</span> Gabow_GBG_Code.find_lasso_tr <span class="main">(=)</span> bounded_hashcode_nat <span class="main">(</span>def_hashmap_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gabow_find_ce_code_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"is_find_ce_algo 
  <span class="main">(</span>gabow_find_ce_code 
    <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>hashable<span class="main">,</span> unit<span class="main">)</span> igbg_impl_scheme <span class="main">⇒</span> <span class="tfree">'a</span> lasso option option<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> AUX_EQ<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">gbgi</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> igbg_impl_scheme<span class="main">.</span> RETURN <span class="main">(</span>gabow_find_ce_code <span class="bound">gbgi</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">l</span> <span class="main">←</span> RETURN <span class="main">(</span>find_lasso_tr <span class="main">(=)</span> bounded_hashcode_nat <span class="main">(</span>def_hashmap_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="bound">gbgi</span><span class="main">)</span><span class="main">;</span>
      RETURN <span class="main">(</span>map_option <span class="main">(</span>Some <span class="main">∘</span> lasso_of_prpl<span class="main">)</span> <span class="bound">l</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gabow_find_ce_code_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="comment1">(* TODO: Clean up this proof! *)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_find_ce_algo_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI plain_nres_relI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_ce_spec_def AUX_EQ
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span>
      <span class="operator">OF</span> bind_mono<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Gabow_GBG_Code.find_lasso_tr_correct order_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">autoref_ga_rules</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">autoref_ga_rules</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> igb_fr_graphI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">unfolding</span></span> igb_graph.find_lasso_spec_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_le_iff <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lasso_run_rel_sv option_rel_sv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> igb_graph.is_lasso_prpl_of_lasso igb_graph.accepted_lasso 
      prod.exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option_rel_def lasso_run_rel_def br_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> igb_graph.is_lasso_prpl_conv igb_graph.lasso_accepted<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ndfs_find_ce</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span><span class="main">::</span>hashable<span class="main">,</span><span class="main">_</span><span class="main">)</span> igb_graph_rec_scheme <span class="main">⇒</span> <span class="tfree">'q</span> lasso option option nres"</span></span> 
  <span class="comment1">― ‹Emptiness check based on nested DFS›</span>
  <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ndfs_find_ce</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span>igb_graph <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">G</span> <span class="main">=</span> igb_graph.degeneralize <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">;</span>
    <span class="bound">l</span> <span class="main">←</span> blue_dfs <span class="bound">G</span><span class="main">;</span>
    <span class="keyword1">case</span> <span class="bound">l</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> RETURN None
    <span class="main">|</span> Some <span class="bound">l</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span> 
        ASSERT <span class="main">(</span>snd <span class="bound">l</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> 
        RETURN <span class="main">(</span>Some <span class="main">(</span>Some <span class="main">(</span>map_lasso fst <span class="main">(</span>lasso_of_prpl <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">}</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ndfs_find_ce_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G'</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>Id <span class="main">⟹</span> 
  ndfs_find_ce <span class="free">G'</span> <span class="main">≤</span> <span class="main">⇓</span><span class="main">(</span><span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span>Id<span class="main">⟩</span>lasso_run_rel<span class="main">⟩</span>option_rel<span class="main">⟩</span>option_rel<span class="main">)</span> <span class="main">(</span>find_ce_spec <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> find_ce_spec_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">refine_rcg</span> SPEC_refine <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"igb_graph <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> igb_graph <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">assume</span></span> fr<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph degeneralize"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degen_invar<span class="main">)</span>
  <span class="comment1">(*then interpret bg: b_graph degeneralize .*)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ndfs_find_ce <span class="free">G</span>
    <span class="main">≤</span>
    <span class="main">(</span>SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">res</span><span class="main">.</span> <span class="main">∃</span><span class="bound">res'</span><span class="main">.</span> 
         <span class="main">(</span><span class="bound">res</span><span class="main">,</span><span class="bound">res'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span>Id<span class="main">⟩</span>lasso_run_rel<span class="main">⟩</span>Relators.option_rel<span class="main">⟩</span>Relators.option_rel<span class="main">)</span>
       <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">res'</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">¬</span> is_acc_run <span class="bound">r</span>
         <span class="main">|</span> Some None <span class="main">⇒</span> Ex is_acc_run 
         <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> is_acc_run <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ndfs_find_ce_def find_lasso_spec_def ce_correct_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> blue_dfs_correct<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp_all</span><span class="main">)</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> degen_finite_reachable fr<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> degen_acc_run_complete<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> degen.accepted_lasso<span class="main"><span class="main">[</span></span><span class="operator">OF</span> degen_finite_reachable<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> fr<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degen.is_lasso_prpl_of_lasso<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> prpl_of_lasso_def
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> degen.is_lasso_prpl_of_lasso<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b_graph.is_lasso_prpl_def graph.is_lasso_prpl_pre_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degen.is_lasso_prpl_conv lasso_run_rel_def br_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> degen.lasso_accepted degen_acc_run_sound
    <span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">schematic_goal</span></span> ndfs_find_ce_impl_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> ndfs_find_ce<span class="main">)</span> 
  <span class="main">∈</span> igbg_impl_rel_ext <span class="free">Rm</span> Id 
  <span class="main">→</span> <span class="main">⟨</span>
    <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span>unit_rel<span class="main">,</span>Id<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>hashable<span class="main">×</span><span class="main">_</span><span class="main">)</span> set<span class="main">⟩</span>lasso_rel_ext<span class="main">⟩</span>option_rel<span class="main">⟩</span>option_rel
  <span class="main">⟩</span> nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfs_find_ce_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">ndfs_find_ce_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> ndfs_find_ce_impl_aux

<span class="keyword1"><span class="command">schematic_goal</span></span> ndfs_find_ce_code_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> ndfs_find_ce_impl <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ndfs_find_ce_impl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">post</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">ndfs_find_ce_code</span> <span class="keyword2"><span class="keyword">uses</span></span> ndfs_find_ce_code_aux


<span class="keyword1"><span class="command">lemma</span></span> ndfs_find_ce_code_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"is_find_ce_algo ndfs_find_ce_code"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_find_ce_algo_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI plain_nres_relI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">gbgi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span>unit<span class="main">)</span> igbg_impl_scheme"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">gbg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> igb_graph_rec"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">gbgi</span><span class="main">,</span> <span class="skolem">gbg</span><span class="main">)</span> <span class="main">∈</span> igbg_impl_rel_ext unit_rel Id"</span></span>
  <span class="keyword1"><span class="command">note</span></span> ndfs_find_ce_code.refine
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> ndfs_find_ce_impl.refine<span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">THEN</span> nres_relD<span class="main">,</span> <span class="operator">OF</span> R<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> ndfs_find_ce_refine<span class="main">[</span><span class="operator">OF</span> IdI<span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>ndfs_find_ce_code <span class="skolem">gbgi</span><span class="main">)</span>
    <span class="main">≤</span> <span class="main">⇓</span> <span class="main">(</span><span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span>Id<span class="main">⟩</span>lasso_run_rel<span class="main">⟩</span>Relators.option_rel<span class="main">⟩</span>Relators.option_rel<span class="main">)</span> 
      <span class="main">(</span>find_ce_spec <span class="skolem">gbg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lasso_rel_ext_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a function that chooses between the emptiness check 
  algorithms›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> config_ce <span class="main">=</span> CFG_CE_SCC_GABOW <span class="main">|</span> CFG_CE_NDFS

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_ce_code</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">find_ce_code</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="keyword1">of</span> 
  CFG_CE_SCC_GABOW <span class="main">⇒</span> gabow_find_ce_code
<span class="main">|</span> CFG_CE_NDFS <span class="main">⇒</span> ndfs_find_ce_code"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_ce_code_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"is_find_ce_algo <span class="main">(</span>find_ce_code <span class="free">cfg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">cfg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> find_ce_code_def
  <span class="keyword1"><span class="command">using</span></span> gabow_find_ce_code_refine ndfs_find_ce_code_refine
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> config_ce.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹System-Agnostic Model-Checker›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we implement the part of the model-checker that does not 
  depend on the language used to describe the system to be checked. 
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Default Implementation of Lazy Intersection›</span></span>

<span class="keyword1"><span class="command">locale</span></span> cava_inter_impl_loc <span class="main">=</span>
  igba_sys_prod_precond <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">S</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'l</span> set<span class="main">)</span> sa_rec"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="tfree">'l</span> set<span class="main">)</span> igba_rec"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Gi</span> <span class="free">Si</span> <span class="free">Rq</span> <span class="free">Rs</span> <span class="free">Rl</span> <span class="free">eqq</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">eqq</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rq</span> <span class="main">→</span> <span class="free">Rq</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="main">∈</span> igbav_impl_rel_ext unit_rel <span class="free">Rq</span> <span class="free">Rl</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Si</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> sa_impl_rel_ext unit_rel <span class="free">Rs</span> <span class="free">Rl</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> cava_inter_impl_loc_this<span class="main">:</span> <span class="quoted"><span class="quoted">"cava_inter_impl_loc <span class="free">S</span> <span class="free">G</span> <span class="free">Gi</span> <span class="free">Si</span> <span class="free">Rq</span> <span class="free">Rs</span> <span class="free">Rl</span> <span class="free">eqq</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="comment1">(*&lt;*)</span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹TODO/FIXME:
    Some black-magic is going on here: The performance of the mc seems to depend on the ordering of states,
    so we do some adjustments of the ordering here.
›</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> prod_impl_aux_alt_cava_reorder<span class="main">:</span>
    <span class="quoted"><span class="quoted">"prod <span class="main">=</span> <span class="main">(</span><span class="main">⦇</span>
      g_V <span class="main">=</span> Collect <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> igba.V <span class="main">∧</span> <span class="bound">s</span> <span class="main">∈</span> sa.V<span class="main">)</span><span class="main">,</span>
      g_E <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> 
        <span class="keyword1">if</span> igba.L <span class="bound">q</span> <span class="main">(</span>sa.L <span class="bound">s</span><span class="main">)</span> <span class="keyword1">then</span>     
          <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>LIST_SET_REV_TAG <span class="main">(</span>succ_of_E <span class="main">(</span>sa.E<span class="main">)</span> <span class="bound">s</span><span class="main">)</span> 
           <span class="main">×</span> <span class="main">(</span>succ_of_E <span class="main">(</span>igba.E<span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="main">{}</span>
      <span class="main">)</span><span class="main">,</span>
      g_V0 <span class="main">=</span> igba.V0 <span class="main">×</span> sa.V0<span class="main">,</span>
      igbg_num_acc <span class="main">=</span> igba.num_acc<span class="main">,</span>
      igbg_acc <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">s</span><span class="main">∈</span>sa.V <span class="keyword1">then</span> igba.acc <span class="bound">q</span> <span class="keyword1">else</span> <span class="main">{}</span>
    <span class="main">⦈</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prod_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> succ_of_E_def E_of_succ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">schematic_goal</span></span> vf_prod_impl_aux_cava_reorder<span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> prod<span class="main">)</span> <span class="main">∈</span> igbg_impl_rel_ext unit_rel <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prod_impl_aux_alt_cava_reorder<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> map_concat_map_map_opt<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> map <span class="main">(</span><span class="free">f'</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="free">l2</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">=</span> List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> map <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">f'</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">(</span><span class="free">l1</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="free">l2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xd</span><span class="main">,</span> <span class="bound">xe</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">xe</span><span class="main">,</span> <span class="bound">xd</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> Pair <span class="free">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free">xa</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹Very specific optimization used in the next refinement›</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l2</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.maps_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="entity">gbav_sys_prod_impl_cava_reorder</span> 
    <span class="keyword2"><span class="keyword">for</span></span> eqq Gi Si
    <span class="keyword2"><span class="keyword">uses</span></span> cava_inter_impl_loc.vf_prod_impl_aux_cava_reorder<span class="main">[</span>
    <span class="operator">param_fo</span><span class="main">,</span> <span class="operator">unfolded</span> map_concat_map_map_opt<span class="main">]</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> 
    gbav_sys_prod_impl_cava_reorder.refine<span class="main">[</span><span class="operator">OF</span> cava_inter_impl_loc_this<span class="main">]</span>
  
  <span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
    <span class="comment1">(* HACK: Overwrite pattern that rewrites outer-level prod, such that
      local rules apply here. *)</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prod <span class="main">≡</span> <span class="keyword1">OP</span> prod"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(*&gt;*)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">dflt_inter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> igb_graph_rec <span class="main">×</span> <span class="main">(</span><span class="tfree">'q</span> <span class="main">×</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">dflt_inter</span> <span class="main">≡</span> <span class="main">(</span>prod<span class="main">,</span> snd<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> dflt_inter_refine<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RETURN dflt_inter <span class="main">≤</span> inter_spec <span class="free">S</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inter_spec_def dflt_inter_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> le_ASSERTI <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp_all</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"igb_graph prod"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_invar<span class="main">)</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>igba.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> igba.V0<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">S</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E prod<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 prod<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_finite_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">r'</span><span class="main">.</span> prod.is_acc_run <span class="bound">r'</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> snd <span class="main">∘</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">⟷</span>
          <span class="main">(</span>sa.is_run <span class="skolem">r</span> <span class="main">∧</span> sa.L <span class="main">∘</span> <span class="skolem">r</span> <span class="main">∈</span> igba.lang<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gsp_correct1 gsp_correct2 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_assoc<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">schematic_goal</span></span> dflt_inter_impl_aux<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> dflt_inter<span class="main">)</span> 
    <span class="main">∈</span> igbg_impl_rel_ext unit_rel <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dflt_inter_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="entity">dflt_inter_impl</span>
    <span class="keyword2"><span class="keyword">for</span></span> eqq Si Gi
    <span class="keyword2"><span class="keyword">uses</span></span> cava_inter_impl_loc.dflt_inter_impl_aux

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> dflt_inter_impl.refine<span class="main">[</span><span class="operator">OF</span> cava_inter_impl_loc_this<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_dflt_inter</span> <span class="main">≡</span> cava_inter_impl_loc.dflt_inter"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cava_inter_impl_loc.dflt_inter <span class="main">≡</span> op_dflt_inter"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> dflt_inter_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="tfree">'l</span> set<span class="main">)</span> igba_rec"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'l</span> set<span class="main">)</span> sa_rec"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Gi</span> <span class="free">Si</span> <span class="free">Rq</span> <span class="free">Rs</span> <span class="free">Rl</span> <span class="free">eqq</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>igba <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>sa <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">eqq</span> <span class="main">(=)</span> <span class="main">(</span><span class="free">Rq</span> <span class="main">→</span> <span class="free">Rq</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="main">∈</span> igbav_impl_rel_ext unit_rel <span class="free">Rq</span> <span class="free">Rl</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Si</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> sa_impl_rel_ext unit_rel <span class="free">Rs</span> <span class="free">Rl</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dflt_inter_impl <span class="free">eqq</span> <span class="free">Si</span> <span class="free">Gi</span><span class="main">,</span>
    <span class="main">(</span><span class="keyword1">OP</span> op_dflt_inter 
     <span class="main">:::</span> sa_impl_rel_ext unit_rel <span class="free">Rs</span> <span class="free">Rl</span>
      <span class="main">→</span> igbav_impl_rel_ext unit_rel <span class="free">Rq</span> <span class="free">Rl</span> 
      <span class="main">→</span> igbg_impl_rel_ext unit_rel <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span><span class="main">)</span><span class="main">)</span><span class="main">$</span><span class="free">S</span><span class="main">$</span><span class="free">G</span>
  <span class="main">)</span> <span class="main">∈</span> igbg_impl_rel_ext unit_rel <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> igba<span class="main">:</span> igba <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> sa<span class="main">:</span> sa <span class="quoted"><span class="free">S</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> cava_inter_impl_loc <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">Gi</span></span> <span class="quoted"><span class="free">Si</span></span> <span class="quoted"><span class="free">Rq</span></span> <span class="quoted"><span class="free">Rs</span></span> <span class="quoted"><span class="free">Rl</span></span> <span class="quoted"><span class="free">eqq</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dflt_inter_impl.refine<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inter_spec_refineI<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sa <span class="free">S</span><span class="main">;</span> igba <span class="free">G</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>inter_spec <span class="free">S</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="main">⇓</span><span class="free">R</span> <span class="main">(</span>inter_spec <span class="free">S</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> inter_spec_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">refine_rcg</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> dflt_inter_impl_refine<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'si</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'qi</span> <span class="main">×</span> <span class="tfree">'q</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rprop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'pi</span> <span class="main">×</span> <span class="tfree">'p</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">Rs</span>"</span></span> <span class="quoted"><span class="quoted">"Range <span class="free">Rs</span> <span class="main">=</span> UNIV"</span></span> 
    <span class="quoted"><span class="quoted">"single_valued <span class="free">Rq</span>"</span></span> <span class="quoted"><span class="quoted">"Range <span class="free">Rq</span> <span class="main">=</span> UNIV"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">eqq</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rq</span> <span class="main">→</span> <span class="free">Rq</span> <span class="main">→</span> bool_rel"</span></span>

  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dflt_inter_impl <span class="free">eqq</span><span class="main">,</span> inter_spec<span class="main">)</span>
  <span class="main">∈</span> sa_impl_rel_ext unit_rel <span class="free">Rs</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rprop</span><span class="main">⟩</span>fun_set_rel<span class="main">)</span> <span class="main">→</span>
    igbav_impl_rel_ext unit_rel <span class="free">Rq</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rprop</span><span class="main">⟩</span>fun_set_rel<span class="main">)</span> <span class="main">→</span>
    <span class="main">⟨</span>igbg_impl_rel_ext unit_rel <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span> <span class="main">→</span> <span class="free">Rs</span><span class="main">)</span><span class="main">⟩</span>plain_nres_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI plain_nres_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inter_spec_refineI<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Si</span> <span class="skolem">S</span> <span class="skolem">Gi</span> <span class="skolem">G</span>

  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Si</span><span class="main">,</span><span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> sa_impl_rel_ext unit_rel <span class="free">Rs</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rprop</span><span class="main">⟩</span>fun_set_rel<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Gi</span><span class="main">,</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">∈</span> igbav_impl_rel_ext unit_rel <span class="free">Rq</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rprop</span><span class="main">⟩</span>fun_set_rel<span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sa <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"igba <span class="skolem">G</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> sa<span class="main">:</span> sa <span class="quoted"><span class="skolem">S</span></span> <span class="main">+</span> igba<span class="main">:</span> igba <span class="quoted"><span class="skolem">G</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> cava_inter_impl_loc <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">G</span></span> <span class="quoted"><span class="skolem">Gi</span></span> <span class="quoted"><span class="skolem">Si</span></span> <span class="quoted"><span class="free">Rq</span></span> <span class="quoted"><span class="free">Rs</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rprop</span><span class="main">⟩</span>fun_set_rel"</span></span> <span class="quoted"><span class="free">eqq</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> EQ R <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">note</span></span> RETURN_refine<span class="main">[</span><span class="operator">OF</span> dflt_inter_impl.refine<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cava_inter_impl_loc_this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> dflt_inter_refine
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>dflt_inter_impl <span class="free">eqq</span> <span class="skolem">Si</span> <span class="skolem">Gi</span><span class="main">)</span>
  <span class="main">≤</span> <span class="main">⇓</span> <span class="main">(</span>igbg_impl_rel_ext unit_rel <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>inter_spec <span class="skolem">S</span> <span class="skolem">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of Model-Checker›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we instantiate the parametrized model checker
  with the actual implementations.›</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Locale_Code.open_block</span>
<span class="keyword1"><span class="command">interpretation</span></span> cava_sys_agn<span class="main">:</span> impl_model_checker 
  <span class="quoted"><span class="quoted">"sa_impl_rel_ext unit_rel Id <span class="main">(</span><span class="main">⟨</span>Id<span class="main">⟩</span>fun_set_rel<span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"igbav_impl_rel_ext unit_rel Id <span class="main">(</span><span class="main">⟨</span>Id<span class="main">⟩</span>fun_set_rel<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"igbg_impl_rel_ext unit_rel <span class="main">(</span>Id <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> Id<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> Id<span class="main">⟩</span>lasso_run_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">⟩</span>lasso_run_rel"</span></span>

  <span class="quoted"><span class="quoted">"ltl_to_gba_code"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">::</span>unit<span class="main">.</span> dflt_inter_impl <span class="main">(=)</span>"</span></span>
  <span class="quoted"><span class="quoted">"find_ce_code"</span></span>
  <span class="quoted"><span class="quoted">"map_lasso"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">tagged_solver</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ltl_to_gba_code_refine<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> is_ltl_to_gba_algo_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">using</span></span> dflt_inter_impl_refine<span class="main">[</span><span class="operator">of</span> <span class="quoted">Id</span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted">Id</span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">using</span></span> find_ce_code_refine<span class="main">[</span><span class="operator">unfolded</span> is_find_ce_algo_def<span class="main">]</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>

  <span class="keyword1"><span class="command">using</span></span> map_lasso_run_refine<span class="main">[</span><span class="operator">of</span> <span class="quoted">Id</span> <span class="quoted">Id</span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Locale_Code.close_block</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cava_sys_agn</span> <span class="main">≡</span> cava_sys_agn.impl_model_check"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The correctness theorem states correctness of the model checker wrt.\ 
  a model given as system automata. In the following sections, we will then 
  refine the model description to Boolean programs and Promela.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> cava_sys_agn_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">sysi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">::</span>hashable<span class="main">,</span> <span class="tfree">'p</span><span class="main">::</span>linorder <span class="main">⇒</span> bool<span class="main">,</span> unit<span class="main">)</span> sa_impl_scheme"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'p</span> set<span class="main">)</span> sa_rec"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> ltlc"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cfg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"config_l2b <span class="main">×</span> unit <span class="main">×</span> config_ce"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sysi</span><span class="main">,</span> <span class="free">sys</span><span class="main">)</span> <span class="main">∈</span> sa_impl_rel_ext unit_rel Id <span class="main">(</span><span class="main">⟨</span>Id<span class="main">⟩</span>fun_set_rel<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sa <span class="free">sys</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">sys</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">sys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> cava_sys_agn <span class="free">cfg</span> <span class="free">sysi</span> <span class="free">φ</span> <span class="keyword1">of</span>
         None <span class="main">⇒</span> sa.lang <span class="free">sys</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span> 
         <span class="main">|</span> Some None <span class="main">⇒</span> <span class="main">¬</span> sa.lang <span class="free">sys</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>
         <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">L</span><span class="main">)</span> <span class="main">⇒</span> 
             graph_defs.is_run <span class="free">sys</span> <span class="main">(</span>run_of_lasso <span class="bound">L</span><span class="main">)</span> 
           <span class="main">∧</span> sa_L <span class="free">sys</span> <span class="main">∘</span> <span class="main">(</span>run_of_lasso <span class="bound">L</span><span class="main">)</span> <span class="main">∉</span> language_ltlc <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cava_sys_agn.impl_model_check_correct<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">cfg</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cava_sys_agn_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lasso_run_rel_def br_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model Checker for Boolean Programs›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bpc_to_sa</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"bprog <span class="main">×</span> BoolProgs.config <span class="main">⇒</span> <span class="main">(</span>BoolProgs.config<span class="main">,</span>nat set<span class="main">)</span> sa_rec"</span></span> 
  <span class="comment1">― ‹Conversion of a Boolean program to a system automata.›</span>
  <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">bpc_to_sa</span> <span class="free"><span class="bound"><span class="entity">bpc</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">bp</span><span class="main">,</span><span class="bound">c0</span><span class="main">)</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">bpc</span></span></span> <span class="keyword1">in</span>
  <span class="main">⦇</span>
    g_V <span class="main">=</span> UNIV<span class="main">,</span>
    g_E <span class="main">=</span> E_of_succ <span class="main">(</span>set <span class="keyword1">o</span> BoolProgs.nexts <span class="bound">bp</span><span class="main">)</span><span class="main">,</span>
    g_V0 <span class="main">=</span> <span class="main">{</span><span class="bound">c0</span><span class="main">}</span><span class="main">,</span>
    sa_L <span class="main">=</span> <span class="main">λ</span><span class="bound">c</span><span class="main">.</span> bs_α <span class="main">(</span>snd <span class="bound">c</span><span class="main">)</span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bpc_to_sa_impl</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"bprog <span class="main">×</span> BoolProgs.config 
  <span class="main">⇒</span> <span class="main">(</span>BoolProgs.config<span class="main">,</span>nat <span class="main">⇒</span> bool<span class="main">,</span>unit<span class="main">)</span> sa_impl_scheme"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">bpc_to_sa_impl</span> <span class="free"><span class="bound"><span class="entity">bpc</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">bp</span><span class="main">,</span><span class="bound">c0</span><span class="main">)</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">bpc</span></span></span> <span class="keyword1">in</span>
  <span class="main">⦇</span> gi_V <span class="main">=</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">,</span>
    gi_E <span class="main">=</span> remdups <span class="keyword1">o</span> BoolProgs.nexts <span class="bound">bp</span><span class="main">,</span>
    gi_V0 <span class="main">=</span> <span class="main">[</span><span class="bound">c0</span><span class="main">]</span><span class="main">,</span>
    sai_L <span class="main">=</span> <span class="main">λ</span><span class="bound">c</span> <span class="bound">i</span><span class="main">.</span> bs_mem <span class="bound">i</span> <span class="main">(</span>snd <span class="bound">c</span><span class="main">)</span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bpc_to_sa_impl_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bpc_to_sa_impl <span class="free">bpc</span><span class="main">,</span> bpc_to_sa <span class="free">bpc</span><span class="main">)</span> 
  <span class="main">∈</span> sa_impl_rel_ext unit_rel Id <span class="main">(</span><span class="main">⟨</span>nat_rel<span class="main">⟩</span>fun_set_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bpc_to_sa_impl_def bpc_to_sa_def 
  <span class="keyword1"><span class="command">unfolding</span></span> sa_impl_rel_eext_def g_impl_rel_ext_def
  <span class="keyword1"><span class="command">unfolding</span></span> gen_sa_impl_rel_eext_def gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_set_rel_def br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> E_of_succ_refine<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_set_rel_def br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_set_rel_def br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_set_rel_def br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> bpc_to_sa_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"sa <span class="main">(</span>bpc_to_sa <span class="free">bpc</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bpc_to_sa_fr<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>bpc_to_sa <span class="free">bpc</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>bpc_to_sa <span class="free">bpc</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bp</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bpc</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bp</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">bpc</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sa <span class="main">(</span>bpc_to_sa <span class="free">bpc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bpc_to_sa_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bpc_to_sa_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>bpc_to_sa <span class="free">bpc</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>bpc_to_sa <span class="free">bpc</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bpc_to_sa_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ BoolProgs.reachable_configs_finite<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">bp</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_reachable_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> BoolProgs.reachable_configs.intros 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> bpc_to_sa<span class="main">:</span> sa <span class="quoted"><span class="quoted">"bpc_to_sa <span class="free">bpc</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bpc_to_sa_invar <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bpc_to_sa_run_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"graph_defs.is_run <span class="main">(</span>bpc_to_sa <span class="free">bpc</span><span class="main">)</span> <span class="main">=</span> bpc_is_run <span class="free">bpc</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> graph_defs.is_run_def
  <span class="keyword1"><span class="command">unfolding</span></span> bpc_to_sa_def bpc_is_run_def 
    ipath_def E_of_succ_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bpc_to_sa_L_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sa_L <span class="main">(</span>bpc_to_sa <span class="free">bpc</span><span class="main">)</span> <span class="main">=</span> bpc_props"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> bpc_to_sa_def bpc_props_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bpc_to_sa_lang_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sa.lang <span class="main">(</span>bpc_to_sa <span class="free">bpc</span><span class="main">)</span> <span class="main">=</span> bpc_lang <span class="free">bpc</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bpc_to_sa.lang_def bpc_to_sa.accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> bpc_lang_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cava_bpc</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">bpc</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> cava_sys_agn <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">(</span>bpc_to_sa_impl <span class="free"><span class="bound"><span class="entity">bpc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Correctness theorem for the model checker on boolean programs.
  Note that the semantics of Boolean programs is given 
  by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "bpc_lang"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> cava_bpc_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> cava_bpc <span class="free">cfg</span> <span class="free">bpc</span> <span class="free">φ</span> <span class="keyword1">of</span> 
    None <span class="main">⇒</span> bpc_lang <span class="free">bpc</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>
  <span class="main">|</span> Some None <span class="main">⇒</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span>bpc_lang <span class="free">bpc</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">ce</span><span class="main">)</span> <span class="main">⇒</span> 
      bpc_is_run <span class="free">bpc</span> <span class="main">(</span>run_of_lasso <span class="bound">ce</span><span class="main">)</span> 
    <span class="main">∧</span> bpc_props <span class="keyword1">o</span> run_of_lasso <span class="bound">ce</span> <span class="main">∉</span> language_ltlc <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cava_sys_agn_correct<span class="main">[</span><span class="operator">OF</span> bpc_to_sa_impl_refine bpc_to_sa_invar bpc_to_sa_fr<span class="main">,</span> 
    <span class="operator">of</span> <span class="quoted"><span class="free">bpc</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">cfg</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cava_bpc_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lasso_run_rel_def br_def<span class="main">)</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">cava_bpc</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model Checker for Promela Programs›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">promela_to_sa</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"PromelaDatastructures.program <span class="main">×</span> APs <span class="main">×</span> gState <span class="main">⇒</span> <span class="main">(</span>gState<span class="main">,</span> nat set<span class="main">)</span> sa_rec"</span></span> 
  <span class="comment1">― ‹Conversion of a Promela model to a system automata.›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">promela_to_sa</span> <span class="free"><span class="bound"><span class="entity">promg</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">prog</span><span class="main">,</span><span class="bound">APs</span><span class="main">,</span><span class="bound">g<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">promg</span></span></span> <span class="keyword1">in</span>
  <span class="main">⦇</span>
    g_V <span class="main">=</span> UNIV<span class="main">,</span>
    g_E <span class="main">=</span> E_of_succ <span class="main">(</span>ls.α <span class="keyword1">o</span> Promela.nexts_code <span class="bound">prog</span><span class="main">)</span><span class="main">,</span>
    g_V0 <span class="main">=</span> <span class="main">{</span><span class="bound">g<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span><span class="main">,</span>
    sa_L <span class="main">=</span> promela_props_ltl <span class="bound">APs</span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">promela_to_sa_impl</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"PromelaDatastructures.program <span class="main">×</span> APs <span class="main">×</span> gState
  <span class="main">⇒</span> <span class="main">(</span>gState<span class="main">,</span> nat <span class="main">⇒</span> bool<span class="main">,</span> unit<span class="main">)</span> sa_impl_scheme"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">promela_to_sa_impl</span> <span class="free"><span class="bound"><span class="entity">promg</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">prog</span><span class="main">,</span><span class="bound">APs</span><span class="main">,</span><span class="bound">g<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">promg</span></span></span> <span class="keyword1">in</span>
  <span class="main">⦇</span> gi_V <span class="main">=</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">,</span>
    gi_E <span class="main">=</span> ls.to_list <span class="keyword1">o</span> Promela.nexts_code <span class="bound">prog</span><span class="main">,</span>
    gi_V0 <span class="main">=</span> <span class="main">[</span><span class="bound">g<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span><span class="main">,</span>
    sai_L <span class="main">=</span> propValid <span class="bound">APs</span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> promela_to_sa_impl_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>promela_to_sa_impl <span class="free">promg</span><span class="main">,</span> promela_to_sa <span class="free">promg</span><span class="main">)</span> 
  <span class="main">∈</span> sa_impl_rel_ext unit_rel Id <span class="main">(</span><span class="main">⟨</span>nat_rel<span class="main">⟩</span>fun_set_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> promela_to_sa_impl_def promela_to_sa_def 
  <span class="keyword1"><span class="command">unfolding</span></span> sa_impl_rel_eext_def g_impl_rel_ext_def
  <span class="keyword1"><span class="command">unfolding</span></span> gen_sa_impl_rel_eext_def gen_g_impl_rel_ext_def

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_set_rel_def br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> E_of_succ_refine<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_set_rel_def br_def ls.correct<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_set_rel_def br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_set_rel_def br_def in_set_member promela_props_ltl_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cava_promela</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">ast</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> 
  <span class="keyword1">let</span> 
      <span class="main">(</span><span class="bound">promg</span><span class="main">,</span><span class="bound">φ<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">=</span> PromelaLTL.prepare <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">ast</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
  <span class="keyword1">in</span>
     cava_sys_agn <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span> <span class="main">(</span>promela_to_sa_impl <span class="bound">promg</span><span class="main">)</span> <span class="bound">φ<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The next theorem states correctness of the Promela model checker.

  The correctness is specified for some AST.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> cava_promela_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> cava_promela <span class="free">cfg</span> <span class="free">ast</span> <span class="free">φ</span> <span class="keyword1">of</span> 
    None <span class="main">⇒</span> promela_language <span class="free">ast</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>
  <span class="main">|</span> Some None <span class="main">⇒</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span>promela_language <span class="free">ast</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">ce</span><span class="main">)</span> <span class="main">⇒</span> promela_is_run <span class="free">ast</span> <span class="main">(</span>run_of_lasso <span class="bound">ce</span><span class="main">)</span> 
    <span class="main">∧</span> promela_props <span class="keyword1">o</span> run_of_lasso <span class="bound">ce</span> <span class="main">∉</span> language_ltlc <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">APs</span></span> <span class="skolem"><span class="skolem">φ<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"PromelaLTL.ltl_convert <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">APs</span><span class="main">,</span><span class="skolem">φ<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">prog</span></span> <span class="skolem"><span class="skolem">g<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> ast<span class="main">:</span> <span class="quoted"><span class="quoted">"Promela.setUp <span class="free">ast</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">prog</span><span class="main">,</span><span class="skolem">g<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?promg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">prog</span><span class="main">,</span><span class="skolem">APs</span><span class="main">,</span><span class="skolem">g<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> promela_to_sa_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"sa <span class="main">(</span>promela_to_sa <span class="var">?promg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> promela_to_sa_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> promela_to_sa_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> promela_to_sa_fr<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>promela_to_sa <span class="var">?promg</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>promela_to_sa <span class="var">?promg</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> promela_to_sa_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 
      finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Promela.reachable_states_finite<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">prog</span></span> <span class="quoted"><span class="skolem">g<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_reachable_induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Promela.reachable_states.intros 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span> setUp_program_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ast<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span> setUp_gState_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ast<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">interpret</span></span> promela_to_sa<span class="main">:</span> sa <span class="quoted"><span class="quoted">"promela_to_sa <span class="var">?promg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> promela_to_sa_invar <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> promela_to_sa_run_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"graph_defs.is_run <span class="main">(</span>promela_to_sa <span class="var">?promg</span><span class="main">)</span> <span class="main">=</span> promela_is_run_ltl <span class="var">?promg</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> graph_defs.is_run_def
    <span class="keyword1"><span class="command">unfolding</span></span> promela_to_sa_def promela_is_run_ltl_def promela_is_run'_def ipath_def E_of_succ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> promela_to_sa_L_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"sa_L <span class="main">(</span>promela_to_sa <span class="var">?promg</span><span class="main">)</span> <span class="main">=</span> promela_props_ltl <span class="skolem">APs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> promela_to_sa_def promela_props_ltl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> promela_to_sa_lang_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"sa.lang <span class="main">(</span>promela_to_sa <span class="var">?promg</span><span class="main">)</span> <span class="main">=</span> promela_language_ltl <span class="var">?promg</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> promela_to_sa.lang_def promela_to_sa.accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      promela_language_ltl_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cava_sys_agn_correct<span class="main">[</span><span class="operator">OF</span> 
      promela_to_sa_impl_refine promela_to_sa_invar promela_to_sa_fr<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">φ<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="quoted"><span class="quoted">"fst <span class="free">cfg</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> promela_language_sub_iff<span class="main">[</span><span class="operator">OF</span> conv ast<span class="main">]</span> promela_run_in_language_iff<span class="main">[</span><span class="operator">OF</span> conv<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> cava_promela_def PromelaLTL.prepare_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lasso_run_rel_def br_def conv ast promela_is_run_ltl_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">cava_promela</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model Checker for SM›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test_aprop_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> valuation_impl <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">test_aprop_impl</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> eval_exp_impl <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="main">⦇</span> local_state_impl.variables <span class="main">=</span> vi_empty <span class="main">⦈</span><span class="main">,</span>
    <span class="main">⦇</span> global_state_impl.variables <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⦈</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> bool_of_val_impl <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sm_to_sa</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"program <span class="main">⇒</span> <span class="main">(</span>ident <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>pid_global_config_impl<span class="main">,</span>exp set<span class="main">)</span> sa_rec"</span></span> 
  <span class="comment1">― ‹Conversion of a Boolean program to a system automata.›</span>
  <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">sm_to_sa</span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="free"><span class="bound"><span class="entity">is_vis_var</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span>
    <span class="bound">cinf</span> <span class="main">=</span> comp_info_of <span class="free"><span class="bound"><span class="entity">prog</span></span></span>
  <span class="keyword1">in</span>
    <span class="main">⦇</span>
      g_V <span class="main">=</span> UNIV<span class="main">,</span>
      g_E <span class="main">=</span> E_of_succ <span class="main">(</span>set <span class="keyword1">o</span> impl4_succ_impl <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">cinf</span> <span class="free"><span class="bound"><span class="entity">is_vis_var</span></span></span><span class="main">)</span><span class="main">,</span>
      g_V0 <span class="main">=</span> <span class="main">{</span>pid_init_gc_impl_impl <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">cinf</span><span class="main">}</span><span class="main">,</span>
      sa_L <span class="main">=</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> test_aprop_impl <span class="bound">e</span> <span class="main">(</span>global_state_impl.variables <span class="main">(</span>pid_global_config.state <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_state_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> vi_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span> local_state_impl.variables <span class="main">=</span> <span class="free">s'</span> <span class="main">⦈</span><span class="main">,</span> <span class="main">⦇</span> local_state.variables <span class="main">=</span> <span class="free">s</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">∈</span> local_state_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms vi_rel_rew <span class="keyword1"><span class="command">unfolding</span></span> local_state_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">lemma</span></span> global_state_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> vi_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⦇</span> global_state_impl.variables <span class="main">=</span> <span class="free">s'</span> <span class="main">⦈</span><span class="main">,</span> <span class="main">⦇</span> global_state.variables <span class="main">=</span> <span class="free">s</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">∈</span> global_state_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms vi_rel_rew <span class="keyword1"><span class="command">unfolding</span></span> global_state_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> test_aprop_impl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>test_aprop_impl<span class="main">,</span> test_aprop<span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> vi_rel <span class="main">→</span> bool_rel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">s'</span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vi_empty<span class="main">,</span> Map.empty<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>vi_rel <span class="main">::</span> <span class="main">(</span>valuation_impl <span class="main">×</span> valuation<span class="main">)</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vi_rel_rew vi_empty_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>vi_rel <span class="main">::</span> <span class="main">(</span>valuation_impl <span class="main">×</span> valuation<span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>test_aprop_impl <span class="skolem">e</span> <span class="skolem">s'</span><span class="main">,</span> test_aprop <span class="skolem">e</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> test_aprop_def test_aprop_impl_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">parametricity</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_exp_impl bool_of_val_impl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> IdI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> local_state_rel 0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> global_state_rel 1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"test_aprop_impl <span class="skolem">e</span> <span class="skolem">s'</span> <span class="main">⟷</span> test_aprop <span class="skolem">e</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_parametric<span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_option <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> rel_set <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_option <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(|`)</span> <span class="main">(|`)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms bi_uniqueDl bi_uniqueDr option.rel_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
    rel_funD rel_setD1 rel_setD2 restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> restrict <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(|`)</span>"</span></span> <span class="keyword2"><span class="keyword">parametric</span></span> restrict_parametric <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> vi_restrict <span class="main">::</span> <span class="quoted"><span class="quoted">"valuation_impl <span class="main">⇒</span> ident set <span class="main">⇒</span> valuation_impl"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(|`)</span> <span class="main">::</span> valuation <span class="main">⇒</span> ident set <span class="main">⇒</span> valuation"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vi_restrict <span class="main">=</span> restrict"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> vi_restrict_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"vi_α <span class="main">(</span>vi_restrict <span class="free">s</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> vi_α <span class="free">s</span> <span class="main">|`</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vi_α_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fun.comp_def option.map_ident<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> <span class="entity">pid_test_gc_impl</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"pid_global_config_impl <span class="main">⇒</span> exp <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pid_test_gc_impl</span> <span class="free"><span class="bound"><span class="entity">gci</span></span></span> <span class="free"><span class="bound"><span class="entity">ap</span></span></span> <span class="main">≡</span> test_aprop_impl <span class="free"><span class="bound"><span class="entity">ap</span></span></span>
    <span class="main">(</span><span class="main">(</span>global_state_impl.variables <span class="main">(</span>pid_global_config.state <span class="free"><span class="bound"><span class="entity">gci</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sm_to_sa_impl</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"program <span class="main">⇒</span> <span class="main">(</span>ident <span class="main">⇒</span> bool<span class="main">)</span> 
  <span class="main">⇒</span> <span class="main">(</span>pid_global_config_impl<span class="main">,</span>exp <span class="main">⇒</span> bool<span class="main">,</span>unit<span class="main">)</span> sa_impl_scheme"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">sm_to_sa_impl</span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="free"><span class="bound"><span class="entity">is_vis_var</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span>
    <span class="bound">cinf</span> <span class="main">=</span> comp_info_of <span class="free"><span class="bound"><span class="entity">prog</span></span></span>
  <span class="keyword1">in</span>  
    <span class="main">⦇</span> gi_V <span class="main">=</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">,</span>
      gi_E <span class="main">=</span> remdups <span class="keyword1">o</span> impl4_succ_impl <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">cinf</span> <span class="free"><span class="bound"><span class="entity">is_vis_var</span></span></span><span class="main">,</span> <span class="comment1">― ‹TODO: This remdups is unnecessary!›</span>
      gi_V0 <span class="main">=</span> <span class="main">[</span>pid_init_gc_impl_impl <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">cinf</span><span class="main">]</span><span class="main">,</span>
      sai_L <span class="main">=</span> pid_test_gc_impl  
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sm_to_sa_impl_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sm_to_sa_impl <span class="free">prog</span> <span class="free">is_vis_var</span><span class="main">,</span> sm_to_sa <span class="free">prog</span> <span class="free">is_vis_var</span><span class="main">)</span> 
  <span class="main">∈</span> sa_impl_rel_ext unit_rel Id <span class="main">(</span><span class="main">⟨</span>Id<span class="main">⟩</span>fun_set_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sm_to_sa_impl_def sm_to_sa_def 
  <span class="keyword1"><span class="command">unfolding</span></span> sa_impl_rel_eext_def g_impl_rel_ext_def
  <span class="keyword1"><span class="command">unfolding</span></span> gen_sa_impl_rel_eext_def gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_set_rel_def br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> E_of_succ_refine<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_set_rel_def br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_set_rel_def br_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_set_rel_def br_def pid_test_gc_impl_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> E_of_succ_is_rel_of_succ<span class="main">:</span> <span class="quoted"><span class="quoted">"E_of_succ <span class="main">=</span> rel_of_succ"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def rel_of_succ_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vi_γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"valuation <span class="main">⇒</span> valuation_impl"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vi_γ</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span>Mapping.Mapping <span class="main">(</span>map_option Abs_uint32 <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vi_α <span class="main">(</span>vi_γ <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vi_α_def vi_γ_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mapping_inverse option.map_comp option.map_ident Abs_uint32_inverse o_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vi_γ <span class="main">(</span>vi_α <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vi_α_def vi_γ_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mapping.rep_inverse option.map_comp option.map_ident Rep_uint32_inverse o_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lsi_α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"local_state_impl <span class="main">⇒</span> local_state"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lsi_α</span> <span class="free"><span class="bound"><span class="entity">lsi</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> local_state.variables <span class="main">=</span> vi_α <span class="main">(</span>local_state_impl.variables <span class="free"><span class="bound"><span class="entity">lsi</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lsi_γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"local_state <span class="main">⇒</span> local_state_impl"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lsi_γ</span> <span class="free"><span class="bound"><span class="entity">lsi</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> local_state_impl.variables <span class="main">=</span> vi_γ <span class="main">(</span>local_state.variables <span class="free"><span class="bound"><span class="entity">lsi</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"lsi_α <span class="main">(</span>lsi_γ <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> <span class="free">ls</span>"</span></span>
  <span class="quoted"><span class="quoted">"lsi_γ <span class="main">(</span>lsi_α <span class="free">lsi</span><span class="main">)</span> <span class="main">=</span> <span class="free">lsi</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lsi_α_def lsi_γ_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> local_state_rel_as_br<span class="main">:</span> <span class="quoted"><span class="quoted">"local_state_rel <span class="main">=</span> br lsi_α <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_state_rel_def br_def lsi_α_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gsi_α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"global_state_impl <span class="main">⇒</span> global_state"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gsi_α</span> <span class="free"><span class="bound"><span class="entity">gsi</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> global_state.variables <span class="main">=</span> vi_α <span class="main">(</span>global_state_impl.variables <span class="free"><span class="bound"><span class="entity">gsi</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gsi_γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"global_state <span class="main">⇒</span> global_state_impl"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gsi_γ</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> global_state_impl.variables <span class="main">=</span> vi_γ <span class="main">(</span>global_state.variables <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"gsi_α <span class="main">(</span>gsi_γ <span class="free">gs</span><span class="main">)</span> <span class="main">=</span> <span class="free">gs</span>"</span></span>
  <span class="quoted"><span class="quoted">"gsi_γ <span class="main">(</span>gsi_α <span class="free">gsi</span><span class="main">)</span> <span class="main">=</span> <span class="free">gsi</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gsi_α_def gsi_γ_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> global_state_rel_as_br<span class="main">:</span> <span class="quoted"><span class="quoted">"global_state_rel <span class="main">=</span> br gsi_α <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> global_state_rel_def br_def gsi_α_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_local_config</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> Gen_Scheduler.local_config <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> Gen_Scheduler.local_config"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_local_config</span> <span class="free"><span class="bound"><span class="entity">mc</span></span></span> <span class="free"><span class="bound"><span class="entity">ms</span></span></span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> 
    local_config.command <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mc</span></span></span> <span class="main">(</span>local_config.command <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">,</span>
    local_config.state <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ms</span></span></span> <span class="main">(</span>local_config.state <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_local_config <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"map_local_config <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>map_local_config <span class="free">f'</span> <span class="free">g'</span> <span class="free">lc</span><span class="main">)</span> <span class="main">=</span> map_local_config <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">f'</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">g'</span><span class="main">)</span> <span class="free">lc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_local_config_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_pid_global_config</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">⇒</span><span class="tfree">'f</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> Pid_Scheduler.pid_global_config <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span><span class="main">,</span><span class="tfree">'e</span><span class="main">,</span><span class="tfree">'f</span><span class="main">)</span> Pid_Scheduler.pid_global_config"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_pid_global_config</span> <span class="free"><span class="bound"><span class="entity">mp</span></span></span> <span class="free"><span class="bound"><span class="entity">ml</span></span></span> <span class="free"><span class="bound"><span class="entity">mg</span></span></span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> 
    pid_global_config.processes <span class="main">=</span> map <span class="main">(</span>map_local_config <span class="free"><span class="bound"><span class="entity">mp</span></span></span> <span class="free"><span class="bound"><span class="entity">ml</span></span></span><span class="main">)</span> <span class="main">(</span>pid_global_config.processes <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">)</span><span class="main">,</span>
    pid_global_config.state <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mg</span></span></span> <span class="main">(</span>pid_global_config.state <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_pid_global_config <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"map_pid_global_config <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="main">(</span>map_pid_global_config <span class="free">f'</span> <span class="free">g'</span> <span class="free">h'</span> <span class="free">gc</span><span class="main">)</span> 
  <span class="main">=</span> map_pid_global_config <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">f'</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="keyword1">o</span> <span class="free">h'</span><span class="main">)</span> <span class="free">gc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_pid_global_config_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lci_α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"local_config_impl <span class="main">⇒</span> local_config"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lci_α</span> <span class="main">≡</span> map_local_config <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> lsi_α"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lci_γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"local_config <span class="main">⇒</span> local_config_impl"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lci_γ</span> <span class="main">≡</span> map_local_config <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> lsi_γ"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gci_α</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pid_global_config_impl <span class="main">⇒</span> pid_global_config"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gci_α</span> <span class="main">≡</span> map_pid_global_config <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> lsi_α gsi_α"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gci_γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pid_global_config <span class="main">⇒</span> pid_global_config_impl"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gci_γ</span> <span class="main">≡</span> map_pid_global_config <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> lsi_γ gsi_γ"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> local_config_rel_as_br<span class="main">:</span> <span class="quoted"><span class="quoted">"local_config_rel <span class="main">=</span> br lci_α <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> local_config_rel_def br_def map_local_config_def local_state_rel_as_br<span class="main">)</span>
  
<span class="keyword1"><span class="command">thm</span></span> list_all2_induct
<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> list_all2_map_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">ys</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">=</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> pid_global_config_rel_as_br<span class="main">:</span> <span class="quoted"><span class="quoted">"global_config_rel <span class="main">=</span> br gci_α <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> global_config_rel_def br_def map_pid_global_config_def 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> global_state_rel_as_br local_config_rel_as_br
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> global_config_rel_inv_sv<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span>global_config_rel<span class="main">¯</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pid_global_config_rel_as_br br_def<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"gci_α <span class="skolem">x</span> <span class="main">=</span> gci_α <span class="skolem">y</span>"</span></span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"gci_γ <span class="main">(</span>gci_α <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> gci_γ <span class="main">(</span>gci_α <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> pred_of_enex_mono<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">en</span> <span class="free">c</span> <span class="main">⊆</span> <span class="free">en'</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pred_of_enex <span class="main">(</span><span class="free">en</span><span class="main">,</span><span class="free">ex</span><span class="main">)</span> <span class="free">c</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_of_enex <span class="main">(</span><span class="free">en'</span><span class="main">,</span><span class="free">ex</span><span class="main">)</span> <span class="free">c</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_ample_reachable<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ty_program <span class="free">prog</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite
     <span class="main">(</span><span class="main">(</span>E_of_succ <span class="main">(</span><span class="main">(</span>set <span class="main">∘∘</span> impl4_succ_impl <span class="free">prog</span> <span class="main">(</span>comp_info_of <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="free">is_vis_var</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span>
      <span class="main">{</span>pid_init_gc_impl_impl <span class="free">prog</span> <span class="main">(</span>comp_info_of <span class="free">prog</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> visible_prog <span class="quoted"><span class="free">prog</span></span> <span class="quoted"><span class="free">is_vis_var</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"E_of_succ <span class="main">(</span><span class="main">(</span>set <span class="main">∘∘</span> impl4_succ_impl <span class="free">prog</span> <span class="main">(</span>comp_info_of <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="free">is_vis_var</span><span class="main">)</span> 
    <span class="main">=</span> ample_step_impl4 <span class="free">is_vis_var</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> 
          <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> impl4_succ_pred<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> E_of_succ_is_rel_of_succ
          <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> impl4_succ_impl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> ample_step_impl4<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"E_of_succ <span class="main">(</span><span class="main">(</span>set <span class="main">∘∘</span> impl4_succ_impl <span class="free">prog</span> <span class="main">(</span>comp_info_of <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="free">is_vis_var</span><span class="main">)</span> 
    <span class="main">=</span> ample_step_impl3"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> S_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> ample_step_impl3<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span>pid_init_gc_impl<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pid_init_gc_impl_impl<span class="main">)</span>

  <span class="comment1">(* TODO: Move as sublocale to SM_Ample_Impl in visible_prog-context,
    before interpretation as impl3_sim.b ! *)</span>  
  <span class="keyword1"><span class="command">interpret</span></span> impl2<span class="main">:</span> sa <span class="quoted"><span class="quoted">"<span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> ample_step_impl2<span class="main">,</span>
    g_V0 <span class="main">=</span> <span class="main">{</span>pid_init_gc<span class="main">}</span><span class="main">,</span> sa_L <span class="main">=</span> pid_interp_gc <span class="main">⦈</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

  <span class="comment1">(* TODO: Duplicated from prf of cr_ample_impl2_reduction *)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"ample_step_impl2 <span class="main">=</span> rel_of_enex <span class="main">(</span>cr_ample_impl1<span class="main">,</span> ga_ex<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ample_step_impl2_def cr_ample_impl1_def cr_ample_impl2_def
    <span class="keyword1"><span class="command">unfolding</span></span> ga_gample_mi2_impl<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">gc</span> <span class="main">::</span> <span class="quoted">pid_global_config</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cr_ample <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="skolem">gc</span> <span class="main">⊆</span> ga_en <span class="skolem">gc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cr_ample_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> find_fas_init_correct<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sticky_E</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ga_ample <span class="skolem">sticky_E</span> <span class="skolem">gc</span> <span class="main">⊆</span> ga_en <span class="skolem">gc</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ga_ample <span class="skolem">sticky_E</span> <span class="skolem">gc</span> <span class="main">=</span> ga_en <span class="skolem">gc</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ga_ample_neq_en_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">sticky_E</span></span> <span class="quoted"><span class="skolem">gc</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ga_gample_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sticky_E</span></span> <span class="quoted"><span class="skolem">gc</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>    
    <span class="keyword1"><span class="command">from</span></span> order_trans<span class="main">[</span><span class="operator">OF</span> cr_ample_impl1.refine<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> nres_relD<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cr_ample_impl1 <span class="skolem">gc</span> <span class="main">⊆</span> ga_en <span class="skolem">gc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux1<span class="main">=</span>this

  <span class="keyword1"><span class="command">interpret</span></span> simulation <span class="quoted">Id</span>
    <span class="quoted"><span class="quoted">"<span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> rel_of_enex <span class="main">(</span>cr_ample_impl1<span class="main">,</span>ga_ex<span class="main">)</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="main">{</span>pid_init_gc<span class="main">}</span> <span class="main">⦈</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> ga_step<span class="main">,</span> g_V0 <span class="main">=</span> <span class="main">{</span>pid_init_gc<span class="main">}</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ga_step_alt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> pred_of_enex_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted">cr_ample_impl1</span> <span class="main">_</span> <span class="quoted">ga_en</span> <span class="quoted">ga_ex</span><span class="main">,</span><span class="operator">OF</span> aux1<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


  <span class="keyword1"><span class="command">have</span></span> FIN2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ample_step_impl2<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span>pid_init_gc<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1
    <span class="keyword1"><span class="command">unfolding</span></span> graph_rec.simps
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reachable_finite_sim<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> graph_rec.simps<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> jsys.reachable_finite
    <span class="keyword1"><span class="command">using</span></span> reachable_alt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>    

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_eq
    <span class="keyword1"><span class="command">using</span></span> impl3_sim.s1.reachable_finite_sim FIN2 finite_Image_sv<span class="main">[</span><span class="operator">OF</span> global_config_rel_inv_sv<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
 

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ty_program <span class="free">prog</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> sm_to_sa_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"sa <span class="main">(</span>sm_to_sa <span class="free">prog</span> <span class="free">is_vis_var</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sm_to_sa_fr<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>sm_to_sa <span class="free">prog</span> <span class="free">is_vis_var</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>sm_to_sa <span class="free">prog</span> <span class="free">is_vis_var</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sm_to_sa_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mapping_val_hashcode</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∑</span><span class="main">(</span><span class="main">(</span>hashcode <span class="keyword1">o</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">`</span>Mapping.keys <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> local_config_ext <span class="main">::</span> <span class="main">(</span><span class="quoted">hashable</span><span class="main">,</span><span class="quoted">hashable</span><span class="main">,</span><span class="quoted">hashable</span><span class="main">)</span><span class="quoted">hashable</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"hashcode <span class="free"><span class="bound"><span class="entity">lc</span></span></span> <span class="main">≡</span> 
      hashcode <span class="main">(</span>local_config.command <span class="free"><span class="bound"><span class="entity">lc</span></span></span><span class="main">)</span> 
    <span class="main">+</span> hashcode <span class="main">(</span>local_config.state <span class="free"><span class="bound"><span class="entity">lc</span></span></span><span class="main">)</span>
    <span class="main">+</span> hashcode <span class="main">(</span>local_config.more <span class="free"><span class="bound"><span class="entity">lc</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"def_hashmap_size <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> local_config_ext itself<span class="main">)</span> <span class="main">≡</span> <span class="numeral">8</span>"</span></span>  

  <span class="keyword1"><span class="command">instance</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
    <span class="keyword1"><span class="command">unfolding</span></span> def_hashmap_size_local_config_ext_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Pid_Scheduler.pid_global_config_ext <span class="main">::</span> <span class="main">(</span><span class="quoted">hashable</span><span class="main">,</span><span class="quoted">hashable</span><span class="main">,</span><span class="quoted">hashable</span><span class="main">,</span><span class="quoted">hashable</span><span class="main">)</span> <span class="quoted">hashable</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"hashcode <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">≡</span> 
      hashcode <span class="main">(</span>pid_global_config.processes <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">)</span>
    <span class="main">+</span> hashcode <span class="main">(</span>pid_global_config.state <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">)</span>
    <span class="main">+</span> hashcode <span class="main">(</span>pid_global_config.more <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"def_hashmap_size <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">,</span><span class="tfree">'d</span><span class="main">)</span> pid_global_config_ext itself<span class="main">)</span> <span class="main">≡</span> <span class="numeral">8</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
    <span class="keyword1"><span class="command">unfolding</span></span> def_hashmap_size_pid_global_config_ext_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> local_state_impl_ext <span class="main">::</span> <span class="main">(</span><span class="quoted">hashable</span><span class="main">)</span><span class="quoted">hashable</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"rm.iterate <span class="free">r</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="bound">s</span><span class="main">.</span> hashcode <span class="bound">k</span> <span class="main">+</span> hashcode <span class="bound">v</span> <span class="main">+</span> <span class="bound">s</span><span class="main">)</span> <span class="main">0</span>"</span></span>

  <span class="comment1">(* TODO: Derive sensible hashcode! *)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"hashcode <span class="free"><span class="bound"><span class="entity">ls</span></span></span> 
    <span class="main">≡</span> mapping_val_hashcode <span class="main">(</span>local_state_impl.variables <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> 
     <span class="main">+</span> hashcode <span class="main">(</span>local_state_impl.more <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"def_hashmap_size <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> local_state_impl_ext itself<span class="main">)</span> <span class="main">≡</span> <span class="numeral">8</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
    <span class="keyword1"><span class="command">unfolding</span></span> def_hashmap_size_local_state_impl_ext_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> global_state_impl_ext <span class="main">::</span> <span class="main">(</span><span class="quoted">hashable</span><span class="main">)</span><span class="quoted">hashable</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"rm.iterate <span class="free">r</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="bound">s</span><span class="main">.</span> hashcode <span class="bound">k</span> <span class="main">+</span> hashcode <span class="bound">v</span> <span class="main">+</span> <span class="bound">s</span><span class="main">)</span> <span class="main">0</span>"</span></span>

  <span class="comment1">(* TODO: Derive sensible hashcode! *)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"hashcode <span class="free"><span class="bound"><span class="entity">gs</span></span></span> 
    <span class="main">≡</span> mapping_val_hashcode <span class="main">(</span>global_state_impl.variables <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span>
    <span class="main">+</span> hashcode <span class="main">(</span>global_state_impl.more <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"def_hashmap_size <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> global_state_impl_ext itself<span class="main">)</span> <span class="main">≡</span> <span class="numeral">8</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">intro_classes</span>
    <span class="keyword1"><span class="command">unfolding</span></span> def_hashmap_size_global_state_impl_ext_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* TODO: Move. TODO: Can we generate a more efficient comparator. 
  Perhaps using code_printing? *)</span>
<span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹
  <span class="entity">Comparator_Generator.register_foreign_comparator</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">String.literal</span><span class="antiquote">}</span></span>
    <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"comparator_of <span class="main">::</span> String.literal <span class="main">⇒</span> <span class="main">_</span>"</span><span class="antiquote">}</span></span>
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> comparator_of<span class="main">[</span><span class="operator">where</span> 'a<span class="main"><span class="main">=</span></span><span class="quoted">String.literal</span><span class="main">]</span><span class="antiquote">}</span></span></span>
›</span>

<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">un_op</span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">bin_op</span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">exp</span>

<span class="keyword1"><span class="command">datatype</span></span> sm_result <span class="main">=</span> TY_ERR <span class="main">|</span> SAT <span class="main">|</span> UNSAT <span class="main">|</span> UNSAT_CE <span class="quoted"><span class="quoted">"pid_global_config_impl lasso"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cava_sm</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> 
  <span class="keyword1">let</span> <span class="bound">prog</span> <span class="main">=</span> dloc <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>
  <span class="keyword1">if</span> ty_program <span class="bound">prog</span> <span class="main">∧</span> ltlc_next_free <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">then</span>
    <span class="keyword1">case</span> cava_sys_agn <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">(</span>sm_to_sa_impl <span class="bound">prog</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>vars_of_ltlc <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> SAT
    <span class="main">|</span> Some None <span class="main">⇒</span> UNSAT
    <span class="main">|</span> Some <span class="main">(</span>Some <span class="bound">ce</span><span class="main">)</span> <span class="main">⇒</span> UNSAT_CE <span class="bound">ce</span>
  <span class="keyword1">else</span> TY_ERR<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Relation that relates states of computed counterexample with
  states of actual run in reference point semantics. Unfortunately,
  we cannot exactly recompute the reference point run b/c we cannot undo
  the effect of the locality decider. ›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sm_gc_rel</span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">gci</span><span class="main">,</span> <span class="bound">gc</span><span class="main">)</span><span class="main">.</span> map_option dloc_gc <span class="bound">gc</span> <span class="main">=</span> Some <span class="main">(</span>cprog.gc_α <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main">(</span>pidgc_α <span class="main">(</span>gci_α <span class="bound">gci</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sm_props_of_gc</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span> <span class="main">≡</span> sm_props <span class="main">(</span>global_state.variables <span class="main">(</span>global_config.state <span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lang_eq_on_ss_ltlc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">interp</span> <span class="free">interp'</span> <span class="free">P</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">P</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">interp</span> <span class="keyword1">o</span> <span class="bound">r</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">L'</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">P</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">interp'</span> <span class="keyword1">o</span> <span class="bound">r</span> <span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">P</span> <span class="bound">r</span> <span class="main">⟹</span> pw_eq_on <span class="main">(</span>atoms_ltlc <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">interp</span> <span class="keyword1">o</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">interp'</span> <span class="keyword1">o</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span> <span class="main">⟷</span> <span class="free">L'</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="free">P</span> <span class="bound">r</span> <span class="main">⟹</span> pw_eq_on <span class="main">(</span>atoms_ltlc <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">interp'</span> <span class="keyword1">o</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">interp</span> <span class="keyword1">o</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pw_eq_on_sym<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def L'_def language_ltlc_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ltlc_eq_on<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ltlc_eq_on<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> 2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ltlc_eq_on<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> 1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness theorem for the model checker on SM programs.›</span></span>
<span class="comment1">(* TODO: variables occurring in the formula but not as global variables in the
  program should also be a type error *)</span>
<span class="keyword1"><span class="command">theorem</span></span> cava_sm_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> cava_sm <span class="free">config</span> <span class="free">prog</span> <span class="free">φ</span> <span class="keyword1">of</span> 
    TY_ERR <span class="main">⇒</span> <span class="main">¬</span>ty_program <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span>ltlc_next_free <span class="free">φ</span>
  <span class="main">|</span> SAT <span class="main">⇒</span> Collect <span class="main">(</span>ap_accept <span class="free">prog</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>
  <span class="main">|</span> UNSAT <span class="main">⇒</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span>Collect <span class="main">(</span>ap_accept <span class="free">prog</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> UNSAT_CE <span class="bound">ce</span> <span class="main">⇒</span> <span class="main">¬</span><span class="main">(</span>Collect <span class="main">(</span>ap_accept <span class="free">prog</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>run_of_lasso <span class="bound">ce</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> run_rel <span class="main">(</span>sm_gc_rel <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> ref_is_run <span class="free">prog</span> <span class="bound">r</span>
        <span class="main">∧</span> sm_props_of_gc <span class="keyword1">o</span> <span class="bound">r</span> <span class="main">∉</span> language_ltlc <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cava_sm_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?is_vis_var</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_of_ltlc <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?csa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cava_sys_agn <span class="free">config</span> <span class="main">(</span>sm_to_sa_impl <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="var">?is_vis_var</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> TY<span class="main">:</span> <span class="quoted"><span class="quoted">"ty_program <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> visible_prog <span class="quoted"><span class="quoted">"<span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>vars_of_ltlc <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    
  <span class="keyword1"><span class="command">interpret</span></span> sm_to_sa<span class="main">:</span> sa <span class="quoted"><span class="quoted">"<span class="main">(</span>sm_to_sa <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="var">?is_vis_var</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sm_to_sa_invar<span class="main">[</span><span class="operator">OF</span> TY<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">assume</span></span> NF<span class="main">:</span> <span class="quoted"><span class="quoted">"ltlc_next_free <span class="free">φ</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> csa_correct <span class="main">=</span> cava_sys_agn_correct<span class="main">[</span><span class="operator">OF</span> sm_to_sa_impl_refine sm_to_sa_invar sm_to_sa_fr<span class="main">,</span>
      <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?is_vis_var</span></span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">config</span></span><span class="main">]</span>
    
  <span class="keyword1"><span class="command">have</span></span> aprop_impl_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">v</span><span class="main">.</span> test_aprop_impl <span class="bound">e</span> <span class="bound">v</span> <span class="main">=</span> test_aprop <span class="bound">e</span> <span class="main">(</span>vi_α <span class="bound">v</span><span class="main">)</span>"</span></span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> IdD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">parametricity</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> test_aprop_impl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> lang_ss_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"sa.lang <span class="main">(</span>sm_to_sa <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="var">?is_vis_var</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>
    <span class="main">⟷</span> Collect <span class="main">(</span>ample_impl.accept <span class="var">?is_vis_var</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sm_to_sa.lang_def sm_to_sa.accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> graph_defs.is_run_def
    <span class="keyword1"><span class="command">unfolding</span></span> sm_to_sa_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ample_impl.accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> graph_defs.is_run_def
    <span class="keyword1"><span class="command">unfolding</span></span> impl4_succ_impl ample_step_impl4_impl
    <span class="keyword1"><span class="command">unfolding</span></span> impl4_succ_pred<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> E_of_succ_is_rel_of_succ
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pid_init_gc_impl_impl <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="main">(</span>comp_info_of <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> conj_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="comment1">(* TODO: Hack *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lang_eq_on_ss_ltlc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_on_def pid_interp_gc_impl_def aprop_impl_conv sm_props_def test_aprop_vars_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?csa</span><span class="main">=</span>None"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ap_accept <span class="free">prog</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> dloc_sim.accept_bisim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">prog</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"ap_accept <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> ap_accept_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> csa_correct N TY <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sa.lang <span class="main">(</span>sm_to_sa <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="var">?is_vis_var</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>ample_impl.accept <span class="var">?is_vis_var</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_ss_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ample_reduction_correct<span class="main">[</span><span class="operator">OF</span> TY NF<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>ap_accept <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>language_ltlc <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ACC <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?csa</span><span class="main">=</span>Some None"</span></span> 
    
    <span class="keyword1"><span class="command">from</span></span> csa_correct N TY <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sa.lang <span class="main">(</span>sm_to_sa <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="var">?is_vis_var</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Collect <span class="main">(</span>ample_impl.accept <span class="var">?is_vis_var</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_ss_conv<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> ample_reduction_correct<span class="main">[</span><span class="operator">OF</span> TY NF<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Collect <span class="main">(</span>ap_accept <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>ap_accept <span class="free">prog</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>ap_accept <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dloc_sim.accept_bisim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">prog</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ap_accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">ce</span>
    <span class="keyword3"><span class="command">assume</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?csa</span><span class="main">=</span>Some <span class="main">(</span>Some <span class="skolem">ce</span><span class="main">)</span>"</span></span> 

    <span class="keyword1"><span class="command">from</span></span> csa_correct N TY <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span>
      <span class="quoted"><span class="quoted">"graph_defs.is_run <span class="main">(</span>sm_to_sa <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_of_ltlc <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_of_lasso <span class="skolem">ce</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> NL<span class="main">:</span>  
      <span class="quoted"><span class="quoted">"<span class="main">(</span>sa_L <span class="main">(</span>sm_to_sa <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_of_ltlc <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>run_of_lasso <span class="skolem">ce</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">∉</span> language_ltlc <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

    <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"graph_defs.is_run <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> ample_step_impl4_impl <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span>
      <span class="main">(</span>comp_info_of <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="var">?is_vis_var</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="main">{</span>pid_init_gc_impl_impl <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span>
      <span class="main">(</span>comp_info_of <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> sa_L <span class="main">=</span> pid_interp_gc_impl <span class="var">?is_vis_var</span> <span class="main">⦈</span> <span class="main">(</span>run_of_lasso <span class="skolem">ce</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> graph_defs.is_run_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ipath_def impl4_succ_pred<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        sm_to_sa_def E_of_succ_def  pid_init_gc_impl_impl ample_step_impl4_impl impl4_succ_impl<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> ample_step_impl4 <span class="keyword1"><span class="command">have</span></span> R3<span class="main">:</span> <span class="quoted"><span class="quoted">"graph_defs.is_run <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span>
      g_E <span class="main">=</span> visible_prog.ample_step_impl3 <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_of_ltlc <span class="free">φ</span><span class="main">)</span><span class="main">,</span>
      g_V0 <span class="main">=</span> <span class="main">{</span>cprog.pid_init_gc_impl <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
      sa_L <span class="main">=</span> pid_interp_gc_impl <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_of_ltlc <span class="free">φ</span><span class="main">)</span> <span class="main">⦈</span> <span class="main">(</span>run_of_lasso <span class="skolem">ce</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pid_init_gc_impl_impl ample_step_impl4_impl<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> impl3_sim.br_run_conv<span class="main">[</span><span class="operator">OF</span> pid_global_config_rel_as_br<span class="main">]</span> R3 
    <span class="keyword1"><span class="command">have</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"graph_defs.is_run <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> visible_prog.ample_step_impl2 <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_of_ltlc <span class="free">φ</span><span class="main">)</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="main">{</span>cprog.pid_init_gc <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
      sa_L <span class="main">=</span> visible_prog.pid_interp_gc <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_of_ltlc <span class="free">φ</span><span class="main">)</span> <span class="main">⦈</span> <span class="main">(</span>gci_α <span class="keyword1">o</span> run_of_lasso <span class="skolem">ce</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="comment1">(* TODO: The whole next 100 lines duplicated from finiteness proof *)</span>  
    <span class="comment1">(* TODO: Duplicated from prf of cr_ample_impl2_reduction *)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"ample_step_impl2 <span class="main">=</span> rel_of_enex <span class="main">(</span>cr_ample_impl1<span class="main">,</span> ga_ex<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ample_step_impl2_def cr_ample_impl1_def cr_ample_impl2_def
      <span class="keyword1"><span class="command">unfolding</span></span> ga_gample_mi2_impl<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">gc</span> <span class="main">::</span> <span class="quoted">pid_global_config</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cr_ample <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="skolem">gc</span> <span class="main">⊆</span> ga_en <span class="skolem">gc</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> cr_ample_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_vcg</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> find_fas_init_correct<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sticky_E</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ga_ample <span class="skolem">sticky_E</span> <span class="skolem">gc</span> <span class="main">⊆</span> ga_en <span class="skolem">gc</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ga_ample <span class="skolem">sticky_E</span> <span class="skolem">gc</span> <span class="main">=</span> ga_en <span class="skolem">gc</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ga_ample_neq_en_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">sticky_E</span></span> <span class="quoted"><span class="skolem">gc</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> ga_gample_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sticky_E</span></span> <span class="quoted"><span class="skolem">gc</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>    
      <span class="keyword1"><span class="command">from</span></span> order_trans<span class="main">[</span><span class="operator">OF</span> cr_ample_impl1.refine<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> nres_relD<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cr_ample_impl1 <span class="skolem">gc</span> <span class="main">⊆</span> ga_en <span class="skolem">gc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux1<span class="main">=</span>this

    <span class="keyword1"><span class="command">interpret</span></span> simulation <span class="quoted">Id</span>
      <span class="quoted"><span class="quoted">"<span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> ample_step_impl2<span class="main">,</span> g_V0 <span class="main">=</span> <span class="main">{</span>pid_init_gc<span class="main">}</span> <span class="main">⦈</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> ga_step<span class="main">,</span> g_V0 <span class="main">=</span> <span class="main">{</span>pid_init_gc<span class="main">}</span> <span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ga_step_alt 1
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">using</span></span> pred_of_enex_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted">cr_ample_impl1</span> <span class="main">_</span> <span class="quoted">ga_en</span> <span class="quoted">ga_ex</span><span class="main">,</span><span class="operator">OF</span> aux1<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">have</span></span> run_rel_eq_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> run_rel Id <span class="main">⟷</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_rel_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"graph_defs.is_run <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> ample_step_impl2<span class="main">,</span>
      g_V0 <span class="main">=</span> <span class="main">{</span>pid_init_gc<span class="main">}</span> <span class="main">⦈</span> <span class="main">(</span>gci_α <span class="keyword1">o</span> run_of_lasso <span class="skolem">ce</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R2 <span class="keyword1"><span class="command">unfolding</span></span> graph_defs.is_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"graph_defs.is_run <span class="main">(</span>Pid_Gen_Scheduler_linit.ga_automaton <span class="main">(</span>sl_graph.astep_impl
      <span class="main">(</span>approx_reachable_list <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> cfg'_succ_list<span class="main">)</span> la_en' la_ex'
      <span class="main">(</span>cprog.pid_init_gc <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>visible_prog.pid_interp_gc <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> vars_of_ltlc <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>gci_α <span class="keyword1">o</span> run_of_lasso <span class="skolem">ce</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ga_automaton_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> run_sim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ga_automaton_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> graph_defs.is_run_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> ga_run_sim'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ref_is_run <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">∘</span> gc_α <span class="main">∘</span> pidgc_α <span class="main">∘</span> gci_α <span class="keyword1">o</span> <span class="main">(</span>run_of_lasso <span class="skolem">ce</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> dloc_sim.br_run_conv<span class="main">[</span><span class="operator">OF</span> refl<span class="main">,</span> <span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> RUN<span class="main">:</span> <span class="quoted"><span class="quoted">"ref_is_run <span class="free">prog</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> RR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>run_of_lasso <span class="skolem">ce</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> run_rel <span class="main">(</span>sm_gc_rel <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> NL'<span class="main">:</span> <span class="quoted"><span class="quoted">"pid_interp_gc_impl <span class="var">?is_vis_var</span> <span class="main">∘</span> <span class="main">(</span>run_of_lasso <span class="skolem">ce</span><span class="main">)</span> <span class="main">∉</span> language_ltlc <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command">unfolding</span></span> run_rel_def sm_gc_rel_def fun_eq_iff
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def map_option_def<span class="main">)</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">r</span> <span class="main">⟹</span> <span class="skolem">b</span> <span class="bound">r</span> <span class="main">⟹</span> <span class="skolem">c</span> <span class="bound">r</span> <span class="main">⟹</span> <span class="skolem">thesis</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">a</span><span class="main">)</span>
        
      <span class="keyword1"><span class="command">using</span></span> NL
      <span class="keyword1"><span class="command">unfolding</span></span> language_ltlc_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ltlc_eq_on<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_on_def sm_to_sa_def pid_interp_gc_impl_def 
        aprop_impl_conv sm_props_def test_aprop_vars_cong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pw_eq_on <span class="main">(</span>atoms_ltlc <span class="free">φ</span><span class="main">)</span> 
      <span class="main">(</span>sm_props_of_gc <span class="keyword1">o</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>pid_interp_gc_impl <span class="var">?is_vis_var</span> <span class="keyword1">o</span> run_of_lasso <span class="skolem">ce</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> RR
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pw_eq_on_def run_rel_def sm_gc_rel_def sm_props_of_gc_def
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pid_interp_gc_impl_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sm_props_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dloc_gc_def gc_α_def pidgc_α_def map_pid_global_config_def gsi_α_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> test_aprop_vars_cong
        <span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dloc_gc_def gc_α_def pidgc_α_def map_pid_global_config_def gsi_α_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> test_aprop_vars_cong
        <span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> NL' ltlc_eq_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sm_props_of_gc <span class="main">∘</span> <span class="skolem">r</span> <span class="main">∉</span> language_ltlc <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> language_ltlc_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> RUN RR <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>run_of_lasso <span class="skolem">ce</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> run_rel <span class="main">(</span>sm_gc_rel <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               ref_is_run <span class="free">prog</span> <span class="bound">r</span> <span class="main">∧</span>
               sm_props_of_gc <span class="main">∘</span> <span class="bound">r</span> <span class="main">∉</span> language_ltlc <span class="free">φ</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">{</span></span>  
      <span class="keyword1"><span class="command">from</span></span> R NL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sa.lang <span class="main">(</span>sm_to_sa <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="var">?is_vis_var</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sm_to_sa.lang_def sm_to_sa.accept_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> csa_correct N TY <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sa.lang <span class="main">(</span>sm_to_sa <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span> <span class="var">?is_vis_var</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sm_to_sa.lang_def sm_to_sa.accept_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Collect <span class="main">(</span>ample_impl.accept <span class="var">?is_vis_var</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lang_ss_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ample_reduction_correct<span class="main">[</span><span class="operator">OF</span> TY NF<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Collect <span class="main">(</span>ap_accept <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>ap_accept <span class="free">prog</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>ap_accept <span class="main">(</span>dloc <span class="free">prog</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> language_ltlc <span class="free">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dloc_sim.accept_bisim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">prog</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ap_accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">cava_sm</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extraction of SML Code›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dflt_cfg</span> <span class="main">≡</span> <span class="main">(</span>CFG_L2B_GERTHS<span class="main">,</span><span class="main">()</span><span class="main">,</span>CFG_CE_SCC_GABOW<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="comment1">(* Cava MC *)</span>
            <span class="quoted"><span class="quoted">cava_bpc</span></span> <span class="quoted"><span class="quoted">cava_promela</span></span> <span class="quoted"><span class="quoted">dflt_cfg</span></span> <span class="quoted"><span class="quoted">CAVA_Impl.CFG_CE_NDFS</span></span>
            
            <span class="comment1">(* BP *)</span>
            <span class="quoted"><span class="quoted">BoolProgs.print_config</span></span> <span class="quoted"><span class="quoted">chose_prog</span></span> <span class="quoted"><span class="quoted">list_progs</span></span>
            <span class="quoted"><span class="quoted">BoolProgs_LTL_Conv.ltl_conv</span></span> <span class="quoted"><span class="quoted">BoolProgs_LTL_Conv.CProp</span></span> 
            <span class="quoted"><span class="quoted">BoolProgs_Programs.default_prog</span></span> 
            <span class="quoted"><span class="quoted">BoolProgs_Programs.keys_of_map</span></span>
            <span class="quoted"><span class="quoted">BoolProgs_Programs.default_prog</span></span> <span class="quoted"><span class="quoted">BoolProgs_Programs.keys_of_map</span></span>
            
            <span class="comment1">(* Promela *)</span>
            <span class="quoted"><span class="quoted">printProcesses</span></span> <span class="quoted"><span class="quoted">Promela.printConfigFromAST</span></span> <span class="quoted"><span class="quoted">lookupLTL</span></span>
            <span class="quoted"><span class="quoted">PromelaLTLConv.ltl_conv</span></span>

            <span class="comment1">(* stat printing *)</span>
            <span class="quoted"><span class="quoted">frv_export_code</span></span> <span class="quoted"><span class="quoted">LTL_to_GBA_impl.create_name_gba_code</span></span>

            <span class="comment1">(* Lasso *)</span>
            <span class="quoted"><span class="quoted">lasso_v0</span></span> <span class="quoted"><span class="quoted">lasso_va</span></span> <span class="quoted"><span class="quoted">lasso_reach</span></span> <span class="quoted"><span class="quoted">lasso_cycle</span></span>
            
            <span class="comment1">(* Arith *)</span>
            <span class="quoted"><span class="quoted">nat_of_integer</span></span> <span class="quoted"><span class="quoted">int_of_integer</span></span>
            <span class="quoted"><span class="quoted">integer_of_nat</span></span> <span class="quoted"><span class="quoted">integer_of_int</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> SML 

<span class="keyword1"><span class="command">code_identifier</span></span>
  <span class="keyword2"><span class="keyword">code_module</span></span> String <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> HOLString <span class="main">|</span>
  <span class="keyword2"><span class="keyword">code_module</span></span> Code_Target_Int <span class="main">⇀</span> <span class="main">(</span>SML<span class="main">)</span> Code_Target_Int

<span class="keyword1"><span class="command">export_code</span></span> <span class="comment1">(* Cava MC *)</span>
            <span class="quoted"><span class="quoted">cava_bpc</span></span> <span class="quoted"><span class="quoted">cava_promela</span></span> <span class="quoted"><span class="quoted">dflt_cfg</span></span> <span class="quoted"><span class="quoted">CAVA_Impl.CFG_CE_NDFS</span></span>
            
            <span class="comment1">(* BP *)</span>
            <span class="quoted"><span class="quoted">BoolProgs.print_config</span></span> <span class="quoted"><span class="quoted">chose_prog</span></span> <span class="quoted"><span class="quoted">list_progs</span></span>
            <span class="quoted"><span class="quoted">BoolProgs_LTL_Conv.ltl_conv</span></span> <span class="quoted"><span class="quoted">BoolProgs_LTL_Conv.CProp</span></span> 
            <span class="quoted"><span class="quoted">BoolProgs_Programs.default_prog</span></span> 
            <span class="quoted"><span class="quoted">BoolProgs_Programs.keys_of_map</span></span>
            <span class="quoted"><span class="quoted">BoolProgs_Programs.default_prog</span></span> <span class="quoted"><span class="quoted">BoolProgs_Programs.keys_of_map</span></span>
            
            <span class="comment1">(* Promela *)</span>
            <span class="quoted"><span class="quoted">printProcesses</span></span> <span class="quoted"><span class="quoted">Promela.printConfigFromAST</span></span> <span class="quoted"><span class="quoted">lookupLTL</span></span>
            <span class="quoted"><span class="quoted">PromelaLTLConv.ltl_conv</span></span> <span class="quoted"><span class="quoted">PromelaLTLConv.CProp</span></span> <span class="quoted"><span class="quoted">PromelaLTLConv.Eq</span></span> <span class="quoted"><span class="quoted">PromelaLTLConv.Ident</span></span>

            <span class="comment1">(* stat printing *)</span>
            <span class="quoted"><span class="quoted">frv_export_code</span></span> <span class="quoted"><span class="quoted">LTL_to_GBA_impl.create_name_gba_code</span></span>

            <span class="comment1">(* Lasso *)</span>
            <span class="quoted"><span class="quoted">lasso_v0</span></span> <span class="quoted"><span class="quoted">lasso_va</span></span> <span class="quoted"><span class="quoted">lasso_reach</span></span> <span class="quoted"><span class="quoted">lasso_cycle</span></span>
            
            <span class="comment1">(* Arith *)</span>
            <span class="quoted"><span class="quoted">nat_of_integer</span></span> <span class="quoted"><span class="quoted">int_of_integer</span></span>
            <span class="quoted"><span class="quoted">integer_of_nat</span></span> <span class="quoted"><span class="quoted">integer_of_int</span></span>

            <span class="comment1">(* String *)</span>
            <span class="quoted"><span class="quoted">String.explode</span></span> <span class="quoted"><span class="quoted">String.implode</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> SML
  <span class="keyword2"><span class="keyword">file</span></span> <span class="quoted">‹code/CAVA_Export.sml›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mulog">
<div class="head">
<h1>Theory Mulog</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Mulog
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="CAVA_Impl.html">../CAVA_Impl</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">join</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">join'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">join'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">join'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">nat_to_string</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">nat_to_string</span> <span class="main">0</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''0''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">nat_to_string</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''1''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">nat_to_string</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''2''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">nat_to_string</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''3''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">nat_to_string</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''many''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_to_string</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">int_to_string</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="main">0</span>
      <span class="keyword1">then</span> <span class="keyword1">STR</span> <span class="inner_quoted">''-''</span> <span class="main">+</span> nat_to_string <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> nat_to_string <span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">literal_concat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"String.literal list <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">literal_concat</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> foldr <span class="main">(+)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">0</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_assignments</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"valuation_impl <span class="main">⇒</span> String.literal list"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_assignments</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> map
      <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' = ''</span> <span class="main">+</span> nat_to_string <span class="main">(</span>nat_of_uint32 <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>Mapping.ordered_keys <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">show_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pid_global_config_impl <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_state</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span>
      <span class="bound">gvals</span> <span class="main">=</span> global_state_impl.variables <span class="main">(</span>pid_global_config.state <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">lvals</span> <span class="main">=</span> map <span class="main">(</span>local_state_impl.variables <span class="main">∘</span> local_config.state<span class="main">)</span> <span class="main">(</span>pid_global_config.processes <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
      <span class="keyword1">in</span> literal_concat <span class="main">(</span>join' <span class="main">(</span>concat <span class="main">(</span>map get_assignments <span class="main">(</span><span class="bound">gvals</span> <span class="main">#</span> <span class="bound">lvals</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">'', ''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">show_ce</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pid_global_config_impl lasso <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_ce</span> <span class="free"><span class="bound"><span class="entity">ce</span></span></span> <span class="main">≡</span>
      <span class="keyword1">STR</span> <span class="inner_quoted">''reach''</span> <span class="main">+</span>
      String.implode <span class="main">[</span>lf<span class="main">]</span> <span class="main">+</span>
      literal_concat <span class="main">(</span>join' <span class="main">(</span>remdups_adj <span class="main">(</span>map show_state <span class="main">(</span>lasso_reach <span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>String.implode <span class="main">[</span>lf<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
      String.implode <span class="main">[</span>lf<span class="main">]</span> <span class="main">+</span>
      <span class="keyword1">STR</span> <span class="inner_quoted">''va''</span> <span class="main">+</span>
      String.implode <span class="main">[</span>lf<span class="main">]</span> <span class="main">+</span>
      show_state <span class="main">(</span>lasso_va <span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">)</span> <span class="main">+</span>
      String.implode <span class="main">[</span>lf<span class="main">]</span> <span class="main">+</span>
      <span class="keyword1">STR</span> <span class="inner_quoted">''cysfx''</span> <span class="main">+</span>
      String.implode <span class="main">[</span>lf<span class="main">]</span> <span class="main">+</span>
      literal_concat <span class="main">(</span>join' <span class="main">(</span>remdups_adj <span class="main">(</span>map show_state <span class="main">(</span>lasso_cysfx <span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>String.implode <span class="main">[</span>lf<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> cmd <span class="main">=</span> <span class="quoted">SM_Syntax.cmd</span>

  <span class="keyword1"><span class="command">notation</span></span> cmd.Seq <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 50<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">efalse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">efalse</span> <span class="main">≡</span> e_const <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">etrue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">etrue</span> <span class="main">≡</span> e_const <span class="main">1</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">⇒</span> exp"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">var</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> e_var <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">assign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">⇒</span> exp <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">assign</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> cmd.Assign etrue <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">assignc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> ident <span class="main">⇒</span> exp <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">assignc</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> cmd.Assign <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">wait</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">wait</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> cmd.Test <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">not</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> exp"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">not</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> e_bin bo_eq <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ifelse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> cmd <span class="main">⇒</span> cmd <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ifelse</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">≡</span> cmd.Or <span class="main">(</span>cmd.Test <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="main">(</span>cmd.Test <span class="main">(</span>not <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">var_decl_to_promela</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var_decl <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">var_decl_to_promela</span> <span class="free"><span class="bound"><span class="entity">var_decl</span></span></span> <span class="main">≡</span> <span class="keyword1">STR</span> <span class="inner_quoted">''int''</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' ''</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">var_decl</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">bin_op_to_promela</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bin_op <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_plus <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''+''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_minus <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''-''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_mul <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''*''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_div <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''/''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_mod <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''%''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_less <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''&lt;''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_less_eq <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''&lt;=''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_eq <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''==''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_and <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''&amp;''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_or <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''|''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">bin_op_to_promela</span> bo_xor <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''^''</span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">un_op_to_promela</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"un_op <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">un_op_to_promela</span> uo_minus <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''-''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">un_op_to_promela</span> uo_not <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''~''</span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">exp_to_promela</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">exp_to_promela</span> <span class="main">(</span>e_var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">exp_to_promela</span> <span class="main">(</span>e_localvar <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">exp_to_promela</span> <span class="main">(</span>e_globalvar <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">exp_to_promela</span> <span class="main">(</span>e_const <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> int_to_string <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">exp_to_promela</span> <span class="main">(</span>e_bin <span class="free"><span class="bound"><span class="entity">bo</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''(''</span> <span class="main">+</span> <span class="free">exp_to_promela</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' ''</span> <span class="main">+</span> bin_op_to_promela <span class="free"><span class="bound"><span class="entity">bo</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' ''</span> <span class="main">+</span> <span class="free">exp_to_promela</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">exp_to_promela</span> <span class="main">(</span>e_un <span class="free"><span class="bound"><span class="entity">uo</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''(''</span> <span class="main">+</span> un_op_to_promela <span class="free"><span class="bound"><span class="entity">uo</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' ''</span> <span class="main">+</span> <span class="free">exp_to_promela</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'')''</span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">cmd_to_promela</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"cmd <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">cmd_to_promela</span> <span class="main">(</span>Assign <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''atomic { ''</span> <span class="main">+</span> exp_to_promela <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' -&gt; ''</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' = ''</span> <span class="main">+</span> exp_to_promela <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' }''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">cmd_to_promela</span> <span class="main">(</span>Assign_local <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''atomic { ''</span> <span class="main">+</span> exp_to_promela <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' -&gt; ''</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' = ''</span> <span class="main">+</span> exp_to_promela <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' }''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">cmd_to_promela</span> <span class="main">(</span>Assign_global <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''atomic { ''</span> <span class="main">+</span> exp_to_promela <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' -&gt; ''</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' = ''</span> <span class="main">+</span> exp_to_promela <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' }''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">cmd_to_promela</span> <span class="main">(</span>Test <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> exp_to_promela <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">cmd_to_promela</span> <span class="main">(</span>Skip<span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''skip''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">cmd_to_promela</span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">cmd_to_promela</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''; ''</span> <span class="main">+</span> <span class="free">cmd_to_promela</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">cmd_to_promela</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''if''</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' :: ''</span> <span class="main">+</span> <span class="free">cmd_to_promela</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' :: ''</span> <span class="main">+</span> <span class="free">cmd_to_promela</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' fi''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">cmd_to_promela</span> <span class="main">(</span>Iterate <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="keyword1">then</span>
          <span class="keyword1">STR</span> <span class="inner_quoted">''do''</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' :: ''</span> <span class="main">+</span> <span class="free">cmd_to_promela</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' od''</span>
        <span class="keyword1">else</span>
          Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''General iterate not supported by promela translator''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> undefined<span class="main">)</span>
        <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">proc_decl_to_promela</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proc_decl <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">proc_decl_to_promela</span> <span class="free"><span class="bound"><span class="entity">proc_decl</span></span></span> <span class="main">≡</span>
      <span class="keyword1">STR</span> <span class="inner_quoted">''proctype''</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' ''</span> <span class="main">+</span> name <span class="free"><span class="bound"><span class="entity">proc_decl</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''()''</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' ''</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''{ ''</span> <span class="main">+</span>
      literal_concat <span class="main">(</span>join <span class="main">(</span>map var_decl_to_promela <span class="main">(</span>local_vars <span class="free"><span class="bound"><span class="entity">proc_decl</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''; ''</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
      cmd_to_promela <span class="main">(</span>body <span class="free"><span class="bound"><span class="entity">proc_decl</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' }''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_process_to_promela</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proc_decl <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">run_process_to_promela</span> <span class="free"><span class="bound"><span class="entity">proc_decl</span></span></span> <span class="main">≡</span> <span class="keyword1">STR</span> <span class="inner_quoted">''run''</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' ''</span> <span class="main">+</span> name <span class="free"><span class="bound"><span class="entity">proc_decl</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''()''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">program_to_promela</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"program <span class="main">⇒</span> String.literal"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">program_to_promela</span> <span class="free"><span class="bound"><span class="entity">program</span></span></span> <span class="main">≡</span>
      literal_concat <span class="main">(</span>join <span class="main">(</span>map var_decl_to_promela <span class="main">(</span>global_vars <span class="free"><span class="bound"><span class="entity">program</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''; ''</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
      literal_concat <span class="main">(</span>map proc_decl_to_promela <span class="main">(</span>processes <span class="free"><span class="bound"><span class="entity">program</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
      <span class="keyword1">STR</span> <span class="inner_quoted">''init { ''</span> <span class="main">+</span> literal_concat <span class="main">(</span>join' <span class="main">(</span>map run_process_to_promela <span class="main">(</span>processes <span class="free"><span class="bound"><span class="entity">program</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''; ''</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">'' }''</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lock_lock</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''l''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lock_vars</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">[</span>lock_lock <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">lock_initialize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lock_initialize</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> assign <span class="main">(</span>lock_lock <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> efalse"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">lock_block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">⇒</span> cmd <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lock_block</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
      assignc <span class="main">(</span>not <span class="main">(</span>var <span class="main">(</span>lock_lock <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lock_lock <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> etrue<span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span>
      assign <span class="main">(</span>lock_lock <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> efalse"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_sender</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''s''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_receiver</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''r''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_message</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''m''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_sent</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''n''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_received</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''c''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_vars</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
    concat <span class="main">(</span>map lock_vars <span class="main">[</span>handshake_sender <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> handshake_receiver <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">@</span>
    <span class="main">[</span>handshake_message <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> handshake_sent <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> handshake_received <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">handshake_initialize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_initialize</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
      lock_initialize <span class="main">(</span>handshake_sender <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span>
      lock_initialize <span class="main">(</span>handshake_receiver <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span>
      assign <span class="main">(</span>handshake_message <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span><span class="main">;</span>
      assign <span class="main">(</span>handshake_sent <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> efalse<span class="main">;</span>
      assign <span class="main">(</span>handshake_received <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> efalse"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">handshake_waiting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">⇒</span> exp"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_waiting</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> var <span class="main">(</span>handshake_sent <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">handshake_send</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">⇒</span> exp <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_send</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
      lock_block <span class="main">(</span>handshake_sender <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
      <span class="main">(</span>
        assign <span class="main">(</span>handshake_message <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
        assign <span class="main">(</span>handshake_sent <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> etrue<span class="main">;</span>
        wait <span class="main">(</span>var <span class="main">(</span>handshake_received <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        assign <span class="main">(</span>handshake_received <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> efalse
      <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">handshake_receive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">⇒</span> ident <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">handshake_receive</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
      lock_block <span class="main">(</span>handshake_receiver <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
      <span class="main">(</span>
        wait <span class="main">(</span>var <span class="main">(</span>handshake_sent <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        assign <span class="main">(</span>handshake_sent <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> efalse<span class="main">;</span>
        assign <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>var <span class="main">(</span>handshake_message <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        assign <span class="main">(</span>handshake_received <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> etrue
      <span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_processes</span> <span class="main">≡</span> <span class="main">[</span><span class="keyword1">STR</span> <span class="inner_quoted">''A''</span><span class="main">,</span> <span class="keyword1">STR</span> <span class="inner_quoted">''B''</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_process_ids</span> <span class="main">≡</span> <span class="main">[</span><span class="main">1</span> <span class="main">..&lt;</span> Suc <span class="main">(</span>length mulog_processes<span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">mulog_process_name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ident"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">mulog_process_name</span> <span class="main">0</span> <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''unknown''</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">mulog_process_name</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> mulog_processes <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_handshake</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> mulog_process_name <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''h''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_msg</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> mulog_process_name <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''m''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_idle</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> mulog_process_name <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''i''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_token</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> mulog_process_name <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''t''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_requesting</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> mulog_process_name <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''r''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_parent</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> mulog_process_name <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''p''</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_next</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> mulog_process_name <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="keyword1">STR</span> <span class="inner_quoted">''n''</span>"</span></span>

  <span class="keyword1"><span class="command">fun</span></span> <span class="entity">mulog_send_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> exp <span class="main">⇒</span> exp <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">mulog_send_aux</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">proc</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">=</span> cmd.Skip"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="free">mulog_send_aux</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">proc</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">=</span>
        ifelse <span class="main">(</span>e_bin bo_eq <span class="free"><span class="bound"><span class="entity">proc</span></span></span> <span class="main">(</span>e_const <span class="main">(</span>int <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>handshake_send <span class="main">(</span>mulog_handshake <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="free">mulog_send_aux</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">proc</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mulog_send</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> exp <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_send</span> <span class="main">≡</span> mulog_send_aux <span class="main">(</span>length mulog_processes<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_vars_global</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> handshake_vars <span class="main">(</span>mulog_handshake <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_vars_local</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">[</span>mulog_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> mulog_idle <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> mulog_token <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> mulog_requesting <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>
    mulog_parent <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> mulog_next <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mulog_initialize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_initialize</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
      handshake_initialize <span class="main">(</span>mulog_handshake <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
      assign <span class="main">(</span>mulog_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span><span class="main">;</span>
      assign <span class="main">(</span>mulog_idle <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> etrue<span class="main">;</span>
      assign <span class="main">(</span>mulog_parent <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> e_const <span class="main">0</span> <span class="keyword1">else</span> e_const <span class="main">1</span><span class="main">)</span><span class="main">;</span>
      assign <span class="main">(</span>mulog_next <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span><span class="main">;</span>
      assign <span class="main">(</span>mulog_requesting <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> efalse<span class="main">;</span>
      assign <span class="main">(</span>mulog_token <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> etrue <span class="keyword1">else</span> efalse<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mulog_request_token</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_request_token</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
      assign <span class="main">(</span>mulog_requesting <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> etrue<span class="main">;</span>
      ifelse <span class="main">(</span>e_bin bo_eq <span class="main">(</span>var <span class="main">(</span>mulog_parent <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span><span class="main">)</span>
      cmd.Skip
      <span class="main">(</span>
        mulog_send <span class="main">(</span>var <span class="main">(</span>mulog_parent <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        assign <span class="main">(</span>mulog_parent <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mulog_release_token</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_release_token</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
      assign <span class="main">(</span>mulog_requesting <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> efalse<span class="main">;</span>
      ifelse <span class="main">(</span>e_bin bo_eq <span class="main">(</span>var <span class="main">(</span>mulog_next <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span><span class="main">)</span>
      cmd.Skip
      <span class="main">(</span>
        assign <span class="main">(</span>mulog_token <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> efalse<span class="main">;</span>
        mulog_send <span class="main">(</span>var <span class="main">(</span>mulog_next <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span><span class="main">;</span>
        assign <span class="main">(</span>mulog_next <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mulog_process_cmd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> cmd"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_process_cmd</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
      mulog_initialize <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
      SM_Syntax.Loop
      <span class="main">(</span>
        ifelse <span class="main">(</span>handshake_waiting <span class="main">(</span>mulog_handshake <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>
          handshake_receive <span class="main">(</span>mulog_handshake <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>mulog_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
          ifelse <span class="main">(</span>e_bin bo_eq <span class="main">(</span>var <span class="main">(</span>mulog_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>assign <span class="main">(</span>mulog_token <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> etrue<span class="main">)</span>
          <span class="main">(</span>
            ifelse <span class="main">(</span>e_bin bo_eq <span class="main">(</span>var <span class="main">(</span>mulog_parent <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>
              ifelse <span class="main">(</span>var <span class="main">(</span>mulog_requesting <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>assign <span class="main">(</span>mulog_next <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>var <span class="main">(</span>mulog_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>
                assign <span class="main">(</span>mulog_token <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> efalse<span class="main">;</span>
                mulog_send <span class="main">(</span>var <span class="main">(</span>mulog_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">0</span><span class="main">)</span>
              <span class="main">)</span>
            <span class="main">)</span>
            <span class="main">(</span>mulog_send <span class="main">(</span>var <span class="main">(</span>mulog_parent <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>var <span class="main">(</span>mulog_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
            assign <span class="main">(</span>mulog_parent <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>var <span class="main">(</span>mulog_msg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>
          <span class="main">)</span>
        <span class="main">)</span>
        <span class="main">(</span>
          ifelse <span class="main">(</span>var <span class="main">(</span>mulog_idle <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>
            assign <span class="main">(</span>mulog_idle <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> efalse<span class="main">;</span>
            mulog_request_token <span class="free"><span class="bound"><span class="entity">i</span></span></span>
          <span class="main">)</span>
          <span class="main">(</span>
            ifelse <span class="main">(</span>var <span class="main">(</span>mulog_token <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>
              assign <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>e_bin bo_plus <span class="main">(</span>var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
              assign <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>e_bin bo_minus <span class="main">(</span>var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
              mulog_release_token <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
              assign <span class="main">(</span>mulog_idle <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> etrue
            <span class="main">)</span>
            cmd.Skip
          <span class="main">)</span>
        <span class="main">)</span>
      <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mulog_process</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> proc_decl"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_process</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
    <span class="main">⦇</span>
      name <span class="main">=</span> mulog_process_name <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>
      body <span class="main">=</span> mulog_process_cmd <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span>
      local_vars <span class="main">=</span> mulog_vars_local <span class="free"><span class="bound"><span class="entity">i</span></span></span>
    <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">mulog_program</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"program"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_program</span> <span class="main">≡</span>
    <span class="main">⦇</span>
      program.processes <span class="main">=</span> map mulog_process mulog_process_ids<span class="main">,</span>
      program.global_vars <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''x''</span> <span class="main">#</span> List.maps mulog_vars_global mulog_process_ids
    <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">test1_process_send</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> proc_decl"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test1_process_send</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
    <span class="main">⦇</span>
      name <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''test1_process_send''</span><span class="main">,</span>
      body <span class="main">=</span> handshake_send <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''foo''</span><span class="main">)</span> <span class="main">(</span>e_const <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span>
      local_vars <span class="main">=</span> <span class="main">[]</span>
    <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">test1_process_receive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proc_decl"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test1_process_receive</span> <span class="main">≡</span>
    <span class="main">⦇</span>
      name <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''test1_process_receive''</span><span class="main">,</span>
      body <span class="main">=</span> SM_Syntax.Loop
      <span class="main">(</span>
        handshake_receive <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''foo''</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''temp''</span><span class="main">)</span><span class="main">;</span>
        assign <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>e_bin bo_plus <span class="main">(</span>var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''temp''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span><span class="main">,</span>
      local_vars <span class="main">=</span> <span class="main">[</span><span class="keyword1">STR</span> <span class="inner_quoted">''temp''</span><span class="main">]</span>
    <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">test1_program</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"program"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test1_program</span> <span class="main">≡</span>
    <span class="main">⦇</span>
      program.processes <span class="main">=</span> <span class="main">[</span>test1_process_send <span class="main">1</span><span class="main">,</span> test1_process_send <span class="numeral">2</span><span class="main">,</span> test1_process_receive<span class="main">]</span><span class="main">,</span>
      program.global_vars <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''x''</span> <span class="main">#</span> handshake_vars <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''foo''</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">test2_process</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proc_decl"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test2_process</span> <span class="main">≡</span>
    <span class="main">⦇</span>
      name <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''test2_process''</span><span class="main">,</span>
      body <span class="main">=</span> lock_block <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''foo''</span><span class="main">)</span>
      <span class="main">(</span>
        assign <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>e_bin bo_plus <span class="main">(</span>var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        assign <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>e_bin bo_minus <span class="main">(</span>var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">1</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span><span class="main">,</span>
      local_vars <span class="main">=</span> <span class="main">[]</span>
    <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">test2_program</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"program"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test2_program</span> <span class="main">≡</span>
    <span class="main">⦇</span>
      program.processes <span class="main">=</span> <span class="main">[</span>test2_process<span class="main">,</span> test2_process<span class="main">]</span><span class="main">,</span>
      program.global_vars <span class="main">=</span> <span class="keyword1">STR</span> <span class="inner_quoted">''x''</span> <span class="main">#</span> lock_vars <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''foo''</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mulog_property</span> <span class="main">≡</span> <span class="keyword1">G<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>c</sub>(</span>e_bin bo_less_eq <span class="main">(</span>e_var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">test1_property</span> <span class="main">≡</span> <span class="keyword1">F<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>c</sub>(</span>e_bin bo_eq <span class="main">(</span>e_var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="numeral">3</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">test2_property</span> <span class="main">≡</span> <span class="keyword1">G<span class="hidden">⇩</span><sub>c</sub></span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>c</sub>(</span>e_bin bo_less_eq <span class="main">(</span>e_var <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_const <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> cava_sm dflt_cfg mulog_program mulog_property"</span></span>

  <span class="keyword1"><span class="command">value</span></span> <span class="main">[</span>code<span class="main">]</span> <span class="quoted"><span class="quoted">"cmd_to_promela <span class="main">(</span>mulog_initialize <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* value [code] "program_to_promela mulog_program *)</span>

  <span class="keyword1"><span class="command">export_code</span></span>
    <span class="quoted"><span class="quoted">program_to_promela</span></span> <span class="quoted"><span class="quoted">mulog_program</span></span>
    <span class="quoted"><span class="quoted">test</span></span> <span class="quoted"><span class="quoted">show_ce</span></span>
    <span class="quoted"><span class="quoted">TY_ERR</span></span> <span class="quoted"><span class="quoted">SAT</span></span> <span class="quoted"><span class="quoted">UNSAT</span></span> <span class="quoted"><span class="quoted">UNSAT_CE</span></span>
    <span class="quoted"><span class="quoted">lasso_reach</span></span> <span class="quoted"><span class="quoted">lasso_va</span></span> <span class="quoted"><span class="quoted">lasso_cysfx</span></span>
    <span class="quoted"><span class="quoted">nat_of_integer</span></span>
    <span class="keyword2"><span class="keyword">in</span></span> SML
    <span class="keyword2"><span class="keyword">module_name</span></span> Mulog
    <span class="keyword2"><span class="keyword">file</span></span> <span class="quoted">"../code/examples/mulog/Mulog_Export.sml"</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="All_Of_Nested_DFS">
<div class="head">
<h1>Theory All_Of_Nested_DFS</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> All_Of_Nested_DFS
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="NDFS_SI_Statistics.html">NDFS_SI_Statistics</a>
  <a href="NDFS_SI.html">NDFS_SI</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="All_Of_CAVA_LTL_Modelchecker">
<div class="head">
<h1>Theory All_Of_CAVA_LTL_Modelchecker</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> All_Of_CAVA_LTL_Modelchecker
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="All_Of_Nested_DFS.html">Nested_DFS/All_Of_Nested_DFS</a>"</span>
  <span class="quoted">"<a href="BoolProgs.html">BoolProgs/BoolProgs</a>"</span>
  <span class="quoted">"<a href="BoolProgs_Extras.html">BoolProgs/BoolProgs_Extras</a>"</span> <span class="quoted">"<a href="BoolProgs_LTL_Conv.html">BoolProgs/BoolProgs_LTL_Conv</a>"</span>
  <span class="quoted">"<a href="BoolProgs_Programs.html">BoolProgs/Programs/BoolProgs_Programs</a>"</span>
  <a href="CAVA_Abstract.html">CAVA_Abstract</a> <a href="CAVA_Impl.html">CAVA_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>