<div id="MuchAdoAboutTwo">
<div class="head">
<h1>Theory MuchAdoAboutTwo</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Much Ado about Two
    Author:      Sascha Böhme &lt;boehmes@informatik.tu-muenchen.de&gt;, 2007
    Maintainer:  Sascha Böhme &lt;boehmes@informatik.tu-muenchen.de&gt;
*)</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Much Ado about Two›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> MuchAdoAboutTwo
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Permutation.html">HOL-Library.Permutation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

Due to Donald E. Knuth, it is known for some time that certain sorting
functions for lists of arbitrary types can be proved correct by only showing
that they are correct for boolean lists (\cite{KnuthSortingAndSearching},
see also \cite{LogicalAbstractionsInHaskell}).
This reduction idea, i.e. reducing a proof for an arbitrary type to a proof for a fixed type with a fixed number of values, has also instances in other
fields.
Recently, in \cite{MuchAdoAboutTwo}, a similar result as Knuth's 0-1-principle
is explained for the problem of parallel prefix computation 
\cite{PrefixSumsAndTheirApplications}.
That is the task to compute, for given $x_1, \ldots, x_n$ and an associative
operation $\oplus$, the values $x_1$, $x_1 \oplus x_2$, $\ldots$,
 $x_1 \oplus x_2 \oplus \cdots \oplus x_n$.
There are several solutions which optimise this computation, and an
obvious question is to ask whether these solutions are correct.
One way to answer this question is given in \cite{MuchAdoAboutTwo}.
There, a ``0-1-2-principle'' is proved which relates an unspecified solution
of the parallel prefix computation, expressed as a function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate›</span></span></span></span>,
with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>scanl1›</span></span></span></span>, a functional representation of the parallel prefix
computation. The essence proved in the mentioned paper is as follows:
If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>scanl1›</span></span></span></span> behave identical on all lists over
a type which has three elements, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate›</span></span></span></span> is semantically
equivalent to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>scanl1›</span></span></span></span>, that is, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate›</span></span></span></span> is a correct solution
of the parallel prefix computation.

Although it seems that nearly nothing is known about the function
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate›</span></span></span></span>, it turns out that the type of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate›</span></span></span></span> already
suffices for the proof of the paper's result. The key is relational
parametricity \cite{TypesAbstractionsAndParametricPolymorphism} in the form of
a free theorem \cite{TheoremsForFree}. This, some rewriting and a few 
properties about list-processing functions thrown in allow to proof the
``0-1-2-principle''.

The paper first shows some simple properties and derives a specialisation of
the free theorem. The proof of the main theorem itself is split up in two 
parts. The first, and considerably more complicated part relates lists over a
type with three values to lists of integer lists. Here, the paper uses
several figures to demonstrate and shorten several proofs. The second part then
relates lists of integer list with lists over arbitrary types, and consists of
applying the free theorem and some rewriting. The combination of these two
parts then yields the theorem.



Th article at hand formalises the proofs given in \cite{MuchAdoAboutTwo},
which is called here ``the original paper''. Compared to that paper, there are 
several differences in this article. The major differences are listed below.
A more detailed collection follows thereafter.

\begin{itemize}
\item The original paper requires lists to be non-empty. Eventhough lists in
Isabelle may also be empty, we stick to Isabelle's list datatype instead of
declaring a new datatype, due to the huge, already existing theory about
lists in Isabelle. As a consequence, however, several modifications become
necessary.

\item The figure-based proofs of the original paper are replaced by formal
proofs. This forms a major part of this article (see Section 6).

\item Instead of integers, we restrict ourselves to natural numbers. Thus,
several conditions can be simplified since every natural number is greater
than or equal to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>0›</span></span></span></span>. This decision has no further influence on the 
proofs because they never consider negative integers.

\item Mainly due to differences between Haskell and Isabelle, certain notations
are different here compared to the original paper. List concatenation is
denoted by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>@›</span></span></span></span> instead of $++$, and in writing down intervals, we use
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[0..&lt;k + 1]›</span></span></span></span> instead of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[0..k]›</span></span></span></span>. Moreover, we write <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span>
instead of $\oplus$ and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>g›</span></span></span></span> instead of $\otimes$. Functions mapping
an element of the three-valued type to an arbitrary type are denoted by
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>h›</span></span></span></span>.

\end{itemize}

Whenever we use lemmas from already existing Isabelle theories, we qualify
them by their theory name. For example, instead of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>map_map›</span></span></span></span>, we
write <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>List.map_map›</span></span></span></span> to point out that this lemma is taken from
Isabelle's list theory.



The following comparison shows all differences of this article compared to the
original paper. The items below follow the structure of the original paper
(and also this article's structure). They also highlight the challenges which
needed to be solved in formalising the original paper.

\begin{itemize}
\item Introductions of several list functions (e.g. <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>length›</span></span></span></span>,
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>map›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>take›</span></span></span></span>) are dropped. They exist already in Isabelle's list
theory and are be considered familiar to the reader.

\item The free theorem given in Lemma 1 of the original paper is not sufficient
for later proofs, because the assumption is not appropriate in the context
of Isabelle's lists, which may also be empty. Thus, here, Lemma 1 is a
derived version of the free theorem given as Lemma 1 in the original paper,
and some additional proof-work is done.

\item Before proceeding in the original paper's way, we state and proof
additional lemmas, which are not part of Isabelle's libraries. These lemmas
are not specific to this article and may also be used in other theories.

\item Laws 1 to 8 and Lemma 2 of the original paper are explicitly proved.
Most of the proofs follow directly from existing results of Isabelle's list
theory. To proof Law 7, Law 8 and Lemma 2, more work was necessary, especially
for Law 8.

\item Lemma 3 and its proof are nearly the same here as in the original paper.
Only the additional assumptions of Lemma 1, due to Isabelle's list datatype,
have to be shown.

\item Lemma 4 is split up in several smaller lemmas, and the order of them
tries to follow the structure of the original paper's Lemma 4.

For every figure of the original paper, there is now one separate proof.
These proofs constitute the major difference in the structure of this article
compared to the original paper. 

The proof of Lemma 4 in the original paper concludes by combining the results
of the figure-based proofs to a non-trivial permutation property. These three
sentences given in the original paper are split up in five separate lemmas
and according proofs, and therefore, they as well form a major difference to
the original paper.

\item Lemma 5 is mostly identical to the version in the original paper. It has
one additional assumption required by Lemma 4. Moreover, the proof is slightly
more structured, and some steps needed a bit more argumentation than in the
original paper.

\item In principle, Proposition 1 is identical to the according proposition in
the original paper. However, to fulfill the additional requirement of Lemma 5,
an additional lemma was proved. This, however, is only necessary, because we
use Isabelle's list type which allows lists to be empty.

\item Proposition 2 contains one non-trivial step, which is proved as a
seperate lemma. Note that this is not due to any decisions of using special
datatypes, but inherent in the proof itself.  Apart from that, the proof is
identical to the original paper's proof of Proposition 2.

\item The final theorem is, as in the original paper, just a combination of
Proposition 1 and Proposition 2. Only the assumptions are extended due to
Isabelle's list datatype.

\end{itemize}


›</span></span>





<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basic definitions›</span></span>



<span class="keyword1"><span class="command">fun</span></span> <span class="entity">foldl1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> foldl <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">scanl1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">scanl1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>take <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>
                     <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The original paper further relies on associative functions. Thus, we define
another predicate to be able to express this condition:
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">associative</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">z</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following constant symbols represents our unspecified function. We want to
show that this function is semantically equivalent to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>scanl1›</span></span></span></span>, provided
that the first argument is an associative function.
›</span></span>

<span class="keyword1"><span class="command">consts</span></span> 
  candidate <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
With the final theorem, it suffices to show that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate›</span></span></span></span> behaves like
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>scanl1›</span></span></span></span> on all lists of the following type, to conclude that 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>canditate›</span></span></span></span> is semantically equivalent to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>scanl1›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> three <span class="main">=</span> Zero <span class="main">|</span> One <span class="main">|</span> Two



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Although most of the functions mentioned in the original paper already exist
in Isabelle's list theory, we still need to define two more functions:
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wrap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wrap</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ups</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ups</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>





<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Free Theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The key to proof the final theorem is the following free theorem \cite{TypesAbstractionsAndParametricPolymorphism,TheoremsForFree} of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate›</span></span></span></span>. 
Since there is no proof possible without specifying the underlying
(functional) language (which would be beyond the scope of this work),
this lemma is expected to hold. As a consequence, all following lemmas and also
the final theorem only hold under this provision.
›</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  candidate_free_theorem<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> map <span class="free">h</span> <span class="main">(</span>candidate <span class="free">f</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> candidate <span class="free">g</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">zs</span><span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In what follows in this section, the previous lemma is specialised to a lemma 
for non-empty lists. More precisely, we want to restrict the above assumption
to be applicable for non-empty lists. This is already possible without
modifications when having a list datatype which does not allow for empty lists.
However, before being able to also use Isabelle's list datatype, further
conditions on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>zs›</span></span></span></span> are necessary.

To prove the derived lemma, we first introduce a datatype for non-empty lists,
and we furthermore define conversion functions to map the new datatype on
Isabelle lists and back.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> nel 
  <span class="main">=</span> NE_One <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> 
  <span class="main">|</span> NE_Cons <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nel"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">n2l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> nel <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">n2l</span> <span class="main">(</span>NE_One <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>     <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">n2l</span> <span class="main">(</span>NE_Cons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">n2l</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">l2n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> nel"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l2n</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>      <span class="main">=</span> NE_One <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">l2n</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span>      <span class="main">⇒</span> NE_One <span class="free"><span class="bound"><span class="entity">x</span></span></span>
                            <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> NE_Cons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">l2n</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following results relate Isabelle lists and non-empty lists:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> non_empty_n2l<span class="main">:</span> <span class="quoted"><span class="quoted">"n2l <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> n2l_l2n_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> n2l <span class="main">(</span>l2n <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> n2l_l2n_map_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>n2l <span class="main">∘</span> l2n<span class="main">)</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">zs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> List.set_subset_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>n2l <span class="main">∘</span> l2n<span class="main">)</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"map <span class="main">(</span>n2l <span class="main">∘</span> l2n<span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>
   <span class="main">=</span> <span class="main">(</span>n2l <span class="main">∘</span> l2n<span class="main">)</span> <span class="skolem">z</span> <span class="main">#</span> map <span class="main">(</span>n2l <span class="main">∘</span> l2n<span class="main">)</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> map <span class="main">(</span>n2l <span class="main">∘</span> l2n<span class="main">)</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> n2l_l2n_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Based on the previous lemmas, we can state and proof a specialised version
of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate›</span></span></span></span>'s free theorem, suitable for our setting as explained 
before.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Lemma_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">.</span> 
                 <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="free">h</span> <span class="main">(</span>candidate <span class="free">f</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> candidate <span class="free">g</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹We define two functions, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"fn :: 'a nel ⇒ 'a nel ⇒ 'a nel"</span><span class="antiquote">}</span></span> and›</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"hn :: 'a nel ⇒ b"</span><span class="antiquote">}</span></span>, which wrap <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">f</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">h</span><span class="antiquote">}</span></span> in the›</span>
  <span class="comment1">― ‹setting of non-empty lists.›</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> l2n <span class="main">(</span><span class="free">f</span> <span class="main">(</span>n2l <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>n2l <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?hn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∘</span> n2l"</span></span>

  <span class="comment1">― ‹Our new functions fulfill the preconditions of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">candidate</span><span class="antiquote">}</span></span>'s›</span>
  <span class="comment1">― ‹free theorem:›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span> nel<span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span> nel<span class="main">)</span><span class="main">.</span> <span class="var">?hn</span> <span class="main">(</span><span class="var">?fn</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="var">?hn</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?hn</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"n2l <span class="main">(</span><span class="skolem">x</span> <span class="main">::</span> <span class="tfree">'a</span> nel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?yl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"n2l <span class="main">(</span><span class="skolem">y</span> <span class="main">::</span> <span class="tfree">'a</span> nel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="var">?hn</span> <span class="main">(</span><span class="var">?fn</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
       <span class="main">=</span> <span class="free">h</span> <span class="main">(</span>n2l <span class="main">(</span>l2n <span class="main">(</span><span class="free">f</span> <span class="main">(</span>n2l <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>n2l <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">h</span> <span class="main">(</span><span class="free">f</span> <span class="var">?xl</span> <span class="var">?yl</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> A2 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?xl</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?yl</span>"</span></span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> n2l_l2n_id <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>n2l <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>n2l <span class="skolem">y</span><span class="main">)</span>"</span></span><span class="main">]</span> 
          <span class="keyword2"><span class="keyword">and</span></span> non_empty_n2l <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 
          <span class="keyword2"><span class="keyword">and</span></span> non_empty_n2l <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">h</span> <span class="var">?xl</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="var">?yl</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A1 <span class="keyword2"><span class="keyword">and</span></span> non_empty_n2l <span class="keyword2"><span class="keyword">and</span></span> non_empty_n2l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="var">?hn</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?hn</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?hn</span> <span class="main">(</span><span class="var">?fn</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="var">?hn</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?hn</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> candidate_free_theorem <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?fn</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?hn</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> ne_free_theorem<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"map <span class="var">?hn</span> <span class="main">(</span>candidate <span class="var">?fn</span> <span class="main">(</span>map l2n <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> candidate <span class="free">g</span> <span class="main">(</span>map <span class="var">?hn</span> <span class="main">(</span>map l2n <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹We use <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">candidate</span><span class="antiquote">}</span></span>'s free theorem again to show the following›</span>
  <span class="comment1">― ‹property:›</span>
  <span class="keyword1"><span class="command">have</span></span> n2l_candidate<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">zs</span><span class="main">.</span> map n2l <span class="main">(</span>candidate <span class="var">?fn</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> candidate <span class="free">f</span> <span class="main">(</span>map n2l <span class="bound">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">zs</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> n2l <span class="main">(</span><span class="var">?fn</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>n2l <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>n2l <span class="bound">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"n2l <span class="main">(</span><span class="var">?fn</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>n2l <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>n2l <span class="skolem">y</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n2l_l2n_id <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>n2l <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>n2l <span class="skolem">y</span><span class="main">)</span>"</span></span><span class="main">]</span> 
              <span class="keyword2"><span class="keyword">and</span></span> A2 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"n2l <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"n2l <span class="skolem">y</span>"</span></span><span class="main">]</span>
              <span class="keyword2"><span class="keyword">and</span></span> non_empty_n2l <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> non_empty_n2l <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> candidate_free_theorem <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted">n2l</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?fn</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">f</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map n2l <span class="main">(</span>candidate <span class="var">?fn</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span> candidate <span class="free">f</span> <span class="main">(</span>map n2l <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Now, with the previous preparations, we conclude the thesis by the›</span>
  <span class="comment1">― ‹following rewriting:›</span>
  <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"map <span class="free">h</span> <span class="main">(</span>candidate <span class="free">f</span> <span class="free">zs</span><span class="main">)</span>
   <span class="main">=</span> map <span class="free">h</span> <span class="main">(</span>candidate <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>n2l <span class="main">∘</span> l2n<span class="main">)</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n2l_l2n_map_id <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> zs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">zs</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> A3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="free">h</span> <span class="main">(</span>candidate <span class="free">f</span> <span class="main">(</span>map n2l <span class="main">(</span>map l2n <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> List.map_map <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">n2l</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted">l2n</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">zs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span><span class="main">=</span> map <span class="free">h</span> <span class="main">(</span>map n2l <span class="main">(</span>candidate <span class="var">?fn</span> <span class="main">(</span>map l2n <span class="free">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n2l_candidate <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="var">?hn</span> <span class="main">(</span>candidate <span class="var">?fn</span> <span class="main">(</span>map l2n <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> List.map_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> candidate <span class="free">g</span> <span class="main">(</span>map <span class="var">?hn</span> <span class="main">(</span>map l2n <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ne_free_theorem <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> candidate <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(</span><span class="free">h</span> <span class="main">∘</span> n2l<span class="main">)</span> <span class="main">∘</span> l2n<span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> List.map_map <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∘</span> n2l"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted">l2n</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> candidate <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> <span class="main">(</span>n2l <span class="main">∘</span> l2n<span class="main">)</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Fun.o_assoc <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">h</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted">n2l</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted">l2n</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> candidate <span class="free">g</span> <span class="main">(</span>map <span class="free">h</span> <span class="main">(</span>map <span class="main">(</span>n2l <span class="main">∘</span> l2n<span class="main">)</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> List.map_map <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">h</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"n2l <span class="main">∘</span> l2n"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> candidate <span class="free">g</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">zs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> n2l_l2n_map_id <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> zs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">zs</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> A3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>





<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Useful lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In this section, we state and proof several lemmas, which neither occur in the
original paper nor in Isabelle's libraries.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upt_map_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="main">0</span> <span class="main">#</span> map Suc <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> List.upt_conv_Cons <span class="keyword2"><span class="keyword">and</span></span> List.map_Suc_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> divide_and_conquer_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">;</span> <span class="free">P</span> <span class="bound">ys</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> A1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> A2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> A2 <span class="keyword2"><span class="keyword">and</span></span> A3 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">zs</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> divide_and_conquer 
  <span class="main">=</span> divide_and_conquer_induct <span class="main">[</span><span class="operator">case_names</span> Nil One Partition<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> all_set_inter_empty_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">⟹</span> set <span class="bound">xs</span> <span class="main">∩</span> set <span class="bound">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">js</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">js</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> divide_and_conquer<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> One <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Partition <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">⟹</span> set <span class="bound">as</span> <span class="main">∩</span> set <span class="bound">bs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs1</span> <span class="bound">xs2</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">xs1</span> <span class="main">@</span> <span class="bound">xs2</span> <span class="main">⟹</span> set <span class="bound">xs1</span> <span class="main">∩</span> set <span class="bound">xs2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs1</span> <span class="skolem">xs2</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs1</span> <span class="main">@</span> <span class="skolem">xs2</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs1</span> <span class="main">∩</span> set <span class="main">(</span><span class="skolem">xs2</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xs1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">xs2</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs1</span> <span class="main">∩</span> set <span class="skolem">xs2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> List.set_append <span class="keyword2"><span class="keyword">and</span></span> Set.Int_Un_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Partition <span class="keyword1"><span class="command">have</span></span> distinct_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys1</span> <span class="bound">ys2</span><span class="main">.</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="bound">ys1</span> <span class="main">@</span> <span class="bound">ys2</span> <span class="main">⟹</span> set <span class="bound">ys1</span> <span class="main">∩</span> set <span class="bound">ys2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys1</span> <span class="skolem">ys2</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ys1</span> <span class="main">@</span> <span class="skolem">ys2</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys1</span><span class="main">)</span> <span class="main">∩</span> set <span class="skolem">ys2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ys2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys1</span> <span class="main">∩</span> set <span class="skolem">ys2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> List.set_append <span class="keyword2"><span class="keyword">and</span></span> Set.Int_Un_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Partition <span class="keyword1"><span class="command">have</span></span> distinct_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Partition <span class="keyword2"><span class="keyword">and</span></span> distinct_xs <span class="keyword2"><span class="keyword">and</span></span> distinct_ys <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> partitions_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">js</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">js</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> divide_and_conquer<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> One <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Partition <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span> <span class="bound">bs</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">as</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">bs</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs1</span> <span class="bound">xs2</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="bound">xs1</span> <span class="main">@</span> <span class="bound">xs2</span> <span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs1</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">xs2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs1</span> <span class="skolem">xs2</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs1</span> <span class="main">@</span> <span class="skolem">xs2</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs1</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">xs2</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xs1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">xs2</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs1</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">xs2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> List.set_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Partition <span class="keyword1"><span class="command">have</span></span> sorted_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys1</span> <span class="bound">ys2</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="bound">ys1</span> <span class="main">@</span> <span class="bound">ys2</span> <span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">ys1</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys1</span> <span class="skolem">ys2</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ys1</span> <span class="main">@</span> <span class="skolem">ys2</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys1</span><span class="main">)</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">ys2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ys2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">ys1</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">ys2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> List.set_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Partition <span class="keyword1"><span class="command">have</span></span> sorted_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">ys</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> as<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> sorted_xs <span class="keyword2"><span class="keyword">and</span></span> sorted_ys <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> List.sorted_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preparatory Material›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, the following lemmas L1 to L8 are given without a proof,
although it is hinted there that most of them follow from parametricity
properties \cite{TypesAbstractionsAndParametricPolymorphism,TheoremsForFree}.
Alternatively, most of them can be shown by induction over lists.
However, since we are using Isabelle's list datatype, we rely on already
existing results.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">g</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> List.map_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> L2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> List.length_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> L3<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> List.take_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> L4<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">∘</span> wrap <span class="main">=</span> wrap <span class="main">∘</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> L5<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> List.map_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> L6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> List.nth_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> L7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>nth <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> 
           <span class="main">=</span> map <span class="main">(</span>nth <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> map Suc <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> upt_map_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> map <span class="main">(</span>nth <span class="skolem">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> map <span class="main">(</span>nth <span class="skolem">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> take <span class="main">(</span><span class="skolem">k'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In Isabelle's list theory, a similar result for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>foldl›</span></span></span></span> already exists.
Therefore, it is easy to prove the following lemma for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>foldl1›</span></span></span></span>.
Note that this lemma does not occur in the original paper.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldl1_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl1 <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> foldl1 <span class="free">f</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="free">xs</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> non_empty_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_xs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl1 <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> foldl <span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_xs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl <span class="free">f</span> <span class="main">(</span>foldl <span class="free">f</span> <span class="skolem">x</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> List.foldl_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl <span class="free">f</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs'</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="free">f</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="free">xs</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_xs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This is a special induction scheme suitable for proving L8. It is not mentioned
in the original paper.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldl1_induct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">z</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">z</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="free">P</span> <span class="bound">f</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">f</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ys</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">.</span> length <span class="bound">ys</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">xs</span><span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="free">f</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">f</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x1</span> <span class="skolem">xs1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> xs1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">x1</span> <span class="main">#</span> <span class="skolem">xs1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs1</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> xs1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x2</span> <span class="skolem">xs2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> xs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs1</span> <span class="main">=</span> <span class="skolem">x2</span> <span class="main">#</span> <span class="skolem">xs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs2</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> xs1 <span class="keyword2"><span class="keyword">and</span></span> xs2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x3</span> <span class="skolem">xs3</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs2</span> <span class="main">=</span> <span class="skolem">x3</span> <span class="main">#</span> <span class="skolem">xs3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> xs1 xs2 <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> foldl1_induct <span class="main">=</span> foldl1_induct' <span class="main">[</span><span class="operator">case_names</span> One Two More Nil<span class="main">]</span>


<span class="keyword1"><span class="command">lemma</span></span> L8<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"associative <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl1 <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> foldl1_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>One <span class="skolem">f</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> 
   <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> foldl1_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Two <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span><span class="main">)</span> 
   <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> foldl1_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> Two <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Two 
      <span class="keyword1"><span class="command">unfolding</span></span> associative_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>More <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span> 
             <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span> 
   <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span> <span class="main">#</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> foldl1_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> More <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> More <span class="keyword1"><span class="command">unfolding</span></span> associative_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span> <span class="main">#</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> foldl1_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> More <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The next lemma is applied in several following proofs whenever the equivalence
of two lists is shown.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Lemma_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.list_eq_iff_nth_eq<span class="main">)</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, this lemma and its proof appear inside of Lemma 3.
However, this property will be useful also in later proofs and is thus 
separated.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldl1_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"associative <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> 
         <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> 
   <span class="main">=</span> foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">xs</span> <span class="main">@</span> map <span class="free">h</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> L8 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> Lemma_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"associative <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">∘</span> map <span class="free">h</span><span class="main">)</span> <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
         <span class="main">=</span> candidate <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="comment1">― ‹The following three properties <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">P1</span><span class="antiquote">}</span></span>, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">P2</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">P3</span><span class="antiquote">}</span></span>›</span>
  <span class="comment1">― ‹are preconditions of Lemma 1.›</span>
  <span class="keyword1"><span class="command">have</span></span> P1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span>
   <span class="main">⟹</span> foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="main">(</span><span class="bound">x</span> <span class="main">@</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> foldl1_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">y</span>  <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> P3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹The proof for the thesis is now equal to the one of the original paper:›</span>
  <span class="keyword1"><span class="command">from</span></span> Lemma_1 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"foldl1 <span class="free">f</span> <span class="main">∘</span> map <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> zs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">]</span>"</span></span>
       <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(@)</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> P1 P2 P3
  <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"map <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">∘</span> map <span class="free">h</span><span class="main">)</span> <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
   <span class="main">=</span> candidate <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">∘</span> map <span class="free">h</span><span class="main">)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> candidate <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">∘</span> map <span class="free">h</span> <span class="main">∘</span> wrap<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> candidate <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>foldl1 <span class="free">f</span> <span class="main">∘</span> wrap <span class="main">∘</span> <span class="free">h</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> L4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fun.o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> candidate <span class="free">f</span> <span class="main">(</span>map <span class="free">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fun.o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>





<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proving Proposition 1›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions of Lemma 4›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the same way as in the original paper, the following two functions are 
defined:
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">f1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"three <span class="main">⇒</span> three <span class="main">⇒</span> three"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>    Zero <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">f1</span> Zero One  <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">f1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>    <span class="free"><span class="bound"><span class="entity">y</span></span></span>    <span class="main">=</span> Two"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">f2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"three <span class="main">⇒</span> three <span class="main">⇒</span> three"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Zero <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">f2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> One  <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">f2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Two  <span class="main">=</span> Two"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Both functions are associative as is proved by case analysis:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f1_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"associative f1"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> associative_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"f1 <span class="skolem">x</span> <span class="main">(</span>f1 <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> f1 <span class="main">(</span>f1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Zero <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> One 
    <span class="keyword1"><span class="command">hence</span></span> z_One<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Two <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f2_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"associative f2"</span></span> 
<span class="keyword1"><span class="command">unfolding</span></span> associative_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"f2 <span class="skolem">x</span> <span class="main">(</span>f2 <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> f2 <span class="main">(</span>f2 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Next, we define two other functions, again according to the original paper.
Note that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>h1›</span></span></span></span> has an extra parameter <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> which is only implicit in
the original paper.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">h1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> three"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h1</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> One
               <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> Zero
               <span class="keyword1">else</span> Two<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">h2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> three"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> One
             <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> Two
             <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Figures and Proofs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, this lemma is depicted in (and proved by) Figure~2.
Therefore, it carries this unusual name here.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Figure_2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> One"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate <span class="free">i</span> Zero <span class="main">@</span> <span class="main">[</span>One<span class="main">]</span> <span class="main">@</span> replicate <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> Zero"</span></span>

  <span class="keyword1"><span class="command">have</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="var">?mr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> Q1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> length <span class="var">?mr</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      
      <span class="keyword1"><span class="command">have</span></span> Q2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>
                    <span class="main">⟹</span> <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="var">?mr</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> j_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> M1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> One"</span></span>
            <span class="keyword1"><span class="command">using</span></span> L6 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"h1 <span class="free">k</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms
              <span class="keyword2"><span class="keyword">and</span></span> List.nth_upt <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> M2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Zero"</span></span>
            <span class="keyword1"><span class="command">using</span></span> L6 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"h1 <span class="free">k</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> j_k
              <span class="keyword2"><span class="keyword">and</span></span> List.nth_upt <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mr</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> One"</span></span>
            <span class="keyword1"><span class="command">using</span></span> List.nth_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="free">i</span> Zero"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="var">?mr</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Zero"</span></span>
            <span class="keyword1"><span class="command">using</span></span> List.nth_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="free">i</span> Zero"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> R3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="var">?mr</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Zero"</span></span>
            <span class="keyword1"><span class="command">using</span></span> List.nth_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="free">i</span> Zero <span class="main">@</span> <span class="main">[</span>One<span class="main">]</span>"</span></span><span class="main">]</span>
              <span class="keyword2"><span class="keyword">and</span></span> j_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?mr</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> M1 <span class="keyword2"><span class="keyword">and</span></span> R1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> i_ne_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">with</span></span> M2 <span class="keyword2"><span class="keyword">and</span></span> R3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span> 
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">with</span></span> i_ne_j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">with</span></span> M2 <span class="keyword2"><span class="keyword">and</span></span> R2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      
      <span class="keyword1"><span class="command">from</span></span> Q1 Q2 <span class="keyword2"><span class="keyword">and</span></span> Lemma_2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> foldl1 f1 <span class="main">(</span>replicate <span class="bound">j</span> Zero<span class="main">)</span> <span class="main">=</span> Zero"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span>replicate <span class="skolem">j</span> Zero<span class="main">)</span> <span class="main">=</span> Zero"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> P3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> foldl1 f1 <span class="main">(</span><span class="main">[</span>One<span class="main">]</span> <span class="main">@</span> replicate <span class="bound">j</span> Zero<span class="main">)</span> <span class="main">=</span> One"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span><span class="main">[</span>One<span class="main">]</span> <span class="main">@</span> replicate <span class="skolem">j</span> Zero<span class="main">)</span> <span class="main">=</span> One"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L8 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">f1</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>One<span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> Zero"</span></span><span class="main">]</span> 
          <span class="keyword2"><span class="keyword">and</span></span> f1_assoc <span class="keyword2"><span class="keyword">and</span></span> P2 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="var">?mr</span> <span class="main">=</span> One"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> P3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 
      <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> Zero <span class="main">@</span> <span class="main">[</span>One<span class="main">]</span> <span class="main">@</span> replicate <span class="main">(</span><span class="free">k</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> Zero<span class="main">)</span>
       <span class="main">=</span> f1 <span class="main">(</span>foldl1 f1 <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> Zero<span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>foldl1 f1 <span class="main">(</span><span class="main">[</span>One<span class="main">]</span> <span class="main">@</span> replicate <span class="main">(</span><span class="free">k</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> Zero<span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L8 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> Zero"</span></span> 
                    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>One<span class="main">]</span> <span class="main">@</span> replicate <span class="main">(</span><span class="free">k</span> <span class="main">-</span> Suc <span class="skolem">i</span><span class="main">)</span> Zero"</span></span><span class="main">]</span> 
          <span class="keyword2"><span class="keyword">and</span></span> f1_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> One"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> P2 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> P3 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> P1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, this lemma is depicted in (and proved by) Figure~3.
Therefore, it carries this unusual name here.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Figure_3<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Two"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate <span class="free">i</span> Zero <span class="main">@</span> <span class="main">[</span>One<span class="main">,</span> Two<span class="main">]</span> <span class="main">@</span> replicate <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> Zero"</span></span>

  <span class="keyword1"><span class="command">have</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="var">?mr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> Q1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> length <span class="var">?mr</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      
      <span class="keyword1"><span class="command">have</span></span> Q2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>
                    <span class="main">⟹</span> <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="var">?mr</span> <span class="main">!</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> j_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> M1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> One"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> L6 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"h2 <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms 
            <span class="keyword2"><span class="keyword">and</span></span> List.nth_upt <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> M2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Two"</span></span>
            <span class="keyword1"><span class="command">using</span></span> L6 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"h2 <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> 
            <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> List.nth_upt <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> M3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Zero"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> L6 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"h2 <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> 
            <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> List.nth_upt <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
            <span class="keyword2"><span class="keyword">and</span></span> j_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="var">?mr</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Zero"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> List.nth_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="free">i</span> Zero"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mr</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> One"</span></span>
            <span class="keyword1"><span class="command">using</span></span> List.nth_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="free">i</span> Zero"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> R3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mr</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Two"</span></span>
            <span class="keyword1"><span class="command">using</span></span> List.nth_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="free">i</span> Zero <span class="main">@</span> <span class="main">[</span>One<span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> R4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> <span class="var">?mr</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Zero"</span></span>
            <span class="keyword1"><span class="command">using</span></span> List.nth_append <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="free">i</span> Zero <span class="main">@</span> <span class="main">[</span>One<span class="main">,</span>Two<span class="main">]</span>"</span></span><span class="main">]</span>
            <span class="keyword2"><span class="keyword">and</span></span> j_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?mr</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> M3 <span class="keyword2"><span class="keyword">and</span></span> R1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> j_ge_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> M1 <span class="keyword2"><span class="keyword">and</span></span> R2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">with</span></span> j_ge_i <span class="keyword1"><span class="command">have</span></span> j_gt_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> M2 <span class="keyword2"><span class="keyword">and</span></span> R3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">with</span></span> j_gt_i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">with</span></span> M3 <span class="keyword2"><span class="keyword">and</span></span> R4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> Q1 Q2 <span class="keyword2"><span class="keyword">and</span></span> Lemma_2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
 
  <span class="keyword1"><span class="command">have</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> foldl1 f2 <span class="main">(</span>replicate <span class="bound">j</span> Zero<span class="main">)</span> <span class="main">=</span> Zero"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> j_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span>replicate <span class="skolem">j</span> Zero<span class="main">)</span> <span class="main">=</span> Zero"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_0 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
 
  <span class="keyword1"><span class="command">have</span></span> P3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> foldl1 f2 <span class="main">(</span><span class="main">[</span>One<span class="main">,</span> Two<span class="main">]</span> <span class="main">@</span> replicate <span class="bound">j</span> Zero<span class="main">)</span> <span class="main">=</span> Two"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span><span class="main">[</span>One<span class="main">,</span> Two<span class="main">]</span> <span class="main">@</span> replicate <span class="skolem">j</span> Zero<span class="main">)</span> <span class="main">=</span> Two"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L8 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">f2</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>One<span class="main">,</span>Two<span class="main">]</span>"</span></span> 
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> Zero"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> f2_assoc <span class="keyword2"><span class="keyword">and</span></span> P2 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="var">?mr</span> <span class="main">=</span> Two"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> P3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 
      <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> Zero <span class="main">@</span> <span class="main">[</span>One<span class="main">,</span> Two<span class="main">]</span> 
                                         <span class="main">@</span> replicate <span class="main">(</span><span class="free">k</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> Zero<span class="main">)</span>
       <span class="main">=</span> f2 <span class="main">(</span>foldl1 f2 <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> Zero<span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>foldl1 f2 <span class="main">(</span><span class="main">[</span>One<span class="main">,</span> Two<span class="main">]</span> <span class="main">@</span>  replicate <span class="main">(</span><span class="free">k</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> Zero<span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L8 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">f2</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"replicate <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> Zero"</span></span> 
                    <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>One<span class="main">,</span> Two<span class="main">]</span> <span class="main">@</span> replicate <span class="main">(</span><span class="free">k</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> Zero"</span></span><span class="main">]</span> 
          <span class="keyword2"><span class="keyword">and</span></span> f2_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Two"</span></span>
          <span class="keyword1"><span class="command">using</span></span> P2 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> P3 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> P1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Counterparts of the following two lemmas are shown in the proof of Lemma 4 in
the original paper. Since here, the proof of Lemma 4 is seperated in several
smaller lemmas, also these two properties are given separately.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L9<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="main">(</span><span class="bound">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="bound">h</span><span class="main">.</span> associative <span class="bound">f</span> 
             <span class="main">⟹</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> One"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> f1_assoc <span class="keyword2"><span class="keyword">and</span></span> Figure_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> L10<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="main">(</span><span class="bound">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="bound">h</span><span class="main">.</span> associative <span class="bound">f</span> 
             <span class="main">⟹</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> Two"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> f2_assoc <span class="keyword2"><span class="keyword">and</span></span> Figure_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, this lemma is depicted in (and proved by) Figure~4.
Therefore, it carries this unusual name here. This lemma expresses that every
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i ≤ k›</span></span></span></span> is contained in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> at least once.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Figure_4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> One"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">js</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> i_not_in_js<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="free">js</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> One_not_in_map_js<span class="main">:</span> <span class="quoted"><span class="quoted">"One <span class="main">∉</span> set <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"One <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"One <span class="main">∈</span> <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">js</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="free">js</span> <span class="main">∧</span> One <span class="main">=</span> h1 <span class="free">k</span> <span class="free">i</span> <span class="skolem">j</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Set.image_iff <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"h1 <span class="free">k</span> <span class="free">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> i_not_in_js <span class="keyword2"><span class="keyword">and</span></span> j_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> f1_One<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> One <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> One <span class="main">⟹</span> f1 <span class="bound">x</span> <span class="bound">y</span> <span class="main">≠</span> One"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> One <span class="main">∧</span> <span class="skolem">y</span> <span class="main">≠</span> One"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"f1 <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">≠</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> One <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> foldl1 f1 <span class="bound">xs</span> <span class="main">≠</span> One"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">::</span> three list<span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"One <span class="main">∉</span> set <span class="skolem">xs</span> <span class="main">⟹</span> foldl1 f1 <span class="skolem">xs</span> <span class="main">≠</span> One"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> divide_and_conquer<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>One <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">≠</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Partition <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"One <span class="main">∉</span> set <span class="skolem">xs</span> <span class="main">∧</span> One <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> Partition <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="skolem">xs</span> <span class="main">≠</span> One <span class="main">∧</span> foldl1 f1 <span class="skolem">ys</span> <span class="main">≠</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> f1_One <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"f1 <span class="main">(</span>foldl1 f1 <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>foldl1 f1 <span class="skolem">ys</span><span class="main">)</span> <span class="main">≠</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> L8 <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">f1</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> f1_assoc <span class="keyword2"><span class="keyword">and</span></span> Partition 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">≠</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> One_not_in_map_js <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, this lemma is depicted in (and proved by) Figure~5.
Therefore, it carries this unusual name here. This lemma expresses that every
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i ≤ k›</span></span></span></span> is contained in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> at most once.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Figure_5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> One"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">i</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span><span class="main">(</span><span class="free">i</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> i_xs_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> i_xs_ys <span class="keyword1"><span class="command">have</span></span> xs_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> i_xs_ys <span class="keyword1"><span class="command">have</span></span> ys_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> f1_Zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> Zero <span class="main">∨</span> <span class="bound">y</span> <span class="main">≠</span> Zero <span class="main">⟹</span> f1 <span class="bound">x</span> <span class="bound">y</span> <span class="main">≠</span> Zero"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> Zero <span class="main">∨</span> <span class="skolem">y</span> <span class="main">≠</span> Zero <span class="main">⟹</span> f1 <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">≠</span> Zero"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> One_foldl1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> One <span class="main">∈</span> set <span class="bound">xs</span> <span class="main">⟹</span> foldl1 f1 <span class="bound">xs</span> <span class="main">≠</span> Zero"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> One_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"One <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="skolem">xs</span> <span class="main">≠</span> Zero"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> divide_and_conquer<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> One <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Partition <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"One <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∨</span> One <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> Partition <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="skolem">xs</span> <span class="main">≠</span> Zero <span class="main">∨</span> foldl1 f1 <span class="skolem">ys</span> <span class="main">≠</span> Zero"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> f1_Zero <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"f1 <span class="main">(</span>foldl1 f1 <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>foldl1 f1 <span class="skolem">ys</span><span class="main">)</span> <span class="main">≠</span> Zero"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> L8 <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">f1</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> f1_assoc <span class="keyword2"><span class="keyword">and</span></span> Partition
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> f1_Two<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> Zero <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> Zero <span class="main">⟹</span> f1 <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> Two"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> Zero <span class="main">∧</span> <span class="skolem">y</span> <span class="main">≠</span> Zero <span class="main">⟹</span> f1 <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> Two"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> i_xs_ys
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"One <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> One <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> Zero 
         <span class="main">∧</span> foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≠</span> Zero"</span></span>
    <span class="keyword1"><span class="command">using</span></span> One_foldl1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"f1 <span class="main">(</span>foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Two"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f1_Two <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Two"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldl1_map <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"h1 <span class="free">k</span> <span class="free">i</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> f1_assoc 
      <span class="keyword2"><span class="keyword">and</span></span> xs_not_empty <span class="keyword2"><span class="keyword">and</span></span> ys_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, this lemma is depicted in (and proved by) Figure~6.
Therefore, it carries this unusual name here. This lemma expresses that
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> contains only elements of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[0..&lt;k + 1]›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Figure_6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="bound">i</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> One"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> set <span class="free">js</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> i_in_js<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">js</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> Two_map<span class="main">:</span> <span class="quoted"><span class="quoted">"Two <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="main">0</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Two <span class="main">=</span> h1 <span class="free">k</span> <span class="main">0</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> i_in_js <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IntI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> f1_Two<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Two <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> Two <span class="main">⟹</span> f1 <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> Two"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Two <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> Two <span class="main">⟹</span> f1 <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> Two"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> Two <span class="main">∈</span> set <span class="bound">xs</span> <span class="main">⟹</span> foldl1 f1 <span class="bound">xs</span> <span class="main">=</span> Two"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> Two_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"Two <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="skolem">xs</span> <span class="main">=</span> Two"</span></span> <span class="keyword1"><span class="command">using</span></span> Two_xs
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> divide_and_conquer<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> One <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Partition <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Two <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∨</span> Two <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="skolem">xs</span> <span class="main">=</span> Two <span class="main">∨</span> foldl1 f1 <span class="skolem">ys</span> <span class="main">=</span> Two"</span></span> <span class="keyword1"><span class="command">using</span></span> Partition <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> f1_Two <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"f1 <span class="main">(</span>foldl1 f1 <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>foldl1 f1 <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> Two"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> Two"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L8 <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">f1</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> f1_assoc <span class="keyword2"><span class="keyword">and</span></span> Partition <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">with</span></span> Two_map <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="main">0</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> Two"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, this lemma is depicted in (and proved by) Figure~7.
Therefore, it carries this unusual name here. This lemma expresses that every
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i ≤ k›</span></span></span></span> in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> is eventually followed by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i + 1›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Figure_7<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> Two"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> last <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> Suc_i_not_in_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∉</span> set <span class="free">ys</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> last_map_One<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> One"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"last <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> List.last_conv_nth <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> h2 <span class="free">i</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L6 <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> h2 <span class="free">i</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> List.last_conv_nth <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> One"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="main">⟦</span>  <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> last <span class="bound">xs</span> <span class="main">=</span> One <span class="main">⟧</span> <span class="main">⟹</span> foldl1 f2 <span class="bound">xs</span> <span class="main">=</span> One"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> last_xs_One<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="skolem">xs</span> <span class="main">=</span> One"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> xs_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> xs_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> butlast <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span>last <span class="skolem">xs</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="skolem">xs</span> <span class="main">=</span> One"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"butlast <span class="skolem">xs</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> xs_partition <span class="keyword2"><span class="keyword">and</span></span> last_xs_One <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Cons
        <span class="keyword1"><span class="command">hence</span></span> butlast_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        
        <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"foldl1 f2 <span class="skolem">xs</span> <span class="main">=</span> foldl1 f2 <span class="main">(</span>butlast <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span>last <span class="skolem">xs</span><span class="main">]</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> xs_partition <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> f2 <span class="main">(</span>foldl1 f2 <span class="main">(</span>butlast <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl1 f2 <span class="main">[</span>last <span class="skolem">xs</span><span class="main">]</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> L8 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">f2</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> f2_assoc <span class="keyword2"><span class="keyword">and</span></span> butlast_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> One"</span></span> <span class="keyword1"><span class="command">using</span></span> last_xs_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> last_map_One <span class="keyword1"><span class="command">have</span></span> foldl1_map_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> One"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> ys_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> foldl1_map_xs <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> Two_map_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"Two <span class="main">∉</span> set <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Two <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Two <span class="main">∈</span> <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">∧</span> Two <span class="main">=</span> h2 <span class="free">i</span> <span class="skolem">j</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Set.image_iff <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"h2 <span class="free">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Suc_i_not_in_ys <span class="keyword2"><span class="keyword">and</span></span> j_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> f2_One<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> Two <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> Two <span class="main">⟹</span> f2 <span class="bound">x</span> <span class="bound">y</span> <span class="main">≠</span> Two"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> Two <span class="main">∧</span> <span class="skolem">y</span> <span class="main">≠</span> Two <span class="main">⟹</span> f2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">≠</span> Two"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> Two <span class="main">∉</span> set <span class="bound">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> foldl1 f2 <span class="bound">xs</span> <span class="main">≠</span> Two"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> xs_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">::</span> three list<span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Two <span class="main">∉</span> set <span class="skolem">xs</span> <span class="main">⟹</span> foldl1 f2 <span class="skolem">xs</span> <span class="main">≠</span> Two"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> divide_and_conquer<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> One <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Partition <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Two <span class="main">∉</span> set <span class="skolem">xs</span> <span class="main">∧</span> Two <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="skolem">xs</span> <span class="main">≠</span> Two <span class="main">∧</span> foldl1 f2 <span class="skolem">ys</span> <span class="main">≠</span> Two"</span></span> <span class="keyword1"><span class="command">using</span></span> Partition <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"f2 <span class="main">(</span>foldl1 f2 <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>foldl1 f2 <span class="skolem">ys</span><span class="main">)</span> <span class="main">≠</span> Two"</span></span> <span class="keyword1"><span class="command">using</span></span> f2_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">≠</span> Two"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L8 <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">f2</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> f2_assoc <span class="keyword2"><span class="keyword">and</span></span> Partition <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Two_map_ys <span class="keyword1"><span class="command">have</span></span> foldl1_map_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≠</span> Two"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ys_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> f2_One 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"f2 <span class="main">(</span>foldl1 f2 <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>foldl1 f2 <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> Two"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldl1_map_xs <span class="keyword2"><span class="keyword">and</span></span> foldl1_map_ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl1 f2 <span class="main">(</span>map <span class="main">(</span>h2 <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> Two"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> foldl1_map <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"h2 <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">f2</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> f2_assoc 
      <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> ys_not_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Permutations and Lemma 4›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, the argumentation goes as follows:
From <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Figure_4›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Figure_5›</span></span></span></span> we can show that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span>
contains every <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i ≤ k›</span></span></span></span> exactly once, and from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Figure_6›</span></span></span></span> we can
furthermore show that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> contains no other elements. Thus, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span>
must be a permutation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[0..&lt;k + 1]›</span></span></span></span>.

Here, however, the argumentation is different, because we want to use already
existing results. Therefore, we show first, that the sets of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> and
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[0..&lt;k + 1]›</span></span></span></span> are equal using the results of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Figure_4›</span></span></span></span> and
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Figure_6›</span></span></span></span>. Second, we show that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> is a distinct list, i.e. no
element occurs twice in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span>. Since also <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[0..&lt;k + 1]›</span></span></span></span> is
distinct, the multisets of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[0..&lt;k + 1]›</span></span></span></span> are equal,
and therefore, both lists are permutations.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> js_is_a_permutation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="main">(</span><span class="bound">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="bound">h</span><span class="main">.</span> associative <span class="bound">f</span>
                <span class="main">⟹</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">&lt;~~&gt;</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword2"><span class="keyword">and</span></span> L9 <span class="keyword1"><span class="command">have</span></span> L9'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> foldl1 f1 <span class="main">(</span>map <span class="main">(</span>h1 <span class="free">k</span> <span class="bound">i</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> L9' <span class="keyword2"><span class="keyword">and</span></span> Figure_4 <span class="keyword2"><span class="keyword">and</span></span> A2 <span class="keyword1"><span class="command">have</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">js</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> L9' <span class="keyword2"><span class="keyword">and</span></span> Figure_5 <span class="keyword1"><span class="command">have</span></span> P2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">;</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="bound">i</span> <span class="main">∈</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="bound">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> L9' <span class="keyword2"><span class="keyword">and</span></span> Figure_6 <span class="keyword1"><span class="command">have</span></span> P3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∉</span> set <span class="free">js</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> set_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> set <span class="free">js</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">from</span></span> P1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">⊆</span> set <span class="free">js</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">js</span> <span class="main">⊆</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="free">js</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">j</span> <span class="main">∉</span> set <span class="free">js</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> P3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> HOL.contrapos_nn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">⟹</span> set <span class="bound">xs</span> <span class="main">∩</span> set <span class="bound">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span>
      <span class="keyword3"><span class="command">assume</span></span> js_xs_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> set_eq <span class="keyword1"><span class="command">have</span></span> i_xs_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="skolem">ys</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">i</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">i</span> <span class="main">∉</span> set <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> js_xs_ys <span class="keyword2"><span class="keyword">and</span></span> P2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> js_xs_ys <span class="keyword2"><span class="keyword">and</span></span> P2 <span class="keyword2"><span class="keyword">and</span></span> P1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">∩</span> set <span class="skolem">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_xs_ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> all_set_inter_empty_distinct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">js</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> set_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">js</span> <span class="main">=</span> mset <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Multiset.set_eq_iff_mset_eq_distinct 
          <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">js</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">&lt;~~&gt;</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Permutation.mset_eq_perm <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">js</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> ys<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The result of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Figure_7›</span></span></span></span> is too specific. Instead of having that every
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> is eventually followed by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i + 1›</span></span></span></span>, it more useful to know
that every <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> is followed by all <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i + r›</span></span></span></span>, where 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r &gt; 0›</span></span></span></span>. This result follows easily by induction from 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Figure_7›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Figure_7_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">;</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="bound">i</span> <span class="main">=</span> last <span class="bound">xs</span> <span class="main">⟧</span>
                         <span class="main">⟹</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">r</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> last <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> A2 A3 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> i_r_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> Suc <span class="skolem">r</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A1 <span class="keyword2"><span class="keyword">and</span></span> i_r_k <span class="keyword2"><span class="keyword">and</span></span> A4 <span class="keyword2"><span class="keyword">and</span></span> A5 <span class="keyword2"><span class="keyword">and</span></span> A6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Suc 
    <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">!</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> List.in_set_conv_nth <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">ys</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="skolem">r</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_r_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="skolem">r</span> <span class="main">=</span> last <span class="var">?xs</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> p_def <span class="keyword2"><span class="keyword">and</span></span> List.take_Suc_conv_app_nth <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A1 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> List.set_drop_subset <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Since we want to use Lemma <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>partitions_sorted›</span></span></span></span> to show that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span>
is sorted, we need yet another result which can be obtained using the
previous lemma and some further argumentation:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> js_partition_order<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">&lt;~~&gt;</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">;</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="bound">i</span> <span class="main">=</span> last <span class="bound">xs</span> <span class="main">⟧</span>
                         <span class="main">⟹</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> A5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> i_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> A5 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pj</span></span> <span class="keyword2"><span class="keyword">where</span></span> pj_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pj</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">!</span> <span class="skolem">pj</span> <span class="main">=</span> <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> List.in_set_conv_nth <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">pj</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">pj</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">ys</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="free">j</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword2"><span class="keyword">and</span></span> A3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Permutation.perm_distinct_iff <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> xs_ys_inter_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> A2 <span class="keyword2"><span class="keyword">and</span></span> Figure_7_trans <span class="keyword1"><span class="command">have</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">r</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">r</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">;</span> <span class="bound">i</span> <span class="main">+</span> <span class="bound">r</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">;</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="bound">i</span> <span class="main">=</span> last <span class="bound">xs</span> <span class="main">⟧</span>
               <span class="main">⟹</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> i_j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="var">?r</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">js</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A4 <span class="keyword2"><span class="keyword">and</span></span> A3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> A1 <span class="keyword2"><span class="keyword">and</span></span> Permutation.perm_set_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> last <span class="main">(</span><span class="var">?xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pj_def <span class="keyword2"><span class="keyword">and</span></span> List.take_Suc_conv_app_nth <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">pj</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="var">?r</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_j <span class="keyword2"><span class="keyword">and</span></span> List.set_drop_subset <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A4 <span class="keyword2"><span class="keyword">and</span></span> xs_ys_inter_empty <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
With the help of the previous lemma, we show now that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span> equals
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[0..&lt;k + 1]›</span></span></span></span>, if both lists are permutations and every <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span> is
eventually followed by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i + 1›</span></span></span></span> in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>js›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> js_equals_upt_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">&lt;~~&gt;</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">;</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="bound">i</span> <span class="main">=</span> last <span class="bound">xs</span> <span class="main">⟧</span>
                         <span class="main">⟹</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword2"><span class="keyword">and</span></span> A2 <span class="keyword2"><span class="keyword">and</span></span> js_partition_order
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs</span> <span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="bound">ys</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">js</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partitions_sorted <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">js</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> A1 <span class="keyword2"><span class="keyword">and</span></span> Permutation.perm_distinct_iff <span class="keyword2"><span class="keyword">and</span></span> List.distinct_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> List.sorted_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">js</span> <span class="main">=</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> A1 <span class="keyword2"><span class="keyword">and</span></span> Permutation.perm_set_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> List.sorted_distinct_set_unique 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
From all the work done before, we conclude now Lemma 4:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Lemma_4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="bound">h</span><span class="main">.</span> associative <span class="bound">f</span>  
             <span class="main">⟹</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="free">js</span><span class="main">)</span> <span class="main">=</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> js_is_a_permutation <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">&lt;~~&gt;</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> L10 <span class="keyword2"><span class="keyword">and</span></span> Figure_7
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">;</span> <span class="free">js</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">;</span> <span class="bound">i</span> <span class="main">=</span> last <span class="bound">xs</span> <span class="main">⟧</span>
                  <span class="main">⟹</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> js_equals_upt_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 5›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This lemma is a lifting of Lemma 4 to the overall computation of 
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>scanl1›</span></span></span></span>. Its proof follows closely the one given in the original paper.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Lemma_5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="bound">h</span><span class="main">.</span> associative <span class="bound">f</span>
             <span class="main">⟹</span> map <span class="main">(</span>foldl1 <span class="bound">f</span> <span class="main">∘</span> map <span class="bound">h</span><span class="main">)</span> <span class="free">jss</span> <span class="main">=</span> scanl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">js</span><span class="main">.</span> <span class="bound">js</span> <span class="main">∈</span> set <span class="free">jss</span> <span class="main">⟹</span> <span class="bound">js</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">jss</span> <span class="main">=</span> ups <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">jss</span> <span class="main">=</span> length <span class="main">(</span>ups <span class="free">n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"three <span class="main">⇒</span> three <span class="main">⇒</span> three"</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"associative <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f1_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span>
      <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"length <span class="free">jss</span> <span class="main">=</span> length <span class="main">(</span>map <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="main">∘</span> map <span class="skolem">h</span><span class="main">)</span> <span class="free">jss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>scanl1 <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> f_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>ups <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">jss</span> <span class="main">⟹</span> <span class="free">jss</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span>ups <span class="free">n</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> k_length_jss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">jss</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> non_empty_jss_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jss</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">from</span></span> k_length_jss 
      <span class="keyword1"><span class="command">have</span></span> k_length_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> k_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> List.length_upt <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="bound">h</span><span class="main">.</span> associative <span class="bound">f</span>
                  <span class="main">⟹</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="main">(</span><span class="free">jss</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> foldl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">h</span>
          <span class="keyword3"><span class="command">assume</span></span> f_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"associative <span class="main">(</span><span class="skolem">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"foldl1 <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">(</span><span class="free">jss</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>
           <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="main">∘</span> map <span class="skolem">h</span><span class="main">)</span> <span class="free">jss</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> L6 <span class="keyword2"><span class="keyword">and</span></span> k_length_jss <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>scanl1 <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> f_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                    <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span><span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> L6 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
              <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> 
              <span class="keyword2"><span class="keyword">and</span></span> k_length_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">k</span>  <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> List.nth_upt <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
                    <span class="keyword2"><span class="keyword">and</span></span> k_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> L3 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">h</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> List.take_upt <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
                <span class="keyword2"><span class="keyword">and</span></span> k_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> 
          <span class="quoted"><span class="quoted">"foldl1 <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">(</span><span class="free">jss</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> foldl1 <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> Lemma_4 <span class="keyword2"><span class="keyword">and</span></span> non_empty_jss_k <span class="keyword1"><span class="command">have</span></span> P3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jss</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span>ups <span class="free">n</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> 
       <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L6 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> k_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> List.nth_upt <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> k_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ups <span class="free">n</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      
      <span class="keyword1"><span class="command">with</span></span> P3 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">jss</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span>ups <span class="free">n</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> P1 P2 <span class="keyword2"><span class="keyword">and</span></span> Lemma_2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">jss</span> <span class="main">=</span> ups <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proposition 1›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In the original paper, only non-empty lists where considered, whereas here,
the used list datatype allows also for empty lists. Therefore, we need to 
exclude non-empty lists to have a similar setting as in the original paper.

In the case of Proposition 1, we need to show that every list contained in
the result of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>candidate (@) (map wrap [0..&lt;n + 1])›</span></span></span></span> is non-empty.
The idea is to interpret empty lists by the value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Zero›</span></span></span></span> and non-empty
lists by the value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>One›</span></span></span></span>, and to apply the assumptions.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> non_empty_candidate_results<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="main">(</span><span class="bound">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">::</span> three list<span class="main">)</span><span class="main">.</span> 
             <span class="main">⟦</span> associative <span class="bound">f</span> <span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span>  <span class="main">⟹</span> candidate <span class="bound">f</span> <span class="bound">xs</span> <span class="main">=</span> scanl1 <span class="bound">f</span> <span class="bound">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">∈</span> set <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹We define a mapping of lists to values of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">three</span><span class="antiquote">}</span></span> as explained›</span>
  <span class="comment1">― ‹above, and a function which behaves like <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">@</span><span class="antiquote">}</span></span> on values of›</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">three</span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xs</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> Zero <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">#</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> One"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">x</span> <span class="main">=</span> One <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> One<span class="main">)</span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Zero"</span></span>
  <span class="keyword1"><span class="command">have</span></span> g_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"associative <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> associative_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹Our defined functions fulfill the requirements of the free theorem of›</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">candidate</span><span class="antiquote">}</span></span>, that is:›</span>
  <span class="keyword1"><span class="command">have</span></span> req_free_theorem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="var">?h</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">(</span><span class="var">?h</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="var">?h</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">(</span><span class="var">?h</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="var">?h</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Before applying the assumptions, we show that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">candidate</span><span class="antiquote">}</span></span>'s›</span>
  <span class="comment1">― ‹counterpart <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">scanl1</span><span class="antiquote">}</span></span>, applied to a non-empty list, returns only›</span>
  <span class="comment1">― ‹a repetition of the value <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">One</span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">have</span></span> set_scanl1_is_One<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>scanl1 <span class="var">?g</span> <span class="main">(</span>map <span class="var">?h</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>One<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> const_One<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> One<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> replicate <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> 
          <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> One<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>
           <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> One<span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">n</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="skolem">n</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> One<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">n</span><span class="main">]</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> One<span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">n</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> replicate <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> One <span class="main">@</span> replicate <span class="main">1</span> One"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> replicate <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> List.replicate_add 
                      <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted">One</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> foldl1_One<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> foldl1 <span class="var">?g</span> <span class="main">(</span>One <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span> One"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldl1 <span class="var">?g</span> <span class="main">(</span>One <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> One"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">length</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> length <span class="bound">y</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">x</span><span class="main">::</span>three list<span class="main">)</span> 
                        <span class="main">⟶</span> foldl1 <span class="var">?g</span> <span class="main">(</span>One <span class="main">#</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> One"</span></span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl1 <span class="var">?g</span> <span class="main">(</span>One <span class="main">#</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"scanl1 <span class="var">?g</span> <span class="main">(</span>map <span class="var">?h</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> scanl1 <span class="var">?g</span> <span class="main">(</span>map <span class="main">(</span><span class="var">?h</span> <span class="main">∘</span> wrap<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L1 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?h</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">wrap</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> scanl1 <span class="var">?g</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> One<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fun.o_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> scanl1 <span class="var">?g</span> <span class="main">(</span>replicate <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> const_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="var">?g</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>replicate <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One<span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="main">(</span>replicate <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One<span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="var">?g</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>replicate <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One<span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span>map Suc <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>replicate <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One<span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> List.map_Suc_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="var">?g</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>replicate <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> Suc<span class="main">)</span>
               <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>replicate <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One<span class="main">)</span><span class="main">]</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="var">?g</span> <span class="main">(</span>replicate <span class="main">(</span>min <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> One<span class="main">)</span><span class="main">)</span>
               <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Fun.o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="var">?g</span> <span class="main">(</span>One <span class="main">#</span> replicate <span class="main">(</span>min <span class="bound">k</span> <span class="free">n</span><span class="main">)</span> One<span class="main">)</span><span class="main">)</span> 
               <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> One<span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> foldl1_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> replicate <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> One"</span></span> <span class="keyword1"><span class="command">using</span></span> const_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> List.set_replicate <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Thus, with the assumptions and the free theorem of candidate, we show›</span>
  <span class="comment1">― ‹that results of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">candidate</span><span class="antiquote">}</span></span>, after applying <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">h</span><span class="antiquote">}</span></span>, can only›</span>
  <span class="comment1">― ‹have the value <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">One</span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"scanl1 <span class="var">?g</span> <span class="main">(</span>map <span class="var">?h</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
   <span class="main">=</span> candidate <span class="var">?g</span> <span class="main">(</span>map <span class="var">?h</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> g_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="var">?h</span> <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> candidate_free_theorem <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(@)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?g</span>"</span></span> 
      <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?h</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> zs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> req_free_theorem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> set_is_One<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="var">?h</span> <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> One"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> set_scanl1_is_One <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹Now, it is easy to conclude the thesis.›</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="free">js</span> <span class="main">∈</span> <span class="var">?h</span> <span class="main">`</span> set <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> set_is_One <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="free">js</span> <span class="main">=</span> One"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Proposition 1 is very similar to the corresponding one shown in the original
paper except of a slight modification due to the choice of using Isabelle's
list datatype.

Strictly speaking, the requirement that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> must be non-empty in the
assumptions of Proposition 1 is not necessary, because only non-empty lists
are applied in the proof. However, the additional requirement eases the proof
obligations of the final theorem, i.e. this additions allows more (or easier)
applications of the final theorem.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Proposition_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="main">(</span><span class="bound">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">::</span> three list<span class="main">)</span><span class="main">.</span> 
             <span class="main">⟦</span> associative <span class="bound">f</span> <span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span>  <span class="main">⟹</span> candidate <span class="bound">f</span> <span class="bound">xs</span> <span class="main">=</span> scanl1 <span class="bound">f</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ups <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹This addition is necessary because we are using Isabelle's list datatype›</span>
  <span class="comment1">― ‹which allows for empty lists.›</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> non_empty_candidate_results <span class="keyword1"><span class="command">have</span></span> non_empty_candidate<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">js</span><span class="main">.</span> <span class="bound">js</span> <span class="main">∈</span> set <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">js</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="main">(</span><span class="bound">f</span><span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="bound">h</span><span class="main">.</span> associative <span class="bound">f</span>
        <span class="main">⟹</span> map <span class="main">(</span>foldl1 <span class="bound">f</span> <span class="main">∘</span> map <span class="bound">h</span><span class="main">)</span> <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
           <span class="main">=</span> scanl1 <span class="bound">f</span> <span class="main">(</span>map <span class="bound">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">h</span>
      <span class="keyword3"><span class="command">assume</span></span> f_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"associative <span class="main">(</span><span class="skolem">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> 
      <span class="quoted"><span class="quoted">"map <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="main">∘</span> map <span class="skolem">h</span><span class="main">)</span> <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
       <span class="main">=</span> candidate <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Lemma_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> scanl1 <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> f_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> 
      <span class="quoted"><span class="quoted">"map <span class="main">(</span>foldl1 <span class="skolem">f</span> <span class="main">∘</span> map <span class="skolem">h</span><span class="main">)</span> <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> scanl1 <span class="skolem">f</span> <span class="main">(</span>map <span class="skolem">h</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Lemma_5 <span class="keyword2"><span class="keyword">and</span></span> non_empty_candidate <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>





<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Proving Proposition 2›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Before proving Proposition 2, a non-trivial step of that proof is shown first.
In the original paper, the argumentation simply applies L7 and the definition
of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>map›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[0..&lt;k + 1]›</span></span></span></span>. However, since, L7 requires that
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span> must be less than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>length [0..&lt;length xs]›</span></span></span></span> and this does
not simply follow for the bound occurrence of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>k›</span></span></span></span>, a more complicated
proof is necessary. Here, it is shown based on Lemma 2.
›</span></span>
      
<span class="keyword1"><span class="command">lemma</span></span> Prop_2_step_L7<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span>
   <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>   
  <span class="keyword1"><span class="command">have</span></span> P1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>
   <span class="main">=</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
      
  <span class="keyword1"><span class="command">have</span></span> P2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
                       <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> 
       <span class="main">⟹</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span>
          <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> k_length<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
                         <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> k_length'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
        
      <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> 
       <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L6 <span class="keyword2"><span class="keyword">and</span></span> k_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> k_length' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L7 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> k_length' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> k_length' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L6 <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> k_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> 
       <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
      
  <span class="keyword1"><span class="command">from</span></span> P1 P2 <span class="keyword2"><span class="keyword">and</span></span> Lemma_2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Compared to the original paper, here, Proposition 2 has the additional 
assumption that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs›</span></span></span></span> is non-empty. The proof, however, is identical
to the the one given in the original paper, except for the non-trivial step
shown before.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Proposition_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> ups <span class="bound">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"associative <span class="free">g</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"candidate <span class="free">g</span> <span class="free">xs</span> <span class="main">=</span> scanl1 <span class="free">g</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹First, based on Lemma 2, we show that›</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span>"</span><span class="antiquote">}</span></span>›</span>
  <span class="comment1">― ‹by the following facts P1 and P2.›</span>

  <span class="keyword1"><span class="command">have</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"length <span class="free">xs</span> 
       <span class="main">=</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L2 <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> k_length_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> k_length_xs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> nth <span class="free">xs</span> <span class="main">(</span><span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> k_length_xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> L6 <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> k_length_xs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> P1 P2 <span class="keyword2"><span class="keyword">and</span></span> Lemma_2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="comment1">― ‹Thus, with some rewriting, we show the thesis.›</span>
  <span class="keyword1"><span class="command">hence</span></span> 
  <span class="quoted"><span class="quoted">"candidate <span class="free">g</span> <span class="free">xs</span> 
   <span class="main">=</span> candidate <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>foldl1 <span class="free">g</span> <span class="main">∘</span> map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>candidate <span class="main">(@)</span> <span class="main">(</span>map wrap <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Lemma_3 <span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"nth <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> 
      <span class="keyword2"><span class="keyword">and</span></span> A2 <span class="keyword2"><span class="keyword">and</span></span> A3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>foldl1 <span class="free">g</span> <span class="main">∘</span> map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ups <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A1 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> A3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>foldl1 <span class="free">g</span> <span class="main">∘</span> map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L1 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"foldl1 <span class="free">g</span> <span class="main">∘</span> map <span class="main">(</span>nth <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Fun.o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Prop_2_step_L7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="bound">k</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> foldl1 <span class="free">g</span> <span class="main">(</span>take <span class="bound">k</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">xs</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> List.map_Suc_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> scanl1 <span class="free">g</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>




<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Final Result›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Finally, we the main result follows directly from Proposition 1 and 
Proposition 2.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> The_0_1_2_Principle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="main">(</span><span class="bound">f</span> <span class="main">::</span> three <span class="main">⇒</span> three <span class="main">⇒</span> three<span class="main">)</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">::</span> three list<span class="main">)</span><span class="main">.</span> 
             <span class="main">⟦</span> associative <span class="bound">f</span> <span class="main">;</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟧</span> <span class="main">⟹</span> candidate <span class="bound">f</span> <span class="bound">xs</span> <span class="main">=</span> scanl1 <span class="bound">f</span> <span class="bound">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"associative <span class="free">g</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"candidate <span class="free">g</span> <span class="free">ys</span> <span class="main">=</span> scanl1 <span class="free">g</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Proposition_1 Proposition_2 <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>





<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\section*{Acknowledgments}

I thank Janis Voigtl\"ander for sharing a draft of his paper before its
publication with me.

›</span></span>



<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>

</pre>
</div>