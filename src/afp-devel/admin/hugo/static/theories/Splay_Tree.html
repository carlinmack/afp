<div id="Splay_Tree">
<div class="head">
<h1>Theory Splay_Tree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Splay Tree"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Splay_Tree
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Tree.html">HOL-Library.Tree</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Set_Specs.html">HOL-Data_Structures.Set_Specs</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Cmp.html">HOL-Data_Structures.Cmp</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> sorted_wrt.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Splay trees were invented by Sleator and Tarjan~\cite{SleatorT-JACM85}.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>splay›</span></span></span></span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">splay</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span> <span class="main">=</span> Node Leaf <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span> <span class="main">=</span> Node Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> Leaf <span class="main">⟹</span>
 <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">of</span> Node <span class="bound">A1</span> <span class="bound">a'</span> <span class="bound">A2</span> <span class="main">⇒</span> Node <span class="bound">A1</span> <span class="bound">a'</span> <span class="main">(</span>Node <span class="bound">A2</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≠</span> Leaf <span class="main">⟹</span>
 <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1">of</span> Node <span class="bound">B1</span> <span class="bound">b'</span> <span class="bound">B2</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">B1</span><span class="main">)</span> <span class="bound">b'</span> <span class="main">(</span>Node <span class="bound">B2</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> Leaf<span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≠</span> Leaf <span class="main">⟹</span>
 <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">of</span> Node <span class="bound">C1</span> <span class="bound">c'</span> <span class="bound">C</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">C1</span><span class="main">)</span> <span class="bound">c'</span> <span class="main">(</span>Node <span class="bound">C</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> Leaf<span class="main">)</span><span class="main">)</span> <span class="main">=</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≠</span> Leaf <span class="main">⟹</span>
 <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">of</span> Node <span class="bound">D1</span> <span class="bound">d'</span> <span class="bound">D2</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">AB</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">D1</span><span class="main">)</span> <span class="bound">d'</span> <span class="bound">D2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="comment1">(* 1 subgoal *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> neq_Leaf_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust le_less_linear less_linear<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">splay</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> splay_code<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="free">x</span> <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> <span class="free">CD</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="free">b</span> <span class="keyword1">of</span>
   EQ <span class="main">⇒</span> Node <span class="free">AB</span> <span class="free">b</span> <span class="free">CD</span> <span class="main">|</span>
   LT <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">AB</span> <span class="keyword1">of</span>
          Leaf <span class="main">⇒</span> Node <span class="free">AB</span> <span class="free">b</span> <span class="free">CD</span> <span class="main">|</span>
          Node <span class="bound">A</span> <span class="bound">a</span> <span class="bound">B</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="bound">a</span> <span class="keyword1">of</span> EQ <span class="main">⇒</span> Node <span class="bound">A</span> <span class="bound">a</span> <span class="main">(</span>Node <span class="bound">B</span> <span class="free">b</span> <span class="free">CD</span><span class="main">)</span> <span class="main">|</span>
             LT <span class="main">⇒</span>  <span class="keyword1">if</span> <span class="bound">A</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="bound">A</span> <span class="bound">a</span> <span class="main">(</span>Node <span class="bound">B</span> <span class="free">b</span> <span class="free">CD</span><span class="main">)</span>
                       <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free">x</span> <span class="bound">A</span> <span class="keyword1">of</span>
                         Node <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">a'</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> Node <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">a'</span> <span class="main">(</span>Node <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">a</span> <span class="main">(</span>Node <span class="bound">B</span> <span class="free">b</span> <span class="free">CD</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
             GT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">B</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="bound">A</span> <span class="bound">a</span> <span class="main">(</span>Node <span class="bound">B</span> <span class="free">b</span> <span class="free">CD</span><span class="main">)</span>
                       <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free">x</span> <span class="bound">B</span> <span class="keyword1">of</span>
                         Node <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">b'</span> <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="bound">A</span> <span class="bound">a</span> <span class="bound">B<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">b'</span> <span class="main">(</span>Node <span class="bound">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">b</span> <span class="free">CD</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
   GT <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">CD</span> <span class="keyword1">of</span>
          Leaf <span class="main">⇒</span> Node <span class="free">AB</span> <span class="free">b</span> <span class="free">CD</span> <span class="main">|</span>
          Node <span class="bound">C</span> <span class="bound">c</span> <span class="bound">D</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="bound">c</span> <span class="keyword1">of</span> EQ <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> <span class="bound">C</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">D</span> <span class="main">|</span>
             LT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">C</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> <span class="bound">C</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">D</span>
                       <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free">x</span> <span class="bound">C</span> <span class="keyword1">of</span>
                         Node <span class="bound">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c'</span> <span class="bound">C<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> <span class="bound">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">c'</span> <span class="main">(</span>Node <span class="bound">C<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">c</span> <span class="bound">D</span><span class="main">)</span> <span class="main">|</span>
             GT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">D</span><span class="main">=</span>Leaf <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> <span class="bound">C</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">D</span>
                       <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free">x</span> <span class="bound">D</span> <span class="keyword1">of</span>
                         Node <span class="bound">D<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">d</span> <span class="bound">D<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="main">(</span>Node <span class="free">AB</span> <span class="free">b</span> <span class="bound">C</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">D<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">d</span> <span class="bound">D<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_root</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Leaf <span class="main">⇒</span> False <span class="main">|</span> Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">isin</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> is_root <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">=</span> Leaf"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> insert

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf
   <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
     Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span>
      <span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">a</span> <span class="keyword1">of</span>
        EQ <span class="main">⇒</span> Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">|</span>
        LT <span class="main">⇒</span> Node <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node Leaf <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span>
        GT <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="bound">l</span> <span class="bound">a</span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">r</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">splay_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">splay_max</span> Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">splay_max</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf<span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">splay_max</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> Leaf
   <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free">splay_max</span> <span class="free"><span class="bound"><span class="entity">CD</span></span></span> <span class="keyword1">of</span>
     Node <span class="bound">C</span> <span class="bound">c</span> <span class="bound">D</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">C</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splay_max_code<span class="main">:</span> <span class="quoted"><span class="quoted">"splay_max <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span>
  Leaf <span class="main">⇒</span> <span class="free">t</span> <span class="main">|</span>
  Node <span class="bound">la</span> <span class="bound">a</span> <span class="bound">ra</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ra</span> <span class="keyword1">of</span>
    Leaf <span class="main">⇒</span> <span class="free">t</span> <span class="main">|</span>
    Node <span class="bound">lb</span> <span class="bound">b</span> <span class="bound">rb</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="bound">rb</span><span class="main">=</span>Leaf <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="bound">la</span> <span class="bound">a</span> <span class="bound">lb</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">rb</span>
       <span class="keyword1">else</span> <span class="keyword1">case</span> splay_max <span class="bound">rb</span> <span class="keyword1">of</span>
              Node <span class="bound">lc</span> <span class="bound">c</span> <span class="bound">rc</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="main">(</span>Node <span class="bound">la</span> <span class="bound">a</span> <span class="bound">lb</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">lc</span><span class="main">)</span> <span class="bound">c</span> <span class="bound">rc</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Leaf_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Leaf
   <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="bound">a</span> <span class="keyword1">then</span> Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="bound">r</span> <span class="keyword1">else</span> <span class="keyword1">case</span> splay_max <span class="bound">l</span> <span class="keyword1">of</span> Node <span class="bound">l'</span> <span class="bound">m</span> <span class="bound">r'</span> <span class="main">⇒</span> Node <span class="bound">l'</span> <span class="bound">m</span> <span class="bound">r</span><span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Functional Correctness Proofs I"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This subsection follows the automated method by Nipkow \cite{Nipkow-ITP16}.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splay_Leaf_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splay <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> Leaf<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">=</span> Leaf<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splay_max_Leaf_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splay_max <span class="free">t</span> <span class="main">=</span> Leaf<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">=</span> Leaf<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay_max.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Verification of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> isin<span class="antiquote"><span class="antiquote">}</span></span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splay_elemsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"splay <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">a</span> <span class="free">r</span> <span class="main">⟹</span> sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">=</span><span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isin_simps ball_Un <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isin_set<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> isin <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isin_def is_root_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> splay_elemsD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Verification of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> insert<span class="antiquote"><span class="antiquote">}</span></span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_splay<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder<span class="main">(</span>splay <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Leaf_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_splay<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> splay <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">a</span> <span class="free">r</span> <span class="main">⟹</span>
  sorted<span class="main">(</span>inorder <span class="free">l</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> inorder <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inorder_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_lems sorted_Cons_le sorted_snoc_le <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder<span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> inorder_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> sorted_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins_list_simps ins_list_Cons ins_list_snoc neq_Leaf_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Verification of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> delete<span class="antiquote"><span class="antiquote">}</span></span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_splay_maxD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"splay_max <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">a</span> <span class="free">r</span> <span class="main">⟹</span> sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
  inorder <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">=</span> inorder <span class="free">t</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> Leaf"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay_max.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_lems <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder<span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> inorder_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> sorted_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> del_list_simps del_list_sorted_app delete_def
  del_list_notin_Cons inorder_splay_maxD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Overall Correctness"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> splay<span class="main">:</span> Set_by_Ordered
<span class="keyword2"><span class="keyword">where</span></span> empty <span class="main">=</span> <span class="quoted">empty</span> <span class="keyword2"><span class="keyword">and</span></span> isin <span class="main">=</span> <span class="quoted">isin</span> <span class="keyword2"><span class="keyword">and</span></span> insert <span class="main">=</span> <span class="quoted">insert</span>
<span class="keyword2"><span class="keyword">and</span></span> delete <span class="main">=</span> <span class="quoted">delete</span> <span class="keyword2"><span class="keyword">and</span></span> inorder <span class="main">=</span> <span class="quoted">inorder</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isin_set<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inorder_insert <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inorder_delete<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> empty_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Corollaries:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bst_splay<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> bst <span class="main">(</span>splay <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bst_iff_sorted_wrt_less inorder_splay<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bst_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> bst<span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> splay.invar_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bst_iff_sorted_wrt_less splay.invar_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bst_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> bst<span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> splay.invar_delete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bst_iff_sorted_wrt_less splay.invar_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splay_bstL<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> splay <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">e</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set_tree <span class="free">l</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bst_iff_sorted_wrt_less list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_inorder sorted_splay sorted_wrt_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splay_bstR<span class="main">:</span> <span class="quoted"><span class="quoted">"bst <span class="free">t</span> <span class="main">⟹</span> splay <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">e</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set_tree <span class="free">r</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bst_iff_sorted_wrt_less sorted_Cons_iff set_inorder sorted_splay sorted_wrt_append<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Size lemmas"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_splay<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>splay <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> size <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_if_splay<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">u</span> <span class="free">r</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">=</span> size <span class="free">l</span> <span class="main">+</span> size <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def size_splay tree.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splay_not_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">x</span> <span class="bound">r</span><span class="main">.</span> splay <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> Node <span class="bound">l</span> <span class="bound">x</span> <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> neq_Leaf_iff splay_Leaf_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_splay_max<span class="main">:</span> <span class="quoted"><span class="quoted">"size<span class="main">(</span>splay_max <span class="free">t</span><span class="main">)</span> <span class="main">=</span> size <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay_max.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_if_splay_max<span class="main">:</span> <span class="quoted"><span class="quoted">"splay_max <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">u</span> <span class="free">r</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">=</span> size <span class="free">l</span> <span class="main">+</span> size <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def size_splay_max tree.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(*
subsection "Functional Correctness Proofs II"

text ‹This subsection follows the traditional approach, is less automated
and is retained more for historic reasons.›

lemma set_splay: "set_tree(splay a t) = set_tree t"
proof(induction a t rule: splay.induct)
  case (6 a)
  with splay_not_Leaf[OF 6(3), of a] show ?case by(fastforce)
next
  case (8 _ a)
  with splay_not_Leaf[OF 8(3), of a] show ?case by(fastforce)
next
  case (11 _ a)
  with splay_not_Leaf[OF 11(3), of a] show ?case by(fastforce)
next
  case (14 _ a)
  with splay_not_Leaf[OF 14(3), of a] show ?case by(fastforce)
qed auto

lemma splay_bstL: "bst t ⟹ splay a t = Node l e r ⟹ x ∈ set_tree l ⟹ x &lt; a"
apply(induction a t arbitrary: l x r rule: splay.induct)
apply (auto split: tree.splits)
apply auto
done

lemma splay_bstR: "bst t ⟹ splay a t = Node l e r ⟹ x ∈ set_tree r ⟹ a &lt; x"
apply(induction a t arbitrary: l e x r rule: splay.induct)
apply auto
apply (fastforce split!: tree.splits)+
done

lemma bst_splay: "bst t ⟹ bst(splay a t)"
proof(induction a t rule: splay.induct)
  case (6 a _ _ ll)
  with splay_not_Leaf[OF 6(3), of a] set_splay[of a ll,symmetric]
  show ?case by (fastforce)
next
  case (8 _ a _ t)
  with splay_not_Leaf[OF 8(3), of a] set_splay[of a t,symmetric]
  show ?case by fastforce
next
  case (11 _ a _ t)
  with splay_not_Leaf[OF 11(3), of a] set_splay[of a t,symmetric]
  show ?case by fastforce
next
  case (14 _ a _ t)
  with splay_not_Leaf[OF 14(3), of a] set_splay[of a t,symmetric]
  show ?case by fastforce
qed auto

lemma splay_to_root: "⟦ bst t;  splay a t = t' ⟧ ⟹
  a ∈ set_tree t ⟷ (∃l r. t' = Node l a r)"
proof(induction a t arbitrary: t' rule: splay.induct)
  case (6 a)
  with splay_not_Leaf[OF 6(3), of a] show ?case by auto
next
  case (8 _ a)
  with splay_not_Leaf[OF 8(3), of a] show ?case by auto
next
  case (11 _ a)
  with splay_not_Leaf[OF 11(3), of a] show ?case by auto
next
  case (14 _ a)
  with splay_not_Leaf[OF 14(3), of a] show ?case by auto
qed fastforce+


subsubsection "Verification of Is-in Test"

text‹To test if an element ‹a› is in ‹t›, first perform
@{term"splay a t"}, then check if the root is ‹a›. One could
put this into one function that returns both a new tree and the test result.›

lemma is_root_splay: "bst t ⟹ is_root a (splay a t) ⟷ a ∈ set_tree t"
by(auto simp add: is_root_def splay_to_root split: tree.split)


subsubsection "Verification of @{const insert}"

lemma set_insert: "set_tree(insert a t) = Set.insert a (set_tree t)"
apply(cases t)
 apply simp
using set_splay[of a t]
by(simp split: tree.split) fastforce

lemma bst_insert: "bst t ⟹ bst(insert a t)"
apply(cases t)
 apply simp
using bst_splay[of t a] splay_bstL[of t a] splay_bstR[of t a]
by(auto simp: ball_Un split: tree.split)


subsubsection "Verification of ‹splay_max›"

lemma set_splay_max: "set_tree(splay_max t) = set_tree t"
apply(induction t rule: splay_max.induct)
   apply(simp)
  apply(simp)
apply(force split: tree.split)
done

lemma bst_splay_max: "bst t ⟹ bst (splay_max t)"
proof(induction t rule: splay_max.induct)
  case (3 l b rl c rr)
  { fix rrl' d' rrr'
    have "splay_max rr = Node rrl' d' rrr'
       ⟹ ∀x ∈ set_tree(Node rrl' d' rrr'). c &lt; x" 
      using "3.prems" set_splay_max[of rr]
      by (clarsimp split: tree.split simp: ball_Un)
  }
  with 3 show ?case by (fastforce split: tree.split simp: ball_Un)
qed auto

lemma splay_max_Leaf: "splay_max t = Node l a r ⟹ r = Leaf"
by(induction t arbitrary: l rule: splay_max.induct)
  (auto split: tree.splits if_splits)

text‹For sanity purposes only:›

lemma splay_max_eq_splay:
  "bst t ⟹ ∀x ∈ set_tree t. x ≤ a ⟹ splay_max t = splay a t"
proof(induction a t rule: splay.induct)
  case (2 a l r)
  show ?case
  proof (cases r)
    case Leaf with 2 show ?thesis by simp
  next
    case Node with 2 show ?thesis by(auto)
  qed
qed (auto simp: neq_Leaf_iff)

lemma splay_max_eq_splay_ex: assumes "bst t" shows "∃a. splay_max t = splay a t"
proof(cases t)
  case Leaf thus ?thesis by simp
next
  case Node
  hence "splay_max t = splay (Max(set_tree t)) t"
    using assms by (auto simp: splay_max_eq_splay)
  thus ?thesis by auto
qed


subsubsection "Verification of @{const delete}"

lemma set_delete: assumes "bst t"
shows "set_tree (delete a t) = set_tree t - {a}"
proof(cases t)
  case Leaf thus ?thesis by(simp add: delete_def)
next
  case (Node l x r)
  obtain l' x' r' where sp[simp]: "splay a (Node l x r) = Node l' x' r'"
    by (metis neq_Leaf_iff splay_Leaf_iff)
  show ?thesis
  proof cases
    assume [simp]: "x' = a"
    show ?thesis
    proof cases
      assume "l' = Leaf"
      thus ?thesis
        using Node assms set_splay[of a "Node l x r"] bst_splay[of "Node l x r" a]
        by(simp add: delete_def split: tree.split prod.split)(fastforce)
    next
      assume "l' ≠ Leaf"
      moreover then obtain l'' m r'' where "splay_max l' = Node l'' m r''"
        using splay_max_Leaf_iff tree.exhaust by blast
      moreover have "a ∉ set_tree l'"
        by (metis (no_types) Node assms less_irrefl sp splay_bstL)
      ultimately show ?thesis
        using Node assms set_splay[of a "Node l x r"] bst_splay[of "Node l x r" a]
          splay_max_Leaf[of l' l'' m r''] set_splay_max[of l']
        by(clarsimp simp: delete_def split: tree.split) auto
    qed
  next
    assume "x' ≠ a"
    thus ?thesis using Node assms set_splay[of a "Node l x r"] splay_to_root[OF _ sp]
      by (simp add: delete_def)
  qed
qed

lemma bst_delete: assumes "bst t" shows "bst (delete a t)"
proof(cases t)
  case Leaf thus ?thesis by(simp add: delete_def)
next
  case (Node l x r)
  obtain l' x' r' where sp[simp]: "splay a (Node l x r) = Node l' x' r'"
    by (metis neq_Leaf_iff splay_Leaf_iff)
  show ?thesis
  proof cases
    assume [simp]: "x' = a"
    show ?thesis
    proof cases
      assume "l' = Leaf"
      thus ?thesis using Node assms bst_splay[of "Node l x r" a]
        by(simp add: delete_def split: tree.split prod.split)
    next
      assume "l' ≠ Leaf"
      thus ?thesis
        using Node assms set_splay[of a "Node l x r"] bst_splay[of "Node l x r" a]
          bst_splay_max[of l'] set_splay_max[of l']
        by(clarsimp simp: delete_def split: tree.split)
          (metis (no_types) insertI1 less_trans)
    qed
  next
    assume "x' ≠ a"
    thus ?thesis using Node assms bst_splay[of "Node l x r" a]
      by(auto simp: delete_def split: tree.split prod.split)
  qed
qed
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Splay_Map">
<div class="head">
<h1>Theory Splay_Map</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Splay Tree Implementation of Maps"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Splay_Map
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Splay_Tree.html">Splay_Tree</a>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Map_Specs.html">HOL-Data_Structures.Map_Specs</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">splay</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Node Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> Node Leaf <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">≠</span> Leaf <span class="main">⟹</span>
 <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1">of</span> Node <span class="bound">t11</span> <span class="bound">y</span> <span class="bound">t12</span> <span class="main">⇒</span> Node <span class="bound">t11</span> <span class="bound">y</span> <span class="main">(</span>Node <span class="bound">t12</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≠</span> Leaf <span class="main">⟹</span>
 <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">of</span> Node <span class="bound">t21</span> <span class="bound">y</span> <span class="bound">t22</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t21</span><span class="main">)</span> <span class="bound">y</span> <span class="main">(</span>Node <span class="bound">t22</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf<span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span>  <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≠</span> Leaf <span class="main">⟹</span>
 <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">of</span> Node <span class="bound">t21</span> <span class="bound">y</span> <span class="bound">t22</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t21</span><span class="main">)</span> <span class="bound">y</span> <span class="main">(</span>Node <span class="bound">t22</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> Leaf<span class="main">)</span><span class="main">)</span> <span class="main">=</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"fst <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> fst <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="main">≠</span> Leaf <span class="main">⟹</span>
 <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">splay</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="keyword1">of</span> Node <span class="bound">t31</span> <span class="bound">y</span> <span class="bound">t32</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">t31</span><span class="main">)</span> <span class="bound">y</span> <span class="bound">t32</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="comment1">(* 1 subgoal *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> neq_Leaf_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> tree.exhaust surj_pair less_linear<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">splay</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> splay_code<span class="main">:</span> <span class="quoted"><span class="quoted">"splay <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>linorder<span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span> Leaf <span class="main">⇒</span> Leaf <span class="main">|</span>
  Node <span class="bound">al</span> <span class="bound">a</span> <span class="bound">ar</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span> <span class="keyword1">of</span>
    EQ <span class="main">⇒</span> <span class="free">t</span> <span class="main">|</span>
    LT <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">al</span> <span class="keyword1">of</span>
      Leaf <span class="main">⇒</span> <span class="free">t</span> <span class="main">|</span>
      Node <span class="bound">bl</span> <span class="bound">b</span> <span class="bound">br</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="main">(</span>fst <span class="bound">b</span><span class="main">)</span> <span class="keyword1">of</span>
        EQ <span class="main">⇒</span> Node <span class="bound">bl</span> <span class="bound">b</span> <span class="main">(</span>Node <span class="bound">br</span> <span class="bound">a</span> <span class="bound">ar</span><span class="main">)</span> <span class="main">|</span>
        LT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">bl</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="bound">bl</span> <span class="bound">b</span> <span class="main">(</span>Node <span class="bound">br</span> <span class="bound">a</span> <span class="bound">ar</span><span class="main">)</span>
              <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free">x</span> <span class="bound">bl</span> <span class="keyword1">of</span>
                Node <span class="bound">bll</span> <span class="bound">y</span> <span class="bound">blr</span> <span class="main">⇒</span> Node <span class="bound">bll</span> <span class="bound">y</span> <span class="main">(</span>Node <span class="bound">blr</span> <span class="bound">b</span> <span class="main">(</span>Node <span class="bound">br</span> <span class="bound">a</span> <span class="bound">ar</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
        GT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">br</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="bound">bl</span> <span class="bound">b</span> <span class="main">(</span>Node <span class="bound">br</span> <span class="bound">a</span> <span class="bound">ar</span><span class="main">)</span>
              <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free">x</span> <span class="bound">br</span> <span class="keyword1">of</span>
                Node <span class="bound">brl</span> <span class="bound">y</span> <span class="bound">brr</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="bound">bl</span> <span class="bound">b</span> <span class="bound">brl</span><span class="main">)</span> <span class="bound">y</span> <span class="main">(</span>Node <span class="bound">brr</span> <span class="bound">a</span> <span class="bound">ar</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
    GT <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ar</span> <span class="keyword1">of</span>
      Leaf <span class="main">⇒</span> <span class="free">t</span> <span class="main">|</span>
      Node <span class="bound">bl</span> <span class="bound">b</span> <span class="bound">br</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="main">(</span>fst <span class="bound">b</span><span class="main">)</span> <span class="keyword1">of</span>
        EQ <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="bound">al</span> <span class="bound">a</span> <span class="bound">bl</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">br</span> <span class="main">|</span>
        LT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">bl</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="bound">al</span> <span class="bound">a</span> <span class="bound">bl</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">br</span>
              <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free">x</span> <span class="bound">bl</span> <span class="keyword1">of</span>
                Node <span class="bound">bll</span> <span class="bound">y</span> <span class="bound">blr</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="bound">al</span> <span class="bound">a</span> <span class="bound">bll</span><span class="main">)</span> <span class="bound">y</span> <span class="main">(</span>Node <span class="bound">blr</span> <span class="bound">b</span> <span class="bound">br</span><span class="main">)</span> <span class="main">|</span>
        GT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">br</span><span class="main">=</span>Leaf <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="bound">al</span> <span class="bound">a</span> <span class="bound">bl</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">br</span>
              <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free">x</span> <span class="bound">br</span> <span class="keyword1">of</span>
                Node <span class="bound">bll</span> <span class="bound">y</span> <span class="bound">blr</span> <span class="main">⇒</span> Node <span class="main">(</span>Node <span class="main">(</span>Node <span class="bound">al</span> <span class="bound">a</span> <span class="bound">bl</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">bll</span><span class="main">)</span> <span class="bound">y</span> <span class="bound">blr</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span>tree <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Leaf <span class="main">⇒</span> None <span class="main">|</span> Node <span class="main"><span class="bound">_</span></span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="bound">a</span> <span class="keyword1">then</span> Some <span class="bound">b</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> insert

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node Leaf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> Leaf
  <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="bound">a</span> <span class="keyword1">then</span> Node <span class="bound">l</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="bound">r</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> fst <span class="bound">a</span> <span class="keyword1">then</span> Node <span class="bound">l</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>Node Leaf <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span> <span class="keyword1">else</span> Node <span class="main">(</span>Node <span class="bound">l</span> <span class="bound">a</span> Leaf<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'b</span><span class="main">)</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Leaf
  <span class="keyword1">else</span> <span class="keyword1">case</span> splay <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span> <span class="main">⇒</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="bound">a</span>
    <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="bound">r</span> <span class="keyword1">else</span> <span class="keyword1">case</span> splay_max <span class="bound">l</span> <span class="keyword1">of</span> Node <span class="bound">l'</span> <span class="bound">m</span> <span class="bound">r'</span> <span class="main">⇒</span> Node <span class="bound">l'</span> <span class="bound">m</span> <span class="bound">r</span>
    <span class="keyword1">else</span> Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Functional Correctness Proofs"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splay_Leaf_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>splay <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Leaf<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">=</span> Leaf<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Proofs for lookup"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splay_map_of_inorder<span class="main">:</span>
  <span class="quoted"><span class="quoted">"splay <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">a</span> <span class="free">r</span> <span class="main">⟹</span> sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
   map_of <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> fst <span class="free">a</span> <span class="keyword1">then</span> Some<span class="main">(</span>snd <span class="free">a</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_of_simps splay_Leaf_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> lookup <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> map_of <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_def splay_Leaf_iff splay_map_of_inorder <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Proofs for update"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_splay<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder<span class="main">(</span>splay <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Leaf_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_splay<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> splay <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">a</span> <span class="free">r</span> <span class="main">⟹</span>
  sorted<span class="main">(</span>map fst <span class="main">(</span>inorder <span class="free">l</span><span class="main">)</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> map fst <span class="main">(</span>inorder <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inorder_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_lems sorted_Cons_le sorted_snoc_le splay_Leaf_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_update_splay<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder<span class="main">(</span>update <span class="free">x</span> <span class="free">y</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> upd_list <span class="free">x</span> <span class="free">y</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> inorder_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> sorted_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upd_list_simps upd_list_Cons upd_list_snoc neq_Leaf_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Proofs for delete"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_splay_maxD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"splay_max <span class="free">t</span> <span class="main">=</span> Node <span class="free">l</span> <span class="free">a</span> <span class="free">r</span> <span class="main">⟹</span> sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
  inorder <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">=</span> inorder <span class="free">t</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> Leaf"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> splay_max.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_lems <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_delete_splay<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder<span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> inorder_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> sorted_splay<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> del_list_simps del_list_sorted_app delete_def del_list_notin_Cons inorder_splay_maxD
  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Overall Correctness"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Map_by_Ordered
<span class="keyword2"><span class="keyword">where</span></span> empty <span class="main">=</span> <span class="quoted">empty</span> <span class="keyword2"><span class="keyword">and</span></span> lookup <span class="main">=</span> <span class="quoted">lookup</span> <span class="keyword2"><span class="keyword">and</span></span> update <span class="main">=</span> <span class="quoted">update</span>
<span class="keyword2"><span class="keyword">and</span></span> delete <span class="main">=</span> <span class="quoted">delete</span> <span class="keyword2"><span class="keyword">and</span></span> inorder <span class="main">=</span> <span class="quoted">inorder</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inorder_update_splay <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> update.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inorder_delete_splay<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> empty_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Splay_Heap">
<div class="head">
<h1>Theory Splay_Heap</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Splay Heap"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Splay_Heap
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Tree_Multiset.html">HOL-Library.Tree_Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Splay heaps were invented by Okasaki~\cite{Okasaki}. They represent
priority queues by splay trees, not by heaps!›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">get_min</span><span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">else</span> <span class="free">get_min</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">*</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">partition</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> Leaf <span class="main">=</span> <span class="main">(</span>Leaf<span class="main">,</span>Leaf<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">partition</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span>
     <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span> <span class="keyword1">of</span>
       Leaf <span class="main">⇒</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">,</span> Leaf<span class="main">)</span> <span class="main">|</span>
       Node <span class="bound">bl</span> <span class="bound">b</span> <span class="bound">br</span> <span class="main">⇒</span>
         <span class="keyword1">if</span> <span class="bound">b</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
         <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">pl</span><span class="main">,</span><span class="bound">pr</span><span class="main">)</span> <span class="main">=</span> <span class="free">partition</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">br</span> <span class="keyword1">in</span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">bl</span><span class="main">)</span> <span class="bound">b</span> <span class="bound">pl</span><span class="main">,</span> <span class="bound">pr</span><span class="main">)</span>
         <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">pl</span><span class="main">,</span><span class="bound">pr</span><span class="main">)</span> <span class="main">=</span> <span class="free">partition</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">bl</span> <span class="keyword1">in</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">pl</span><span class="main">,</span> Node <span class="bound">pr</span> <span class="bound">b</span> <span class="bound">br</span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="keyword1">of</span>
       Leaf <span class="main">⇒</span> <span class="main">(</span>Leaf<span class="main">,</span> Node <span class="free"><span class="bound"><span class="entity">al</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span> <span class="main">|</span>
       Node <span class="bound">bl</span> <span class="bound">b</span> <span class="bound">br</span> <span class="main">⇒</span>
         <span class="keyword1">if</span> <span class="bound">b</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
         <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">pl</span><span class="main">,</span><span class="bound">pr</span><span class="main">)</span> <span class="main">=</span> <span class="free">partition</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">br</span> <span class="keyword1">in</span> <span class="main">(</span>Node <span class="bound">bl</span> <span class="bound">b</span> <span class="bound">pl</span><span class="main">,</span> Node <span class="bound">pr</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span>
         <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">pl</span><span class="main">,</span><span class="bound">pr</span><span class="main">)</span> <span class="main">=</span> <span class="free">partition</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">bl</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">pl</span><span class="main">,</span> Node <span class="bound">pr</span> <span class="bound">b</span> <span class="main">(</span>Node <span class="bound">br</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">ar</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">=</span> partition <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">in</span> Node <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">del_min</span> Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">del_min</span> <span class="main">(</span>Node Leaf <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">del_min</span> <span class="main">(</span>Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">lr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">lr</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> Node <span class="main">(</span><span class="free">del_min</span> <span class="free"><span class="bound"><span class="entity">ll</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">lr</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> get_min_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> get_min <span class="free">h</span> <span class="main">∈</span> set_tree <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> get_min_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bst_wrt <span class="main">(≤)</span> <span class="free">h</span><span class="main">;</span> <span class="free">h</span> <span class="main">≠</span> Leaf <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_tree <span class="free">h</span><span class="main">.</span> get_min <span class="free">h</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> get_min_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> get_min_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> size_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"partition <span class="free">p</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">=</span> size <span class="free">l'</span> <span class="main">+</span> size <span class="free">r'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quoted"><span class="free">r'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> partition.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits tree.splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bst_wrt <span class="main">(≤)</span> <span class="free">t</span><span class="main">;</span> partition <span class="free">p</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span> <span class="main">⟧</span>
 <span class="main">⟹</span> mset_tree <span class="free">t</span> <span class="main">=</span> mset_tree <span class="free">l'</span> <span class="main">+</span> mset_tree <span class="free">r'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quoted"><span class="free">r'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> partition.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">p</span> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">rl</span> <span class="skolem">b</span> <span class="skolem">rr</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="quoted">"2.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="quoted">"2.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ll</span> <span class="skolem">b</span> <span class="skolem">lr</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="quoted">"2.IH"</span><span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="quoted">"2.IH"</span><span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bst_wrt <span class="main">(≤)</span> <span class="free">t</span><span class="main">;</span> partition <span class="free">p</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span> <span class="main">⟧</span>
 <span class="main">⟹</span> set_tree <span class="free">t</span> <span class="main">=</span> set_tree <span class="free">l'</span> <span class="main">∪</span> set_tree <span class="free">r'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_partition set_mset_tree set_mset_union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bst_partition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"partition <span class="free">p</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">r'</span><span class="main">)</span> <span class="main">⟹</span> bst_wrt <span class="main">(≤)</span> <span class="free">t</span> <span class="main">⟹</span> bst_wrt <span class="main">(≤)</span> <span class="main">(</span>Node <span class="free">l'</span> <span class="free">p</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l'</span></span> <span class="quoted"><span class="free">r'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> partition.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">p</span> <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">rl</span> <span class="skolem">b</span> <span class="skolem">rr</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Node <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="quoted">"2.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">]</span> set_partition<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rr</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Node <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="quoted">"2.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">]</span> set_partition<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rl</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ll</span> <span class="skolem">b</span> <span class="skolem">lr</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Node <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="quoted">"2.IH"</span><span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">]</span> set_partition<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">lr</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Node <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted">"2.prems"</span> <span class="quoted">"2.IH"</span><span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Node<span class="main">]</span> set_partition<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ll</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_del_min<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size<span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span> <span class="main">=</span> size <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_min.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Leaf_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_tree <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span> <span class="main">=</span> mset_tree <span class="free">h</span> <span class="main">-</span> <span class="main">{#</span> get_min <span class="free">h</span> <span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_min.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">ll</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ll</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ll</span> <span class="main">≠</span> Leaf"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"get_min <span class="skolem">ll</span> <span class="main">∈#</span> mset_tree <span class="skolem">ll</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_min_in<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"mset_tree <span class="skolem">ll</span> <span class="main">=</span> add_mset <span class="main">(</span>get_min <span class="skolem">ll</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> multi_member_split<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bst_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"bst_wrt <span class="main">(≤)</span> <span class="free">t</span> <span class="main">⟹</span> bst_wrt <span class="main">(≤)</span> <span class="main">(</span>del_min <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_min.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Multiset.diff_subset_eq_self subsetD set_mset_mono set_mset_tree mset_del_min<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>