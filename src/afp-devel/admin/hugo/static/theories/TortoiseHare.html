<div id="Basis">
<div class="head">
<h1>Theory Basis</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Basis
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ Point-free notation ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We adopt point-free notation for our assertions over program states.

›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_K</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_not</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>¬</b></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>¬</b></span></span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∧</b></span>"</span> 35<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>∧</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_implies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⟶</b></span>"</span> 25<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>⟶</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>=</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>=</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_member</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∈</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>∈</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_neq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>≠</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≠</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_If</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1"><span class="hidden">❙</span><b>i</b>f</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1"><span class="hidden">❙</span><b>t</b>hen</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1"><span class="hidden">❙</span><b>e</b>lse</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>i</b>f</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>t</b>hen</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>e</b>lse</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>&lt;</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>ord<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>≤</b></span>"</span> 40<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>plus<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>+</b></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>+</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_minus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>minus<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>-</b></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>-</b></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">fun_fanout</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⨝</b></span>"</span> 35<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free"><span class="hidden">❙</span><b>⨝</b></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∀</b></span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>∀</b></span></span><span class="bound">x</span><span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span>
  <span class="entity">pred_ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>∃</b></span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>∃</b></span></span><span class="bound">x</span><span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ ``Monoidal'' Hoare logic ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

In the absence of a general-purpose development of Hoare Logic for
total correctness in Isabelle/HOL\footnote{At the time of writing the
distribution contains several for partial correctness, and one for
total correctness over a language with restricted expressions.  SIMPL
(<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "DBLP:journals/afp/Schirmer08"<span class="antiquote"><span class="antiquote">}</span></span></span></span>) is overkill for our present
purposes.}, we adopt the following syntactic contrivance that eases
making multiple assertions about function results. ``Programs''
consist of the state-transformer semantics of statements.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span><span class="keyword3">/ </span>_<span class="keyword3">/ </span><span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> <span class="main">(</span>input<span class="main">)</span> id <span class="main">(</span><span class="quoted">"<span class="keyword1">SKIP</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> fcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;;</span>"</span> 60<span class="main">)</span>

<span class="keyword1"><span class="command">named_theorems</span></span> wp_intro <span class="quoted">"weakest precondition intro rules"</span>

<span class="keyword1" id="Basis-seqI"><span class="command">lemma</span></span> seqI<span class="main">[</span><span class="operator">wp_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span> <span class="free">d</span> <span class="main">⦃</span><span class="free">R</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">;;</span> <span class="free">d</span> <span class="main">⦃</span><span class="free">R</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1" id="Basis-iteI"><span class="command">lemma</span></span> iteI<span class="main">[</span><span class="operator">wp_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P'</span><span class="main">⦄</span> <span class="free">x</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P''</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="keyword1"><span class="hidden">❙</span><b>i</b>f</span> <span class="free">b</span> <span class="keyword1"><span class="hidden">❙</span><b>t</b>hen</span> <span class="free">P'</span> <span class="keyword1"><span class="hidden">❙</span><b>e</b>lse</span> <span class="free">P''</span><span class="main">⦄</span> <span class="keyword1"><span class="hidden">❙</span><b>i</b>f</span> <span class="free">b</span> <span class="keyword1"><span class="hidden">❙</span><b>t</b>hen</span> <span class="free">x</span> <span class="keyword1"><span class="hidden">❙</span><b>e</b>lse</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1" id="Basis-assignI"><span class="command">lemma</span></span> assignI<span class="main">[</span><span class="operator">wp_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">Q</span> <span class="main">∘</span> <span class="free">f</span><span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1" id="Basis-whileI"><span class="command">lemma</span></span> whileI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">I'</span><span class="main">⦄</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">I</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="free">I'</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">I</span> <span class="bound">s</span><span class="main">;</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">I</span><span class="main">⦄</span> while <span class="free">b</span> <span class="free">c</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> while_rule valid_def<span class="main">)</span>

<span class="keyword1" id="Basis-hoare_pre"><span class="command">lemma</span></span> hoare_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">R</span><span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">f</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1" id="Basis-hoare_post_imp"><span class="command">lemma</span></span> hoare_post_imp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">a</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">a</span> <span class="main">⦃</span><span class="free">R</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Note that the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] assignI<span class="antiquote"><span class="antiquote">}</span></span></span></span> rule applies to all state
transformers, and therefore the order in which we attempt to use the
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">wp_intro</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> rules matters.

›</span></span>


<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ Properties of iterated functions on finite sets ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We begin by fixing the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under
consideration in a locale, and establishing Knuth's properties.

The sequence is modelled as a function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>seq :: nat
⇒ 'a›</span></span></span></span> in the obvious way.

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> fx0 <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">seq'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">seq'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">seq</span> <span class="main">≡</span> seq' <span class="free">x0</span>"</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> fx0.seq'_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1" id="Basis-seq'_simps"><span class="command">lemma</span></span> seq'_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"seq' <span class="free">x</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"seq' <span class="free">x</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>seq' <span class="free">x</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"seq' <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="free">i</span> <span class="main">∈</span> range <span class="main">(</span>seq' <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> range_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Suc <span class="free">i</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> seq'_def funpow_swap1<span class="main">)</span>

<span class="keyword1" id="Basis-seq_inj"><span class="command">lemma</span></span> seq_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> seq' <span class="free">x</span> <span class="free">i</span> <span class="main">=</span> seq' <span class="free">x</span> <span class="free">j</span><span class="main">;</span> <span class="free">p</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="free">n</span><span class="main">;</span> <span class="free">q</span> <span class="main">=</span> <span class="free">j</span> <span class="main">+</span> <span class="free">n</span> <span class="main">⟧</span> <span class="main">⟹</span> seq' <span class="free">x</span> <span class="free">p</span> <span class="main">=</span> seq' <span class="free">x</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The parameters <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lambda›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mu›</span></span></span></span> must exist by the
pigeonhole principle.

›</span></span>

<span class="keyword1" id="Basis-seq'_not_inj_on_card_UNIV"><span class="command">lemma</span></span> seq'_not_inj_on_card_UNIV<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>inj_on <span class="main">(</span>seq' <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> card <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_iff_eq_card<span class="main">)</span>
   <span class="main">(</span><span class="operator">metis</span> UNIV_I card_mono finite lessI not_less subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">properties</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">properties</span> <span class="free"><span class="bound"><span class="entity">lambda</span></span></span> <span class="free"><span class="bound"><span class="entity">mu</span></span></span> <span class="main">≡</span>
     <span class="main">0</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">lambda</span></span></span>
   <span class="main">∧</span> inj_on seq <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">mu</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">lambda</span></span></span><span class="main">}</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">mu</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> seq <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">j</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">lambda</span></span></span><span class="main">)</span> <span class="main">=</span> seq <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Basis-properties_existence"><span class="command">lemma</span></span> properties_existence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">lambda</span> <span class="free">mu</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"properties <span class="free">lambda</span> <span class="free">mu</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on seq <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">l</span><span class="main">}</span> <span class="main">∧</span> <span class="main">¬</span>inj_on seq <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="skolem">l</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_least_nat_less<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ub</span><span class="main">.</span> <span class="main">¬</span>inj_on seq <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="bound">ub</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> n<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span><span class="main">]</span>
          seq'_not_inj_on_card_UNIV
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> l <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mu</span></span> <span class="keyword2"><span class="keyword">where</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mu</span> <span class="main">≤</span> <span class="skolem">l</span> <span class="main">∧</span> seq <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> seq <span class="skolem">mu</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atLeastAtMostSuc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lambda</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lambda</span> <span class="main">=</span> <span class="skolem">l</span> <span class="main">-</span> <span class="skolem">mu</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">lambda</span><span class="main">)</span> <span class="main">=</span> seq <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mu</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> l mu <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> seq <span class="main">(</span><span class="skolem">mu</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> seq_inj<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> mu Suc F<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">lambda</span> <span class="main">-</span> <span class="skolem">mu</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lambda_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"properties <span class="skolem">lambda</span> <span class="skolem">mu</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> properties_def lambda_def atLeastLessThanSuc_atLeastAtMost<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

To ease further reasoning, we define a new locale that fixes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">lambda</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">mu</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and assume these properties hold. We then
derive further rules that are easy to apply.

›</span></span>

<span class="keyword1"><span class="command">locale</span></span> properties <span class="main">=</span> fx0 <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">lambda</span> <span class="free">mu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"properties <span class="free">lambda</span> <span class="free">mu</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Basis-properties_lambda_gt_0"><span class="command">lemma</span></span> properties_lambda_gt_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">lambda</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> properties_def<span class="main">)</span>

<span class="keyword1" id="Basis-properties_loop"><span class="command">lemma</span></span> properties_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span> <span class="main">*</span> <span class="free">lambda</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> P assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> properties_def<span class="main">)</span>

<span class="keyword1" id="Basis-properties_mod_lambda"><span class="command">lemma</span></span> properties_mod_lambda<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"seq <span class="free">i</span> <span class="main">=</span> seq <span class="main">(</span><span class="free">mu</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">mu</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">lambda</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> properties_loop<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">mu</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">lambda</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">mu</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">lambda</span>"</span></span><span class="main">]</span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Basis-properties_distinct"><span class="command">lemma</span></span> properties_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">&lt;..&lt;</span> <span class="free">lambda</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> seq <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">lambda</span> <span class="main">≠</span> <span class="skolem">i</span> <span class="keyword1">mod</span> <span class="free">lambda</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> nat_mod_eq_lemma <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">mu</span> <span class="main">≤</span> <span class="free">i</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> seq <span class="main">(</span><span class="free">mu</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span> <span class="main">-</span> <span class="free">mu</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">lambda</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"seq <span class="free">i</span> <span class="main">=</span> seq <span class="main">(</span><span class="free">mu</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">mu</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">lambda</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> properties_mod_lambda<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P <span class="quoted"><span class="quoted">‹<span class="free">mu</span> <span class="main">≤</span> <span class="free">i</span>›</span></span> assms A<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">-</span><span class="free">mu</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> properties_def inj_on_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> P assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> properties_def inj_on_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Basis-properties_distinct_contrapos"><span class="command">lemma</span></span> properties_distinct_contrapos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span> <span class="main">&lt;..&lt;</span> <span class="free">lambda</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_pp<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> properties_distinct<span class="main">)</span>

<span class="keyword1" id="Basis-properties_loops_ge_mu"><span class="command">lemma</span></span> properties_loops_ge_mu<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?thesis</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="free">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> P X assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> properties_def inj_on_eq_iff
                    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> properties_mod_lambda<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> P assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> properties_def inj_on_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="TortoiseHare">
<div class="head">
<h1>Theory TortoiseHare</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> TortoiseHare
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Basis.html">Basis</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ The Tortoise and the Hare \label{sec:th} ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> properties<span class="main">)</span> <span class="quoted"><span class="plain_text">‹

The key to the Tortoise and Hare algorithm is that any <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">nu</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"seq <span class="main"><span class="main">(</span></span><span class="free"><span class="free">nu</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">nu</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> seq <span class="free"><span class="free">nu</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must be divisible by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">lambda</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Intuitively the first <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">nu</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> steps get us into the
loop. If the second <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">nu</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> steps return us to the same value of
the sequence, then we must have gone around the loop one or more
times.

›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> properties<span class="main">)</span> lambda_dvd_nu<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">lambda</span> <span class="keyword1">dvd</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> properties_loops_ge_mu<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">i</span> <span class="keyword1">mod</span> <span class="free">lambda</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> properties_loop<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="free">i</span> <span class="keyword1">mod</span> <span class="free">lambda</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="keyword1">div</span> <span class="free">lambda</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> properties_distinct_contrapos<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">meson</span> dvd_eq_mod_eq_0 mod_less_divisor not_less properties_lambda_gt_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> properties<span class="main">)</span> <span class="quoted"><span class="plain_text">‹

The program is split into three loops; we find <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">nu</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">mu</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">lambda</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in that order.

›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹ Finding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nu›</span></span></span></span> ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The state space of the program tracks each of the variables we wish to
discover, and the current positions of the Tortoise and Hare.

›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> state <span class="main">=</span>
  nu <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>ν›</span></span>›</span>
  m <span class="main">::</span> <span class="quoted">nat</span>  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>μ›</span></span>›</span>
  l <span class="main">::</span> <span class="quoted">nat</span>  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>λ›</span></span>›</span>
  hare <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  tortoise <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> properties
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The Hare proceeds at twice the speed of the Tortoise. The program
tracks how many steps the Tortoise has taken in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nu"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fx0<span class="main">)</span> <span class="entity">find_nu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_nu</span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> nu <span class="main">:=</span> <span class="main">1</span><span class="main">,</span> tortoise <span class="main">:=</span> <span class="free">f</span><span class="main">(</span><span class="free">x0</span><span class="main">)</span><span class="main">,</span> hare <span class="main">:=</span> <span class="free">f</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x0</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">;;</span>
    while <span class="main">(</span>hare <span class="main"><span class="hidden">❙</span><b>≠</b></span> tortoise<span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> nu <span class="main">:=</span> nu <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> tortoise <span class="main">:=</span> <span class="free">f</span><span class="main">(</span>tortoise <span class="bound">s</span><span class="main">)</span><span class="main">,</span> hare <span class="main">:=</span> <span class="free">f</span><span class="main">(</span><span class="free">f</span><span class="main">(</span>hare <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

If this program terminates, we expect <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>seq ∘ (nu
<span class="hidden">❙</span><b>+</b> nu) <span class="hidden">❙</span><b>=</b> seq ∘ nu›</span></span></span></span> to hold in the final state.

The simplest approach to showing termination is to define a suitable
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nu›</span></span></span></span> in terms of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lambda›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mu›</span></span></span></span>, which also
gives us an upper bound on the number of calls to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nu_witness</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nu_witness</span> <span class="main">≡</span> <span class="free">mu</span> <span class="main">+</span> <span class="free">lambda</span> <span class="main">-</span> <span class="free">mu</span> <span class="keyword1">mod</span> <span class="free">lambda</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This constant has the following useful properties:

›</span></span>

<span class="keyword1" id="TortoiseHare-nu_witness_properties"><span class="command">lemma</span></span> nu_witness_properties<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">&lt;</span> nu_witness"</span></span>
  <span class="quoted"><span class="quoted">"nu_witness <span class="main">≤</span> <span class="free">lambda</span> <span class="main">+</span> <span class="free">mu</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lambda</span> <span class="keyword1">dvd</span> nu_witness"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> nu_witness <span class="main">=</span> <span class="free">lambda</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> nu_witness_def
<span class="keyword1"><span class="command">using</span></span> properties_lambda_gt_0
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_diff_conv <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> minus_mod_eq_div_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> dvd_def mod_add_self2 mult.commute<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

These demonstrate that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nu_witness"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has the key property:

›</span></span>

<span class="keyword1" id="TortoiseHare-nu_witness"><span class="command">lemma</span></span> nu_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span>nu_witness <span class="main">+</span> nu_witness<span class="main">)</span> <span class="main">=</span> seq nu_witness"</span></span>
<span class="keyword1"><span class="command">using</span></span> nu_witness_properties properties_loop
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dvd_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Termination amounts to showing that the Tortoise gets closer to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"nu_witness"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on each iteration of the loop.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_nu_measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_nu_measure</span> <span class="main">≡</span> measure <span class="main">(</span><span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> nu_witness <span class="main">-</span> <span class="bound">ν</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TortoiseHare-find_nu_measure_wellfounded"><span class="command">lemma</span></span> find_nu_measure_wellfounded<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf find_nu_measure"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nu_measure_def<span class="main">)</span>

<span class="keyword1" id="TortoiseHare-find_nu_measure_decreases"><span class="command">lemma</span></span> find_nu_measure_decreases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">ν</span> <span class="main">+</span> <span class="free">ν</span><span class="main">)</span> <span class="main">≠</span> seq <span class="free">ν</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">≤</span> nu_witness"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">ν</span><span class="main">,</span> <span class="free">ν</span><span class="main">)</span> <span class="main">∈</span> find_nu_measure"</span></span>
<span class="keyword1"><span class="command">using</span></span> nu_witness_properties nu_witness assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_nu_measure_def le_eq_less_or_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The remainder of the Hoare proof is straightforward.

›</span></span>

<span class="keyword1" id="TortoiseHare-find_nu"><span class="command">lemma</span></span> find_nu<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⦄</span> find_nu <span class="main">⦃</span>nu <span class="main"><span class="hidden">❙</span><b>∈</b></span> <span class="main">⟨</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free">lambda</span> <span class="main">+</span> <span class="free">mu</span><span class="main">}</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> seq <span class="main">∘</span> <span class="main">(</span>nu <span class="main"><span class="hidden">❙</span><b>+</b></span> nu<span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>=</b></span> seq <span class="main">∘</span> nu <span class="main"><span class="hidden">❙</span><b>∧</b></span> hare <span class="main"><span class="hidden">❙</span><b>=</b></span> seq <span class="main">∘</span> nu<span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nu_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> hoare_pre<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"nu <span class="main"><span class="main"><span class="hidden">❙</span><b>∈</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">&lt;..</span></span>nu_witness<span class="main"><span class="main">}</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main"><span class="hidden">❙</span><b>∀</b></span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⟨</span></span><span class="main"><span class="main">0</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>&lt;</b></span></span> nu <span class="main"><span class="main"><span class="hidden">❙</span><b>⟶</b></span></span> <span class="main"><span class="main">⟨</span></span>seq <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">i</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≠</span></span> seq <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">⟩</span></span><span class="main"><span class="main">)</span></span>
                            <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> tortoise <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> nu <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> hare <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> <span class="main"><span class="main">(</span></span>nu <span class="main"><span class="main"><span class="hidden">❙</span><b>+</b></span></span> nu<span class="main"><span class="main">)</span></span>"</span></span></span>
                       <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"inv_image find_nu_measure nu"</span></span></span><span class="main"><span class="main">]</span></span>
             <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> nu_witness_properties nu_witness
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nu_measure_wellfounded<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nu_measure_decreases<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> nu_witness_properties
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹ Side observations ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We can also show termination ala \citet{Filliatre:2007}.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_nu_measures</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_nu_measures</span> <span class="main">≡</span>
    measures <span class="main">[</span><span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> <span class="free">mu</span> <span class="main">-</span> <span class="bound">ν</span><span class="main">,</span> <span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> <span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> seq <span class="main">(</span><span class="bound">ν</span> <span class="main">+</span> <span class="bound">ν</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> seq <span class="bound">ν</span><span class="main">]</span>"</span></span>

<span class="keyword1" id="TortoiseHare-find_nu_measures_wellfounded"><span class="command">lemma</span></span> find_nu_measures_wellfounded<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf find_nu_measures"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nu_measures_def<span class="main">)</span>

<span class="keyword1" id="TortoiseHare-find_nu_measures_existence"><span class="command">lemma</span></span> find_nu_measures_existence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ν<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> <span class="free">ν</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> seq <span class="main">(</span><span class="free">ν</span> <span class="main">+</span> <span class="free">ν</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">ν</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">ν</span> <span class="main">+</span> <span class="free">ν</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">ν</span>"</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> False
 <span class="keyword1"><span class="command">from</span></span> properties_lambda_gt_0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ν</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">*</span> <span class="free">lambda</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI mult.right_neutral mult_le_mono order_refl<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> ν k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">ν</span> <span class="main">+</span> <span class="free">ν</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="free">lambda</span> <span class="main">-</span> <span class="free">ν</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> seq <span class="main">(</span><span class="free">mu</span> <span class="main">+</span> <span class="main">(</span><span class="free">ν</span> <span class="main">-</span> <span class="free">mu</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> <span class="free">lambda</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ν properties_loop <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> seq <span class="free">ν</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="TortoiseHare-find_nu_measures_decreases"><span class="command">lemma</span></span> find_nu_measures_decreases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ν<span class="main">:</span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">ν</span> <span class="main">+</span> <span class="free">ν</span><span class="main">)</span> <span class="main">≠</span> seq <span class="free">ν</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">ν</span><span class="main">,</span> <span class="free">ν</span><span class="main">)</span> <span class="main">∈</span> find_nu_measures"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> <span class="free">ν</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> Suc <span class="free">ν</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> seq <span class="main">(</span>Suc <span class="free">ν</span> <span class="main">+</span> Suc <span class="free">ν</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> seq <span class="main">(</span>Suc <span class="free">ν</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> seq <span class="main">(</span><span class="free">ν</span> <span class="main">+</span> <span class="free">ν</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">ν</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> LeastI2_wellorder_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> find_nu_measures_existence<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">mu</span> <span class="main">≤</span> Suc <span class="free">ν</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> LeastI2_wellorder_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> find_nu_measures_existence<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">mu</span> <span class="main">≤</span> <span class="free">ν</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span>Suc <span class="free">ν</span> <span class="main">+</span> Suc <span class="free">ν</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> seq <span class="main">(</span>Suc <span class="free">ν</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> seq <span class="main">(</span>Suc <span class="free">ν</span> <span class="main">+</span> Suc <span class="free">ν</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> seq <span class="main">(</span>Suc <span class="free">ν</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">ν</span> <span class="main">+</span> <span class="free">ν</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">ν</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ν <span class="quoted"><span class="quoted">‹<span class="free">mu</span> <span class="main">≤</span> <span class="free">ν</span>›</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span>Suc <span class="free">ν</span> <span class="main">+</span> Suc <span class="free">ν</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> seq <span class="main">(</span>Suc <span class="free">ν</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> seq_inj<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">y</span>›</span></span> spec<span class="main">[</span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> y <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> True ν <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nu_measures_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_nu_measures_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted">"find_nu_Filliâtre"</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⦄</span> find_nu <span class="main">⦃</span><span class="main">⟨</span><span class="main">0</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>&lt;</b></span> nu <span class="main"><span class="hidden">❙</span><b>∧</b></span> seq <span class="main">∘</span> <span class="main">(</span>nu <span class="main"><span class="hidden">❙</span><b>+</b></span> nu<span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>=</b></span> seq <span class="main">∘</span> nu <span class="main"><span class="hidden">❙</span><b>∧</b></span> hare <span class="main"><span class="hidden">❙</span><b>=</b></span> seq <span class="main">∘</span> nu<span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nu_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> hoare_pre<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⟨</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>&lt;</b></span></span> nu <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> tortoise <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> nu <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> hare <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> <span class="main"><span class="main">(</span></span>nu <span class="main"><span class="main"><span class="hidden">❙</span><b>+</b></span></span> nu<span class="main"><span class="main">)</span></span>"</span></span></span>
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"inv_image find_nu_measures nu"</span></span></span><span class="main"><span class="main">]</span></span>
             <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nu_measures_wellfounded<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nu_measures_decreases<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> properties_lambda_gt_0<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

This approach does not provide an upper bound on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nu›</span></span></span></span> however.

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Harper:PiSML:2011"<span class="antiquote"><span class="antiquote">}</span></span></span></span> observes (in his \S13.5.2) that if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mu›</span></span></span></span> is zero then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nu = lambda›</span></span></span></span>.

›</span></span>

<span class="keyword1" id="TortoiseHare-Harper"><span class="command">lemma</span></span> Harper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⦄</span> find_nu <span class="main">⦃</span>nu <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">lambda</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hoare_post_imp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> find_nu<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms dvd_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lambda_dvd_nu<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹ Finding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mu›</span></span></span></span> \label{sec:th-finding-mu} ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

We recover <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mu›</span></span></span></span> from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nu›</span></span></span></span> by exploiting the fact that
lambda divides <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"nu"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: the Tortoise, reset to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and the Hare, both now moving at the same speed, will meet at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">mu</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1" id="TortoiseHare-mu_nu"><span class="command">lemma</span></span> mu_nu<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> si<span class="main">:</span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> seq <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> lambda_dvd_nu<span class="main">[</span><span class="operator">OF</span> si<span class="main">]</span> properties_loop<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dvd_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fx0<span class="main">)</span> <span class="entity">find_mu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_mu</span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> m <span class="main">:=</span> <span class="main">0</span><span class="main">,</span> tortoise <span class="main">:=</span> <span class="free">x0</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">;;</span>
    while <span class="main">(</span>hare <span class="main"><span class="hidden">❙</span><b>≠</b></span> tortoise<span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> tortoise <span class="main">:=</span> <span class="free">f</span> <span class="main">(</span>tortoise <span class="bound">s</span><span class="main">)</span><span class="main">,</span> hare <span class="main">:=</span> <span class="free">f</span> <span class="main">(</span>hare <span class="bound">s</span><span class="main">)</span><span class="main">,</span> m <span class="main">:=</span> m <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TortoiseHare-find_mu"><span class="command">lemma</span></span> find_mu<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span>nu <span class="main"><span class="hidden">❙</span><b>∈</b></span> <span class="main">⟨</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free">lambda</span> <span class="main">+</span> <span class="free">mu</span><span class="main">}</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> seq <span class="main">∘</span> <span class="main">(</span>nu <span class="main"><span class="hidden">❙</span><b>+</b></span> nu<span class="main">)</span> <span class="main"><span class="hidden">❙</span><b>=</b></span> seq <span class="main">∘</span> nu <span class="main"><span class="hidden">❙</span><b>∧</b></span> hare <span class="main"><span class="hidden">❙</span><b>=</b></span> seq <span class="main">∘</span> nu<span class="main">⦄</span>
     find_mu
   <span class="main">⦃</span>nu <span class="main"><span class="hidden">❙</span><b>∈</b></span> <span class="main">⟨</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free">lambda</span> <span class="main">+</span> <span class="free">mu</span><span class="main">}</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> tortoise <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span>seq <span class="free">mu</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> m <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">mu</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_mu_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> hoare_pre<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"nu <span class="main"><span class="main"><span class="hidden">❙</span><b>∈</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">&lt;..</span></span><span class="free"><span class="free">lambda</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">mu</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> seq <span class="main"><span class="main">∘</span></span> <span class="main"><span class="main">(</span></span>nu <span class="main"><span class="main"><span class="hidden">❙</span><b>+</b></span></span> nu<span class="main"><span class="main">)</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> nu <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> m <span class="main"><span class="main"><span class="hidden">❙</span><b>≤</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">mu</span></span><span class="main"><span class="main">⟩</span></span>
                           <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> tortoise <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> m <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> hare <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> <span class="main"><span class="main">(</span></span>m <span class="main"><span class="main"><span class="hidden">❙</span><b>+</b></span></span> nu<span class="main"><span class="main">)</span></span>"</span></span></span>
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">mu</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>-</b></span></span> m<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span>
             <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> properties_loops_ge_mu
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mu_nu <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mu_nu <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹ Finding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lambda›</span></span></span></span> ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

With the Tortoise parked at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">mu</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we find <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lambda›</span></span></span></span> by
walking the Hare around the loop.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fx0<span class="main">)</span> <span class="entity">find_lambda</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_lambda</span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> l <span class="main">:=</span> <span class="main">1</span><span class="main">,</span> hare <span class="main">:=</span> <span class="free">f</span> <span class="main">(</span>tortoise <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">;;</span>
    while <span class="main">(</span>hare <span class="main"><span class="hidden">❙</span><b>≠</b></span> tortoise<span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> hare <span class="main">:=</span> <span class="free">f</span> <span class="main">(</span>hare <span class="bound">s</span><span class="main">)</span><span class="main">,</span> l <span class="main">:=</span> l <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="TortoiseHare-find_lambda"><span class="command">lemma</span></span> find_lambda<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span>nu <span class="main"><span class="hidden">❙</span><b>∈</b></span> <span class="main">⟨</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free">lambda</span> <span class="main">+</span> <span class="free">mu</span><span class="main">}</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> tortoise <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span>seq <span class="free">mu</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> m <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">mu</span><span class="main">⟩</span><span class="main">⦄</span>
     find_lambda
   <span class="main">⦃</span>nu <span class="main"><span class="hidden">❙</span><b>∈</b></span> <span class="main">⟨</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free">lambda</span> <span class="main">+</span> <span class="free">mu</span><span class="main">}</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> l <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">lambda</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> m <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">mu</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_lambda_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> hoare_pre<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"nu <span class="main"><span class="main"><span class="hidden">❙</span><b>∈</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">&lt;..</span></span><span class="free"><span class="free">lambda</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">mu</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> l <span class="main"><span class="main"><span class="hidden">❙</span><b>∈</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">&lt;..</span></span><span class="free"><span class="free">lambda</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">⟩</span></span>
                           <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> tortoise <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> <span class="main"><span class="main">⟨</span></span>seq <span class="free"><span class="free">mu</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> hare <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">mu</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>+</b></span></span> l<span class="main"><span class="main">)</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> m <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">mu</span></span><span class="main"><span class="main">⟩</span></span>"</span></span></span>
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">lambda</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>-</b></span></span> l<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span>
             <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> properties_lambda_gt_0 properties_mod_lambda<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">+</span> <span class="free">lambda</span>"</span></span><span class="main">]</span> properties_distinct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">mu</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> properties_mod_lambda<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">+</span> <span class="free">lambda</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> properties_lambda_gt_0
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹ Top level ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The complete program is simply the steps composed in order.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fx0<span class="main">)</span> <span class="entity">tortoise_hare</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tortoise_hare</span> <span class="main">≡</span> find_nu <span class="main">;;</span> find_mu <span class="main">;;</span> find_lambda"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> tortoise_hare<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⦄</span> tortoise_hare <span class="main">⦃</span>nu <span class="main"><span class="hidden">❙</span><b>∈</b></span> <span class="main">⟨</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free">lambda</span> <span class="main">+</span> <span class="free">mu</span><span class="main">}</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> l <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">lambda</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> m <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">mu</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> tortoise_hare_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> find_nu find_mu find_lambda <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">corollary</span></span> tortoise_hare_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> fx0.tortoise_hare <span class="free">f</span> <span class="free">x</span> <span class="free">arbitrary</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fx0.properties <span class="free">f</span> <span class="free">x</span> <span class="main">(</span>l <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>m <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms properties.tortoise_hare<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?x0.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fx0.properties_existence<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?x0.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span>
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  Basis.properties_def valid_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

Isabelle can generate code from these definitions.

›</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> tortoise_hare_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fx0.tortoise_hare <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?code</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fx0.tortoise_hare_def fx0.find_nu_def fx0.find_mu_def fx0.find_lambda_def fcomp_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> fcomp_comp
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">fx0.tortoise_hare</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Brent">
<div class="head">
<h1>Theory Brent</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Brent
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Basis.html">Basis</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹ Brent's algorithm \label{sec:brent} ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Brent:1980"<span class="antiquote"><span class="antiquote">}</span></span></span></span> improved on the Tortoise and Hare algorithm and
used it to factor large primes. In practice it makes significantly
fewer calls to the function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> before detecting a loop.

We begin by defining the base-2 logarithm.

›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lg</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span> <span class="main">+</span> <span class="free">lg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Brent-lg_safe"><span class="command">lemma</span></span> lg_safe<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lg <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"lg <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"lg <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">⟹</span> lg <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> lg <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lg.simps<span class="main">)</span>

<span class="keyword1" id="Brent-lg_inv"><span class="command">lemma</span></span> lg_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">⟹</span> lg <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lg.simps Suc_lessI not_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Brent-lg_inv2"><span class="command">lemma</span></span> lg_inv2<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> lg <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> lg <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">^</span> <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lg_safe mult_2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> lg_simps <span class="main">=</span> lg_safe lg_inv lg_inv2

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹ Finding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lambda›</span></span></span></span> ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> properties<span class="main">)</span> <span class="quoted"><span class="plain_text">‹

Imagine now that the Tortoise carries an unbounded number of carrots,
which he passes to the Hare when they meet, and the Hare has a
teleporter. The Hare eats a carrot each time she waits for the
function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to execute, and initially has just one. If she
runs out of carrots before meeting the Tortoise again, she teleports
him to her position, and he gives her twice as many carrots as the
last time they met (tracked by the variable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>carrots›</span></span></span></span>). By
counting how many carrots she has eaten from when she last teleported
the Tortoise (recorded in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span>) until she finally has surplus
carrots when she meets him again, the Hare directly discovers <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="free">lambda</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> state <span class="main">=</span>
  m <span class="main">::</span> <span class="quoted">nat</span>  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>μ›</span></span>›</span>
  l <span class="main">::</span> <span class="quoted">nat</span>  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>λ›</span></span>›</span>
  carrots <span class="main">::</span> <span class="quoted">nat</span>
  hare <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  tortoise <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> properties
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fx0<span class="main">)</span> <span class="entity">find_lambda</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_lambda</span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> carrots <span class="main">:=</span> <span class="main">1</span><span class="main">,</span> l <span class="main">:=</span> <span class="main">1</span><span class="main">,</span> tortoise <span class="main">:=</span> <span class="free">x0</span><span class="main">,</span> hare <span class="main">:=</span> <span class="free">f</span> <span class="free">x0</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">;;</span>
    while <span class="main">(</span>hare <span class="main"><span class="hidden">❙</span><b>≠</b></span> tortoise<span class="main">)</span>
          <span class="main">(</span> <span class="main">(</span> <span class="keyword1"><span class="hidden">❙</span><b>i</b>f</span> carrots <span class="main"><span class="hidden">❙</span><b>=</b></span> l <span class="keyword1"><span class="hidden">❙</span><b>t</b>hen</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> tortoise <span class="main">:=</span> hare <span class="bound">s</span><span class="main">,</span> carrots <span class="main">:=</span> <span class="numeral">2</span> <span class="main">*</span> carrots <span class="bound">s</span><span class="main">,</span> l <span class="main">:=</span> <span class="main">0</span> <span class="main">⦈</span><span class="main">)</span>
                             <span class="keyword1"><span class="hidden">❙</span><b>e</b>lse</span> <span class="keyword1">SKIP</span> <span class="main">)</span> <span class="main">;;</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> hare <span class="main">:=</span> <span class="free">f</span> <span class="main">(</span>hare <span class="bound">s</span><span class="main">)</span><span class="main">,</span> l <span class="main">:=</span> l <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

The termination argument goes intuitively as follows. The Hare eats as
many carrots as it takes to teleport the Tortoise into the
loop. Afterwards she continues the teleportation dance until the
Tortoise has given her enough carrots to make it all the way around
the loop and back to him.

We can calculate the Tortoise's position as a function of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>carrots›</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">carrots_total</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">carrots_total</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span>lg <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span>"</span></span>

<span class="keyword1" id="Brent-carrots_total_simps"><span class="command">lemma</span></span> carrots_total_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"carrots_total <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"carrots_total <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">i</span> <span class="main">=</span> <span class="free">c</span> <span class="main">⟹</span> carrots_total <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">+</span> carrots_total <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> carrots_total_def lg_simps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_lambda_measures</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_lambda_measures</span> <span class="main">≡</span>
    measures <span class="main">[</span><span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="free">mu</span> <span class="main">-</span> carrots_total <span class="bound">c</span><span class="main">,</span>
              <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="free">lambda</span> <span class="main">≤</span> <span class="bound">c</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">^</span><span class="bound">i</span><span class="main">,</span>
              <span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">-</span> <span class="bound">l</span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Brent-find_lambda_measures_wellfounded"><span class="command">lemma</span></span> find_lambda_measures_wellfounded<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf find_lambda_measures"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_lambda_measures_def<span class="main">)</span>

<span class="keyword1" id="Brent-find_lambda_measures_decreases1"><span class="command">lemma</span></span> find_lambda_measures_decreases1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> carrots_total <span class="free">c</span> <span class="main">⟶</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">lambda</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"seq <span class="main">(</span>carrots_total <span class="free">c</span><span class="main">)</span> <span class="main">≠</span> seq <span class="main">(</span>carrots_total <span class="free">c</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">)</span> <span class="main">∈</span> find_lambda_measures"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> carrots_total <span class="free">c</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_lambda_measures_def carrots_total_simps mult_2 <span class="dynamic"><span class="dynamic">field_simps</span></span> diff_less_mono2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">lambda</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">lambda</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> mult_2<span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> Nat.add_0_right Suc_leI linorder_neqE_nat mult_eq_0_iff add_left_cancel not_le numeral_2_eq_2 old.nat.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> power_not_zero trans_le_add2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ex <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="free">lambda</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="free">lambda</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> LeastI2_wellorder_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> LeastI2_wellorder_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ex<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">lambda</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">y</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="free">lambda</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="free">lambda</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> True assms properties_loop<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"carrots_total <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="quoted"><span class="quoted">‹<span class="free">c</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">i</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_lambda_measures_def mult_2 carrots_total_simps <span class="dynamic"><span class="dynamic">field_simps</span></span> power_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Brent-find_lambda_measures_decreases2"><span class="command">lemma</span></span> find_lambda_measures_decreases2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">(</span>Suc <span class="free">ls</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ls</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">)</span> <span class="main">∈</span> find_lambda_measures"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_lambda_measures_def<span class="main">)</span>

<span class="keyword1" id="Brent-find_lambda"><span class="command">lemma</span></span> find_lambda<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⦄</span> find_lambda <span class="main">⦃</span>l <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">lambda</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_lambda_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> hoare_pre<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⟨</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>&lt;</b></span></span> l <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> l <span class="main"><span class="main"><span class="hidden">❙</span><b>≤</b></span></span> carrots <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">mu</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>≤</b></span></span> carrots_total <span class="main"><span class="main">∘</span></span> carrots <span class="main"><span class="main"><span class="hidden">❙</span><b>⟶</b></span></span> l <span class="main"><span class="main"><span class="hidden">❙</span><b>≤</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">lambda</span></span><span class="main"><span class="main">⟩</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main"><span class="hidden">❙</span><b>∃</b></span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> carrots <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">^</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">⟩</span></span><span class="main"><span class="main">)</span></span>
                           <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> tortoise <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> carrots_total <span class="main"><span class="main">∘</span></span> carrots <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> hare <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> <span class="main"><span class="main">(</span></span>l <span class="main"><span class="main"><span class="hidden">❙</span><b>+</b></span></span> <span class="main"><span class="main">(</span></span>carrots_total <span class="main"><span class="main">∘</span></span> carrots<span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"inv_image find_lambda_measures <span class="main"><span class="main">(</span></span>l <span class="main"><span class="main"><span class="hidden">❙</span><b>⨝</b></span></span> carrots<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span>
            <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">using</span></span> properties_lambda_gt_0
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> mult_2_right carrots_total_simps<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mult_2 power_Suc<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≤</span> carrots_total <span class="main">(</span>l <span class="improper">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"carrots_total <span class="main">(</span>l <span class="improper">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> properties_distinct_contrapos<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"carrots_total <span class="main">(</span>l <span class="improper">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> properties_loops_ge_mu<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"carrots_total <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="improper">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> properties_loop<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"carrots_total <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="improper">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> properties_loops_ge_mu<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"carrots_total <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="improper">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"l <span class="improper">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> properties_distinct_contrapos<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_lambda_measures_wellfounded<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.commute find_lambda_measures_decreases1 find_lambda_measures_decreases2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> properties_lambda_gt_0
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> carrots_total_simps exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹ Finding <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mu›</span></span></span></span> ›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹

With <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">lambda</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in hand, we can find <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mu›</span></span></span></span> using the same
approach as for the Tortoise and Hare (\S\ref{sec:th-finding-mu}),
after we first move the Hare to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">lambda</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fx0<span class="main">)</span> <span class="entity">find_mu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_mu</span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> m <span class="main">:=</span> <span class="main">0</span><span class="main">,</span> tortoise <span class="main">:=</span> <span class="free">x0</span><span class="main">,</span> hare <span class="main">:=</span> seq <span class="main">(</span>l <span class="bound">s</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">;;</span>
    while <span class="main">(</span>hare <span class="main"><span class="hidden">❙</span><b>≠</b></span> tortoise<span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">⦇</span> tortoise <span class="main">:=</span> <span class="free">f</span> <span class="main">(</span>tortoise <span class="bound">s</span><span class="main">)</span><span class="main">,</span> hare <span class="main">:=</span> <span class="free">f</span> <span class="main">(</span>hare <span class="bound">s</span><span class="main">)</span><span class="main">,</span> m <span class="main">:=</span> m <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Brent-find_mu"><span class="command">lemma</span></span> find_mu<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span>l <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">lambda</span><span class="main">⟩</span><span class="main">⦄</span> find_mu <span class="main">⦃</span>l <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">lambda</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> m <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">mu</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_mu_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> hoare_pre<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> whileI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"l <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">lambda</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> m <span class="main"><span class="main"><span class="hidden">❙</span><b>≤</b></span></span> <span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">mu</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> tortoise <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> m <span class="main"><span class="main"><span class="hidden">❙</span><b>∧</b></span></span> hare <span class="main"><span class="main"><span class="hidden">❙</span><b>=</b></span></span> seq <span class="main"><span class="main">∘</span></span> <span class="main"><span class="main">(</span></span>m <span class="main"><span class="main"><span class="hidden">❙</span><b>+</b></span></span> l<span class="main"><span class="main">)</span></span>"</span></span></span>
                      <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"measure <span class="main"><span class="main">(</span></span><span class="main"><span class="main">⟨</span></span><span class="free"><span class="free">mu</span></span><span class="main"><span class="main">⟩</span></span> <span class="main"><span class="main"><span class="hidden">❙</span><b>-</b></span></span> m<span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span>
            <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">using</span></span> properties_lambda_gt_0 properties_loop<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">mu</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span><span class="main">]</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_less <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> properties_loops_ge_mu<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">using</span></span> properties_loop<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">mu</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> j<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹ Top level ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> fx0<span class="main">)</span> <span class="entity">brent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> state <span class="main">⇒</span> <span class="tfree">'a</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">brent</span> <span class="main">≡</span> find_lambda <span class="main">;;</span> find_mu"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> brent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">⟨</span>True<span class="main">⟩</span><span class="main">⦄</span> brent <span class="main">⦃</span>l <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">lambda</span><span class="main">⟩</span> <span class="main"><span class="hidden">❙</span><b>∧</b></span> m <span class="main"><span class="hidden">❙</span><b>=</b></span> <span class="main">⟨</span><span class="free">mu</span><span class="main">⟩</span><span class="main">⦄</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> brent_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> find_lambda find_mu <span class="dynamic"><span class="dynamic">wp_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">corollary</span></span> brent_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> fx0.brent <span class="free">f</span> <span class="free">x</span> <span class="free">arbitrary</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fx0.properties <span class="free">f</span> <span class="free">x</span> <span class="main">(</span>l <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>m <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms properties.brent<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?x0.0</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">x</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fx0.properties_existence<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?x0.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span>
               <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  Basis.properties_def valid_def<span class="main">)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> brent_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fx0.brent <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?code</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fx0.brent_def fx0.find_lambda_def fx0.find_mu_def fcomp_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> fcomp_comp
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">fx0.brent</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>