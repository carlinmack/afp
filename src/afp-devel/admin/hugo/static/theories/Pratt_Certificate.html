<div id="Pratt_Certificate">
<div class="head">
<h1>Theory Pratt_Certificate</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Pratt's Primality Certificates›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:pratt}›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Pratt_Certificate
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <a href="../Lehmer/Lehmer.html">Lehmer.Lehmer</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This work formalizes Pratt's proof system as described in his article
  ``Every Prime has a Succinct Certificate''\cite{pratt1975certificate}.

  The proof system makes use of two types of predicates:
  \begin{itemize}
    \item $\text{Prime}(p)$: $p$ is a prime number
    \item $(p, a, x)$: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>∀q ∈ prime_factors(x). [a^((p - 1) div q) ≠ 1] (mod p)›</span></span></span></span>
  \end{itemize}
  We represent these predicates with the following datatype:
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pratt <span class="main">=</span> Prime <span class="quoted">nat</span> <span class="main">|</span> Triple <span class="quoted">nat</span> <span class="quoted">nat</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Pratt describes an inference system consisting of the axiom $(p, a, 1)$
  and the following inference rules:
  \begin{itemize}
  \item R1: If we know that $(p, a, x)$ and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[a^((p - 1) div q) ≠ 1] (mod p)›</span></span></span></span> hold for some
              prime number $q$ we can conclude $(p, a, qx)$ from that.
  \item R2: If we know that $(p, a, p - 1)$ and  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>[a^(p - 1) = 1] (mod p)›</span></span></span></span> hold, we can
              infer $\text{Prime}(p)$.
  \end{itemize}
  Both rules follow from Lehmer's theorem as we will show later on.

  A list of predicates (i.e., values of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> pratt<span class="antiquote"><span class="antiquote">}</span></span></span></span>) is a \emph{certificate}, if it is
  built according to the inference system described above. I.e., a list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">::</span></span> pratt list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  is a certificate if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">::</span></span> pratt list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a certificate and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">::</span></span> pratt"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
  either an axiom or all preconditions of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">::</span></span> pratt"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> occur in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">::</span></span> pratt list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  We call a certificate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">::</span></span> pratt list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a \emph{certificate for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>},
  if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Prime <span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> occurs in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">::</span></span> pratt list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  The function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>valid_cert›</span></span></span></span> checks whether a list is a certificate.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_cert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pratt list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_cert</span> <span class="main">[]</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_cert</span> <span class="main">(</span>Prime <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free">valid_cert</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">[</span><span class="bound">a</span><span class="main">^</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">∧</span> Triple <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">a</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_cert</span> <span class="main">(</span>Triple <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>  <span class="main">∧</span> <span class="free">valid_cert</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="main">1</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">q</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">∧</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> Triple <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
      <span class="main">∧</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define a function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">size_cert</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to measure the size of a certificate, assuming
  a binary encoding of numbers. We will use this to show that there is a certificate for a
  prime number $p$ such that the size of the certificate is polynomially bounded in the size
  of the binary representation of $p$.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size_pratt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pratt <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">size_pratt</span> <span class="main">(</span>Prime <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">size_pratt</span> <span class="main">(</span>Triple <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> log <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size_cert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pratt list <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">size_cert</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">size_cert</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> size_pratt <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free">size_cert</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Soundness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In Section \ref{sec:pratt} we introduced the predicates $\text{Prime}(p)$ and $(p, a, x)$.
  In this section we show that for a certificate every predicate occurring in this certificate
  holds. In particular, if $\text{Prime}(p)$ occurs in a certificate, $p$ is prime.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_factors_one <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_factorization_1 <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main">=</span></span> <span class="quoted">nat</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_factors_of_prime<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="free">p</span> <span class="main">=</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> prime_prime_factors<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pratt_triple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pratt_triple</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">∈</span>prime_factors <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pratt_triple_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> pratt_triple <span class="free">p</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pratt_triple_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pratt_triple_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"pratt_triple <span class="free">p</span> <span class="free">a</span> <span class="free">y</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">q</span> <span class="main">*</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pratt_triple <span class="free">p</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="free">x</span> <span class="main">=</span> insert <span class="free">q</span> <span class="main">(</span>prime_factors <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_factors_product prime_prime_factors<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> <span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pratt_triple_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> pratt_triple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pratt_triple_imp_prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pratt_triple <span class="free">p</span> <span class="free">a</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lehmers_theorem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pratt_triple_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> pratt_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_cert <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">=</span> Prime <span class="free">p</span> <span class="main">⟶</span> prime <span class="free">p</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="free">t</span> <span class="main">=</span> Triple <span class="free">p</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="free">x</span> <span class="main">.</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span><span class="main">&lt;</span><span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span>Triple <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="skolem">x</span> <span class="main">.</span> <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span><span class="main">&lt;</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> x_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span>Triple <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">~=</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">q</span><span class="main">*</span><span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"Prime <span class="skolem">q</span> <span class="main">∈</span> set <span class="skolem">ys</span> <span class="main">∧</span> Triple <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">z</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span>
               <span class="keyword2"><span class="keyword">and</span></span> cong<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems x_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> factors_IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> prime_factors <span class="skolem">z</span> <span class="main">.</span> <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&gt;</span><span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span><span class="main">=</span>Triple <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">x</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="skolem">x</span> <span class="main">=</span> prime_factors <span class="skolem">z</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span><span class="skolem">q</span><span class="main">*</span><span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&gt;</span><span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_factors_product prime_factors_of_prime<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="skolem">x</span> <span class="main">.</span> <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> factors_IH cong <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">&gt;</span><span class="main">0</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> y_Triple<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span>Triple <span class="skolem">p</span> <span class="skolem">a</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="skolem">x</span> <span class="main">.</span>
                                                <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span><span class="main">&lt;</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span>Prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">&gt;</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">then</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Triple <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Bier<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">∈</span>prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>y<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lehmers_theorem<span class="main">[</span><span class="operator">OF</span> _ _a<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span><span class="main">&gt;</span><span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span>Prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span>Prime <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">&gt;</span><span class="main">1</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> Cons.prems  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> y_Prime<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Prime <span class="skolem">p</span> <span class="main">⟹</span> prime <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">OF</span> _ True<span class="main">]</span> Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> y_Prime y_Triple <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> pratt_primeI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"Prime <span class="free">p</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pratt_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Completeness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we show completeness of Pratt's proof system, i.e., we show that for
  every prime number $p$ there exists a certificate for $p$. We also give an upper
  bound for the size of a minimal certificate

  The prove we give is constructive. We assume that we have certificates for all prime
  factors of $p - 1$ and use these to build a certificate for $p$ from that. It is
  important to note that certificates can be concatenated.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_cert_appendI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="main">(</span><span class="free">r</span> <span class="main">@</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_cert_concatI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">.</span> valid_cert <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> valid_cert <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_cert_appendI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_pratt_le<span class="main">:</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">d</span><span class="main">::</span><span class="quoted">real</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size_cert <span class="free">c</span> <span class="main">≤</span> length <span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">build_fpc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> pratt list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">build_fpc</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span>Triple <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">build_fpc</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> Triple <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">#</span> <span class="free">build_fpc</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">build_fpc</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> helps us to construct a certificate for $p$ from
  the certificates for the prime factors of $p - 1$. Called as
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"build_fpc <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">a</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">p</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">qs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where $<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">qs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> = q_1 \ldots q_n$
  is prime decomposition of $p - 1$ such that $q_1 \cdot \dotsb \cdot q_n = <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">::</span></span> nat"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>$,
  it returns the following list of predicates:
  \[
  (p,a,p-1), (p,a,\frac{p - 1}{q_1}), (p,a,\frac{p - 1}{q_1 q_2}), \ldots, (p,a,\frac{p-1}{q_1 \ldots q_n}) = (p,a,1)
  \]

  I.e., if there is an appropriate $a$ and and a certificate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">rs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for all
  prime factors of $p$, then we can construct a certificate for $p$ as
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> [display] <span class="quoted"><span class="quoted">"Prime <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">#</span></span> build_fpc <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">a</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">p</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">qs</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">rs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma shows that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>build_fpc›</span></span></span></span> extends a certificate that
  satisfies the preconditions described before to a correct certificate.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> correct_fpc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">qs</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">.</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">.</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="main">(</span>build_fpc <span class="free">p</span> <span class="free">a</span> <span class="free">r</span> <span class="free">qs</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">r</span> <span class="keyword1">div</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> T_in<span class="main">:</span> <span class="quoted"><span class="quoted">"Triple <span class="free">p</span> <span class="free">a</span> <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>build_fpc <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">div</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="main">(</span>build_fpc <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">div</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons.IH<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="main">(</span>Triple <span class="free">p</span> <span class="free">a</span> <span class="skolem">r</span> <span class="main">#</span> build_fpc <span class="free">p</span> <span class="free">a</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">div</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> T_in Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_fpc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>build_fpc <span class="free">p</span> <span class="free">a</span> <span class="free">r</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">qs</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> div_gt_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> div_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">div</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> div_le_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_pratt_fpc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">qs</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>build_fpc <span class="free">p</span> <span class="free">a</span> <span class="free">r</span> <span class="free">qs</span><span class="main">)</span> <span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">qs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">a</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="skolem">r</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">q</span> <span class="skolem">qs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">a</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="skolem">r</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">a</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="skolem">r</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">div</span> <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> div_gt_0<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">qs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="keyword1">div</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">div</span> <span class="skolem">q</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span><span class="main">≤</span><span class="free">p</span>›</span></span> div_le_dividend<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> concat_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">.</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">qs</span> <span class="main">.</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> p_in_prime_factorsE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> prime_factors <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_imp_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_factors_list_prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">qs</span><span class="main">.</span> prime_factors <span class="free">n</span> <span class="main">=</span> set <span class="bound">qs</span> <span class="main">∧</span> prod_list <span class="bound">qs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> length <span class="bound">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_factorization_prime <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">n</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_factors_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">qs</span><span class="main">.</span> prime_factors <span class="free">n</span> <span class="main">=</span> set <span class="bound">qs</span> <span class="main">∧</span> prod_list <span class="bound">qs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> length <span class="bound">qs</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> prime_factors <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> prime_factors_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">3</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> p_in_prime_factorsE<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">qs</span>"</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">qs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> p' <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_gt_0<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">p</span> <span class="main">(</span>prime_factors <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">3</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_product div_gt_0 prime_factors_of_prime<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="skolem">n</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">p</span><span class="main">#</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">qs</span>"</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">qs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prime_factors_list_prime <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">p</span> <span class="main">(</span>prime_factors <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">3</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_product div_gt_0 prime_factors_of_prime<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="skolem">n</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">qs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">p</span><span class="main">#</span><span class="skolem">qs</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> case_prime <span class="main">=</span> this
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span><span class="main">&gt;</span><span class="numeral">3</span>›</span></span>  <span class="keyword1"><span class="command">using</span></span> One_leq_div<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>›</span></span><span class="main">]</span> p'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> prime <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> case_prime <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> p' case_prime <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> p' div_gt_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> case_prime <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_list_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">xs</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_log<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> log <span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> log <span class="free">b</span> <span class="main">(</span>prod_list <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>prod_list <span class="skolem">ys</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_list_ge Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> log_mult<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> concat_length_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">.</span> real <span class="main">(</span>length <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_gt_3_impl_p_minus_one_not_prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">&gt;</span><span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> even <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_odd_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span><span class="main">&gt;</span><span class="numeral">3</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factorization_times_prime<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> prime_factors_of_prime <span class="quoted"><span class="quoted">‹<span class="free">p</span><span class="main">&gt;</span><span class="numeral">3</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now prove that Pratt's proof system is complete and derive upper bounds for
  the length and the size of the entries of a minimal certificate.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> pratt_complete'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> Prime <span class="free">p</span> <span class="main">∈</span> set <span class="bound">c</span> <span class="main">∧</span> valid_cert <span class="bound">c</span> <span class="main">∧</span> length <span class="bound">c</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="free">p</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">" <span class="skolem">p</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Prime <span class="skolem">p</span> <span class="main">∈</span> set <span class="main">[</span>Prime <span class="numeral">2</span><span class="main">,</span> Triple <span class="numeral">2</span> <span class="main">1</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cert</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Prime <span class="numeral">3</span><span class="main">,</span> Triple <span class="numeral">3</span> <span class="numeral">2</span> <span class="numeral">2</span><span class="main">,</span> Triple <span class="numeral">3</span> <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Prime <span class="numeral">2</span><span class="main">,</span> Triple <span class="numeral">2</span> <span class="main">1</span> <span class="main">1</span><span class="main">]</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?cert</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="skolem">p</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">⟷</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="numeral">3</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_nat_power<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="numeral">9</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="numeral">9</span> <span class="main">⟷</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> le_log_iff<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?cert</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> qlp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred le_imp_less_Suc lessI less_trans p_in_prime_factorsE prime_gt_1_nat zero_less_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> factor_certs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span>Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>valid_cert <span class="bound">c</span><span class="main">)</span>
                                                      <span class="main">∧</span> length <span class="bound">c</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="bound">q</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less.IH<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
              <span class="main">⟶</span> <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> converse_lehmer<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span><span class="main">&gt;</span><span class="numeral">3</span>›</span></span> prime_gt_3_impl_p_minus_one_not_prime <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> prod_qs_eq<span class="main">:</span><span class="quoted"><span class="quoted">"prod_list <span class="skolem">qs</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> qs_eq<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="skolem">qs</span> <span class="main">=</span> prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> qs_length_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_factors_list<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="main">¬</span> prime <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">q</span> <span class="main">=</span> <span class="bound">c</span>
                     <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>valid_cert <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">c</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="bound">q</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">)</span>
                     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> factor_certs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="skolem">f</span> <span class="skolem">qs</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span> <span class="main">∈</span> set <span class="var">?cs</span> <span class="main">.</span> <span class="main">(</span>Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>valid_cert <span class="bound">c</span><span class="main">)</span>
                                           <span class="main">∧</span> length <span class="bound">c</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="bound">q</span> <span class="main">-</span> <span class="numeral">4</span>
                                           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f qs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> cs_cert_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> set <span class="var">?cs</span> <span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="skolem">f</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="skolem">qs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f qs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qlp <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> set <span class="skolem">qs</span>›</span></span> qs_eq prime_factors_gt_0_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size_pratt <span class="skolem">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"size_pratt <span class="skolem">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> cs_valid_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span> <span class="main">∈</span> set <span class="var">?cs</span> <span class="main">.</span> valid_cert <span class="bound">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f qs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>build_fpc <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cs_cert_size a_size <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> prod_qs_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> size_pratt_fpc<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>build_fpc <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">qs</span> <span class="main">@</span> concat <span class="var">?cs</span><span class="main">)</span> <span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cs_cert_size <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Triple <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>build_fpc <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">qs</span> <span class="main">@</span> concat <span class="var">?cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">qs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="main">(</span><span class="main">(</span>build_fpc <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">@</span> concat <span class="var">?cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> correct_fpc<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="main">(</span>concat <span class="var">?cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cs_valid_all <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_cert_concatI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">qs</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_qs_eq<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="skolem">qs</span> <span class="main">.</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span>concat <span class="var">?cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> concat_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"prime_factors <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span> cs qs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="skolem">qs</span> <span class="main">.</span> <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qs_eq a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> qs_ge_2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="skolem">qs</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qs_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prime_ge_2_nat<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">qs</span><span class="main">.</span> real <span class="main">(</span>length <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">6</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f qs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="var">?cs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">q</span><span class="main">←</span><span class="skolem">qs</span><span class="main">.</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="bound">q</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> concat_length_le
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>Prime <span class="skolem">p</span> <span class="main">#</span> <span class="main">(</span><span class="main">(</span>build_fpc <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">@</span> concat <span class="var">?cs</span><span class="main">)</span><span class="main">)</span>
            <span class="main">≤</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">q</span><span class="main">←</span><span class="main">(</span>map real <span class="skolem">qs</span><span class="main">)</span><span class="main">.</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="bound">q</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">+</span> <span class="var">?k</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def length_fpc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="main">(</span><span class="main">∑</span><span class="bound">q</span><span class="main">←</span><span class="main">(</span>map real <span class="skolem">qs</span><span class="main">)</span><span class="main">.</span> log <span class="numeral">2</span> <span class="bound">q</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="numeral">4</span> <span class="main">*</span> real <span class="var">?k</span><span class="main">)</span> <span class="main">+</span> <span class="var">?k</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def sum_list_subtractf sum_list_triv sum_list_const_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span><span class="main">≥</span><span class="numeral">2</span>›</span></span> prod_qs_eq sum_list_log<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="skolem">qs</span></span><span class="main">]</span> qs_ge_2
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="skolem">p</span> <span class="main">-</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> log_le_cancel_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span><span class="main">&gt;</span><span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>Prime <span class="skolem">p</span> <span class="main">#</span> <span class="main">(</span><span class="main">(</span>build_fpc <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">qs</span><span class="main">)</span><span class="main">@</span> concat <span class="var">?cs</span><span class="main">)</span><span class="main">)</span>
                       <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="skolem">p</span> <span class="main">-</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"Triple <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="skolem">c</span>"</span></span>
                               <span class="quoted"><span class="quoted">"length <span class="main">(</span>Prime <span class="skolem">p</span> <span class="main">#</span><span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="skolem">p</span> <span class="main">-</span> <span class="numeral">4</span>"</span></span>
                               <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Prime <span class="skolem">p</span> <span class="main">∈</span> set <span class="main">(</span>Prime <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="main">(</span>Prime <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>Prime <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">c</span><span class="main">)</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Primes.prime_gt_Suc_0_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now recapitulate our results. A number $p$ is prime if and only if there
  is a certificate for $p$. Moreover, for a prime $p$ there always is a certificate
  whose size is polynomially bounded in the logarithm of $p$.
›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> pratt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c</span><span class="main">.</span> Prime <span class="free">p</span> <span class="main">∈</span> set <span class="bound">c</span> <span class="main">∧</span> valid_cert <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pratt_complete' pratt_sound<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> pratt_size<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> Prime <span class="free">p</span> <span class="main">∈</span> set <span class="bound">c</span> <span class="main">∧</span> valid_cert <span class="bound">c</span> <span class="main">∧</span> size_cert <span class="bound">c</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="free">p</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"Prime <span class="free">p</span> <span class="main">∈</span> set <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="skolem">c</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">c</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="free">p</span> <span class="main">-</span> <span class="numeral">4</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">c</span><span class="main">.</span> size_pratt <span class="bound">x</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pratt_complete' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size_cert <span class="skolem">c</span> <span class="main">≤</span> length <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_pratt_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span>log <span class="numeral">2</span> <span class="free">p</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Efficient modular exponentiation›</span></span>

<span class="keyword1"><span class="command">locale</span></span> efficient_power <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">z</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">efficient_power</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> even <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> odd <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">efficient_power</span> <span class="main">(</span><span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span>snd <span class="main">∘</span> snd<span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> efficient_power_code<span class="main">:</span>
  <span class="quoted"><span class="quoted">"efficient_power <span class="free">y</span> <span class="free">x</span> <span class="free">n</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">y</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> even <span class="free">n</span> <span class="keyword1">then</span> efficient_power <span class="free">y</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
      <span class="keyword1">else</span> efficient_power <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> efficient_power.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> efficient_power_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"efficient_power <span class="free">y</span> <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">^^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> efficient_power.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evenE oddE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> funpow_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> funpow_Suc_right f_assoc
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> mod_exp_nat<span class="main">:</span> efficient_power <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mult_left_eq mod_mult_right_eq mult_ac<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mod_exp_nat_aux</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mod_exp_nat_aux</span> <span class="main">=</span> mod_exp_nat.efficient_power"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mod_exp_nat_aux_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="free">n</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">y</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> even <span class="free">n</span> <span class="keyword1">then</span> mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
      <span class="keyword1">else</span> mod_exp_nat_aux <span class="free">m</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mod_exp_nat_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mod_exp_nat.efficient_power_code<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mod_exp_nat_aux_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">y</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_exp_nat_aux_def mod_exp_nat.efficient_power_correct<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">y</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">y</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">^^</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">*</span> <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mod_mult_right_eq mult.assoc<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mod_exp_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code_abbrev</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mod_exp_nat</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mod_exp_nat_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mod_exp_nat <span class="free">b</span> <span class="free">e</span> <span class="free">m</span> <span class="main">=</span> mod_exp_nat_aux <span class="free">m</span> <span class="main">1</span> <span class="free">b</span> <span class="free">e</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_exp_nat_def mod_exp_nat_aux_correct<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span> <span class="main">=</span> cong_def

<span class="keyword1"><span class="command">lemma</span></span> eval_mod_exp_nat_aux <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">0</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">(</span>numeral <span class="main">(</span>num.Bit0 <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">(</span>numeral <span class="main">(</span>num.Bit1 <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     mod_exp_nat_aux <span class="free">m</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> <span class="main">(</span>numeral <span class="free">n</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">0</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_exp_nat_aux_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"numeral <span class="main">(</span>num.Bit0 <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> numeral.numeral_Bit0<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> arith_simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">…</span> <span class="main">=</span> mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="main">(</span><span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="skolem">n'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mod_exp_nat_aux_code<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">(</span>numeral <span class="main">(</span>num.Bit0 <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"numeral <span class="main">(</span>num.Bit1 <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> numeral.numeral_Bit1<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> arith_simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">…</span> <span class="main">=</span> mod_exp_nat_aux <span class="free">m</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="skolem">n'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mod_exp_nat_aux_code<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mod_exp_nat_aux <span class="free">m</span> <span class="free">y</span> <span class="free">x</span> <span class="main">(</span>numeral <span class="main">(</span>num.Bit1 <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  mod_exp_nat_aux <span class="free">m</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_mod_exp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="free">b'</span> <span class="main">0</span> <span class="free">m'</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">m'</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="free">b'</span> <span class="main">1</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">b'</span> <span class="keyword1">mod</span> <span class="free">m'</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="free">b'</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">b'</span> <span class="keyword1">mod</span> <span class="free">m'</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="free">b'</span> <span class="free">e'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">b'</span> <span class="main">^</span> <span class="free">e'</span>"</span></span>  
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="free">b'</span> <span class="free">e'</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="free">b'</span> <span class="free">e'</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="main">0</span> <span class="main">1</span> <span class="free">m'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="main">0</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">m'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="main">0</span> <span class="main">(</span>numeral <span class="free">e</span><span class="main">)</span> <span class="free">m'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="main">1</span> <span class="free">e'</span> <span class="free">m'</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">m'</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">e'</span> <span class="free">m'</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">m'</span>"</span></span>
  <span class="quoted"><span class="quoted">"mod_exp_nat <span class="main">(</span>numeral <span class="free">b</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">e</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">m</span><span class="main">)</span> <span class="main">=</span>
     mod_exp_nat_aux <span class="main">(</span>numeral <span class="free">m</span><span class="main">)</span> <span class="main">1</span> <span class="main">(</span>numeral <span class="free">b</span><span class="main">)</span> <span class="main">(</span>numeral <span class="free">e</span><span class="main">)</span> <span class="keyword1">mod</span> numeral <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_exp_nat_def mod_exp_nat_aux_correct<span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Executable certificate checker›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> valid_cert.simps<span class="main">(</span>1<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_cert_Cons1 <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_cert <span class="main">(</span>Prime <span class="free">p</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span>
     <span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Prime <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> 
     Triple <span class="bound">p'</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> mod_exp_nat <span class="bound">a</span> <span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span> <span class="main">)</span> <span class="main">∧</span> valid_cert <span class="free">xs</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_exp_nat_def cong_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> pratt.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"valid_cert <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">t</span> <span class="keyword1">of</span> Prime <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> 
     Triple <span class="bound">p'</span> <span class="bound">a</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">[</span><span class="bound">a</span><span class="main">^</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def mod_exp_nat_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> pratt.case_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> Suc_0_mod_eq_Suc_0_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">≠</span> Suc <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> Suc_0_eq_Suc_0_mod_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">≠</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Suc_0_mod_eq_Suc_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_cert_Cons2 <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_cert <span class="main">(</span>Triple <span class="free">p</span> <span class="free">a</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="main">(</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Prime <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span>
        Triple <span class="bound">p'</span> <span class="bound">a'</span> <span class="bound">y</span> <span class="main">⇒</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">y</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="keyword1">let</span> <span class="bound">q</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="bound">y</span> <span class="keyword1">in</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> mod_exp_nat <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> valid_cert <span class="free">xs</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_cert <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">q</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">∧</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> Triple <span class="free">p</span> <span class="free">a</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span>
      <span class="main">∧</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> q y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> qy <span class="main">=</span> this
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Prime <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span>
        Triple <span class="bound">p'</span> <span class="bound">a'</span> <span class="bound">y</span> <span class="main">⇒</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">y</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="keyword1">let</span> <span class="bound">q</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="bound">y</span> <span class="keyword1">in</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> mod_exp_nat <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Triple <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="free"><span class="free"><span class="free">a</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_0_mod_eq_Suc_0_iff Suc_0_eq_Suc_0_mod_iff cong_def mod_exp_nat_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> pos gt_1 valid <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_cert <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">t</span> <span class="keyword1">of</span> Prime <span class="bound">x</span> <span class="main">⇒</span> False
         <span class="main">|</span> Triple <span class="bound">p'</span> <span class="bound">a'</span> <span class="bound">y</span> <span class="main">⇒</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">a'</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="bound">y</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">q</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="bound">y</span>
              <span class="keyword1">in</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> mod_exp_nat <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Triple <span class="free">p</span> <span class="free">a</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">dvd</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">q</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="skolem">y</span> <span class="keyword1">in</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> 
                              mod_exp_nat <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pratt.exhaust<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> gt_1 <span class="keyword1"><span class="command">have</span></span> y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">q</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="skolem">y</span> <span class="keyword1">in</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def Let_def mod_exp_nat_def Suc_0_mod_eq_Suc_0_iff Suc_0_eq_Suc_0_mod_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">q</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">∧</span> Prime <span class="bound">q</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> Triple <span class="free">p</span> <span class="free">a</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span>
                     <span class="main">∧</span> <span class="main">[</span><span class="free">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">q</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> t y y'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def q_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> pos gt_1 valid <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> valid_cert.simps<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> eval_valid_cert <span class="main">=</span> valid_cert.simps<span class="main">(</span>1<span class="main">)</span> valid_cert_Cons1 valid_cert_Cons2

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following alternative tree representation of certificates is better suited for 
  efficient checking.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pratt_tree <span class="main">=</span> Pratt_Node <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">×</span> pratt_tree list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pratt_tree_number</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pratt_tree_number</span> <span class="main">(</span>Pratt_Node <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following function checks that a given list contains all the prime factors of the given
  number.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">check_prime_factors_subset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_prime_factors_subset</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">check_prime_factors_subset</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> False <span class="keyword1">else</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">dvd</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free">check_prime_factors_subset</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>
                         <span class="keyword1">else</span> <span class="free">check_prime_factors_subset</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_prime_factors_subset_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>check_prime_factors_subset <span class="main">0</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> check_prime_factors_subset.simps<span class="main">(</span>2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> check_prime_factors_subset_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"check_prime_factors_subset <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟷</span> check_prime_factors_subset <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="quoted"><span class="quoted">"check_prime_factors_subset <span class="main">1</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟷</span> check_prime_factors_subset <span class="main">1</span> <span class="free">ps</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">dvd</span> numeral <span class="free">n</span> <span class="main">⟹</span> check_prime_factors_subset <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟷</span>
                           check_prime_factors_subset <span class="main">(</span>numeral <span class="free">n</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∨</span> <span class="main">¬</span><span class="free">p</span> <span class="keyword1">dvd</span> numeral <span class="free">n</span> <span class="main">⟹</span> check_prime_factors_subset <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⟷</span>
                           check_prime_factors_subset <span class="main">(</span>numeral <span class="free">n</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> check_prime_factors_subset.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_prime_factors_subset_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"check_prime_factors_subset <span class="free">n</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"list_all prime <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime_factors <span class="free">n</span> <span class="main">⊆</span> set <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> check_prime_factors_subset.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_gt_Suc_0_nat<span class="main">)</span>

  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">p</span> <span class="main">(</span>prime_factors <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_product prime_prime_factors<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_prime_factors_subset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_prime_factors_subset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_pratt_tree</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_pratt_tree</span> <span class="main">(</span>Pratt_Node <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
     <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">∧</span>
     check_prime_factors_subset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>map pratt_tree_number <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">^</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> pratt_tree_number <span class="bound">t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="free">valid_pratt_tree</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_pratt_tree_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"valid_pratt_tree <span class="main">(</span>Pratt_Node <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
     <span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">∧</span>
     check_prime_factors_subset <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>map pratt_tree_number <span class="free">ts</span><span class="main">)</span> <span class="main">∧</span>
     mod_exp_nat <span class="free">a</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> mod_exp_nat <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> pratt_tree_number <span class="bound">t</span><span class="main">)</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> valid_pratt_tree <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_exp_nat_def cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_pratt_tree_imp_prime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_pratt_tree <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime <span class="main">(</span>pratt_tree_number <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_pratt_tree.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">a</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factors <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>map pratt_tree_number <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> check_prime_factors_subset_correct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lehmers_theorem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_pratt_tree_imp_prime'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="main">(</span>Trueprop <span class="main">(</span>valid_pratt_tree <span class="main">(</span>Pratt_Node <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≡</span> <span class="keyword1">PROP</span> <span class="main">(</span>Trueprop True<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_pratt_tree <span class="main">(</span>Pratt_Node <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> assms<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> valid_pratt_tree_imp_prime<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proof method setup›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lehmers_theorem'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all prime <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≡</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> mod_exp_nat <span class="free">a</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">p</span><span class="main">)</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"mod_exp_nat <span class="free">a</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"check_prime_factors_subset <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms check_prime_factors_subset_correct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lehmers_theorem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def mod_exp_nat_def list.pred_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all_ConsI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> list_all <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> list_all <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹pratt.ML›</span>

<span class="keyword1"><span class="command">method_setup</span></span> pratt <span class="main">=</span> <span class="quoted">‹
  Scan.lift <span class="main">(</span><span class="entity">Pratt.tac_config_parser</span> -- Scan.option <span class="entity">Pratt.cert_cartouche</span><span class="main">)</span> &gt;&gt; 
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">config</span><span class="main">,</span> <span class="entity">cert</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD</span> <span class="main">(</span>HEADGOAL <span class="main">(</span><span class="entity">Pratt.tac</span> <span class="entity">config</span> <span class="entity">cert</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span> <span class="quoted">"Prove primality of natural numbers using Pratt certificates."</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The proof method replays a given Pratt certificate to prove the primality of a given number.
  If no certificate is given, the method attempts to compute one. The computed certificate is then
  also printed with a prompt to insert it into the proof document so that it does not have to
  be recomputed the next time.

  The format of the certificates is compatible with those generated by Mathematica. Therefore,
  for larger numbers, certificates generated by Mathematica can be used with this method directly.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">47</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pratt</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">silent</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">2503</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pratt</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">7919</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pratt</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">131059</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pratt</span> <span class="quoted">‹{131059, 2, {2, {3, 2, {2}}, {809, 3, {2, {101, 2, {2, {5, 2, {2}}}}}}}}›</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/pratt.ML">
<div class="head">
<h1>File ‹pratt.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
    File:     pratt.ML
    Author:   Manuel Eberl, TU München

    Various functions around Pratt certificates to prove primality of numbers.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">PRATT</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">prime_thm_cache</span> <span class="main">=</span> <span class="main">(</span>int * thm<span class="main">)</span> list
<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">tac_config</span> <span class="main">=</span> <span class="main">{</span>cache <span class="main">:</span> <span class="entity">prime_thm_cache</span><span class="main">,</span> verbose <span class="main">:</span> bool<span class="main">,</span> code <span class="main">:</span> bool<span class="main">}</span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">cert</span> <span class="main">=</span> <span class="entity">Pratt_Node</span> <span class="keyword2"><span class="keyword">of</span></span> int * int * cert list
<span class="keyword1"><span class="keyword">exception</span></span> INVALID_CERT <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">cert</span>

<span class="keyword1"><span class="keyword">val</span></span> get_cert_number <span class="main">:</span> <span class="entity">cert</span> <span class="main">-&gt;</span> int

<span class="keyword1"><span class="keyword">val</span></span> mk_cert <span class="main">:</span> int <span class="main">-&gt;</span> <span class="entity">cert</span> option
<span class="keyword1"><span class="keyword">val</span></span> check_cert <span class="main">:</span> <span class="entity">cert</span> <span class="main">-&gt;</span> bool
<span class="keyword1"><span class="keyword">val</span></span> replay_cert <span class="main">:</span> <span class="entity">prime_thm_cache</span> <span class="main">-&gt;</span> <span class="entity">cert</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm * <span class="entity">prime_thm_cache</span>
<span class="keyword1"><span class="keyword">val</span></span> replay_cert_code <span class="main">:</span> <span class="entity">cert</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm
<span class="keyword1"><span class="keyword">val</span></span> prove_prime <span class="main">:</span> <span class="entity">prime_thm_cache</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm option * <span class="entity">prime_thm_cache</span>

<span class="keyword1"><span class="keyword">val</span></span> certT <span class="main">:</span> typ
<span class="keyword1"><span class="keyword">val</span></span> termify_cert <span class="main">:</span> <span class="entity">cert</span> <span class="main">-&gt;</span> term
<span class="keyword1"><span class="keyword">val</span></span> untermify_cert <span class="main">:</span> term <span class="main">-&gt;</span> <span class="entity">cert</span>

<span class="keyword1"><span class="keyword">val</span></span> pretty_cert <span class="main">:</span> <span class="entity">cert</span> <span class="main">-&gt;</span> Pretty.T
<span class="keyword1"><span class="keyword">val</span></span> read_cert <span class="main">:</span> Input.source <span class="main">-&gt;</span> <span class="entity">cert</span>

<span class="keyword1"><span class="keyword">val</span></span> cert_cartouche <span class="main">:</span> <span class="entity">cert</span> parser 
<span class="keyword1"><span class="keyword">val</span></span> tac_config_parser <span class="main">:</span> <span class="entity">tac_config</span> parser
<span class="keyword1"><span class="keyword">val</span></span> tac <span class="main">:</span> <span class="entity">tac_config</span> <span class="main">-&gt;</span> <span class="entity">cert</span> option <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic

<span class="keyword1"><span class="keyword">val</span></span> setup_valid_cert_code_conv <span class="main">:</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Pratt</span> <span class="main">:</span> <span class="entity">PRATT</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mod_exp</span> <span class="main">_</span> <span class="inner_numeral">0</span> <span class="entity">m</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">m</span> <span class="main">=</span> <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">1</span>
  <span class="main">|</span> <span class="entity">mod_exp</span> <span class="entity">b</span> <span class="entity">e</span> <span class="entity">m</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">case</span></span> Integer.div_mod <span class="entity">e</span> <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="entity">e'</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mod_exp</span> <span class="main">(</span><span class="main">(</span><span class="entity">b</span> * <span class="entity">b</span><span class="main">)</span> mod <span class="entity">m</span><span class="main">)</span> <span class="entity">e'</span> <span class="entity">m</span>
      <span class="main">|</span> <span class="main">(</span><span class="entity">e'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">b</span> * <span class="entity">mod_exp</span> <span class="main">(</span><span class="main">(</span><span class="entity">b</span> * <span class="entity">b</span><span class="main">)</span> mod <span class="entity">m</span><span class="main">)</span> <span class="entity">e'</span> <span class="entity">m</span><span class="main">)</span> mod <span class="entity">m</span>

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">calc_primes</span> <span class="entity">mode</span> <span class="entity">ps</span> <span class="entity">i</span> <span class="entity">n</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">ps</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> exists <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">i</span> mod <span class="entity">p</span> <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="entity">ps</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">i</span> + <span class="inner_numeral">1</span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">mode</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">n</span> - <span class="inner_numeral">1</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">calc_primes</span> <span class="entity">mode</span> <span class="entity">ps</span> <span class="entity">i</span> <span class="entity">n</span>
        <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> <span class="entity">ps</span> @ <span class="main">[</span><span class="entity">i</span><span class="main">]</span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">i</span> + <span class="inner_numeral">1</span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">n</span> - <span class="inner_numeral">1</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="entity">calc_primes</span> <span class="entity">mode</span> <span class="entity">ps</span> <span class="entity">i</span> <span class="entity">n</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">primes_up_to</span> <span class="entity">n</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt; <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">calc_primes</span> false <span class="main">[</span><span class="inner_numeral">2</span><span class="main">]</span> <span class="inner_numeral">3</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">2</span><span class="main">)</span><span class="main">;</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">small_primes</span> <span class="main">=</span> <span class="entity">primes_up_to</span> <span class="inner_numeral">100</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">factorise</span> <span class="entity">n</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">init</span> <span class="main">=</span> <span class="main">(</span><span class="entity">small_primes</span><span class="main">,</span> <span class="inner_numeral">101</span><span class="main">,</span> false<span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_divisor</span> <span class="main">(</span><span class="entity">p</span> :: <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">p</span>
      <span class="main">|</span> <span class="entity">get_divisor</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">k</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">k</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">next</span> <span class="main">(</span><span class="main">_</span> :: <span class="entity">ps</span><span class="main">,</span> <span class="entity">k</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">ps</span><span class="main">,</span> <span class="entity">k</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">next</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">k</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">k</span> + <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">4</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">2</span><span class="main">)</span><span class="main">,</span> not <span class="entity">b</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">divide_out</span> <span class="entity">d</span> <span class="entity">n</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">divide</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> mod <span class="entity">d</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">divide</span> <span class="main">(</span><span class="entity">n</span> div <span class="entity">d</span><span class="main">,</span> <span class="entity">acc</span> + <span class="inner_numeral">1</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">divide</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">factor</span> <span class="entity">st</span> <span class="entity">n</span> <span class="entity">acc</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">d</span> <span class="main">=</span> <span class="entity">get_divisor</span> <span class="entity">st</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt;= <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span>
          rev <span class="entity">acc</span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">d</span> * <span class="entity">d</span> &gt; <span class="entity">n</span> <span class="keyword2"><span class="keyword">then</span></span>
          rev <span class="main">(</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span> :: <span class="entity">acc</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">divide_out</span> <span class="entity">d</span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="main">(</span><span class="entity">n'</span><span class="main">,</span> <span class="entity">k</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">factor</span> <span class="main">(</span><span class="entity">next</span> <span class="entity">st</span><span class="main">)</span> <span class="entity">n'</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">k</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">acc</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">d</span><span class="main">,</span> <span class="entity">k</span><span class="main">)</span> :: <span class="entity">acc</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">factor</span> <span class="entity">init</span> <span class="entity">n</span> <span class="main">[</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">prime_thm_cache</span> <span class="main">=</span> <span class="main">(</span>int * thm<span class="main">)</span> list

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">cert</span> <span class="main">=</span> <span class="entity">Pratt_Node</span> <span class="keyword2"><span class="keyword">of</span></span> int * int * cert list

<span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">INVALID_CERT</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">cert</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_cert_number</span> <span class="main">(</span><span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">n</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_cert</span> <span class="entity">n</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">PRATT</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cert</span> <span class="entity">n</span> <span class="entity">cache</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> AList.defined <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">cache</span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">cache</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find</span> <span class="entity">p</span> <span class="entity">lb</span> <span class="entity">ub</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">ub</span> &lt; <span class="entity">lb</span> <span class="keyword2"><span class="keyword">then</span></span> NONE <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="entity">lb</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="entity">lb</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">find</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">lb</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">ub</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> map fst <span class="main">(</span><span class="entity">factorise</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">suitable'</span> <span class="entity">a</span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">mod_exp</span> <span class="entity">a</span> <span class="main">(</span><span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span> div <span class="entity">p</span><span class="main">)</span> <span class="entity">n</span> &lt;&gt; <span class="inner_numeral">1</span>
          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">suitable</span> <span class="entity">a</span> <span class="main">=</span> <span class="entity">mod_exp</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">1</span> <span class="keyword1"><span class="keyword">andalso</span></span> forall <span class="main">(</span><span class="entity">suitable'</span> <span class="entity">a</span><span class="main">)</span> <span class="entity">ps</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">find</span> <span class="entity">suitable</span> <span class="inner_numeral">1</span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">of</span></span>
              NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">PRATT</span>
            <span class="main">|</span> SOME <span class="entity">a</span> <span class="main">=&gt;</span> <span class="entity">a</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cache</span> <span class="main">=</span> fold <span class="entity">cert</span> <span class="entity">ps</span> <span class="entity">cache</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">proofs</span> <span class="main">=</span> map <span class="main">(</span>the o AList.lookup <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">cache</span><span class="main">)</span> <span class="entity">ps</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">proofs</span><span class="main">)</span><span class="main">)</span> :: <span class="entity">cache</span>
        <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    AList.lookup <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="main">(</span><span class="entity">cert</span> <span class="entity">n</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="entity">n</span>
      <span class="keyword3"><span class="keyword">handle</span></span> <span class="entity">PRATT</span> <span class="main">=&gt;</span> NONE
  <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_list_all</span> <span class="entity">ctxt</span> <span class="entity">property</span> <span class="entity">thms</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span>
      Drule.infer_instantiate' <span class="entity">ctxt</span> <span class="main">[</span>SOME <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">property</span><span class="main">)</span><span class="main">]</span>
        <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> list.pred_inject<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove</span> <span class="entity">acc</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">acc</span>
      <span class="main">|</span> <span class="entity">prove</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">thm</span> :: <span class="entity">thms</span><span class="main">)</span> <span class="main">=</span> <span class="entity">prove</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> list_all_ConsI<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">,</span> <span class="entity">acc</span><span class="main">]</span><span class="main">)</span> <span class="entity">thms</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">prove</span> <span class="entity">thm</span> <span class="main">(</span>rev <span class="entity">thms</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_prime_factors_subset</span> <span class="inner_numeral">0</span> <span class="main">_</span> <span class="main">=</span> false
  <span class="main">|</span> <span class="entity">check_prime_factors_subset</span> <span class="entity">n</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">1</span>
  <span class="main">|</span> <span class="entity">check_prime_factors_subset</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">p</span> :: <span class="entity">ps</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> mod <span class="entity">p</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">check_prime_factors_subset</span> <span class="main">(</span><span class="entity">n</span> div <span class="entity">p</span><span class="main">)</span> <span class="main">(</span><span class="entity">p</span> :: <span class="entity">ps</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="entity">check_prime_factors_subset</span> <span class="entity">n</span> <span class="entity">ps</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_cert'</span> <span class="main">(</span><span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ps</span> <span class="main">=</span> map <span class="entity">get_cert_number</span> <span class="entity">ts</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">check_prime_factors_subset</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">ps</span>
    <span class="keyword1"><span class="keyword">andalso</span></span> forall <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">p</span> <span class="main">=&gt;</span> <span class="entity">mod_exp</span> <span class="entity">a</span> <span class="main">(</span><span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span> div <span class="entity">p</span><span class="main">)</span> <span class="entity">n</span> &lt;&gt; <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">ps</span>
    <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">mod_exp</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">1</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_cert</span> <span class="main">(</span><span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="entity">check_cert'</span> <span class="main">(</span><span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> forall <span class="entity">check_cert</span> <span class="entity">ts</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">replay_cert</span> <span class="entity">cache</span> <span class="entity">cert</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_nat</span> <span class="main">=</span> <span class="entity">HOLogic.mk_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"Nat.nat"</span><span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_eq_thm</span> <span class="main">=</span> Thm.cterm_of <span class="entity">ctxt</span> #&gt; Thm.reflexive

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">replay</span> <span class="main">(</span><span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span> <span class="entity">cache</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> AList.lookup <span class="keyword1"><span class="keyword">op</span></span><span class="main">=</span> <span class="entity">cache</span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">thm</span><span class="main">,</span> <span class="entity">cache</span><span class="main">)</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">check_cert'</span> <span class="entity">cert</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">INVALID_CERT</span> <span class="entity">cert</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">prime_thms</span><span class="main">,</span> <span class="entity">cache</span><span class="main">)</span> <span class="main">=</span> fold_map <span class="entity">replay</span> <span class="entity">ts</span> <span class="entity">cache</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">n'</span><span class="main">,</span> <span class="entity">a'</span><span class="main">)</span> <span class="main">=</span> apply2 <span class="entity">mk_nat</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">a</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prime_thm</span> <span class="main">=</span> <span class="entity">prove_list_all</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"prime <span class="main">::</span> nat <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span> <span class="entity">prime_thms</span>

            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span>
              <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> lehmers_theorem'<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">prime_thm</span><span class="main">,</span> <span class="entity">mk_eq_thm</span> <span class="entity">a'</span><span class="main">,</span> <span class="entity">mk_eq_thm</span> <span class="entity">n'</span><span class="main">]</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_thm</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
              Goal.prove <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
                <span class="main">(</span><span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"prime <span class="main">::</span> nat <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span> $ <span class="entity">mk_nat</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
                   HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
                   THEN ALLGOALS <span class="main">(</span>TRY o REPEAT_ALL_NEW
                     <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> list_all_ConsI list.pred_inject<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>
                   THEN <span class="entity">PARALLEL_ALLGOALS</span> <span class="main">(</span><span class="entity">Simplifier.simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword2"><span class="keyword">case</span></span> try <span class="entity">mk_thm</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
              NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> THM <span class="main">(</span><span class="inner_quoted">"replay_cert"</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
            <span class="main">|</span> SOME <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">thm</span><span class="main">,</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span> :: <span class="entity">cache</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">replay</span> <span class="entity">cert</span> <span class="entity">cache</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_prime</span> <span class="entity">cache</span> <span class="entity">n</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">mk_cert</span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">of</span></span>
    NONE <span class="main">=&gt;</span> <span class="main">(</span>NONE<span class="main">,</span> <span class="entity">cache</span><span class="main">)</span>
  <span class="main">|</span> SOME <span class="entity">cert</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">replay_cert</span> <span class="entity">cache</span> <span class="entity">cert</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="entity">thm</span><span class="main">,</span> <span class="entity">cache</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span>SOME <span class="entity">thm</span><span class="main">,</span> <span class="entity">cache</span><span class="main">)</span>

<span class="comment1">(* datatype token *)</span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">token_kind</span> <span class="main">=</span> <span class="entity">Nat</span> <span class="keyword2"><span class="keyword">of</span></span> int <span class="main">|</span> <span class="entity">Comma</span> <span class="main">|</span> <span class="entity">Open_Brace</span> <span class="main">|</span> <span class="entity">Close_Brace</span> <span class="main">|</span> <span class="entity">Space</span> <span class="main">|</span> <span class="entity">EOF</span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">token</span> <span class="main">=</span> <span class="entity">Token</span> <span class="keyword2"><span class="keyword">of</span></span> token_kind * Position.T

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pos_of</span> <span class="main">(</span><span class="entity">Token</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">pos</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pos</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_space</span> <span class="main">(</span><span class="entity">Token</span> <span class="main">(</span><span class="entity">Space</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_space</span> <span class="main">_</span> <span class="main">=</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_eof</span> <span class="main">(</span><span class="entity">Token</span> <span class="main">(</span><span class="entity">EOF</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">is_eof</span> <span class="main">_</span> <span class="main">=</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_eof</span> <span class="entity">pos</span> <span class="main">=</span> <span class="entity">Token</span> <span class="main">(</span><span class="entity">EOF</span><span class="main">,</span> <span class="entity">pos</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">token_kind_name</span> <span class="main">(</span><span class="entity">Nat</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="inner_quoted">"natural number"</span>
  <span class="main">|</span> <span class="entity">token_kind_name</span> <span class="entity">Comma</span> <span class="main">=</span> <span class="inner_quoted">"comma"</span>
  <span class="main">|</span> <span class="entity">token_kind_name</span> <span class="entity">Open_Brace</span> <span class="main">=</span> <span class="inner_quoted">"opening curly brace"</span>
  <span class="main">|</span> <span class="entity">token_kind_name</span> <span class="entity">Close_Brace</span> <span class="main">=</span> <span class="inner_quoted">"closing curly brace"</span>
  <span class="main">|</span> <span class="entity">token_kind_name</span> <span class="entity">Space</span> <span class="main">=</span> <span class="inner_quoted">"whitespace"</span>
  <span class="main">|</span> <span class="entity">token_kind_name</span> <span class="entity">EOF</span> <span class="main">=</span> <span class="inner_quoted">"end of input"</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">stopper</span> <span class="main">=</span>
  Scan.stopper <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">mk_eof</span> Position.none <span class="main">|</span> <span class="entity">toks</span> <span class="main">=&gt;</span> <span class="entity">mk_eof</span> <span class="main">(</span><span class="entity">pos_of</span> <span class="main">(</span>List.last <span class="entity">toks</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">is_eof</span>


<span class="comment1">(* tokenize *)</span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">space_symbol</span> <span class="main">(</span><span class="main">(</span><span class="entity">s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">:</span> Symbol_Pos.T<span class="main">)</span> <span class="main">=</span> Symbol.is_blank <span class="entity">s</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">s</span> &lt;&gt; <span class="inner_quoted">"\n"</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">scan_space</span> <span class="main">=</span>
  Scan.many1 <span class="entity">space_symbol</span> @@@ Scan.optional <span class="main">(</span>Symbol_Pos.$$$ <span class="inner_quoted">"\n"</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> ||
  Scan.many <span class="entity">space_symbol</span> @@@ Symbol_Pos.$$$ <span class="inner_quoted">"\n"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">token</span> <span class="entity">kind</span> <span class="main">(</span><span class="entity">ss</span><span class="main">:</span> Symbol_Pos.T list<span class="main">)</span> <span class="main">=</span>
  <span class="entity">Token</span> <span class="main">(</span><span class="entity">kind</span><span class="main">,</span> Position.range_position <span class="main">(</span>Symbol_Pos.range <span class="entity">ss</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">scan_token</span> <span class="main">=</span>
  Symbol_Pos.scan_nat &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ss</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">kind</span> <span class="main">=</span> <span class="entity">Nat</span> <span class="main">(</span><span class="main">#</span><span class="inner_numeral">1</span> <span class="main">(</span>Library.read_int <span class="main">(</span>map <span class="main">#</span><span class="inner_numeral">1</span> <span class="entity">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pos</span> <span class="main">=</span> Position.range_position <span class="main">(</span>Symbol_Pos.range <span class="entity">ss</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Token</span> <span class="main">(</span><span class="entity">kind</span><span class="main">,</span> <span class="entity">pos</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> ||
  Symbol_Pos.$$$ <span class="inner_quoted">","</span> &gt;&gt; <span class="entity">token</span> <span class="entity">Comma</span> ||
  Symbol_Pos.$$$ <span class="inner_quoted">"{"</span> &gt;&gt; <span class="entity">token</span> <span class="entity">Open_Brace</span> ||
  Symbol_Pos.$$$ <span class="inner_quoted">"}"</span> &gt;&gt; <span class="entity">token</span> <span class="entity">Close_Brace</span> ||
  <span class="entity">scan_space</span> &gt;&gt; <span class="entity">token</span> <span class="entity">Space</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">scan_all_tokens</span> <span class="main">=</span>
  Scan.repeat <span class="entity">scan_token</span> --|
  Symbol_Pos.!!! <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="inner_quoted">"Lexical error"</span><span class="main">)</span> <span class="main">(</span>Scan.ahead <span class="main">(</span>Scan.one Symbol_Pos.is_eof<span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tokenize</span> <span class="main">=</span>
  <span class="main">#</span><span class="inner_numeral">1</span> o Scan.error <span class="main">(</span>Scan.finite Symbol_Pos.stopper <span class="entity">scan_all_tokens</span><span class="main">)</span> o Input.source_explode

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>


<span class="comment1">(* parse *)</span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">parser</span> <span class="main">=</span> <span class="entity">token</span> list <span class="main">-&gt;</span> 'a * <span class="entity">token</span> list

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">err_msg</span> <span class="entity">expected</span> <span class="entity">toks</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">found</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="inner_quoted">"end of input"</span>
      <span class="main">|</span> <span class="entity">found</span> <span class="main">(</span><span class="entity">Token</span> <span class="main">(</span><span class="entity">kind</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> :: <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="entity">token_kind_name</span> <span class="entity">kind</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">expected</span> ^ <span class="inner_quoted">" expected, but "</span> ^ <span class="entity">found</span> <span class="entity">toks</span> ^ <span class="inner_quoted">" was found"</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">!!!</span> <span class="main">(</span><span class="entity">scan</span><span class="main">:</span> 'a <span class="entity">parser</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_pos</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="inner_quoted">" (end-of-input)"</span>
      <span class="main">|</span> <span class="entity">get_pos</span> <span class="main">(</span><span class="entity">tok</span> :: <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Position.here <span class="main">(</span><span class="entity">pos_of</span> <span class="entity">tok</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">err</span> <span class="main">(</span><span class="entity">toks</span><span class="main">,</span> <span class="entity">msg</span><span class="main">)</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
      <span class="inner_quoted">"Syntax error"</span> ^ <span class="entity">get_pos</span> <span class="entity">toks</span> ^ <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">msg</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="inner_quoted">""</span> <span class="main">|</span> SOME <span class="entity">m</span> <span class="main">=&gt;</span> <span class="inner_quoted">": "</span> ^ <span class="entity">m</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> Scan.!! <span class="entity">err</span> <span class="entity">scan</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">one</span> <span class="entity">kind</span> <span class="main">=</span>
  Scan.some <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Token</span> <span class="main">(</span><span class="entity">kind'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">kind</span> <span class="main">=</span> <span class="entity">kind'</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> NONE<span class="main">)</span>
  || Scan.fail_with <span class="main">(</span><span class="entity">err_msg</span> <span class="main">(</span><span class="entity">token_kind_name</span> <span class="entity">kind</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nat</span> <span class="main">=</span>
  Scan.some <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">Token</span> <span class="main">(</span><span class="entity">Nat</span> <span class="entity">n</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> SOME <span class="entity">n</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span>
  || Scan.fail_with <span class="main">(</span><span class="entity">err_msg</span> <span class="inner_quoted">"natural number"</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">comma</span> <span class="main">=</span> <span class="entity">one</span> <span class="entity">Comma</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">open_brace</span> <span class="main">=</span> <span class="entity">one</span> <span class="entity">Open_Brace</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">close_brace</span> <span class="main">=</span> <span class="entity">one</span> <span class="entity">Close_Brace</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">enum1</span> <span class="entity">scan</span> <span class="main">=</span> <span class="entity">scan</span> ::: Scan.repeat <span class="main">(</span><span class="entity">comma</span> |-- <span class="entity">scan</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">enum</span> <span class="entity">scan</span> <span class="main">=</span> <span class="entity">enum1</span> <span class="entity">scan</span> || Scan.succeed <span class="main">[</span><span class="main">]</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list</span> <span class="entity">scan</span> <span class="main">=</span> <span class="entity">!!!</span> <span class="entity">open_brace</span> |-- <span class="entity">enum</span> <span class="entity">scan</span> --| <span class="entity">!!!</span> <span class="entity">close_brace</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parse</span> <span class="entity">toks</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span><span class="entity">open_brace</span> |-- <span class="entity">!!!</span> <span class="main">(</span><span class="entity">nat</span> --| <span class="entity">!!!</span> <span class="entity">comma</span> -- <span class="entity">!!!</span> <span class="entity">nat</span> --| <span class="entity">!!!</span> <span class="entity">comma</span> -- <span class="entity">list</span> <span class="entity">parse</span>
    --| <span class="entity">!!!</span> <span class="entity">close_brace</span><span class="main">)</span><span class="main">)</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">)</span><span class="main">,</span> <span class="entity">c</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">b</span><span class="main">,</span> <span class="entity">c</span><span class="main">)</span><span class="main">)</span>
  || <span class="entity">!!!</span> <span class="entity">nat</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">a</span> <span class="main">=&gt;</span> <span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  || Scan.fail_with <span class="main">(</span><span class="entity">err_msg</span> <span class="inner_quoted">"opening curly brace or natural number"</span><span class="main">)</span><span class="main">)</span> <span class="entity">toks</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">read_cert</span> <span class="entity">input</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">toks</span> <span class="main">=</span> filter_out <span class="entity">is_space</span> <span class="main">(</span><span class="entity">tokenize</span> <span class="entity">input</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">#</span><span class="inner_numeral">1</span> <span class="main">(</span>Scan.error <span class="main">(</span>Scan.finite <span class="entity">stopper</span> <span class="main">(</span><span class="entity">parse</span> --| <span class="entity">!!!</span> <span class="main">(</span>Scan.ahead <span class="main">(</span><span class="entity">one</span> <span class="entity">EOF</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">toks</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cert_cartouche</span> <span class="main">=</span> Args.cartouche_input &gt;&gt; <span class="entity">read_cert</span>


<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">certT</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"Pratt_Certificate.pratt_tree"</span><span class="antiquote">}</span></span>


<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_nat</span> <span class="main">=</span> <span class="entity">HOLogic.mk_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">dest_nat</span> <span class="main">=</span> snd o <span class="entity">HOLogic.dest_number</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">termify_cert</span> <span class="main">(</span><span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Pratt_Node</span><span class="antiquote">}</span></span> $
    <span class="entity">HOLogic.mk_tuple</span> <span class="main">[</span><span class="entity">mk_nat</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">mk_nat</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">HOLogic.mk_list</span> <span class="entity">certT</span> <span class="main">(</span>map <span class="entity">termify_cert</span> <span class="entity">ts</span><span class="main">)</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">untermify_cert</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Pratt_Node</span><span class="antiquote">}</span></span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">HOLogic.strip_tuple</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">[</span><span class="entity">n</span><span class="main">,</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">ts</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">dest_nat</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">dest_nat</span> <span class="entity">a</span><span class="main">,</span> map <span class="entity">untermify_cert</span> <span class="main">(</span><span class="entity">HOLogic.dest_list</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"untermify_cert"</span><span class="main">,</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Pratt_Node</span><span class="antiquote">}</span></span> $ <span class="entity">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">untermify_cert</span> <span class="entity">t</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"untermify_cert"</span><span class="main">,</span> <span class="main">[</span><span class="entity">t</span><span class="main">]</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Data</span> <span class="main">=</span> Generic_Data
<span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv<span class="main">)</span> option
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">:</span> <span class="entity">T</span> <span class="main">=</span> NONE
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">conv</span><span class="main">)</span> <span class="main">=</span> <span class="entity">conv</span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">setup_valid_cert_code_conv</span> <span class="entity">conv</span> <span class="entity">ctxt</span> <span class="main">=</span>
  Data.put <span class="main">(</span>SOME <span class="entity">conv</span><span class="main">)</span> <span class="entity">ctxt</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">has_code_conv</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Data.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="main">_</span> <span class="main">=&gt;</span> true
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">valid_cert_code_conv</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> Data.get <span class="main">(</span>Context.Proof <span class="entity">ctxt</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    SOME <span class="entity">conv</span> <span class="main">=&gt;</span> <span class="entity">conv</span> <span class="entity">ctxt</span>
  <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ct</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> CTERM <span class="main">(</span><span class="inner_quoted">"valid_cert_code_conv"</span><span class="main">,</span> <span class="main">[</span><span class="entity">ct</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">replay_cert_code</span> <span class="entity">cert</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span>
      Thm.cterm_of <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">valid_pratt_tree</span><span class="antiquote">}</span></span> $ <span class="entity">termify_cert</span> <span class="entity">cert</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> valid_pratt_tree_imp_prime'<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">valid_cert_code_conv</span> <span class="entity">ctxt</span> <span class="entity">goal</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword3"><span class="keyword">handle</span></span> TERM <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">INVALID_CERT</span> <span class="entity">cert</span>
         <span class="main">|</span> CTERM <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">INVALID_CERT</span> <span class="entity">cert</span>
         <span class="main">|</span> THM <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">INVALID_CERT</span> <span class="entity">cert</span>

<span class="keyword2"><span class="keyword">local</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pretty_int</span> <span class="main">=</span> Pretty.str o string_of_int
<span class="keyword2"><span class="keyword">in</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pretty_cert</span> <span class="main">(</span><span class="entity">Pratt_Node</span> <span class="main">(</span><span class="inner_numeral">2</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">pretty_int</span> <span class="inner_numeral">2</span>
  <span class="main">|</span> <span class="entity">pretty_cert</span> <span class="main">(</span><span class="entity">Pratt_Node</span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">a</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      Pretty.list <span class="inner_quoted">"{"</span> <span class="inner_quoted">"}"</span>
        <span class="main">[</span><span class="entity">pretty_int</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">pretty_int</span> <span class="entity">a</span><span class="main">,</span> Pretty.enum <span class="inner_quoted">","</span> <span class="inner_quoted">"{"</span> <span class="inner_quoted">"}"</span> <span class="main">(</span>map <span class="entity">pretty_cert</span> <span class="entity">ts</span><span class="main">)</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">tac_config</span> <span class="main">=</span> <span class="main">{</span>cache <span class="main">:</span> <span class="entity">prime_thm_cache</span><span class="main">,</span> verbose <span class="main">:</span> bool<span class="main">,</span> code <span class="main">:</span> bool<span class="main">}</span>

<span class="keyword1"><span class="keyword">exception</span></span> <span class="entity">NO_CODE</span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cert_err</span> <span class="entity">config</span> <span class="entity">cert</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>verbose <span class="entity">config</span> <span class="keyword2"><span class="keyword">then</span></span>
        Pretty.chunks <span class="main">[</span>Pretty.str <span class="inner_quoted">"Invalid Pratt certificate:"</span><span class="main">,</span>
          Pretty.indent <span class="inner_numeral">2</span> <span class="main">(</span><span class="entity">pretty_cert</span> <span class="entity">cert</span><span class="main">)</span><span class="main">]</span>
        |&gt; Pretty.string_of
        |&gt; warning
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    no_tac
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">config</span> <span class="entity">cert</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cmd</span> <span class="main">=</span>
      Pretty.block <span class="main">(</span><span class="main">[</span>Pretty.str <span class="inner_quoted">"pratt"</span><span class="main">]</span> @
        <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>code <span class="entity">config</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span>Pretty.str <span class="inner_quoted">" ("</span><span class="main">,</span> Pretty.keyword1 <span class="inner_quoted">"code"</span><span class="main">,</span> Pretty.str <span class="inner_quoted">")"</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print_cert</span> <span class="entity">cert</span> <span class="main">=</span>
      <span class="main">[</span>Pretty.keyword1 <span class="inner_quoted">"by"</span><span class="main">,</span> Pretty.brk <span class="inner_numeral">1</span><span class="main">,</span> Pretty.str <span class="inner_quoted">"("</span><span class="main">,</span> <span class="entity">cmd</span><span class="main">,</span> Pretty.str <span class="inner_quoted">" "</span><span class="main">,</span>
        Pretty.blk <span class="main">(</span><span class="inner_numeral">2</span><span class="main">,</span> <span class="main">[</span>Pretty.cartouche <span class="main">(</span><span class="entity">pretty_cert</span> <span class="entity">cert</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> Pretty.str <span class="inner_quoted">")"</span><span class="main">]</span>
      |&gt; Pretty.blk o pair <span class="inner_numeral">4</span>
      |&gt; Pretty.string_of
      |&gt; Active.sendback_markup_command
      |&gt; prefix <span class="inner_quoted">"To repeat this proof with a pre-computed certificate, use:\n"</span>
      |&gt; Output.information

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">not_prime_err</span> <span class="entity">n</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>verbose <span class="entity">config</span> <span class="keyword2"><span class="keyword">then</span></span> warning <span class="main">(</span><span class="inner_quoted">"Not a prime number: "</span> ^ Int.toString <span class="entity">n</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        NONE
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">certify</span> <span class="entity">p</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">cert</span> <span class="keyword2"><span class="keyword">of</span></span>
        SOME <span class="entity">cert</span> <span class="main">=&gt;</span> SOME <span class="entity">cert</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span>         
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p'</span> <span class="main">=</span> <span class="entity">p</span> |&gt; <span class="entity">HOLogic.dest_Trueprop</span> |&gt; dest_comb |&gt; snd |&gt; <span class="entity">HOLogic.dest_number</span> |&gt; snd
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">mk_cert</span> <span class="entity">p'</span> <span class="keyword2"><span class="keyword">of</span></span>
            SOME <span class="entity">cert</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>verbose <span class="entity">config</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">print_cert</span> <span class="entity">cert</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span> SOME <span class="entity">cert</span> <span class="keyword2"><span class="keyword">end</span></span>
          <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="entity">not_prime_err</span> <span class="entity">p'</span>
        <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">replay</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>code <span class="entity">config</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">has_code_conv</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="entity">replay_cert_code</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          <span class="keyword2"><span class="keyword">let</span></span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>verbose <span class="entity">config</span> <span class="keyword2"><span class="keyword">then</span></span>
                warning
                  <span class="main">(</span><span class="inner_quoted">"Code for Pratt certificates was not set up yet. "</span> ^
                   <span class="inner_quoted">"Load the theory Pratt_Certificate_Code to do this."</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span>
                <span class="main">(</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span>
            <span class="keyword3"><span class="keyword">raise</span></span> <span class="entity">NO_CODE</span>
          <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span>
        fst oo <span class="entity">replay_cert</span> <span class="main">(</span><span class="main">#</span>cache <span class="entity">config</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Subgoal.FOCUS_PARAMS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">concl</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">certify</span> <span class="main">(</span>Thm.term_of <span class="entity">concl</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
        NONE <span class="main">=&gt;</span> no_tac
      <span class="main">|</span> SOME <span class="entity">cert</span> <span class="main">=&gt;</span>
          HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">replay</span> <span class="entity">cert</span> <span class="entity">ctxt</span><span class="main">]</span><span class="main">)</span>
    <span class="main">)</span> <span class="entity">ctxt</span> <span class="entity">i</span>
  <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword3"><span class="keyword">handle</span></span> <span class="entity">INVALID_CERT</span> <span class="entity">cert</span> <span class="main">=&gt;</span> <span class="entity">cert_err</span> <span class="entity">config</span> <span class="entity">cert</span>
         <span class="main">|</span> <span class="entity">NO_CODE</span> <span class="main">=&gt;</span> no_tac

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">default_config</span> <span class="main">=</span> <span class="main">{</span>verbose <span class="main">=</span> true<span class="main">,</span> code <span class="main">=</span> false<span class="main">,</span> cache <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">}</span>

<span class="keyword2"><span class="keyword">local</span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">silent</span> <span class="main">:</span> <span class="main">(</span><span class="entity">tac_config</span> <span class="main">-&gt;</span> <span class="entity">tac_config</span><span class="main">)</span> parser <span class="main">=</span>
    Args.$$$ <span class="inner_quoted">"silent"</span> &gt;&gt;
      <span class="main">(</span>K <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">code</span><span class="main">,</span> <span class="entity">cache</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="main">{</span>verbose <span class="main">=</span> false<span class="main">,</span> code <span class="main">=</span> <span class="entity">code</span><span class="main">,</span> cache <span class="main">=</span> <span class="entity">cache</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code</span> <span class="main">:</span> <span class="main">(</span><span class="entity">tac_config</span> <span class="main">-&gt;</span> <span class="entity">tac_config</span><span class="main">)</span> parser <span class="main">=</span>
    Args.$$$ <span class="inner_quoted">"code"</span> &gt;&gt;
      <span class="main">(</span>K <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">verbose</span><span class="main">,</span> <span class="entity">cache</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="main">{</span>verbose <span class="main">=</span> <span class="entity">verbose</span><span class="main">,</span> code <span class="main">=</span> true<span class="main">,</span> cache <span class="main">=</span> <span class="entity">cache</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">option</span> <span class="main">=</span> <span class="entity">silent</span> || <span class="entity">code</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">options</span> <span class="main">=</span>
    Scan.optional <span class="main">(</span>Args.parens <span class="main">(</span>Parse.list <span class="entity">option</span><span class="main">)</span> &gt;&gt;
      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">fs</span> <span class="main">=&gt;</span> fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">g</span> <span class="main">=&gt;</span> <span class="entity">f</span> o <span class="entity">g</span><span class="main">)</span> <span class="entity">fs</span> I<span class="main">)</span><span class="main">)</span> I
  
<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac_config_parser</span> <span class="main">=</span> <span class="entity">options</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">default_config</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pratt_Certificate_Code">
<div class="head">
<h1>Theory Pratt_Certificate_Code</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Pratt_Certificate_Code.thy
  Author:   Manuel Eberl, TU München

  Efficient checking of Pratt certificates using the code generator.
  Evaluation on some big examples.
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Pratt_Certificate_Code
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Pratt_Certificate.html">Pratt_Certificate</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Code generation for Pratt certificates›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following one-time setup is required to set up code generation for the certificate
  checking. Other theories importing this theories do not have to do this again.
›</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹
  Context.theory_map <span class="main">(</span><span class="entity">Pratt.setup_valid_cert_code_conv</span>
    <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">computation_check</span>
        <span class="quasi_keyword">terms</span><span class="main">:</span> <span class="quoted">Trueprop</span> <span class="quoted">valid_pratt_tree</span> <span class="quoted">"<span class="main">0</span><span class="main">::</span>nat"</span> <span class="quoted">"<span class="main">1</span><span class="main">::</span>nat"</span> <span class="quoted">"<span class="numeral">2</span><span class="main">::</span>nat"</span> <span class="quoted">"<span class="numeral">3</span><span class="main">::</span>nat"</span> <span class="quoted">"<span class="numeral">4</span><span class="main">::</span>nat"</span>
        <span class="quasi_keyword">datatypes</span><span class="main">:</span> <span class="quoted">"pratt_tree list"</span> <span class="quoted">"nat <span class="main">×</span> nat <span class="main">×</span> pratt_tree list"</span> <span class="quoted">nat</span><span class="antiquote">}</span></span></span></span></span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now evaluate the efficiency of the procedure on some examples.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">131059</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pratt</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">code</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">100000007</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pratt</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">code</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">8504276003</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pratt</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">code</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">52759926861157</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pratt</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">code</span><span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">39070009756439177203</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pratt</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">code</span><span class="main"><span class="main">)</span></span>
        <span class="quoted">‹{39070009756439177203, 2, 
           {2, {3, 2, {2}}, {197, 2, {2, {7, 3, {2, {3, 2, {2}}}}}}, 
            {11018051256751037, 2, {2, {19, 2, {2, {3, 2, {2}}}}, 
              {1249, 7, {2, {3, 2, {2}}, {13, 2, {2, {3, 2, {2}}}}}}, 
              {116072344789, 2, {2, {3, 2, {2}}, 
                {3067, 2, {2, {3, 2, {2}}, {7, 3, {2, {3, 2, {2}}}}, 
                  {73, 5, {2, {3, 2, {2}}}}}}, 
                {3153797, 2, {2, {788449, 11, 
                   {2, {3, 2, {2}}, {43, 3, 
                     {2, {3, 2, {2}}, {7, 3, {2, {3, 2, {2}}}}}}, 
                    {191, 19, {2, {5, 2, {2}}, {19, 2, {2, {3, 2, {2}}}}}}}}}}}}}}}}›</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">933491553728809239092563013853810654040043466297416456476877</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">pratt</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">code</span><span class="main"><span class="main">)</span></span>
        <span class="quoted">‹{933491553728809239092563013853810654040043466297416456476877, 
             2, {2, {38463351105299604725411, 6, 
               {2, {5, 2, {2}}, {13, 2, {2, {3, 2, {2}}}}, 
                {295871931579227728657, 5, 
                 {2, {3, 2, {2}}, {26041, 13, 
                   {2, {3, 2, {2}}, {5, 2, {2}}, {7, 3, {2, {3, 2, {2}}}}, 
                    {31, 3, {2, {3, 2, {2}}, {5, 2, {2}}}}}}, 
                  {29009, 3, {2, {7, 3, {2, {3, 2, {2}}}}, 
                    {37, 2, {2, {3, 2, {2}}}}}}, 
                  {39133, 5, {2, {3, 2, {2}}, 
                    {1087, 3, {2, {3, 2, {2}}, 
                      {181, 2, {2, {3, 2, {2}}, {5, 2, {2}}}}}}}}, 
                  {208511, 7, {2, {5, 2, {2}}, {29, 2, {2, {7, 3, {2, {3, 2, {2}}}}}}, 
                    {719, 11, {2, {359, 7, 
                       {2, {179, 2, {2, {89, 3, {2, {11, 2, {2, {5, 2, {2}}}}}}}}}}}}}}
                   }}}}, {6067409149902371339956289140415169329, 3, 
               {2, {11, 2, {2, {5, 2, {2}}}}, 
                {103, 5, {2, {3, 2, {2}}, {17, 3, {2}}}}, 
                {7955023343, 7, {2, {7, 3, {2, {3, 2, {2}}}}, 
                  {79, 3, {2, {3, 2, {2}}, {13, 2, {2, {3, 2, {2}}}}}}, 
                  {1451, 2, {2, {5, 2, {2}}, {29, 2, {2, {7, 3, {2, {3, 2, {2}}}}}}}}, 
                  {4957, 2, {2, {3, 2, {2}}, {7, 3, {2, {3, 2, {2}}}}, 
                    {59, 2, {2, {29, 2, {2, {7, 3, {2, {3, 2, {2}}}}}}}}}}}}, 
                {8108847767, 5, {2, {4054423883, 2, 
                   {2, {2027211941, 2, {2, {5, 2, {2}}, {13, 2, {2, {3, 2, {2}}}}, 
                      {29, 2, {2, {7, 3, {2, {3, 2, {2}}}}}}, 
                      {268861, 6, {2, {3, 2, {2}}, {5, 2, {2}}, 
                        {4481, 3, {2, {5, 2, {2}}, {7, 3, {2, {3, 2, {2}}}}}}}}}}}}}}, 
                {5188630976471, 13, {2, {5, 2, {2}}, 
                  {518863097647, 5, {2, {3, 2, {2}}, 
                    {67, 2, {2, {3, 2, {2}}, {11, 2, {2, {5, 2, {2}}}}}}, 
                    {17881, 7, {2, {3, 2, {2}}, {5, 2, {2}}, 
                      {149, 2, {2, {37, 2, {2, {3, 2, {2}}}}}}}}, 
                    {24061, 10, {2, {3, 2, {2}}, {5, 2, {2}}, 
                      {401, 3, {2, {5, 2, {2}}}}}}}}}}}}}}
›</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>