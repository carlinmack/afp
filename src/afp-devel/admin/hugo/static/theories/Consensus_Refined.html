<div id="Infra">
<div class="head">
<h1>Theory Infra</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Infra <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Prover configuration›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">declare</span></span> if_split_asm <span class="main">[</span><span class="operator">split</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Forward reasoning ("attributes")›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas are used to produce intro/elim rules from
set definitions and relation definitions.›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> set_def_to_intro <span class="main">=</span> eqset_imp_iff <span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> set_def_to_dest <span class="main">=</span> eqset_imp_iff <span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> set_def_to_elim <span class="main">=</span> set_def_to_dest <span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> setc_def_to_intro <span class="main">=</span> 
  set_def_to_intro <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">P</span>

<span class="keyword1"><span class="command">lemmas</span></span> setc_def_to_dest <span class="main">=</span> 
  set_def_to_dest <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">P</span>

<span class="keyword1"><span class="command">lemmas</span></span> setc_def_to_elim <span class="main">=</span> setc_def_to_dest <span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> rel_def_to_intro <span class="main">=</span> setc_def_to_intro <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">s</span> <span class="free">t</span>
<span class="keyword1"><span class="command">lemmas</span></span> rel_def_to_dest <span class="main">=</span> setc_def_to_dest <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">s</span> <span class="free">t</span>
<span class="keyword1"><span class="command">lemmas</span></span> rel_def_to_elim <span class="main">=</span> rel_def_to_dest <span class="main">[</span><span class="operator">elim_format</span><span class="main">]</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General results›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Maps›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We usually remove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">domIff</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from the simpset and clasets due
to annoying behavior. Sometimes the lemmas below are more well-behaved than 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">domIff</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Usually to be used as "dest: dom\_lemmas". However, adding 
them as permanent dest rules slows down proofs too much, so we refrain from 
doing this.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_definedness<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> dom <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_definedness_contra<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span><span class="main">;</span> <span class="free">z</span> <span class="main">∉</span> dom <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> dom_lemmas <span class="main">=</span> map_definedness map_definedness_contra


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Set›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">declare</span></span> image_comp<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>
<span class="comment1">(*
lemma image_comp [simp]: "(g o f)`A = g`f`A"
by (auto)
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> vimage_image_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">-`</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def vimage_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relations›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> Image_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span><span class="main">``</span><span class="free">A</span>  <span class="main">=</span> <span class="free">R2</span><span class="main">``</span><span class="main">(</span><span class="free">R1</span><span class="main">``</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_id<span class="main">:</span> <span class="quoted"><span class="quoted">"map id <span class="main">=</span> id"</span></span>      <span class="comment1">(* already in simpset *)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="comment1">― ‹Do NOT add the following equation to the simpset! (looping)›</span>
<span class="keyword1"><span class="command">lemma</span></span> map_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> map <span class="free">g</span> <span class="keyword1">o</span> map <span class="free">f</span>"</span></span>  
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> map_comp_map <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> take_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> take <span class="free">n</span> <span class="free">l</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs'</span><span class="main">.</span> <span class="free">l</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="bound">xs'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finite sets›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Cardinality.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> arg_cong <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">card</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span> 

<span class="keyword1"><span class="command">lemma</span></span> finite_positive_cardI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> card <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_positive_cardD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">0</span> <span class="main">&lt;</span> card <span class="free">A</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_zero_cardI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> card <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_zero_cardD <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> card <span class="free">A</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>





</pre>
</div><div id="Consensus_Types">
<div class="head">
<h1>Theory Consensus_Types</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Consensus_Types
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Consensus: types›</span></span>
<span class="keyword1"><span class="command">typedecl</span></span> process

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once we start taking maximums (e.g. in Last\_Voting), we will need the process set to be finite›</span></span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> process_finite<span class="main">:</span> 
  <span class="comment1">(* "class.finite TYPE(process)" *)</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>process<span class="main">,</span> finite_class<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> process <span class="main">::</span> <span class="quoted">finite</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> process_finite<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≡</span> card <span class="main">(</span>UNIV<span class="main">::</span>process set<span class="main">)</span>"</span></span>   <span class="comment1">― ‹number of processes›</span>

<span class="keyword1"><span class="command">typedecl</span></span> val     <span class="comment1">― ‹Type of values to choose from›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> round <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Quorums">
<div class="head">
<h1>Theory Quorums</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Quorums
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Consensus_Types.html">Consensus_Types</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quorums›</span></span>
<span class="comment1">(******************************************************************************)</span>


<span class="keyword1"><span class="command">locale</span></span> quorum <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Quorum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    qintersect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Q</span> <span class="main">∈</span> <span class="free">Quorum</span><span class="main">;</span> <span class="free">Q'</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">∩</span> <span class="free">Q'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="comment1">― ‹Non-emptiness needed for some invariants of Coordinated Voting›</span>
    <span class="keyword2"><span class="keyword">and</span></span> Quorum_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> quorum<span class="main">)</span> quorum_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> qintersect<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> quorum<span class="main">)</span> empty_not_quorum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> quorum_non_empty
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">locale</span></span> quorum_process <span class="main">=</span> quorum <span class="quoted"><span class="free">Quorum</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Quorum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"process set set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> mono_quorum <span class="main">=</span> quorum_process <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono_quorum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Q</span> <span class="main">∈</span> <span class="free">Quorum</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">Q'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mono_quorum<span class="main">)</span> UNIV_quorum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"UNIV <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Quorum_not_empty mono_quorum
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">majs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process set<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">majs</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">S</span><span class="main">.</span> card <span class="bound">S</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> majsI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">∈</span> majs"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> card_Compl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">-</span> card <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">S</span> <span class="main">+</span> card <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> card_Un_disjoint<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span><span class="free"><span class="free"><span class="free">S</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> Compl_partition<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> majorities_intersect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">Q</span> <span class="main">::</span> process set<span class="main">)</span> <span class="main">+</span> card <span class="free">Q'</span> <span class="main">&gt;</span> N <span class="main">⟹</span> <span class="free">Q</span> <span class="main">∩</span> <span class="free">Q'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_Un_disjoint card_mono finite not_le top_greatest<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> majorities<span class="main">:</span> mono_quorum <span class="quoted">majs</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="skolem">Q'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> majs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> majs"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∩</span> <span class="skolem">Q'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> majorities_intersect<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">∈</span> majs"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> div_less_dividend finite_UNIV_card_ge_0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="skolem">Q'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> majs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊆</span> <span class="skolem">Q'</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> majs"</span></span> <span class="keyword1"><span class="command">using</span></span> card_mono<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">Q</span> <span class="main">⊆</span> <span class="skolem">Q'</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Consensus_Misc">
<div class="head">
<h1>Theory Consensus_Misc</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Consensus_Misc
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous lemmas›</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> clarsimp_all <span class="main">=</span>
  <span class="quoted">‹<span class="entity">Method.sections</span> <span class="entity">clasimp_modifiers</span> &gt;&gt;
    K <span class="main">(</span><span class="entity">SIMPLE_METHOD</span> o CHANGED_PROP o <span class="entity">PARALLEL_ALLGOALS</span> o <span class="entity">clarsimp_tac</span><span class="main">)</span>›</span>
  <span class="quoted">"clarify simplified, all goals"</span>

<span class="keyword1"><span class="command">lemma</span></span> div_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Suc <span class="free">m</span> <span class="keyword1">div</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> Suc <span class="free">m</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Suc <span class="free">m</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Zero_not_Suc diff_Suc_Suc div_geq minus_mod_eq_mult_div mod_Suc mod_less neq0_conv nonzero_mult_div_cancel_left<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_Suc div_eq_0_iff minus_mod_eq_mult_div mod_Suc neq0_conv nonzero_mult_div_cancel_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flip</span> <span class="keyword2"><span class="keyword">where</span></span>
  flip_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">flip</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> option_expand'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">option</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">option'</span> <span class="main">=</span> None<span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="free">option</span> <span class="main">=</span> Some <span class="bound">x</span><span class="main">;</span> <span class="free">option'</span> <span class="main">=</span> Some <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> 
    <span class="free">option</span> <span class="main">=</span> <span class="free">option'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> option.expand<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(*********************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Argmax›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Max_by</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Max_by</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">=</span> Max <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_by_dest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max_by <span class="free">f</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">(</span>Max_by <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Max_by <span class="free">f</span> <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Max_by_def some_eq_ex<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_by_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max_by <span class="free">f</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Max_by_dest<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_by_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>Max_by <span class="free">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fin_image<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> fin_image this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> Max_by_dest<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> non_empty<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_UN_D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> finite <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Union_upper finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_by_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">cmp_f</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">cmp_f</span> <span class="free">x</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> in_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">cmp_f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max_by <span class="free">cmp_f</span> <span class="free">A</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> in_M<span class="main">:</span> <span class="quoted"><span class="quoted">"Max_by <span class="free">cmp_f</span> <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_by_in<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">cmp_f</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cmp_f</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max_by_ge assms<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">using</span></span> inj in_M in_X
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> Max_by_Union_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">A</span><span class="main">;</span> <span class="free">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="free">S</span><span class="main">;</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">S</span><span class="main">;</span> inj_on <span class="free">cmp_f</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> 
    Max_by <span class="free">cmp_f</span> <span class="free">A</span> <span class="main">=</span> Max_by <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Max_by_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">cmp_f</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_by_ge finite_UN_D<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def<span class="main">(</span>1<span class="main">)</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_by_ge finite_UnionD finite_imageI imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">cmp_f</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> image_is_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_UnionD finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max_by <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_by_in<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v0</span> <span class="bound">v1</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span> finite <span class="bound">v0</span> <span class="main">∨</span> <span class="bound">v0</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∨</span> Max_by <span class="main">(</span><span class="bound">v1</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="bound">v0</span> <span class="main">∈</span> <span class="bound">v0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Max_by_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v1</span><span class="main">.</span> <span class="bound">v1</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">∨</span> finite <span class="bound">v1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> finite_UN_D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2_13</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f1 assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max_by <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Max_by_UNION_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">A</span><span class="main">;</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="main">{}</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">;</span> inj_on <span class="free">cmp_f</span> <span class="free">A</span><span class="main">⟧</span> <span class="main">⟹</span> 
    Max_by <span class="free">cmp_f</span> <span class="free">A</span> <span class="main">=</span> Max_by <span class="free">cmp_f</span> <span class="main">(</span>Max_by <span class="free">cmp_f</span> <span class="main">`</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_by_Union_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_by_eta<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max_by <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_by_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_is_Max_by_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">S</span><span class="main">;</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> Max <span class="free">S</span> <span class="main">=</span> Max_by id <span class="free">S</span> "</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_by_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Max_in someI_ex<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">option_Max_by</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">option_Max_by</span> <span class="free"><span class="bound"><span class="entity">cmp_f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Max_by <span class="free"><span class="bound"><span class="entity">cmp_f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(*********************************)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function and map graphs›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_graph</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fun_graph</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_graph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_graph</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> Some <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> fun_graph <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_graph_mem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> map_graph <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def map_graph_def fun_graph_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fun_graph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span>fun_graph <span class="free">f</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> bij_betw_finite<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">f</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_graph_def bij_betw_def inj_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_map_graph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span>map_graph <span class="free">f</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_graph_def
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_fun_graph<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fun_graph <span class="free">f</span> <span class="main">∩</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"apsnd the"</span></span><span class="main"><span class="main">]</span></span> 
  <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_dom_finite_map_graph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>map_graph <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def map_graph_def fun_graph_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span> the <span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.sel<span class="main">)</span>

<span class="comment1">(*******************************************************************)</span>
<span class="keyword1"><span class="command">lemma</span></span> ran_map_addD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ran <span class="main">(</span><span class="free">m</span> <span class="main">++</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> ran <span class="free">m</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> ran <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constant maps›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">const_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'k</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span>map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">const_map</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">|`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> const_map_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"const_map <span class="free">v</span> <span class="main">{}</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> const_map_ran<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ran <span class="main">(</span>const_map <span class="free">v</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def ran_def restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> const_map_is_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>const_map <span class="free">y</span> <span class="free">A</span>  <span class="free">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∉</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> const_map_is_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>const_map <span class="free">y</span> <span class="free">A</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">z</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> const_map_in_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> const_map <span class="free">v</span> <span class="free">A</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> const_map_notin_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> const_map <span class="free">v</span> <span class="free">A</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_const_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="main">(</span>const_map <span class="free">v</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def<span class="main">)</span>

<span class="comment1">(*******************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Votes with maximum timestamps.›</span></span>
<span class="comment1">(*******************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vote_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'round</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'process</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span>map<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'process</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'round</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vote_set</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">|</span><span class="bound">a</span> <span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> map_graph <span class="main">(</span>case_prod <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_fst_vote_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on fst <span class="main">(</span>vote_set <span class="free">v_hist</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def vote_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_vote_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">r'</span></span><span class="main">≥</span><span class="main">(</span><span class="free">r</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="free">v_hist</span> <span class="bound">r'</span> <span class="main">=</span> Map.empty"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vote_set <span class="free">v_hist</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">|</span><span class="bound">r</span> <span class="bound">a</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> map_graph <span class="main">(</span>case_prod <span class="free">v_hist</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">p</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>map_graph <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="free">v_hist</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_graph_def fun_graph_def vs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">p</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span><span class="free">v_hist</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">r</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_graph_def fun_graph_def image_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_less_linear option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> I<span class="main">=</span>finite_subset<span class="main">[</span><span class="operator">OF</span> calculation<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> I assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nat_seg_image_imp_finite<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>    
    
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_graph_def fun_graph_def vote_set_def vs_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">r</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">r</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mru_of_set</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'round</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'process</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span>map<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'process</span> set<span class="main">,</span> <span class="tfree">'round</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span>map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mru_of_set</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">Q</span><span class="main">.</span> option_Max_by fst <span class="main">(</span>vote_set <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="bound">Q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">process_mru</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'round</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'process</span><span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span>map<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'process</span><span class="main">,</span> <span class="tfree">'round</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span>map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">process_mru</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> mru_of_set <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> process_mru_is_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>process_mru <span class="free">v_f</span> <span class="free">a</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>vote_set <span class="free">v_f</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_def mru_of_set_def option_Max_by_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> process_mru_is_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>process_mru <span class="free">v_f</span> <span class="free">a</span> <span class="main">=</span> Some <span class="free">rv</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>vote_set <span class="free">v_f</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">=</span> Max_by fst <span class="main">(</span>vote_set <span class="free">v_f</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_def mru_of_set_def option_Max_by_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vote_set_upd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vote_set <span class="main">(</span><span class="free">v_hist</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">v_f</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">=</span> 
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">∈</span> dom <span class="free">v_f</span> 
        <span class="keyword1">then</span> insert <span class="main">(</span><span class="free">r</span><span class="main">,</span> the <span class="main">(</span><span class="free">v_f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> id
      <span class="main">)</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">v_hist</span> <span class="free">r</span> <span class="free">p</span> <span class="main">=</span> None
        <span class="keyword1">then</span> vote_set <span class="free">v_hist</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>
        <span class="keyword1">else</span> vote_set <span class="free">v_hist</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">r</span><span class="main">,</span> the <span class="main">(</span><span class="free">v_hist</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
      <span class="main">)</span>
  "</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def const_map_is_Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_vote_set_upd<span class="main">:</span>
  <span class="quoted"><span class="quoted">" finite <span class="main">(</span>vote_set <span class="free">v_hist</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> 
    finite <span class="main">(</span>vote_set <span class="main">(</span><span class="free">v_hist</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">v_f</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_upd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vote_setD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">∈</span> vote_set <span class="free">v_f</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">v_f</span> <span class="main">(</span>fst <span class="free">rv</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> process_mru_new_votes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">≥</span> <span class="main">(</span><span class="free">r</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="free">v_hist</span> <span class="bound">r'</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"process_mru <span class="main">(</span><span class="free">v_hist</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">v_f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>process_mru <span class="free">v_hist</span> <span class="main">++</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> map_option <span class="main">(</span>Pair <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">v_f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> option_expand'<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">show</span></span>  
    <span class="quoted"><span class="quoted">"<span class="main">(</span>process_mru <span class="main">(</span><span class="free">v_hist</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">v_f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span>process_mru <span class="free">v_hist</span> <span class="main">++</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> map_option <span class="main">(</span>Pair <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">v_f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def restrict_map_def  const_map_is_None process_mru_is_None<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">rv</span> <span class="skolem">rv'</span>
  <span class="keyword3"><span class="command">assume</span></span> eqs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"process_mru <span class="main">(</span><span class="free">v_hist</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">v_f</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">rv</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>process_mru <span class="free">v_hist</span> <span class="main">++</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> map_option <span class="main">(</span>Pair <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">v_f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">rv'</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v_hist</span> <span class="main">(</span><span class="free">r</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rv</span> <span class="main">=</span> <span class="skolem">rv'</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> eqs assms 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_Some_iff const_map_is_Some const_map_is_None 
      process_mru_is_Some vote_set_upd <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vote_setD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_by_eqI
      finite_vote_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ccontr inj_on_fst_vote_set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Two_Steps">
<div class="head">
<h1>Theory Two_Steps</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Two_Steps
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Consensus_Misc.html">Consensus_Misc</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Step definitions for 2-step algorithms›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">two_phase</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">two_phase</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">two_step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">two_step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> two_phase_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"two_phase <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_phase_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> two_step_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_step_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> two_phase_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>two_phase <span class="free">r</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> two_step <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_phase_def two_step_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> two_step_phase_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> two_phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> two_phase <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> two_step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> two_phase <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>two_phase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> two_phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>two_phase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> two_step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_step_def two_phase_def mod_Suc div_Suc<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Three_Steps">
<div class="head">
<h1>Theory Three_Steps</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Three_Steps
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Consensus_Misc.html">../Consensus_Misc</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Step definitions for 3-step algorithms›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">nr_steps</span> <span class="main">≡</span> <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">three_phase</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">three_phase</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">div</span> nr_steps"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">three_step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">three_step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">mod</span> nr_steps"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> three_phase_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"three_phase <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_phase_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> three_step_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> three_phase_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>three_phase <span class="free">r</span> <span class="main">*</span> nr_steps<span class="main">)</span> <span class="main">+</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_phase_def three_step_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> three_step_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> three_step <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> three_step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> three_step <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> three_step <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> three_step <span class="main">(</span><span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> three_step_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> three_step_phase_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> three_phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> three_phase <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> three_phase <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> three_phase <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> three_phase <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>three_phase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> three_phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> three_phase <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> three_phase <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>three_phase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> three_phase <span class="main">(</span>Suc <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>three_phase <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step_def three_phase_def mod_Suc div_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> three_step2_phase_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"three_step <span class="free">r</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="main">(</span>three_phase <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step_def three_phase_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_2_eq_Suc' mult_div_mod_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> three_stepE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">;</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> three_step_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Refinement">
<div class="head">
<h1>Theory Refinement</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Models, Invariants and Refinements›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Refinement <span class="keyword2"><span class="keyword">imports</span></span> <a href="Infra.html">Infra</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specifications, reachability, and behaviours.›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transition systems are multi-pointed graphs.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'s</span> TS <span class="main">=</span> 
  init <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The inductive set of reachable states.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">reach</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  r_init <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> init <span class="free">T</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span> <span class="free">T</span>"</span></span>
<span class="main">|</span> r_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">T</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">reach</span> <span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> <span class="free">reach</span> <span class="free">T</span>"</span></span>

<span class="comment1">(* inductive_cases reach_invert: "t ∈ reach T" *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finite behaviours›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that behaviours grow at the head of the list, i.e., the initial 
state is at the end.›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">beh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> list<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  b_empty <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span>"</span></span>
<span class="main">|</span> b_init <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> init <span class="free">T</span> <span class="main">⟹</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span>"</span></span>
<span class="main">|</span> b_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> <span class="free">beh</span> <span class="free">T</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> beh_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">#</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Behaviours are prefix closed.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> beh_immediate_prefix_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">#</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> beh_non_empty<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> beh_prefix_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">@</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> beh_immediate_prefix_closed<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹States in behaviours are exactly reachable.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> beh_in_reach <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> beh <span class="free">T</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">b</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> reach <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> beh.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> reach_in_beh<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> reach <span class="free">T</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> beh <span class="free">T</span><span class="main">.</span> <span class="free">s</span> <span class="main">∈</span> set <span class="bound">b</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_init <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bexI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_trans <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> r_trans<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">b0</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b1</span> <span class="main">@</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b0</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> beh_prefix_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">#</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b0</span> <span class="main">∈</span> beh <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">T</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_equiv_beh_states<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">T</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">∈</span>beh <span class="free">T</span><span class="main">.</span> set <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_in_beh beh_in_reach<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consecutive states in a behavior are connected by the transition relation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> beh_consecutive_in_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> beh <span class="free">TS</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> Suc <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">b</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">TS</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">b</span> <span class="main">@</span> <span class="free">t</span> <span class="main">#</span> <span class="free">s</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>    
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_take_nth_drop Cons_nth_drop_Suc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> beh_non_empty beh_prefix_closed list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Specifications, observability, and implementation›</span></span> 
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Specifications add an observer function to transition systems.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> TS"</span></span> <span class="main">+</span>
  obs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> beh_obs_upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"beh <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">x</span> <span class="main">|)</span><span class="main">)</span> <span class="main">=</span> beh <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> beh.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_obs_upd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">x</span> <span class="main">|)</span><span class="main">)</span> <span class="main">=</span> reach <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observable behaviour and reachability.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">obeh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'o</span> list<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obeh</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="main">(</span>obs <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>beh <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">oreach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec <span class="main">⇒</span> <span class="tfree">'o</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">oreach</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span>obs <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">`</span><span class="main">(</span>reach <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> oreach_equiv_obeh_states<span class="main">:</span> <span class="quoted"><span class="quoted">"oreach <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">b</span><span class="main">∈</span>obeh <span class="free">S</span><span class="main">.</span> set <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_equiv_beh_states oreach_def obeh_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> obeh_pi_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">pi</span><span class="main">)</span><span class="main">`</span><span class="main">(</span>obeh <span class="free">S</span><span class="main">)</span> <span class="main">=</span> obeh <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">pi</span> <span class="keyword1">o</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obeh_def image_comp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> oreach_pi_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">pi</span><span class="main">`</span><span class="main">(</span>oreach <span class="free">S</span><span class="main">)</span> <span class="main">=</span> oreach <span class="main">(</span><span class="free">S</span><span class="main">(|</span> obs <span class="main">:=</span> <span class="free">pi</span> <span class="keyword1">o</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A predicate $P$ on the states of a specification is \emph{observable} 
if it cannot distinguish between states yielding the same observation. 
Equivalently, $P$ is observable if it is the inverse image under the 
observation function of a predicate on observations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">observable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observable</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="bound">s</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">observable2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observable2</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">-`</span><span class="bound">Q</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">observable3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observable3</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">-`</span><span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>    <span class="comment1">― ‹other direction holds trivially›</span>

<span class="keyword1"><span class="command">lemma</span></span> observableE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>observable <span class="free">ob</span> <span class="free">P</span><span class="main">;</span> <span class="free">ob</span> <span class="free">s</span> <span class="main">=</span> <span class="free">ob</span> <span class="free">s'</span><span class="main">;</span> <span class="free">s'</span> <span class="main">∈</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> observable_def<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> observable2_equiv_observable<span class="main">:</span> <span class="quoted"><span class="quoted">"observable2 <span class="free">ob</span> <span class="free">P</span> <span class="main">=</span> observable <span class="free">ob</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> observable_def observable2_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> observable3_equiv_observable2<span class="main">:</span> <span class="quoted"><span class="quoted">"observable3 <span class="free">ob</span> <span class="free">P</span> <span class="main">=</span> observable2 <span class="free">ob</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> observable3_def observable2_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> observable_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"observable id <span class="free">P</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> observable_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set extension of a function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ob</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the left adjoint of 
a Galois connection on the powerset lattices over domain and range of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ob</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
where the right adjoint is the inverse image function.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> image_vimage_adjoints<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ob</span><span class="main">`</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">ob</span><span class="main">-`</span><span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> image_vimage_subset <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> vimage_image_subset <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similar but "reversed" (wrt to adjointness) relationships only hold under
additional conditions.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> image_r_vimage_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">ob</span><span class="main">`</span><span class="free">P</span><span class="main">;</span> observable <span class="free">ob</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ob</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vimage_l_image_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ob</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊆</span> range <span class="free">ob</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">ob</span><span class="main">`</span><span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> image_mono <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ob</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Internal and external invariants›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> external_from_internal_invariant<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">`</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟧</span>  
  <span class="main">⟹</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_from_internal_invariant_vimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊆</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⟧</span>
  <span class="main">⟹</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> external_from_internal_invariant<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> external_to_internal_invariant_vimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oreach_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_to_internal_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">`</span><span class="free">P</span><span class="main">;</span> observable <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> external_to_internal_invariant_vimage<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> external_equiv_internal_invariant_vimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> external_from_internal_invariant_vimage
                external_to_internal_invariant_vimage 
         <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_equiv_internal_invariant<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span><span class="main">`</span><span class="free">P</span> <span class="main">=</span> <span class="free">Q</span><span class="main">;</span> observable <span class="main">(</span>obs <span class="free">S</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">(</span>oreach <span class="free">S</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_equiv_internal_invariant_vimage<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our notion of implementation is inclusion of observable behaviours.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">implements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> spec<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">implements</span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">≡</span> <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">pi</span></span></span><span class="main">)</span><span class="main">`</span><span class="main">(</span>obeh <span class="free"><span class="bound"><span class="entity">Sc</span></span></span><span class="main">)</span> <span class="main">⊆</span> obeh <span class="free"><span class="bound"><span class="entity">Sa</span></span></span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implements_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"implements id <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> implements_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> implements <span class="free">pi1</span> <span class="free">S1</span> <span class="free">S2</span><span class="main">;</span> implements <span class="free">pi2</span> <span class="free">S2</span> <span class="free">S3</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> implements <span class="main">(</span><span class="free">pi1</span> <span class="keyword1">o</span> <span class="free">pi2</span><span class="main">)</span> <span class="free">S1</span> <span class="free">S3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def image_comp <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> image_mono <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map <span class="free">pi1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of external invariants›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implements_oreach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> <span class="free">pi</span><span class="main">`</span><span class="main">(</span>oreach <span class="free">Sc</span><span class="main">)</span> <span class="main">⊆</span> oreach <span class="free">Sa</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def oreach_equiv_obeh_states <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_invariant_preservation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">pi</span><span class="main">`</span><span class="main">(</span>oreach <span class="free">Sc</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> implements_oreach<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> external_invariant_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> oreach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> <span class="free">pi</span><span class="main">-`</span><span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span>
  <span class="main">⟹</span> oreach <span class="free">Sc</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> vimage_image_subset<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">pi</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">pi</span></span><span class="main"><span class="main">-`</span></span><span class="free"><span class="free">Q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> vimage_mono external_invariant_preservation<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Preservation of internal invariants›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> internal_invariant_translation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reach <span class="free">Sa</span> <span class="main">⊆</span> <span class="free">Pa</span><span class="main">;</span> <span class="free">Pa</span> <span class="main">⊆</span> obs <span class="free">Sa</span> <span class="main">-`</span> <span class="free">Qa</span><span class="main">;</span> <span class="free">pi</span> <span class="main">-`</span> <span class="free">Qa</span> <span class="main">⊆</span> <span class="free">Q</span><span class="main">;</span> obs <span class="free">S</span> <span class="main">-`</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span>
     implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">S</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">S</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> external_from_internal_invariant_vimage <span class="main"><span class="main">[</span></span>
      <span class="operator">THEN</span> external_invariant_translation<span class="main"><span class="main">,</span></span> 
      <span class="operator">THEN</span> external_to_internal_invariant_vimage<span class="main"><span class="main">]</span></span><span class="main">)</span> 
   <span class="main">(</span><span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>



<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we define Hoare triples over transition relations and then
we derive proof rules to establish invariants.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Hoare triples›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">PO_hoare</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set<span class="main">,</span> <span class="tfree">'s</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
     <span class="main">(</span><span class="quoted">"<span class="keyword3">(3</span><span class="keyword1">{</span>_<span class="keyword1">}</span> _ <span class="keyword1">{&gt;</span> _<span class="keyword1">}</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 90<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main"><span class="free">{&gt;</span></span> <span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_hoare_defs <span class="main">=</span> PO_hoare_def Image_def

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoareD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">I</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span><span class="free">J</span><span class="main">}</span><span class="main">;</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">I</span><span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s'</span> <span class="main">∈</span> <span class="free">J</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some essential facts about Hoare triples.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_conseq_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">P'</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊆</span> <span class="free">P'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_conseq_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q'</span><span class="main">}</span><span class="main">;</span> <span class="free">Q'</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_false_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_true_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> UNIV<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_conj_right <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q1</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q2</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="main">{&gt;</span> <span class="free">Q1</span> <span class="main">∩</span> <span class="free">Q2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Special transition relations.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_stop <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">{}</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_skip <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> Id <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_trans_Un <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R1</span> <span class="main">∪</span> <span class="free">R2</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R1</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">∧</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R2</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hoare_trans_UN <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">⋃</span> <span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="free">R</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">Q</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Characterization of reachability›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_init<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟹</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">{</span>reach <span class="free">T</span><span class="main">}</span> trans <span class="free">T</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful consequences.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> init_reach <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"init <span class="free">T</span> <span class="main">⊆</span> reach <span class="free">T</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> trans_reach <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>reach <span class="free">T</span><span class="main">}</span> trans <span class="free">T</span> <span class="main">{&gt;</span> reach <span class="free">T</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reach_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant proof rules›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic proof rule for invariants.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rule_basic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">P</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹General invariant proof rule. This rule is complete (set 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">I</span></span> <span class="main"><span class="main">=</span></span> reach <span class="free"><span class="free">T</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>              <span class="comment1">― ‹strengthen goal›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rule is equivalent to the previous one.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> INV_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> reach <span class="free">T</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> reach.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proof of equivalence.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rule_from_INV_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> INV_rule_from_inv_rule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> reach <span class="free">T</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> I<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> reach <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> inv_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Incremental proof rule for invariants using auxiliary invariant(s). 
This rule might have become obsolete by addition of $INV\_rule$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rule_incr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">T</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟧</span>    
  <span class="main">⟹</span> reach <span class="free">T</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our notion of refinement is simulation. We first define a general
notion of relational Hoare tuple, which we then use to define the refinement
proof obligation.  Finally, we show that observation-consistent refinement 
of specifications implies the implementation relation between them.›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relational Hoare tuples›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Relational Hoare tuples formalize the following generalized simulation 
diagram:

\begin{verbatim}
                           o -- Ra --&gt; o
                           |           |
                          pre         post
                           |           |
                           v           V
                           o -- Rc --&gt; o
\end{verbatim}

Here, $Ra$ and $Rc$ are the abstract and concrete transition relations, 
and $pre$ and $post$ are the pre- and post-relations.
(In the definiton below, the operator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(O)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> stands for relational 
composition, which is defined as follows: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> relcomp_def <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.)›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">PO_rhoare</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
     <span class="main">(</span><span class="quoted">"<span class="keyword3">(4</span><span class="keyword1">{</span>_<span class="keyword1">}</span> _<span class="keyword1">,</span> _ <span class="keyword1">{&gt;</span> _<span class="keyword1">}</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 90<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">pre</span></span></span><span class="main"><span class="free">}</span></span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Rc</span></span></span> <span class="main"><span class="free">{&gt;</span></span> <span class="free"><span class="bound"><span class="entity">post</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">pre</span></span></span> <span class="keyword1">O</span> <span class="free"><span class="bound"><span class="entity">Rc</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Ra</span></span></span> <span class="keyword1">O</span> <span class="free"><span class="bound"><span class="entity">post</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> PO_rhoare_defs <span class="main">=</span> PO_rhoare_def relcomp_unfold


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Facts about relational Hoare tuples.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_conseq_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre'</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">;</span> <span class="free">pre</span> <span class="main">⊆</span> <span class="free">pre'</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_conseq_right<span class="main">:</span>                    <span class="comment1">― ‹do NOT declare [intro]›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post'</span><span class="main">}</span><span class="main">;</span> <span class="free">post'</span> <span class="main">⊆</span> <span class="free">post</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_false_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>               <span class="comment1">― ‹do NOT declare [intro]›</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">{}</span> <span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_true_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>                <span class="comment1">― ‹not true in general›</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> UNIV<span class="main">}</span> <span class="main">=</span> <span class="main">(</span>Domain <span class="main">(</span><span class="free">pre</span> <span class="keyword1">O</span> <span class="free">Rc</span><span class="main">)</span> <span class="main">⊆</span> Domain <span class="free">Ra</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Domain_rel_comp <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Domain <span class="free">pre</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">⟹</span> Domain <span class="main">(</span><span class="free">pre</span> <span class="keyword1">O</span> <span class="free">Rc</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Domain_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_hoare_skip <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">R</span><span class="main">}</span> Id<span class="main">,</span> Id <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and transitivity.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Id<span class="main">}</span> <span class="free">R</span><span class="main">,</span> <span class="free">R</span> <span class="main">{&gt;</span> Id<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rhoare_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">R1</span><span class="main">}</span> <span class="free">T1</span><span class="main">,</span> <span class="free">T2</span> <span class="main">{&gt;</span> <span class="free">R1</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span><span class="free">R2</span><span class="main">}</span> <span class="free">T2</span><span class="main">,</span> <span class="free">T3</span> <span class="main">{&gt;</span> <span class="free">R2</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">}</span> <span class="free">T1</span><span class="main">,</span> <span class="free">T3</span> <span class="main">{&gt;</span> <span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subset_refl <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> relcomp_mono<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> subset_refl <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> <span class="main"><span class="main">[</span></span>2<span class="main"><span class="main">]</span></span> relcomp_mono<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">R2</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> O_assoc <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Conjunction in the post-relation cannot be split in general.  However, 
here are two useful special cases.  In the first case the abstract transtition 
relation is deterministic and in the second case one conjunct is a cartesian 
product of two state predicates.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_conj_right_det<span class="main">:</span>                 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post1</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post2</span><span class="main">}</span><span class="main">;</span>
     single_valued <span class="free">Ra</span> <span class="main">⟧</span>                           <span class="comment1">― ‹only for deterministic <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Ra›</span></span>!›</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post1</span> <span class="main">∩</span> <span class="free">post2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_conj_right_cartesian <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span>Domain <span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span>Range <span class="free">pre</span><span class="main">}</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs PO_hoare_defs Domain_def Range_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Separate rule for cartesian products.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> relhoare_cartesian<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span>Domain <span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> <span class="main">{</span>Range <span class="free">pre</span><span class="main">}</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>                      <span class="comment1">― ‹any <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>post›</span></span>, including <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>UNIV›</span></span>!›</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> relhoare_conseq_right<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Unions of transition relations.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_concrete_Un <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc1</span> <span class="main">∪</span> <span class="free">Rc2</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> 
   <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc1</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">∧</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc2</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_concrete_UN <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Rc</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span><span class="main">,</span> <span class="free">Rc</span> <span class="bound">x</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_abstract_Un_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra1</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra1</span> <span class="main">∪</span> <span class="free">Ra2</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_abstract_Un_right <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra2</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra1</span> <span class="main">∪</span> <span class="free">Ra2</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relhoare_abstract_UN <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>   <span class="comment1">― ‹might be too aggressive?›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="free">Ra</span> <span class="free">x</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">pre</span><span class="main">}</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Ra</span> <span class="bound">x</span><span class="main">,</span> <span class="free">Rc</span> <span class="main">{&gt;</span> <span class="free">post</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement proof obligations›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A transition system refines another one if the initial states and the
transitions are refined. 
Initial state refinement means that for each concrete initial state there is 
a related abstract one. Transition refinement means that the simulation 
relation is preserved (as expressed by a relational Hoare tuple). 
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">PO_refines</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> TS_scheme<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> TS_scheme<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">PO_refines</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Ta</span></span></span> <span class="free"><span class="bound"><span class="entity">Tc</span></span></span> <span class="main">≡</span> <span class="main">(</span>
       init <span class="free"><span class="bound"><span class="entity">Tc</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">``</span><span class="main">(</span>init <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span> <span class="main">(</span>trans <span class="free"><span class="bound"><span class="entity">Ta</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free"><span class="bound"><span class="entity">Tc</span></span></span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span> 
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Basic refinement rule. This is just an introduction rule for the
definition.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refine_basic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> <span class="main">{</span><span class="free">R</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following proof rule uses individual invariants <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">J</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the concrete and abstract systems to strengthen the 
simulation relation $R$. 

The hypotheses state that these state predicates are indeed invariants.
Note that the pre-condition of the invariant preservation hypotheses for 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">J</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are strengthened by adding the predicates 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Domain <span class="main"><span class="main">(</span></span><span class="free"><span class="free">R</span></span> <span class="main"><span class="main">∩</span></span> UNIV <span class="main"><span class="main">×</span></span> <span class="free"><span class="free">J</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Range <span class="main"><span class="main">(</span></span><span class="free"><span class="free">R</span></span> <span class="main"><span class="main">∩</span></span> <span class="free"><span class="free">I</span></span> <span class="main"><span class="main">×</span></span> UNIV<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
respectively.  In particular, the latter predicate may be essential, if a 
concrete invariant depends on the simulation relation and an abstract invariant, 
i.e. to "transport" abstract invariants to the concrete system.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refine_init_using_invariants<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> init <span class="free">Ta</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟧</span>
  <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">)</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> refine_trans_using_invariants<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="free">J</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> 
     <span class="main">{</span><span class="free">J</span> <span class="main">∩</span> Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span>  <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> relhoare_conj_right_cartesian<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is our main rule for refinements.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refine_using_invariants<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">R</span><span class="main">}</span><span class="main">;</span>
     <span class="main">{</span><span class="free">I</span> <span class="main">∩</span> Domain <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="free">J</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Ta</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span><span class="main">;</span> 
     <span class="main">{</span><span class="free">J</span> <span class="main">∩</span> Range <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">}</span> <span class="main">(</span>trans <span class="free">Tc</span><span class="main">)</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span><span class="main">;</span> 
     init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span><span class="main">``</span><span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span><span class="main">;</span> 
     init <span class="free">Ta</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">;</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">J</span> <span class="main">⟧</span>
  <span class="main">⟹</span> PO_refines <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">×</span> <span class="free">J</span><span class="main">)</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> PO_refines_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">intro</span> refine_init_using_invariants refine_trans_using_invariants conjI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Deriving invariants from refinements›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some invariants can only be proved after the simulation has been 
established, because they depend on the simulation relation and some abstract
invariants.  Here is a rule to derive invariant theorems from the refinement.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_implies_Range_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> Range <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_implies_Range_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> <span class="main">{</span>Range <span class="free">R</span><span class="main">}</span> trans <span class="free">Tc</span> <span class="main">{&gt;</span> Range <span class="free">R</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def PO_rhoare_def PO_hoare_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_implies_Range_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> reach <span class="free">Tc</span> <span class="main">⊆</span> Range <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_refines_implies_Range_init 
                 PO_refines_implies_Range_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rules are more useful in proofs.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> INV_init_from_refinement<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span>
  <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> PO_refines_implies_Range_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> INV_trans_from_refinement<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> <span class="free">K</span> <span class="main">⊆</span> Range <span class="free">R</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">{</span><span class="free">K</span><span class="main">}</span> trans <span class="free">Tc</span> <span class="main">{&gt;</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> PO_refines_implies_Range_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> hoare_conseq_right<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> INV_from_refinement<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">⟧</span>
  <span class="main">⟹</span> reach <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> PO_refines_implies_Range_invariant<span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Transfering abstract invariants to concrete systems›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemmas</span></span> hoare_conseq <span class="main">=</span> hoare_conseq_right<span class="main">[</span><span class="operator">OF</span> hoare_conseq_left<span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">P'</span> <span class="free">R</span> <span class="free">Q'</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_implies_R_image_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span> <span class="main">⟹</span> init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">``</span> <span class="main">(</span>init <span class="free">Ta</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">R</span></span> <span class="main"><span class="main">``</span></span> init <span class="free"><span class="free">Ta</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> commute_dest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">R</span> <span class="keyword1">O</span> <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">Ta</span> <span class="keyword1">O</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free">sa</span><span class="main">,</span> <span class="free">sc</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free">sc</span><span class="main">,</span> <span class="free">sc'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Tc</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="free">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ta</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> <span class="free">sc'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_implies_R_image_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">R</span> <span class="main">``</span> reach <span class="free">Ta</span><span class="main">}</span> trans <span class="free">Tc</span> <span class="main">{&gt;</span> <span class="free">R</span> <span class="main">``</span> reach <span class="free">Ta</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> PO_hoare_def Image_def PO_refines_def PO_rhoare_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">sa</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> TS.trans <span class="free">Tc</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sa_reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> reach <span class="free">Ta</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans_ref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="keyword1">O</span> trans <span class="free">Tc</span> <span class="main">⊆</span> trans <span class="free">Ta</span> <span class="keyword1">O</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> commute_dest<span class="main">[</span><span class="operator">OF</span> trans_ref R step<span class="main">]</span> sa_reach
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">sa'</span><span class="main">∈</span>reach <span class="free">Ta</span><span class="main">.</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_implies_R_image_invariant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">``</span> reach <span class="free">Ta</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> INV_rule<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">``</span> reach <span class="free">Ta</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> PO_refines_implies_R_image_init<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">R</span> <span class="main">``</span> reach <span class="free">Ta</span> <span class="main">∩</span> reach <span class="free">Tc</span><span class="main">}</span> TS.trans <span class="free">Tc</span> <span class="main">{&gt;</span> <span class="free">R</span> <span class="main">``</span> reach <span class="free">Ta</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> PO_refines_implies_R_image_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_INV_init_transfer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
    <span class="quoted"><span class="quoted">"init <span class="free">Ta</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"init <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">``</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PO_refines_implies_R_image_init<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subset_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Image_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_INV_trans_transfer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ref<span class="main">:</span> <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> abs_hoare<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">I</span><span class="main">}</span> trans <span class="free">Ta</span> <span class="main">{&gt;</span> <span class="free">J</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">R</span> <span class="main">``</span> <span class="free">I</span><span class="main">}</span> trans <span class="free">Tc</span> <span class="main">{&gt;</span> <span class="free">R</span> <span class="main">``</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> PO_hoare_def Image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">sa</span>
  <span class="keyword3"><span class="command">assume</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">Tc</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> abs_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ref step <span class="keyword2"><span class="keyword">and</span></span> R <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    abs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">Ta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> R'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def PO_rhoare_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> hoareD<span class="main">[</span><span class="operator">OF</span> abs_hoare abs_inv abs_step<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">∈</span><span class="free">J</span><span class="main">.</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> abs_INV_transfer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span>
    <span class="quoted"><span class="quoted">"reach <span class="free">Ta</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">Tc</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">``</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PO_refines_implies_R_image_invariant<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement of specifications›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lift relation membership to finite sequences›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> 
  <span class="entity">seq_lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> list <span class="main">×</span> <span class="tfree">'t</span> list<span class="main">)</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  sl_nil <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq_lift</span> <span class="free">R</span>"</span></span>
<span class="main">|</span> sl_cons <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq_lift</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq_lift</span> <span class="free">R</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> sl_cons_right_invert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ba'</span><span class="main">,</span> <span class="free">t</span> <span class="main">#</span> <span class="free">bc</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span>"</span></span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For each concrete behaviour there is a related abstract one.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> behaviour_refinement<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PO_refines <span class="free">R</span> <span class="free">Ta</span> <span class="free">Tc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bc</span> <span class="main">∈</span> beh <span class="free">Tc</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ba</span> <span class="main">∈</span> beh <span class="free">Ta</span><span class="main">.</span> <span class="main">(</span><span class="bound">ba</span><span class="main">,</span> <span class="free">bc</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beh.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> b_empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>b_init <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>b_trans <span class="skolem">s</span> <span class="skolem">b</span> <span class="skolem">s'</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> b_trans<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">#</span> <span class="skolem">c</span> <span class="main">∈</span> beh <span class="free">Ta</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sl_cons_right_invert<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> TS.trans <span class="free">Tc</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> trans <span class="free">Ta</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def PO_rhoare_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">t</span> <span class="main">#</span> <span class="skolem">c</span> <span class="main">∈</span> beh <span class="free">Ta</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">t</span> <span class="main">#</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">s'</span> <span class="main">#</span> <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Observation consistency of a relation is defined using a mediator 
function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">pi</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to abstract the concrete observation.  This allows us 
to also refine the observables as we move down a refinement branch.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">obs_consistent</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> spec<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obs_consistent</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="main">(</span>obs <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> obs <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_refl <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"obs_consistent Id id <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_trans <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> obs_consistent <span class="free">R1</span> <span class="free">pi1</span> <span class="free">S1</span> <span class="free">S2</span><span class="main">;</span> obs_consistent <span class="free">R2</span> <span class="free">pi2</span> <span class="free">S2</span> <span class="free">S3</span> <span class="main">⟧</span>
  <span class="main">⟹</span> obs_consistent <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="main">(</span><span class="free">pi1</span> <span class="keyword1">o</span> <span class="free">pi2</span><span class="main">)</span> <span class="free">S1</span> <span class="free">S3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"obs_consistent <span class="main">{}</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_conj1 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> obs_consistent <span class="main">(</span><span class="free">R</span> <span class="main">∩</span> <span class="free">R'</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_conj2 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> obs_consistent <span class="main">(</span><span class="free">R'</span> <span class="main">∩</span> <span class="free">R</span><span class="main">)</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> obs_consistent_behaviours<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="free">bc</span> <span class="main">∈</span> beh <span class="free">Sc</span><span class="main">;</span> <span class="free">ba</span> <span class="main">∈</span> beh <span class="free">Sa</span><span class="main">;</span> <span class="main">(</span><span class="free">ba</span><span class="main">,</span> <span class="free">bc</span><span class="main">)</span> <span class="main">∈</span> seq_lift <span class="free">R</span><span class="main">⟧</span>
  <span class="main">⟹</span> map <span class="free">pi</span> <span class="main">(</span>map <span class="main">(</span>obs <span class="free">Sc</span><span class="main">)</span> <span class="free">bc</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>obs <span class="free">Sa</span><span class="main">)</span> <span class="free">ba</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> seq_lift.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_consistent_def<span class="main">)</span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of refinement proof obligations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">refines</span> <span class="main">::</span> 
    <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'t</span><span class="main">)</span> set<span class="main">,</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'o</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'o</span><span class="main">)</span> spec<span class="main">,</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'p</span><span class="main">)</span> spec<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">refines</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">≡</span> obs_consistent <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pi</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span> <span class="main">∧</span> PO_refines <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">Sa</span></span></span> <span class="free"><span class="bound"><span class="entity">Sc</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> refines_defs <span class="main">=</span> 
  refines_def PO_refines_def

<span class="keyword1"><span class="command">lemma</span></span> refinesI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> PO_refines <span class="free">R</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> obs_consistent <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟧</span>
  <span class="main">⟹</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> PO_refines_from_refines<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> PO_refines <span class="free">R</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity and transitivity of refinement.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> refinement_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"refines Id id <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> refinement_transitive<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R1</span> <span class="free">pi1</span> <span class="free">S1</span> <span class="free">S2</span><span class="main">;</span> refines <span class="free">R2</span> <span class="free">pi2</span> <span class="free">S2</span> <span class="free">S3</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> refines <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="main">(</span><span class="free">pi1</span> <span class="keyword1">o</span> <span class="free">pi2</span><span class="main">)</span> <span class="free">S1</span> <span class="free">S3</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_defs <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rhoare_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Image_mono<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Soundness of refinement for proving implementation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> observable_behaviour_refinement<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span><span class="main">;</span> <span class="free">bc</span> <span class="main">∈</span> obeh <span class="free">Sc</span> <span class="main">⟧</span> <span class="main">⟹</span> map <span class="free">pi</span> <span class="free">bc</span> <span class="main">∈</span> obeh <span class="free">Sa</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refines_def obeh_def image_def
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> behaviour_refinement obs_consistent_behaviours<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> refinement_soundness<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"refines <span class="free">R</span> <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span> <span class="main">⟹</span> implements <span class="free">pi</span> <span class="free">Sa</span> <span class="free">Sc</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> implements_def 
         <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> observable_behaviour_refinement<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extended versions of proof rules including observations›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Refinement_basic <span class="main">=</span> refine_basic <span class="main">[</span><span class="operator">THEN</span> refinesI<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> Refinement_using_invariants <span class="main">=</span> refine_using_invariants <span class="main">[</span><span class="operator">THEN</span> refinesI<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> INV_init_from_Refinement <span class="main">=</span> 
  INV_init_from_refinement <span class="main">[</span><span class="operator">OF</span> PO_refines_from_refines<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> INV_trans_from_Refinement <span class="main">=</span> 
  INV_trans_from_refinement <span class="main">[</span><span class="operator">OF</span> PO_refines_from_refines<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> INV_from_Refinement <span class="main">=</span> 
  INV_from_refinement <span class="main">[</span><span class="operator">OF</span> PO_refines_from_refines<span class="main">]</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HO_Transition_System">
<div class="head">
<h1>Theory HO_Transition_System</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> HO_Transition_System
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/HOModel.html">Heard_Of.HOModel</a> <a href="Refinement.html">Refinement</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition system semantics for HO models›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The HO development already defines two trace semantics for algorithms in this model, the
coarse- and fine-grained ones. However, both of these are defined on infinite traces. Since the
semantics of our transition systems are defined on finite traces, we also provide such a semantics
for the HO model. Since we only use refinement for safety properties, the result also extend to
infinite traces (although we do not prove this in Isabelle).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CHO_trans</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">CHO_trans</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="main">=</span> 
  <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">r</span> <span class="bound">r'</span> <span class="bound">st</span> <span class="bound">st'</span><span class="main">.</span>
      <span class="bound">r'</span> <span class="main">=</span> Suc <span class="bound">r</span>
      <span class="main">∧</span> CSHOnextConfig <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">r</span> <span class="bound">st</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">st'</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CHO_to_TS</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> CHOAlgorithm 
  <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> coord<span class="main">)</span> 
  <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span><span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span><span class="main">)</span><span class="main">)</span> TS"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CHO_to_TS</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    init <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">|</span><span class="bound">st</span><span class="main">.</span> CHOinitConfig <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">st</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
    trans <span class="main">=</span> CHO_trans <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coord</span></span></span>
  <span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_msgs</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span> <span class="main">⇒</span> <span class="tfree">'msg</span><span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span><span class="main">)</span>
  <span class="main">⇒</span> <span class="tfree">'proc</span> HO
  <span class="main">⇒</span> <span class="tfree">'proc</span> HO
  <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'proc</span> <span class="main">⇀</span> <span class="tfree">'msg</span><span class="main">)</span>set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_msgs</span> <span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">p</span><span class="main">.</span>
   <span class="main">{</span><span class="bound">μ</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="bound">p</span> <span class="main">⟷</span> <span class="bound">μ</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="bound">p</span> <span class="main">⟶</span> <span class="bound">μ</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CSHO_trans_alt</span>
  <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span> <span class="main">⇒</span> <span class="tfree">'msg</span><span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'proc</span> <span class="main">⇀</span> <span class="tfree">'msg</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span> <span class="main">⇒</span> bool<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'proc</span><span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span><span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span><span class="main">)</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span><span class="tfree">'proc</span> <span class="main">⇒</span> <span class="tfree">'pst</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CSHO_trans_alt</span> <span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="free"><span class="bound"><span class="entity">nxt_st</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">≡</span>
    <span class="main">⋃</span><span class="bound">r</span> <span class="bound">μ</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">,</span> <span class="bound">cfg'</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">cfg</span> <span class="bound">cfg'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span>
      <span class="bound">μ</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">(</span>get_msgs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">cfg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">nxt_st</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="bound">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">cfg'</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CHO_trans_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CHO_trans <span class="free">A</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span> <span class="main">=</span> CSHO_trans_alt <span class="main">(</span>sendMsg <span class="free">A</span><span class="main">)</span> <span class="main">(</span>CnextState <span class="free">A</span><span class="main">)</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHO_trans_def CSHO_trans_alt_def CSHOnextConfig_def SHOmsgVectors_def 
    get_msgs_def restrict_map_def map_add_def choice_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHO_trans_def CSHO_trans_alt_def CSHOnextConfig_def SHOmsgVectors_def 
    get_msgs_def restrict_map_def map_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">K</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SHOmsgVectors_get_msgs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SHOmsgVectors <span class="free">A</span> <span class="free">r</span> <span class="free">p</span> <span class="free">cfg</span> <span class="free">HOp</span> <span class="free">SHOp</span> <span class="main">=</span> get_msgs <span class="main">(</span>sendMsg <span class="free">A</span> <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span>K <span class="free">HOp</span><span class="main">)</span> <span class="main">(</span>K <span class="free">SHOp</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SHOmsgVectors_def get_msgs_def K_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> get_msgs_K<span class="main">:</span>
  <span class="quoted"><span class="quoted">"get_msgs <span class="free">snd_f</span> <span class="free">cfg</span> <span class="main">(</span>K <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>K <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>
  <span class="main">=</span> get_msgs <span class="free">snd_f</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_def K_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> CSHORun_get_msgs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CSHORun <span class="main">(</span><span class="free">A</span> <span class="main">::</span>  <span class="main">(</span><span class="tfree">'proc</span><span class="main">,</span> <span class="tfree">'pst</span><span class="main">,</span> <span class="tfree">'msg</span><span class="main">)</span> CHOAlgorithm<span class="main">)</span> <span class="free">rho</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">coords</span> <span class="main">=</span> <span class="main">(</span>
     CHOinitConfig <span class="free">A</span> <span class="main">(</span><span class="free">rho</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">0</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span>
      <span class="bound">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>sendMsg <span class="free">A</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">SHOs</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span>
      <span class="main">∧</span> CnextState <span class="free">A</span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">coords</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHORun_def CSHOnextConfig_def SHOmsgVectors_get_msgs nextState_def get_msgs_K
     Bex_def choice_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> CSHORun_step <span class="main">=</span> CSHORun_get_msgs<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> get_msgs_dom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">msgs</span> <span class="main">∈</span> get_msgs <span class="free">send</span> <span class="free">s</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">p</span> <span class="main">⟹</span> dom <span class="free">msgs</span> <span class="main">=</span> <span class="free">HOs</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> get_msgs_benign<span class="main">:</span>
  <span class="quoted"><span class="quoted">"get_msgs <span class="free">snd_f</span> <span class="free">cfg</span> <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">p</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span>Some <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="free">snd_f</span> <span class="bound">q</span> <span class="free">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">p</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_def restrict_map_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Voting">
<div class="head">
<h1>Theory Voting</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Voting Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Voting <span class="keyword2"><span class="keyword">imports</span></span> <a href="Refinement.html">Refinement</a> <a href="Consensus_Misc.html">Consensus_Misc</a> <a href="Quorums.html">Quorums</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model definition›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">record</span></span> v_state <span class="main">=</span> 
  <span class="comment1">(* We want 0 to be the first round, and we also have to use something in the initial state
     - hence next_round *)</span>
  next_round <span class="main">::</span> <span class="quoted">round</span> 
  votes <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span> map"</span></span>
  decisions <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Initially, no rounds have been executed (the next round is 0), no votes have been
  cast, and no decisions have been made.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">v_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v_init</span> <span class="main">=</span> <span class="main">{</span> <span class="main">⦇</span> next_round <span class="main">=</span> <span class="main">0</span><span class="main">,</span> votes <span class="main">=</span> <span class="main">λ</span><span class="bound">r</span> <span class="bound">a</span><span class="main">.</span> None<span class="main">,</span> decisions <span class="main">=</span> Map.empty <span class="main">⦈</span> <span class="main">}</span>"</span></span>  

<span class="keyword1"><span class="command">context</span></span> quorum_process <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quorum_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"process set <span class="main">⇒</span> val <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  quorum_for_def'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">quorum_for</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v_f</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v_f</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> <span class="main">{</span>Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">quorum_for</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is easier to reason about in Isabelle.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> quorum_for_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"quorum_for <span class="free">Q</span> <span class="free">v</span> <span class="free">v_f</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="free">v_f</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quorum_for_def' image_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> quorum_non_empty<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locked_in_vf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locked_in_vf</span> <span class="free"><span class="bound"><span class="entity">v_f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> quorum_for <span class="bound">Q</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">v_f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locked_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_state <span class="main">⇒</span> round <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locked_in</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> locked_in_vf <span class="main">(</span>votes <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">d_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process <span class="main">⇒</span> val option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇒</span> val option<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">d_guard</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">v</span><span class="main">.</span>
    <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> locked_in_vf <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">no_defection</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_state <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> round <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  no_defection_def'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">no_defection</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> 
    <span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">Q</span> <span class="main">∈</span> <span class="free">Quorum</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>votes <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">r'</span><span class="main">)</span> <span class="main">`</span> <span class="bound">Q</span> <span class="main">=</span> <span class="main">{</span>Some <span class="bound">v</span><span class="main">}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="main">`</span> <span class="bound">Q</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">no_defection</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is easier to reason about in Isabelle.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_defection_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_defection <span class="free">s</span> <span class="free">round_votes</span> <span class="free">r</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&lt;</span> <span class="free">r</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span> <span class="bound">Q</span> <span class="bound">v</span><span class="main">.</span> quorum_for <span class="bound">Q</span> <span class="bound">v</span> <span class="main">(</span>votes <span class="free">s</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="free">round_votes</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_defection_def' Ball_def quorum_for_def'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.discI option.inject<span class="main">)</span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">locked</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_state <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">locked</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> locked_in <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">r</span> <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The sole system event.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">v_round</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>v_state <span class="main">×</span> v_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v_round</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span>
     <span class="main">∧</span> no_defection <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="main">∧</span> d_guard <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span>
     <span class="main">∧</span> <span class="comment1">― ‹actions›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span>
       votes <span class="main">:=</span> <span class="main">(</span>votes <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span><span class="main">)</span><span class="main">,</span>
       decisions <span class="main">:=</span> <span class="main">(</span>decisions <span class="bound">s</span><span class="main">)</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> v_evt_defs <span class="main">=</span> v_round_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">v_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v_state <span class="main">×</span> v_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v_trans</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">.</span> v_round <span class="bound">r</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">v_TS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_state TS"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v_TS</span> <span class="main">=</span> <span class="main">⦇</span> init <span class="main">=</span> v_init<span class="main">,</span> trans <span class="main">=</span> v_trans <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> v_TS_defs <span class="main">=</span> v_TS_def v_init_def v_trans_def


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The only rounds where votes could have been cast are the ones 
  preceding the next round.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Vinv1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Vinv1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> next_round <span class="bound">s</span> <span class="main">≤</span> <span class="bound">r</span> <span class="main">⟶</span> votes <span class="bound">s</span> <span class="bound">r</span> <span class="main">=</span> Map.empty <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Vinv1I <span class="main">=</span> Vinv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> Vinv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> Vinv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> Vinv1D <span class="main">=</span> Vinv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The votes cast must respect the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">no_defection</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> property.›</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Vinv2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Vinv2</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> no_defection <span class="bound">s</span> <span class="main">(</span>votes <span class="bound">s</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">r</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Vinv2I <span class="main">=</span> Vinv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> Vinv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> Vinv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> Vinv2D <span class="main">=</span> Vinv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Vinv3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Vinv3</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> ran <span class="main">(</span>decisions <span class="bound">s</span><span class="main">)</span> <span class="main">⊆</span> locked <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Vinv3I <span class="main">=</span> Vinv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> Vinv3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> Vinv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> Vinv3D <span class="main">=</span> Vinv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="comment1">(*************************)</span> 
<span class="keyword1"><span class="command">lemma</span></span> Vinv1_v_round<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv1<span class="main">}</span> v_round <span class="free">r</span> <span class="free">v_f</span> <span class="free">d_f</span> <span class="main">{&gt;</span> Vinv1<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs v_round_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Vinv1I<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> Vinv1_event_pres <span class="main">=</span> Vinv1_v_round

<span class="keyword1"><span class="command">lemma</span></span> Vinv1_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init v_TS <span class="main">⊆</span> Vinv1"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv1<span class="main">}</span> trans v_TS <span class="main">{&gt;</span> Vinv1<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_TS_defs Vinv1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_TS_defs Vinv1_event_pres<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Vinv1_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"reach v_TS <span class="main">⊆</span> Vinv1"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_basic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Vinv1_inductive<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following two lemmas will be useful later, when we
  start taking votes with the maximum timestamp.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Vinv1_finite_map_graph<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1 <span class="main">⟹</span> finite <span class="main">(</span>map_graph <span class="main">(</span>case_prod <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_dom_finite_map_graph<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">..&lt;</span></span> v_state.next_round <span class="free"><span class="free">s</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">×</span></span> UNIV"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Vinv1_def dom_def not_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Vinv1_finite_vote_set<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1 <span class="main">⟹</span> finite <span class="main">(</span>vote_set <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Vinv1_finite_map_graph<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_graph_def fun_graph_def vote_set_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">r</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">r</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>   

<span class="keyword1"><span class="command">lemma</span></span> process_mru_map_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"process_mru <span class="main">(</span><span class="main">(</span>votes <span class="free">s</span><span class="main">)</span><span class="main">(</span>next_round <span class="free">s</span> <span class="main">:=</span> <span class="free">v_f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>process_mru <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span> <span class="main">++</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> map_option <span class="main">(</span>Pair <span class="main">(</span>next_round <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">v_f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">THEN</span> Vinv1D<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">≥</span> next_round <span class="free">s</span><span class="main">.</span> votes <span class="free">s</span> <span class="bound">r'</span> <span class="main">=</span> Map.empty"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_new_votes<span class="main"><span class="main">[</span></span><span class="operator">OF</span> empty<span class="main"><span class="main">]</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_defection_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"no_defection <span class="free">s</span> Map.empty <span class="free">r'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_defection_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_defection_preserved<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> next_round <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"no_defection <span class="free">s</span> <span class="free">v_f</span> <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"no_defection <span class="free">s</span> <span class="main">(</span>votes <span class="free">s</span> <span class="free">r'</span><span class="main">)</span> <span class="free">r'</span>"</span></span>
  <span class="quoted"><span class="quoted">"votes <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">v_f</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"no_defection <span class="free">s'</span> <span class="main">(</span>votes <span class="free">s'</span> <span class="free">r'</span><span class="main">)</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_defection_def<span class="main">)</span>
  
<span class="comment1">(********)</span>

<span class="keyword1"><span class="command">lemma</span></span> Vinv2_v_round<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv2 <span class="main">∩</span> Vinv1<span class="main">}</span> v_round <span class="free">r</span> <span class="free">v_f</span> <span class="free">d_f</span> <span class="main">{&gt;</span> Vinv2<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Vinv2I<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> s' r' s<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> no_defection_preserved<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_round_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> v_state.equality<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Vinv2_event_pres <span class="main">=</span> Vinv2_v_round

<span class="keyword1"><span class="command">lemma</span></span> Vinv2_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init v_TS <span class="main">⊆</span> Vinv2"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv2 <span class="main">∩</span> Vinv1<span class="main">}</span> trans v_TS <span class="main">{&gt;</span> Vinv2<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_TS_defs Vinv2_def no_defection_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_TS_defs Vinv2_event_pres<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Vinv2_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"reach v_TS <span class="main">⊆</span> Vinv2"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Vinv2_inductive Vinv1_invariant <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="comment1">(*************************)</span>
<span class="keyword1"><span class="command">lemma</span></span> locked_preserved<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> next_round <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"votes <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span><span class="main">(</span><span class="free">r</span> <span class="main">:=</span> <span class="free">v_f</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"locked <span class="free">s</span> <span class="main">⊆</span> locked <span class="free">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locked_def locked_in_def locked_in_vf_def quorum_for_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Vinv1D<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  

<span class="comment1">(*************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> Vinv3_v_round<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv3 <span class="main">∩</span> Vinv1<span class="main">}</span> v_round <span class="free">r</span> <span class="free">v_f</span> <span class="free">d_f</span> <span class="main">{&gt;</span> Vinv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> Vinv3I<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> v_round <span class="free">r</span> <span class="free">v_f</span> <span class="free">d_f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Vinv3"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Vinv1"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> ran <span class="main">(</span>decisions <span class="skolem">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"locked <span class="skolem">s</span> <span class="main">⊆</span> locked <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> locked_preserved<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv1<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_round_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Vinv3D<span class="main">[</span><span class="operator">OF</span> inv3<span class="main">]</span> step dec
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> locked <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_round_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ran_map_addD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locked_def locked_in_def d_guard_def ran_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Vinv3_event_pres <span class="main">=</span> Vinv3_v_round

<span class="keyword1"><span class="command">lemma</span></span> Vinv3_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init v_TS <span class="main">⊆</span> Vinv3"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv3 <span class="main">∩</span> Vinv1<span class="main">}</span> trans v_TS <span class="main">{&gt;</span> Vinv3<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_TS_defs Vinv3_def no_defection_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_TS_defs Vinv3_event_pres<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Vinv3_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"reach v_TS <span class="main">⊆</span> Vinv3"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Vinv3_inductive Vinv1_invariant <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Agreement and stability›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Only a singe value can be locked within the votes for one round.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> locked_in_vf_same<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> locked_in_vf <span class="free">v_f</span> <span class="free">v</span><span class="main">;</span> locked_in_vf <span class="free">v_f</span> <span class="free">w</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qintersect
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locked_in_vf_def quorum_for_def image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff all_not_in_conv option.inject<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In any reachable state, no two different values can be locked in
  different rounds.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> locked_in_different<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv2"</span></span>
  <span class="quoted"><span class="quoted">"locked_in <span class="free">s</span> <span class="free">r1</span> <span class="free">v</span>"</span></span>
  <span class="quoted"><span class="quoted">"locked_in <span class="free">s</span> <span class="free">r2</span> <span class="free">w</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">&lt;</span> <span class="free">r2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
  <span class="comment1">― ‹To be locked, <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">v</span></span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">w</span></span><span class="antiquote">}</span></span> must each have received votes from a quorum.›</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q1</span></span> <span class="skolem"><span class="skolem">Q2</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> Q12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q1</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q2</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span> <span class="quoted"><span class="quoted">"quorum_for <span class="skolem">Q1</span> <span class="free">v</span> <span class="main">(</span>votes <span class="free">s</span> <span class="free">r1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"quorum_for <span class="skolem">Q2</span> <span class="free">w</span> <span class="main">(</span>votes <span class="free">s</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locked_in_def locked_in_vf_def quorum_for_def<span class="main">)</span>
  <span class="comment1">― ‹By the quorum intersection property, some process from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">Q1</span></span><span class="antiquote">}</span></span> voted for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">w</span></span><span class="antiquote">}</span></span>:›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">Q1</span>"</span></span> <span class="quoted"><span class="quoted">"votes <span class="free">s</span> <span class="free">r2</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> qintersect<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q1</span> <span class="main">∈</span> <span class="free">Quorum</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q2</span> <span class="main">∈</span> <span class="free">Quorum</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quorum_for_def<span class="main">)</span>
  <span class="comment1">― ‹But from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Vinv2</span><span class="antiquote">}</span></span> we conclude that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">a</span></span><span class="antiquote">}</span></span> could not have defected by voting
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">w</span></span><span class="antiquote">}</span></span>, so <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="var">?thesis</span></span><span class="antiquote">}</span></span>:›</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> Vinv2›</span></span> <span class="quoted"><span class="quoted">‹quorum_for <span class="skolem">Q1</span> <span class="free">v</span> <span class="main">(</span>votes <span class="free">s</span> <span class="free">r1</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r1</span> <span class="main">&lt;</span> <span class="free">r2</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Vinv2_def no_defection_def quorum_for_def'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is simple to extend the previous theorem to any two (not necessarily different) rounds.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> locked_unique<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv2"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> locked <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> locked <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> quoIn<span class="main">:</span> <span class="quoted"><span class="quoted">"locked_in <span class="free">s</span> <span class="skolem">r1</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"locked_in <span class="free">s</span> <span class="skolem">r2</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locked_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">&lt;</span> <span class="skolem">r2</span> <span class="main">∨</span> <span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">r2</span> <span class="main">∨</span> <span class="skolem">r2</span> <span class="main">&lt;</span> <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linorder_less_linear<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> <span class="skolem">r2</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> quoIn <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locked_in_def locked_in_vf_same<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> locked_in_different<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> Vinv2›</span></span><span class="main"><span class="main">]</span></span> quoIn sym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now prove that decisions are stable; once a process makes a decision, it never
  changes it, and it does not go back to an undecided state. Note that behaviors grow at 
  the front; hence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">tr</span></span> <span class="main"><span class="main">!</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">-</span></span><span class="free"><span class="free">j</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is later in the trace than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">tr</span></span> <span class="main"><span class="main">!</span></span> <span class="free"><span class="free">i</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stable_decision<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> beh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="main">∈</span> beh v_TS"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">tr</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> nth <span class="free">tr</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> nth <span class="free">tr</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"decisions <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"decisions <span class="free">t</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="comment1">― ‹First, we show that the both <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">s</span></span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">t</span></span><span class="antiquote">}</span></span> respect the invariants.›</span>
  <span class="keyword1"><span class="command">have</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> reach v_TS"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> reach v_TS"</span></span> <span class="keyword1"><span class="command">using</span></span> beh s t len
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_equiv_beh_states<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> len nth_mem<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_diff_less nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> invs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv2"</span></span> <span class="keyword2"><span class="keyword">and</span></span> invs3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv3"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Vinv2_invariant<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> Vinv3_invariant<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> dec_j<span class="main">:</span> <span class="quoted"><span class="quoted">"decisions <span class="main">(</span><span class="free">tr</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"decisions <span class="skolem">t</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc
    <span class="comment1">― ‹As <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(-)</span>"</span><span class="antiquote">}</span></span> is a total function on naturals, we perform a case distinction;
          if <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span><span class="antiquote">}</span></span>, the induction step is trivial.›</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span><span class="main">)</span> 
      <span class="comment1">― ‹The non-trivial case.›</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="free">tr</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="comment1">― ‹Both <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">t</span></span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">t'</span></span><span class="antiquote">}</span></span> are reachable, thus respect the invariants, and
        they are related by the transition relation.›</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> reach v_TS"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> reach v_TS"</span></span> <span class="keyword1"><span class="command">using</span></span> beh len Suc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> beh_in_reach less_imp_diff_less nth_mem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> invs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> Vinv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> Vinv3"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> Vinv2"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> Vinv3"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Vinv1_invariant<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> Vinv2_invariant<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> 
          Vinv3_invariant<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> locked_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> locked <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ranI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> trans v_TS"</span></span> <span class="keyword1"><span class="command">using</span></span> beh len Suc 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> beh_consecutive_in_trans<span class="main">)</span>
      <span class="comment1">― ‹Thus <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">v</span></span><span class="antiquote">}</span></span> also remains locked in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">t</span></span><span class="antiquote">}</span></span>, and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">p</span></span><span class="antiquote">}</span></span> does not 
        revoke, nor change its decision.›</span>
      <span class="keyword1"><span class="command">hence</span></span> locked_v_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> locked <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> locked_v
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_TS_defs v_round_def
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> locked_preserved<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invs<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ locked_v<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> trans <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"decisions <span class="skolem">t</span> <span class="free">p</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dec_j
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'_def v_TS_defs v_round_def 
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split option.split_asm<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> invs<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> Vinv3D<span class="main">]</span> locked_v_t locked_unique<span class="main">[</span><span class="operator">OF</span> invs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> contra_subsetD ranI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"decisions <span class="skolem">t</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we prove that the Voting model ensures agreement. Without a loss 
  of generality, we assume that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> preceeds <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> in the trace.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Voting_agreement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> beh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tr</span> <span class="main">∈</span> beh v_TS"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">tr</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> nth <span class="free">tr</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> nth <span class="free">tr</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dec<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"decisions <span class="free">s</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
    <span class="quoted"><span class="quoted">"decisions <span class="free">t</span> <span class="free">q</span> <span class="main">=</span> Some <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="comment1">― ‹Again, we first prove that the invariants hold for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">s</span></span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">have</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> reach v_TS"</span></span> <span class="keyword1"><span class="command">using</span></span> beh s t len
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_equiv_beh_states<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> invs2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv2"</span></span> <span class="keyword2"><span class="keyword">and</span></span> invs3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv3"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Vinv2_invariant<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> Vinv3_invariant<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="comment1">― ‹We now proceed to prove the thesis by induction.›</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">hence</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> locked <span class="main">(</span><span class="free">tr</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> locked <span class="main">(</span><span class="free">tr</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ranI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> invs2 <span class="keyword1"><span class="command">using</span></span> assms 0
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> locked_unique<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="comment1">― ‹Again, the totality of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(-)</span>"</span><span class="antiquote">}</span></span> makes the claim trivial if <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span><span class="antiquote">}</span></span>.›</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="comment1">― ‹In the non-trivial case, the proof follows from the decision stability theorem 
        and the uniqueness of locked values.›</span>
      <span class="keyword1"><span class="command">have</span></span> dec_t<span class="main">:</span> <span class="quoted"><span class="quoted">"decisions <span class="skolem">t</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stable_decision<span class="main"><span class="main">[</span></span><span class="operator">OF</span> beh len s <span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> reach v_TS"</span></span> <span class="keyword1"><span class="command">using</span></span> beh len Suc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> beh_in_reach less_imp_diff_less nth_mem<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> invs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> Vinv2"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> Vinv3"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Vinv2_invariant<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> Vinv3_invariant<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> dec_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> locked <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> invs<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ranI<span class="main">)</span> 
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> locked_w_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> locked <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> Vinv3›</span></span><span class="main">[</span><span class="operator">THEN</span> Vinv3D<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ranI<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> locked_unique<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> Vinv2›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context quorum *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Voting_Opt">
<div class="head">
<h1>Theory Voting_Opt</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Optimized Voting Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Voting_Opt
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Voting.html">Voting</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model definition›</span></span>
<span class="comment1">(*****************************************************************************)</span>

<span class="keyword1"><span class="command">record</span></span> opt_v_state <span class="main">=</span> 
  next_round <span class="main">::</span> <span class="quoted">round</span> 
  last_vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span> map"</span></span>
  decisions <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flv_init</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flv_init</span> <span class="main">=</span> <span class="main">{</span> <span class="main">⦇</span> next_round <span class="main">=</span> <span class="main">0</span><span class="main">,</span> last_vote <span class="main">=</span> Map.empty<span class="main">,</span> decisions <span class="main">=</span> Map.empty <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> quorum_process <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fmru_lv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> round <span class="main">×</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>process set<span class="main">,</span> round <span class="main">×</span> val<span class="main">)</span>map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fmru_lv</span> <span class="free"><span class="bound"><span class="entity">lvs</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> option_Max_by fst <span class="main">(</span>ran <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lvs</span></span></span> <span class="main">|`</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flv_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> round <span class="main">×</span> val<span class="main">)</span>map <span class="main">⇒</span> process set <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flv_guard</span> <span class="free"><span class="bound"><span class="entity">lvs</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">alv</span> <span class="main">=</span> fmru_lv <span class="free"><span class="bound"><span class="entity">lvs</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="keyword1">in</span> <span class="bound">alv</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">alv</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt_no_defection</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opt_v_state <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  opt_no_defection_def'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">opt_no_defection</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">round_votes</span></span></span> <span class="main">≡</span> 
    <span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> quorum_for <span class="bound">Q</span> <span class="bound">v</span> <span class="main">(</span>last_vote <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">round_votes</span></span></span> <span class="main">`</span> <span class="bound">Q</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> opt_no_defection_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"opt_no_defection <span class="free">s</span> <span class="free">round_votes</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">Q</span> <span class="bound">v</span><span class="main">.</span> quorum_for <span class="bound">Q</span> <span class="bound">v</span> <span class="main">(</span>last_vote <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="free">round_votes</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_no_defection_def'<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
                    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flv_round</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span>  <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>opt_v_state <span class="main">×</span> opt_v_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flv_round</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span>
     <span class="main">∧</span> opt_no_defection <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span>
     <span class="main">∧</span> d_guard <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span>
     <span class="main">∧</span> <span class="comment1">― ‹actions›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
       <span class="main">,</span> last_vote <span class="main">:=</span> last_vote <span class="bound">s</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span>
       <span class="main">,</span> decisions <span class="main">:=</span> <span class="main">(</span>decisions <span class="bound">s</span><span class="main">)</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> flv_evt_defs <span class="main">=</span> flv_round_def flv_guard_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flv_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_v_state <span class="main">×</span> opt_v_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flv_trans</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">.</span> flv_round <span class="bound">r</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flv_TS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opt_v_state TS"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flv_TS</span> <span class="main">=</span> <span class="main">⦇</span> init <span class="main">=</span> flv_init<span class="main">,</span> trans <span class="main">=</span> flv_trans <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> flv_TS_defs <span class="main">=</span> flv_TS_def flv_init_def flv_trans_def

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flv_ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v_state <span class="main">×</span> opt_v_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flv_ref_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">sc</span> <span class="main">=</span> <span class="main">⦇</span>
      next_round <span class="main">=</span> v_state.next_round <span class="bound">sa</span>
      <span class="main">,</span> last_vote <span class="main">=</span> map_option snd <span class="keyword1">o</span> <span class="main">(</span>process_mru <span class="main">(</span>votes <span class="bound">sa</span><span class="main">)</span><span class="main">)</span>
      <span class="main">,</span> decisions <span class="main">=</span> v_state.decisions <span class="bound">sa</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Guard strengthening›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> process_mru_Max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">∈</span> Vinv1"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> process_mru<span class="main">:</span> <span class="quoted"><span class="quoted">"process_mru <span class="main">(</span>votes <span class="free">sa</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"votes <span class="free">sa</span> <span class="free">r</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span> <span class="free">r</span><span class="main">.</span> votes <span class="free">sa</span> <span class="bound">r'</span> <span class="free">p</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> process_mru <span class="keyword1"><span class="command">have</span></span> not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"vote_set <span class="main">(</span>votes <span class="free">sa</span><span class="main">)</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_def mru_of_set_def option_Max_by_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Max_by_conds <span class="main">=</span> Vinv1_finite_vote_set<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span> this
  <span class="keyword1"><span class="command">from</span></span> Max_by_dest<span class="main">[</span><span class="operator">OF</span> Max_by_conds<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">fst</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span>
    r<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> Max_by fst <span class="main">(</span>vote_set <span class="main">(</span>votes <span class="free">sa</span><span class="main">)</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"votes <span class="free">sa</span> <span class="free">r</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> process_mru
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_def mru_of_set_def option_Max_by_def vote_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span><span class="free">r</span> <span class="main">.</span> votes <span class="free">sa</span> <span class="bound">r'</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∉</span> vote_set <span class="main">(</span>votes <span class="free">sa</span><span class="main">)</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> process_mru
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_by_ge<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">fst</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> Vinv1_finite_vote_set<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> inv<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> 
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_def mru_of_set_def option_Max_by_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"votes <span class="free">sa</span> <span class="skolem">r'</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> opt_no_defection_imp_no_defection<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    conc_guard<span class="main">:</span> <span class="quoted"><span class="quoted">"opt_no_defection <span class="free">sc</span> <span class="free">round_votes</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sa</span><span class="main">,</span> <span class="free">sc</span><span class="main">)</span> <span class="main">∈</span> flv_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ainv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">∈</span> Vinv1"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">∈</span> Vinv2"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"no_defection <span class="free">sa</span> <span class="free">round_votes</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> no_defection_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r'</span> <span class="skolem">v</span> <span class="skolem">a</span> <span class="skolem">Q</span> <span class="skolem">w</span>
  <span class="keyword3"><span class="command">assume</span></span>
    r'_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">&lt;</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a_votes_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">round_votes</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"quorum_for <span class="skolem">Q</span> <span class="skolem">v</span> <span class="main">(</span>votes <span class="free">sa</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> a_in_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quorum_for_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"quorum_for <span class="skolem">Q</span> <span class="skolem">v</span> <span class="main">(</span>last_vote <span class="free">sc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quorum_for_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Q <span class="keyword1"><span class="command">have</span></span> q_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"votes <span class="free">sa</span> <span class="skolem">r'</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quorum_for_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> votes<span class="main">:</span> <span class="quoted"><span class="quoted">"vote_set <span class="main">(</span>votes <span class="free">sa</span><span class="main">)</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"last_vote <span class="free">sc</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flv_ref_rel_def process_mru_def mru_of_set_def
        option_Max_by_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> R <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r_max</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"process_mru <span class="main">(</span>votes <span class="free">sa</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r_max</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flv_ref_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> process_mru_Max<span class="main">[</span><span class="operator">OF</span> ainv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> q_r' <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"votes <span class="free">sa</span> <span class="skolem">r_max</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">≤</span> <span class="skolem">r_max</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q_r'
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"last_vote <span class="free">sc</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ainv<span class="main">(</span>2<span class="main">)</span> Q <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">Q</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">r_max</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w Vinv2_def no_defection_def q_r' <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_neq_implies_less<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w Vinv2_def no_defection_def q_r' <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_neq_implies_less<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">round_votes</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conc_guard a_in_Q a_votes_w r'_less
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_no_defection_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Action refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> act_ref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"map_option snd <span class="keyword1">o</span> <span class="main">(</span>process_mru <span class="main">(</span><span class="main">(</span>votes <span class="free">s</span><span class="main">)</span><span class="main">(</span>v_state.next_round <span class="free">s</span> <span class="main">:=</span> <span class="free">v_f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">(</span>map_option snd <span class="keyword1">o</span> <span class="main">(</span>process_mru <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">++</span> <span class="free">v_f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_map_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="main"><span class="main">]</span></span> map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The complete refinement proof›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> flv_round_refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>flv_ref_rel <span class="main">∩</span> <span class="main">(</span>Vinv1 <span class="main">∩</span> Vinv2<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span>
    v_round <span class="free">r</span> <span class="free">v_f</span>  <span class="free">d_f</span><span class="main">,</span> flv_round <span class="free">r</span> <span class="free">v_f</span> <span class="free">d_f</span>
  <span class="main">{&gt;</span> flv_ref_rel<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs flv_round_def v_round_def 
    flv_ref_rel_def act_ref
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> opt_no_defection_imp_no_defection<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> Last_Voting_Refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="main">(</span>flv_ref_rel <span class="main">∩</span> <span class="main">(</span>Vinv1 <span class="main">∩</span> Vinv2<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span> v_TS flv_TS"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_using_invariants<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init flv_TS <span class="main">⊆</span> flv_ref_rel <span class="main">``</span> init v_TS"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flv_TS_defs v_TS_defs flv_ref_rel_def
      process_mru_def mru_of_set_def vote_set_def option_Max_by_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>flv_ref_rel <span class="main">∩</span> <span class="main">(</span>Vinv1 <span class="main">∩</span> Vinv2<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span> trans v_TS<span class="main">,</span> trans flv_TS <span class="main">{&gt;</span> flv_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> v_TS_defs flv_TS_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> flv_round_refines<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv1 <span class="main">∩</span> Vinv2 <span class="main">∩</span> Domain <span class="main">(</span>flv_ref_rel <span class="main">∩</span> UNIV <span class="main">×</span> UNIV<span class="main">)</span><span class="main">}</span> 
      trans v_TS 
    <span class="main">{&gt;</span> Vinv1 <span class="main">∩</span> Vinv2<span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Vinv1_inductive<span class="main">(</span>2<span class="main">)</span> Vinv2_inductive<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Vinv1_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Vinv2_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OneThirdRule_Defs">
<div class="head">
<h1>Theory OneThirdRule_Defs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The OneThirdRule Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> OneThirdRule_Defs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/HOModel.html">Heard_Of.HOModel</a> <span class="quoted">"<a href="Consensus_Types.html">../Consensus_Types</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The contents of this file have been taken almost verbatim from the
  Heard Of Model AFP entry. The only difference is that the types have been
  changed.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The state of each process consists of two fields: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>last_vote›</span></span></span></span> holds
  the current value proposed by the process and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>decision›</span></span></span></span> the
  value (if any, hence the option type) it has decided.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  last_vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span>
  decision <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The initial value of field <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>last_vote›</span></span></span></span> is unconstrained, but no decision
  has been taken initially.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> decision <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a vector <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>msgs›</span></span></span></span> of values (possibly null) received from 
  each process, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">HOV</span></span> <span class="free"><span class="free">msgs</span></span> <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> denotes the set of processes from
  which value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> was received.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HOV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process <span class="main">⇒</span> <span class="tfree">'val</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> process set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HOV</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">MFR</span></span> <span class="free"><span class="free">msgs</span></span> <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (``most frequently received'') holds for
  vector <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>msgs›</span></span></span></span> if no value has been received more frequently
  than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.

  Some such value always exists, since there is only a finite set of
  processes and thus a finite set of possible cardinalities of the
  sets <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"HOV <span class="free"><span class="free">msgs</span></span> <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">MFR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process <span class="main">⇒</span> <span class="tfree">'val</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">MFR</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">w</span><span class="main">.</span> card <span class="main">(</span>HOV <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">w</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>HOV <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> MFR_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> MFR <span class="free">msgs</span> <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cards</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="bound">v</span> <span class="main">.</span> True <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mfr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="var">?cards</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="bound">v</span><span class="main">)</span> <span class="main">≤</span> N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cards</span> <span class="main">⊆</span> <span class="main">{</span> <span class="main">0</span> <span class="main">..</span> N <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?cards</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast0AtMost finite_atMost finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mfr</span> <span class="main">∈</span> <span class="var">?cards</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_in<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mfr</span> <span class="main">=</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFR <span class="free">msgs</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MFR_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?mfr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> v<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Also, if a process has heard from at least one other process,
  the most frequently received values are among the received messages.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> MFR_in_msgs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> HO<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="free">m</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"MFR <span class="main">(</span>HOrcvdMsgs <span class="free">OTR_M</span> <span class="free">m</span> <span class="free">p</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">v</span>"</span></span>
             <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"MFR <span class="var">?msgs</span> <span class="free">v</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">m</span> <span class="free">p</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> the <span class="main">(</span><span class="var">?msgs</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> HO <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">m</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HOV <span class="var">?msgs</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def HOrcvdMsgs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> HOp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?msgs</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>HOV <span class="var">?msgs</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MFR_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HOV <span class="var">?msgs</span> <span class="free">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def HOrcvdMsgs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">TwoThirds</span></span> <span class="free"><span class="free">msgs</span></span> <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds if value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> has been
  received from more than $2/3$ of all processes.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TwoThirds</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">TwoThirds</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">(</span>HOV <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The next-state relation of algorithm \emph{One-Third Rule} for every process
  is defined as follows:
  if the process has received values from more than $2/3$ of all processes,
  the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>last_vote›</span></span></span></span> field is set to the smallest among the most frequently received
  values, and the process decides value $v$ if it received $v$ from more than
  $2/3$ of all processes. If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> hasn't heard from more than $2/3$ of
  all processes, the state remains unchanged.
  (Note that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Some›</span></span></span></span> is the constructor of the option datatype, whereas
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ϵ›</span></span></span></span> is Hilbert's choice operator.)
  We require the type of values to be linearly ordered so that the minimum
  is guaranteed to be well-defined.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_nextState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> pstate<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> 
   <span class="keyword1">if</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>
   <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="main">⦇</span> last_vote <span class="main">=</span> Min <span class="main">{</span><span class="bound">v</span> <span class="main">.</span> MFR <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span><span class="main">}</span><span class="main">,</span>
          decision <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> TwoThirds <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span><span class="main">)</span>
                    <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">ϵ</span><span class="bound">v</span><span class="main">.</span> TwoThirds <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span><span class="main">)</span>
                    <span class="keyword1">else</span> decision <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">⦈</span>
   <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The message sending function is very simple: at every round, every process
  sends its current proposal (field <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>last_vote›</span></span></span></span> of its local state) to all 
  processes.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_sendMsg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_sendMsg</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> last_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Communication predicate for \emph{One-Third Rule}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the communication predicate for the \emph{One-Third Rule}
  algorithm to be correct.
  It requires that, infinitely often, there is a round where all processes
  receive messages from the same set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Π›</span></span></span></span> of processes where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Π›</span></span></span></span>
  contains more than two thirds of all processes.
  The ``per-round'' part of the communication predicate is trivial.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_commPerRd</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="main">≡</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r0</span> <span class="bound">Π</span><span class="main">.</span> <span class="bound">r0</span> <span class="main">≥</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r0</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">Π</span><span class="main">)</span> <span class="main">∧</span> card <span class="bound">Π</span> <span class="main">&gt;</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \emph{One-Third Rule} Heard-Of machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the HO machine for the \emph{One-Third Rule} algorithm
  by assembling the algorithm definition and its communication-predicate.
  Because this is an uncoordinated algorithm, the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>crd›</span></span></span></span> arguments
  of the initial- and next-state predicates are unused.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_HOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_HOMachine</span> <span class="main">=</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> OTR_initState <span class="bound">p</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span>
     sendMsg <span class="main">=</span>  OTR_sendMsg<span class="main">,</span>
     CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> OTR_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span><span class="main">,</span>
     HOcommPerRd <span class="main">=</span> OTR_commPerRd<span class="main">,</span>
     HOcommGlobal <span class="main">=</span> OTR_commGlobal <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">OTR_M</span> <span class="main">≡</span> OTR_HOMachine<span class="main">::</span><span class="main">(</span>process<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> HOMachine"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="OneThirdRule_Proofs">
<div class="head">
<h1>Theory OneThirdRule_Proofs</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> OneThirdRule_Proofs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/Majorities.html">Heard_Of.Majorities</a> 
  <span class="quoted">"<a href="HO_Transition_System.html">../HO_Transition_System</a>"</span> <span class="quoted">"<a href="Voting_Opt.html">../Voting_Opt</a>"</span> <a href="OneThirdRule_Defs.html">OneThirdRule_Defs</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">majs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process set<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">majs</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">S</span><span class="main">.</span> card <span class="bound">S</span> <span class="main">&gt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_Compl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">-</span> card <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">S</span> <span class="main">+</span> card <span class="main">(</span><span class="main">-</span><span class="free">S</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> card_Un_disjoint<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span><span class="free"><span class="free"><span class="free">S</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> Compl_partition<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m_mult_div_Suc_m<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="keyword1">div</span> Suc <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_mult_imp_div_less<span class="main">)</span>
  
<span class="keyword1"><span class="command">interpretation</span></span> majorities<span class="main">:</span> quorum_process <span class="quoted">majs</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="skolem">Q'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> majs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> majs"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> N<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="skolem">Q</span> <span class="main">+</span> card <span class="skolem">Q'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∩</span> <span class="skolem">Q'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> majorities_intersect<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> N <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> N"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> eval_nat_numeral m_mult_div_Suc_m<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹N <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">∈</span> majs"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> div_less_dividend<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_Un_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">A</span><span class="main">;</span> finite <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">A</span> <span class="main">+</span> card <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card_Un_Int<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> qintersect_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">∈</span> majs"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q'</span> <span class="main">∈</span> majs"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">Q</span> <span class="main">∩</span> <span class="free">Q'</span><span class="main">)</span> <span class="main">&gt;</span> card <span class="main">(</span><span class="free">Q</span> <span class="main">∩</span> <span class="main">-</span><span class="free">Q'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">Q</span> <span class="main">∩</span> <span class="main">-</span><span class="free">Q'</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">-</span><span class="free">Q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> N <span class="main">-</span> <span class="main">(</span>card <span class="main">(</span><span class="main">-</span><span class="free">Q</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="main">-</span><span class="free">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="main">&lt;</span> card <span class="free">Q</span> <span class="main">+</span> card <span class="free">Q'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> le_N<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">Q</span> <span class="main">≤</span> N"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">Q'</span> <span class="main">≤</span> N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms sum
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Compl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> diff_less_mono2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def card_Compl<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_add_assoc2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> le_N<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> add_diff_assoc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_N<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mono le_N<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_N<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_diff_conv2 nat_add_left_cancel_less<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>              
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">Q</span> <span class="main">∩</span> <span class="free">Q'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="main">-</span> <span class="main">(</span>card <span class="main">(</span><span class="main">-</span><span class="free">Q</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="main">-</span><span class="free">Q'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="main">-</span><span class="free">Q</span> <span class="main">∪</span> <span class="main">-</span><span class="free">Q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card_Compl<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">Q</span> <span class="main">∪</span> <span class="main">-</span><span class="free">Q'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono2 card_Un_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> val_linorder<span class="main">:</span> 
  <span class="comment1">(* "class.finite TYPE(process)" *)</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>val<span class="main">,</span> linorder_class<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> val <span class="main">::</span> <span class="quoted">linorder</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val_linorder<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> p_TS_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span>process <span class="main">⇒</span> <span class="main">(</span>val pstate<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">K</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_Alg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_Alg</span> <span class="main">=</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> OTR_initState <span class="bound">p</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span>
     sendMsg <span class="main">=</span>  OTR_sendMsg<span class="main">,</span>
     CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> OTR_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span>
   <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OTR_TS</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process<span class="main">)</span>
  <span class="main">⇒</span> p_TS_state TS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_TS</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="main">=</span> CHO_to_TS OTR_Alg <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span>K <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> OTR_TS_defs <span class="main">=</span> OTR_TS_def CHO_to_TS_def OTR_Alg_def CHOinitConfig_def
  OTR_initState_def

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OTR_trans_step</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">μ</span><span class="main">.</span>
   <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">,</span> Suc <span class="bound">r</span><span class="main">,</span> <span class="bound">cfg'</span><span class="main">)</span><span class="main">|</span><span class="bound">cfg</span> <span class="bound">cfg'</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>OTR_sendMsg <span class="bound">r</span><span class="main">)</span> <span class="bound">cfg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> OTR_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="bound">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">cfg'</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CSHOnextConfig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CSHOnextConfig</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span> <span class="main">∈</span> SHOmsgVectors <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span>
          CnextState <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">μ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> rHO <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process HO"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">otr_ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_v_state <span class="main">×</span> p_TS_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">otr_ref_rel</span> <span class="main">=</span>  <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">r</span> <span class="main">=</span> next_round <span class="bound">sa</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> decisions <span class="bound">sa</span> <span class="bound">p</span> <span class="main">=</span> decision <span class="main">(</span><span class="bound">sc</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> majorities.opt_no_defection <span class="bound">sa</span> <span class="main">(</span>Some <span class="keyword1">o</span> last_vote <span class="keyword1">o</span> <span class="bound">sc</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decide_origin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="free">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>OTR_sendMsg <span class="free">r</span><span class="main">)</span> <span class="free">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"OTR_nextState <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">sc</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">sc'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> new_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decision <span class="main">(</span><span class="free">sc'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decision <span class="main">(</span><span class="free">sc</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> decision <span class="main">(</span><span class="free">sc'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> last_vote <span class="main">(</span><span class="free">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span> <span class="main">∈</span> majs"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> new_dec <span class="keyword2"><span class="keyword">and</span></span> nxt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    p_dec_v<span class="main">:</span> <span class="quoted"><span class="quoted">"decision <span class="main">(</span><span class="free">sc'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> two_thirds_v<span class="main">:</span> <span class="quoted"><span class="quoted">"TwoThirds <span class="main">(</span><span class="free">μ</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OTR_nextState_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exE_some<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> N <span class="keyword1">div</span> <span class="numeral">3</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> last_vote <span class="main">(</span><span class="free">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> send
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign OTR_sendMsg_def TwoThirds_def HOV_def 
      restrict_map_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_le_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> p_dec_v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> MFR_in_msgs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> HO<span class="main">:</span><span class="quoted"><span class="quoted">"dom <span class="free">msgs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"MFR <span class="free">msgs</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> dom <span class="free">msgs</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> the <span class="main">(</span><span class="free">msgs</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> HO <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> dom <span class="free">msgs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HOV <span class="free">msgs</span> <span class="main">(</span>the <span class="main">(</span><span class="free">msgs</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def <span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> HOp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="main">(</span>the <span class="main">(</span><span class="free">msgs</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>HOV <span class="free">msgs</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MFR_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HOV <span class="free">msgs</span> <span class="free">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HOV_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>otr_ref_rel<span class="main">}</span> 
      <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">.</span> majorities.flv_round <span class="bound">r</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">)</span><span class="main">,</span> 
      OTR_trans_step <span class="free">HOs</span> 
    <span class="main">{&gt;</span> otr_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs OTR_trans_step_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">r</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> otr_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>OTR_sendMsg <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> OTR_nextState <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> step<span class="main">=</span>send nxt
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d_f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d_f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> decision <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> decision <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">then</span> decision <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="main">⦇</span> 
    opt_v_state.next_round <span class="main">=</span> Suc <span class="skolem">r</span>
    <span class="main">,</span> opt_v_state.last_vote <span class="main">=</span> opt_v_state.last_vote <span class="skolem">sa</span> <span class="main">++</span> <span class="main">(</span>Some <span class="keyword1">o</span> last_vote <span class="keyword1">o</span> <span class="skolem">sc</span><span class="main">)</span> 
    <span class="main">,</span> opt_v_state.decisions <span class="main">=</span> opt_v_state.decisions <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">d_f</span>
    <span class="main">⦈</span>"</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"majorities.d_guard <span class="skolem">d_f</span> <span class="main">(</span>Some <span class="keyword1">o</span> last_vote <span class="keyword1">o</span> <span class="skolem">sc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.d_guard_def d_f_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span>
      <span class="quoted"><span class="quoted">"Some <span class="skolem">v</span> <span class="main">≠</span> decision <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"decision <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> 
      decide_origin<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> μ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">μ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> HOs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">HOs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sc'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">sc'</span></span><span class="main">,</span> <span class="operator">OF</span> send<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span> nxt<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"quorum_process.locked_in_vf majs <span class="main">(</span>Some <span class="main">∘</span> last_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.locked_in_vf_def majorities.quorum_for_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.flv_round <span class="skolem">r</span> <span class="main">(</span>Some <span class="keyword1">o</span> last_vote <span class="keyword1">o</span> <span class="skolem">sc</span><span class="main">)</span> <span class="skolem">d_f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.flv_round_def otr_ref_rel_def sa'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> otr_ref_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> otr_ref_rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"opt_v_state.decisions <span class="skolem">sa'</span> <span class="skolem">p</span> <span class="main">=</span> decision <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> otr_ref_rel_def sa'_def map_add_def d_f_def OTR_nextState_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"quorum_process.opt_no_defection majs <span class="skolem">sa'</span> <span class="main">(</span>Some <span class="main">∘</span> last_vote <span class="main">∘</span> <span class="skolem">sc'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sa'_def majorities.opt_no_defection_def map_add_def majorities.quorum_for_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="skolem">p</span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> majs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> last_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> old<span class="main">:</span> <span class="quoted"><span class="quoted">"last_vote <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> v_maj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> last_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span> <span class="main">∈</span> majs"</span></span> <span class="keyword1"><span class="command">using</span></span> Q Q_v
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> less_le_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> card_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"last_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> new<span class="main">:</span> <span class="quoted"><span class="quoted">"last_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"last_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 
          w_MFR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">=</span> Min <span class="main">{</span><span class="bound">z</span><span class="main">.</span> MFR <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="bound">z</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">=</span> Min <span class="var">?MFRs</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> dom_maj<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> majs"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> old new nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OTR_nextState_def majs_def dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> dom_maj <span class="keyword1"><span class="command">have</span></span> not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">elim</span> majorities.quorum_non_empty<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> MFR_exists <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mfr_v</span></span> <span class="keyword2"><span class="keyword">where</span></span> mfr_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mfr_v</span> <span class="main">∈</span> <span class="var">?MFRs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">from</span></span> not_empty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> card <span class="main">(</span>HOV <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HOV_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> MFR <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> w_MFR<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Min_in<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?MFRs</span> <span class="main">⊆</span> <span class="main">(</span>the <span class="keyword1">o</span> <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_empty
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> MFR_in_msgs<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?MFRs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MFR_exists<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> card_HOV<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>HOV <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>HOV <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="var">?w</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MFR_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v'</span><span class="main">.</span> HOV <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="bound">v'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> last_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v'</span><span class="main">}</span> <span class="main">∩</span> dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HOV_def get_msgs_benign OTR_sendMsg_def restrict_map_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> card_le1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">q</span><span class="main">.</span> last_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span> <span class="main">∩</span> dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">{</span><span class="bound">q</span><span class="main">.</span> last_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?w</span><span class="main">}</span> <span class="main">∩</span> dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> card_HOV
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">q</span><span class="main">.</span> last_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span> <span class="main">∩</span> dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">{</span><span class="bound">q</span><span class="main">.</span> last_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">v</span><span class="main">}</span> <span class="main">∩</span> dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> card_le1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> card_mono<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> qintersect_card<span class="main">[</span><span class="operator">OF</span> dom_maj v_maj<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute Collect_neg_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sa'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ra</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> quorum_process.flv_round majs <span class="bound">ra</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> otr_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> OTR_Refines_LV_VOting<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="main">(</span>otr_ref_rel<span class="main">)</span> 
    majorities.flv_TS <span class="main">(</span>OTR_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_basic<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init <span class="main">(</span>OTR_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">⊆</span> otr_ref_rel <span class="main">``</span> init <span class="main">(</span>quorum_process.flv_TS majs<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OTR_TS_def CHO_to_TS_def OTR_Alg_def CHOinitConfig_def OTR_initState_def
      majorities.flv_TS_def flv_init_def majorities.opt_no_defection_def majorities.quorum_for_def'
      otr_ref_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>otr_ref_rel<span class="main">}</span> TS.trans <span class="main">(</span>quorum_process.flv_TS majs<span class="main">)</span><span class="main">,</span> TS.trans <span class="main">(</span>OTR_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">{&gt;</span> otr_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_ref
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.flv_TS_defs OTR_TS_def CHO_to_TS_def OTR_Alg_def 
      CSHO_trans_alt_def CHO_trans_alt OTR_trans_step_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The termination proof for the algorithm is already given in the Heard-Of Model AFP
  entry, and we do not repeat it here.›</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Ate_Defs">
<div class="head">
<h1>Theory Ate_Defs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The $A_{T,E}$ Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Ate_Defs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/HOModel.html">Heard_Of.HOModel</a> <span class="quoted">"<a href="Consensus_Types.html">../Consensus_Types</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The contents of this file have been taken almost verbatim from the
  Heard Of Model AFP entry. The only difference is that the types have been
  changed.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following record models the local state of a process.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span>              <span class="comment1">― ‹current value held by process›</span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field of the initial state is unconstrained, but no
  decision has yet been taken.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ate_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="main">(</span>decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ate_parameters <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">T</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">E</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> TNaE<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">*</span><span class="main">(</span>N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span> <span class="main">-</span> <span class="free">E</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> TltN<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&lt;</span> N"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> EltN<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">&lt;</span> N"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following are consequences of the assumptions on the parameters.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> majE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">E</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">≥</span> N"</span></span>
<span class="keyword1"><span class="command">using</span></span> TNaE TltN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Egta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">&gt;</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> majE EltN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Tge2a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">α</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> TNaE EltN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  At every round, each process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>.
  If it received more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> messages, it selects the smallest value
  and store it in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>. As in algorithm \emph{OneThirdRule}, we
  therefore require values to be linearly ordered.

  If more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> messages holding the same value are received,
  the process decides that value.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mostOftenRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mostOftenRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>process <span class="main">⇒</span> <span class="tfree">'val</span> option<span class="main">)</span> <span class="main">≡</span>
   <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w</span><span class="main">.</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">Ate_sendMsg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> process <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_sendMsg</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> x <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Ate_nextState</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> pstate <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇒</span> <span class="tfree">'val</span> option<span class="main">)</span>
                        <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="keyword1">if</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>
      <span class="keyword1">then</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Min <span class="main">(</span>mostOftenRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span>   <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span>  <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span>
       <span class="main">∨</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span><span class="main">)</span> 
         <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Communication predicate for $A_{T,E}$›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ate_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_commPerRd</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOrs</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="bound">p</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">SHOrs</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> <span class="free">α</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The global communication predicate stipulates the three following
  conditions:
  \begin{itemize}
  \item for every process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> there are infinitely many rounds 
    where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> receives more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> messages,
  \item for every process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> there are infinitely many rounds 
    where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> receives more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E›</span></span></span></span> uncorrupted messages,
  \item and there are infinitely many rounds in which more than
    <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E - α›</span></span></span></span> processes receive uncorrupted messages from the
    same set of processes, which contains more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> processes.
  \end{itemize}
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Ate_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">≡</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span> <span class="bound">r</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">T</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span>  <span class="main">∃</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span> <span class="bound">r</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">E</span><span class="main">)</span>
   <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&gt;</span> <span class="bound">r</span><span class="main">.</span> <span class="main">∃</span><span class="bound">π1</span> <span class="bound">π2</span><span class="main">.</span>
        card <span class="bound">π1</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>
      <span class="main">∧</span> card <span class="bound">π2</span> <span class="main">&gt;</span> <span class="free">T</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="bound">π1</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">π2</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r'</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">π2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The $A_{T,E}$ Heard-Of machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the non-coordinated SHO machine for the Ate algorithm
  by assembling the algorithm definition and its communication-predicate.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ate_SHOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_SHOMachine</span> <span class="main">=</span> <span class="main">⦇</span> 
    CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> Ate_initState <span class="bound">p</span> <span class="main">(</span><span class="bound">st</span><span class="main">::</span><span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> pstate<span class="main">)</span><span class="main">)</span><span class="main">,</span>
    sendMsg <span class="main">=</span>  Ate_sendMsg<span class="main">,</span>
    CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> Ate_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span><span class="main">,</span>
    SHOcommPerRd <span class="main">=</span> <span class="main">(</span>Ate_commPerRd<span class="main">::</span> process HO <span class="main">⇒</span> process HO <span class="main">⇒</span> bool<span class="main">)</span><span class="main">,</span>
    SHOcommGlobal <span class="main">=</span> Ate_commGlobal
   <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_M</span> <span class="main">≡</span> <span class="main">(</span>Ate_SHOMachine<span class="main">::</span><span class="main">(</span>process<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span><span class="main">)</span> SHOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">― ‹locale <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"ate_parameters"</span><span class="antiquote">}</span></span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">(* theory AteDefs *)</span>
</pre>
</div><div id="Ate_Proofs">
<div class="head">
<h1>Theory Ate_Proofs</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Ate_Proofs
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Voting_Opt.html">../Voting_Opt</a>"</span> <a href="Ate_Defs.html">Ate_Defs</a> <a href="../Heard_Of/Majorities.html">Heard_Of.Majorities</a> 
  <span class="quoted">"<a href="HO_Transition_System.html">../HO_Transition_System</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> val_linorder<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>val<span class="main">,</span> linorder_class<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> val <span class="main">::</span> <span class="quoted">linorder</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val_linorder<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> ate_parameters
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">majs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process set<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">majs</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">S</span><span class="main">.</span> card <span class="bound">S</span> <span class="main">&gt;</span> <span class="free">E</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> majorities<span class="main">:</span> quorum_process <span class="quoted">majs</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="skolem">Q'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> majs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> majs"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"N <span class="main">&lt;</span> card <span class="skolem">Q</span> <span class="main">+</span> card <span class="skolem">Q'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> majE
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∩</span> <span class="skolem">Q'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> majorities_intersect<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> EltN
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">∈</span> majs"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">UNIV</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> div_less_dividend<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> p_TS_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span>process <span class="main">⇒</span> <span class="main">(</span>val pstate<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">K</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ate_Alg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_Alg</span> <span class="main">=</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> Ate_initState <span class="bound">p</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span>
     sendMsg <span class="main">=</span>  Ate_sendMsg<span class="main">,</span>
     CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> Ate_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span>
   <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Ate_TS</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process<span class="main">)</span>
  <span class="main">⇒</span> p_TS_state TS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_TS</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="main">=</span> CHO_to_TS Ate_Alg <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span>K <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Ate_TS_defs <span class="main">=</span> Ate_TS_def CHO_to_TS_def Ate_Alg_def CHOinitConfig_def
  Ate_initState_def

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Ate_trans_step</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">μ</span><span class="main">.</span>
   <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">,</span> Suc <span class="bound">r</span><span class="main">,</span> <span class="bound">cfg'</span><span class="main">)</span><span class="main">|</span><span class="bound">cfg</span> <span class="bound">cfg'</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>Ate_sendMsg <span class="bound">r</span><span class="main">)</span> <span class="bound">cfg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> Ate_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="bound">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">cfg'</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CSHOnextConfig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CSHOnextConfig</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">μ</span> <span class="main">∈</span> SHOmsgVectors <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HO</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHO</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span>
          CnextState <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">μ</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">coord</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> rHO <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process HO"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ate_ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_v_state <span class="main">×</span> p_TS_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ate_ref_rel</span> <span class="main">=</span>  <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">r</span> <span class="main">=</span> next_round <span class="bound">sa</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> decisions <span class="bound">sa</span> <span class="bound">p</span> <span class="main">=</span> Ate_Defs.decide <span class="main">(</span><span class="bound">sc</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> majorities.opt_no_defection <span class="bound">sa</span> <span class="main">(</span>Some <span class="keyword1">o</span> x <span class="keyword1">o</span> <span class="bound">sc</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decide_origin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="free">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>Ate_sendMsg <span class="free">r</span><span class="main">)</span> <span class="free">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"Ate_nextState <span class="free">r</span> <span class="free">p</span> <span class="main">(</span><span class="free">sc</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">sc'</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> new_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="free">sc'</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free">sc</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">sc'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="free">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span> <span class="main">∈</span> majs"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign Ate_sendMsg_def Ate_nextState_def
    majs_def restrict_map_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> other_values_received<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"Ate_nextState  <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">sc</span> <span class="free">q</span><span class="main">)</span> <span class="free">μq</span> <span class="main">(</span><span class="main">(</span><span class="free">sc'</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μq</span> <span class="main">∈</span> get_msgs <span class="main">(</span>Ate_sendMsg <span class="free">r</span><span class="main">)</span> <span class="free">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> vsent<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">sc</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
             <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?vsent</span> <span class="main">&gt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span> <span class="main">-</span> <span class="free">E</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> nxt muq
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span> <span class="main">-</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span>
        <span class="main">⊆</span>  <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">sc</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">≠</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?notvrcvd</span> <span class="main">-</span> <span class="var">?aho</span> <span class="main">⊆</span> <span class="var">?notvsent</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> get_msgs_def SHOmsgVectors_def Ate_SHOMachine_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?notvsent</span> <span class="main">≥</span> card <span class="main">(</span><span class="var">?notvrcvd</span> <span class="main">-</span> <span class="var">?aho</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?notvrcvd</span> <span class="main">-</span> <span class="var">?aho</span><span class="main">)</span> <span class="main">≥</span> card <span class="var">?notvrcvd</span> <span class="main">-</span> card <span class="var">?aho</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono diff_card_le_card_Diff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?notvsent</span> <span class="main">+</span> card <span class="var">?vsent</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?notvsent</span> <span class="main">∪</span> <span class="var">?vsent</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_Int<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?notvsent</span> <span class="main">∪</span> <span class="var">?vsent</span> <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span>process set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?notvsent</span> <span class="main">∪</span> <span class="var">?vsent</span><span class="main">)</span> <span class="main">=</span> N"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 1 vsent <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?notvsent</span> <span class="main">≤</span>  N <span class="main">-</span> <span class="main">(</span><span class="free">E</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> EltN Egta <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If more than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>E - α›</span></span></span></span> processes send a value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> to some
  process <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> at some round <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, and if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> receives more than
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>T›</span></span></span></span> messages in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> is the most frequently
  received value by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mostOftenRcvd_v<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"Ate_nextState  <span class="free">r</span> <span class="free">q</span> <span class="main">(</span><span class="free">sc</span> <span class="free">q</span><span class="main">)</span> <span class="free">μq</span> <span class="main">(</span><span class="main">(</span><span class="free">sc'</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> muq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μq</span> <span class="main">∈</span> get_msgs <span class="main">(</span>Ate_sendMsg <span class="free">r</span><span class="main">)</span> <span class="free">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> threshold_T<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span> <span class="main">&gt;</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> threshold_E<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="free">r</span> <span class="bound">qq</span> <span class="free">q</span> <span class="main">(</span><span class="free">sc</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> <span class="free">E</span> <span class="main">-</span> <span class="free">α</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mostOftenRcvd <span class="free">μq</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> muq <span class="keyword1"><span class="command">have</span></span> hodef<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span> <span class="main">=</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> get_msgs_def SHOmsgVectors_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> nxt muq threshold_E
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">≠</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">≤</span> N <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="free">α</span> <span class="main">-</span> <span class="free">E</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?heardnotv</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> other_values_received<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?heardnotv</span> <span class="main">≥</span> <span class="free">T</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> muq
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?heardnotv</span> <span class="main">=</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> SHOmsgVectors_def get_msgs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?heardnotv</span> <span class="main">=</span> card <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">-</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_Diff_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> hodef threshold_T <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span> <span class="main">&gt;</span> card <span class="var">?heardnotv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> TNaE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> hodef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="skolem">w</span><span class="main">}</span> <span class="main">⊆</span> <span class="var">?heardnotv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="skolem">w</span><span class="main">}</span> <span class="main">≤</span> card <span class="var">?heardnotv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">w</span><span class="main">.</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="bound">w</span><span class="main">}</span> <span class="main">≥</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="free">μq</span> <span class="bound">qq</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mostOftenRcvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ate_ref_rel<span class="main">}</span> 
      <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">.</span> majorities.flv_round <span class="bound">r</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">)</span><span class="main">,</span> 
      Ate_trans_step <span class="free">HOs</span> 
    <span class="main">{&gt;</span> ate_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs Ate_trans_step_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">r</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> ate_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>Ate_sendMsg <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> Ate_nextState <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> step<span class="main">=</span>send nxt
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d_f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d_f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">then</span> decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="main">⦇</span> 
    opt_v_state.next_round <span class="main">=</span> Suc <span class="skolem">r</span>
    <span class="main">,</span> opt_v_state.last_vote <span class="main">=</span> opt_v_state.last_vote <span class="skolem">sa</span> <span class="main">++</span> <span class="main">(</span>Some <span class="keyword1">o</span> x <span class="keyword1">o</span> <span class="skolem">sc</span><span class="main">)</span> 
    <span class="main">,</span> opt_v_state.decisions <span class="main">=</span> opt_v_state.decisions <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">d_f</span>
    <span class="main">⦈</span>"</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"majorities.d_guard <span class="skolem">d_f</span> <span class="main">(</span>Some <span class="keyword1">o</span> x <span class="keyword1">o</span> <span class="skolem">sc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.d_guard_def d_f_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span>
      <span class="quoted"><span class="quoted">"Some <span class="skolem">v</span> <span class="main">≠</span> decide <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> 
      decide_origin<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> μ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">μ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> HOs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">HOs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sc'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">sc'</span></span><span class="main">,</span> <span class="operator">OF</span> send<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span> nxt<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"quorum_process.locked_in_vf majs <span class="main">(</span>Some <span class="main">∘</span> x <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.locked_in_vf_def majorities.quorum_for_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.flv_round <span class="skolem">r</span> <span class="main">(</span>Some <span class="keyword1">o</span> x <span class="keyword1">o</span> <span class="skolem">sc</span><span class="main">)</span> <span class="skolem">d_f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.flv_round_def ate_ref_rel_def sa'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> ate_ref_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> ate_ref_rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"opt_v_state.decisions <span class="skolem">sa'</span> <span class="skolem">p</span> <span class="main">=</span> decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ate_ref_rel_def sa'_def map_add_def d_f_def Ate_nextState_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"quorum_process.opt_no_defection majs <span class="skolem">sa'</span> <span class="main">(</span>Some <span class="main">∘</span> x <span class="main">∘</span> <span class="skolem">sc'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sa'_def majorities.opt_no_defection_def map_add_def majorities.quorum_for_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="skolem">p</span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> majs"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> x <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> old<span class="main">:</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> v_maj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span> <span class="main">∈</span> majs"</span></span> <span class="keyword1"><span class="command">using</span></span> Q Q_v
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> less_le_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> card_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> <span class="skolem">μ</span> <span class="skolem">p</span> <span class="bound">qq</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">-</span> <span class="free">α</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">qq</span><span class="main">.</span> sendMsg Ate_M <span class="skolem">r</span> <span class="bound">qq</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">qq</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v_maj
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ate_SHOMachine_def Ate_sendMsg_def majs_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> mostOftenRcvd_v<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> HOs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">HOs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sc<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">sc</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> sc'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">sc'</span></span><span class="main">,</span> 
          <span class="operator">OF</span> nxt<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span> send<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span> True this<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> old
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ate_nextState_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> old
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ate_nextState_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sa'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ra</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> quorum_process.flv_round majs <span class="bound">ra</span> <span class="bound">v_f</span> <span class="bound">d_f</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> ate_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Ate_Refines_LV_VOting<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="main">(</span>ate_ref_rel<span class="main">)</span> 
    majorities.flv_TS <span class="main">(</span>Ate_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_basic<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init <span class="main">(</span>Ate_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">⊆</span> ate_ref_rel <span class="main">``</span> init <span class="main">(</span>quorum_process.flv_TS majs<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ate_TS_def CHO_to_TS_def Ate_Alg_def CHOinitConfig_def Ate_initState_def
      majorities.flv_TS_def flv_init_def majorities.opt_no_defection_def majorities.quorum_for_def'
      ate_ref_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>ate_ref_rel<span class="main">}</span> TS.trans <span class="main">(</span>quorum_process.flv_TS majs<span class="main">)</span><span class="main">,</span> TS.trans <span class="main">(</span>Ate_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">{&gt;</span> ate_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_ref
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.flv_TS_defs Ate_TS_def CHO_to_TS_def Ate_Alg_def 
      CSHO_trans_alt_def CHO_trans_alt Ate_trans_step_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">― ‹context <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"ate_parameters"</span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The termination proof for the algorithm is already given in the Heard-Of Model AFP
  entry, and we do not repeat it here.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>   <span class="comment1">(* theory AteProof *)</span>

</pre>
</div><div id="Same_Vote">
<div class="head">
<h1>Theory Same_Vote</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Same Vote Model›</span></span>
                                                                                            
<span class="keyword1"><span class="command">theory</span></span> Same_Vote
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Voting.html">Voting</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> quorum_process <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model definition›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The system state remains the same as in the Voting model, but the
  voting event is changed.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_state <span class="main">⇒</span> round <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  safe_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">safe</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> 
    <span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">Q</span> <span class="main">∈</span> <span class="free">Quorum</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span>votes <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">r'</span><span class="main">)</span> <span class="main">`</span> <span class="bound">Q</span> <span class="main">=</span> <span class="main">{</span>Some <span class="bound">w</span><span class="main">}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="bound">w</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">safe</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is easier to reason about in Isabelle.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> safe_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"safe <span class="free">s</span> <span class="free">r</span> <span class="free">v</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&lt;</span> <span class="free">r</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Q</span> <span class="bound">w</span><span class="main">.</span> quorum_for <span class="bound">Q</span> <span class="bound">w</span> <span class="main">(</span>votes <span class="free">s</span> <span class="bound">r'</span><span class="main">)</span>  <span class="main">⟶</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_def' quorum_for_def' Ball_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sv_round</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> process set <span class="main">⇒</span> val <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>v_state <span class="main">×</span> v_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sv_round</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span>
     <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> safe <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>
     <span class="main">∧</span> d_guard <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">(</span>const_map <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
     <span class="main">∧</span> <span class="comment1">― ‹actions›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
       <span class="main">,</span> votes <span class="main">:=</span> <span class="main">(</span>votes <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> const_map <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
       <span class="main">,</span> decisions <span class="main">:=</span> <span class="main">(</span>decisions <span class="bound">s</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sv_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v_state <span class="main">×</span> v_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sv_trans</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">D</span><span class="main">.</span> sv_round <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">D</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sv_TS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_state TS"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sv_TS</span> <span class="main">=</span> <span class="main">⦇</span> init <span class="main">=</span> v_init<span class="main">,</span> trans <span class="main">=</span> sv_trans <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sv_TS_defs <span class="main">=</span> sv_TS_def v_init_def sv_trans_def

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_imp_no_defection<span class="main">:</span>
  <span class="quoted"><span class="quoted">"safe <span class="free">s</span> <span class="main">(</span>next_round <span class="free">s</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> no_defection <span class="free">s</span> <span class="main">(</span>const_map <span class="free">v</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>next_round <span class="free">s</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_def no_defection_def restrict_map_def const_map_def<span class="main">)</span>
 
<span class="keyword1"><span class="command">lemma</span></span> const_map_quorum_locked<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟹</span> locked_in_vf <span class="main">(</span>const_map <span class="free">v</span> <span class="free">S</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> locked_in_vf_def const_map_def quorum_for_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sv_round_refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>Id<span class="main">}</span> v_round <span class="free">r</span> <span class="main">(</span>const_map <span class="free">v</span> <span class="free">S</span><span class="main">)</span> <span class="free">r_decisions</span><span class="main">,</span> sv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">r_decisions</span> <span class="main">{&gt;</span> Id<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs sv_round_def v_round_def  no_defection_empty
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_imp_no_defection const_map_quorum_locked<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Same_Vote_Refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines Id v_TS sv_TS"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def sv_TS_def sv_trans_def v_TS_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 
    sv_round_refines relhoare_refl<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SV_inv3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SV_inv3</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> 
    votes <span class="bound">s</span> <span class="bound">r</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> votes <span class="bound">s</span> <span class="bound">r</span> <span class="bound">b</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">w</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> SV_inv3I <span class="main">=</span> SV_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> SV_inv3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> SV_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> SV_inv3D <span class="main">=</span> SV_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
 
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proof of invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> SV_inv3_v_round<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>SV_inv3<span class="main">}</span> sv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">D</span> <span class="main">{&gt;</span> SV_inv3<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> SV_inv3I<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sv_round_def const_map_def restrict_map_def SV_inv3_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> SV_inv3_event_pres <span class="main">=</span> SV_inv3_v_round 

<span class="keyword1"><span class="command">lemma</span></span> SV_inv3_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init sv_TS <span class="main">⊆</span> SV_inv3"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>SV_inv3<span class="main">}</span> trans sv_TS <span class="main">{&gt;</span> SV_inv3<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sv_TS_defs SV_inv3_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sv_TS_defs SV_inv3_event_pres<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SV_inv3_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"reach sv_TS <span class="main">⊆</span> SV_inv3"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inv_rule_basic SV_inv3_inductive <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹

This is a different characterization of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">safe</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, due to Lampson~\cite{lampson_abcds_2001}:
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">safe'</span></span> <span class="free"><span class="free">s</span></span> <span class="free"><span class="free">r</span></span> <span class="free"><span class="free">v</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound">r'</span></span></span></span><span class="main"><span class="main">&lt;</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">Q</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">Quorum</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">a</span></span> <span class="main"><span class="main">∈</span></span> <span class="bound"><span class="bound">Q</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">w</span></span><span class="main"><span class="main">.</span></span> votes <span class="free"><span class="free">s</span></span> <span class="bound"><span class="bound">r'</span></span> <span class="bound"><span class="bound">a</span></span> <span class="main"><span class="main">=</span></span> Some <span class="bound"><span class="bound">w</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">w</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">v</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

It is, however, strictly stronger than our characterization, since we do not at this point assume
the "completeness" of our quorum system (for any set S, either S or the complement of S is a
quorum), and the following is thus not provable: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">∈</span></span> SV_inv3 <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">safe'</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> safe <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer of abstract invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> SV_inv1_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init sv_TS <span class="main">⊆</span> Vinv1"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv1<span class="main">}</span> trans sv_TS <span class="main">{&gt;</span> Vinv1<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> abs_INV_init_transfer<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Same_Vote_Refines Vinv1_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> abs_INV_trans_transfer<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Same_Vote_Refines Vinv1_inductive<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> SV_inv1_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach sv_TS <span class="main">⊆</span> Vinv1"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> abs_INV_transfer<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Same_Vote_Refines Vinv1_invariant<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SV_inv2_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init sv_TS <span class="main">⊆</span> Vinv2"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv2 <span class="main">∩</span> Vinv1<span class="main">}</span> trans sv_TS <span class="main">{&gt;</span> Vinv2<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> abs_INV_init_transfer<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Same_Vote_Refines Vinv2_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> abs_INV_trans_transfer<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Same_Vote_Refines Vinv2_inductive<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> SV_inv2_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach sv_TS <span class="main">⊆</span> Vinv2"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> abs_INV_transfer<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Same_Vote_Refines Vinv2_invariant<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additional invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹With Same Voting, the voted values are safe in the next round.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SV_inv4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SV_inv4</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> votes <span class="bound">s</span> <span class="bound">r</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> safe <span class="bound">s</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">)</span> <span class="bound">v</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> SV_inv4I <span class="main">=</span> SV_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> SV_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> SV_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> SV_inv4D <span class="main">=</span> SV_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> SV_inv4_sv_round<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>SV_inv4 <span class="main">∩</span> <span class="main">(</span>Vinv1 <span class="main">∩</span> Vinv2<span class="main">)</span><span class="main">}</span> sv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">D</span> <span class="main">{&gt;</span> SV_inv4<span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> SV_inv4I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">v'</span> <span class="skolem">a</span> <span class="skolem">r'</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span> 
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> sv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> invs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> SV_inv4"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Vinv1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Vinv2"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vote<span class="main">:</span> <span class="quoted"><span class="quoted">"votes <span class="skolem">s'</span> <span class="skolem">r'</span> <span class="skolem">a</span> <span class="main">=</span> Some <span class="skolem">v'</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"safe <span class="skolem">s'</span> <span class="main">(</span>Suc <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">v'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">=</span><span class="skolem">r'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe <span class="skolem">s'</span> <span class="skolem">r'</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step vote
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sv_round_def const_map_is_Some safe_def quorum_for_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step vote
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_def less_Suc_eq sv_round_def quorum_for_def const_map_is_Some 
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> quorum_non_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sv_round_def safe_def Vinv2_def Vinv1_def  SV_inv4_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Quorum_not_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> SV_inv4_event_pres <span class="main">=</span> SV_inv4_sv_round 

<span class="keyword1"><span class="command">lemma</span></span> SV_inv4_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init sv_TS <span class="main">⊆</span> SV_inv4"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>SV_inv4 <span class="main">∩</span> <span class="main">(</span>Vinv1 <span class="main">∩</span> Vinv2<span class="main">)</span><span class="main">}</span> trans sv_TS <span class="main">{&gt;</span> SV_inv4<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sv_TS_defs SV_inv4_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sv_TS_defs SV_inv4_event_pres<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SV_inv4_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"reach sv_TS <span class="main">⊆</span> SV_inv4"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inv_rule_incr<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> SV_inv4_inductive SV_inv2_invariant SV_inv1_invariant <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context quorum_process *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Observing_Quorums">
<div class="head">
<h1>Theory Observing_Quorums</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Observing Quorums Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Observing_Quorums
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Same_Vote.html">Same_Vote</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model definition›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The state adds one field to the Voting model state:›</span></span>
<span class="keyword1"><span class="command">record</span></span> obsv_state <span class="main">=</span> <span class="quoted">v_state</span> <span class="main">+</span>
  obs <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span> map"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the observation mechanism to work, we need monotonicity of quorums.›</span></span>
<span class="keyword1"><span class="command">context</span></span> mono_quorum <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obs_safe</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obs_safe</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> obs <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">r'</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obsv_round</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> process set <span class="main">⇒</span> val <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> process set <span class="main">⇒</span> <span class="main">(</span>obsv_state <span class="main">×</span> obsv_state<span class="main">)</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obsv_round</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="free"><span class="bound"><span class="entity">Os</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span>
     <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> obs_safe <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>
     <span class="main">∧</span> d_guard <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">(</span>const_map <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Os</span></span></span> <span class="main">=</span> UNIV<span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Os</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>
     <span class="main">∧</span> <span class="comment1">― ‹actions›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
       <span class="main">,</span> votes <span class="main">:=</span> <span class="main">(</span>votes <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> const_map <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
       <span class="main">,</span> decisions <span class="main">:=</span> decisions <span class="bound">s</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span>
       <span class="main">,</span> obs <span class="main">:=</span> <span class="main">(</span>obs <span class="bound">s</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> const_map <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">Os</span></span></span><span class="main">)</span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obsv_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>obsv_state <span class="main">×</span> obsv_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obsv_trans</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">d_f</span> <span class="bound">Os</span><span class="main">.</span> obsv_round <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">d_f</span> <span class="bound">Os</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obsv_init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"obsv_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obsv_init</span> <span class="main">=</span> <span class="main">{</span> <span class="main">⦇</span> next_round <span class="main">=</span> <span class="main">0</span><span class="main">,</span> votes <span class="main">=</span> <span class="main">λ</span><span class="bound">r</span> <span class="bound">a</span><span class="main">.</span> None<span class="main">,</span> decisions <span class="main">=</span> Map.empty<span class="main">,</span> obs <span class="main">=</span> <span class="main">λ</span><span class="bound">r</span> <span class="bound">a</span><span class="main">.</span> None <span class="main">⦈</span> <span class="main">}</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obsv_TS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"obsv_state TS"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obsv_TS</span> <span class="main">=</span> <span class="main">⦇</span> init <span class="main">=</span> obsv_init<span class="main">,</span> trans <span class="main">=</span> obsv_trans <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> obsv_TS_defs <span class="main">=</span> obsv_TS_def obsv_init_def obsv_trans_def


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OV_inv1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OV_inv1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="bound">Q</span> <span class="bound">v</span><span class="main">.</span> quorum_for <span class="bound">Q</span> <span class="bound">v</span> <span class="main">(</span>votes <span class="bound">s</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">Q'</span> <span class="main">∈</span> <span class="free">Quorum</span><span class="main">.</span> quorum_for <span class="bound">Q'</span> <span class="bound">v</span> <span class="main">(</span>obs <span class="bound">s</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> OV_inv1I <span class="main">=</span> OV_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OV_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> OV_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OV_inv1D <span class="main">=</span> OV_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
 
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> OV_inv1_obsv_round<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>OV_inv1<span class="main">}</span> obsv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">d_f</span> <span class="free">Ob</span> <span class="main">{&gt;</span> OV_inv1<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> OV_inv1I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">Q</span> <span class="skolem">Q'</span> <span class="skolem">r'</span>
  <span class="keyword3"><span class="command">assume</span></span> 
    Q<span class="main">:</span> <span class="quoted"><span class="quoted">"quorum_for <span class="skolem">Q</span> <span class="skolem">v'</span> <span class="main">(</span>votes <span class="skolem">s'</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> OV_inv1"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> obsv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">d_f</span> <span class="free">Ob</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> quorum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q'</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Q inv<span class="main">[</span><span class="operator">THEN</span> OV_inv1D<span class="main">]</span> step quorum
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"quorum_for <span class="skolem">Q'</span> <span class="skolem">v'</span> <span class="main">(</span>obs <span class="skolem">s'</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span><span class="main">=</span><span class="free">r</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword2"><span class="keyword">and</span></span> Q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_round_def obs_safe_def quorum_for_def const_map_is_Some
        ball_conj_distrib subset_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mono_quorum<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>      
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step inv<span class="main">[</span><span class="operator">THEN</span> OV_inv1D<span class="main">]</span> Q quorum
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_round_def obs_safe_def quorum_for_def const_map_is_Some
        ball_conj_distrib subset_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> quorum_non_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_round_def obs_safe_def quorum_for_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> OV_inv1_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init obsv_TS <span class="main">⊆</span> OV_inv1"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>OV_inv1<span class="main">}</span> trans obsv_TS <span class="main">{&gt;</span> OV_inv1<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_TS_defs OV_inv1_def<span class="main">)</span> 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_TS_defs OV_inv1_obsv_round quorum_for_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> empty_not_quorum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> quorum_for_const_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>quorum_for <span class="free">Q</span> <span class="free">w</span> <span class="main">(</span>const_map <span class="free">v</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quorum_for_def const_map_is_Some <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> quorum_non_empty<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obsv_ref_rel</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">obsv_ref_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">sa</span> <span class="main">=</span> v_state.truncate <span class="bound">sc</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> obsv_round_refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>obsv_ref_rel <span class="main">∩</span> UNIV <span class="main">×</span> OV_inv1<span class="main">}</span> sv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">dec_f</span><span class="main">,</span> obsv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">dec_f</span> <span class="free">Ob</span> <span class="main">{&gt;</span> obsv_ref_rel<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs sv_round_def obsv_round_def safe_def obsv_ref_rel_def 
    v_state.truncate_def obs_safe_def quorum_for_def OV_inv1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I UNIV_quorum  option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Observable_Refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="main">(</span>obsv_ref_rel <span class="main">∩</span> UNIV <span class="main">×</span> OV_inv1<span class="main">)</span> sv_TS obsv_TS"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_using_invariants<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init obsv_TS <span class="main">⊆</span> obsv_ref_rel <span class="main">``</span> init sv_TS"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def sv_TS_defs  obsv_TS_defs  obsv_ref_rel_def 
    v_state.truncate_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>obsv_ref_rel <span class="main">∩</span> UNIV <span class="main">×</span> OV_inv1<span class="main">}</span> trans sv_TS<span class="main">,</span> trans obsv_TS <span class="main">{&gt;</span> obsv_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def sv_TS_defs  obsv_TS_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 
      obsv_round_refines relhoare_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OV_inv1_inductive <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Additional invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OV_inv2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OV_inv2</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">r</span></span> <span class="main">≥</span> next_round <span class="bound">s</span><span class="main">.</span> obs <span class="bound">s</span> <span class="bound">r</span> <span class="main">=</span> Map.empty <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> OV_inv2I <span class="main">=</span> OV_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OV_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> OV_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OV_inv2D <span class="main">=</span> OV_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OV_inv3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OV_inv3</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> obs <span class="bound">s</span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span>
    obs_safe <span class="bound">r</span> <span class="bound">s</span> <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> OV_inv3I <span class="main">=</span> OV_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OV_inv3E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> OV_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OV_inv3D <span class="main">=</span> OV_inv3_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OV_inv4</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OV_inv4</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> obs <span class="bound">s</span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> obs <span class="bound">s</span> <span class="bound">r</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span>
    <span class="bound">w</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> OV_inv4I <span class="main">=</span> OV_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OV_inv4E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> OV_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OV_inv4D <span class="main">=</span> OV_inv4_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of additional invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> OV_inv2_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init obsv_TS <span class="main">⊆</span> OV_inv2"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>OV_inv2<span class="main">}</span> trans obsv_TS <span class="main">{&gt;</span> OV_inv2<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs OV_inv2_def obsv_TS_defs obsv_round_def const_map_is_Some<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SVinv3_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init obsv_TS <span class="main">⊆</span> SV_inv3"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>SV_inv3<span class="main">}</span> trans obsv_TS <span class="main">{&gt;</span> SV_inv3<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs SV_inv3_def obsv_TS_defs obsv_round_def const_map_is_Some<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> OV_inv3_obsv_round<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">{</span>OV_inv3 <span class="main">∩</span> OV_inv2<span class="main">}</span> obsv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">D</span> <span class="free">Ob</span> <span class="main">{&gt;</span> OV_inv3<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> OV_inv3I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">r_w</span> <span class="skolem">p</span> <span class="skolem">w</span>
  <span class="keyword3"><span class="command">assume</span></span> Assms<span class="main">:</span>
    <span class="quoted"><span class="quoted">"obs <span class="skolem">s'</span> <span class="skolem">r_w</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> OV_inv3"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> obsv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">D</span> <span class="free">Ob</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> OV_inv2"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> OV_inv2"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_TS_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OV_inv2_inductive<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> hoareD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> OV_inv2›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r_w</span> <span class="main">≤</span> next_round <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OV_inv2_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> leI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> r_w_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r_w</span> <span class="main">≤</span> next_round <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_round_def le_Suc_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"obs_safe <span class="skolem">r_w</span> <span class="skolem">s'</span> <span class="skolem">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r_w</span> <span class="main">=</span> next_round <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Assms
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_round_def const_map_is_Some obs_safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r_w</span> <span class="main">&lt;</span> next_round <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_w_le
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> less_le<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">≠</span> next_round <span class="skolem">s</span> <span class="main">⟶</span> obs <span class="skolem">s'</span> <span class="bound">r'</span> <span class="main">=</span> obs <span class="skolem">s</span> <span class="bound">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_round_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">r'</span></span> <span class="main">≤</span> <span class="skolem">r_w</span><span class="main">.</span> obs <span class="skolem">s'</span> <span class="bound">r'</span> <span class="main">=</span> obs <span class="skolem">s</span> <span class="bound">r'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Assms
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OV_inv3_def obs_safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> OV_inv3_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init obsv_TS <span class="main">⊆</span> OV_inv3"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>OV_inv3 <span class="main">∩</span> OV_inv2<span class="main">}</span> trans obsv_TS <span class="main">{&gt;</span> OV_inv3<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_TS_def obsv_trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OV_inv3_obsv_round<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_init_def OV_inv3_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> OV_inv4_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init obsv_TS <span class="main">⊆</span> OV_inv4"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>OV_inv4<span class="main">}</span> trans obsv_TS <span class="main">{&gt;</span> OV_inv4<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_hoare_defs OV_inv4_def obsv_TS_defs obsv_round_def const_map_is_Some<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Observing_Quorums_Opt">
<div class="head">
<h1>Theory Observing_Quorums_Opt</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Optimized Observing Quorums Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Observing_Quorums_Opt
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Observing_Quorums.html">Observing_Quorums</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model definition›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">record</span></span> opt_obsv_state <span class="main">=</span> 
  next_round <span class="main">::</span> <span class="quoted">round</span> 
  decisions <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map"</span></span>
  last_obs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map"</span></span>

<span class="keyword1"><span class="command">context</span></span> mono_quorum
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt_obs_safe</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt_obs_safe</span> <span class="free"><span class="bound"><span class="entity">obs_f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">obs_f</span></span></span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">olv_round</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">olv_round</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="free"><span class="bound"><span class="entity">Ob</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span>
    <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> opt_obs_safe <span class="main">(</span>last_obs <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Ob</span></span></span> <span class="main">=</span> UNIV<span class="main">)</span>
    <span class="main">∧</span> d_guard <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">(</span>const_map <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Ob</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">∧</span> <span class="comment1">― ‹actions›</span>
    <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
     next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="main">,</span> decisions <span class="main">:=</span> decisions <span class="bound">s</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span>
     <span class="main">,</span> last_obs <span class="main">:=</span> last_obs <span class="bound">s</span> <span class="main">++</span> const_map <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">Ob</span></span></span>
   <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">olv_init</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">olv_init</span> <span class="main">=</span> <span class="main">{</span> <span class="main">⦇</span> next_round <span class="main">=</span> <span class="main">0</span><span class="main">,</span> decisions <span class="main">=</span> Map.empty<span class="main">,</span> last_obs <span class="main">=</span> Map.empty <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">olv_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_obsv_state <span class="main">×</span> opt_obsv_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">olv_trans</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">D</span> <span class="bound">Ob</span><span class="main">.</span> olv_round <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">D</span> <span class="bound">Ob</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">olv_TS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opt_obsv_state TS"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">olv_TS</span> <span class="main">=</span> <span class="main">⦇</span> init <span class="main">=</span> olv_init<span class="main">,</span> trans <span class="main">=</span> olv_trans <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> olv_TS_defs <span class="main">=</span> olv_TS_def olv_init_def olv_trans_def

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">olv_ref_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">olv_ref_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>
    next_round <span class="bound">sc</span> <span class="main">=</span> v_state.next_round <span class="bound">sa</span>
    <span class="main">∧</span> decisions <span class="bound">sc</span> <span class="main">=</span> v_state.decisions <span class="bound">sa</span>
    <span class="main">∧</span> last_obs <span class="bound">sc</span> <span class="main">=</span> map_option snd <span class="keyword1">o</span> process_mru <span class="main">(</span>obsv_state.obs <span class="bound">sa</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> OV_inv2_finite_map_graph<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> OV_inv2 <span class="main">⟹</span> finite <span class="main">(</span>map_graph <span class="main">(</span>case_prod <span class="main">(</span>obsv_state.obs <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_dom_finite_map_graph<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">..&lt;</span></span> v_state.next_round <span class="free"><span class="free">s</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">×</span></span> UNIV"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> OV_inv2_def dom_def not_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> OV_inv2_finite_obs_set<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> OV_inv2 <span class="main">⟹</span> finite <span class="main">(</span>vote_set <span class="main">(</span>obsv_state.obs <span class="free">s</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> OV_inv2_finite_map_graph<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_graph_def fun_graph_def vote_set_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">r</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">r</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>   

<span class="keyword1"><span class="command">lemma</span></span> olv_round_refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>olv_ref_rel <span class="main">∩</span> <span class="main">(</span>OV_inv2 <span class="main">∩</span> OV_inv3 <span class="main">∩</span> OV_inv4<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span> obsv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">D</span> <span class="free">Ob</span><span class="main">,</span> olv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">D</span> <span class="free">Ob</span> <span class="main">{&gt;</span>olv_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="main">::</span> <span class="quoted">obsv_state</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">sc</span> <span class="skolem">sc'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ainv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> OV_inv2"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> OV_inv3"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> OV_inv4"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> olv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">D</span> <span class="free">Ob</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> olv_ref_rel"</span></span>

  <span class="comment1">― ‹Abstract guard.›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> obs_safe <span class="main">(</span>v_state.next_round <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">sa</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> S_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> no_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> obs_safe <span class="main">(</span>v_state.next_round <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">sa</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> no_Q <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r_w</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      r_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r_w</span> <span class="main">&lt;</span> v_state.next_round <span class="skolem">sa</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> all_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> obsv_state.obs <span class="skolem">sa</span> <span class="skolem">r_w</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ainv<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> OV_inv4D<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_safe_def<span class="main">)</span>  <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> diff step R <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      p_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="main">(</span>map_option snd <span class="main">∘</span> process_mru <span class="main">(</span>obsv_state.obs <span class="skolem">sa</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> Some <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_obs_safe_def quorum_for_def olv_round_def  olv_ref_rel_def<span class="main">)</span>  
       <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> all_obs <span class="keyword1"><span class="command">have</span></span> nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"vote_set <span class="main">(</span>obsv_state.obs <span class="skolem">sa</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  vote_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r_w'</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">"process_mru <span class="main">(</span>obsv_state.obs <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r_w'</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_def mru_of_set_def<span class="main">)</span> 
        <span class="main">(</span><span class="operator">metis</span> option_Max_by_def surj_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r_w'</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">=</span> Max_by fst <span class="main">(</span>vote_set <span class="main">(</span>obsv_state.obs <span class="skolem">sa</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_def mru_of_set_def option_Max_by_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> w'_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r_w'</span><span class="main">,</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∈</span> vote_set <span class="main">(</span>obsv_state.obs <span class="skolem">sa</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Max_by_in<span class="main">[</span><span class="operator">OF</span> OV_inv2_finite_obs_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ainv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> nempty<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r_w</span> <span class="main">≤</span> <span class="skolem">r_w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> all_obs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> Max_by_ge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> OV_inv2_finite_obs_set<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> ainv<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">p</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">r_w</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">w</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="quoted">fst</span></span><span class="main"><span class="main">,</span></span> 
                            <span class="operator">simplified</span> max<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quorum_for_def vote_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">≠</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_w w' S_nonempty
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r_w</span> <span class="main">&lt;</span> <span class="skolem">r_w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> all_obs w'_obs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">elim</span> le_neq_implies_less<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> quorum_for_def vote_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> ainv<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> OV_inv3D<span class="main">]</span> w'_obs all_obs <span class="quoted"><span class="quoted">‹<span class="skolem">w'</span> <span class="main">≠</span> <span class="skolem">w</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def obs_safe_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Action refinement.›</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span>map_option snd <span class="main">∘</span> process_mru <span class="main">(</span>obsv_state.obs <span class="skolem">sa</span><span class="main">)</span><span class="main">)</span> <span class="main">++</span> const_map <span class="free">v</span> <span class="free">Ob</span> <span class="main">=</span>
      map_option snd <span class="main">∘</span> process_mru <span class="main">(</span><span class="main">(</span>obsv_state.obs <span class="skolem">sa</span><span class="main">)</span><span class="main">(</span>v_state.next_round <span class="skolem">sa</span> <span class="main">:=</span> const_map <span class="free">v</span> <span class="free">Ob</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sa</span> <span class="main">∈</span> OV_inv2›</span></span><span class="main">[</span><span class="operator">THEN</span> OV_inv2D<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">r'</span></span><span class="main">≥</span>v_state.next_round <span class="skolem">sa</span><span class="main">.</span> obsv_state.obs <span class="skolem">sa</span> <span class="bound">r'</span> <span class="main">=</span> Map.empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def const_map_def restrict_map_def process_mru_new_votes<span class="main"><span class="main">[</span></span><span class="operator">OF</span> empty<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> obsv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">D</span> <span class="free">Ob</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> olv_ref_rel"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> R step
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_round_def olv_round_def olv_ref_rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> OLV_Refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="main">(</span>olv_ref_rel <span class="main">∩</span> <span class="main">(</span>OV_inv2 <span class="main">∩</span> OV_inv3 <span class="main">∩</span> OV_inv4<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span> obsv_TS olv_TS"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_using_invariants<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init olv_TS <span class="main">⊆</span> olv_ref_rel <span class="main">``</span> init obsv_TS"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obsv_TS_defs olv_TS_defs olv_ref_rel_def process_mru_def mru_of_set_def
      vote_set_def option_Max_by_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span>olv_ref_rel <span class="main">∩</span> <span class="main">(</span>OV_inv2 <span class="main">∩</span> OV_inv3 <span class="main">∩</span> OV_inv4<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span> TS.trans obsv_TS<span class="main">,</span> TS.trans olv_TS <span class="main">{&gt;</span> olv_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def obsv_TS_defs olv_TS_defs 
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> olv_round_refines<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OV_inv2_inductive OV_inv3_inductive OV_inv4_inductive
  OV_inv2_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> OV_inv3_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> 
  OV_inv4_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Two_Step_Observing">
<div class="head">
<h1>Theory Two_Step_Observing</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Two-Step Observing Quorums Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Two_Step_Observing
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Observing_Quorums_Opt.html">../Observing_Quorums_Opt</a>"</span> <span class="quoted">"<a href="Two_Steps.html">../Two_Steps</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To make the coming proofs of concrete algorithms easier, in this model we split 
  the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">olv_round</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into two steps.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model definition›</span></span>
<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">record</span></span> tso_state <span class="main">=</span> <span class="quoted">opt_obsv_state</span> <span class="main">+</span>
  r_votes <span class="main">::</span> <span class="quoted"><span class="quoted">"process <span class="main">⇒</span> val option"</span></span>

<span class="keyword1"><span class="command">context</span></span> mono_quorum
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tso_round0</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> process set <span class="main">⇒</span> val <span class="main">⇒</span> <span class="main">(</span>tso_state <span class="main">×</span> tso_state<span class="main">)</span>set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tso_round0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span>
    <span class="main">∧</span> two_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span>
    <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> opt_obs_safe <span class="main">(</span>last_obs <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>
    <span class="comment1">― ‹actions›</span>
    <span class="main">∧</span> <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="main">,</span> r_votes <span class="main">:=</span> const_map <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">obs_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obs_guard</span> <span class="free"><span class="bound"><span class="entity">r_obs</span></span></span> <span class="free"><span class="bound"><span class="entity">r_v</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r_obs</span></span></span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r_v</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">r_v</span></span></span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">r_v</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r_obs</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r_v</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tso_round1</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>tso_state <span class="main">×</span> tso_state<span class="main">)</span>set"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tso_round1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="free"><span class="bound"><span class="entity">r_obs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
    <span class="comment1">― ‹guards›</span>
    <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span>
    <span class="main">∧</span> two_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span>
    <span class="main">∧</span> d_guard <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">(</span>r_votes <span class="bound">s</span><span class="main">)</span>
    <span class="main">∧</span> obs_guard <span class="free"><span class="bound"><span class="entity">r_obs</span></span></span> <span class="main">(</span>r_votes <span class="bound">s</span><span class="main">)</span>
    <span class="comment1">― ‹actions›</span>
    <span class="main">∧</span> <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span>
      next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="main">,</span> decisions <span class="main">:=</span> decisions <span class="bound">s</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span>
      <span class="main">,</span> last_obs <span class="main">:=</span> last_obs <span class="bound">s</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_obs</span></span></span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tso_init</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tso_init</span> <span class="main">=</span> <span class="main">{</span> <span class="main">⦇</span> next_round <span class="main">=</span> <span class="main">0</span><span class="main">,</span> decisions <span class="main">=</span> Map.empty<span class="main">,</span> last_obs <span class="main">=</span> Map.empty<span class="main">,</span> r_votes <span class="main">=</span> Map.empty <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tso_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tso_state <span class="main">×</span> tso_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tso_trans</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> tso_round0 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">.</span> tso_round1 <span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tso_TS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tso_state TS"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tso_TS</span> <span class="main">=</span> <span class="main">⦇</span> init <span class="main">=</span> tso_init<span class="main">,</span> trans <span class="main">=</span> tso_trans <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> tso_TS_defs <span class="main">=</span> tso_TS_def tso_init_def tso_trans_def

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basic_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_obsv_state <span class="main">×</span> tso_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basic_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>
    next_round <span class="bound">sa</span> <span class="main">=</span> two_phase <span class="main">(</span>next_round <span class="bound">sc</span><span class="main">)</span>
    <span class="main">∧</span> last_obs <span class="bound">sc</span> <span class="main">=</span> last_obs <span class="bound">sa</span>
    <span class="main">∧</span> decisions <span class="bound">sc</span> <span class="main">=</span> decisions <span class="bound">sa</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step0_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_obsv_state <span class="main">×</span> tso_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step0_rel</span> <span class="main">=</span> basic_rel"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step1_add_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_obsv_state <span class="main">×</span> tso_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step1_add_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">S</span> <span class="bound">v</span><span class="main">.</span>
    r_votes <span class="bound">sc</span> <span class="main">=</span> const_map <span class="bound">v</span> <span class="bound">S</span>
    <span class="main">∧</span> <span class="main">(</span><span class="bound">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> opt_obs_safe <span class="main">(</span>last_obs <span class="bound">sc</span><span class="main">)</span> <span class="bound">v</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step1_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_obsv_state <span class="main">×</span> tso_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step1_rel</span> <span class="main">=</span> basic_rel <span class="main">∩</span> step1_add_rel"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tso_ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_obsv_state <span class="main">×</span> tso_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tso_ref_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span>two_step <span class="main">(</span>next_round <span class="bound">sc</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="main">∈</span> step0_rel<span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span>two_step <span class="main">(</span>next_round <span class="bound">sc</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> 
        <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="main">∈</span> step1_rel
        <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">sc'</span> <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">sc'</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="main">∈</span> tso_round0 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span> <span class="main">∈</span> step0_rel<span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> const_map_equality<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>const_map <span class="free">v</span> <span class="free">S</span> <span class="main">=</span> const_map <span class="free">v'</span> <span class="free">S'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">=</span> <span class="free">S'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equals0D option.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.inject subsetI subset_antisym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rhoare_skipI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">sa</span> <span class="bound">sc</span> <span class="bound">sc'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Pre</span><span class="main">;</span> <span class="main">(</span><span class="bound">sc</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Tc</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Post</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">Pre</span><span class="main">}</span> Id<span class="main">,</span> <span class="free">Tc</span> <span class="main">{&gt;</span><span class="free">Post</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tso_round0_refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>tso_ref_rel<span class="main">}</span> Id<span class="main">,</span> tso_round0 <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="main">{&gt;</span>tso_ref_rel<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rhoare_skipI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_ref_rel_def basic_rel_def step1_rel_def 
     step1_add_rel_def  step0_rel_def tso_round0_def const_map_equality conj_disj_distribR
     ex_disj_distrib two_step_phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> tso_round1_refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>tso_ref_rel<span class="main">}</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">dec_f</span> <span class="bound">Ob</span><span class="main">.</span> olv_round <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">dec_f</span> <span class="bound">Ob</span><span class="main">,</span> tso_round1 <span class="free">r</span> <span class="free">dec_f</span> <span class="free">o_f</span> <span class="main">{&gt;</span>tso_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">sc'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> tso_ref_rel"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> tso_round1 <span class="free">r</span> <span class="free">dec_f</span> <span class="free">o_f</span>"</span></span>

  <span class="keyword1"><span class="command">hence</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r_next<span class="main">:</span> <span class="quoted"><span class="quoted">"next_round <span class="skolem">sc</span> <span class="main">=</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_round1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="skolem"><span class="skolem">sc0</span></span> <span class="skolem"><span class="skolem">S0</span></span> <span class="skolem"><span class="skolem">v0</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc0</span><span class="main">)</span> <span class="main">∈</span> step0_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc0</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> tso_round0 <span class="skolem">r0</span> <span class="skolem">S0</span> <span class="skolem">v0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_ref_rel_def<span class="main">)</span> 

  <span class="keyword1"><span class="command">from</span></span> step_r r_next R <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    v<span class="main">:</span> <span class="quoted"><span class="quoted">"r_votes <span class="skolem">sc</span> <span class="main">=</span> const_map <span class="skolem">v</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> opt_obs_safe <span class="main">(</span>last_obs <span class="skolem">sc</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_ref_rel_def step1_rel_def step1_add_rel_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span> 
      next_round <span class="main">:=</span> Suc <span class="main">(</span>next_round <span class="skolem">sa</span><span class="main">)</span>
      <span class="main">,</span> decisions <span class="main">:=</span> decisions <span class="skolem">sa</span> <span class="main">++</span> <span class="free">dec_f</span>
      <span class="main">,</span> last_obs <span class="main">:=</span> last_obs <span class="skolem">sa</span> <span class="main">++</span> const_map <span class="skolem">v</span> <span class="main">(</span>dom <span class="free">o_f</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟶</span> dom <span class="free">o_f</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> step1 v
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_round1_def obs_guard_def const_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">o_f</span> <span class="main">≠</span> Map.empty <span class="main">⟶</span> <span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step1 v
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_round1_def obs_guard_def dom_const_map<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
    abs_step<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> olv_round <span class="main">(</span>next_round <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">S</span> <span class="skolem">v</span> <span class="free">dec_f</span> <span class="main">(</span>dom <span class="free">o_f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R safe v step_r r_next step1
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_ref_rel_def step1_rel_def basic_rel_def sa'_def 
      olv_round_def tso_round1_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> post_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> tso_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> R step1
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_round0_def tso_round1_def 
      step0_rel_def basic_rel_def  sa'_def tso_ref_rel_def two_step_phase_Suc o_def
      const_map_is_Some const_map_is_None const_map_equality obs_guard_def 
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">map_add</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> abs_step post_rel <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r'</span> <span class="bound">S'</span> <span class="bound">w</span> <span class="bound">dec_f'</span> <span class="bound">Ob'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> olv_round <span class="bound">r'</span> <span class="bound">S'</span> <span class="bound">w</span> <span class="bound">dec_f'</span> <span class="bound">Ob'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> tso_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> TS_Observing_Refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines tso_ref_rel olv_TS tso_TS"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_refines_def olv_TS_defs tso_TS_defs 
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tso_round0_refines tso_round1_refines<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_ref_rel_def step0_rel_def basic_rel_def tso_init_def quorum_for_def 
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> empty_not_quorum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TSO_inv1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">TSO_inv1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> two_step <span class="main">(</span>next_round <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> r_votes <span class="bound">s</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> TSO_inv1I <span class="main">=</span> TSO_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> TSO_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> TSO_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> TSO_inv1D <span class="main">=</span> TSO_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TSO_inv2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">TSO_inv2</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> two_step <span class="main">(</span>next_round <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span>r_votes <span class="bound">s</span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> last_obs <span class="bound">s</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">v</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> TSO_inv2I <span class="main">=</span> TSO_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> TSO_inv2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> TSO_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> TSO_inv2D <span class="main">=</span> TSO_inv2_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs of invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> TSO_inv1_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init tso_TS <span class="main">⊆</span> TSO_inv1"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>TSO_inv1<span class="main">}</span> TS.trans tso_TS <span class="main">{&gt;</span> TSO_inv1<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TSO_inv1_def tso_TS_defs PO_hoare_def 
    tso_round0_def tso_round1_def const_map_is_Some two_step_phase_Suc<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> TSO_inv1_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach tso_TS <span class="main">⊆</span> TSO_inv1"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> inv_rule_basic TSO_inv1_inductive<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> TSO_inv2_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init tso_TS <span class="main">⊆</span> TSO_inv2"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>TSO_inv2<span class="main">}</span> TS.trans tso_TS <span class="main">{&gt;</span> TSO_inv2<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TSO_inv2_def tso_TS_defs PO_hoare_def 
    opt_obs_safe_def tso_round0_def tso_round1_def const_map_is_Some two_step_phase_Suc<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> TSO_inv2_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach tso_TS <span class="main">⊆</span> TSO_inv2"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> inv_rule_basic TSO_inv2_inductive<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Uv_Defs">
<div class="head">
<h1>Theory Uv_Defs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The UniformVoting Algorithm›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Uv_Defs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/HOModel.html">Heard_Of.HOModel</a> <span class="quoted">"<a href="Consensus_Types.html">../Consensus_Types</a>"</span> <span class="quoted">"<a href="Quorums.html">../Quorums</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The contents of this file have been taken almost verbatim from the
  Heard Of Model AFP entry. The only difference is that the types have been
  changed.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the algorithm›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nSteps</span> <span class="main">≡</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">phase</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">phase</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">div</span> nSteps"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">mod</span> nSteps"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following record models the local state of a process.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  last_obs <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>                <span class="comment1">― ‹current value held by process›</span>
  agreed_vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>    <span class="comment1">― ‹value the process voted for, if any›</span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Possible messages sent during the execution of the algorithm, and characteristic
  predicates to distinguish types of messages.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'val</span> msg <span class="main">=</span>
  Val <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>
<span class="main">|</span> ValVote <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>
<span class="main">|</span> Null  <span class="comment1">― ‹dummy message in case nothing needs to be sent›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isValVote</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isValVote</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">z</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> ValVote <span class="bound">z</span> <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isVal</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isVal</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Val <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Selector functions to retrieve components of messages. These functions
  have a meaningful result only when the message is of appropriate kind.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getvote</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">getvote</span> <span class="main">(</span>ValVote <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getval</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">getval</span> <span class="main">(</span>ValVote <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">getval</span> <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="main">(</span>agreed_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We separately define the transition predicates and the send functions
  for each step and later combine them to define the overall next-state relation.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msgRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="comment1">― ‹processes from which some message was received›</span>
  <span class="quoted"><span class="quoted">"<span class="free">msgRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smallestValRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">smallestValRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>process <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> msg<span class="main">)</span> <span class="main">≡</span>
   Min <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 0, each process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>last_obs›</span></span></span></span> value.

  It updates its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>last_obs›</span></span></span></span> field to the smallest value it has received.
  If the process has received the same value <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> from all processes
  from which it has heard, it updates its <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>agreed_vote›</span></span></span></span> field to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> Val <span class="main">(</span>last_obs <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>process <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> msg<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
           <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> agreed_vote <span class="main">:=</span> Some <span class="bound">v</span><span class="main">,</span> last_obs <span class="main">:=</span> smallestValRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">⦈</span><span class="main">)</span>
    <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> last_obs <span class="main">:=</span> smallestValRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In step 1, each process sends its current <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>last_obs›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>agreed_vote›</span></span></span></span> values.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> ValVote <span class="main">(</span>last_obs <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">(</span>agreed_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹processes from which values and votes were received›</span>
  <span class="quoted"><span class="quoted">"<span class="free">valVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span> 
   <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">z</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">z</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smallestValNoVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">smallestValNoVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>process <span class="main">⇀</span> <span class="main">(</span><span class="tfree">'val</span><span class="main">::</span>linorder<span class="main">)</span> msg<span class="main">)</span> <span class="main">≡</span>
   Min <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">v</span> None<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">someVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹set of processes from which some vote was received›</span>
  <span class="quoted"><span class="quoted">"<span class="free">someVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span>
   <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">∧</span> isValVote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> getvote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">identicalVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">identicalVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">.</span> isValVote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> getvote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">x_update</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">x_update</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> someVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">.</span> last_obs <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> the <span class="main">(</span>getvote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">∨</span> someVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> last_obs <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> smallestValNoVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec_update</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dec_update</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> identicalVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span> <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span>
  <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> identicalVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
     x_update <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span>
   <span class="main">∧</span> dec_update <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span>
   <span class="main">∧</span> agreed_vote <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The overall send function and next-state relation are simply obtained as 
  the composition of the individual relations defined above.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_sendMsg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_sendMsg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> send0 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> send1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_nextState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> next0 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> next1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> quorum_process<span class="main">)</span> <span class="entity">UV_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_commPerRd</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span> <span class="bound">q</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \emph{UniformVoting} Heard-Of machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the HO machine for \emph{Uniform Voting} by assembling the
  algorithm definition and its communication predicate. Notice that the
  coordinator arguments for the initialization and transition functions are
  unused since \emph{UniformVoting} is not a coordinated algorithm.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> quorum_process<span class="main">)</span> <span class="entity">UV_HOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_HOMachine</span> <span class="main">=</span> <span class="main">⦇</span> 
    CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> UV_initState <span class="bound">p</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span>
    sendMsg <span class="main">=</span>  UV_sendMsg<span class="main">,</span>
    CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> UV_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span><span class="main">,</span>
    HOcommPerRd <span class="main">=</span> UV_commPerRd<span class="main">,</span>
    HOcommGlobal <span class="main">=</span> UV_commGlobal
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> quorum_process<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_M</span> <span class="main">≡</span> <span class="main">(</span>UV_HOMachine<span class="main">::</span><span class="main">(</span>process<span class="main">,</span> <span class="tfree">'val</span><span class="main">::</span>linorder pstate<span class="main">,</span> <span class="tfree">'val</span> msg<span class="main">)</span> HOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Uv_Proofs">
<div class="head">
<h1>Theory Uv_Proofs</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Uv_Proofs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/Reduction.html">Heard_Of.Reduction</a>
  <a href="Two_Step_Observing.html">Two_Step_Observing</a> <span class="quoted">"<a href="HO_Transition_System.html">../HO_Transition_System</a>"</span> <a href="Uv_Defs.html">Uv_Defs</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> uv_TS_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span>process <span class="main">⇒</span> <span class="main">(</span>val pstate<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> val_linorder<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>val<span class="main">,</span> linorder_class<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> val <span class="main">::</span> <span class="quoted">linorder</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val_linorder<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> two_step_step<span class="main">:</span>
   <span class="quoted"><span class="quoted">"step <span class="main">=</span> two_step"</span></span>
   <span class="quoted"><span class="quoted">"phase <span class="main">=</span> two_phase"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def two_step_def phase_def two_phase_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> mono_quorum
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_Alg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val pstate<span class="main">,</span> val msg<span class="main">)</span>CHOAlgorithm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_Alg</span> <span class="main">=</span> CHOAlgorithm.truncate UV_M"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_TS</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process<span class="main">)</span> <span class="main">⇒</span> uv_TS_state TS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_TS</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="main">=</span> CHO_to_TS UV_Alg <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span>K <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> UV_TS_defs <span class="main">=</span> UV_TS_def CHO_to_TS_def UV_Alg_def CHOinitConfig_def
  UV_initState_def

<span class="keyword1"><span class="command">type_synonym</span></span> rHO <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process HO"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_trans_step</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UV_trans_step</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">μ</span><span class="main">.</span>
    <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">,</span> <span class="bound">cfg'</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">cfg</span> <span class="bound">cfg'</span><span class="main">.</span> step <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span>  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span>
      <span class="bound">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">cfg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span>
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="bound">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">cfg'</span> <span class="bound">p</span><span class="main">)</span>
    <span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_less_D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> step <span class="free">r</span> <span class="main">⟹</span> step <span class="free">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> UV_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CSHO_trans_alt UV_sendMsg <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> UV_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> <span class="main">=</span> 
  UV_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next0 send0 <span class="main">0</span>
  <span class="main">∪</span> UV_trans_step <span class="free">HOs</span> <span class="free">SHOs</span>  next1 send1 <span class="main">1</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CSHO_trans_alt UV_sendMsg <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span><span class="main">.</span> UV_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span><span class="main">)</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span>
    <span class="main">⊆</span> UV_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next0 send0 <span class="main">0</span> <span class="main">∪</span> UV_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next1 send1 <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def UV_sendMsg_def UV_nextState_def UV_trans_step_def 
    K_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step_less_D<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" UV_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next0 send0 <span class="main">0</span> <span class="main">∪</span>
    UV_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next1 send1 <span class="main">1</span>
    <span class="main">⊆</span> CSHO_trans_alt UV_sendMsg
        <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span><span class="main">.</span> UV_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span><span class="main">)</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def UV_sendMsg_def UV_nextState_def UV_trans_step_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">UV_inv1</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"uv_TS_state set"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>  
  <span class="quoted"><span class="quoted">"<span class="free">UV_inv1</span>  <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> 
    two_step <span class="bound">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="bound">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> None<span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> UV_inv1I <span class="main">=</span> UV_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> UV_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> UV_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> UV_inv1D <span class="main">=</span> UV_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> UV_inv1_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init <span class="main">(</span>UV_TS <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">⊆</span> UV_inv1"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>UV_inv1<span class="main">}</span> TS.trans <span class="main">(</span>UV_TS <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">{&gt;</span> UV_inv1<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UV_inv1_def UV_TS_defs CHO_trans_alt UV_trans PO_hoare_def 
    UV_HOMachine_def CHOAlgorithm.truncate_def UV_trans_step_def 
    all_conj_distrib two_step_phase_Suc two_step_step next1_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> UV_inv1_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach <span class="main">(</span>UV_TS <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">⊆</span> UV_inv1"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> inv_rule_basic UV_inv1_inductive<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tso_state <span class="main">×</span> uv_TS_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ref_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">r</span> <span class="main">=</span> next_round <span class="bound">sa</span>
    <span class="main">∧</span> <span class="main">(</span>step <span class="bound">r</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> r_votes <span class="bound">sa</span> <span class="main">=</span> agreed_vote <span class="keyword1">o</span> <span class="bound">sc</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> last_obs <span class="main">(</span><span class="bound">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> opt_obsv_state.last_obs <span class="bound">sa</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">v</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> decisions <span class="bound">sa</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="bound">sc</span>
  <span class="main">}</span>"</span></span>

<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Agreement for UV only holds if the communication predicates hold›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">HOs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> process set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rho</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> <span class="tfree">'val</span> pstate"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> global<span class="main">:</span> <span class="quoted"><span class="quoted">"UV_commGlobal <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> per_rd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> UV_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun <span class="free">fA</span> <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> HOs_intersect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="free">r'</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> per_rd
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UV_commPerRd_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> qintersect<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> HOs_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> HOs_intersect
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> vote_origin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">∈</span> UV_inv1"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"agreed_vote <span class="main">(</span><span class="free">cfg'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">.</span> last_obs <span class="main">(</span><span class="free">cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> inv step_r HOs_nonempty
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def get_msgs_benign send0_def msgRcvd_def o_def restrict_map_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> same_new_vote<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">∈</span> UV_inv1"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"agreed_vote <span class="main">(</span><span class="free">cfg'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LV</span><span class="main">(</span><span class="skolem">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> vote_origin<span class="main">[</span><span class="operator">OF</span> send step inv step_r<span class="main">]</span> HOs_intersect
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> asm<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> x_origin1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> last_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"last_obs <span class="main">(</span><span class="free">cfg'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> last_obs <span class="main">(</span><span class="free">cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smallestValRcvd <span class="main">(</span><span class="free">μ</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">μ</span> <span class="free">p</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"smallestValRcvd <span class="var">?msgs</span> <span class="main">∈</span> <span class="var">?vals</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> smallestValRcvd_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Min_in<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vals</span> <span class="main">⊆</span> getval <span class="main">`</span> <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> <span class="var">?msgs</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def get_msgs_benign restrict_map_def send0_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?vals</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vals</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> HOs_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def get_msgs_benign restrict_map_def send0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="var">?vals</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> last_obs step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send0_def restrict_map_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> step0_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ref_rel <span class="main">∩</span> UNIV <span class="main">×</span> UV_inv1<span class="main">}</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> tso_round0 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">,</span> 
    UV_trans_step <span class="free">HOs</span> <span class="free">HOs</span> next0 send0 <span class="main">0</span> <span class="main">{&gt;</span> ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs UV_trans_step_def two_step_step all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">r</span> <span class="skolem">cfg</span> <span class="skolem">μ</span> <span class="skolem">cfg'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> UV_inv1"</span></span>

  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> next_r<span class="main">:</span> <span class="quoted"><span class="quoted">"next_round <span class="skolem">sa</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> HOs_nonempty send <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send0_def msgRcvd_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> same_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="keyword1">o</span> <span class="skolem">cfg'</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="skolem">cfg</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pstate.select_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> pstate.surjective pstate.update_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pstate.update_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> same_new_vote<span class="main">[</span><span class="operator">OF</span> send step inv step_r<span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> vote_const_map<span class="main">:</span> <span class="quoted"><span class="quoted">"agreed_vote <span class="keyword1">o</span> <span class="skolem">cfg'</span> <span class="main">=</span> const_map <span class="skolem">v</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def const_map_def restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> x_origin <span class="main">=</span> x_origin1<span class="main">[</span><span class="operator">OF</span> send step step_r<span class="main">]</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span> next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span> r_votes <span class="main">:=</span> const_map <span class="skolem">v</span> <span class="skolem">S</span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟶</span> opt_obs_safe <span class="main">(</span>opt_obsv_state.last_obs <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vote_origin<span class="main">[</span><span class="operator">OF</span> send step inv step_r<span class="main">]</span> R per_rd<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> v
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UV_commPerRd_def opt_obs_safe_def ref_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> tso_round0 <span class="skolem">r</span> <span class="skolem">S</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> next_r step_r v R 
    vote_origin<span class="main">[</span><span class="operator">OF</span> send step inv step_r<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_round0_def sa'_def all_conj_distrib<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> step send v R same_dec step_r next_r
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def sa'_def two_step_step two_step_phase_Suc vote_const_map<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> x_origin<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> tso_round0 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> x_origin2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> last_obs<span class="main">:</span> <span class="quoted"><span class="quoted">"last_obs <span class="main">(</span><span class="free">cfg'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> last_obs <span class="main">(</span><span class="free">cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="free">cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="free">μ</span> <span class="free">p</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">w</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"someVoteRcvd <span class="main">(</span><span class="free">μ</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> HOs_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> someVoteRcvd_def msgRcvd_def isValVote_def 
      get_msgs_benign send1_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smallestValNoVoteRcvd <span class="main">(</span><span class="free">μ</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">μ</span> <span class="free">p</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">v</span> None<span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"smallestValNoVoteRcvd <span class="var">?msgs</span> <span class="main">∈</span> <span class="var">?vals</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> smallestValNoVoteRcvd_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Min_in<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vals</span> <span class="main">⊆</span> getval <span class="main">`</span> <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> <span class="var">?msgs</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def get_msgs_benign restrict_map_def send0_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?vals</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> True HOs_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vals</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def get_msgs_benign restrict_map_def send1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="var">?vals</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> empty step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> last_obs
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def x_update_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign restrict_map_def send1_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"someVoteRcvd <span class="main">(</span><span class="free">μ</span> <span class="free">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> HOs_nonempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> someVoteRcvd_def msgRcvd_def isValVote_def 
      get_msgs_benign send1_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> someVoteRcvd <span class="main">(</span><span class="free">μ</span> <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> the <span class="main">(</span>getvote <span class="main">(</span>the <span class="main">(</span><span class="free">μ</span> <span class="free">p</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> last_obs
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def x_update_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def x_update_def someVoteRcvd_def isValVote_def 
      send1_def get_msgs_benign msgRcvd_def restrict_map_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">D</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> decide <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decide_origin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"D <span class="free">cfg</span> <span class="free">cfg'</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">r</span> <span class="bound">p</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="free">cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_def next1_def get_msgs_benign send1_def msgRcvd_def o_def restrict_map_def
    x_update_def dec_update_def identicalVoteRcvd_def all_conj_distrib someVoteRcvd_def isValVote_def
    smallestValNoVoteRcvd_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> step1_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ref_rel <span class="main">∩</span> <span class="main">(</span>TSO_inv1 <span class="main">∩</span> TSO_inv2<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">.</span> tso_round1 <span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">,</span> 
    UV_trans_step <span class="free">HOs</span> <span class="free">HOs</span> next1 send1 <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">{&gt;</span> ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs UV_trans_step_def two_step_step all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">r</span> <span class="skolem">cfg</span> <span class="skolem">μ</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">cfg'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"process <span class="main">⇒</span> val pstate"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="skolem">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ainv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> TSO_inv1"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ainv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> TSO_inv2"</span></span>

  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> next_r<span class="main">:</span> <span class="quoted"><span class="quoted">"next_round <span class="skolem">sa</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="skolem">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> agreed_vote <span class="main">(</span><span class="skolem">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ainv step_r
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def TSO_inv1_def S_def two_step_step<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ob</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ob</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> last_obs <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">o_f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">o_f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">S</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="keyword1">then</span> Some <span class="skolem">v</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">process</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dec_f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dec_f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">p</span> <span class="main">∈</span> D <span class="skolem">cfg</span> <span class="skolem">cfg'</span> <span class="keyword1">then</span> decide <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"agreed_vote <span class="main">(</span><span class="skolem">cfg</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> S_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> v'<span class="main">=</span>this
    
  <span class="keyword1"><span class="command">have</span></span> d_guard<span class="main">:</span> <span class="quoted"><span class="quoted">"d_guard <span class="skolem">dec_f</span> <span class="main">(</span>agreed_vote <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> per_rd<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_guard_def locked_in_vf_def quorum_for_def dec_f_def
      UV_commPerRd_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> decide_origin<span class="main"><span class="main">[</span></span><span class="operator">OF</span> send step step_r<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>agreed_vote <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟶</span> <span class="skolem">Ob</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ob_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>agreed_vote <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> per_rd<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UV_commPerRd_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> qintersect<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"someVoteRcvd <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> someVoteRcvd_def get_msgs_benign msgRcvd_def restrict_map_def 
        isValVote_def send1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> someVoteRcvd <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="skolem">μ</span> <span class="skolem">p</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>ValVote <span class="bound">x'</span> <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> someVoteRcvd_def get_msgs_benign msgRcvd_def restrict_map_def
        isValVote_def send1_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> v'<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"last_obs <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def x_update_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> Ob_UNIV<span class="main">=</span>this<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> obs_guard<span class="main">:</span> <span class="quoted"><span class="quoted">"obs_guard <span class="skolem">o_f</span> <span class="main">(</span>agreed_vote <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_guard_def o_f_def S_def dom_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> v' Ob_UNIV quorum_non_empty<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> S_def all_not_in_conv  empty_not_quorum v<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span> 
    next_round <span class="main">:=</span> Suc <span class="main">(</span>next_round <span class="skolem">sa</span><span class="main">)</span>
    <span class="main">,</span> decisions <span class="main">:=</span> decisions <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">dec_f</span>
    <span class="main">,</span> opt_obsv_state.last_obs <span class="main">:=</span> opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">o_f</span>
    <span class="main">⦈</span>"</span></span>


  <span class="comment1">― ‹Abstract step›</span>
  <span class="keyword1"><span class="command">have</span></span> abs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> tso_round1 <span class="skolem">r</span> <span class="skolem">dec_f</span> <span class="skolem">o_f</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> next_r step_r R d_guard obs_guard
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_round1_def sa'_def ref_rel_def two_step_step<span class="main">)</span>

  <span class="comment1">― ‹Relation preserved›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> decide <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> decide <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dec_f_def D_def next1_def dec_update_def map_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> dec_rel<span class="main">=</span>this<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">o_f</span> <span class="bound">q</span> <span class="main">=</span> None <span class="main">∧</span> opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="bound">q</span> <span class="main">=</span> None 
        <span class="main">∨</span> <span class="main">(</span>opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">o_f</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>last_obs <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> 
    <span class="keyword3"><span class="command">case</span></span> True 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"last_obs <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ob_UNIV
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def Ob_def dom_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">o_f</span> <span class="bound">q</span> <span class="main">=</span> None <span class="main">∧</span> opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="bound">q</span> <span class="main">=</span> None 
        <span class="main">∨</span> <span class="main">(</span>opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">o_f</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>last_obs <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">o_f</span> <span class="main">=</span> Map.empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> last_obs <span class="main">=</span> x_origin2<span class="main">[</span><span class="operator">OF</span> send step step_r refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">o_f</span> <span class="bound">q</span> <span class="main">=</span> None <span class="main">∧</span> opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="bound">q</span> <span class="main">=</span> None 
        <span class="main">∨</span> <span class="main">(</span>opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">o_f</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>last_obs <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> disjE exE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"last_obs <span class="main">(</span><span class="skolem">cfg</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> last_obs <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> R step_r empty
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def two_step_step<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"agreed_vote <span class="main">(</span><span class="skolem">cfg</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>last_obs <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> R ainv2 step_r empty
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def two_step_step TSO_inv2_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> obs_rel<span class="main">=</span>this<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> post_rel<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> step send next_r R step_r
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sa'_def ref_rel_def two_step_step
      two_step_phase_Suc dec_rel obs_rel<span class="main">)</span>
    
  <span class="keyword1"><span class="command">from</span></span> abs_step post_rel <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> tso_round1 <span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> UV_Refines_votes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="main">(</span>ref_rel <span class="main">∩</span> <span class="main">(</span>TSO_inv1 <span class="main">∩</span> TSO_inv2<span class="main">)</span> <span class="main">×</span> UV_inv1<span class="main">)</span>
    tso_TS <span class="main">(</span>UV_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_using_invariants<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init <span class="main">(</span>UV_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">⊆</span> ref_rel <span class="main">``</span> init tso_TS"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UV_TS_defs UV_HOMachine_def CHOAlgorithm.truncate_def 
      tso_TS_defs ref_rel_def tso_init_def Let_def o_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>ref_rel <span class="main">∩</span> <span class="main">(</span>TSO_inv1 <span class="main">∩</span> TSO_inv2<span class="main">)</span> <span class="main">×</span> UV_inv1<span class="main">}</span> TS.trans tso_TS<span class="main">,</span> 
      TS.trans <span class="main">(</span>UV_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">{&gt;</span> ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_TS_defs UV_TS_defs UV_HOMachine_def CHOAlgorithm.truncate_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHO_trans_alt UV_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step0_ref step1_ref<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> TSO_inv1_inductive TSO_inv2_inductive UV_inv1_inductive<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* HO predicate context *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* mono_quorum context *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As the model of the algorithm is taken verbatim from the HO Model AFP, we
  do not repeat the termination proof here and refer to that AFP entry.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="BenOr_Defs">
<div class="head">
<h1>Theory BenOr_Defs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Ben-Or Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> BenOr_Defs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/HOModel.html">Heard_Of.HOModel</a> <span class="quoted">"<a href="Consensus_Types.html">../Consensus_Types</a>"</span> <span class="quoted">"<a href="Quorums.html">../Quorums</a>"</span> <span class="quoted">"<a href="Two_Steps.html">../Two_Steps</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">consts</span></span> coin <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> process <span class="main">⇒</span> val"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>                <span class="comment1">― ‹current value held by process›</span>
  vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>    <span class="comment1">― ‹value the process voted for, if any›</span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'val</span> msg <span class="main">=</span>
  Val <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>
<span class="main">|</span> Vote <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>
<span class="main">|</span> Null  <span class="comment1">― ‹dummy message in case nothing needs to be sent›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isVote</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isVote</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Vote <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isVal</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isVal</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Val <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getvote</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">getvote</span> <span class="main">(</span>Vote <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getval</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">getval</span> <span class="main">(</span>Val <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BenOr_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="main">(</span>vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msgRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="comment1">― ‹processes from which some message was received›</span>
  <span class="quoted"><span class="quoted">"<span class="free">msgRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> Val <span class="main">(</span>x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
           <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> vote <span class="main">:=</span> Some <span class="bound">v</span> <span class="main">⦈</span><span class="main">)</span>
    <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Val <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
       <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> vote <span class="main">:=</span> None <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> Vote <span class="main">(</span>vote <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">someVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹set of processes from which some vote was received›</span>
  <span class="quoted"><span class="quoted">"<span class="free">someVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span>
   <span class="main">{</span> <span class="bound">q</span> <span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">∧</span> isVote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> getvote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">identicalVoteRcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">identicalVoteRcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">.</span> isVote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> getvote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">x_update</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">x_update</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> someVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">.</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> the <span class="main">(</span>getvote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">∨</span> someVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> coin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec_update</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dec_update</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> identicalVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span> <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span>
  <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> identicalVoteRcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
     x_update <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span>
   <span class="main">∧</span> dec_update <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span>
   <span class="main">∧</span> vote <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BenOr_sendMsg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_sendMsg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span> <span class="keyword1">if</span> two_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> send0 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> send1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BenOr_nextState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> two_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> next0 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> next1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \emph{Ben-Or} Heard-Of machine›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> quorum_process<span class="main">)</span> <span class="entity">BenOr_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_commPerRd</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOrs</span></span></span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BenOr_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> two_step <span class="bound">r</span> <span class="main">=</span> <span class="main">1</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span> <span class="bound">q</span> <span class="main">∧</span> <span class="main">(</span>coin <span class="bound">r</span> <span class="bound">p</span> <span class="main">::</span> val<span class="main">)</span> <span class="main">=</span> coin <span class="bound">r</span> <span class="bound">q</span><span class="main">)</span>"</span></span>



<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> quorum_process<span class="main">)</span> <span class="entity">BenOr_HOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_HOMachine</span> <span class="main">=</span> <span class="main">⦇</span> 
    CinitState <span class="main">=</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">st</span> <span class="bound">crd</span><span class="main">.</span> BenOr_initState <span class="bound">p</span> <span class="bound">st</span><span class="main">)</span><span class="main">,</span>
    sendMsg <span class="main">=</span>  BenOr_sendMsg<span class="main">,</span>
    CnextState <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> BenOr_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span><span class="main">,</span>
    HOcommPerRd <span class="main">=</span> BenOr_commPerRd<span class="main">,</span>
    HOcommGlobal <span class="main">=</span> BenOr_commGlobal
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> quorum_process<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_M</span> <span class="main">≡</span> <span class="main">(</span>BenOr_HOMachine<span class="main">::</span><span class="main">(</span>process<span class="main">,</span> val pstate<span class="main">,</span> val msg<span class="main">)</span> HOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BenOr_Proofs">
<div class="head">
<h1>Theory BenOr_Proofs</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> BenOr_Proofs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/Reduction.html">Heard_Of.Reduction</a>
  <a href="Two_Step_Observing.html">Two_Step_Observing</a> <span class="quoted">"<a href="HO_Transition_System.html">../HO_Transition_System</a>"</span> <a href="BenOr_Defs.html">BenOr_Defs</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> ben_or_TS_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span>process <span class="main">⇒</span> <span class="main">(</span>val pstate<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">consts</span></span> 
  val0 <span class="main">::</span> <span class="quoted">val</span> 
  val1 <span class="main">::</span> <span class="quoted">val</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Ben-Or works only on binary values.›</span></span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  val_exhaust<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> val0 <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> val1"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> val_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"val0 <span class="main">≠</span> val1"</span></span>

<span class="keyword1"><span class="command">context</span></span> mono_quorum
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BenOr_Alg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val pstate<span class="main">,</span> val msg<span class="main">)</span>CHOAlgorithm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_Alg</span> <span class="main">=</span> CHOAlgorithm.truncate BenOr_M"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BenOr_TS</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process<span class="main">)</span> <span class="main">⇒</span> ben_or_TS_state TS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_TS</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="main">=</span> CHO_to_TS BenOr_Alg <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span>K <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> BenOr_TS_defs <span class="main">=</span> BenOr_TS_def CHO_to_TS_def BenOr_Alg_def CHOinitConfig_def
  BenOr_initState_def

<span class="keyword1"><span class="command">type_synonym</span></span> rHO <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process HO"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BenOr_trans_step</span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BenOr_trans_step</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">μ</span><span class="main">.</span>
    <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">,</span> <span class="bound">cfg'</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">cfg</span> <span class="bound">cfg'</span><span class="main">.</span> two_step <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span>  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span>
      <span class="bound">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">cfg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span>
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="bound">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">cfg'</span> <span class="bound">p</span><span class="main">)</span>
    <span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> two_step_less_D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> two_step <span class="free">r</span> <span class="main">⟹</span> two_step <span class="free">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_step_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> BenOr_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CSHO_trans_alt BenOr_sendMsg <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span> <span class="bound">st'</span><span class="main">.</span> BenOr_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">st'</span><span class="main">)</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> <span class="main">=</span> 
  BenOr_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next0 send0 <span class="main">0</span>
  <span class="main">∪</span> BenOr_trans_step <span class="free">HOs</span> <span class="free">SHOs</span>  next1 send1 <span class="main">1</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CSHO_trans_alt BenOr_sendMsg <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span><span class="main">.</span> BenOr_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span><span class="main">)</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span>
    <span class="main">⊆</span> BenOr_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next0 send0 <span class="main">0</span> <span class="main">∪</span> BenOr_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next1 send1 <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def BenOr_sendMsg_def BenOr_nextState_def BenOr_trans_step_def 
    K_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> two_step_less_D<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" BenOr_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next0 send0 <span class="main">0</span> <span class="main">∪</span>
    BenOr_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> next1 send1 <span class="main">1</span>
    <span class="main">⊆</span> CSHO_trans_alt BenOr_sendMsg
        <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span> <span class="bound">crd</span><span class="main">.</span> BenOr_nextState <span class="bound">r</span> <span class="bound">p</span> <span class="bound">st</span> <span class="bound">msgs</span><span class="main">)</span> <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def BenOr_sendMsg_def BenOr_nextState_def BenOr_trans_step_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">BenOr_A</span> <span class="main">=</span> CHOAlgorithm.truncate BenOr_M"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Agreement for BenOr only holds if the communication predicates hold›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">HOs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> process set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rho</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> val pstate"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> comm_global<span class="main">:</span> <span class="quoted"><span class="quoted">"BenOr_commGlobal <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> per_rd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> BenOr_commPerRd <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun BenOr_A <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">no_vote_diff</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">no_vote_diff</span> <span class="free"><span class="bound"><span class="entity">sc</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> vote <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sc</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟶</span>
            <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="bound">q'</span><span class="main">.</span> x <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sc</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> x <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sc</span></span></span> <span class="bound">q'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tso_state <span class="main">×</span> ben_or_TS_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ref_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">r</span> <span class="main">=</span> next_round <span class="bound">sa</span>
    <span class="main">∧</span> <span class="main">(</span>two_step <span class="bound">r</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> r_votes <span class="bound">sa</span> <span class="main">=</span> vote <span class="keyword1">o</span> <span class="bound">sc</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span>two_step <span class="bound">r</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> no_vote_diff <span class="bound">sc</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> x <span class="main">(</span><span class="bound">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> last_obs <span class="bound">sa</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">v</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> decisions <span class="bound">sa</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="bound">sc</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HOs_intersect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="free">r'</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> per_rd
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BenOr_commPerRd_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> qintersect<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> HOs_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> HOs_intersect
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> vote_origin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">cfg'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">.</span> x <span class="main">(</span><span class="free">cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> step_r HOs_nonempty
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def get_msgs_benign send0_def msgRcvd_def o_def restrict_map_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> same_new_vote<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> vote <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> vote <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> vote <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">cfg'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">w</span><span class="main">.</span> vote <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span> <span class="main">⟶</span> <span class="bound">w</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LV</span><span class="main">(</span><span class="skolem">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> vote_origin<span class="main">[</span><span class="operator">OF</span> send step step_r<span class="main">]</span> HOs_intersect
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> asm<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_x_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="free">cfg'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> x <span class="main">(</span><span class="free">cfg</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> step_r HOs_nonempty
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def get_msgs_benign send0_def msgRcvd_def o_def restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_vote<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"no_vote_diff <span class="free">cfg'</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> no_vote_diff_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="free">cfg'</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="bound">q'</span><span class="main">.</span> x <span class="main">(</span><span class="free">cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> x <span class="main">(</span><span class="free">cfg</span> <span class="bound">q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">p</span></span><span class="main">]</span> step_r HOs_nonempty 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def get_msgs_benign send0_def msgRcvd_def o_def restrict_map_def<span class="main">)</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="bound">q'</span><span class="main">.</span> x <span class="main">(</span><span class="free">cfg'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> x <span class="main">(</span><span class="free">cfg'</span> <span class="bound">q'</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> no_x_change<span class="main">[</span><span class="operator">OF</span> send step step_r<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">lemma</span></span> step0_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ref_rel<span class="main">}</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> tso_round0 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">,</span> 
    BenOr_trans_step <span class="free">HOs</span> <span class="free">HOs</span> next0 send0 <span class="main">0</span> <span class="main">{&gt;</span> ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs BenOr_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">r</span> <span class="skolem">cfg</span> <span class="skolem">μ</span> <span class="skolem">cfg'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> next_r<span class="main">:</span> <span class="quoted"><span class="quoted">"next_round <span class="skolem">sa</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> HOs_nonempty send <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> msgRcvd <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send0_def msgRcvd_def restrict_map_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> same_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"decide <span class="keyword1">o</span> <span class="skolem">cfg'</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="skolem">cfg</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pstate.select_convs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> pstate.surjective pstate.update_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> vote <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> same_new_vote<span class="main">[</span><span class="operator">OF</span> send step step_r<span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> vote <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> vote_const_map<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="keyword1">o</span> <span class="skolem">cfg'</span> <span class="main">=</span> const_map <span class="skolem">v</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def const_map_def restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span> next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span> r_votes <span class="main">:=</span> const_map <span class="skolem">v</span> <span class="skolem">S</span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟶</span> opt_obs_safe <span class="main">(</span>last_obs <span class="skolem">sa</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vote_origin<span class="main">[</span><span class="operator">OF</span> send step step_r<span class="main">]</span> R per_rd<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> v
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BenOr_commPerRd_def opt_obs_safe_def ref_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> tso_round0 <span class="skolem">r</span> <span class="skolem">S</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> next_r step_r v R 
    vote_origin<span class="main">[</span><span class="operator">OF</span> send step step_r<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_round0_def sa'_def all_conj_distrib<span class="main">)</span>


  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> step send v R same_dec step_r next_r
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def sa'_def  two_step_phase_Suc vote_const_map next0_def
      all_conj_distrib no_vote<span class="main"><span class="main">[</span></span><span class="operator">OF</span> send step step_r<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pstate.select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pstate.surjective pstate.update_convs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> tso_round0 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">D</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> decide <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg'</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decide_origin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
  send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="free">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="free">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"D <span class="free">cfg</span> <span class="free">cfg'</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="free">r</span> <span class="bound">p</span><span class="main">.</span> vote <span class="main">(</span><span class="free">cfg</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_def next1_def get_msgs_benign send1_def msgRcvd_def o_def restrict_map_def
    x_update_def dec_update_def identicalVoteRcvd_def all_conj_distrib someVoteRcvd_def isVote_def<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> step1_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ref_rel <span class="main">∩</span> <span class="main">(</span>TSO_inv1 <span class="main">∩</span> TSO_inv2<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">.</span> tso_round1 <span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">,</span> 
    BenOr_trans_step <span class="free">HOs</span> <span class="free">HOs</span> next1 send1 <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">{&gt;</span> ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs BenOr_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">r</span> <span class="skolem">cfg</span> <span class="skolem">μ</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">cfg'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"process <span class="main">⇒</span> val pstate"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_r<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="skolem">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ainv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> TSO_inv1"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ainv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> TSO_inv2"</span></span>

  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> next_r<span class="main">:</span> <span class="quoted"><span class="quoted">"next_round <span class="skolem">sa</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> vote <span class="main">(</span><span class="skolem">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> vote <span class="main">(</span><span class="skolem">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ainv step_r
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def TSO_inv1_def S_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ob</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ob</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> x <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">o_f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">o_f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">S</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="keyword1">then</span> Some <span class="skolem">v</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">process</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dec_f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dec_f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">p</span> <span class="main">∈</span> D <span class="skolem">cfg</span> <span class="skolem">cfg'</span> <span class="keyword1">then</span> decide <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="skolem">cfg</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> S_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> v'<span class="main">=</span>this
    
  <span class="keyword1"><span class="command">have</span></span> d_guard<span class="main">:</span> <span class="quoted"><span class="quoted">"d_guard <span class="skolem">dec_f</span> <span class="main">(</span>vote <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> per_rd<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_guard_def locked_in_vf_def quorum_for_def dec_f_def
      BenOr_commPerRd_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> decide_origin<span class="main"><span class="main">[</span></span><span class="operator">OF</span> send step step_r<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>vote <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">⟶</span> <span class="skolem">Ob</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ob_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>vote <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">∩</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> per_rd<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BenOr_commPerRd_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> qintersect<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"someVoteRcvd <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> someVoteRcvd_def get_msgs_benign msgRcvd_def restrict_map_def 
        isVote_def send1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> someVoteRcvd <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="skolem">μ</span> <span class="skolem">p</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> send<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> someVoteRcvd_def get_msgs_benign msgRcvd_def restrict_map_def
        isVote_def send1_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> v'<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def x_update_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> Ob_UNIV<span class="main">=</span>this<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> obs_guard<span class="main">:</span> <span class="quoted"><span class="quoted">"obs_guard <span class="skolem">o_f</span> <span class="main">(</span>vote <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> obs_guard_def o_f_def S_def dom_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> v' Ob_UNIV quorum_non_empty<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> S_def all_not_in_conv  empty_not_quorum v<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span> 
    next_round <span class="main">:=</span> Suc <span class="main">(</span>next_round <span class="skolem">sa</span><span class="main">)</span>
    <span class="main">,</span> decisions <span class="main">:=</span> decisions <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">dec_f</span>
    <span class="main">,</span> last_obs <span class="main">:=</span> last_obs <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">o_f</span>
    <span class="main">⦈</span>"</span></span>

  <span class="comment1">― ‹Abstract step›</span>
  <span class="keyword1"><span class="command">have</span></span> abs_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> tso_round1 <span class="skolem">r</span> <span class="skolem">dec_f</span> <span class="skolem">o_f</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> next_r step_r R d_guard obs_guard
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_round1_def sa'_def ref_rel_def<span class="main">)</span>

  <span class="comment1">― ‹Relation preserved›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> decide <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">cfg</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> decide <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dec_f_def D_def next1_def dec_update_def map_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> dec_rel<span class="main">=</span>this<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">o_f</span> <span class="bound">q</span> <span class="main">=</span> None <span class="main">∧</span> opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="bound">q</span> <span class="main">=</span> None 
        <span class="main">∨</span> <span class="main">(</span>opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">o_f</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="skolem">cfg'</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> 
    <span class="keyword3"><span class="command">case</span></span> True 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ob_UNIV
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def Ob_def dom_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">o_f</span> <span class="bound">q</span> <span class="main">=</span> None <span class="main">∧</span> opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="bound">q</span> <span class="main">=</span> None 
        <span class="main">∨</span> <span class="main">(</span>opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">o_f</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">o_f</span> <span class="main">=</span> Map.empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> UNIV_quorum
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"vote <span class="main">(</span><span class="skolem">cfg</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_f_def S_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q1</span></span> <span class="skolem"><span class="skolem">q2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="skolem">cfg</span> <span class="skolem">q1</span><span class="main">)</span> <span class="main">≠</span> x <span class="main">(</span><span class="skolem">cfg</span> <span class="skolem">q2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R step_r
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def no_vote_diff_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q1'</span></span> <span class="skolem"><span class="skolem">q2'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="skolem">cfg</span> <span class="skolem">q1'</span><span class="main">)</span> <span class="main">=</span> val0"</span></span>
      <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="skolem">cfg</span> <span class="skolem">q2'</span><span class="main">)</span> <span class="main">=</span> val1"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> val_exhaust<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R step_r
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ref_rel_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>poly_guards_query<span class="main"><span class="main">)</span></span> val_exhaust<span class="main">)</span>
    <span class="comment1">(* note x = x_origin2[OF send step step_r refl, of p] *)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">o_f</span> <span class="bound">q</span> <span class="main">=</span> None <span class="main">∧</span> opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="bound">q</span> <span class="main">=</span> None 
        <span class="main">∨</span> <span class="main">(</span>opt_obsv_state.last_obs <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">o_f</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>x <span class="main">(</span><span class="skolem">cfg'</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> empty
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">note</span></span> obs_rel<span class="main">=</span>this<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> post_rel<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> step send next_r R step_r
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sa'_def ref_rel_def 
      two_step_phase_Suc dec_rel obs_rel<span class="main">)</span>
    
  <span class="keyword1"><span class="command">from</span></span> abs_step post_rel <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> tso_round1 <span class="bound">r</span> <span class="bound">d_f</span> <span class="bound">o_f</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">cfg'</span><span class="main">)</span> <span class="main">∈</span> ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> BenOr_Refines_Two_Step_Obs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="main">(</span>ref_rel <span class="main">∩</span> <span class="main">(</span>TSO_inv1 <span class="main">∩</span> TSO_inv2<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span>
    tso_TS <span class="main">(</span>BenOr_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_using_invariants<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init <span class="main">(</span>BenOr_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">⊆</span> ref_rel <span class="main">``</span> init tso_TS"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BenOr_TS_defs BenOr_HOMachine_def CHOAlgorithm.truncate_def 
      tso_TS_defs ref_rel_def tso_init_def Let_def o_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>ref_rel <span class="main">∩</span> <span class="main">(</span>TSO_inv1 <span class="main">∩</span> TSO_inv2<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span> TS.trans tso_TS<span class="main">,</span> 
      TS.trans <span class="main">(</span>BenOr_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">{&gt;</span> ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tso_TS_defs BenOr_TS_defs BenOr_HOMachine_def CHOAlgorithm.truncate_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHO_trans_alt BenOr_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step0_ref step1_ref<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> TSO_inv1_inductive TSO_inv2_inductive<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The full termination proof for Ben-Or is probabilistic, and depends on the state
of the processes, and a "favorable" coin toss, where "favorable" is relative to this state.
As this termination pre-condition is state-dependent, we cannot capture it in an HO 
predicate.

Instead, we prove a variant of the argument, where we assume that there exists a 
round where all the processes hear from the same set of other processes, and all toss the 
same coin.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> BenOr_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> comm_global <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> r1<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="free">HOs</span> <span class="skolem">r1</span> <span class="free">p</span> <span class="main">=</span> <span class="free">HOs</span> <span class="skolem">r1</span> <span class="bound">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>coin <span class="skolem">r1</span> <span class="free">p</span> <span class="main">::</span> val<span class="main">)</span> <span class="main">=</span> coin <span class="skolem">r1</span> <span class="bound">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"two_step <span class="skolem">r1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BenOr_commGlobal_def all_conj_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> r1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="keyword2"><span class="keyword">where</span></span> r1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> Suc <span class="skolem">r0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step_r0<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="skolem">r0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> two_step_phase_Suc two_step_def mod_Suc<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg0</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg1</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">=</span> Suc <span class="skolem">r1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg2</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r3</span> <span class="main">=</span> Suc <span class="skolem">r2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg3</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r3</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg4</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg4</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r3</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> step_r2<span class="main">:</span> <span class="quoted"><span class="quoted">"two_step <span class="skolem">r2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r1
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2_def two_step_phase_Suc<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span>
    run<span class="main">[</span><span class="operator">simplified</span> HORun_def SHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r0</span>"</span></span><span class="main">]</span>
    run<span class="main">[</span><span class="operator">simplified</span> HORun_def SHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r1</span>"</span></span><span class="main">]</span>
    run<span class="main">[</span><span class="operator">simplified</span> HORun_def SHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r2</span>"</span></span><span class="main">]</span> 
    run<span class="main">[</span><span class="operator">simplified</span> HORun_def SHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r3</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ0</span></span> <span class="skolem"><span class="skolem">μ1</span></span> <span class="skolem"><span class="skolem">μ2</span></span> <span class="skolem"><span class="skolem">μ3</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    send0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ0</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">cfg0</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r0</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r0</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ1</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">cfg1</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r1</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r1</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ2</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">cfg2</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r2</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg3</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ3</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r3</span><span class="main">)</span> <span class="skolem">cfg3</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r3</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r3</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r3</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg3</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ3</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg4</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BenOr_A_def BenOr_HOMachine_def 
      two_step_phase_Suc BenOr_nextState_def BenOr_sendMsg_def all_conj_distrib
      CHOAlgorithm.truncate_def step_r0 r1_def r2_def r3_def
      cfg0_def cfg1_def cfg2_def cfg3_def cfg4_def 
      <span class="main">)</span>
  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"x <span class="main">(</span><span class="skolem">cfg2</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> per_rd r1 <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> x <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="var">?v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="skolem">r1</span> <span class="free">p</span> <span class="main">∧</span> vote <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">w</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="skolem">r1</span> <span class="free">p</span> <span class="main">∧</span> vote <span class="main">(</span><span class="skolem">cfg1</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q'</span><span class="main">.</span> vote <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="skolem">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  same_new_vote<span class="main">[</span><span class="operator">OF</span> send0 step0 step_r0<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff not_None_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q'</span><span class="main">.</span> x <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> step1 send1 q_w
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def all_conj_distrib dec_update_def x_update_def
        get_msgs_benign send1_def isVote_def msgRcvd_def identicalVoteRcvd_def 
        someVoteRcvd_def restrict_map_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> option.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel r1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q'</span><span class="main">.</span> x <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">=</span> coin <span class="skolem">r1</span> <span class="bound">q'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r1 step1 send1
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def all_conj_distrib dec_update_def x_update_def
        get_msgs_benign send1_def isVote_def msgRcvd_def identicalVoteRcvd_def 
        someVoteRcvd_def restrict_map_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r1
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span><span class="main">)</span>      
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> vote <span class="main">(</span><span class="skolem">cfg3</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="var">?v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_origin<span class="main"><span class="main">[</span></span><span class="operator">OF</span> send2 step2 step_r2<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="skolem">cfg4</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> send3<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> step3<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> HOs_nonempty
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def send1_def get_msgs_benign dec_update_def
      restrict_map_def identicalVoteRcvd_def msgRcvd_def isVote_def<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfg4_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* HO predicate context *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* mono_quorum context *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="MRU_Vote">
<div class="head">
<h1>Theory MRU_Vote</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The MRU Vote Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> MRU_Vote
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Same_Vote.html">Same_Vote</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> quorum_process
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This model is identical to Same Vote, except that it replaces
  the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">safe</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> guard with the following one, which says that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v›</span></span></span></span> is the
  most recently used (MRU) vote of a quorum:
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mru_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_state <span class="main">⇒</span> process set <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mru_guard</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">mru</span> <span class="main">=</span> mru_of_set <span class="main">(</span>votes <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="keyword1">in</span> 
    <span class="bound">mru</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">mru</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The concrete algorithms will not refine the MRU Voting model directly, but its optimized
  version instead. For simplicity, we thus do not create the model explicitly, but just prove guard
  strengthening. We will show later that the optimized model refines the Same Vote model.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mru_vote_implies_safe<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    inv4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> SV_inv4"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mru_vote<span class="main">:</span> <span class="quoted"><span class="quoted">"mru_guard <span class="free">s</span> <span class="free">Q</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> is_Quorum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safe <span class="free">s</span> <span class="main">(</span>v_state.next_round <span class="free">s</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mru_vote
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mru_guard_def mru_of_set_def option_Max_by_def<span class="main">)</span>
  <span class="comment1">― ‹The first case: some votes have been cast. We prove that the most recently used one is 
    safe.›</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span>
    nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"vote_set <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span> <span class="free">Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> max<span class="main">:</span> <span class="quoted"><span class="quoted">"Max_by fst <span class="main">(</span>vote_set <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> Max_by_in<span class="main">[</span><span class="operator">OF</span> Vinv1_finite_vote_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv1<span class="main"><span class="main">]</span></span> nempty<span class="main">]</span> max
  <span class="keyword1"><span class="command">have</span></span> in_votes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> vote_set <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> no_larger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a'</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">r'</span></span><span class="main">&gt;</span><span class="skolem">r</span><span class="main">.</span> votes <span class="free">s</span> <span class="bound">r'</span> <span class="bound">a'</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a'</span> <span class="skolem">r'</span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>  <span class="quoted"><span class="quoted">"votes <span class="free">s</span> <span class="skolem">r'</span> <span class="skolem">a'</span> <span class="main">=</span> Some <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">&gt;</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> vote_set <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> 
      <span class="keyword1"><span class="command">using</span></span> Max_by_ge<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">fst</span><span class="main">,</span> <span class="operator">OF</span> Vinv1_finite_vote_set<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">Q</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> inv1<span class="main"><span class="main">]</span></span><span class="main">]</span> max gt
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe <span class="free">s</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv4 in_votes <span class="keyword2"><span class="keyword">and</span></span> SV_inv4_def      
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"safe <span class="free">s</span> <span class="main">(</span>v_state.next_round <span class="free">s</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_larger is_Quorum<span class="main">[</span><span class="operator">THEN</span> qintersect<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_def quorum_for_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntE all_not_in_conv not_less_eq option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"vote_set <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"safe <span class="free">s</span> <span class="main">(</span>v_state.next_round <span class="free">s</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_Quorum<span class="main">[</span><span class="operator">THEN</span> qintersect<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def safe_def quorum_for_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context quorum_process *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="MRU_Vote_Opt">
<div class="head">
<h1>Theory MRU_Vote_Opt</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Optimized MRU Vote Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> MRU_Vote_Opt
<span class="keyword2"><span class="keyword">imports</span></span> <a href="MRU_Vote.html">MRU_Vote</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model definition›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">record</span></span> opt_mru_state <span class="main">=</span> 
  next_round <span class="main">::</span> <span class="quoted">round</span> 
  mru_vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> round <span class="main">×</span> val<span class="main">)</span> map"</span></span>
  decisions <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt_mru_init</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt_mru_init</span> <span class="main">=</span> <span class="main">{</span> <span class="main">⦇</span> next_round <span class="main">=</span> <span class="main">0</span><span class="main">,</span> mru_vote <span class="main">=</span> Map.empty<span class="main">,</span> decisions <span class="main">=</span> Map.empty <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> quorum_process <span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt_mru_vote</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> round <span class="main">×</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>process set<span class="main">,</span> round <span class="main">×</span> val<span class="main">)</span>map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt_mru_vote</span> <span class="free"><span class="bound"><span class="entity">lvs</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> option_Max_by fst <span class="main">(</span>ran <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lvs</span></span></span> <span class="main">|`</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt_mru_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> round <span class="main">×</span> val<span class="main">)</span>map <span class="main">⇒</span> process set <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt_mru_guard</span> <span class="free"><span class="bound"><span class="entity">mru_votes</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∈</span> <span class="free">Quorum</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">mru</span> <span class="main">=</span> opt_mru_vote <span class="free"><span class="bound"><span class="entity">mru_votes</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="keyword1">in</span> <span class="bound">mru</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">mru</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt_mru_round</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> process set <span class="main">⇒</span> process set <span class="main">⇒</span> val <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>opt_mru_state <span class="main">×</span> opt_mru_state<span class="main">)</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt_mru_round</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span>
     <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> opt_mru_guard <span class="main">(</span>mru_vote <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>
     <span class="main">∧</span> d_guard <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">(</span>const_map <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
     <span class="main">∧</span> <span class="comment1">― ‹actions›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       mru_vote <span class="main">:=</span> mru_vote <span class="bound">s</span> <span class="main">++</span> const_map <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>
       <span class="main">,</span> next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
       <span class="main">,</span> decisions <span class="main">:=</span> decisions <span class="bound">s</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> lv_evt_defs <span class="main">=</span> opt_mru_round_def opt_mru_guard_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mru_opt_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_mru_state <span class="main">×</span> opt_mru_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mru_opt_trans</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">Q</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">D</span><span class="main">.</span> opt_mru_round <span class="bound">r</span> <span class="bound">Q</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">D</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mru_opt_TS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opt_mru_state TS"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mru_opt_TS</span> <span class="main">=</span> <span class="main">⦇</span> init <span class="main">=</span> opt_mru_init<span class="main">,</span> trans <span class="main">=</span> mru_opt_trans <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> mru_opt_TS_defs <span class="main">=</span> mru_opt_TS_def opt_mru_init_def mru_opt_trans_def

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lv_ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>v_state <span class="main">×</span> opt_mru_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lv_ref_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>
    <span class="bound">sc</span> <span class="main">=</span> <span class="main">⦇</span>
      next_round <span class="main">=</span> v_state.next_round <span class="bound">sa</span>
      <span class="main">,</span> mru_vote <span class="main">=</span> process_mru <span class="main">(</span>votes <span class="bound">sa</span><span class="main">)</span>
      <span class="main">,</span> decisions <span class="main">=</span> v_state.decisions <span class="bound">sa</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The concrete guard implies the abstract guard›</span></span>
<span class="comment1">(******************************************************************************)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">voters</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>round <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map<span class="main">)</span> <span class="main">⇒</span> process set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">voters</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">|</span><span class="bound">a</span> <span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> map_graph <span class="main">(</span>case_prod <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vote_set_as_Union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vote_set <span class="free">vs</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="main">(</span><span class="free">Q</span> <span class="main">∩</span> voters <span class="free">vs</span><span class="main">)</span><span class="main">.</span> vote_set <span class="free">vs</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def voters_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_ran<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ran <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_ran_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ran <span class="main">(</span><span class="free">f</span> <span class="main">|`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_ran restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> option_Max_by_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">S</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">S'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">S'</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> Max_by <span class="free">f</span> <span class="free">S</span> <span class="main">=</span> Max_by <span class="free">g</span> <span class="free">S'</span> <span class="main">⟧</span> 
  <span class="main">⟹</span>  option_Max_by <span class="free">f</span> <span class="free">S</span> <span class="main">=</span> option_Max_by <span class="free">g</span> <span class="free">S'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option_Max_by_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ran_process_mru_only_voters<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ran <span class="main">(</span>process_mru <span class="free">vs</span> <span class="main">|`</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> ran <span class="main">(</span>process_mru <span class="free">vs</span> <span class="main">|`</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∩</span> voters <span class="free">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ran_def restrict_map_def voters_def process_mru_def 
    mru_of_set_def option_Max_by_def vote_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SV_inv3_inj_on_fst_vote_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> SV_inv3 <span class="main">⟹</span> inj_on fst <span class="main">(</span>vote_set <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SV_inv3_def inj_on_def vote_set_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> opt_mru_vote_mru_of_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> SV_inv3"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">≡</span> votes <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"opt_mru_vote <span class="main">(</span>process_mru <span class="free">vs</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> mru_of_set <span class="free">vs</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_mru_vote_def mru_of_set_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> option_Max_by_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ran <span class="main">(</span>process_mru <span class="free">vs</span> <span class="main">|`</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>vote_set <span class="free">vs</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_ran_restrict process_mru_def mru_of_set_def option_Max_by_def 
      vote_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span>process_mru <span class="free">vs</span> <span class="main">|`</span> <span class="free">Q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"vote_set <span class="free">vs</span> <span class="free">Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>

  <span class="keyword1"><span class="command">hence</span></span> nempty'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">∩</span> voters <span class="free">vs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def voters_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> nempty''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> vote_set <span class="free">vs</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∩</span> voters <span class="free">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vote_set_def voters_def<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> fin<span class="main">=</span>Vinv1_finite_vote_set<span class="main">[</span><span class="operator">OF</span> inv1<span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> ran_eq<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"ran <span class="main">(</span>process_mru <span class="free">vs</span> <span class="main">|`</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> Max_by fst <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span><span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">∩</span> voters <span class="free">vs</span><span class="main">.</span> vote_set <span class="free">vs</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∩</span> voters <span class="free">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ran_process_mru_only_voters<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def process_mru_def ran_def restrict_map_def mru_of_set_def option_Max_by_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Set.set_insert image_eqI insertI1 insert_inter_insert nempty''<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> inj<span class="main">=</span>inv3<span class="main">[</span><span class="operator">THEN</span> SV_inv3_inj_on_fst_vote_set<span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max_by fst <span class="main">(</span>ran <span class="main">(</span>process_mru <span class="free">vs</span> <span class="main">|`</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Max_by fst <span class="main">(</span>vote_set <span class="free">vs</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> vs_def 
      Max_by_UNION_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin vote_set_as_Union nempty'<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> vs_def<span class="main"><span class="main">]</span></span> 
        nempty''<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> vs_def<span class="main"><span class="main">]</span></span> inj<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> vote_set_as_Union<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> ran_eq vs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> opt_mru_guard_imp_mru_guard<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> invs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> SV_inv3"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c_guard<span class="main">:</span> <span class="quoted"><span class="quoted">"opt_mru_guard <span class="main">(</span>process_mru <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mru_guard <span class="free">s</span> <span class="free">Q</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_guard
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_mru_vote_mru_of_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> invs<span class="main"><span class="main">]</span></span> opt_mru_guard_def mru_guard_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The concrete action refines the abstract action›</span></span>
<span class="comment1">(******************************************************************************)</span>


<span class="keyword1"><span class="command">lemma</span></span> act_ref<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> Vinv1"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"process_mru <span class="main">(</span>votes <span class="free">s</span><span class="main">)</span> <span class="main">++</span> const_map <span class="main">(</span>v_state.next_round <span class="free">s</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="free">S</span> 
    <span class="main">=</span> process_mru <span class="main">(</span><span class="main">(</span>votes <span class="free">s</span><span class="main">)</span><span class="main">(</span>v_state.next_round <span class="free">s</span> <span class="main">:=</span> const_map <span class="free">v</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> process_mru_map_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> map_add_def const_map_def 
      restrict_map_def
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The complete refinement›</span></span> 
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">lemma</span></span> opt_mru_guard_imp_Quorum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"opt_mru_guard <span class="free">vs</span> <span class="free">Q</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_mru_guard_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> opt_mru_round_refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>lv_ref_rel <span class="main">∩</span> <span class="main">(</span>Vinv1 <span class="main">∩</span> SV_inv3 <span class="main">∩</span> SV_inv4<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span> 
    sv_round <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="free">d_f</span><span class="main">,</span> opt_mru_round <span class="free">r</span> <span class="free">Q</span> <span class="free">S</span> <span class="free">v</span> <span class="free">d_f</span> 
  <span class="main">{&gt;</span> lv_ref_rel<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs lv_ref_rel_def opt_mru_round_def sv_round_def 
    act_ref <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> disjCI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> opt_mru_guard_imp_mru_guard<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">Q</span></span><span class="main"><span class="main">]</span></span>  mru_vote_implies_safe<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">Q</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> opt_mru_guard_imp_Quorum<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> Opt_MRU_Vote_Refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="main">(</span>lv_ref_rel <span class="main">∩</span> <span class="main">(</span>Vinv1 <span class="main">∩</span> Vinv2 <span class="main">∩</span> SV_inv3 <span class="main">∩</span> SV_inv4<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span> sv_TS mru_opt_TS"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_using_invariants<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init mru_opt_TS <span class="main">⊆</span> lv_ref_rel <span class="main">``</span> init sv_TS"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mru_opt_TS_defs sv_TS_defs lv_ref_rel_def
      process_mru_def mru_of_set_def vote_set_def option_Max_by_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>lv_ref_rel <span class="main">∩</span> <span class="main">(</span>Vinv1 <span class="main">∩</span> Vinv2 <span class="main">∩</span> SV_inv3 <span class="main">∩</span> SV_inv4<span class="main">)</span> <span class="main">×</span> UNIV<span class="main">}</span> trans sv_TS<span class="main">,</span> trans mru_opt_TS <span class="main">{&gt;</span> lv_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sv_TS_defs mru_opt_TS_defs <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> opt_mru_round_refines<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span>Vinv1 <span class="main">∩</span> Vinv2 <span class="main">∩</span> SV_inv3 <span class="main">∩</span> SV_inv4 <span class="main">∩</span> Domain <span class="main">(</span>lv_ref_rel <span class="main">∩</span> UNIV <span class="main">×</span> UNIV<span class="main">)</span><span class="main">}</span> 
      trans sv_TS 
    <span class="main">{&gt;</span> Vinv1 <span class="main">∩</span> Vinv2 <span class="main">∩</span> SV_inv3 <span class="main">∩</span> SV_inv4<span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> SV_inv1_inductive<span class="main">(</span>2<span class="main">)</span> SV_inv2_inductive<span class="main">(</span>2<span class="main">)</span> SV_inv3_inductive<span class="main">(</span>2<span class="main">)</span> SV_inv4_inductive<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> SV_inv1_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> SV_inv2_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> SV_inv3_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> SV_inv4_inductive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">OMRU_inv1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"opt_mru_state set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">OMRU_inv1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> mru_vote <span class="bound">s</span> <span class="bound">p</span> <span class="keyword1">of</span>
      Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">r</span> <span class="main">&lt;</span> next_round <span class="bound">s</span>
      <span class="main">|</span> None <span class="main">⇒</span> True<span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> OMRU_inv1_inductive<span class="main">:</span>
  <span class="quoted"><span class="quoted">"init mru_opt_TS <span class="main">⊆</span> OMRU_inv1"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>OMRU_inv1<span class="main">}</span> trans mru_opt_TS <span class="main">{&gt;</span> OMRU_inv1<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mru_opt_TS_def opt_mru_init_def PO_hoare_def OMRU_inv1_def mru_opt_trans_def 
    opt_mru_round_def const_map_is_Some less_Suc_eq
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm option.split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> OMRU_inv1I <span class="main">=</span> OMRU_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_intro<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OMRU_inv1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span> <span class="main">=</span> OMRU_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_elim<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> OMRU_inv1D <span class="main">=</span> OMRU_inv1_def <span class="main">[</span><span class="operator">THEN</span> setc_def_to_dest<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Three_Step_MRU">
<div class="head">
<h1>Theory Three_Step_MRU</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Three-step Optimized MRU Model›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Three_Step_MRU
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="MRU_Vote_Opt.html">../MRU_Vote_Opt</a>"</span> <a href="Three_Steps.html">Three_Steps</a>
<span class="keyword2"><span class="keyword">begin</span></span>            

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To make the coming proofs of concrete algorithms easier, in this model we split 
  the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">opt_mru_round</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into three steps›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model definition›</span></span>
<span class="comment1">(******************************************************************************)</span>
<span class="keyword1"><span class="command">record</span></span> three_step_mru_state <span class="main">=</span> <span class="quoted">opt_mru_state</span> <span class="main">+</span> 
  candidates <span class="main">::</span> <span class="quoted"><span class="quoted">"val set"</span></span>

<span class="keyword1"><span class="command">context</span></span> mono_quorum
<span class="keyword2"><span class="keyword">begin</span></span>                    

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt_mru_step0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> val set <span class="main">⇒</span>  <span class="main">(</span>three_step_mru_state <span class="main">×</span> three_step_mru_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt_mru_step0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span> <span class="main">∧</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">cand</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> opt_mru_guard <span class="main">(</span>mru_vote <span class="bound">s</span><span class="main">)</span> <span class="bound">Q</span> <span class="bound">cand</span><span class="main">)</span>
     <span class="main">∧</span> <span class="comment1">― ‹actions›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       candidates <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>
       <span class="main">,</span> next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt_mru_step1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> process set <span class="main">⇒</span> val <span class="main">⇒</span> 
  <span class="main">(</span>three_step_mru_state <span class="main">×</span> three_step_mru_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt_mru_step1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span> <span class="main">∧</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span>
     <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> candidates <span class="bound">s</span><span class="main">)</span>
     <span class="main">∧</span> <span class="comment1">― ‹actions›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       mru_vote <span class="main">:=</span> mru_vote <span class="bound">s</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>
       <span class="main">,</span> next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">step2_d_guard</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step2_d_guard</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="bound">p</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> 
      <span class="bound">v</span> <span class="main">∈</span> ran <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="main">∧</span> dom <span class="free"><span class="bound"><span class="entity">r_votes</span></span></span> <span class="main">∈</span> <span class="free">Quorum</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_votes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"three_step_mru_state <span class="main">⇒</span> round <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_votes</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> mru_vote <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">then</span> map_option snd <span class="main">(</span>mru_vote <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">p</span><span class="main">)</span>
        <span class="keyword1">else</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opt_mru_step2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"round <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> val<span class="main">)</span>map <span class="main">⇒</span> <span class="main">(</span>three_step_mru_state <span class="main">×</span> three_step_mru_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt_mru_step2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span>
     <span class="comment1">― ‹guards›</span>
     <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> next_round <span class="bound">s</span> <span class="main">∧</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="numeral">2</span>
     <span class="main">∧</span> step2_d_guard <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span>  <span class="main">(</span>r_votes <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
     <span class="main">∧</span> <span class="comment1">― ‹actions›</span>
     <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">⦇</span> 
       next_round <span class="main">:=</span> Suc <span class="free"><span class="bound"><span class="entity">r</span></span></span>
       <span class="main">,</span> decisions <span class="main">:=</span> decisions <span class="bound">s</span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">r_decisions</span></span></span>
     <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ts_mru_evt_defs <span class="main">=</span> opt_mru_step0_def opt_mru_step1_def opt_mru_guard_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts_mru_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>three_step_mru_state <span class="main">×</span> three_step_mru_state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ts_mru_trans</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">C</span><span class="main">.</span> opt_mru_step0 <span class="bound">r</span> <span class="bound">C</span><span class="main">)</span> 
      <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> opt_mru_step1 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span>
      <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">dec_f</span><span class="main">.</span> opt_mru_step2 <span class="bound">r</span> <span class="bound">dec_f</span><span class="main">)</span> <span class="main">∪</span> Id"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts_mru_init</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ts_mru_init</span> <span class="main">=</span> <span class="main">{</span> <span class="main">⦇</span> next_round <span class="main">=</span> <span class="main">0</span><span class="main">,</span> mru_vote <span class="main">=</span> Map.empty<span class="main">,</span> decisions <span class="main">=</span> Map.empty<span class="main">,</span> candidates <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts_mru_TS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"three_step_mru_state TS"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ts_mru_TS</span> <span class="main">=</span> <span class="main">⦇</span> init <span class="main">=</span> ts_mru_init<span class="main">,</span> trans <span class="main">=</span> ts_mru_trans <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ts_mru_TS_defs <span class="main">=</span> ts_mru_TS_def ts_mru_init_def ts_mru_trans_def

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">basic_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">basic_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>    
    decisions <span class="bound">sc</span> <span class="main">=</span> decisions <span class="bound">sa</span>
    <span class="main">∧</span> next_round <span class="bound">sa</span> <span class="main">=</span> three_phase <span class="main">(</span>next_round <span class="bound">sc</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">three_step0_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_mru_state <span class="main">×</span> three_step_mru_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">three_step0_rel</span> <span class="main">≡</span> basic_rel <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>    
    three_step <span class="main">(</span>next_round <span class="bound">sc</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>
    <span class="main">∧</span> mru_vote <span class="bound">sc</span> <span class="main">=</span> mru_vote <span class="bound">sa</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">three_step1_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_mru_state <span class="main">×</span> three_step_mru_state<span class="main">)</span>set"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">three_step1_rel</span> <span class="main">≡</span> basic_rel <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">sc'</span> <span class="bound">r</span> <span class="bound">C</span><span class="main">.</span> <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span> <span class="main">∈</span> three_step0_rel <span class="main">∧</span> <span class="main">(</span><span class="bound">sc'</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="main">∈</span> opt_mru_step0 <span class="bound">r</span> <span class="bound">C</span><span class="main">)</span>
    <span class="main">∧</span> mru_vote <span class="bound">sc</span> <span class="main">=</span> mru_vote <span class="bound">sa</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">three_step2_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>opt_mru_state <span class="main">×</span> three_step_mru_state<span class="main">)</span>set"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">three_step2_rel</span> <span class="main">≡</span> basic_rel <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">sc'</span> <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc'</span><span class="main">)</span> <span class="main">∈</span> three_step1_rel <span class="main">∧</span> <span class="main">(</span><span class="bound">sc'</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="main">∈</span> opt_mru_step1 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts_ref_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ts_ref_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span>three_step <span class="main">(</span>next_round <span class="bound">sc</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="main">∈</span> three_step0_rel<span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span>three_step <span class="main">(</span>next_round <span class="bound">sc</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="main">∈</span> three_step1_rel<span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span>three_step <span class="main">(</span>next_round <span class="bound">sc</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span> <span class="main">∈</span> three_step2_rel<span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ts_ref_rel_defs <span class="main">=</span> 
  basic_rel_def
  ts_ref_rel_def
  three_step0_rel_def
  three_step1_rel_def
  three_step2_rel_def


<span class="keyword1"><span class="command">lemma</span></span> step0_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ts_ref_rel<span class="main">}</span> Id<span class="main">,</span> opt_mru_step0 <span class="free">r</span> <span class="free">C</span> <span class="main">{&gt;</span> ts_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> opt_mru_step0 <span class="free">r</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> r_step<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="main">(</span>next_round <span class="skolem">sc</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"three_step <span class="main">(</span>next_round <span class="skolem">sc'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_ref_rel_def opt_mru_step0_def three_step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> R step
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_ref_rel_def  three_step_phase_Suc three_step1_rel_def
      three_step2_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">sc</span></span><span class="main"><span class="main">]</span></span> step R<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step0_rel_def basic_rel_def three_step_phase_Suc
        opt_mru_step0_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step1_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ts_ref_rel<span class="main">}</span> Id<span class="main">,</span> opt_mru_step1 <span class="free">r</span> <span class="free">S</span> <span class="free">v</span> <span class="main">{&gt;</span> ts_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> opt_mru_step1 <span class="free">r</span> <span class="free">S</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> r_step<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="main">(</span>next_round <span class="skolem">sc</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"three_step <span class="main">(</span>next_round <span class="skolem">sc'</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_ref_rel_def opt_mru_step1_def three_step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> R step
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_ref_rel_def  three_step_phase_Suc three_step0_rel_def
      three_step2_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">sc</span></span><span class="main"><span class="main">]</span></span> step R<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step1_rel_def basic_rel_def three_step_phase_Suc
      opt_mru_step1_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step2_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ts_ref_rel <span class="main">∩</span> OMRU_inv1 <span class="main">×</span> UNIV<span class="main">}</span> 
    <span class="main">⋃</span><span class="bound">r'</span> <span class="bound">Q</span> <span class="bound">S'</span> <span class="bound">v</span> <span class="bound">dec_f'</span><span class="main">.</span> opt_mru_round <span class="bound">r'</span> <span class="bound">Q</span> <span class="bound">S'</span> <span class="bound">v</span> <span class="bound">dec_f'</span><span class="main">,</span> 
    opt_mru_step2 <span class="free">r</span> <span class="free">dec_f</span> <span class="main">{&gt;</span> ts_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">sc2</span> <span class="skolem">sc3</span>
  <span class="keyword3"><span class="command">assume</span></span> 
    ainv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> OMRU_inv1"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc2</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc2</span><span class="main">,</span> <span class="skolem">sc3</span><span class="main">)</span> <span class="main">∈</span> opt_mru_step2 <span class="free">r</span> <span class="free">dec_f</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> R step2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sc0</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">sc1</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc0</span><span class="main">)</span> <span class="main">∈</span> three_step0_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc0</span><span class="main">,</span> <span class="skolem">sc1</span><span class="main">)</span> <span class="main">∈</span> opt_mru_step0 <span class="skolem">r0</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc1</span><span class="main">)</span> <span class="main">∈</span> three_step1_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sc1</span><span class="main">,</span> <span class="skolem">sc2</span><span class="main">)</span> <span class="main">∈</span> opt_mru_step1 <span class="skolem">r1</span> <span class="skolem">S</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_ref_rel_def three_step2_rel_def opt_mru_step2_def
      three_step1_rel_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sc2</span><span class="main">)</span> <span class="main">∈</span> three_step2_rel"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> r2_step<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="main">(</span>next_round <span class="skolem">sc2</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> r3_step<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="main">(</span>next_round <span class="skolem">sc3</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R step2
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_ref_rel_def opt_mru_step2_def three_step_phase_Suc three_step_Suc<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Suc <span class="skolem">r1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> Suc <span class="skolem">r0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> next_round <span class="skolem">sc1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    r0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r0</span> <span class="main">=</span> next_round <span class="skolem">sc0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r0_step<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> next_round <span class="skolem">sc2</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> step0 step1 step2
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_mru_step0_def opt_mru_step1_def opt_mru_step2_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> abs_round2<span class="main">:</span> <span class="quoted"><span class="quoted">"next_round <span class="skolem">sa</span> <span class="main">=</span> three_phase <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R2 r2
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step2_rel_def basic_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> abs_round1<span class="main">:</span> <span class="quoted"><span class="quoted">"next_round <span class="skolem">sa</span> <span class="main">=</span> three_phase <span class="skolem">r1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R1 r1
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step1_rel_def basic_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> abs_round0<span class="main">:</span> <span class="quoted"><span class="quoted">"next_round <span class="skolem">sa</span> <span class="main">=</span> three_phase <span class="skolem">r0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R0 r0 r
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step0_rel_def basic_rel_def three_step_phase_Suc<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> r_votes<span class="main">:</span> <span class="quoted"><span class="quoted">"r_votes <span class="skolem">sc2</span> <span class="free">r</span> <span class="main">=</span> const_map <span class="skolem">v</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"r_votes <span class="skolem">sc2</span> <span class="free">r</span> <span class="skolem">p</span> <span class="main">=</span> const_map <span class="skolem">v</span> <span class="skolem">S</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"r_votes <span class="skolem">sc2</span> <span class="free">r</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step0 step1 abs_round0 abs_round1 abs_round2
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_votes_def opt_mru_step1_def
          const_map_def restrict_map_def map_add_def<span class="main">)</span>        
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">w</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> in_S<span class="main">:</span> <span class="quoted"><span class="quoted">"mru_vote <span class="skolem">sc1</span> <span class="skolem">p</span> <span class="main">≠</span> mru_vote <span class="skolem">sc2</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R0 step0 ainv r1 r abs_round0
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_votes_def ts_ref_rel_defs
          three_step_phase_Suc opt_mru_step0_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> OMRU_inv1D<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> step1
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_mru_step1_def map_add_def const_map_is_Some 
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R0 R1 step1 ainv r abs_round1 Some
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_votes_def ts_ref_rel_defs const_map_is_Some
          three_step_phase_Suc opt_mru_step1_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> OMRU_inv1D<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_map_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> step0 step1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> opt_mru_guard <span class="main">(</span>mru_vote <span class="skolem">sc0</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opt_mru_step0_def opt_mru_step1_def<span class="main">)</span>
    
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span>
      mru_vote <span class="main">:=</span> mru_vote <span class="skolem">sa</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="free">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span>
      <span class="main">,</span> next_round <span class="main">:=</span> Suc <span class="main">(</span>three_phase <span class="free">r</span><span class="main">)</span>
      <span class="main">,</span> decisions <span class="main">:=</span> decisions <span class="skolem">sa</span> <span class="main">++</span> <span class="free">dec_f</span>
    <span class="main">⦈</span>"</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> guard_strengthening<span class="main">:</span>
    <span class="quoted"><span class="quoted">"step2_d_guard <span class="free">dec_f</span> <span class="main">(</span>r_votes <span class="skolem">sc2</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟶</span> d_guard <span class="free">dec_f</span> <span class="main">(</span>const_map <span class="skolem">v</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_votes d_guard_def step2_d_guard_def locked_in_vf_def 
      quorum_for_def const_map_is_Some dom_const_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> opt_mru_round <span class="main">(</span>three_phase <span class="free">r</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">S</span> <span class="skolem">v</span> <span class="free">dec_f</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="skolem">sc3</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="skolem">sc3</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> r3_step R0 R1 R2 step0 step1 step2 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_ref_rel_def three_step0_rel_def basic_rel_def opt_mru_step0_def 
        opt_mru_step1_def opt_mru_step2_def  sa'_def three_step_phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> opt_mru_round <span class="main">(</span>three_phase <span class="free">r</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">S</span> <span class="skolem">v</span> <span class="free">dec_f</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> R0 r0_step step0 step1 step2 r0 r1 r2 r r_votes Q guard_strengthening
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_ref_rel_defs opt_mru_round_def three_step_phase_Suc
        opt_mru_step0_def opt_mru_step1_def opt_mru_step2_def sa'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r'</span> <span class="bound">Q</span> <span class="bound">S'</span> <span class="bound">v</span> <span class="bound">D'</span><span class="main">.</span> opt_mru_round <span class="bound">r'</span> <span class="bound">Q</span> <span class="bound">S'</span> <span class="bound">v</span> <span class="bound">D'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="skolem">sc3</span><span class="main">)</span> <span class="main">∈</span> ts_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> ThreeStep_Coordinated_Refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines <span class="main">(</span>ts_ref_rel <span class="main">∩</span> OMRU_inv1 <span class="main">×</span> UNIV<span class="main">)</span> 
    mru_opt_TS ts_mru_TS"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_using_invariants<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init ts_mru_TS <span class="main">⊆</span> ts_ref_rel <span class="main">``</span> init mru_opt_TS"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_mru_TS_defs mru_opt_TS_defs ts_ref_rel_def three_step0_rel_def 
      three_step1_rel_def three_step2_rel_def basic_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>ts_ref_rel <span class="main">∩</span> OMRU_inv1 <span class="main">×</span> UNIV<span class="main">}</span> TS.trans mru_opt_TS<span class="main">,</span> 
      TS.trans <span class="main">(</span>ts_mru_TS<span class="main">)</span> <span class="main">{&gt;</span> ts_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mru_opt_TS_defs ts_mru_TS_defs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_mru_trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step0_ref step1_ref step2_ref<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> OMRU_inv1_inductive<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="New_Algorithm_Defs">
<div class="head">
<h1>Theory New_Algorithm_Defs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The New Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> New_Algorithm_Defs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/HOModel.html">Heard_Of.HOModel</a> <span class="quoted">"<a href="Consensus_Types.html">../Consensus_Types</a>"</span> <span class="quoted">"<a href="Consensus_Misc.html">../Consensus_Misc</a>"</span> <a href="Three_Steps.html">Three_Steps</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the algorithm›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We assume that the values are linearly ordered, to be able to have each process
  select the smallest value.›</span></span>
<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> val_linorder<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">OFCLASS</span><span class="main">(</span>val<span class="main">,</span> linorder_class<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> val <span class="main">::</span> <span class="quoted">linorder</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val_linorder<span class="main">)</span>

<span class="keyword1"><span class="command">record</span></span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="quoted">val</span>                <span class="comment1">― ‹current value held by process›</span>
  prop_vote <span class="main">::</span> <span class="quoted"><span class="quoted">"val option"</span></span>
  mru_vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> val<span class="main">)</span> option"</span></span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"val option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>

<span class="keyword1"><span class="command">datatype</span></span> msg <span class="main">=</span>
  MruVote <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> val<span class="main">)</span> option"</span></span> <span class="quoted"><span class="quoted">"val"</span></span>
<span class="main">|</span> PreVote <span class="quoted"><span class="quoted">"val"</span></span>
<span class="main">|</span> Vote <span class="quoted">val</span>
<span class="main">|</span> Null  <span class="comment1">― ‹dummy message in case nothing needs to be sent›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Characteristic predicates on messages.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isLV</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isLV</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">rv</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Vote <span class="bound">rv</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isPreVote</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isPreVote</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">px</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> PreVote <span class="bound">px</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NA_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NA_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">≡</span>
   mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
   <span class="main">∧</span> prop_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
   <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
  "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> MruVote <span class="main">(</span>mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">(</span>x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">msg_to_val_stamp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> <span class="main">(</span>round <span class="main">×</span> val<span class="main">)</span>option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msg_to_val_stamp</span> <span class="main">(</span>MruVote <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msgs_to_lvs</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>process <span class="main">⇀</span> msg<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> round <span class="main">×</span> val<span class="main">)</span> map"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msgs_to_lvs</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">≡</span> msg_to_val_stamp <span class="keyword1">∘<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smallest_proposal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">smallest_proposal</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">::</span>process <span class="main">⇀</span> msg<span class="main">)</span> <span class="main">≡</span>
   Min <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span> <span class="bound">mv</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>MruVote <span class="bound">mv</span> <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next0</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat 
  <span class="main">⇒</span> process 
  <span class="main">⇒</span> pstate 
  <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> msg<span class="main">)</span>
  <span class="main">⇒</span> process
  <span class="main">⇒</span> pstate
  <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> 
      <span class="bound">Q</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span> 
      <span class="bound">lvs</span> <span class="main">=</span> msgs_to_lvs <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span>
      <span class="bound">smallest</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">Q</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> x <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">else</span> smallest_proposal <span class="free"><span class="bound"><span class="entity">msgs</span></span></span>
    <span class="keyword1">in</span>
    <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span>
      prop_vote <span class="main">:=</span> <span class="keyword1">if</span> card <span class="bound">Q</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
        <span class="keyword1">then</span> Some <span class="main">(</span>case_option <span class="bound">smallest</span> snd <span class="main">(</span>option_Max_by fst <span class="main">(</span>ran <span class="main">(</span><span class="bound">lvs</span> <span class="main">|`</span> <span class="bound">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> None
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> prop_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> Null
    <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> PreVote <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Q_prevotes_v</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q_prevotes_v</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">D</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="keyword1">in</span>
    <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⊆</span> <span class="bound">D</span> <span class="main">∧</span> card <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>PreVote <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next1</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat 
  <span class="main">⇒</span> process 
  <span class="main">⇒</span> pstate 
  <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> msg<span class="main">)</span>
  <span class="main">⇒</span> process
  <span class="main">⇒</span> pstate
  <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> 
      decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span>
      <span class="main">∧</span> x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> x <span class="free"><span class="bound"><span class="entity">st</span></span></span> 
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Q</span> <span class="bound">v</span><span class="main">.</span> Q_prevotes_v <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">Q</span> <span class="bound">v</span>
        <span class="main">⟶</span> mru_vote <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Q</span> <span class="bound">v</span><span class="main">.</span> Q_prevotes_v <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">Q</span> <span class="bound">v</span><span class="main">)</span>
        <span class="main">⟶</span> mru_vote <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
  "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> Null
    <span class="main">|</span> Some <span class="main">(</span><span class="bound">Φ</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">Φ</span> <span class="main">=</span> three_phase <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Vote <span class="bound">v</span> <span class="keyword1">else</span> Null"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Q'_votes_v</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q'_votes_v</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">Q'</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> 
    <span class="free"><span class="bound"><span class="entity">Q'</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">∧</span> card <span class="free"><span class="bound"><span class="entity">Q'</span></span></span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q'</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next2</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat 
  <span class="main">⇒</span> process 
  <span class="main">⇒</span> pstate 
  <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> msg<span class="main">)</span>
  <span class="main">⇒</span> process
  <span class="main">⇒</span> pstate
  <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span> <span class="bound">lvs</span> <span class="main">=</span> msgs_to_lvs <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="keyword1">in</span>
    x <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> x <span class="free"><span class="bound"><span class="entity">st</span></span></span>
    <span class="main">∧</span> mru_vote <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Q'</span> <span class="bound">v</span><span class="main">.</span> Q'_votes_v <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">Q</span> <span class="bound">Q'</span> <span class="bound">v</span> <span class="main">⟶</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">Q'</span> <span class="bound">v</span><span class="main">.</span> Q'_votes_v <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">Q</span> <span class="bound">Q'</span> <span class="bound">v</span> <span class="main">⟶</span> decide <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span>
  "</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NA_sendMsg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> process <span class="main">⇒</span> pstate <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NA_sendMsg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span>
   <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> send0 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> send1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> send2 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">NA_nextState</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> pstate <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> msg<span class="main">)</span> 
                       <span class="main">⇒</span> process <span class="main">⇒</span> pstate <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NA_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> next0 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> next1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> next2 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Heard-Of machine›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">NA_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NA_commPerRd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOrs</span></span></span><span class="main">::</span>process HO<span class="main">)</span>  <span class="main">≡</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">NA_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NA_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span>  <span class="main">≡</span>
      <span class="main">∃</span><span class="bound">ph</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="numeral">2</span><span class="main">}</span><span class="main">.</span> 
        <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>
    "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">New_Algo_Alg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">New_Algo_Alg</span> <span class="main">≡</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span> NA_initState<span class="main">,</span>
      sendMsg <span class="main">=</span> NA_sendMsg<span class="main">,</span>
      CnextState <span class="main">=</span> NA_nextState <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">New_Algo_HOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">New_Algo_HOMachine</span> <span class="main">≡</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span> NA_initState<span class="main">,</span>
      sendMsg <span class="main">=</span> NA_sendMsg<span class="main">,</span>
      CnextState <span class="main">=</span> NA_nextState<span class="main">,</span>
      HOcommPerRd <span class="main">=</span> NA_commPerRd<span class="main">,</span>
      HOcommGlobal <span class="main">=</span> NA_commGlobal <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">New_Algo_M</span> <span class="main">≡</span> <span class="main">(</span>New_Algo_HOMachine<span class="main">::</span><span class="main">(</span>process<span class="main">,</span> pstate<span class="main">,</span> msg<span class="main">)</span> HOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="New_Algorithm_Proofs">
<div class="head">
<h1>Theory New_Algorithm_Proofs</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> New_Algorithm_Proofs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Three_Step_MRU.html">Three_Step_MRU</a> <a href="New_Algorithm_Defs.html">New_Algorithm_Defs</a> <span class="quoted">"<a href="HO_Transition_System.html">../HO_Transition_System</a>"</span>
  <a href="../Heard_Of/Majorities.html">Heard_Of.Majorities</a> <span class="quoted">"<a href="Quorums.html">../Quorums</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> p_TS_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span>process <span class="main">⇒</span> pstate<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">New_Algo_TS</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process<span class="main">)</span> <span class="main">⇒</span> p_TS_state TS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">New_Algo_TS</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="main">=</span> CHO_to_TS New_Algo_Alg <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span>K <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> New_Algo_TS_defs <span class="main">=</span> New_Algo_TS_def CHO_to_TS_def New_Algo_Alg_def CHOinitConfig_def
  NA_initState_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">New_Algo_trans_step</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">New_Algo_trans_step</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">μ</span><span class="main">.</span>
    <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">,</span> <span class="bound">cfg'</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">cfg</span> <span class="bound">cfg'</span><span class="main">.</span> three_step <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span>  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span>
      <span class="bound">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">cfg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span>
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="bound">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="bound">cfg'</span> <span class="bound">p</span><span class="main">)</span>
    <span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> three_step_less_D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> three_step <span class="free">r</span> <span class="main">⟹</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> three_step_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> New_Algo_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CSHO_trans_alt NA_sendMsg NA_nextState <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span>K <span class="main">∘</span> <span class="free">crds</span><span class="main">)</span> <span class="main">=</span> 
  New_Algo_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span>
  <span class="main">∪</span> New_Algo_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next1 send1 <span class="main">1</span>
  <span class="main">∪</span> New_Algo_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CSHO_trans_alt NA_sendMsg NA_nextState <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span>K <span class="main">∘</span> <span class="free">crds</span><span class="main">)</span>
    <span class="main">⊆</span> New_Algo_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span> <span class="main">∪</span>
       New_Algo_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next1 send1 <span class="main">1</span> <span class="main">∪</span>
       New_Algo_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def NA_sendMsg_def NA_nextState_def 
    New_Algo_trans_step_def K_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> three_step_less_D<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"New_Algo_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span> <span class="main">∪</span>
    New_Algo_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next1 send1 <span class="main">1</span> <span class="main">∪</span>
    New_Algo_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span>
    <span class="main">⊆</span> CSHO_trans_alt NA_sendMsg NA_nextState <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span>K <span class="main">∘</span> <span class="free">crds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def NA_sendMsg_def NA_nextState_def 
    New_Algo_trans_step_def K_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> rHO <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process HO"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">new_algo_ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>three_step_mru_state <span class="main">×</span> p_TS_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">new_algo_ref_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    opt_mru_state.next_round <span class="bound">sa</span> <span class="main">=</span> <span class="bound">r</span>
    <span class="main">∧</span> opt_mru_state.decisions <span class="bound">sa</span> <span class="main">=</span> pstate.decide <span class="keyword1">o</span> <span class="bound">sc</span>
    <span class="main">∧</span> opt_mru_state.mru_vote <span class="bound">sa</span> <span class="main">=</span> pstate.mru_vote <span class="keyword1">o</span> <span class="bound">sc</span>
    <span class="main">∧</span> <span class="main">(</span>three_step <span class="bound">r</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟶</span> three_step_mru_state.candidates <span class="bound">sa</span> <span class="main">=</span> ran <span class="main">(</span>prop_vote <span class="keyword1">o</span> <span class="bound">sc</span><span class="main">)</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Different types seem to be derived for the two <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mru_vote_evolution›</span></span></span></span> lemmas,
  so we state them separately.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mru_vote_evolution0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> mru_vote <span class="keyword1">o</span> <span class="free">s'</span> <span class="main">=</span> mru_vote <span class="keyword1">o</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next2_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mru_vote_evolution2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> mru_vote <span class="keyword1">o</span> <span class="free">s'</span> <span class="main">=</span> mru_vote <span class="keyword1">o</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next2_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> decide_evolution<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> decide <span class="keyword1">o</span> <span class="free">s</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> decide <span class="keyword1">o</span> <span class="free">s</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next1_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msgs_mru_vote<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="free">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>msgs_to_lvs <span class="main">(</span><span class="free">μ</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mru_vote <span class="keyword1">o</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">|`</span> <span class="free">HOs</span> <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send0_def restrict_map_def msgs_to_lvs_def
      map_comp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> step0_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>new_algo_ref_rel<span class="main">}</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">C</span><span class="main">.</span> majorities.opt_mru_step0 <span class="bound">r</span> <span class="bound">C</span><span class="main">)</span><span class="main">,</span> 
    New_Algo_trans_step <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span> <span class="main">{&gt;</span> new_algo_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs New_Algo_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> new_algo_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> μnxt <span class="main">=</span> μ nxt
  <span class="keyword1"><span class="command">have</span></span> r_phase_step<span class="main">:</span> <span class="quoted"><span class="quoted">"nr_steps <span class="main">*</span> three_phase <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r three_phase_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> ran <span class="main">(</span>prop_vote <span class="keyword1">o</span> <span class="skolem">sc'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> guard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">cand</span><span class="main">∈</span><span class="skolem">C</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> majorities.opt_mru_guard <span class="main">(</span>mru_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="bound">Q</span> <span class="bound">cand</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_def ran_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">cand</span>
    <span class="keyword3"><span class="command">assume</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"prop_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cand</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lvs0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mru_vote <span class="keyword1">o</span> <span class="skolem">sc</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">∈</span> majs"</span></span> <span class="keyword1"><span class="command">using</span></span> Some μnxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def majs_def next0_def get_msgs_dom<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"map_option snd <span class="main">(</span>option_Max_by fst <span class="main">(</span>ran <span class="main">(</span><span class="var">?lvs</span> <span class="main">|`</span> <span class="var">?Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="skolem">cand</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Some nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      msgs_mru_vote<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> HOs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">HOs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> μ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">μ</span></span><span class="main">,</span> <span class="operator">OF</span> μ<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      get_msgs_dom<span class="main">[</span><span class="operator">OF</span> μ<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"majorities.opt_mru_guard <span class="var">?lvs0</span> <span class="var">?Q</span> <span class="skolem">cand</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_guard_def Let_def majorities.opt_mru_vote_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> majorities.opt_mru_guard <span class="var">?lvs0</span> <span class="bound">Q</span> <span class="skolem">cand</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span>
      next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span>
      candidates <span class="main">:=</span> <span class="skolem">C</span>
    <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step0 <span class="skolem">r</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R r nxt guard
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_step0_def sa'_def new_algo_ref_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> new_algo_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> R nxt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sa'_def new_algo_ref_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>
      mru_vote_evolution0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nxt<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> decide_evolution<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> nxt<span class="main"><span class="main">]</span></span>
    <span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def C_def o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">C</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step0 <span class="bound">r</span> <span class="bound">C</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> new_algo_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step1_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>new_algo_ref_rel<span class="main">}</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> majorities.opt_mru_step1 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> 
    New_Algo_trans_step <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span> next1 send1 <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">{&gt;</span> new_algo_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs New_Algo_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> new_algo_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> μnxt <span class="main">=</span> μ nxt

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> mru_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> mru_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Q</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="bound">p</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="bound">Q</span><span class="main">.</span> prop_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span>
      <span class="main">∧</span> <span class="bound">Q</span> <span class="main">∈</span> majs
      <span class="main">∧</span> <span class="main">(</span>mru_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">v</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> <span class="skolem">μ</span> <span class="skolem">p</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>PreVote <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> maj_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> majs"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Q_HOs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊆</span> dom <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lv<span class="main">:</span> <span class="quoted"><span class="quoted">"mru_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LV</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def Let_def S_def majs_def Q_prevotes_v_def<span class="main">)</span>
  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> prop_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">Q</span> <span class="skolem">v</span>"</span></span><span class="main">)</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> μ<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send1_def restrict_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
    
    <span class="keyword1"><span class="command">with</span></span> maj_Q <span class="keyword2"><span class="keyword">and</span></span> lv <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">Q</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">Q</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">Q</span> <span class="main">∈</span> majs <span class="main">∧</span> <span class="var">?LV</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>    

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> mru_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">∈</span> ran <span class="main">(</span>prop_vote <span class="keyword1">o</span> <span class="skolem">sc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> pstate.mru_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> ran <span class="main">(</span>prop_vote <span class="keyword1">o</span> <span class="skolem">sc</span><span class="main">)</span>  
        <span class="main">⟹</span> <span class="skolem">thesis</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> S nxt
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">v</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> prop_vote<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="skolem">Q</span><span class="main">.</span> prop_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> maj_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> majs"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> pstate.mru_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LV</span><span class="main">(</span><span class="skolem">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> S
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> majorities.qintersect<span class="main">)</span>
    
    <span class="keyword1"><span class="command">with</span></span> asm prop_vote maj_Q <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv comp_eq_dest_lhs majorities.empty_not_quorum ranI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span> next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span> 
    opt_mru_state.mru_vote <span class="main">:=</span> opt_mru_state.mru_vote <span class="skolem">sa</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span>
  <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step1 <span class="skolem">r</span> <span class="skolem">S</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r R v
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_step1_def sa'_def 
      new_algo_ref_rel_def ball_conj_distrib<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> new_algo_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> r R
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mru_vote <span class="keyword1">o</span> <span class="skolem">sc'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>mru_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mru_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>mru_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> v
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def map_add_def const_map_is_None const_map_is_Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> R r nxt
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_algo_ref_rel_def sa'_def three_step_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> decide_evolution<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>      
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step1 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> new_algo_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step2_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>new_algo_ref_rel<span class="main">}</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">dec_f</span><span class="main">.</span> majorities.opt_mru_step2 <span class="bound">r</span> <span class="bound">dec_f</span><span class="main">)</span><span class="main">,</span> 
    New_Algo_trans_step <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span> <span class="main">{&gt;</span> new_algo_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs New_Algo_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> new_algo_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send2 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> μnxt <span class="main">=</span> μ nxt

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dec_f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dec_f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">then</span> decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>

  <span class="keyword1"><span class="command">have</span></span> dec_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span> <span class="main">=</span> decide <span class="main">∘</span> <span class="skolem">sc'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def dec_f_def next2_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span>
    next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span>
    decisions <span class="main">:=</span> decisions <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">dec_f</span>
  <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> new_algo_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> R r nxt
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_algo_ref_rel_def sa'_def dec_f three_step_Suc 
      mru_vote_evolution2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step2 <span class="skolem">r</span> <span class="skolem">dec_f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r R
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sc_r_votes</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sc_r_votes</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> mru_vote <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">then</span> map_option snd <span class="main">(</span>mru_vote <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">have</span></span> sc_r_votes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sc_r_votes</span> <span class="main">=</span> majorities.r_votes <span class="skolem">sa</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R r
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_algo_ref_rel_def sc_r_votes_def majorities.r_votes_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"majorities.step2_d_guard <span class="skolem">dec_f</span> <span class="skolem">sc_r_votes</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.step2_d_guard_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> d_f_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dec_f</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> Q<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> majs"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> vote<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> <span class="skolem">μ</span> <span class="skolem">p</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> d_f_p
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next2_def dec_f_def Q'_votes_v_def Let_def majs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> mru_vote<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> mru_vote <span class="main">(</span><span class="skolem">sc</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> vote μ<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send2_def sc_r_votes_def restrict_map_def 
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">sc_r_votes</span> <span class="main">∈</span> majs"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  majorities.mono_quorum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Q<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sc_r_votes_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> ran <span class="skolem">sc_r_votes</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q<span class="main">[</span><span class="operator">THEN</span> majorities.quorum_non_empty<span class="main">]</span> mru_vote
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sc_r_votes_def ex_in_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ranI<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> ran <span class="skolem">sc_r_votes</span> <span class="main">∧</span> dom <span class="skolem">sc_r_votes</span> <span class="main">∈</span> majs"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r R
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_step2_def sa'_def new_algo_ref_rel_def sc_r_votes<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">dec_f</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step2 <span class="bound">r</span> <span class="bound">dec_f</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> new_algo_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> New_Algo_Refines_votes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines new_algo_ref_rel
    majorities.ts_mru_TS <span class="main">(</span>New_Algo_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_basic<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init <span class="main">(</span>New_Algo_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">⊆</span> new_algo_ref_rel <span class="main">``</span> init majorities.ts_mru_TS"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> New_Algo_TS_defs majorities.ts_mru_TS_defs new_algo_ref_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>new_algo_ref_rel<span class="main">}</span> TS.trans majorities.ts_mru_TS<span class="main">,</span> 
      TS.trans <span class="main">(</span>New_Algo_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">{&gt;</span> new_algo_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.ts_mru_TS_defs New_Algo_TS_defs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHO_trans_alt New_Algo_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step0_ref step1_ref step2_ref<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">theorem</span></span> New_Algo_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"HORun New_Algo_Alg <span class="free">rho</span> <span class="free">HOs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> HOcommPerRd New_Algo_M <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"HOcommGlobal New_Algo_M <span class="free">HOs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> commG <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ph</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    HOs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="numeral">2</span><span class="main">}</span><span class="main">.</span> 
      <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">HOs</span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">+</span><span class="bound">i</span><span class="main">)</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">HOs</span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> New_Algo_HOMachine_def NA_commGlobal_def<span class="main">)</span>

  <span class="comment1">― ‹The tedious bit: obtain four consecutive rounds linked by send/next functions›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r0</span> <span class="main">=</span> nr_steps <span class="main">*</span> <span class="skolem">ph</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg0</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> Suc <span class="skolem">r0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg1</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">=</span> Suc <span class="skolem">r1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg2</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg3</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r2</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> 
    run<span class="main">[</span><span class="operator">simplified</span> HORun_def SHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r0</span>"</span></span><span class="main">]</span> 
    run<span class="main">[</span><span class="operator">simplified</span> HORun_def SHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r1</span>"</span></span><span class="main">]</span>
    run<span class="main">[</span><span class="operator">simplified</span> HORun_def SHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r2</span>"</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ0</span></span> <span class="skolem"><span class="skolem">μ1</span></span> <span class="skolem"><span class="skolem">μ2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    send0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ0</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">cfg0</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r0</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> three_step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r0</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ0</span> <span class="bound">p</span><span class="main">)</span> undefined <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ1</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">cfg1</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r1</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> three_step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r1</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ1</span> <span class="bound">p</span><span class="main">)</span> undefined <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ2</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send2 <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">cfg2</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> three_step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="skolem">r2</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ2</span> <span class="bound">p</span><span class="main">)</span> undefined <span class="main">(</span><span class="skolem">cfg3</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> New_Algo_Alg_def three_step_def NA_nextState_def NA_sendMsg_def all_conj_distrib
      r0_def r1_def r2_def
      cfg0_def cfg1_def cfg2_def cfg3_def mod_Suc
      <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="comment1">― ‹The proof: everybody hears the same messages (non-empty!) in r0...›</span>

  <span class="keyword1"><span class="command">from</span></span> HOs<span class="main">[</span><span class="operator">THEN</span> bspec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> send0
    <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="skolem">μ0</span> <span class="bound">p</span> <span class="main">=</span> <span class="skolem">μ0</span> <span class="bound">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="main">(</span>dom <span class="main">(</span><span class="skolem">μ0</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send0_def r1_def r0_def dom_def restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="comment1">― ‹...hence everybody sets <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">prop_vote</span><span class="antiquote">}</span></span> to the same value...›</span>    
  <span class="keyword1"><span class="command">hence</span></span> same_prevote<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_vote <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> prop_vote <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> prop_vote <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> three_step0
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def Let_def all_conj_distrib <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def all_conj_distrib Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def all_conj_distrib Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> dom_eq_empty_conv empty_iff majoritiesE'<span class="main">)</span>

  <span class="comment1">― ‹...which will become our decision value.›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dec_v</span></span> <span class="keyword2"><span class="keyword">where</span></span> dec_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> prop_vote <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">dec_v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse<span class="main">)</span>

  <span class="comment1">― ‹...and since everybody hears from majority in r1...›</span>
  <span class="keyword1"><span class="command">from</span></span> HOs<span class="main">[</span><span class="operator">THEN</span> bspec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> send1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="skolem">μ1</span> <span class="bound">p</span> <span class="main">=</span> <span class="skolem">μ1</span> <span class="bound">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="main">(</span>dom <span class="main">(</span><span class="skolem">μ1</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send1_def r1_def r0_def dom_def restrict_map_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="comment1">― ‹and since everybody casts a pre-vote for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">dec_v</span></span><span class="antiquote">}</span></span>, everybody will vote <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">dec_v</span></span><span class="antiquote">}</span></span>›</span> 
  <span class="keyword1"><span class="command">have</span></span> all_vote<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> mru_vote <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r2</span><span class="main">,</span> <span class="skolem">dec_v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">have</span></span> r0_step<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r0_def three_step_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> HOs<span class="main">[</span><span class="operator">THEN</span> bspec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="skolem">r1</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r1_def r0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Q_prevotes_v <span class="main">(</span><span class="skolem">μ1</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">dec_v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dec_v send1<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_prevotes_v_def get_msgs_benign restrict_map_def send1_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"mru_vote <span class="main">(</span><span class="skolem">cfg2</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r2</span><span class="main">,</span> <span class="skolem">dec_v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 
      three_step1<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> r0_step
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def r2_def r1_def three_step_phase_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹And finally, everybody will also decide <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">dec_v</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">have</span></span> all_decide<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> decide <span class="main">(</span><span class="skolem">cfg3</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">dec_v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">from</span></span> HOs<span class="main">[</span><span class="operator">THEN</span> bspec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊆</span> <span class="free">HOs</span> <span class="skolem">r2</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2_def r1_def r0_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="skolem">cfg3</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">dec_v</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> three_step2<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> send2<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next2_def send2_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfg3_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Paxos_Defs">
<div class="head">
<h1>Theory Paxos_Defs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Paxos Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Paxos_Defs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/HOModel.html">Heard_Of.HOModel</a> <span class="quoted">"<a href="Consensus_Types.html">../Consensus_Types</a>"</span> <span class="quoted">"<a href="Consensus_Misc.html">../Consensus_Misc</a>"</span> <a href="Three_Steps.html">Three_Steps</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is a modified version (closer to the original Paxos) of PaxosDefs from the Heard Of 
  entry in the AFP.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Model of the algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following record models the local state of a process.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>                <span class="comment1">― ‹current value held by process›</span>
  mru_vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> option"</span></span>
  commt <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>   <span class="comment1">― ‹for coordinators: the value processes are asked to commit to›</span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The algorithm relies on a coordinator for each phase of the algorithm.
  A phase lasts three rounds. The HO model formalization already provides the 
  infrastructure for this, but unfortunately the coordinator is not passed to
  the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sendMsg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function. Using the infrastructure would thus require 
  additional invariants and proofs; for simplicity, we use a global 
  constant instead.›</span></span>

<span class="keyword1"><span class="command">consts</span></span> coord <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process"</span></span>
<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">coord</span><span class="main">)</span>
  coord_phase<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> three_phase <span class="bound">r</span> <span class="main">=</span> three_phase <span class="bound">r'</span> <span class="main">⟶</span> coord <span class="bound">r</span> <span class="main">=</span> coord <span class="bound">r'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Possible messages sent during the execution of the algorithm.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'val</span> msg <span class="main">=</span>
  ValStamp <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="main">|</span> NeverVoted
<span class="main">|</span> Vote <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span>
<span class="main">|</span> Null  <span class="comment1">― ‹dummy message in case nothing needs to be sent›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Characteristic predicates on messages.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isValStamp</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isValStamp</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span> <span class="bound">ts</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> ValStamp <span class="bound">v</span> <span class="bound">ts</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isVote</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isVote</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Vote <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Selector functions to retrieve components of messages. These functions
  have a meaningful result only when the message is of an appropriate kind.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">val</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>ValStamp <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>Vote <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> field of the initial state is unconstrained, all other
  fields are initialized appropriately.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Paxos_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="main">≡</span>
   mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
   <span class="main">∧</span> commt <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
   <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
  "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mru_vote_to_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mru_vote_to_msg</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">of</span>
    Some <span class="main">(</span><span class="bound">ts</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> ValStamp <span class="bound">v</span> <span class="bound">ts</span>
    <span class="main">|</span> None <span class="main">⇒</span> NeverVoted"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">msg_to_val_stamp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> msg <span class="main">⇒</span> <span class="main">(</span>round <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span>option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msg_to_val_stamp</span> <span class="main">(</span>ValStamp <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msg_to_val_stamp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msgs_to_lvs</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> round <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> map"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msgs_to_lvs</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">≡</span> msg_to_val_stamp <span class="keyword1">∘<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> coord <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> mru_vote_to_msg <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">else</span> Null"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next0</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat 
  <span class="main">⇒</span> process 
  <span class="main">⇒</span> <span class="tfree">'val</span> pstate 
  <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span>
  <span class="main">⇒</span> process
  <span class="main">⇒</span> <span class="tfree">'val</span> pstate
  <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span> <span class="bound">lvs</span> <span class="main">=</span> msgs_to_lvs <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> coord <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> card <span class="bound">Q</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
      <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> commt <span class="main">:=</span> Some <span class="main">(</span>case_option <span class="main">(</span>x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> snd <span class="main">(</span>option_Max_by fst <span class="main">(</span>ran <span class="main">(</span><span class="bound">lvs</span> <span class="main">|`</span> <span class="bound">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span> <span class="main">)</span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">⦇</span> commt <span class="main">:=</span> None <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> coord <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> commt <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≠</span> None <span class="keyword1">then</span> Vote <span class="main">(</span>the <span class="main">(</span>commt <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> Null"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next1</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat 
  <span class="main">⇒</span> process 
  <span class="main">⇒</span> <span class="tfree">'val</span> pstate 
  <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span>
  <span class="main">⇒</span> process
  <span class="main">⇒</span> <span class="tfree">'val</span> pstate
  <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coord <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">≠</span> None <span class="main">∧</span> isVote <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coord <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> mru_vote <span class="main">:=</span> Some <span class="main">(</span>three_phase <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> val <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coord <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="main">⦈</span>
   <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">of</span>
    Some <span class="main">(</span><span class="bound">phs</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">phs</span> <span class="main">=</span> three_phase <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Vote <span class="bound">v</span> <span class="keyword1">else</span> Null<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Null
  <span class="main">)</span>"</span></span>

<span class="comment1">― ‹processes from which a vote was received›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">votes_rcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">votes_rcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span>
   <span class="main">{</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="bound">v</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">the_rcvd_vote</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">the_rcvd_vote</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> snd <span class="main">`</span> votes_rcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> card <span class="main">(</span>votes_rcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
   <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> decide <span class="main">:=</span> Some <span class="main">(</span>the_rcvd_vote <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">)</span> <span class="main">⦈</span>
   <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>
 "</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The overall send function and next-state relation are simply obtained as
  the composition of the individual relations defined above.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Paxos_sendMsg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> process <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_sendMsg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span>
   <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> send0 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> send1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> send2 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Paxos_nextState</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> 
                       <span class="main">⇒</span> process <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> next0 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> next1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> next2 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Paxos_commPerRd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_commPerRd</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HO</span></span></span><span class="main">::</span>process HO<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">crd</span></span></span><span class="main">::</span>process coord<span class="main">)</span> <span class="main">≡</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Paxos_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">≡</span>
      <span class="main">∃</span><span class="bound">ph</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">::</span>process<span class="main">.</span>
           coord <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">)</span> <span class="main">=</span> <span class="bound">c</span>
         <span class="main">∧</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \emph{Paxos} Heard-Of machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the coordinated HO machine for the \emph{Paxos} algorithm
  by assembling the algorithm definition and its communication-predicate.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Paxos_Alg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_Alg</span> <span class="main">≡</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span> Paxos_initState<span class="main">,</span>
      sendMsg <span class="main">=</span> Paxos_sendMsg<span class="main">,</span>
      CnextState <span class="main">=</span> Paxos_nextState <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Paxos_CHOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_CHOMachine</span> <span class="main">≡</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span> Paxos_initState<span class="main">,</span>
      sendMsg <span class="main">=</span> Paxos_sendMsg<span class="main">,</span>
      CnextState <span class="main">=</span> Paxos_nextState<span class="main">,</span>
      CHOcommPerRd <span class="main">=</span> Paxos_commPerRd<span class="main">,</span>
      CHOcommGlobal <span class="main">=</span> Paxos_commGlobal <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_M</span> <span class="main">≡</span> <span class="main">(</span>Paxos_CHOMachine<span class="main">::</span><span class="main">(</span>process<span class="main">,</span> <span class="tfree">'val</span> pstate<span class="main">,</span> <span class="tfree">'val</span> msg<span class="main">)</span> CHOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Paxos_Proofs">
<div class="head">
<h1>Theory Paxos_Proofs</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Paxos_Proofs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Three_Step_MRU.html">Three_Step_MRU</a> <span class="quoted">"<a href="HO_Transition_System.html">../HO_Transition_System</a>"</span> <a href="../Heard_Of/Majorities.html">Heard_Of.Majorities</a> <span class="quoted">"<a href="Quorums.html">../Quorums</a>"</span> <a href="Paxos_Defs.html">Paxos_Defs</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> p_TS_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span>process <span class="main">⇒</span> <span class="main">(</span>val pstate<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Paxos_TS</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process<span class="main">)</span>
  <span class="main">⇒</span> p_TS_state TS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_TS</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="main">=</span> CHO_to_TS Paxos_Alg <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="main">(</span>K <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Paxos_TS_defs <span class="main">=</span> Paxos_TS_def CHO_to_TS_def Paxos_Alg_def CHOinitConfig_def
  Paxos_initState_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Paxos_trans_step</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Paxos_trans_step</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">μ</span><span class="main">.</span>
    <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">,</span> <span class="bound">cfg'</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">cfg</span> <span class="bound">cfg'</span><span class="main">.</span> three_step <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span>  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span>
      <span class="bound">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">cfg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span>
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="bound">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="bound">cfg'</span> <span class="bound">p</span><span class="main">)</span>
    <span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> three_step_less_D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> three_step <span class="free">r</span> <span class="main">⟹</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> three_step_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Paxos_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CSHO_trans_alt Paxos_sendMsg Paxos_nextState <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span>K <span class="main">∘</span> <span class="free">crds</span><span class="main">)</span> <span class="main">=</span> 
  Paxos_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span>
  <span class="main">∪</span> Paxos_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next1 send1 <span class="main">1</span>
  <span class="main">∪</span> Paxos_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CSHO_trans_alt Paxos_sendMsg Paxos_nextState <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span>K <span class="main">∘</span> <span class="free">crds</span><span class="main">)</span>
    <span class="main">⊆</span> Paxos_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span> <span class="main">∪</span>
       Paxos_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next1 send1 <span class="main">1</span> <span class="main">∪</span>
       Paxos_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def Paxos_sendMsg_def Paxos_nextState_def 
    Paxos_trans_step_def K_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> three_step_less_D<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Paxos_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span> <span class="main">∪</span>
    Paxos_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next1 send1 <span class="main">1</span> <span class="main">∪</span>
    Paxos_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span>
    <span class="main">⊆</span> CSHO_trans_alt Paxos_sendMsg Paxos_nextState <span class="free">HOs</span> <span class="free">SHOs</span> <span class="main">(</span>K <span class="main">∘</span> <span class="free">crds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def Paxos_sendMsg_def Paxos_nextState_def 
    Paxos_trans_step_def K_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> rHO <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process HO"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">coord_vote_to_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇒</span> <span class="main">(</span>val pstate<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coord_vote_to_set</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">sc</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> pstate.commt <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sc</span></span></span> <span class="main">(</span>coord <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> 
      <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> None 
          <span class="keyword1">then</span> <span class="main">{}</span>
          <span class="keyword1">else</span> <span class="main">{</span>the <span class="bound">v</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">paxos_ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>three_step_mru_state <span class="main">×</span> p_TS_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">paxos_ref_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    opt_mru_state.next_round <span class="bound">sa</span> <span class="main">=</span> <span class="bound">r</span>
    <span class="main">∧</span> opt_mru_state.decisions <span class="bound">sa</span> <span class="main">=</span> pstate.decide <span class="keyword1">o</span> <span class="bound">sc</span>
    <span class="main">∧</span> opt_mru_state.mru_vote <span class="bound">sa</span> <span class="main">=</span> pstate.mru_vote <span class="keyword1">o</span> <span class="bound">sc</span>
    <span class="main">∧</span> <span class="main">(</span>three_step <span class="bound">r</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟶</span> three_step_mru_state.candidates <span class="bound">sa</span> <span class="main">=</span> coord_vote_to_set <span class="bound">r</span> <span class="bound">sc</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mru_vote_evolution0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> mru_vote <span class="keyword1">o</span> <span class="free">s'</span> <span class="main">=</span> mru_vote <span class="keyword1">o</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next2_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mru_vote_evolution2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> mru_vote <span class="keyword1">o</span> <span class="free">s'</span> <span class="main">=</span> mru_vote <span class="keyword1">o</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next2_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> decide_evolution<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> decide <span class="keyword1">o</span> <span class="free">s</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> decide <span class="keyword1">o</span> <span class="free">s</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next1_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msgs_mru_vote<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">(</span>coord <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>coord <span class="free">r</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="var">?p</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>msgs_to_lvs <span class="main">(</span><span class="free">μ</span> <span class="var">?p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="free">HOs</span> <span class="free">r</span> <span class="var">?p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mru_vote <span class="keyword1">o</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">|`</span> <span class="free">HOs</span> <span class="free">r</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send0_def restrict_map_def msgs_to_lvs_def
      mru_vote_to_msg_def map_comp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> step0_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>paxos_ref_rel<span class="main">}</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">C</span><span class="main">.</span> majorities.opt_mru_step0 <span class="bound">r</span> <span class="bound">C</span><span class="main">)</span><span class="main">,</span> 
    Paxos_trans_step <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span> <span class="main">{&gt;</span> paxos_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs Paxos_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> paxos_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> μnxt <span class="main">=</span> μ nxt
  <span class="keyword1"><span class="command">from</span></span> r <span class="keyword1"><span class="command">have</span></span> same_coord<span class="main">:</span> <span class="quoted"><span class="quoted">"coord <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> coord <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step_phase_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> coord_phase<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> coord_vote_to_set <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> guard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">cand</span><span class="main">∈</span><span class="skolem">C</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> majorities.opt_mru_guard <span class="main">(</span>mru_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="bound">Q</span> <span class="bound">cand</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cand</span>
    <span class="keyword3"><span class="command">assume</span></span> cand<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cand</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="skolem">sc'</span> <span class="main">(</span>coord <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cand</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"coord <span class="skolem">r</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_def coord_vote_to_set_def Let_def same_coord<span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="skolem">r</span> <span class="main">(</span>coord <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lvs0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mru_vote <span class="keyword1">o</span> <span class="skolem">sc</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">∈</span> majs"</span></span> <span class="keyword1"><span class="command">using</span></span> Some μnxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"coord <span class="skolem"><span class="skolem">r</span></span>"</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def majs_def next0_def same_coord get_msgs_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"map_option snd <span class="main">(</span>option_Max_by fst <span class="main">(</span>ran <span class="main">(</span><span class="var">?lvs</span> <span class="main">|`</span> <span class="var">?Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="skolem">cand</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Some nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"coord <span class="skolem">r</span>"</span></span><span class="main">]</span>
      msgs_mru_vote<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> HOs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">HOs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> μ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">μ</span></span><span class="main">,</span> <span class="operator">OF</span> μ<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"coord <span class="skolem">r</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
      get_msgs_dom<span class="main">[</span><span class="operator">OF</span> μ<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"coord <span class="skolem">r</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"majorities.opt_mru_guard <span class="var">?lvs0</span> <span class="var">?Q</span> <span class="skolem">cand</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_guard_def Let_def majorities.opt_mru_vote_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> majorities.opt_mru_guard <span class="var">?lvs0</span> <span class="bound">Q</span> <span class="skolem">cand</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span>
      next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span>
      candidates <span class="main">:=</span> <span class="skolem">C</span>
    <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step0 <span class="skolem">r</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R r nxt guard
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_step0_def sa'_def paxos_ref_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> paxos_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> R nxt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sa'_def paxos_ref_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>
      mru_vote_evolution0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nxt<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> decide_evolution<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> nxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def C_def o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">C</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step0 <span class="bound">r</span> <span class="bound">C</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> paxos_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step1_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>paxos_ref_rel<span class="main">}</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> majorities.opt_mru_step1 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> 
    Paxos_trans_step <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span> next1 send1 <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">{&gt;</span> paxos_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs Paxos_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> paxos_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> μnxt <span class="main">=</span> μ nxt

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> the <span class="main">(</span>commt <span class="main">(</span><span class="skolem">sc</span> <span class="main">(</span>coord <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> coord <span class="skolem">r</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="bound">p</span> <span class="main">∧</span> commt <span class="main">(</span><span class="skolem">sc</span> <span class="main">(</span>coord <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span> next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span> 
    opt_mru_state.mru_vote <span class="main">:=</span> opt_mru_state.mru_vote <span class="skolem">sa</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span>
  <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step1 <span class="skolem">r</span> <span class="skolem">S</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r R 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_step1_def sa'_def  S_def v_def 
      coord_vote_to_set_def paxos_ref_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> paxos_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> r R
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mru_vote <span class="keyword1">o</span> <span class="skolem">sc'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>mru_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mru_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>mru_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> μnxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign next1_def send1_def S_def v_def map_add_def 
          const_map_is_None const_map_is_Some restrict_map_def isVote_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> R r nxt
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paxos_ref_rel_def sa'_def three_step_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> decide_evolution<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>      
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step1 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> paxos_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step2_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>paxos_ref_rel<span class="main">}</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">dec_f</span><span class="main">.</span> majorities.opt_mru_step2 <span class="bound">r</span> <span class="bound">dec_f</span><span class="main">)</span><span class="main">,</span> 
    Paxos_trans_step <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span> <span class="main">{&gt;</span> paxos_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs Paxos_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> paxos_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send2 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> μnxt <span class="main">=</span> μ nxt

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dec_f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dec_f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">then</span> decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>

  <span class="keyword1"><span class="command">have</span></span> dec_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span> <span class="main">=</span> decide <span class="main">∘</span> <span class="skolem">sc'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def dec_f_def next2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span>
    next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span>
    decisions <span class="main">:=</span> decisions <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">dec_f</span>
  <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> paxos_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> R r nxt
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paxos_ref_rel_def sa'_def dec_f three_step_Suc 
      mru_vote_evolution2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step2 <span class="skolem">r</span> <span class="skolem">dec_f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r R
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sc_r_votes</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sc_r_votes</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> mru_vote <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">then</span> map_option snd <span class="main">(</span>mru_vote <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">have</span></span> sc_r_votes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sc_r_votes</span> <span class="main">=</span> majorities.r_votes <span class="skolem">sa</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R r
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> paxos_ref_rel_def sc_r_votes_def majorities.r_votes_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"majorities.step2_d_guard <span class="skolem">dec_f</span> <span class="skolem">sc_r_votes</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.step2_d_guard_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> d_f_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dec_f</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"votes_rcvd <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> Qv<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?Qv</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> the_rcvd_vote <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> d_f_p
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next2_def dec_f_def<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> snd <span class="main">`</span> votes_rcvd <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> the_rcvd_vote_def ex_in_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> le_less_trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> le0<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qv</span> <span class="main">=</span> map_graph <span class="main">(</span><span class="skolem">sc_r_votes</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> μ<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send2_def restrict_map_def votes_rcvd_def
          sc_r_votes_def image_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> ran <span class="skolem">sc_r_votes</span> <span class="main">∧</span> dom <span class="skolem">sc_r_votes</span> <span class="main">∈</span> majs"</span></span> <span class="keyword1"><span class="command">using</span></span> Qv<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def inj_on_def map_graph_def fun_graph_def sc_r_votes_def
          the_rcvd_vote_def majs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ranI
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_le_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_inj_on_le<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">fst</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r R
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_step2_def sa'_def paxos_ref_rel_def sc_r_votes<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">dec_f</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step2 <span class="bound">r</span> <span class="bound">dec_f</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> paxos_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Paxos_Refines_ThreeStep_MRU<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines paxos_ref_rel 
    majorities.ts_mru_TS <span class="main">(</span>Paxos_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_basic<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init <span class="main">(</span>Paxos_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">⊆</span> paxos_ref_rel <span class="main">``</span> init majorities.ts_mru_TS"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Paxos_TS_defs majorities.ts_mru_TS_def paxos_ref_rel_def 
      majorities.ts_mru_init_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>paxos_ref_rel<span class="main">}</span> TS.trans majorities.ts_mru_TS<span class="main">,</span> 
      TS.trans <span class="main">(</span>Paxos_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">{&gt;</span> paxos_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.ts_mru_TS_defs Paxos_TS_defs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHO_trans_alt Paxos_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step0_ref step1_ref step2_ref<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">theorem</span></span> Paxos_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun Paxos_Alg <span class="free">rho</span> <span class="free">HOs</span> <span class="free">crds</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> CHOcommPerRd Paxos_M <span class="bound">r</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"CHOcommGlobal Paxos_M <span class="free">HOs</span> <span class="free">crds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> commG <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ph</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    HOs<span class="main">:</span>
       <span class="quoted"><span class="quoted">"coord <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>
         <span class="main">∧</span> card <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Paxos_CHOMachine_def Paxos_commGlobal_def<span class="main">)</span>

  <span class="comment1">― ‹The tedious bit: obtain three consecutive rounds linked by send/next functions›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r0</span> <span class="main">=</span> nr_steps <span class="main">*</span> <span class="skolem">ph</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg0</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> Suc <span class="skolem">r0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg1</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">=</span> Suc <span class="skolem">r1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg2</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg3</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r2</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span>   
    run<span class="main">[</span><span class="operator">simplified</span> CHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r0</span>"</span></span><span class="main">]</span> 
    run<span class="main">[</span><span class="operator">simplified</span> CHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r1</span>"</span></span><span class="main">]</span>
    run<span class="main">[</span><span class="operator">simplified</span> CHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r2</span>"</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ0</span></span> <span class="skolem"><span class="skolem">μ1</span></span> <span class="skolem"><span class="skolem">μ2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    send0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ0</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">cfg0</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r0</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> three_step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r0</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ1</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">cfg1</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r1</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> three_step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r1</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="main">(</span>Suc <span class="skolem">r1</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ2</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send2 <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">cfg2</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> three_step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="skolem">r2</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="main">(</span>Suc <span class="skolem">r2</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg3</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Paxos_Alg_def three_step_def Paxos_nextState_def Paxos_sendMsg_def all_conj_distrib
      r0_def r1_def r2_def
      cfg0_def cfg1_def cfg2_def cfg3_def mod_Suc
      <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="comment1">― ‹The proof: the coordinator hears enough messages in r0 and thus selects a value.›</span>

  <span class="keyword1"><span class="command">from</span></span> HOs three_step0<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> send0<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="skolem">cfg1</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def Let_def r0_def get_msgs_dom<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dec_v</span></span> <span class="keyword2"><span class="keyword">where</span></span> dec_v<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="skolem">cfg1</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">dec_v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> step_r0<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r0_def three_step_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> same_coord<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"coord <span class="skolem">r1</span> <span class="main">=</span> coord <span class="skolem">r0</span>"</span></span>
    <span class="quoted"><span class="quoted">"coord <span class="skolem">r2</span> <span class="main">=</span> coord <span class="skolem">r0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step_phase_Suc r2_def r1_def r0_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> coord_phase<span class="main">)</span>

  <span class="comment1">― ‹All processes hear from the coordinator, and thus set their vote to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">dec_v</span></span><span class="antiquote">}</span></span>.›</span>  
  <span class="keyword1"><span class="command">hence</span></span> all_vote<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> mru_vote <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r2</span><span class="main">,</span> <span class="skolem">dec_v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> HOs three_step1 send1 step_r0 dec_v
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def Let_def get_msgs_benign send1_def restrict_map_def isVote_def
      r2_def r1_def r0_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> same_coord<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> r2_def r1_def<span class="main"><span class="main">]</span></span> three_step_phase_Suc<span class="main">)</span>

  <span class="comment1">― ‹And finally, everybody will also decide <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">dec_v</span></span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">have</span></span> all_decide<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> decide <span class="main">(</span><span class="skolem">cfg3</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">dec_v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"votes_rcvd <span class="main">(</span><span class="skolem">μ2</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">HOs</span> <span class="skolem">r2</span> <span class="skolem">p</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">dec_v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> send2<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> all_vote
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> send2_def get_msgs_benign votes_rcvd_def restrict_map_def image_def o_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> HOs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2_def r1_def r0_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="skolem">r2</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.empty less_nat_zero_code<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="skolem">cfg3</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">dec_v</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> three_step2<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> send2<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> all_vote
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next2_def send2_def Let_def get_msgs_benign 
        the_rcvd_vote_def restrict_map_def image_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfg3_def<span class="main">)</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="CT_Defs">
<div class="head">
<h1>Theory CT_Defs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Chandra-Toueg $\diamond S$ Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CT_Defs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Heard_Of/HOModel.html">Heard_Of.HOModel</a> <span class="quoted">"<a href="Consensus_Types.html">../Consensus_Types</a>"</span> <span class="quoted">"<a href="Consensus_Misc.html">../Consensus_Misc</a>"</span> <a href="Three_Steps.html">Three_Steps</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following record models the local state of a process.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'val</span> pstate <span class="main">=</span>
  x <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'val</span></span></span>                <span class="comment1">― ‹current value held by process›</span>
  mru_vote <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> option"</span></span>
  commt <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span>   <span class="comment1">― ‹for coordinators: the value processes are asked to commit to›</span>
  decide <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> option"</span></span>  <span class="comment1">― ‹value the process has decided on, if any›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The algorithm relies on a coordinator for each phase of the algorithm.
  A phase lasts three rounds. The HO model formalization already provides the 
  infrastructure for this, but unfortunately the coordinator is not passed to
  the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sendMsg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function. Using the infrastructure would thus require 
  additional invariants and proofs; for simplicity, we use a global 
  constant instead.›</span></span>

<span class="keyword1"><span class="command">consts</span></span> coord <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process"</span></span>
<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">coord</span><span class="main">)</span>
  coord_phase<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> three_phase <span class="bound">r</span> <span class="main">=</span> three_phase <span class="bound">r'</span> <span class="main">⟶</span> coord <span class="bound">r</span> <span class="main">=</span> coord <span class="bound">r'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Possible messages sent during the execution of the algorithm.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'val</span> msg <span class="main">=</span>
  ValStamp <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="main">|</span> NeverVoted
<span class="main">|</span> Vote <span class="quoted"><span class="quoted">"<span class="tfree">'val</span>"</span></span>
<span class="main">|</span> Null  <span class="comment1">― ‹dummy message in case nothing needs to be sent›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Characteristic predicates on messages.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isValStamp</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isValStamp</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span> <span class="bound">ts</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> ValStamp <span class="bound">v</span> <span class="bound">ts</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">isVote</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">isVote</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Vote <span class="bound">v</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Selector functions to retrieve components of messages. These functions
  have a meaningful result only when the message is of an appropriate kind.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">val</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>ValStamp <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>Vote <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>commt›</span></span></span></span> fields of the initial state is unconstrained, all other
  fields are initialized appropriately.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CT_initState</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CT_initState</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="main">≡</span>
   mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
   <span class="main">∧</span> decide <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> None
  "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mru_vote_to_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mru_vote_to_msg</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">of</span>
    Some <span class="main">(</span><span class="bound">ts</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> ValStamp <span class="bound">v</span> <span class="bound">ts</span>
    <span class="main">|</span> None <span class="main">⇒</span> NeverVoted"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">msg_to_val_stamp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'val</span> msg <span class="main">⇒</span> <span class="main">(</span>round <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span>option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msg_to_val_stamp</span> <span class="main">(</span>ValStamp <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msg_to_val_stamp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msgs_to_lvs</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>process<span class="main">,</span> round <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> map"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msgs_to_lvs</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">≡</span> msg_to_val_stamp <span class="keyword1">∘<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> coord <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> mru_vote_to_msg <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">else</span> Null"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next0</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat 
  <span class="main">⇒</span> process 
  <span class="main">⇒</span> <span class="tfree">'val</span> pstate 
  <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span>
  <span class="main">⇒</span> process
  <span class="main">⇒</span> <span class="tfree">'val</span> pstate
  <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">;</span> <span class="bound">lvs</span> <span class="main">=</span> msgs_to_lvs <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> coord <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> commt <span class="main">:=</span> <span class="main">(</span>case_option <span class="main">(</span>x <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> snd <span class="main">(</span>option_Max_by fst <span class="main">(</span>ran <span class="main">(</span><span class="bound">lvs</span> <span class="main">|`</span> <span class="bound">Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⦈</span> <span class="main">)</span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> coord <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Vote <span class="main">(</span>commt <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Null"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next1</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat 
  <span class="main">⇒</span> process 
  <span class="main">⇒</span> <span class="tfree">'val</span> pstate 
  <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span>
  <span class="main">⇒</span> process
  <span class="main">⇒</span> <span class="tfree">'val</span> pstate
  <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coord <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">≠</span> None
   <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> mru_vote <span class="main">:=</span> Some <span class="main">(</span>three_phase <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> val <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">(</span>coord <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="main">⦈</span>
   <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">send2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> mru_vote <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">of</span>
    Some <span class="main">(</span><span class="bound">phs</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">phs</span> <span class="main">=</span> three_phase <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Vote <span class="bound">v</span> <span class="keyword1">else</span> Null<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Null
  <span class="main">)</span>"</span></span>

<span class="comment1">― ‹processes from which a vote was received›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">votes_rcvd</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">votes_rcvd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span>
   <span class="main">{</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span>Vote <span class="bound">v</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">the_rcvd_vote</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">the_rcvd_vote</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="main">::</span> process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> snd <span class="main">`</span> votes_rcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">msgs</span></span></span> <span class="free"><span class="bound"><span class="entity">crd</span></span></span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> card <span class="main">(</span>votes_rcvd <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>
   <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⦇</span> decide <span class="main">:=</span> Some <span class="main">(</span>the_rcvd_vote <span class="free"><span class="bound"><span class="entity">msgs</span></span></span><span class="main">)</span> <span class="main">⦈</span>
   <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">st'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span>
 "</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The overall send function and next-state relation are simply obtained as
  the composition of the individual relations defined above.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CT_sendMsg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> process <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="tfree">'val</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CT_sendMsg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≡</span>
   <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> send0 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> send1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> send2 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">CT_nextState</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> <span class="main">(</span>process <span class="main">⇀</span> <span class="tfree">'val</span> msg<span class="main">)</span> 
                       <span class="main">⇒</span> process <span class="main">⇒</span> <span class="tfree">'val</span> pstate <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CT_nextState</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span>
   <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> next0 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> next1 <span class="free"><span class="bound"><span class="entity">r</span></span></span>
   <span class="keyword1">else</span> next2 <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The \emph{CT} Heard-Of machine›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the coordinated HO machine for the \emph{CT} algorithm
  by assembling the algorithm definition and its communication-predicate.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CT_Alg</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CT_Alg</span> <span class="main">≡</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span> CT_initState<span class="main">,</span>
      sendMsg <span class="main">=</span> CT_sendMsg<span class="main">,</span>
      CnextState <span class="main">=</span> CT_nextState <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The CT algorithm relies on \emph{waiting}: in each round, the
  coordinator waits until it hears from $\frac{N}{2}$ processes. This
  it reflected in the following per-round predicate.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">CT_commPerRd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process HO <span class="main">⇒</span> process coord <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>                                  
  <span class="quoted"><span class="quoted">"<span class="free">CT_commPerRd</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="main">≡</span> 
    three_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>coord <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">CT_commGlobal</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CT_commGlobal</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">coords</span></span></span> <span class="main">≡</span>
      <span class="main">∃</span><span class="bound">ph</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">::</span>process<span class="main">.</span>
           coord <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">)</span> <span class="main">=</span> <span class="bound">c</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="bound">ph</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CT_CHOMachine</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CT_CHOMachine</span> <span class="main">≡</span>
    <span class="main">⦇</span> CinitState <span class="main">=</span> CT_initState<span class="main">,</span>
      sendMsg <span class="main">=</span> CT_sendMsg<span class="main">,</span>
      CnextState <span class="main">=</span> CT_nextState<span class="main">,</span>
      CHOcommPerRd <span class="main">=</span> CT_commPerRd<span class="main">,</span>
      CHOcommGlobal <span class="main">=</span> CT_commGlobal <span class="main">⦈</span>"</span></span>
                          
<span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">CT_M</span> <span class="main">≡</span> <span class="main">(</span>CT_CHOMachine<span class="main">::</span><span class="main">(</span>process<span class="main">,</span> <span class="tfree">'val</span> pstate<span class="main">,</span> <span class="tfree">'val</span> msg<span class="main">)</span> CHOMachine<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="CT_Proofs">
<div class="head">
<h1>Theory CT_Proofs</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> CT_Proofs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Three_Step_MRU.html">Three_Step_MRU</a> <span class="quoted">"<a href="HO_Transition_System.html">../HO_Transition_System</a>"</span> <a href="../Heard_Of/Majorities.html">Heard_Of.Majorities</a> <span class="quoted">"<a href="Quorums.html">../Quorums</a>"</span> <a href="CT_Defs.html">CT_Defs</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> ct_TS_state <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span>process <span class="main">⇒</span> <span class="main">(</span>val pstate<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CT_TS</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process HO<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span>round <span class="main">⇒</span> process <span class="main">⇒</span> process<span class="main">)</span>
  <span class="main">⇒</span> ct_TS_state TS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CT_TS</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="main">=</span> CHO_to_TS CT_Alg <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> CT_TS_defs <span class="main">=</span> CT_TS_def CHO_to_TS_def CT_Alg_def CHOinitConfig_def
  CT_initState_def

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CT_trans_step</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CT_trans_step</span> <span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">r</span> <span class="bound">μ</span><span class="main">.</span>
    <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">cfg</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>Suc <span class="bound">r</span><span class="main">,</span> <span class="bound">cfg'</span><span class="main">)</span><span class="main">)</span><span class="main">|</span><span class="bound">cfg</span> <span class="bound">cfg'</span><span class="main">.</span> three_step <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">stp</span></span></span>  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span>
      <span class="bound">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span><span class="free"><span class="bound"><span class="entity">snd_f</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">cfg</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">HOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">SHOs</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span>
      <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">nxt_f</span></span></span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">(</span><span class="bound">cfg</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">crds</span></span></span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">cfg'</span> <span class="bound">p</span><span class="main">)</span>
    <span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> three_step_less_D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> three_step <span class="free">r</span> <span class="main">⟹</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> three_step <span class="free">r</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> three_step_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> CT_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"CSHO_trans_alt CT_sendMsg CT_nextState <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> <span class="main">=</span> 
  CT_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span>
  <span class="main">∪</span> CT_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next1 send1 <span class="main">1</span>
  <span class="main">∪</span> CT_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CSHO_trans_alt CT_sendMsg CT_nextState <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span>
    <span class="main">⊆</span> CT_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span> <span class="main">∪</span>
       CT_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next1 send1 <span class="main">1</span> <span class="main">∪</span>
       CT_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def CT_sendMsg_def CT_nextState_def 
    CT_trans_step_def K_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> three_step_less_D<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"CT_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span> <span class="main">∪</span>
    CT_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next1 send1 <span class="main">1</span> <span class="main">∪</span>
    CT_trans_step <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span>
    <span class="main">⊆</span> CSHO_trans_alt CT_sendMsg CT_nextState <span class="free">HOs</span> <span class="free">SHOs</span> <span class="free">crds</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CSHO_trans_alt_def CT_sendMsg_def CT_nextState_def 
    CT_trans_step_def K_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> rHO <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process HO"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Refinement›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ct_ref_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>three_step_mru_state <span class="main">×</span> ct_TS_state<span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ct_ref_rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">sa</span><span class="main">,</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">sc</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    opt_mru_state.next_round <span class="bound">sa</span> <span class="main">=</span> <span class="bound">r</span>
    <span class="main">∧</span> opt_mru_state.decisions <span class="bound">sa</span> <span class="main">=</span> pstate.decide <span class="keyword1">o</span> <span class="bound">sc</span>
    <span class="main">∧</span> opt_mru_state.mru_vote <span class="bound">sa</span> <span class="main">=</span> pstate.mru_vote <span class="keyword1">o</span> <span class="bound">sc</span>
    <span class="main">∧</span> <span class="main">(</span>three_step <span class="bound">r</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟶</span> three_step_mru_state.candidates <span class="bound">sa</span> <span class="main">=</span> <span class="main">{</span>commt <span class="main">(</span><span class="bound">sc</span> <span class="main">(</span>coord <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we need to use the fact that SHOs = HOs (i.e. the setting is non-Byzantine), and
  also the fact that the coordinator receives enough messages in each round›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mru_vote_evolution0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> mru_vote <span class="keyword1">o</span> <span class="free">s'</span> <span class="main">=</span> mru_vote <span class="keyword1">o</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next2_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mru_vote_evolution2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> mru_vote <span class="keyword1">o</span> <span class="free">s'</span> <span class="main">=</span> mru_vote <span class="keyword1">o</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next2_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> decide_evolution<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> decide <span class="keyword1">o</span> <span class="free">s</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="free">r</span> <span class="bound">p</span> <span class="main">(</span><span class="free">s</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">msgs</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crd</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> decide <span class="keyword1">o</span> <span class="free">s</span> <span class="main">=</span> decide <span class="keyword1">o</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def next1_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msgs_mru_vote<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">(</span>coord <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="free">r</span><span class="main">)</span> <span class="free">cfg</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>coord <span class="free">r</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="var">?p</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>msgs_to_lvs <span class="main">(</span><span class="free">μ</span> <span class="var">?p</span><span class="main">)</span><span class="main">)</span> <span class="main">|`</span> <span class="free">HOs</span> <span class="free">r</span> <span class="var">?p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mru_vote <span class="keyword1">o</span> <span class="free">cfg</span><span class="main">)</span> <span class="main">|`</span> <span class="free">HOs</span> <span class="free">r</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send0_def restrict_map_def msgs_to_lvs_def
      mru_vote_to_msg_def map_comp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">HOs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span> process set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">crds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> process <span class="main">⇒</span>process"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    per_rd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> CT_commPerRd <span class="bound">r</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step0_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ct_ref_rel<span class="main">}</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">C</span><span class="main">.</span> majorities.opt_mru_step0 <span class="bound">r</span> <span class="bound">C</span><span class="main">)</span><span class="main">,</span> 
    CT_trans_step <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span> next0 send0 <span class="main">0</span> <span class="main">{&gt;</span> ct_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs CT_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ct_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="skolem">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> μnxt <span class="main">=</span> μ nxt
  <span class="keyword1"><span class="command">have</span></span> r_phase_step<span class="main">:</span> <span class="quoted"><span class="quoted">"nr_steps <span class="main">*</span> three_phase <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r three_phase_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> r <span class="keyword1"><span class="command">have</span></span> same_coord<span class="main">:</span> <span class="quoted"><span class="quoted">"coord <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> coord <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step_phase_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> coord_phase<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cand</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cand</span> <span class="main">=</span> commt <span class="main">(</span><span class="skolem">sc'</span> <span class="main">(</span>coord <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">cand</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> guard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">cand</span><span class="main">∈</span><span class="skolem">C</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> majorities.opt_mru_guard <span class="main">(</span>mru_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="bound">Q</span> <span class="bound">cand</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="skolem">r</span> <span class="main">(</span>coord <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lvs0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mru_vote <span class="keyword1">o</span> <span class="skolem">sc</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">∈</span> majs"</span></span> <span class="keyword1"><span class="command">using</span></span> per_rd μnxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"coord <span class="skolem"><span class="skolem">r</span></span>"</span></span></span><span class="main">]</span>
      per_rd<span class="main">[</span><span class="operator">simplified</span> CT_commPerRd_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> r<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def majs_def next0_def same_coord get_msgs_dom r_phase_step<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"map_option snd <span class="main">(</span>option_Max_by fst <span class="main">(</span>ran <span class="main">(</span><span class="var">?lvs</span> <span class="main">|`</span> <span class="var">?Q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="skolem">cand</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"coord <span class="skolem">r</span>"</span></span><span class="main">]</span>
      msgs_mru_vote<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> HOs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">HOs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> μ<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">μ</span></span><span class="main">,</span> <span class="operator">OF</span> μ<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"coord <span class="skolem">r</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
      get_msgs_dom<span class="main">[</span><span class="operator">OF</span> μ<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> spec<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"coord <span class="skolem">r</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next0_def Let_def cand_def same_coord <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"majorities.opt_mru_guard <span class="var">?lvs0</span> <span class="var">?Q</span> <span class="skolem">cand</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_guard_def Let_def majorities.opt_mru_vote_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> majorities.opt_mru_guard <span class="var">?lvs0</span> <span class="bound">Q</span> <span class="skolem">cand</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span>
      next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span>
      candidates <span class="main">:=</span> <span class="skolem">C</span>
    <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step0 <span class="skolem">r</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R r nxt guard
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_step0_def sa'_def ct_ref_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ct_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> R nxt
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sa'_def ct_ref_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>
      mru_vote_evolution0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nxt<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> decide_evolution<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> nxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def C_def cand_def o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">C</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step0 <span class="bound">r</span> <span class="bound">C</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> ct_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step1_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ct_ref_rel<span class="main">}</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> majorities.opt_mru_step1 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> 
    CT_trans_step <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span> next1 send1 <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">{&gt;</span> ct_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs CT_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ct_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="skolem">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> μnxt <span class="main">=</span> μ nxt

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> commt <span class="main">(</span><span class="skolem">sc</span> <span class="main">(</span>coord <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> coord <span class="skolem">r</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="skolem">r</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span> next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span> 
    opt_mru_state.mru_vote <span class="main">:=</span> opt_mru_state.mru_vote <span class="skolem">sa</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span>
  <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step1 <span class="skolem">r</span> <span class="skolem">S</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r R 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_step1_def sa'_def  S_def v_def 
      ct_ref_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ct_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> r R
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mru_vote <span class="keyword1">o</span> <span class="skolem">sc'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>mru_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mru_vote <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>mru_vote <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> const_map <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> μnxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign next1_def send1_def S_def v_def map_add_def 
          const_map_is_None const_map_is_Some restrict_map_def isVote_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> R r nxt
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ct_ref_rel_def sa'_def three_step_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> decide_evolution<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>      
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step1 <span class="bound">r</span> <span class="bound">S</span> <span class="bound">v</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> ct_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step2_ref<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span>ct_ref_rel<span class="main">}</span> 
    <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="bound">dec_f</span><span class="main">.</span> majorities.opt_mru_step2 <span class="bound">r</span> <span class="bound">dec_f</span><span class="main">)</span><span class="main">,</span> 
    CT_trans_step <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span> next2 send2 <span class="numeral">2</span> <span class="main">{&gt;</span> ct_ref_rel<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PO_rhoare_defs CT_trans_step_def all_conj_distrib<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">sa</span> <span class="skolem">sc</span> <span class="skolem">sc'</span> <span class="skolem">μ</span>
  <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ct_ref_rel"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> μ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send2 <span class="skolem">r</span><span class="main">)</span> <span class="skolem">sc</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> nxt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="skolem">r</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">sc</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="skolem">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sc'</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> μnxt <span class="main">=</span> μ nxt

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dec_f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dec_f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> decide <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">then</span> decide <span class="main">(</span><span class="skolem">sc'</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>

  <span class="keyword1"><span class="command">have</span></span> dec_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span> <span class="main">=</span> decide <span class="main">∘</span> <span class="skolem">sc'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">sc</span><span class="main">)</span> <span class="main">++</span> <span class="skolem">dec_f</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span>decide <span class="main">∘</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_def dec_f_def next2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sa'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sa'</span> <span class="main">=</span> <span class="skolem">sa</span><span class="main">⦇</span>
    next_round <span class="main">:=</span> Suc <span class="skolem">r</span><span class="main">,</span>
    decisions <span class="main">:=</span> decisions <span class="skolem">sa</span> <span class="main">++</span> <span class="skolem">dec_f</span>
  <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa'</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> ct_ref_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> R r nxt
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ct_ref_rel_def sa'_def dec_f three_step_Suc 
      mru_vote_evolution2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nxt<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step2 <span class="skolem">r</span> <span class="skolem">dec_f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r R
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sc_r_votes</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sc_r_votes</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> mru_vote <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">then</span> map_option snd <span class="main">(</span>mru_vote <span class="main">(</span><span class="skolem">sc</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">have</span></span> sc_r_votes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sc_r_votes</span> <span class="main">=</span> majorities.r_votes <span class="skolem">sa</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R r
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ct_ref_rel_def sc_r_votes_def majorities.r_votes_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"majorities.step2_d_guard <span class="skolem">dec_f</span> <span class="skolem">sc_r_votes</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.step2_d_guard_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> d_f_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dec_f</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"votes_rcvd <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> Qv<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?Qv</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> the_rcvd_vote <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nxt<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> d_f_p
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next2_def dec_f_def<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> snd <span class="main">`</span> votes_rcvd <span class="main">(</span><span class="skolem">μ</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> the_rcvd_vote_def ex_in_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> le_less_trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> le0<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Qv</span> <span class="main">=</span> map_graph <span class="main">(</span><span class="skolem">sc_r_votes</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> μ<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_msgs_benign send2_def restrict_map_def votes_rcvd_def
          sc_r_votes_def image_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> ran <span class="skolem">sc_r_votes</span> <span class="main">∧</span> dom <span class="skolem">sc_r_votes</span> <span class="main">∈</span> majs"</span></span> <span class="keyword1"><span class="command">using</span></span> Qv<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majs_def inj_on_def map_graph_def fun_graph_def sc_r_votes_def
          the_rcvd_vote_def majs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ranI
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_le_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_inj_on_le<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">fst</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r R
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.opt_mru_step2_def sa'_def ct_ref_rel_def sc_r_votes<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sa'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">dec_f</span><span class="main">.</span> <span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="bound">sa'</span><span class="main">)</span> <span class="main">∈</span> majorities.opt_mru_step2 <span class="bound">r</span> <span class="bound">dec_f</span><span class="main">)</span> 
        <span class="main">∧</span> <span class="main">(</span><span class="bound">sa'</span><span class="main">,</span> Suc <span class="skolem">r</span><span class="main">,</span> <span class="skolem">sc'</span><span class="main">)</span> <span class="main">∈</span> ct_ref_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CT_Refines_ThreeStep_MRU<span class="main">:</span>
  <span class="quoted"><span class="quoted">"PO_refines ct_ref_rel majorities.ts_mru_TS <span class="main">(</span>CT_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refine_basic<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"init <span class="main">(</span>CT_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">⊆</span> ct_ref_rel <span class="main">``</span> init majorities.ts_mru_TS"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CT_TS_defs majorities.ts_mru_TS_defs ct_ref_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span>ct_ref_rel<span class="main">}</span> TS.trans majorities.ts_mru_TS<span class="main">,</span> 
      TS.trans <span class="main">(</span>CT_TS <span class="free">HOs</span> <span class="free">HOs</span> <span class="free">crds</span><span class="main">)</span> <span class="main">{&gt;</span> ct_ref_rel<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> majorities.ts_mru_TS_defs CT_TS_defs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CHO_trans_alt CT_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step0_ref step1_ref step2_ref<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* HO context *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Termination›</span></span>
<span class="comment1">(******************************************************************************)</span>

<span class="keyword1"><span class="command">theorem</span></span> CT_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"CHORun CT_Alg <span class="free">rho</span> <span class="free">HOs</span> <span class="free">crds</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> CHOcommPerRd CT_M <span class="bound">r</span> <span class="main">(</span><span class="free">HOs</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> commG<span class="main">:</span> <span class="quoted"><span class="quoted">"CHOcommGlobal CT_M <span class="free">HOs</span> <span class="free">crds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span> <span class="bound">v</span><span class="main">.</span> decide <span class="main">(</span><span class="free">rho</span> <span class="bound">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> commG commR <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ph</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    HOs<span class="main">:</span>
       <span class="quoted"><span class="quoted">"coord <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="free">HOs</span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> card <span class="main">(</span><span class="free">HOs</span> <span class="main">(</span>nr_steps<span class="main">*</span><span class="skolem">ph</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&gt;</span> N <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CT_CHOMachine_def CT_commGlobal_def CT_commPerRd_def three_step_def<span class="main">)</span>

  <span class="comment1">― ‹The tedious bit: obtain three consecutive rounds linked by send/next functions›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r0</span> <span class="main">=</span> nr_steps <span class="main">*</span> <span class="skolem">ph</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg0</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r1</span> <span class="main">=</span> Suc <span class="skolem">r0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg1</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r2</span> <span class="main">=</span> Suc <span class="skolem">r1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg2</span> <span class="main">=</span> <span class="free">rho</span> <span class="skolem">r2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cfg3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cfg3</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">r2</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span>   
    run<span class="main">[</span><span class="operator">simplified</span> CHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r0</span>"</span></span><span class="main">]</span> 
    run<span class="main">[</span><span class="operator">simplified</span> CHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r1</span>"</span></span><span class="main">]</span>
    run<span class="main">[</span><span class="operator">simplified</span> CHORun_def<span class="main">,</span> <span class="operator">THEN</span> CSHORun_step<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">r2</span>"</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">μ0</span></span> <span class="skolem"><span class="skolem">μ1</span></span> <span class="skolem"><span class="skolem">μ2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    send0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ0</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send0 <span class="skolem">r0</span><span class="main">)</span> <span class="skolem">cfg0</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r0</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> three_step0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next0 <span class="skolem">r0</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ0</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="main">(</span>Suc <span class="skolem">r0</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ1</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send1 <span class="skolem">r1</span><span class="main">)</span> <span class="skolem">cfg1</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r1</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> three_step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next1 <span class="skolem">r1</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ1</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="main">(</span>Suc <span class="skolem">r1</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> send2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">μ2</span> <span class="bound">p</span> <span class="main">∈</span> get_msgs <span class="main">(</span>send2 <span class="skolem">r2</span><span class="main">)</span> <span class="skolem">cfg2</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> three_step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> next2 <span class="skolem">r2</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">μ2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">crds</span> <span class="main">(</span>Suc <span class="skolem">r2</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cfg3</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CT_Alg_def three_step_def CT_nextState_def CT_sendMsg_def all_conj_distrib
      r0_def r1_def r2_def
      cfg0_def cfg1_def cfg2_def cfg3_def mod_Suc
      <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
  <span class="comment1">― ‹The proof: the coordinator hears enough messages in r0 and thus selects a value.›</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dec_v</span></span> <span class="keyword2"><span class="keyword">where</span></span> dec_v<span class="main">:</span> <span class="quoted"><span class="quoted">"commt <span class="main">(</span><span class="skolem">cfg1</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">dec_v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> step_r0<span class="main">:</span> <span class="quoted"><span class="quoted">"three_step <span class="skolem">r0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r0_def three_step_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> same_coord<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"coord <span class="skolem">r1</span> <span class="main">=</span> coord <span class="skolem">r0</span>"</span></span>
    <span class="quoted"><span class="quoted">"coord <span class="skolem">r2</span> <span class="main">=</span> coord <span class="skolem">r0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> three_step_phase_Suc r2_def r1_def r0_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> coord_phase<span class="main">)</span>

  <span class="comment1">― ‹All processes hear from the coordinator, and thus set their vote to <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">dec_v</span></span><span class="antiquote">}</span></span>.›</span>  
  <span class="keyword1"><span class="command">hence</span></span> all_vote<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> mru_vote <span class="main">(</span><span class="skolem">cfg2</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>three_phase <span class="skolem">r2</span><span class="main">,</span> <span class="skolem">dec_v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> HOs three_step1 send1 step_r0 dec_v
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next1_def Let_def get_msgs_benign send1_def restrict_map_def isVote_def
      r2_def r1_def r0_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> same_coord<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> r2_def r1_def<span class="main"><span class="main">]</span></span> three_step_phase_Suc<span class="main">)</span>

  <span class="comment1">― ‹And finally, everybody will also decide <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">dec_v</span></span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">have</span></span> all_decide<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> decide <span class="main">(</span><span class="skolem">cfg3</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">dec_v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"votes_rcvd <span class="main">(</span><span class="skolem">μ2</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">HOs</span> <span class="skolem">r2</span> <span class="skolem">p</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">dec_v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> send2<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> all_vote
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> send2_def get_msgs_benign votes_rcvd_def restrict_map_def image_def o_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> HOs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"N <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">HOs</span> <span class="skolem">r2</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r2_def r1_def r0_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">HOs</span> <span class="skolem">r2</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card.empty less_nat_zero_code<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decide <span class="main">(</span><span class="skolem">cfg3</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">dec_v</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> three_step2<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> send2<span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> all_vote
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> next2_def send2_def Let_def get_msgs_benign 
        the_rcvd_vote_def restrict_map_def image_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
    
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cfg3_def<span class="main">)</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>